<!DOCTYPE html>
<html lang="en">
<head>
   <link rel="icon" type="image/png" href="karta-logo-design.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- Anti-Copy Protection Headers -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:;">
    <meta name="theme-color" content="#0b0b0b">
    <title>Karta</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF & AutoTable for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <script>
        // ===== ANTI-COPY & CODE PROTECTION =====
        // Store original console methods before any modifications
        const originalConsole = {
            log: console.log,
            warn: console.warn,
            error: console.error,
            info: console.info,
            debug: console.debug
        };

        // Wait for DOM to be ready before applying body styles
        if (document.body) {
            document.body.style.userSelect = 'none';
            document.body.style.webkitUserSelect = 'none';
            document.body.style.msUserSelect = 'none';
        } else {
            document.addEventListener('DOMContentLoaded', function() {
                document.body.style.userSelect = 'none';
                document.body.style.webkitUserSelect = 'none';
                document.body.style.msUserSelect = 'none';
            });
        }

        // Disable right-click context menu
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        }, false);

        // Disable keyboard shortcuts for developer tools
        document.addEventListener('keydown', function(e) {
            // F12 - Developer Tools
            if (e.keyCode === 123) {
                e.preventDefault();
                return false;
            }
            // Ctrl+Shift+I - Inspect Element
            if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
                e.preventDefault();
                return false;
            }
            // Ctrl+Shift+J - Developer Console
            if (e.ctrlKey && e.shiftKey && e.keyCode === 74) {
                e.preventDefault();
                return false;
            }
            // Ctrl+Shift+C - Inspect Element (Alt)
            if (e.ctrlKey && e.shiftKey && e.keyCode === 67) {
                e.preventDefault();
                return false;
            }
            // Ctrl+Shift+K - Developer Console (Firefox)
            if (e.ctrlKey && e.shiftKey && e.keyCode === 75) {
                e.preventDefault();
                return false;
            }
        }, false);

        // Disable copy event
        document.addEventListener('copy', function(e) {
            e.preventDefault();
            return false;
        });

        // Disable cut event
        document.addEventListener('cut', function(e) {
            e.preventDefault();
            return false;
        });

        // Detect if Developer Tools are open (non-blocking)
        let devToolsOpen = false;
        const checkDevTools = setInterval(function() {
            if (window.outerHeight - window.innerHeight > 100 || 
                window.outerWidth - window.innerWidth > 100) {
                devToolsOpen = true;
            }
        }, 500);

        // Prevent saving the page
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.keyCode === 83) { // Ctrl+S
                e.preventDefault();
                return false;
            }
        });

        // Disable drag and drop for copying
        document.addEventListener('dragstart', function(e) {
            e.preventDefault();
            return false;
        });

        // Watermark detection - Add hidden marker
        document.documentElement.setAttribute('data-protected', 'true');
        document.documentElement.setAttribute('data-source', 'KARTA_PROPRIETARY');

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        karta: {
                            bg: '#0b0b0b',
                            surface: '#121212',
                            border: '#27272a',
                            primary: '#00c853',
                            primaryDark: '#009624',
                            text: '#e0e0e0',
                            muted: '#9e9e9e',
                            danger: '#ef4444',
                            warning: '#f59e0b'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        /* ===== CODE PROTECTION STYLES ===== */
        /* Prevent text selection globally */
        * {
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            -webkit-user-drag: none !important;
            -webkit-touch-callout: none !important;
        }

        /* Allow selection only in specific input fields */
        input, textarea, select {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }

        /* Disable inspect element highlighting */
        *::-webkit-scrollbar-button {
            pointer-events: none;
        }

        /* Hide during inspection */
        @supports (-webkit-appearance: none) {
            @media screen and (prefers-reduced-motion: no-preference) {
                body::-webkit-scrollbar {
                    width: 0 !important;
                    height: 0 !important;
                }
            }
        }

        body {
            background-color: #0b0b0b;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #121212; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #00c853; }

        /* Utilities */
        .glass-panel {
            background: rgba(18, 18, 18, 0.95);
            border: 1px solid #27272a;
        }
        
        .input-field {
            background-color: #1a1a1a;
            border: 1px solid #333;
            color: white;
            padding: 0.5rem;
            border-radius: 0.375rem;
            width: 100%;
            transition: all 0.2s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: #00c853;
            box-shadow: 0 0 8px rgba(0, 200, 83, 0.3);
        }
        .input-field:hover {
            border-color: #555;
        }
        .input-field:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Button Styles */
        button {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        button:focus-visible {
            outline: 2px solid #00c853;
            outline-offset: 2px;
        }

        /* Primary Button */
        .btn-primary {
            background-color: #00c853;
            color: black;
            font-weight: 600;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.25s ease;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #00e676;
            box-shadow: 0 8px 16px rgba(0, 200, 83, 0.3);
            transform: translateY(-2px);
        }
        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        /* Secondary Button */
        .btn-secondary {
            background-color: transparent;
            border: 1.5px solid #333;
            color: #e0e0e0;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.25s ease;
        }
        .btn-secondary:hover:not(:disabled) {
            border-color: #00c853;
            color: #00c853;
            background-color: rgba(0, 200, 83, 0.1);
        }

        /* Danger Button */
        .btn-danger {
            background-color: #ef4444;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            transition: all 0.25s ease;
        }
        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
            box-shadow: 0 8px 16px rgba(239, 68, 68, 0.3);
            transform: translateY(-2px);
        }

        /* Success/Confirmation Animation */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-slideIn { animation: slideIn 0.3s ease-out; }

        /* Loading State */
        .loading::after {
            content: '';
            display: inline-block;
            width: 4px;
            height: 4px;
            margin-left: 4px;
            background: currentColor;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Modal Content Fixes */
        .modal-content {
            pointer-events: auto !important;
            z-index: 51 !important;
            position: relative !important;
            animation: slideIn 0.3s ease-out;
        }

        #modalBackdrop {
            z-index: 50 !important;
            pointer-events: auto;
        }
        
        #modalBackdrop.hidden {
            pointer-events: none;
        }

        /* Responsive Table Wrapper */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Success Toast */
        .toast-success {
            animation: slideIn 0.3s ease-out, slideIn 0.3s ease-in 4.7s reverse;
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22c55e;
        }

        /* Card Hover Effects */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 200, 83, 0.15);
            border-color: #00c853 !important;
        }

        /* Table Row Hover */
        tbody tr {
            transition: all 0.2s ease;
        }
        tbody tr:hover {
            background-color: rgba(0, 200, 83, 0.05) !important;
        }

        /* KPI Cards */
        .kpi-card {
            transition: all 0.3s ease;
            position: relative;
        }
        .kpi-card:hover {
            transform: scale(1.02);
        }

        /* Smooth Transitions */
        * {
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        /* Focus States for Accessibility */
        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 2px solid #00c853;
            outline-offset: 2px;
        }

        /* Placeholder Styling */
        ::placeholder {
            color: #666;
            opacity: 0.8;
        }

        /* Select Element Styling */
        select {
            background-color: #1a1a1a;
            border: 1px solid #333;
            color: white;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        select:hover {
            border-color: #555;
        }
        select:focus {
            outline: none;
            border-color: #00c853;
            box-shadow: 0 0 8px rgba(0, 200, 83, 0.3);
        }

        /* Checkbox & Radio Styling */
        input[type="checkbox"],
        input[type="radio"] {
            accent-color: #00c853;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        input[type="checkbox"]:hover,
        input[type="radio"]:hover {
            transform: scale(1.1);
        }

        /* Number Input */
        input[type="number"] {
            transition: all 0.2s ease;
        }

        /* Skeleton Loading */
        .skeleton {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            background: linear-gradient(90deg, #1a1a1a 25%, #242424 50%, #1a1a1a 75%);
            background-size: 200% 100%;
        }

        /* Print Layout - A4 Specification Fixed */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { 
                background: white; 
                color: black; 
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                margin: 0;
                padding: 0;
                overflow: visible !important;
            }
            
            /* Hide everything by default */
            body * {
                visibility: hidden;
            }

            /* Show ONLY the printable area and its children */
            #printable-area, #printable-area * { 
                visibility: visible !important;
            }
            
            #printable-area { 
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                background: white;
                color: black;
                z-index: 9999;
            }
            
            .no-print { display: none !important; }
        }

        /* ===== ENHANCED UX IMPROVEMENTS ===== */

        /* Empty State Styling */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
            color: #999;
        }
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }
        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: #ccc;
            margin-bottom: 8px;
        }
        .empty-state-text {
            font-size: 14px;
            color: #999;
        }

        /* Enhanced Input Feedback */
        .input-field:valid {
            border-color: #00c853;
        }
        .input-field:invalid:not(:placeholder-shown) {
            border-color: #ef4444;
        }

        /* Tooltip Styling */
        [data-tooltip] {
            position: relative;
            cursor: help;
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: #00c853;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            border: 1px solid #333;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            max-width: 400px;
            padding: 16px;
            border-radius: 8px;
            font-weight: 500;
            z-index: 1000;
            animation: slideInUp 0.3s ease-out;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }
        .toast-success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22c55e;
            color: #86efac;
        }
        .toast-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #fca5a5;
        }
        .toast-info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
            color: #93c5fd;
        }
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Breadcrumb Navigation */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #999;
            margin-bottom: 16px;
        }
        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .breadcrumb-item.active {
            color: #00c853;
            font-weight: 600;
        }
        .breadcrumb-separator {
            color: #555;
        }

        /* Badge Styling */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .badge-success {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
            border: 1px solid #22c55e;
        }
        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
            border: 1px solid #f59e0b;
        }
        .badge-error {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid #ef4444;
        }
        .badge-info {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            border: 1px solid #3b82f6;
        }

        /* Help Text */
        .help-text {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
            display: block;
        }

        /* Form Group Spacing */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* Confirmation Dialog */
        .confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #121212;
            border: 1px solid #27272a;
            padding: 24px;
            border-radius: 8px;
            z-index: 1001;
            min-width: 320px;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .confirm-dialog-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        /* Expandable Row */
        .expandable-row {
            cursor: pointer;
            user-select: none;
        }
        .expandable-row:hover {
            background: rgba(0, 200, 83, 0.05);
        }
        .expandable-row.expanded {
            background: rgba(0, 200, 83, 0.08);
        }

        /* Loading Bar */
        .progress-bar {
            height: 3px;
            background: linear-gradient(90deg, #00c853, #00e676);
            animation: progress 2s ease-in-out infinite;
            border-radius: 2px;
        }
        @keyframes progress {
            0% { width: 0%; }
            50% { width: 100%; }
            100% { width: 0%; }
        }

        /* Status Indicator */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-indicator.online::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-indicator.offline::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
        }

        /* Responsive Table Fixes */
        table {
            border-collapse: collapse;
        }
        thead th {
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        tbody tr {
            transition: background-color 0.2s ease;
        }
        tbody tr:hover {
            background-color: rgba(0, 200, 83, 0.05);
        }

        /* Mobile-First Improvements */
        @media (max-width: 768px) {
            .breadcrumb {
                font-size: 11px;
            }
            .badge {
                font-size: 10px;
                padding: 3px 6px;
            }
            button {
                font-size: 14px !important;
                padding: 10px 16px !important;
            }
            .input-field {
                font-size: 16px;
                padding: 12px;
            }
        }

        /* Section Transitions */
        section {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Icon Loading Animation */
        .fa-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="h-screen overflow-hidden text-sm relative">

    <!-- AUTH LOGIN SCREEN -->
    <div id="auth-screen" class="absolute inset-0 z-50 bg-karta-bg flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-karta-surface border border-karta-border p-8 rounded-lg shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-16 h-16 rounded bg-karta-primary flex items-center justify-center text-black font-bold text-3xl mx-auto mb-4">
                    <i class="fa-solid fa-leaf"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">Welcome to KARTA</h1>
                <p class="text-karta-muted mt-2">Secure Pharmacy OS</p>
                <div class="mt-4 p-3 bg-blue-900/20 border border-blue-800 rounded text-xs text-blue-300 text-left">
                    <i class="fa-solid fa-shield-halved mr-2"></i> <strong>Private Database:</strong> Each user has a completely separate database. Data is never shared between accounts.
                </div>
            </div>
            
            <form id="authForm" class="space-y-4">
                <div>
                    <label class="text-xs text-gray-400">Email Address</label>
                    <input type="email" id="authEmail" class="input-field mt-1" placeholder="admin@karta.com" required>
                </div>
                <div>
                    <label class="text-xs text-gray-400">Password</label>
                    <input type="password" id="authPass" class="input-field mt-1" placeholder="••••••••" required>
                </div>
                
                <div id="authError" class="text-red-500 text-xs hidden"></div>

                <div class="pt-4 flex flex-col gap-3">
                    <button type="submit" id="btnSignIn" class="w-full bg-karta-primary hover:bg-karta-primaryDark text-black font-bold py-3 rounded transition-all duration-200 hover:shadow-lg hover:shadow-green-500/50 active:scale-95">
                        <i class="fa-solid fa-lock mr-2"></i> Access My Database
                    </button>
                    <button type="button" id="btnSignUp" class="w-full bg-transparent border border-karta-border hover:border-karta-primary hover:bg-white/5 text-white py-2 rounded transition-all duration-200 active:scale-95">
                        Create New Private Database
                    </button>
                </div>
            </form>
            <div class="mt-6 text-center text-xs text-gray-500">
                Secured by Firebase
            </div>
        </div>
    </div>

    <!-- Mobile Sidebar Overlay Backdrop -->
    <div id="mobile-backdrop" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden glass-panel" onclick="toggleSidebar()"></div>

    <!-- Wrapper for Main App (to hide during print) -->
    <div id="app-root" class="flex h-full w-full hidden opacity-0 transition-opacity duration-500">

        <!-- Sidebar -->
        <!-- CHANGED: Added mobile specific classes for slide-out drawer behavior -->
        <aside id="sidebar" class="fixed md:relative inset-y-0 left-0 transform -translate-x-full md:translate-x-0 w-64 bg-karta-surface border-r border-karta-border flex flex-col z-30 transition-transform duration-300 ease-in-out">
            <div class="p-6 flex items-center justify-between border-b border-karta-border">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded bg-karta-primary flex items-center justify-center text-black font-bold text-xl">
                        <i class="fa-solid fa-leaf"></i>
                    </div>
                    <div class="overflow-hidden">
                        <h1 class="text-xl font-bold tracking-tight text-white">KARTA</h1>
                        <p class="text-xs text-karta-primary truncate max-w-[100px]" id="userEmailDisplay">User</p>
                    </div>
                </div>
                <!-- Mobile Close Button -->
                <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-white">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <nav class="flex-1 p-3 space-y-1 overflow-y-auto">
                <div class="text-xs font-bold text-karta-muted uppercase px-3 py-2 mt-2">Core</div>
                <button onclick="nav('dashboard')" class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:border-l-2 hover:border-karta-primary transition-all text-karta-primary bg-white/5">
                    <i class="fa-solid fa-chart-pie w-5 text-center"></i> <span>Dashboard</span>
                </button>
                <button onclick="nav('pos')" class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:text-karta-primary transition-all text-gray-400">
                    <i class="fa-solid fa-cash-register w-5 text-center"></i> <span>POS Terminal</span>
                </button>
                <button onclick="nav('invoices')" class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:text-karta-primary transition-all text-gray-400">
                    <i class="fa-solid fa-receipt w-5 text-center"></i> <span>Invoices</span>
                </button>

                <button onclick="nav('returns')" class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:text-karta-primary transition-all text-gray-400">
                    <i class="fa-solid fa-rotate-left w-5 text-center"></i> <span>Returns & Refunds</span>
                </button>

                <div class="text-xs font-bold text-karta-muted uppercase px-3 py-2 mt-4">Management</div>
                <button onclick="nav('inventory')" class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:text-karta-primary transition-all text-gray-400">
                    <i class="fa-solid fa-pills w-5 text-center"></i> <span>Products & Stock</span>
                </button>
                <button onclick="nav('customers')" class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:text-karta-primary transition-all text-gray-400">
                    <i class="fa-solid fa-users w-5 text-center"></i> <span>Customers</span>
                </button>
                <button onclick="nav('suppliers')" class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:text-karta-primary transition-all text-gray-400">
                    <i class="fa-solid fa-truck-field w-5 text-center"></i> <span>Suppliers</span>
                </button>
                <button onclick="nav('productSuppliers')" class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:text-karta-primary transition-all text-gray-400">
                    <i class="fa-solid fa-link w-5 text-center"></i> <span>Product-Supplier</span>
                </button>

                <div class="text-xs font-bold text-karta-muted uppercase px-3 py-2 mt-4">Finance</div>
                <button onclick="nav('purchases')" class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:text-karta-primary transition-all text-gray-400">
                    <i class="fa-solid fa-file-invoice w-5 text-center"></i> <span>Purchases & Exp</span>
                </button>
                <button onclick="nav('reports')" class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:text-karta-primary transition-all text-gray-400">
                    <i class="fa-solid fa-chart-line w-5 text-center"></i> <span>Reports</span>
                </button>
            </nav>

            <div class="p-4 border-t border-karta-border space-y-2">
                <div class="text-xs text-center text-gray-500 mb-2 animate-pulse">
                    <span id="syncStatusIndicator" class="text-green-500"><i class="fa-solid fa-circle"></i> Synced</span>
                </div>
                <button onclick="nav('settings')" class="flex items-center gap-2 text-gray-400 hover:text-karta-primary hover:bg-white/5 transition-all w-full p-2 rounded">
                    <i class="fa-solid fa-gear"></i> Settings
                </button>
                <button onclick="handleLogout()" class="flex items-center gap-2 text-red-500 hover:text-red-400 hover:bg-red-500/10 transition-all w-full p-2 rounded">
                    <i class="fa-solid fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-karta-bg relative overflow-hidden">
            
            <!-- Top Bar -->
            <header class="h-16 border-b border-karta-border bg-karta-bg flex items-center justify-between px-4 md:px-6 z-10 shrink-0">
                <div class="flex items-center gap-3 flex-1 min-w-0">
                    <!-- Mobile Menu Button -->
                    <button onclick="toggleSidebar()" class="md:hidden text-white p-2 hover:bg-white/5 rounded transition" title="Menu">
                        <i class="fa-solid fa-bars fa-lg"></i>
                    </button>
                    <!-- Breadcrumb Navigation -->
                    <div class="breadcrumb hidden sm:flex overflow-x-auto">
                        <span class="breadcrumb-item active">
                            <i class="fa-solid fa-home text-xs"></i>
                            <span id="pageTitle" class="font-bold text-white truncate">Dashboard</span>
                        </span>
                    </div>
                    <h2 id="pageTitleMobile" class="text-lg md:text-xl font-bold text-white truncate sm:hidden">Dashboard</h2>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <div class="text-sm font-bold text-white" id="clock">12:00 PM</div>
                        <div class="text-xs text-karta-muted" id="date">Jan 01, 2025</div>
                    </div>
                    <div class="h-8 w-8 rounded-full bg-gray-800 border border-gray-700 flex items-center justify-center text-karta-primary hover:bg-gray-700 transition cursor-pointer" title="User Profile">
                        <i class="fa-solid fa-user-shield"></i>
                    </div>
                </div>
            </header>

            <!-- Content Scroll Area -->
            <div class="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth" id="mainContainer">
                
                <!-- DASHBOARD -->
                <section id="dashboard" class="space-y-6 animate-fade pb-20 md:pb-0">
                    <!-- KPI Grid - Sales & Payments -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg relative overflow-hidden group hover:border-karta-primary transition cursor-pointer" data-tooltip="Total revenue from all sales">
                            <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition text-karta-primary"><i class="fa-solid fa-sack-dollar fa-3x"></i></div>
                            <p class="text-karta-muted text-xs uppercase tracking-wider">Total Revenue</p>
                            <h3 class="text-2xl font-bold text-karta-primary mt-1" id="kpiRevenue">$0.00</h3>
                        </div>
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg relative overflow-hidden group hover:border-green-600 transition cursor-pointer" data-tooltip="Cash received from customers">
                            <div class="absolute right-0 top-0 p-4 opacity-10 text-green-500"><i class="fa-solid fa-money-bill fa-3x"></i></div>
                            <p class="text-karta-muted text-xs uppercase tracking-wider">Cash Received</p>
                            <h3 class="text-2xl font-bold text-green-500 mt-1" id="kpiCash">$0.00</h3>
                        </div>
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg relative overflow-hidden group hover:border-blue-600 transition cursor-pointer" data-tooltip="Bank deposits and transfers">
                            <div class="absolute right-0 top-0 p-4 opacity-10 text-blue-500"><i class="fa-solid fa-building fa-3x"></i></div>
                            <p class="text-karta-muted text-xs uppercase tracking-wider">Bank Received</p>
                            <h3 class="text-2xl font-bold text-blue-500 mt-1" id="kpiBank">$0.00</h3>
                        </div>
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg relative overflow-hidden group hover:border-orange-600 transition cursor-pointer" data-tooltip="Products below reorder level">
                            <div class="absolute right-0 top-0 p-4 opacity-10 text-orange-600"><i class="fa-solid fa-triangle-exclamation fa-3x"></i></div>
                            <p class="text-karta-muted text-xs uppercase tracking-wider">Low Stock Items</p>
                            <h3 class="text-2xl font-bold text-orange-500 mt-1" id="kpiLowStock">0</h3>
                        </div>
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg relative overflow-hidden group hover:border-gray-500 transition cursor-pointer" data-tooltip="Total value of inventory at cost">
                            <div class="absolute right-0 top-0 p-4 opacity-10 text-gray-500"><i class="fa-solid fa-boxes-stacked fa-3x"></i></div>
                            <p class="text-karta-muted text-xs uppercase tracking-wider">Stock Value</p>
                            <h3 class="text-2xl font-bold text-gray-300 mt-1" id="kpiStockVal">$0.00</h3>
                        </div>
                    </div>

                    <!-- Balance Summary Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg hover:border-red-700 transition">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Customer Balance Due</p>
                                    <h3 class="text-3xl font-bold text-red-500" id="kpiCustDue">$0.00</h3>
                                    <p class="text-xs text-gray-500 mt-2">Receivables from customers</p>
                                </div>
                                <div class="text-red-600/20"><i class="fa-solid fa-users fa-4x"></i></div>
                            </div>
                        </div>

                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg hover:border-orange-700 transition">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Supplier Balance Due</p>
                                    <h3 class="text-3xl font-bold text-orange-600" id="kpiSupDue">$0.00</h3>
                                    <p class="text-xs text-gray-500 mt-2">Payables to suppliers</p>
                                </div>
                                <div class="text-orange-700/20"><i class="fa-solid fa-handshake fa-4x"></i></div>
                            </div>
                        </div>

                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg hover:border-karta-primary transition">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Net Balance</p>
                                    <h3 class="text-3xl font-bold text-karta-primary" id="kpiNetBalance">$0.00</h3>
                                    <p class="text-xs text-gray-500 mt-2">Receivables - Payables</p>
                                </div>
                                <div class="text-karta-primary/20"><i class="fa-solid fa-scale-balanced fa-4x"></i></div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Area -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-karta-surface border border-karta-border rounded-lg p-4">
                            <h3 class="font-bold mb-4 text-white">Sales & Purchase Volume</h3>
                            <!-- Fixed Container for Chart -->
                            <div class="relative h-64 md:h-80 w-full">
                                <canvas id="mainChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-karta-surface border border-karta-border rounded-lg p-4 flex flex-col">
                            <h3 class="font-bold mb-4 text-white">Top Categories</h3>
                            <div class="flex-1 flex items-center justify-center relative h-64">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Low Stock Table (Restored) -->
                    <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                        <div class="p-4 border-b border-karta-border flex justify-between items-center">
                            <h3 class="font-bold text-white text-sm"><i class="fa-solid fa-circle-exclamation text-amber-600 mr-2"></i>Critical Low Stock</h3>
                            <button onclick="nav('purchases')" class="text-xs text-karta-primary hover:underline">Order Stock</button>
                        </div>
                        <div class="table-container">
                            <table class="w-full text-left text-xs min-w-[500px]">
                                <thead class="bg-white/5 text-gray-400">
                                    <tr>
                                        <th class="p-3">Product</th>
                                        <th class="p-3">SKU</th>
                                        <th class="p-3">Supplier</th>
                                        <th class="p-3 text-right">Stock</th>
                                        <th class="p-3 text-right">Reorder Lvl</th>
                                    </tr>
                                </thead>
                                <tbody id="lowStockBody" class="divide-y divide-gray-800">
                                    <tr>
                                        <td colspan="5" class="p-8">
                                            <div class="empty-state">
                                                <div class="empty-state-icon"><i class="fa-solid fa-check-circle"></i></div>
                                                <div class="empty-state-title">All Items in Stock</div>
                                                <div class="empty-state-text">No products are below their reorder level</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Expired Products Alert -->
                    <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                        <div class="p-4 border-b border-karta-border flex justify-between items-center">
                            <h3 class="font-bold text-white text-sm"><i class="fa-solid fa-calendar-xmark text-red-600 mr-2"></i>Expired Products Alert</h3>
                            <button onclick="nav('inventory')" class="text-xs text-karta-primary hover:underline">View & Remove</button>
                        </div>
                        <div class="table-container">
                            <table class="w-full text-left text-xs min-w-[500px]">
                                <thead class="bg-white/5 text-gray-400">
                                    <tr>
                                        <th class="p-3">Product</th>
                                        <th class="p-3">SKU</th>
                                        <th class="p-3">Batch</th>
                                        <th class="p-3 text-center">Expiry Date</th>
                                        <th class="p-3 text-right">Stock</th>
                                        <th class="p-3 text-center">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="expiredBody" class="divide-y divide-gray-800">
                                    <tr>
                                        <td colspan="6" class="p-8">
                                            <div class="empty-state">
                                                <div class="empty-state-icon"><i class="fa-solid fa-calendar-check"></i></div>
                                                <div class="empty-state-title">No Expired Products</div>
                                                <div class="empty-state-text">All products are within their expiry dates</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- POS TERMINAL -->
                <section id="pos" class="hidden h-full flex flex-col md:flex-row gap-4 pb-20 md:pb-0">
                    <!-- Left: Catalog -->
                    <div class="w-full md:w-2/3 flex flex-col gap-4 h-auto md:h-full order-2 md:order-1">
                        <div class="bg-karta-surface p-3 rounded-lg border border-karta-border flex flex-col md:flex-row gap-3">
                            <div class="relative flex-1">
                                <i class="fa-solid fa-search absolute left-3 top-3 text-gray-500"></i>
                                <input type="text" id="posSearch" placeholder="Scan Barcode or Search..." class="input-field pl-10 h-10 md:h-full">
                            </div>
                            <div class="flex gap-3 h-10 md:h-full">
                                <div class="w-24">
                                    <input type="number" id="posQtyInput" value="1" min="1" class="input-field text-center h-full" placeholder="Qty">
                                </div>
                                <select id="posCatFilter" class="input-field w-full md:w-40 h-full">
                                    <option value="all">All Cats</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex-1 md:overflow-y-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 content-start pr-1 min-h-[300px]" id="posGrid">
                            <!-- Products JS -->
                        </div>
                    </div>
                    
                    <!-- Right: Cart -->
                    <div class="w-full md:w-1/3 bg-karta-surface border border-karta-border rounded-lg flex flex-col h-auto md:h-full order-1 md:order-2 shrink-0">
                        <div class="p-3 border-b border-karta-border">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-white">Current Sale</h3>
                                <button onclick="clearCart()" class="text-xs text-red-400 hover:text-red-300">Clear</button>
                            </div>
                            <!-- Customer Select -->
                            <div class="relative mb-2">
                                <input list="custDataList" id="posCustomerInput" placeholder="Guest Customer (Walk-in)" class="input-field text-xs">
                                <datalist id="custDataList"></datalist>
                            </div>
                            <!-- Price Type Selector -->
                            <div class="flex gap-2 mb-2">
                                <label class="flex-1 flex items-center justify-center px-2 py-1 rounded border border-karta-border bg-karta-primary/20 text-xs cursor-pointer" title="Retail/Customer Price">
                                    <input type="radio" name="priceType" value="retail" checked onchange="renderCart()" class="mr-1"> Retail
                                </label>
                                <label class="flex-1 flex items-center justify-center px-2 py-1 rounded border border-karta-border hover:bg-white/5 text-xs cursor-pointer" title="Wholesale Price">
                                    <input type="radio" name="priceType" value="wholesale" onchange="renderCart()" class="mr-1"> Wholesale
                                </label>
                            </div>
                            <!-- Discount Input -->
                            <div class="flex gap-2 items-center">
                                <label class="text-xs text-gray-400 flex-1">Discount %</label>
                                <div class="flex items-center gap-1 flex-1">
                                    <input type="number" id="posDiscount" value="0" min="0" max="100" step="0.1" class="input-field text-right text-xs" onchange="renderCart()" onkeyup="renderCart()">
                                    <span class="text-xs text-gray-400">%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex-1 md:overflow-y-auto p-2 space-y-1 min-h-[150px] max-h-[300px] md:max-h-none" id="posCartBody">
                            <!-- Cart Items -->
                            <div class="flex h-full items-center justify-center text-gray-600 flex-col py-8 md:py-0">
                                <i class="fa-solid fa-basket-shopping text-4xl mb-2"></i>
                                <p>Cart is empty</p>
                            </div>
                        </div>

                        <div class="p-4 bg-white/5 border-t border-karta-border space-y-2">
                            <div class="flex justify-between text-xs text-gray-400 items-center">
                                <span>Subtotal</span>
                                <span id="posSubTotal">$0.00</span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-400 items-center">
                                <label class="flex items-center cursor-pointer select-none">
                                    <input type="checkbox" id="posVatToggle" checked onchange="renderCart()" class="mr-2"> Apply VAT (<span id="posVatRate">0</span>%)
                                </label>
                                <span id="posTax">$0.00</span>
                            </div>
                            <div class="flex justify-between text-xl font-bold text-karta-primary border-t border-gray-700 pt-2">
                                <span>Total</span>
                                <span id="posTotal">$0.00</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <button onclick="checkout('credit')" class="bg-yellow-600 hover:bg-yellow-700 text-black py-3 rounded font-bold transition text-xs md:text-sm"><i class="fa-solid fa-credit-card mr-1"></i>Credit</button>
                                <button onclick="checkout('cash')" class="bg-karta-primary hover:bg-karta-primaryDark text-black py-3 rounded font-bold transition text-xs md:text-sm"><i class="fa-solid fa-money-bill mr-1"></i>Cash</button>
                                <button onclick="checkout('bank')" class="bg-blue-600 hover:bg-blue-700 text-black py-3 rounded font-bold transition text-xs md:text-sm"><i class="fa-solid fa-university mr-1"></i>Bank</button>
                                <button onclick="checkout('split')" class="bg-purple-600 hover:bg-purple-700 text-white py-3 rounded font-bold transition text-xs md:text-sm"><i class="fa-solid fa-arrows-split-up-and-left mr-1"></i>Split</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- INVOICES -->
                <section id="invoices" class="hidden space-y-6 pb-20 md:pb-0">
                    <div class="flex flex-col gap-4">
                        <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-end">
                            <input type="text" id="invoiceSearch" placeholder="Search Invoice # or Customer Name..." class="input-field flex-1" onkeyup="loadInvoices()">
                            <input type="date" id="invoiceDateFilter" class="input-field md:w-48" onchange="loadInvoices()" title="Filter by Date">
                            <button onclick="clearInvoiceFilters()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded font-bold text-xs whitespace-nowrap">Clear All</button>
                        </div>
                    </div>
                    <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                        <div class="table-container">
                            <table class="w-full text-left text-sm min-w-[600px]">
                                <thead class="bg-white/5 text-gray-400">
                                    <tr>
                                        <th class="p-3">Date</th>
                                        <th class="p-3">Invoice #</th>
                                        <th class="p-3">Customer</th>
                                        <th class="p-3 text-right">Amount</th>
                                        <th class="p-3 text-center">Status</th>
                                        <th class="p-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceListBody" class="divide-y divide-gray-800">
                                    <tr>
                                        <td colspan="6" class="p-8">
                                            <div class="empty-state">
                                                <div class="empty-state-icon"><i class="fa-solid fa-file-invoice"></i></div>
                                                <div class="empty-state-title">No Invoices Yet</div>
                                                <div class="empty-state-text">Create your first invoice from the POS terminal</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- RETURNS & REFUNDS -->
                <section id="returns" class="hidden space-y-6 pb-20 md:pb-0">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        
                        <!-- LEFT: CUSTOMER RETURN (SALES RETURN) -->
                        <div class="bg-karta-surface border border-karta-border rounded-lg p-4 flex flex-col h-full">
                            <div class="border-b border-gray-700 pb-3 mb-3">
                                <h3 class="font-bold text-white text-lg"><i class="fa-solid fa-user-tag text-blue-500 mr-2"></i>Sales Return (From Customer)</h3>
                                <p class="text-xs text-gray-400">Process customer returns. Restocks items & refunds payment.</p>
                            </div>
                            
                            <div class="space-y-3 mb-auto">
                                <div>
                                    <label class="text-xs text-gray-400">Select Customer</label>
                                    <select id="retCustSelect" class="input-field" onchange="loadReturnProducts('cust')"></select>
                                </div>
                                
                                <div>
                                    <label class="text-xs text-gray-400">Select Product to Return</label>
                                    <select id="retCustProd" class="input-field" onchange="updateReturnPrice('cust')"></select>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="bg-white/5 p-2 rounded border border-gray-700">
                                        <div class="text-xs text-gray-500">Price</div>
                                        <div class="text-lg font-bold text-white" id="retCustPrice">-</div>
                                    </div>
                                    <div class="bg-white/5 p-2 rounded border border-gray-700">
                                        <div class="text-xs text-gray-500">Max Qty</div>
                                        <div class="text-lg font-bold text-white" id="retCustQtyPurchased">-</div>
                                    </div>
                                </div>

                                <div>
                                    <label class="text-xs text-gray-400">Quantity to Return</label>
                                    <input type="number" id="retCustQty" class="input-field text-sm" value="1" min="1" onchange="updateReturnPrice('cust')">
                                </div>

                                <button onclick="addToReturnCart('cust')" class="w-full bg-karta-primary text-black py-2 rounded font-bold text-sm hover:bg-karta-primaryDark transition">
                                    <i class="fa-solid fa-plus mr-1"></i> Add to Return Cart
                                </button>
                            </div>

                            <!-- Return Cart -->
                            <div class="border-t border-gray-700 mt-3 pt-3">
                                <p class="text-xs text-gray-400 mb-2">Return Items (<span id="retCustCartCount">0</span>):</p>
                                <div id="retCustCart" class="space-y-1 max-h-48 overflow-y-auto mb-3">
                                    <p class="text-xs text-gray-600">No items added</p>
                                </div>

                                <div class="bg-white/5 p-2 rounded border border-gray-700 mb-3">
                                    <div class="flex justify-between text-sm text-gray-300">
                                        <span>Total Refund:</span>
                                        <span class="font-bold text-karta-primary" id="retCustTotal">$0.00</span>
                                    </div>
                                </div>

                                <!-- Payment Method -->
                                <div class="mb-3">
                                    <label class="text-xs text-gray-400 mb-2 block">Refund Mode</label>
                                    <div class="grid grid-cols-2 gap-1">
                                        <label class="flex items-center px-2 py-1 rounded border border-karta-border bg-karta-primary/20 text-xs cursor-pointer">
                                            <input type="radio" name="retCustPayment" value="cash" checked onchange="toggleReturnSplit('cust')"> Cash
                                        </label>
                                        <label class="flex items-center px-2 py-1 rounded border border-karta-border hover:bg-white/5 text-xs cursor-pointer">
                                            <input type="radio" name="retCustPayment" value="bank" onchange="toggleReturnSplit('cust')"> Bank
                                        </label>
                                        <label class="flex items-center px-2 py-1 rounded border border-karta-border hover:bg-white/5 text-xs cursor-pointer">
                                            <input type="radio" name="retCustPayment" value="credit" onchange="toggleReturnSplit('cust')"> Credit
                                        </label>
                                        <label class="flex items-center px-2 py-1 rounded border border-karta-border hover:bg-white/5 text-xs cursor-pointer">
                                            <input type="radio" name="retCustPayment" value="split" onchange="toggleReturnSplit('cust')"> Split
                                        </label>
                                    </div>
                                </div>

                                <!-- Split Payment Input (Hidden by default) -->
                                <div id="retCustSplitDiv" class="hidden bg-white/5 p-3 rounded border border-karta-border space-y-2">
                                    <p class="text-xs text-gray-400 font-bold">Split Payment:</p>
                                    <div class="flex gap-1">
                                        <div class="flex-1">
                                            <label class="text-xs text-gray-500">Cash</label>
                                            <input type="number" id="retCustSplitCash" class="input-field text-xs" placeholder="0" min="0" step="0.01">
                                        </div>
                                        <div class="flex-1">
                                            <label class="text-xs text-gray-500">Bank</label>
                                            <input type="number" id="retCustSplitBank" class="input-field text-xs" placeholder="0" min="0" step="0.01">
                                        </div>
                                        <div class="flex-1">
                                            <label class="text-xs text-gray-500">Credit</label>
                                            <input type="number" id="retCustSplitCredit" class="input-field text-xs" placeholder="0" min="0" step="0.01">
                                        </div>
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-400">
                                        <span>Total:</span>
                                        <span id="retCustSplitTotal" class="font-bold">$0.00</span>
                                    </div>
                                </div>

                                <button onclick="processReturn('cust')" class="w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded font-bold text-sm transition">
                                    <i class="fa-solid fa-check mr-1"></i> Process Refund
                                </button>
                                <button onclick="clearReturnCart('cust')" class="w-full bg-gray-700 hover:bg-gray-600 text-white py-1 rounded text-xs mt-1 transition">Clear Cart</button>
                            </div>
                        </div>

                        <!-- RIGHT: SUPPLIER RETURN (PURCHASE RETURN) -->
                        <div class="bg-karta-surface border border-karta-border rounded-lg p-4 flex flex-col h-full">
                            <div class="border-b border-gray-700 pb-3 mb-3">
                                <h3 class="font-bold text-white text-lg"><i class="fa-solid fa-truck-ramp-box text-orange-500 mr-2"></i>Purchase Return (To Supplier)</h3>
                                <p class="text-xs text-gray-400">Return items to supplier. Reduces stock & balance.</p>
                            </div>

                            <div class="space-y-3 mb-auto">
                                <div>
                                    <label class="text-xs text-gray-400">Select Supplier</label>
                                    <select id="retSupSelect" class="input-field" onchange="loadReturnProductsSupplier()"></select>
                                </div>
                                
                                <div>
                                    <label class="text-xs text-gray-400">Select Product to Return</label>
                                    <select id="retSupProd" class="input-field" onchange="updateReturnPrice('sup')"></select>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="bg-white/5 p-2 rounded border border-gray-700">
                                        <div class="text-xs text-gray-500">Cost</div>
                                        <div class="text-lg font-bold text-white" id="retSupCost">-</div>
                                    </div>
                                    <div class="bg-white/5 p-2 rounded border border-gray-700">
                                        <div class="text-xs text-gray-500">Stock</div>
                                        <div class="text-lg font-bold text-white" id="retSupStock">-</div>
                                    </div>
                                </div>

                                <div>
                                    <label class="text-xs text-gray-400">Quantity to Return</label>
                                    <input type="number" id="retSupQty" class="input-field text-sm" value="1" min="1" onchange="updateReturnPrice('sup')">
                                </div>

                                <div>
                                    <label class="text-xs text-gray-400">Reason / Notes</label>
                                    <input type="text" id="retSupReason" class="input-field text-sm" placeholder="e.g. Expired, Damaged">
                                </div>

                                <button onclick="addToReturnCart('sup')" class="w-full bg-karta-primary text-black py-2 rounded font-bold text-sm hover:bg-karta-primaryDark transition">
                                    <i class="fa-solid fa-plus mr-1"></i> Add to Return Cart
                                </button>
                            </div>

                            <!-- Return Cart -->
                            <div class="border-t border-gray-700 mt-3 pt-3">
                                <p class="text-xs text-gray-400 mb-2">Return Items (<span id="retSupCartCount">0</span>):</p>
                                <div id="retSupCart" class="space-y-1 max-h-48 overflow-y-auto mb-3">
                                    <p class="text-xs text-gray-600">No items added</p>
                                </div>

                                <div class="bg-white/5 p-2 rounded border border-gray-700 mb-3">
                                    <div class="flex justify-between text-sm text-gray-300">
                                        <span>Total Value:</span>
                                        <span class="font-bold text-karta-primary" id="retSupTotal">$0.00</span>
                                    </div>
                                </div>

                                <!-- Payment Method -->
                                <div class="mb-3">
                                    <label class="text-xs text-gray-400 mb-2 block">Payment Mode</label>
                                    <div class="grid grid-cols-2 gap-1">
                                        <label class="flex items-center px-2 py-1 rounded border border-karta-border bg-karta-primary/20 text-xs cursor-pointer">
                                            <input type="radio" name="retSupPayment" value="cash" checked onchange="toggleReturnSplit('sup')"> Cash
                                        </label>
                                        <label class="flex items-center px-2 py-1 rounded border border-karta-border hover:bg-white/5 text-xs cursor-pointer">
                                            <input type="radio" name="retSupPayment" value="bank" onchange="toggleReturnSplit('sup')"> Bank
                                        </label>
                                        <label class="flex items-center px-2 py-1 rounded border border-karta-border hover:bg-white/5 text-xs cursor-pointer">
                                            <input type="radio" name="retSupPayment" value="credit" onchange="toggleReturnSplit('sup')"> Credit
                                        </label>
                                        <label class="flex items-center px-2 py-1 rounded border border-karta-border hover:bg-white/5 text-xs cursor-pointer">
                                            <input type="radio" name="retSupPayment" value="split" onchange="toggleReturnSplit('sup')"> Split
                                        </label>
                                    </div>
                                </div>

                                <!-- Split Payment Input (Hidden by default) -->
                                <div id="retSupSplitDiv" class="hidden bg-white/5 p-3 rounded border border-karta-border space-y-2">
                                    <p class="text-xs text-gray-400 font-bold">Split Payment:</p>
                                    <div class="flex gap-1">
                                        <div class="flex-1">
                                            <label class="text-xs text-gray-500">Cash</label>
                                            <input type="number" id="retSupSplitCash" class="input-field text-xs" placeholder="0" min="0" step="0.01">
                                        </div>
                                        <div class="flex-1">
                                            <label class="text-xs text-gray-500">Bank</label>
                                            <input type="number" id="retSupSplitBank" class="input-field text-xs" placeholder="0" min="0" step="0.01">
                                        </div>
                                        <div class="flex-1">
                                            <label class="text-xs text-gray-500">Credit</label>
                                            <input type="number" id="retSupSplitCredit" class="input-field text-xs" placeholder="0" min="0" step="0.01">
                                        </div>
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-400">
                                        <span>Total:</span>
                                        <span id="retSupSplitTotal" class="font-bold">$0.00</span>
                                    </div>
                                </div>

                                <button onclick="processReturn('sup')" class="w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded font-bold text-sm transition">
                                    <i class="fa-solid fa-check mr-1"></i> Process Return
                                </button>
                                <button onclick="clearReturnCart('sup')" class="w-full bg-gray-700 hover:bg-gray-600 text-white py-1 rounded text-xs mt-1 transition">Clear Cart</button>
                            </div>
                        </div>

                    </div>
                </section>

                <!-- INVENTORY -->
                <section id="inventory" class="hidden space-y-6 pb-20 md:pb-0">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div class="flex gap-2 w-full md:w-auto">
                            <input type="text" id="invSearch" placeholder="Search Inventory..." class="input-field w-full md:w-64">
                        </div>
                        <div class="flex gap-2 flex-col md:flex-row w-full md:w-auto">
                            <button onclick="openModal('priceManagerModal')" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold flex items-center justify-center gap-2 text-sm">
                                <i class="fa-solid fa-percent"></i> Bulk Price Adjust
                            </button>
                            <button onclick="document.getElementById('prodId').value=''; document.getElementById('prodForm').reset(); openModal('prodModal')" class="w-full md:w-auto bg-karta-primary text-black px-4 py-2 rounded font-bold hover:bg-karta-primaryDark transition flex items-center justify-center gap-2">
                                <i class="fa-solid fa-plus"></i> New Product
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                        <div class="table-container">
                            <table class="w-full text-left text-sm min-w-[1000px]">
                                <thead class="bg-white/5 text-gray-400 border-b border-karta-border">
                                    <tr>
                                        <th class="p-3">Product Name</th>
                                        <th class="p-3">SKU</th>
                                        <th class="p-3">Batch/Expiry</th>
                                        <th class="p-3">Category</th>
                                        <th class="p-3 text-right">Stock</th>
                                        <th class="p-3 text-right">Cost</th>
                                        <th class="p-3 text-right">Retail Price</th>
                                        <th class="p-3 text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="invBody" class="divide-y divide-gray-800">
                                    <tr>
                                        <td colspan="8" class="p-8">
                                            <div class="empty-state">
                                                <div class="empty-state-icon"><i class="fa-solid fa-box-open"></i></div>
                                                <div class="empty-state-title">No Products Yet</div>
                                                <div class="empty-state-text">Add your first product using the "New Product" button above</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- CUSTOMERS -->
                <section id="customers" class="hidden space-y-6 pb-20 md:pb-0">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                            <div class="text-gray-400 text-sm mb-1 flex items-center gap-2"><i class="fa-solid fa-users"></i> Total Customers</div>
                            <div class="text-3xl font-bold text-karta-primary" id="custCount">0</div>
                        </div>
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                            <div class="text-gray-400 text-sm mb-1 flex items-center gap-2"><i class="fa-solid fa-credit-card"></i> Total Due</div>
                            <div class="text-3xl font-bold text-red-500" id="custTotalDue">$0</div>
                        </div>
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                            <div class="text-gray-400 text-sm mb-1 flex items-center gap-2"><i class="fa-solid fa-handshake"></i> Active Customers</div>
                            <div class="text-3xl font-bold text-green-500" id="custActive">0</div>
                        </div>
                    </div>
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <input type="text" id="custSearch" placeholder="Search Customers..." class="input-field w-full md:w-80">
                        <button onclick="document.getElementById('custId').value=''; document.getElementById('custForm').reset(); openModal('custModal')" class="w-full md:w-auto bg-karta-primary text-black px-4 py-2 rounded font-bold hover:bg-karta-primaryDark transition">
                            <i class="fa-solid fa-user-plus"></i> Add Customer
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="custGrid">
                        <!-- Customer Cards JS -->
                        <div class="col-span-full">
                            <div class="empty-state">
                                <div class="empty-state-icon"><i class="fa-solid fa-user-group"></i></div>
                                <div class="empty-state-title">No Customers Yet</div>
                                <div class="empty-state-text">Click "Add Customer" to create a new customer profile</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SUPPLIERS -->
                <section id="suppliers" class="hidden space-y-6 pb-20 md:pb-0">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                            <div class="text-gray-400 text-sm mb-1 flex items-center gap-2"><i class="fa-solid fa-truck"></i> Total Suppliers</div>
                            <div class="text-3xl font-bold text-karta-primary" id="supCount">0</div>
                        </div>
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                            <div class="text-gray-400 text-sm mb-1 flex items-center gap-2"><i class="fa-solid fa-money-check"></i> Total Payable</div>
                            <div class="text-3xl font-bold text-orange-500" id="supTotalDue">$0</div>
                        </div>
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                            <div class="text-gray-400 text-sm mb-1 flex items-center gap-2"><i class="fa-solid fa-inbox"></i> Total Purchased</div>
                            <div class="text-3xl font-bold text-blue-500" id="supTotalPurchased">$0</div>
                        </div>
                    </div>
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <input type="text" id="supSearch" placeholder="Search Suppliers..." class="input-field w-full md:w-64">
                        <button onclick="document.getElementById('supId').value=''; document.getElementById('supForm').reset(); openModal('supModal')" class="w-full md:w-auto bg-karta-primary text-black px-4 py-2 rounded font-bold hover:bg-karta-primaryDark transition">
                            <i class="fa-solid fa-truck"></i> Add Supplier
                        </button>
                    </div>
                    <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                        <div class="table-container">
                            <table class="w-full text-left text-sm min-w-[700px]">
                                <thead class="bg-white/5 text-gray-400">
                                    <tr>
                                        <th class="p-3">Company Name</th>
                                        <th class="p-3">Contact Person</th>
                                        <th class="p-3">Phone</th>
                                        <th class="p-3">Tax/VAT ID</th>
                                        <th class="p-3 text-right">Balance Due</th>
                                        <th class="p-3 text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="supBody" class="divide-y divide-gray-800">
                                    <tr>
                                        <td colspan="6" class="p-8">
                                            <div class="empty-state">
                                                <div class="empty-state-icon"><i class="fa-solid fa-truck"></i></div>
                                                <div class="empty-state-title">No Suppliers Yet</div>
                                                <div class="empty-state-text">Click "Add Supplier" to create a new supplier account</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- PRODUCT SUPPLIER ASSIGNMENT -->
                <section id="productSuppliers" class="hidden space-y-6 pb-20 md:pb-0">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-white">Product Supplier Management</h2>
                        <p class="text-xs text-gray-400">Assign products to specific suppliers</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex flex-col md:flex-row gap-4">
                            <input type="text" id="psmSearch" placeholder="Search products..." class="input-field flex-1" oninput="renderProductSupplierAssignment()">
                            <select id="psmSupplierFilter" class="input-field md:w-64" onchange="renderProductSupplierAssignment()">
                                <option value="">-- All Suppliers --</option>
                            </select>
                        </div>
                        
                        <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                            <div class="table-container">
                                <table class="w-full text-left text-sm min-w-[800px]">
                                    <thead class="bg-white/5 text-gray-400 border-b border-karta-border">
                                        <tr>
                                            <th class="p-3">Product Name</th>
                                            <th class="p-3">SKU</th>
                                            <th class="p-3">Current Supplier</th>
                                            <th class="p-3">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="psmBody" class="divide-y divide-gray-800"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SUPPLIER ASSIGNMENT MODAL -->
                <div id="assignSupplierModal" class="hidden modal-content bg-karta-surface border border-karta-border p-8 rounded-lg w-full max-w-md">
                    <h3 class="text-xl font-bold mb-6 text-white">Assign Supplier to Product</h3>
                    <div id="assignProdInfo" class="bg-white/5 p-4 rounded mb-6 border border-gray-700">
                        <div class="text-base text-gray-400">Product: <span id="assignProdName" class="text-white font-bold text-lg">-</span></div>
                        <div class="text-sm text-gray-500 mt-2">SKU: <span id="assignProdSKU" class="text-gray-300 font-mono">-</span></div>
                        <div id="assignCurrentSupplier" class="text-sm text-gray-400 mt-3 pt-3 border-t border-gray-600">
                            Current: <span id="assignCurrentSupplierName" class="text-yellow-400 font-bold">Unassigned</span>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="text-sm text-gray-400 block mb-3">Select Supplier</label>
                        <select id="assignSupplierSelect" class="input-field w-full text-base">
                            <option value="">-- No Supplier (Unassign) --</option>
                        </select>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="unassignProductSupplier()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded text-white text-sm font-bold transition" title="Remove supplier assignment">
                            <i class="fa-solid fa-unlink mr-1"></i> Unassign
                        </button>
                        <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-white text-sm transition">Cancel</button>
                        <button type="button" onclick="saveProductSupplierAssignment()" class="px-4 py-2 bg-karta-primary hover:bg-green-600 text-black font-bold rounded text-sm transition">
                            <i class="fa-solid fa-check mr-1"></i> Assign
                        </button>
                    </div>
                </div>

                <!-- PURCHASES & EXPENSES -->
                <section id="purchases" class="hidden space-y-6 pb-20 md:pb-0">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                        <h3 class="text-white font-bold text-lg">Transactions & Expenses</h3>
                        <div class="flex gap-2 w-full md:w-auto">
                            <button onclick="openModal('expModal')" class="flex-1 md:flex-none bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-bold text-xs md:text-sm">
                                <i class="fa-solid fa-receipt"></i> Record Expense
                            </button>
                            <button onclick="openModal('purchModal')" class="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold text-xs md:text-sm">
                                <i class="fa-solid fa-cart-shopping"></i> Purchase Order
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-karta-surface border border-karta-border rounded-lg p-4 h-96 overflow-y-auto">
                            <h4 class="font-bold mb-3 text-karta-primary">Purchase History (GRN)</h4>
                            <div id="purchHistory" class="space-y-2"></div>
                        </div>
                        <div class="bg-karta-surface border border-karta-border rounded-lg p-4 h-96 overflow-y-auto">
                            <h4 class="font-bold mb-3 text-red-500">Expense Log</h4>
                            <div id="expHistory" class="space-y-2"></div>
                        </div>
                    </div>

                    <!-- Batch Tracking -->
                    <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                        <div class="p-4 border-b border-karta-border flex justify-between items-center">
                            <h3 class="font-bold text-white text-sm"><i class="fa-solid fa-layer-group text-blue-400 mr-2"></i>Stock Batches (Old & New)</h3>
                            <button onclick="loadBatches()" class="text-xs text-karta-primary hover:underline">Refresh</button>
                        </div>
                        <div class="table-container">
                            <table class="w-full text-left text-xs min-w-[900px]">
                                <thead class="bg-white/5 text-gray-400">
                                    <tr>
                                        <th class="p-3">Product</th>
                                        <th class="p-3">Batch Number</th>
                                        <th class="p-3">Expiry Date</th>
                                        <th class="p-3 text-right">Qty</th>
                                        <th class="p-3 text-right">Cost/Unit</th>
                                        <th class="p-3">Purchase Date</th>
                                        <th class="p-3">Supplier</th>
                                    </tr>
                                </thead>
                                <tbody id="batchBody" class="divide-y divide-gray-800">
                                    <!-- JS Populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- REPORTS -->
                <section id="reports" class="hidden space-y-6 pb-20 md:pb-0">
                    <div class="bg-karta-surface border border-karta-border p-4 rounded-lg flex flex-col gap-4">
                        <div class="flex flex-col md:flex-row gap-4 items-end">
                            <div class="w-full md:w-auto">
                                <label class="text-xs text-gray-400">From Date</label>
                                <input type="date" id="repFrom" class="input-field">
                            </div>
                            <div class="w-full md:w-auto">
                                <label class="text-xs text-gray-400">To Date</label>
                                <input type="date" id="repTo" class="input-field">
                            </div>
                            <div class="w-full md:flex-1 flex justify-end gap-2">
                                <button onclick="exportReportCSV()" class="flex-1 md:flex-none bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded font-bold flex items-center justify-center gap-2 text-xs md:text-sm"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
                                <button onclick="printReport()" class="flex-1 md:flex-none bg-white text-black px-4 py-2 rounded font-bold flex items-center justify-center gap-2 text-xs md:text-sm"><i class="fa-solid fa-print"></i> Print Report</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2">
                            <button onclick="runReports('daily')" class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs">Daily Report</button>
                            <button onclick="runReports('sales')" class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs">Sales Report</button>
                            <button onclick="runReports('vat')" class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs">VAT Report</button>
                            <button onclick="runReports('purchase')" class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs">Purchase Report</button>
                            <button onclick="runReports('expense')" class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs">Expense Report</button>
                            <button onclick="runReports('balance')" class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs">Balance Sheet</button>
                            <button onclick="runReports('debtors')" class="bg-red-700 hover:bg-red-600 text-white py-2 rounded text-xs">Debtors Report</button>
                        </div>
                        <div id="debtorFilterContainer" class="hidden">
                            <label class="text-xs text-gray-400">Search by Location</label>
                            <input type="text" id="debtorLocationSearch" placeholder="e.g., Bharatpur" class="input-field" onkeyup="filterDebtorsReport()">
                        </div>
                    </div>

                    <!-- Dynamic Report Title -->
                    <h3 id="reportTitle" class="text-xl font-bold text-white">Select a Report</h3>

                    <!-- Dynamic Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="reportCards">
                        <!-- Injected via JS -->
                    </div>

                    <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                        <div class="p-3 bg-white/5 font-bold">Details</div>
                        <div class="table-container">
                            <table class="w-full text-left text-xs min-w-[500px]">
                                <thead class="text-gray-400 border-b border-gray-700" id="repHead"></thead>
                                <tbody id="repTable" class="divide-y divide-gray-800"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                 <!-- SETTINGS -->
                 <section id="settings" class="hidden space-y-6 max-w-2xl pb-20 md:pb-0">
                    <div class="bg-karta-surface border border-karta-border rounded-lg p-6">
                        <h3 class="text-xl font-bold mb-4 text-karta-primary">Company Profile & Configuration</h3>
                        <form id="settingsForm" class="space-y-4">
                             <!-- LOGO UPLOAD SECTION -->
                             <div>
                                <label class="block text-xs text-gray-400 mb-1">Brand Logo</label>
                                <div class="flex items-center gap-4">
                                    <div class="h-16 w-16 bg-gray-800 rounded flex items-center justify-center overflow-hidden border border-gray-700 shrink-0">
                                        <img id="confLogoPreview" src="" class="h-full w-full object-contain hidden">
                                        <i id="confLogoPlaceholder" class="fa-solid fa-image text-gray-600"></i>
                                    </div>
                                    <input type="file" id="confLogoInput" accept="image/*" class="text-xs text-gray-400 w-full">
                                    <button type="button" onclick="clearLogo()" class="text-xs text-red-500 hover:text-red-400">Remove</button>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Company Name</label>
                                <input type="text" id="confName" class="input-field">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Address</label>
                                <input type="text" id="confAddr" class="input-field">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Phone</label>
                                    <input type="text" id="confPhone" class="input-field">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Tax/VAT ID</label>
                                    <input type="text" id="confTax" class="input-field">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Default VAT Rate (%)</label>
                                    <input type="number" id="confVatRate" class="input-field">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Currency Symbol</label>
                                    <input type="text" id="confCurr" class="input-field">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Initial Cash on Hand (Opening Balance)</label>
                                    <input type="number" id="confInitialCash" step="0.01" class="input-field" placeholder="0.00">
                                    <p class="text-xs text-gray-500 mt-1">Amount of cash at business start. Used in balance sheet calculations.</p>
                                </div>
                            </div>
                            <button type="submit" class="w-full md:w-auto bg-karta-primary text-black font-bold py-2 px-6 rounded hover:bg-green-600">Save Changes</button>
                        </form>
                        
                        <div class="mt-10 pt-6 border-t border-gray-700 space-y-4">
                            <h4 class="font-bold text-white">Data Management</h4>
                            
                            <!-- FIREBASE CLOUD SYNC -->
                            <div class="p-4 bg-white/5 rounded border border-gray-700 mb-4">
                                <h5 class="text-karta-primary font-bold mb-2"><i class="fa-solid fa-cloud"></i> Private Database</h5>
                                <p class="text-xs text-gray-400 mb-3">You are connected to your private isolated database. Data is synced in real-time only to your account.</p>
                                <div class="text-xs text-green-500"><i class="fa-solid fa-check-circle"></i> Status: Secured & Synced</div>
                                <div class="mt-2 text-xs text-gray-500">Database ID: <span id="dbIdDisplay" class="font-mono text-white">...</span></div>
                            </div>

                            <div class="flex flex-col md:flex-row gap-4">
                                <button onclick="exportDB()" class="bg-gray-700 text-white px-4 py-2 rounded text-xs hover:bg-gray-600 text-center"><i class="fa-solid fa-download"></i> Backup (Export File)</button>
                                <label class="bg-gray-700 text-white px-4 py-2 rounded text-xs hover:bg-gray-600 cursor-pointer text-center">
                                    <i class="fa-solid fa-upload"></i> Restore (Import File)
                                    <input type="file" id="importFile" class="hidden" onchange="importDB(this)">
                                </label>
                            </div>
                            <div class="mt-4">
                                <button onclick="resetData()" class="text-red-500 text-xs hover:text-red-400 underline">Danger: Wipe My Data</button>
                            </div>
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <!-- MODALS -->
    <div id="modalBackdrop" onclick="if(event.target === this) closeModal();" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        
        <!-- Product Modal -->
        <div id="prodModal" class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-white">Product Details</h3>
            <form id="prodForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="prodId">
                <div class="md:col-span-2">
                    <label class="text-xs text-gray-400 font-bold">Product Name <span class="text-red-500">*</span></label>
                    <input type="text" id="pName" required class="input-field" placeholder="e.g., Paracetamol 500mg">
                    <span class="help-text">The name displayed in reports and invoices</span>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">SKU / Barcode <span class="text-red-500">*</span></label>
                    <input type="text" id="pSku" required class="input-field" placeholder="e.g., PAR-500-001">
                    <span class="help-text">Unique identifier for scanning</span>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">Category</label>
                    <input type="text" id="pCat" list="catList" class="input-field" placeholder="e.g., Medicine">
                    <datalist id="catList"><option value="Medicine"><option value="Equipment"><option value="Supplement"></datalist>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">Batch Number</label>
                    <input type="text" id="pBatch" class="input-field" placeholder="e.g., BATCH-001">
                    <span class="help-text">For tracking and expiry management</span>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">Expiry Date</label>
                    <input type="date" id="pExpiry" class="input-field">
                    <span class="help-text">Leave blank if not applicable</span>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">Cost Price <span class="text-red-500">*</span></label>
                    <input type="number" step="0.01" id="pCost" required class="input-field" placeholder="0.00">
                    <span class="help-text">What you paid the supplier</span>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">Retail Price <span class="text-red-500">*</span></label>
                    <input type="number" step="0.01" id="pRetail" required class="input-field" placeholder="0.00">
                    <span class="help-text">Customer/walk-in price</span>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">Wholesale Price</label>
                    <input type="number" step="0.01" id="pWhole" class="input-field" placeholder="0.00">
                    <span class="help-text">For bulk orders (optional)</span>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">Current Stock <span class="text-red-500">*</span></label>
                    <input type="number" id="pStock" required class="input-field" placeholder="0">
                    <span class="help-text">Available quantity now</span>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">Reorder Level</label>
                    <input type="number" id="pReorder" class="input-field" value="10" placeholder="10">
                    <span class="help-text">Alert when stock falls below this</span>
                </div>
                <div class="md:col-span-2">
                    <label class="text-xs text-gray-400 font-bold">Default Supplier (Optional)</label>
                    <select id="pSupplier" class="input-field">
                        <option value="">-- No specific supplier --</option>
                    </select>
                    <span class="help-text">Assign for automatic purchase suggestions</span>
                </div>
                <div class="md:col-span-2 flex justify-end gap-2 mt-4">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-700 rounded text-white hover:bg-gray-600 transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-karta-primary text-black font-bold rounded hover:bg-karta-primaryDark transition">Save Product</button>
                </div>
            </form>
        </div>

        <!-- Invoice Edit Modal -->
        <div id="invEditModal" class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Edit Invoice #<span id="editInvId"></span></h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="mb-4 bg-red-900/20 p-3 rounded border border-red-800 text-red-200 text-xs">
                <i class="fa-solid fa-triangle-exclamation mr-2"></i> Warning: Editing an invoice reverses original stock/balance changes and applies new ones.
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="text-xs text-gray-400">Customer</label>
                    <select id="editInvCust" class="input-field"></select>
                </div>
                <div>
                    <label class="text-xs text-gray-400">Payment Type</label>
                    <select id="editInvPay" class="input-field">
                        <option value="cash">Cash</option>
                        <option value="credit">Credit</option>
                    </select>
                </div>
            </div>
            
            <div class="mb-4">
                <h4 class="text-gray-400 text-xs font-bold mb-2">Items</h4>
                <div id="editInvItems" class="space-y-2 max-h-64 overflow-y-auto"></div>
                <button onclick="addEditItem()" class="mt-2 text-xs text-karta-primary hover:underline">+ Add Item Row</button>
            </div>

            <div class="flex flex-col md:flex-row justify-end gap-2 mt-4 border-t border-gray-700 pt-4">
                <button type="button" onclick="deleteInvoice()" class="px-4 py-2 bg-red-600 rounded text-white md:mr-auto">Delete/Void Invoice</button>
                <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-700 rounded text-white">Cancel</button>
                <button type="button" onclick="saveInvoiceEdit()" class="px-4 py-2 bg-karta-primary text-black font-bold rounded">Save Changes</button>
            </div>
        </div>

        <!-- Customer Modal -->
        <div id="custModal" class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-white">Customer Profile</h3>
            <form id="custForm" class="space-y-4">
                <input type="hidden" id="custId">
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Full Name <span class="text-red-500">*</span></label>
                    <input type="text" id="cName" placeholder="e.g., Raj Poudel" required class="input-field">
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Phone Number <span class="text-red-500">*</span></label>
                    <input type="text" id="cPhone" placeholder="e.g., 9841234567" required class="input-field">
                    <span class="help-text">For SMS updates and reminders</span>
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Address</label>
                    <input type="text" id="cAddr" placeholder="e.g., Bharatpur, Chitwan" class="input-field">
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">VAT/Tax ID</label>
                    <input type="text" id="cTax" placeholder="e.g., 123456789" class="input-field">
                    <span class="help-text">For business customers (optional)</span>
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Credit Limit</label>
                    <input type="number" id="cLimit" placeholder="0.00" class="input-field">
                    <span class="help-text">Maximum amount they can owe</span>
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Initial Balance Due</label>
                    <input type="number" id="cBalance" placeholder="0.00" step="0.01" class="input-field">
                    <span class="help-text">Amount they owe from previous transactions</span>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-700 rounded text-white hover:bg-gray-600 transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-karta-primary text-black font-bold rounded hover:bg-karta-primaryDark transition">Save Customer</button>
                </div>
            </form>
        </div>

        <!-- Customer History & PDF Modal -->
        <div id="custHistoryModal" class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-4xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-start mb-6 shrink-0">
                <div>
                    <h3 class="text-2xl font-bold text-white" id="chName">Customer Name</h3>
                    <p class="text-gray-400 text-sm mt-1"><i class="fa-solid fa-phone mr-2"></i><span id="chPhone"></span> | <i class="fa-solid fa-location-dot mx-2"></i><span id="chAddr"></span></p>
                </div>
                <div class="text-right flex flex-col items-end gap-2">
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times fa-lg"></i></button>
                    <button onclick="downloadCustomerPDF()" class="bg-white text-black px-4 py-2 rounded font-bold text-xs hover:bg-gray-200 transition">
                        <i class="fa-solid fa-file-pdf mr-2"></i>Export
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 shrink-0">
                <div class="bg-white/5 p-4 rounded border border-karta-border">
                    <div class="text-gray-400 text-xs uppercase">Current Balance</div>
                    <div class="text-2xl font-bold text-white mt-1" id="chBalance">$0.00</div>
                </div>
                <div class="bg-white/5 p-4 rounded border border-karta-border">
                    <div class="text-gray-400 text-xs uppercase">Total Spent</div>
                    <div class="text-2xl font-bold text-karta-primary mt-1" id="chTotalSpent">$0.00</div>
                </div>
                <div class="bg-white/5 p-4 rounded border border-karta-border">
                    <div class="text-gray-400 text-xs uppercase">Total Transactions</div>
                    <div class="text-2xl font-bold text-blue-400 mt-1" id="chTxnCount">0</div>
                </div>
            </div>

            <div class="flex-1 overflow-hidden flex flex-col border border-karta-border rounded-lg">
                <div class="bg-white/5 p-3 font-bold border-b border-karta-border text-sm shrink-0">Transaction History</div>
                <div class="overflow-y-auto flex-1">
                    <table class="w-full text-left text-xs" id="chTableContainer">
                        <thead class="bg-karta-surface text-gray-400 sticky top-0">
                            <tr>
                                <th class="p-3">Date</th>
                                <th class="p-3">Type</th>
                                <th class="p-3">Ref</th>
                                <th class="p-3">Details</th>
                                <th class="p-3 text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="chTableBody" class="divide-y divide-gray-800">
                            <!-- Populated via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- NEW: Supplier History Modal -->
        <div id="supHistoryModal" class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-4xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-start mb-6 shrink-0">
                <div>
                    <h3 class="text-2xl font-bold text-white" id="shName">Supplier Name</h3>
                    <p class="text-gray-400 text-sm mt-1"><i class="fa-solid fa-phone mr-2"></i><span id="shPhone"></span> | <i class="fa-solid fa-user-tie mx-2"></i><span id="shContact"></span></p>
                </div>
                <div class="text-right flex flex-col items-end gap-2">
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times fa-lg"></i></button>
                    <button onclick="downloadSupplierPDF()" class="bg-white text-black px-4 py-2 rounded font-bold text-xs hover:bg-gray-200 transition">
                        <i class="fa-solid fa-file-pdf mr-2"></i>Export
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 shrink-0">
                <div class="bg-white/5 p-4 rounded border border-karta-border">
                    <div class="text-gray-400 text-xs uppercase">Current Balance Due</div>
                    <div class="text-2xl font-bold text-red-500 mt-1" id="shBalance">$0.00</div>
                </div>
                <div class="bg-white/5 p-4 rounded border border-karta-border">
                    <div class="text-gray-400 text-xs uppercase">Total Purchased</div>
                    <div class="text-2xl font-bold text-white mt-1" id="shTotalPurchased">$0.00</div>
                </div>
            </div>

            <div class="flex-1 overflow-hidden flex flex-col border border-karta-border rounded-lg">
                <div class="bg-white/5 p-3 font-bold border-b border-karta-border text-sm shrink-0">Supplier Transaction History</div>
                <div class="overflow-y-auto flex-1">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-karta-surface text-gray-400 sticky top-0">
                            <tr>
                                <th class="p-3">Date</th>
                                <th class="p-3">Type</th>
                                <th class="p-3">Ref</th>
                                <th class="p-3">Items/Desc</th>
                                <th class="p-3 text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="shTableBody" class="divide-y divide-gray-800">
                            <!-- Populated via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Customer Payment Modal -->
        <div id="payModal" class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-white"><i class="fa-solid fa-cash-register mr-2 text-green-500"></i>Receive Payment</h3>
            <p id="payCustName" class="text-gray-400 mb-4 text-sm font-bold"></p>
            <form id="payForm" class="space-y-4">
                <input type="hidden" id="payCustId">
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Amount Received <span class="text-red-500">*</span></label>
                    <input type="number" step="0.01" id="payAmount" placeholder="0.00" required class="input-field text-lg font-bold">
                    <span class="help-text">Amount to deduct from customer balance</span>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-700 rounded text-white hover:bg-gray-600 transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white font-bold rounded hover:bg-green-700 transition flex items-center gap-2">
                        <i class="fa-solid fa-check"></i> Record Receipt
                    </button>
                </div>
            </form>
        </div>
        
        <!-- NEW: Supplier Payment Modal -->
        <div id="supPayModal" class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-white"><i class="fa-solid fa-money-bill mr-2 text-orange-500"></i>Record Payment to Supplier</h3>
            <p id="spSupName" class="text-gray-400 mb-4 text-sm font-bold"></p>
            <form id="supPayForm" class="space-y-4">
                <input type="hidden" id="spSupId">
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Amount Paid <span class="text-red-500">*</span></label>
                    <input type="number" step="0.01" id="spAmount" placeholder="0.00" required class="input-field text-lg font-bold">
                    <span class="help-text">Amount to deduct from your payable balance</span>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-700 rounded text-white hover:bg-gray-600 transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-orange-600 text-white font-bold rounded hover:bg-orange-700 transition flex items-center gap-2">
                        <i class="fa-solid fa-check"></i> Record Payment
                    </button>
                </div>
            </form>
        </div>

        <!-- Supplier Modal -->
        <div id="supModal" class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-white">Supplier Profile</h3>
            <form id="supForm" class="space-y-4">
                <input type="hidden" id="supId">
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Company Name <span class="text-red-500">*</span></label>
                    <input type="text" id="sName" placeholder="e.g., ABC Pharma Ltd" required class="input-field">
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Contact Person</label>
                    <input type="text" id="sContact" placeholder="e.g., John Smith" class="input-field">
                    <span class="help-text">Name of primary contact</span>
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Phone</label>
                    <input type="text" id="sPhone" placeholder="e.g., 9841234567" class="input-field">
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">VAT Registration No</label>
                    <input type="text" id="sTax" placeholder="e.g., 123456789" class="input-field">
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Amount You Owe</label>
                    <input type="number" id="sBalance" placeholder="0.00" step="0.01" class="input-field">
                    <span class="help-text">Outstanding balance payable to this supplier</span>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-700 rounded text-white hover:bg-gray-600 transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-karta-primary text-black font-bold rounded hover:bg-karta-primaryDark transition">Save Supplier</button>
                </div>
            </form>
        </div>

         <!-- Purchase Modal -->
         <div id="purchModal" class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-5xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-karta-border">
                <h3 class="text-2xl font-bold text-white flex items-center gap-2"><i class="fa-solid fa-cart-shopping text-karta-primary"></i>Purchase Order</h3>
                <button type="button" onclick="closeModal()" class="text-gray-400 hover:text-white text-xl"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <form id="purchForm" class="space-y-6">
                <!-- Supplier Selection -->
                <div>
                    <label class="text-xs font-bold text-gray-400 mb-2 block uppercase tracking-wide">🏢 Select Supplier</label>
                    <select id="poSup" onchange="loadSupplierProducts()" class="input-field w-full" required>
                        <option value="">-- Choose Supplier --</option>
                    </select>
                </div>

                <!-- Purchase Items -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wide">📦 Purchase Items</label>
                        <button type="button" onclick="addPurchaseItem()" class="bg-karta-primary hover:bg-karta-primaryDark text-black px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-1">
                            <i class="fa-solid fa-plus"></i> Add Item
                        </button>
                    </div>
                    <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                        <div class="table-container">
                            <table class="w-full text-xs min-w-[1000px]">
                                <thead class="bg-white/5 text-gray-400 border-b border-karta-border">
                                    <tr>
                                        <th class="p-3 text-left font-bold">Product</th>
                                        <th class="p-3 text-center font-bold w-20">Qty</th>
                                        <th class="p-3 text-right font-bold w-24">Unit Price</th> 
                                        <th class="p-3 text-right font-bold w-24">Total</th>
                                        <th class="p-3 text-center font-bold w-24">Batch #</th>
                                        <th class="p-3 text-center font-bold w-28">Expiry</th>
                                        <th class="p-3 text-center font-bold w-12">✕</th>
                                    </tr>
                                </thead>
                                <tbody id="purchItemsBody" class="divide-y divide-gray-800">
                                    <tr><td colspan="7" class="p-6 text-center text-gray-500 text-sm">Click "Add Item" to start adding products</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                    <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                        <p class="text-xs text-gray-400 mb-1">Items</p>
                        <p class="text-2xl font-bold text-karta-primary" id="purchTotalItems">0</p>
                    </div>
                    <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                        <p class="text-xs text-gray-400 mb-1">Total Qty</p>
                        <p class="text-2xl font-bold text-white" id="purchTotalQty">0</p>
                    </div>
                    <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                        <p class="text-xs text-gray-400 mb-1">Grand Total</p>
                        <p class="text-2xl font-bold text-green-400" id="purchGrandTotal">$0.00</p>
                    </div>
                    <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                        <label class="text-xs text-gray-400 mb-1 block">Ref No</label>
                        <input type="text" id="poRef" placeholder="Auto-gen" class="input-field text-sm" style="background-color: #0b0b0b; border: none;">
                    </div>
                </div>

                <!-- Payment Method Selection -->
                <div class="border-t border-karta-border pt-4">
                    <label class="text-xs font-bold text-gray-400 mb-3 block uppercase tracking-wide">💳 Payment Method</label>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <label class="flex items-center justify-center px-4 py-3 rounded border-2 border-karta-border bg-karta-primary/20 text-karta-primary cursor-pointer transition hover:bg-karta-primary/40" title="Pay cash now - Reduces cash balance">
                            <input type="radio" name="purchPayment" value="cash" checked class="mr-2" onchange="updatePaymentDisplay()"> 
                            <span class="font-bold"><i class="fa-solid fa-money-bill mr-1"></i>Cash</span>
                        </label>
                        <label class="flex items-center justify-center px-4 py-3 rounded border-2 border-karta-border hover:bg-white/5 text-white cursor-pointer transition" title="Purchase on credit - Add to supplier balance">
                            <input type="radio" name="purchPayment" value="credit" class="mr-2" onchange="updatePaymentDisplay()"> 
                            <span class="font-bold"><i class="fa-solid fa-handshake mr-1"></i>Credit</span>
                        </label>
                        <label class="flex items-center justify-center px-4 py-3 rounded border-2 border-karta-border hover:bg-white/5 text-white cursor-pointer transition" title="Split payment - Part cash, part credit">
                            <input type="radio" name="purchPayment" value="split" class="mr-2" onchange="updatePaymentDisplay()"> 
                            <span class="font-bold"><i class="fa-solid fa-arrows-split-up-and-left mr-1"></i>Split</span>
                        </label>
                    </div>

                    <!-- Split Payment Input (Hidden by default) -->
                    <div id="splitPaymentSection" class="hidden bg-white/5 p-4 rounded border border-karta-border mb-4">
                        <label class="text-xs font-bold text-gray-400 mb-3 block">💰 Split Payment Details</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-400">Cash Amount</label>
                                <input type="number" id="splitCashAmount" class="input-field" placeholder="0.00" step="0.01" min="0" oninput="calculateSplitCredit()">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">Credit Amount</label>
                                <input type="number" id="splitCreditAmount" class="input-field" placeholder="0.00" step="0.01" min="0" readonly style="background-color: #0a0a0a; opacity: 0.7;">
                            </div>
                        </div>
                        <div class="mt-3 p-3 bg-blue-900/20 border border-blue-800 rounded text-xs text-blue-300">
                            <i class="fa-solid fa-info-circle mr-2"></i>
                            Grand Total: <span id="splitTotalDisplay" class="font-bold">$0.00</span> | Cash: <span id="splitCashDisplay" class="font-bold text-green-400">$0.00</span> | Credit: <span id="splitCreditDisplay" class="font-bold text-yellow-400">$0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end gap-2 pt-4 border-t border-karta-border">
                    <button type="button" onclick="clearPurchaseForm()" class="px-4 py-2.5 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded text-sm font-bold transition">Clear All</button>
                    <button type="button" onclick="closeModal()" class="px-4 py-2.5 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded text-sm font-bold transition">Cancel</button>
                    <button type="submit" class="px-4 py-2.5 bg-karta-primary hover:bg-karta-primaryDark text-black rounded text-sm font-bold transition flex items-center gap-2">
                        <i class="fa-solid fa-check"></i> Confirm Purchase
                    </button>
                </div>
            </form>
        </div>

         <!-- Expense Modal -->
         <div id="expModal" class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-red-500"><i class="fa-solid fa-receipt mr-2"></i>Record Expense</h3>
            <form id="expForm" class="space-y-4">
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Description <span class="text-red-500">*</span></label>
                    <input type="text" id="expDesc" placeholder="e.g., Office Rent, Utilities, Transport" required class="input-field">
                    <span class="help-text">What is this expense for?</span>
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Amount <span class="text-red-500">*</span></label>
                    <input type="number" step="0.01" id="expAmt" placeholder="0.00" required class="input-field text-lg font-bold">
                    <span class="help-text">This will reduce your available cash</span>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-700 rounded text-white hover:bg-gray-600 transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white font-bold rounded hover:bg-red-700 transition flex items-center gap-2">
                        <i class="fa-solid fa-check"></i> Save Expense
                    </button>
                </div>
            </form>
        </div>

        <!-- PRICE MANAGER MODAL - NEW FEATURE -->
        <!-- Split Sales Payment Modal -->
        <div id="splitSalesModal" class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-md">
            <h3 class="text-xl font-bold mb-4 text-white">Split Payment - Sales</h3>
            <div class="bg-white/5 p-4 rounded border border-gray-700 mb-4">
                <div class="text-gray-400 text-sm">Total Amount:</div>
                <div class="text-2xl font-bold text-karta-primary" id="splitSalesTotal">$0.00</div>
            </div>
            
            <div class="space-y-3 mb-6">
                <div>
                    <label class="text-xs text-gray-400">💰 Cash Amount</label>
                    <input type="number" id="splitSalesCash" class="input-field" placeholder="0.00" step="0.01" min="0" oninput="calculateSplitSales()" value="0">
                </div>
                <div>
                    <label class="text-xs text-gray-400">🏦 Bank Amount</label>
                    <input type="number" id="splitSalesBank" class="input-field" placeholder="0.00" step="0.01" min="0" oninput="calculateSplitSales()" value="0">
                </div>
                <div>
                    <label class="text-xs text-gray-400">💳 Credit Amount</label>
                    <input type="number" id="splitSalesCredit" class="input-field" placeholder="0.00" step="0.01" min="0" oninput="calculateSplitSales()" value="0">
                </div>
            </div>

            <div class="bg-blue-900/20 p-3 rounded border border-blue-800 text-xs text-blue-300 mb-4">
                <i class="fa-solid fa-info-circle mr-2"></i>
                Remaining: <span id="splitSalesRemaining" class="font-bold">$0.00</span>
            </div>

            <div class="flex justify-end gap-2">
                <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-700 rounded text-white">Cancel</button>
                <button type="button" onclick="confirmSplitSales()" class="px-4 py-2 bg-karta-primary text-black font-bold rounded">Confirm Payment</button>
            </div>
        </div>

        <div id="priceManagerModal" class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-karta-primary"><i class="fa-solid fa-percent mr-2"></i>Bulk Price Adjustment</h3>
            
            <div class="space-y-6">
                <!-- TAB 1: ADJUST ALL PRODUCTS -->
                <div class="border border-karta-border rounded-lg p-4">
                    <h4 class="font-bold text-white mb-3"><i class="fa-solid fa-list"></i> Adjust All Products</h4>
                    <p class="text-xs text-gray-400 mb-3">Apply percentage change to ALL product prices</p>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-400">Adjustment Type</label>
                            <select id="priceAdjustType" class="input-field">
                                <option value="retail">Retail Price Only</option>
                                <option value="both">Both Retail & Wholesale</option>
                                <option value="cost">Cost Price (affects profit margin)</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-400">Percentage Change (%)</label>
                                <input type="number" id="pricePercentage" class="input-field" placeholder="e.g. 10 or -5" step="0.1">
                            </div>
                            <div class="bg-white/5 p-3 rounded border border-gray-700 flex items-end">
                                <div>
                                    <div class="text-xs text-gray-500">Preview:</div>
                                    <div class="text-sm font-bold text-karta-primary" id="pricePreview">₹100 → ₹100</div>
                                </div>
                            </div>
                        </div>
                        <button type="button" onclick="applyBulkPriceChange()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded font-bold text-sm">
                            <i class="fa-solid fa-check mr-2"></i>Apply to All Products
                        </button>
                    </div>
                </div>

                <!-- TAB 2: ADJUST BY CATEGORY -->
                <div class="border border-karta-border rounded-lg p-4">
                    <h4 class="font-bold text-white mb-3"><i class="fa-solid fa-filter"></i> Adjust by Category</h4>
                    <p class="text-xs text-gray-400 mb-3">Apply price change to specific category only</p>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-400">Select Category</label>
                            <select id="priceCategoryFilter" class="input-field">
                                <option value="">-- Select Category --</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Adjustment Type</label>
                            <select id="priceCategoryAdjustType" class="input-field">
                                <option value="retail">Retail Price Only</option>
                                <option value="both">Both Retail & Wholesale</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-400">Percentage Change (%)</label>
                                <input type="number" id="priceCategoryPercentage" class="input-field" placeholder="e.g. 10 or -5" step="0.1">
                            </div>
                            <div class="text-xs text-gray-500">
                                Products to update: <span class="font-bold text-white" id="categoryProductCount">0</span>
                            </div>
                        </div>
                        <button type="button" onclick="applyBulkPriceChangeByCategory()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded font-bold text-sm">
                            <i class="fa-solid fa-check mr-2"></i>Apply to Category
                        </button>
                    </div>
                </div>

                <!-- TAB 3: INDIVIDUAL PRODUCT -->
                <div class="border border-karta-border rounded-lg p-4">
                    <h4 class="font-bold text-white mb-3"><i class="fa-solid fa-pen"></i> Edit Individual Product</h4>
                    <p class="text-xs text-gray-400 mb-3">Update price for a single product</p>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-400">Select Product</label>
                            <select id="priceProductSelect" class="input-field" onchange="loadProductPriceFields()">
                                <option value="">-- Select Product --</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs text-gray-400">Cost Price</label>
                                <input type="number" id="priceProductCost" class="input-field" step="0.01" placeholder="Cost">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">Retail Price</label>
                                <input type="number" id="priceProductRetail" class="input-field" step="0.01" placeholder="Retail">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">Wholesale Price</label>
                                <input type="number" id="priceProductWholesale" class="input-field" step="0.01" placeholder="Wholesale">
                            </div>
                        </div>
                        <div class="bg-blue-900/20 p-3 rounded border border-blue-800 text-xs text-blue-300">
                            <i class="fa-solid fa-info-circle mr-2"></i>
                            Profit Margin: <span id="profitMarginDisplay" class="font-bold">--</span>
                        </div>
                        <button type="button" onclick="updateIndividualProductPrice()" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 rounded font-bold text-sm">
                            <i class="fa-solid fa-save mr-2"></i>Save Individual Price
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-6 border-t border-gray-700 pt-4">
                <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-700 rounded text-white">Close</button>
            </div>
        </div>
    </div>

    <!-- Hidden Printable Invoice Area -->
    <div id="printable-area">
        <!-- INVOICE VIEW - Nepali VAT Format -->
        <div id="invoice-print-view" style="font-family: Arial, sans-serif; color: #000; background: white; padding: 0;">
            <!-- Main Border Container -->
            <div style="border: 2px solid #000; padding: 20px; width: 100%; box-sizing: border-box;">
                
                <!-- Header Section with Border -->
                <div style="border-bottom: 2px solid #000; padding-bottom: 12px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <!-- Company Logo & Info -->
                        <div style="display: flex; gap: 12px; flex: 1;">
                            <img id="printInvLogo" src="" style="width: 70px; height: 70px; object-fit: contain; display: none; border: 1px solid #000; padding: 2px;">
                            <div>
                                <h1 style="font-size: 22px; font-weight: bold; margin: 0; color: #000;" id="invCompName">KARTA PHARMACY</h1>
                                <p style="margin: 3px 0; font-size: 12px; font-weight: bold;">VAT Registration Number: <span id="invCompTax" style="font-weight: normal;">123456789</span></p>
                                <p style="margin: 2px 0; font-size: 11px;" id="invCompAddr">Address: 123 Green Street</p>
                                <p style="margin: 2px 0; font-size: 11px;" id="invCompPhone">Phone: 9800000000</p>
                            </div>
                        </div>
                        
                        <!-- Invoice Title & Number -->
                        <div style="text-align: center; border-left: 2px solid #000; padding-left: 15px;">
                            <h2 style="font-size: 24px; font-weight: bold; color: #000; margin: 0;">TAX INVOICE</h2>
                            <p style="margin: 5px 0; font-size: 13px; font-weight: bold;">Invoice No: <span id="invNo">INV-001</span></p>
                            <p style="margin: 2px 0; font-size: 11px;">Date: <span id="invDate">2025-01-01</span></p>
                        </div>
                    </div>
                </div>

                <!-- Customer Info Box with Borders -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <!-- Bill To -->
                    <div style="border: 1px solid #000; padding: 10px;">
                        <p style="margin: 0; font-weight: bold; font-size: 12px; border-bottom: 1px solid #000; padding-bottom: 5px;">BILL TO:</p>
                        <p style="margin: 5px 0; font-size: 12px; font-weight: bold;" id="invCustName">Guest Customer</p>
                        <p style="margin: 2px 0; font-size: 11px;" id="invCustContact"></p>
                        <p style="margin: 2px 0; font-size: 11px;" id="invCustTaxId"></p>
                    </div>
                    
                    <!-- Barcode Section -->
                    <div style="border: 1px solid #000; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <p style="margin: 0 0 8px 0; font-size: 10px; font-weight: bold;">BARCODE / SKU</p>
                        <svg id="invBarcode" style="width: 100px; height: 50px;"></svg>
                        <p style="margin: 5px 0 0 0; font-size: 10px;" id="invBarcodeText">N/A</p>
                    </div>
                </div>

                <!-- Items Table with Full Borders -->
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 12px; border: 1px solid #000;">
                    <thead>
                        <tr style="background: #e8e8e8; border-bottom: 2px solid #000;">
                            <th style="padding: 8px; text-align: center; border-right: 1px solid #000; width: 5%;">S.N.</th>
                            <th style="padding: 8px; text-align: left; border-right: 1px solid #000; flex: 1;">Description / Item Details</th>
                            <th style="padding: 8px; text-align: center; border-right: 1px solid #000; width: 10%;">Unit</th>
                            <th style="padding: 8px; text-align: right; border-right: 1px solid #000; width: 12%;">Qty</th>
                            <th style="padding: 8px; text-align: right; border-right: 1px solid #000; width: 12%;">Unit Price</th>
                            <th style="padding: 8px; text-align: right; border-right: 1px solid #000; width: 12%;">Amount</th>
                            <th style="padding: 8px; text-align: center; border-right: 1px solid #000; width: 8%;">VAT%</th>
                            <th style="padding: 8px; text-align: right; width: 12%;">VAT Amt</th>
                        </tr>
                    </thead>
                    <tbody id="invItemsBody" style="border-bottom: 2px solid #000;">
                        <!-- Items with individual VAT columns -->
                    </tbody>
                </table>

                <!-- Summary Section with Borders -->
                <div style="border: 1px solid #000; margin-bottom: 15px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <tr>
                            <td style="padding: 8px; text-align: right; border-right: 1px solid #000; width: 70%;">
                                <strong>Taxable Amount (Subtotal):</strong>
                            </td>
                            <td style="padding: 8px; text-align: right; border-right: 1px solid #000; width: 15%;">
                                <span id="invSub">0.00</span>
                            </td>
                            <td style="padding: 8px; width: 15%;"></td>
                        </tr>
                        <tr style="background: #f5f5f5; border-top: 1px solid #000;">
                            <td style="padding: 8px; text-align: right; border-right: 1px solid #000;">
                                <strong>Total VAT (13%):</strong>
                            </td>
                            <td style="padding: 8px; text-align: right; border-right: 1px solid #000;">
                                <span id="invTax">0.00</span>
                            </td>
                            <td style="padding: 8px;"></td>
                        </tr>
                        <tr id="invDiscountRow" style="display: none; border-top: 1px solid #000;">
                            <td style="padding: 8px; text-align: right; border-right: 1px solid #000;">
                                <strong>Discount (<span id="invDiscountPercent">0</span>%):</strong>
                            </td>
                            <td style="padding: 8px; text-align: right; border-right: 1px solid #000;">
                                <span id="invDiscount">0.00</span>
                            </td>
                            <td style="padding: 8px;"></td>
                        </tr>
                        <tr style="background: #ffeb99; border-top: 2px solid #000; border-bottom: 2px solid #000;">
                            <td style="padding: 10px; text-align: right; border-right: 1px solid #000; font-weight: bold; font-size: 13px;">
                                GRAND TOTAL (INCL. VAT):
                            </td>
                            <td style="padding: 10px; text-align: right; border-right: 1px solid #000; font-weight: bold; font-size: 14px;">
                                <span id="invTotal">0.00</span>
                            </td>
                            <td style="padding: 10px; font-weight: bold; font-size: 11px;" id="invTotalWords">Zero</td>
                        </tr>
                    </table>
                </div>

                <!-- Payment & Notes Section -->
                <div style="border: 1px solid #000; padding: 10px; margin-bottom: 15px; font-size: 11px;">
                    <p style="margin: 0 0 5px 0;"><strong>Payment Method:</strong> <span id="invPayMethod">Cash</span></p>
                    <p style="margin: 0;"><strong>Notes:</strong> <span id="invNotes">Thank you for your business. Get well soon!</span></p>
                </div>

                <!-- Signature Section with Boxes -->
                <div style="border: 1px solid #000; padding: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; font-size: 11px;">
                        <!-- Checked By -->
                        <div style="text-align: center; border-top: 1px solid #000; padding-top: 40px;">
                            <p style="margin: 0; font-weight: bold;">Checked By</p>
                            <p style="margin: 3px 0 0 0; font-size: 10px;">(Authorized Signatory)</p>
                            <p style="margin: 3px 0 0 0; font-size: 9px;">Signature & Seal</p>
                        </div>
                        
                        <!-- Company Representative -->
                        <div style="text-align: center; border-top: 1px solid #000; padding-top: 40px;">
                            <p style="margin: 0; font-weight: bold;">Issued By</p>
                            <p style="margin: 3px 0 0 0; font-size: 10px;">(<span id="invCompRepName">Company Name</span>)</p>
                            <p style="margin: 3px 0 0 0; font-size: 9px;">Name & Signature</p>
                        </div>
                        
                        <!-- Buyer Signature -->
                        <div style="text-align: center; border-top: 1px solid #000; padding-top: 40px;">
                            <p style="margin: 0; font-weight: bold;">Buyer/Customer</p>
                            <p style="margin: 3px 0 0 0; font-size: 10px;" id="invCustSignature">Signature</p>
                            <p style="margin: 3px 0 0 0; font-size: 9px;">Date: <span id="invSignDate"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div style="margin-top: 15px; text-align: center; font-size: 10px; border-top: 1px solid #000; padding-top: 10px;">
                    <p style="margin: 3px 0;">This is a Computer Generated Tax Invoice. Authorized signatory is not required.</p>
                    <p style="margin: 3px 0;">Generated by KARTA Pharmacy Management System</p>
                </div>
            </div>
        </div>

        <!-- REPORT VIEW (Hidden by default) -->
        <div id="report-print-view" class="hidden">
            <!-- Generated via JS -->
        </div>
    </div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        // IMPORT ONVALUE FOR REALTIME UPDATES
        import { getDatabase, ref, set, get, child, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAR_ZXBaDY19TwNpK-grHbrQM-E1nadDp8",
            authDomain: "account-9482d.firebaseapp.com",
            databaseURL: "https://account-9482d-default-rtdb.firebaseio.com",
            projectId: "account-9482d",
            storageBucket: "account-9482d.firebasestorage.app",
            messagingSenderId: "742088303662",
            appId: "1:742088303662:web:c23726104923389f156bbf",
            measurementId: "G-K165K36HRF"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const dbRealtime = getDatabase(app);
        
        // --- Firebase Auth & Sync Logic ---
        const authScreen = document.getElementById('auth-screen');
        const appRoot = document.getElementById('app-root');
        const authError = document.getElementById('authError');
        const syncStatusIndicator = document.getElementById('syncStatusIndicator');
        let currentUser = null;
        let dbUnsubscribe = null; // Store listener to detach on logout
        let DB_KEY = ''; // DYNAMIC KEY: Will be set to 'karta_db_UID'

        /** CORE INITIAL STATE - No data loaded yet **/
        const APP_STATE = {
            config: {
                name: 'Karta Pharmacy', address: 'Kathmandu, Nepal', phone: '+977-9800000000',
                taxId: 'PAN-101010', vatRate: 13, currency: 'Rs.', logo: null
            },
            products: [],   
            customers: [], 
            suppliers: [],
            batches: [],
            transactions: []
        };
        
        // Start with empty state
        let db = JSON.parse(JSON.stringify(APP_STATE));
        let cart = [];
        let editTxnId = null;
        let currentReportData = [];
        let currentReportTitle = ""; 
        let activeCustomerReportId = null; 
        let activeSupplierReportId = null;
        let tempLogoBase64 = null;

        /**
         * CRITICAL FIX: Ensure DB integrity
         * Firebase Realtime Database deletes keys if they are empty arrays (e.g. products: []).
         * When data comes back from cloud, if products is missing, the app crashes.
         * This function forces empty arrays to exist if they are missing.
         */
        function ensureDbStructure(data) {
            if (!data) return JSON.parse(JSON.stringify(APP_STATE));
            return {
                config: data.config || APP_STATE.config,
                // If Array is missing (deleted by Firebase optimization), force empty array []
                products: Array.isArray(data.products) ? data.products : [],
                customers: Array.isArray(data.customers) ? data.customers : [],
                suppliers: Array.isArray(data.suppliers) ? data.suppliers : [],
                transactions: Array.isArray(data.transactions) ? data.transactions : []
            };
        }

        // AUTH & ISOLATION LOGIC
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                
                // 1. GENERATE UNIQUE KEY FOR THIS USER
                DB_KEY = `karta_db_${user.uid}`;
                
                // 2. LOAD LOCAL DATA SPECIFIC TO THIS USER
                const localData = localStorage.getItem(DB_KEY);
                if (localData) {
                    // FIX: Run through sanitizer
                    db = ensureDbStructure(JSON.parse(localData));
                } else {
                    db = JSON.parse(JSON.stringify(APP_STATE));
                }
                
                refreshUI(); // Show data immediately
                
                authScreen.classList.add('hidden');
                appRoot.classList.remove('hidden');
                appRoot.classList.remove('opacity-0');
                document.getElementById('userEmailDisplay').innerText = user.email;
                document.getElementById('dbIdDisplay').innerText = user.uid.slice(0,8) + "...";
                
                console.log("Logged in as: ", user.email);
                
                // 3. START SECURE CLOUD SYNC
                // Path is securely isolated to users/{uid}/data
                const userRef = ref(dbRealtime, 'users/' + user.uid + '/data');
                
                // Set up real-time listener
                dbUnsubscribe = onValue(userRef, (snapshot) => {
                    const cloudData = snapshot.val();
                    if (cloudData) {
                        // Data exists in cloud, update local state
                        // FIX: Run through sanitizer to prevent "undefined" arrays crash
                        db = ensureDbStructure(cloudData);
                        
                        localStorage.setItem(DB_KEY, JSON.stringify(db)); // Update Isolated Local Storage
                        refreshUI();
                        console.log("Data synced from Cloud");
                        updateSyncStatus("Synced", "text-green-500");
                    } else {
                        // No data in cloud (New User), upload current local default
                        updateSyncStatus("Initializing Private DB...", "text-yellow-500");
                        set(userRef, db);
                    }
                });

            } else {
                // User is signed out
                currentUser = null;
                DB_KEY = ''; // Clear key
                if(dbUnsubscribe) dbUnsubscribe(); // Stop listening
                
                // WIPE MEMORY FOR SECURITY
                db = JSON.parse(JSON.stringify(APP_STATE));
                
                appRoot.classList.add('hidden');
                appRoot.classList.add('opacity-0');
                authScreen.classList.remove('hidden');
            }
        });
        
        function updateSyncStatus(text, colorClass) {
            syncStatusIndicator.innerHTML = `<i class="fa-solid fa-circle text-[8px]"></i> ${text}`;
            syncStatusIndicator.className = colorClass;
        }

        // Sign In
        document.getElementById('authForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            authError.classList.add('hidden');

            signInWithEmailAndPassword(auth, email, pass)
                .then((userCredential) => {
                    // Signed in via onAuthStateChanged
                })
                .catch((error) => {
                    authError.innerText = error.message;
                    authError.classList.remove('hidden');
                });
        });

        // Sign Up
        document.getElementById('btnSignUp').addEventListener('click', () => {
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            if(!email || !pass) return alert("Enter email and password to create account");

            createUserWithEmailAndPassword(auth, email, pass)
                .then((userCredential) => {
                    alert("Account Created! You are now logged in.");
                })
                .catch((error) => {
                    authError.innerText = error.message;
                    authError.classList.remove('hidden');
                });
        });

        // Global Logout
        window.handleLogout = () => {
            if(confirm("Are you sure you want to logout?")) {
                signOut(auth).then(() => {
                    location.reload(); // Reload to clear memory completely
                }).catch((error) => {
                    alert("Error signing out");
                });
            }
        };


        /** KARTA CORE LOGIC **/
        
        // --- NEW: Toggle Sidebar for Mobile ---
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('mobile-backdrop');
            
            // Check if closed
            const isClosed = sidebar.classList.contains('-translate-x-full');
            
            if (isClosed) {
                // Open
                sidebar.classList.remove('-translate-x-full');
                backdrop.classList.remove('hidden');
            } else {
                // Close
                sidebar.classList.add('-translate-x-full');
                backdrop.classList.add('hidden');
            }
        }

        // MONEY ROUNDING UTILITY - Fixes Penny Drift
        // Round to 2 decimal places to prevent floating point errors
        function moneyRound(value) {
            return Math.round(value * 100) / 100;
        }

        // MODIFIED AUTO-SAVE FUNCTION
        // Debounce saveDB to prevent excessive saves
        let saveTimeout = null;
        function saveDB() {
            if(!currentUser || !DB_KEY) return;
            
            // Clear previous timeout
            if(saveTimeout) clearTimeout(saveTimeout);
            
            // Debounce: Save after 500ms of inactivity
            saveTimeout = setTimeout(() => {
                // 1. Save Locally to ISOLATED Key
                localStorage.setItem(DB_KEY, JSON.stringify(db));
                
                // 2. Auto-Save to Cloud (If Logged In)
                updateSyncStatus("Saving...", "text-yellow-500");
                const userRef = ref(dbRealtime, 'users/' + currentUser.uid + '/data');
                set(userRef, db)
                    .then(() => updateSyncStatus("Synced ✓", "text-green-500"))
                    .catch((err) => {
                        console.error(err);
                        updateSyncStatus("Sync Error", "text-red-500");
                    });
            }, 500);
            
            // Update UI immediately (no debounce for UI)
            refreshUI();
        }

        // Data Migration: Fix products with decimal IDs
        function migrateProductIds() {
            if (!db.products) return;
            let hasDecimalIds = false;
            db.products.forEach(p => {
                if (p.id && !Number.isInteger(p.id)) {
                    p.id = Math.floor(p.id);
                    hasDecimalIds = true;
                }
            });
            if (hasDecimalIds) {
                console.log('✓ Fixed product IDs with decimal values');
                saveDB();
            }
        }

        // Helper function: Filter out zero-stock products if duplicates with stock exist
        window.filterDuplicateZeroStockProducts = function(products) {
            const grouped = {};
            products.forEach(p => {
                if (!grouped[p.name]) grouped[p.name] = [];
                grouped[p.name].push(p);
            });

            let filtered = [];
            Object.keys(grouped).forEach(name => {
                const variants = grouped[name];
                if (variants.length > 1) {
                    // Multiple variants of same product name
                    const hasStock = variants.some(v => v.stock > 0);
                    if (hasStock) {
                        // Hide zero-stock variants
                        filtered = filtered.concat(variants.filter(v => v.stock > 0));
                    } else {
                        // All have 0 stock, keep all
                        filtered = filtered.concat(variants);
                    }
                } else {
                    // Single variant, keep it
                    filtered = filtered.concat(variants);
                }
            });
            return filtered;
        };

        // Attach global functions to window so HTML onclick works
        window.nav = function(page) {
            document.querySelectorAll('main section').forEach(el => el.classList.add('hidden'));
            document.getElementById(page).classList.remove('hidden');
            
            document.getElementById('pageTitle').innerText = page.charAt(0).toUpperCase() + page.slice(1);
            
            // Close Sidebar on Mobile when nav clicked
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('mobile-backdrop').classList.add('hidden');
            }

            // Specific Loaders - Load fresh data when navigating
            if(page === 'dashboard') loadDashboard();
            if(page === 'pos') loadPOS();
            if(page === 'invoices') loadInvoices();
            if(page === 'purchases') loadBatches();
            if(page === 'returns') loadReturns();
            if(page === 'reports') runReports('daily');
            if(page === 'productSuppliers') loadProductSupplierPage();
        }

        let isModalOpen = false;
        
        window.openModal = function(id) {
            // Prevent rapid repeated calls
            if (isModalOpen) return;
            isModalOpen = true;
            
            try {
                const backdrop = document.getElementById('modalBackdrop');
                const modal = document.getElementById(id);
                
                if (!backdrop || !modal) {
                    console.error('Modal or backdrop not found', id);
                    isModalOpen = false;
                    return;
                }
                
                console.log('Opening modal:', id);
                
                // Show backdrop and modal
                backdrop.classList.remove('hidden');
                backdrop.style.display = 'flex';
                modal.classList.remove('hidden');
                modal.style.display = 'block';
                
                // Load data immediately
                if(id === 'purchModal') {
                    console.log('Loading purchase data');
                    loadPurchSelects();
                }
                else if(id === 'prodModal') {
                    console.log('Loading supplier select for product');
                    loadSupplierSelectForProduct();
                }
                else if(id === 'assignSupplierModal') {
                    console.log('Loading suppliers for assignment');
                    loadSuppliersForAssignment();
                    console.log('Suppliers for assignment loaded');
                }
                
                console.log('Modal should now be visible');
                isModalOpen = false;
            } catch(e) {
                console.error('Error opening modal:', e);
                isModalOpen = false;
            }
        }

        window.closeModal = function() {
            const backdrop = document.getElementById('modalBackdrop');
            backdrop.classList.add('hidden');
            backdrop.style.display = 'none';
            document.querySelectorAll('.modal-content').forEach(el => {
                el.classList.add('hidden');
                el.style.display = 'none';
            });
            document.querySelectorAll('form').forEach(f => f.reset());
            editTxnId = null;
            activeCustomerReportId = null;
            activeSupplierReportId = null;
            isModalOpen = false; // Reset flag
        }
        
        window.openPaymentModal = function(custId, custName) {
            document.getElementById('payCustId').value = custId;
            document.getElementById('payCustName').innerText = "Settling due for: " + custName;
            window.openModal('payModal');
        }
        
        window.resetData = function() {
            if(confirm("DANGER: This will wipe all data permanently!")) {
                // Remove isolated key
                if(DB_KEY) localStorage.removeItem(DB_KEY);
                
                // Clear cloud if connected
                if(currentUser) {
                    set(ref(dbRealtime, 'users/' + currentUser.uid + '/data'), APP_STATE);
                }
                location.reload();
            }
        }

        window.exportDB = function() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "karta_backup_" + (currentUser ? currentUser.uid.slice(0,5) : 'local') + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        window.importDB = function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if(confirm("This will overwrite current data with the backup. Continue?")) {
                        // FIX: Sanitize import data too
                        db = ensureDbStructure(imported);
                        saveDB(); // Triggers cloud save
                        alert("Database Restored Successfully!");
                    }
                } catch(err) {
                    alert("Invalid Backup File");
                }
            };
            reader.readAsText(file);
        }

        // --- Product Management ---
        document.getElementById('prodForm').onsubmit = e => {
            e.preventDefault();
            const supplierId = document.getElementById('pSupplier').value || null;
            const supplierName = supplierId ? (db.suppliers.find(s => s.id === parseInt(supplierId))?.name || '') : null;
            
            const p = {
                id: Date.now(),
                name: document.getElementById('pName').value,
                sku: document.getElementById('pSku').value,
                category: document.getElementById('pCat').value,
                batch: document.getElementById('pBatch').value,
                expiry: document.getElementById('pExpiry').value,
                cost: parseFloat(document.getElementById('pCost').value),
                retail: parseFloat(document.getElementById('pRetail').value),
                wholesale: parseFloat(document.getElementById('pWhole').value) || 0,
                stock: parseInt(document.getElementById('pStock').value),
                reorder: parseInt(document.getElementById('pReorder').value),
                supplierId: supplierId ? parseInt(supplierId) : null,
                supplierName: supplierName
            };
            db.products.push(p);
            saveDB();
            renderProducts();
            loadDashboard();
            window.closeModal();
        };

        function renderProducts() {
            // AUTO-CLEAN: Remove old stock products with 0 qty if newer stock exists
            if (!db.products) db.products = [];
            
            // Also pre-load suppliers for the product form
            loadSupplierSelectForProduct();
            
            const productNames = {};
            db.products.forEach(p => {
                if (!productNames[p.name]) productNames[p.name] = [];
                productNames[p.name].push(p);
            });
            
            // For each product name, if we have multiple batches
            Object.keys(productNames).forEach(name => {
                const variants = productNames[name];
                if(variants.length > 1) {
                    // Sort by expiry date - oldest first (FEFO: First Expire, First Out)
                    variants.sort((a, b) => {
                        const expiryA = a.expiry ? new Date(a.expiry) : new Date('2099-12-31');
                        const expiryB = b.expiry ? new Date(b.expiry) : new Date('2099-12-31');
                        return expiryA - expiryB;
                    });
                    
                    // Check if we have at least one variant with stock > 0
                    const hasNewStock = variants.some(v => v.stock > 0);
                    
                    // If newer stock exists, delete old items with 0 quantity
                    if(hasNewStock) {
                        variants.forEach((v, idx) => {
                            if(idx > 0 && v.stock === 0) {
                                // This is an older batch with 0 stock - delete it
                                db.products = db.products.filter(p => p.id !== v.id);
                            }
                        });
                    }
                }
            });
            
            const tbody = document.getElementById('invBody');
            tbody.innerHTML = '';
            const search = document.getElementById('invSearch').value.toLowerCase();
            
            // Safety Check: ensure db.products exists
            if (!db.products) db.products = [];

            // Filter out zero-stock duplicates
            const displayProducts = filterDuplicateZeroStockProducts(db.products);

            displayProducts.filter(p => p.name.toLowerCase().includes(search) || p.sku.toLowerCase().includes(search))
            .forEach(p => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 transition";
                
                // Batch/Expiry Info
                let batchInfo = `<div class="text-xs text-gray-500">N/A</div>`;
                if(p.batch || p.expiry) {
                    batchInfo = `
                        <div class="text-xs text-gray-400">Batch: <span class="text-white">${p.batch || '-'}</span></div>
                        <div class="text-[10px] text-gray-500">Exp: ${p.expiry || '-'}</div>
                    `;
                }
                
                tr.innerHTML = `
                    <td class="p-3 font-bold text-white">${p.name}</td>
                    <td class="p-3 text-gray-400 font-mono text-xs">${p.sku}</td>
                    <td class="p-3">${batchInfo}</td>
                    <td class="p-3"><span class="px-2 py-1 bg-gray-800 rounded text-xs">${p.category}</span></td>
                    <td class="p-3 text-right font-bold ${p.stock <= p.reorder ? 'text-red-500' : 'text-green-500'}">${p.stock}</td>
                    <td class="p-3 text-right text-gray-500">${db.config.currency} ${p.cost}</td>
                    <td class="p-3 text-right text-white">${db.config.currency} ${p.retail}</td>
                    <td class="p-3 text-center">
                        <button onclick="delProd(${p.id})" class="text-red-500 hover:text-white"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        window.delProd = function(id) { 
            if(confirm("Delete Product? This will remove it permanently from inventory.")) { 
                db.products = db.products.filter(p => p.id !== id); 
                saveDB(); 
                renderProducts();
                alert("Product deleted successfully!");
            } 
        }

        // --- PRODUCT SUPPLIER ASSIGNMENT ---
        window.loadSupplierSelectForProduct = function() {
            const supSelect = document.getElementById('pSupplier');
            if (!supSelect) {
                console.warn('Supplier select element not found');
                return;
            }
            supSelect.innerHTML = '<option value="">-- No specific supplier --</option>';
            if (!db.suppliers) db.suppliers = [];
            
            if (db.suppliers.length === 0) {
                supSelect.innerHTML += '<option value="" disabled style="color: gray;">No suppliers created yet - go to Suppliers page to add one</option>';
            } else {
                db.suppliers.forEach(s => {
                    supSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                });
            }
        }

        window.renderProductSupplierAssignment = function() {
            const tbody = document.getElementById('psmBody');
            tbody.innerHTML = '';
            const search = document.getElementById('psmSearch').value.toLowerCase();
            const supplierFilter = document.getElementById('psmSupplierFilter').value;
            
            if (!db.products) db.products = [];
            
            // Get unique products (by name) and their latest supplier assignment
            const productMap = {};
            db.products.forEach(p => {
                const key = p.name.toLowerCase();
                if (!productMap[key] || p.id > productMap[key].id) {
                    productMap[key] = p;
                }
            });
            
            const filteredProducts = Object.values(productMap)
                .filter(p => (p.name.toLowerCase().includes(search) || p.sku.toLowerCase().includes(search)))
                .filter(p => !supplierFilter || (p.supplierId && p.supplierId === parseInt(supplierFilter)))
                .sort((a, b) => a.name.localeCompare(b.name));
            
            if (filteredProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">No products found</td></tr>';
                return;
            }
            
            filteredProducts.forEach(p => {
                const supplier = p.supplierId ? db.suppliers.find(s => s.id === p.supplierId) : null;
                const tr = document.createElement('tr');
                tr.className = `hover:bg-white/5 border-b border-gray-800 ${supplier ? 'bg-green-950/10' : ''}`;
                tr.innerHTML = `
                    <td class="p-3 font-bold text-white">${p.name}</td>
                    <td class="p-3 text-gray-400 text-xs font-mono">${p.sku}</td>
                    <td class="p-3">
                        ${supplier ? `<span class="px-3 py-1 bg-green-900/40 text-green-300 rounded text-xs font-bold border border-green-700"><i class="fa-solid fa-check-circle mr-1"></i>${supplier.name}</span>` : '<span class="px-3 py-1 bg-gray-800/50 text-gray-500 text-xs rounded border border-gray-700"><i class="fa-solid fa-circle-xmark mr-1\"></i>Unassigned</span>'}
                    </td>
                    <td class="p-3 text-center flex gap-1 justify-center">
                        <button onclick="openProductAssignModal(${p.id})" class="text-blue-400 hover:text-blue-300 text-xs font-bold px-3 py-1.5 bg-blue-900/30 hover:bg-blue-900/50 rounded transition border border-blue-800" title="Assign supplier">
                            <i class="fa-solid fa-link"></i>
                        </button>
                        ${supplier ? `<button onclick="quickUnassignProduct(${p.id})" class="text-red-400 hover:text-red-300 text-xs font-bold px-3 py-1.5 bg-red-900/30 hover:bg-red-900/50 rounded transition border border-red-800" title="Remove supplier"><i class="fa-solid fa-unlink"></i></button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        let currentAssignProductId = null;
        window.openProductAssignModal = function(productId) {
            // Handle both integer and decimal product IDs for backwards compatibility
            const numProductId = Math.floor(parseInt(productId) || productId);
            const product = db.products.find(p => Math.floor(p.id) === numProductId);
            if (!product) {
                console.error('Product not found with ID:', productId);
                return;
            }
            
            currentAssignProductId = Math.floor(product.id);
            document.getElementById('assignProdName').innerText = product.name;
            document.getElementById('assignProdSKU').innerText = product.sku;
            
            // Show current supplier
            const currentSupplier = product.supplierId ? db.suppliers.find(s => s.id === product.supplierId) : null;
            const supplierDisplay = document.getElementById('assignCurrentSupplierName');
            if (currentSupplier) {
                supplierDisplay.innerHTML = `<i class="fa-solid fa-check-circle text-green-400 mr-1"></i>${currentSupplier.name}`;
                supplierDisplay.className = 'text-green-400 font-bold';
            } else {
                supplierDisplay.innerHTML = '<i class="fa-solid fa-circle-xmark text-gray-500 mr-1"></i>Unassigned';
                supplierDisplay.className = 'text-gray-500 font-bold';
            }
            
            window.openModal('assignSupplierModal');
        }

        window.loadSuppliersForAssignment = function() {
            try {
                const supSelect = document.getElementById('assignSupplierSelect');
                if (!supSelect) {
                    console.error('Supplier select element not found');
                    return;
                }
                
                if (!db.suppliers) db.suppliers = [];
                
                console.log('Loading suppliers. Count:', db.suppliers.length);
                
                // Build HTML efficiently
                let html = '<option value="">-- Remove Supplier Assignment --</option>';
                if (db.suppliers.length === 0) {
                    html += '<option value="" disabled>No suppliers available</option>';
                } else {
                    db.suppliers.forEach(s => {
                        html += `<option value="${s.id}">${s.name}</option>`;
                    });
                }
                supSelect.innerHTML = html;
                
                console.log('Suppliers loaded successfully');
                
                // Pre-select current supplier if assigned
                if (currentAssignProductId) {
                    const product = db.products.find(p => Math.floor(p.id) === Math.floor(currentAssignProductId));
                    if (product && product.supplierId) {
                        supSelect.value = product.supplierId;
                        console.log('Pre-selected supplier:', product.supplierId);
                    }
                }
            } catch(e) {
                console.error('Error loading suppliers:', e);
            }
        }

        window.saveProductSupplierAssignment = function() {
            if (!currentAssignProductId) {
                console.error('No product selected for assignment');
                alert('Error: No product selected');
                return;
            }
            
            // Handle both integer and decimal product IDs
            const product = db.products.find(p => Math.floor(p.id) === Math.floor(currentAssignProductId));
            if (!product) {
                console.error('Product not found with ID:', currentAssignProductId);
                alert('Error: Product not found');
                return;
            }
            
            const supplierId = document.getElementById('assignSupplierSelect').value;
            
            if (supplierId) {
                const supplier = db.suppliers.find(s => s.id === parseInt(supplierId));
                if (supplier) {
                    product.supplierId = parseInt(supplierId);
                    product.supplierName = supplier.name;
                    saveDB();
                    renderProductSupplierAssignment();
                    window.closeModal();
                    alert('✓ Supplier assigned successfully!');
                } else {
                    alert('Error: Supplier not found');
                    return;
                }
            } else {
                alert('Please select a supplier to assign');
                return;
            }
        }

        window.unassignProductSupplier = function() {
            if (!currentAssignProductId) {
                alert('Error: No product selected');
                return;
            }
            
            const product = db.products.find(p => Math.floor(p.id) === Math.floor(currentAssignProductId));
            if (!product) {
                alert('Error: Product not found');
                return;
            }
            
            if (confirm(`Remove supplier assignment for "${product.name}"?`)) {
                product.supplierId = null;
                product.supplierName = null;
                saveDB();
                renderProductSupplierAssignment();
                window.closeModal();
                alert('✓ Supplier removed! Product is now unassigned.');
            }
        }

        window.quickUnassignProduct = function(productId) {
            // Handle both integer and decimal product IDs
            const numProductId = Math.floor(parseInt(productId) || productId);
            const product = db.products.find(p => Math.floor(p.id) === numProductId);
            if (!product) return;
            
            if (confirm(`Unassign "${product.name}" from its supplier?`)) {
                product.supplierId = null;
                product.supplierName = null;
                saveDB();
                renderProductSupplierAssignment();
                alert('✓ Product unassigned!');
            }
        }

        // Load supplier filter dropdown for product suppliers page
        window.loadProductSupplierPage = function() {
            const filter = document.getElementById('psmSupplierFilter');
            filter.innerHTML = '<option value="">-- All Suppliers --</option>';
            if (!db.suppliers) db.suppliers = [];
            db.suppliers.forEach(s => {
                filter.innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });
            renderProductSupplierAssignment();
        }

        // --- Customer Management ---
        document.getElementById('custForm').onsubmit = e => {
            e.preventDefault();
            const custId = document.getElementById('custId').value;
            const name = document.getElementById('cName').value;
            const phone = document.getElementById('cPhone').value;
            const address = document.getElementById('cAddr').value;
            const taxId = document.getElementById('cTax').value;
            const limit = parseFloat(document.getElementById('cLimit').value) || 0;
            const balance = parseFloat(document.getElementById('cBalance').value) || 0;
            
            if(custId) {
                // Edit existing customer
                const cust = db.customers.find(c => c.id === parseInt(custId));
                if(cust) {
                    cust.name = name;
                    cust.phone = phone;
                    cust.address = address;
                    cust.taxId = taxId;
                    cust.limit = limit;
                    cust.balance = balance;
                }
            } else {
                // Add new customer
                db.customers.push({
                    id: Date.now(),
                    name: name,
                    phone: phone,
                    address: address,
                    taxId: taxId,
                    limit: limit,
                    balance: balance
                });
            }
            saveDB();
            window.closeModal();
            renderCustomers();
        };

        // --- Customer Payment Form Handler ---
        document.getElementById('payForm').onsubmit = e => {
            e.preventDefault();
            const custId = parseInt(document.getElementById('payCustId').value);
            const amount = parseFloat(document.getElementById('payAmount').value);
            
            const cust = db.customers.find(c => c.id === custId);
            if(cust) {
                cust.balance -= amount;
                db.transactions.push({
                    id: Date.now(),
                    type: 'payment', // payment received
                    date: new Date().toISOString(),
                    entityId: custId,
                    entityName: cust.name,
                    items: [], // no items for payment
                    total: amount,
                    tax: 0
                });
                saveDB();
                window.closeModal();
                alert("Payment Recorded");
            }
        };

        // --- Debtors Report Filter ---
        window.filterDebtorsReport = function() {
            const searchLocation = document.getElementById('debtorLocationSearch').value.toLowerCase();
            const tbody = document.getElementById('repTable');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const locationCell = row.cells[1];
                const location = locationCell ? locationCell.textContent.toLowerCase() : '';
                
                if (searchLocation === '' || location.includes(searchLocation)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        };

        // Edit Customer Function
        window.editCustomer = function(id) {
            const cust = db.customers.find(c => c.id === id);
            if(!cust) return;
            
            document.getElementById('custId').value = id;
            document.getElementById('cName').value = cust.name;
            document.getElementById('cPhone').value = cust.phone;
            document.getElementById('cAddr').value = cust.address || '';
            document.getElementById('cTax').value = cust.taxId || '';
            document.getElementById('cLimit').value = cust.limit || 0;
            document.getElementById('cBalance').value = cust.balance || 0;
            
            window.openModal('custModal');
        };

        function renderCustomers() {
            const grid = document.getElementById('custGrid');
            grid.innerHTML = '';
            const search = document.getElementById('custSearch').value.toLowerCase();
            
            if (!db.customers) db.customers = [];
            
            // Calculate summary stats
            let totalDue = 0;
            let activeCount = 0;
            db.customers.forEach(c => {
                totalDue += c.balance;
                if(c.balance > 0) activeCount++;
            });
            
            // Update summary cards
            document.getElementById('custCount').innerText = db.customers.length;
            document.getElementById('custTotalDue').innerText = db.config.currency + totalDue.toFixed(2);
            document.getElementById('custActive').innerText = activeCount;

            db.customers.filter(c => c.name.toLowerCase().includes(search) || (c.address && c.address.toLowerCase().includes(search))).forEach(c => {
                const el = document.createElement('div');
                el.className = "bg-karta-surface border border-karta-border p-4 rounded-lg hover:border-karta-primary transition group flex flex-col h-full";
                
                // Calculate quick stats for the card
                const txns = (db.transactions || []).filter(t => t.entityId === c.id);
                const totalSpent = txns.filter(t => t.type === 'sale').reduce((a,x) => a + x.total, 0);

                el.innerHTML = `
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-white text-lg">${c.name}</h4>
                            <span class="text-xs ${c.balance > 0 ? 'text-red-500' : 'text-green-500'} font-bold border border-current px-2 py-0.5 rounded">
                                ${c.balance > 0 ? 'Due' : 'Bal'}: ${db.config.currency}${c.balance.toFixed(2)}
                            </span>
                        </div>
                        <div class="text-xs text-gray-400 mb-1 flex items-center"><i class="fa-solid fa-location-dot w-4"></i> ${c.address || 'No Address'}</div>
                        <div class="text-xs text-gray-400 mb-2 flex items-center"><i class="fa-solid fa-phone w-4"></i> ${c.phone}</div>
                        <div class="text-xs text-gray-500 mt-2 mb-4">Total Orders: <span class="text-white">${txns.length}</span> | Spent: <span class="text-white">${db.config.currency}${totalSpent.toFixed(0)}</span></div>
                    </div>
                    
                    <div class="mt-auto pt-3 border-t border-gray-800 flex gap-2">
                         <button onclick="viewCustomerHistory(${c.id})" class="flex-1 bg-white/10 hover:bg-white/20 text-white text-xs py-2 rounded transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-list-ul"></i> History
                         </button>
                         <button onclick="editCustomer(${c.id})" class="flex-1 bg-blue-700 hover:bg-blue-600 text-white text-xs py-2 rounded transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-edit"></i> Edit
                         </button>
                         ${c.balance > 0 ? `<button onclick="openPaymentModal(${c.id}, '${c.name}')" class="flex-1 text-xs bg-green-700 hover:bg-green-600 text-white px-2 py-2 rounded font-bold">Settle Due</button>` : ''}
                    </div>
                `;
                grid.appendChild(el);
            });
            
            const dl = document.getElementById('custDataList');
            dl.innerHTML = '';
            db.customers.forEach(c => {
                dl.innerHTML += `<option value="${c.name} [ID:${c.id}]">`;
            });
        }

        // --- NEW: Customer History & PDF Logic ---
        window.viewCustomerHistory = function(id) {
            activeCustomerReportId = id;
            const cust = db.customers.find(c => c.id === id);
            if(!cust) return;

            // Gather Data
            const txns = db.transactions.filter(t => t.entityId === id).sort((a,b) => new Date(b.date) - new Date(a.date));
            const totalSpent = txns.filter(t => t.type === 'sale').reduce((a,x) => a + x.total, 0);

            // Populate Modal Header
            document.getElementById('chName').innerText = cust.name;
            document.getElementById('chPhone').innerText = cust.phone;
            document.getElementById('chAddr').innerText = cust.address || "N/A";
            
            document.getElementById('chBalance').innerText = `${db.config.currency}${cust.balance.toFixed(2)}`;
            document.getElementById('chBalance').className = `text-2xl font-bold mt-1 ${cust.balance > 0 ? 'text-red-500' : 'text-green-500'}`;
            
            document.getElementById('chTotalSpent').innerText = `${db.config.currency}${totalSpent.toFixed(2)}`;
            document.getElementById('chTxnCount').innerText = txns.length;

            // Populate Table
            const tbody = document.getElementById('chTableBody');
            tbody.innerHTML = '';
            
            if(txns.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">No transactions found for this customer.</td></tr>`;
            } else {
                txns.forEach(t => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-white/5 border-b border-gray-800 text-gray-300";
                    
                    // Format Items String
                    let itemsStr = '-';
                    if(t.items && t.items.length > 0) {
                        itemsStr = t.items.map(i => `${i.qty}x ${i.name}`).join(', ');
                        if(itemsStr.length > 40) itemsStr = itemsStr.substring(0, 40) + '...';
                    } else if (t.type === 'payment') {
                        itemsStr = 'Payment Received';
                    }

                    // Type styling
                    const typeColor = t.type === 'sale' ? 'text-blue-400' : (t.type === 'payment' ? 'text-green-400' : 'text-gray-400');
                    
                    tr.innerHTML = `
                        <td class="p-3">${new Date(t.date).toLocaleDateString()}</td>
                        <td class="p-3 uppercase text-xs font-bold ${typeColor}">${t.type}</td>
                        <td class="p-3 font-mono text-xs">#${t.id.toString().slice(-6)}</td>
                        <td class="p-3 text-xs text-gray-400 max-w-[150px] truncate">${itemsStr}</td>
                        <td class="p-3 text-right font-bold">${db.config.currency}${t.total.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            window.openModal('custHistoryModal');
        }

        window.downloadCustomerPDF = function() {
            if(!activeCustomerReportId) return;
            const cust = db.customers.find(c => c.id === activeCustomerReportId);
            const txns = db.transactions.filter(t => t.entityId === activeCustomerReportId).sort((a,b) => new Date(b.date) - new Date(a.date));

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Logo for PDF
            let yPos = 20;
            if(db.config.logo) {
                try {
                    doc.addImage(db.config.logo, 'JPEG', 14, 15, 20, 20); // x, y, w, h
                    yPos = 40; // Push text down if logo exists
                } catch(e) { console.error("Logo error", e); }
            }

            // Header
            doc.setFontSize(18);
            doc.text(db.config.name, 14, yPos);
            doc.setFontSize(10);
            doc.text(db.config.address, 14, yPos + 5);
            doc.text("Customer Account Statement", 14, yPos + 15);
            
            // Customer Details
            doc.setDrawColor(200);
            doc.line(14, yPos + 18, 196, yPos + 18);
            
            doc.setFontSize(12);
            doc.text(`Customer: ${cust.name}`, 14, yPos + 28);
            doc.setFontSize(10);
            doc.text(`Phone: ${cust.phone}`, 14, yPos + 33);
            doc.text(`Address: ${cust.address || '-'}`, 14, yPos + 38);
            
            // Summary
            doc.text(`Current Balance Due: ${db.config.currency} ${cust.balance.toFixed(2)}`, 140, yPos + 28);
            doc.text(`Total Lifetime Spend: ${db.config.currency} ${txns.filter(t=>t.type==='sale').reduce((a,x)=>a+x.total,0).toFixed(2)}`, 140, yPos + 33);

            // Table
            const tableData = txns.map(t => [
                new Date(t.date).toLocaleDateString(),
                t.type.toUpperCase(),
                `#${t.id.toString().slice(-6)}`,
                t.type === 'sale' ? t.items.map(i => `${i.qty}x ${i.name}`).join(', ') : 'Payment Received',
                `${db.config.currency} ${t.total.toFixed(2)}`
            ]);

            doc.autoTable({
                startY: yPos + 45,
                head: [['Date', 'Type', 'Ref #', 'Description / Items', 'Amount']],
                body: tableData,
                theme: 'grid',
                styles: { fontSize: 8 },
                headStyles: { fillColor: [0, 200, 83] } // Green header
            });

            // Footer
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(8);
            doc.text("Generated by Karta Pharmacy OS", 14, finalY);
            doc.text(new Date().toLocaleString(), 14, finalY + 5);

            doc.save(`${cust.name.replace(/\s+/g, '_')}_History.pdf`);
        }

        // --- Supplier Management ---
        document.getElementById('supForm').onsubmit = e => {
            e.preventDefault();
            const supId = document.getElementById('supId').value;
            const name = document.getElementById('sName').value;
            const contact = document.getElementById('sContact').value;
            const phone = document.getElementById('sPhone').value;
            const taxId = document.getElementById('sTax').value;
            const balance = parseFloat(document.getElementById('sBalance').value) || 0;
            
            if(supId) {
                // Edit existing supplier
                const sup = db.suppliers.find(s => s.id === parseInt(supId));
                if(sup) {
                    sup.name = name;
                    sup.contact = contact;
                    sup.phone = phone;
                    sup.taxId = taxId;
                    sup.balance = balance;
                }
            } else {
                // Add new supplier
                db.suppliers.push({
                    id: Date.now(),
                    name: name,
                    contact: contact,
                    phone: phone,
                    taxId: taxId,
                    balance: balance
                });
            }
            saveDB();
            window.closeModal();
            renderSuppliers();
            loadSupplierSelectForProduct();
        };
        
        // NEW: Supplier History & Logic
        window.viewSupplierHistory = function(id) {
            activeSupplierReportId = id;
            const sup = db.suppliers.find(s => s.id === id);
            if(!sup) return;

            // Fetch Transactions (Purchases and Payments Out)
            const txns = db.transactions.filter(t => t.entityId === id && (t.type === 'purchase' || t.type === 'payment_out'))
                                        .sort((a,b) => new Date(b.date) - new Date(a.date));
                                        
            const totalPurchased = txns.filter(t => t.type === 'purchase').reduce((a,x) => a + x.total, 0);

            // Populate Header
            document.getElementById('shName').innerText = sup.name;
            document.getElementById('shContact').innerText = sup.contact || 'N/A';
            document.getElementById('shPhone').innerText = sup.phone || 'N/A';
            
            document.getElementById('shBalance').innerText = `${db.config.currency}${sup.balance.toFixed(2)}`;
            document.getElementById('shTotalPurchased').innerText = `${db.config.currency}${totalPurchased.toFixed(2)}`;

            // Populate Table
            const tbody = document.getElementById('shTableBody');
            tbody.innerHTML = '';
            
            if(txns.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">No transactions found for this supplier.</td></tr>`;
            } else {
                txns.forEach(t => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-white/5 border-b border-gray-800 text-gray-300";
                    
                    let itemsStr = '-';
                    if(t.type === 'purchase' && t.items) {
                         itemsStr = t.items.map(i => `${i.qty}x ${i.name}`).join(', ');
                    } else if (t.type === 'payment_out') {
                        itemsStr = 'Payment Sent to Supplier';
                    }

                    const typeColor = t.type === 'purchase' ? 'text-blue-400' : 'text-red-400';
                    const amountSign = t.type === 'payment_out' ? '-' : '';
                    
                    tr.innerHTML = `
                        <td class="p-3">${new Date(t.date).toLocaleDateString()}</td>
                        <td class="p-3 uppercase text-xs font-bold ${typeColor}">${t.type === 'payment_out' ? 'Payment' : 'Purchase'}</td>
                        <td class="p-3 text-xs text-gray-500">${t.ref || '-'}</td>
                        <td class="p-3 text-xs text-gray-400 max-w-[150px] truncate">${itemsStr}</td>
                        <td class="p-3 text-right font-bold">${amountSign}${db.config.currency}${t.total.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            window.openModal('supHistoryModal');
        }

        // NEW: Open Supplier Pay Modal
        window.openSupPayModal = function(id, name) {
            document.getElementById('spSupId').value = id;
            document.getElementById('spSupName').innerText = "Recording payment to: " + name;
            window.openModal('supPayModal');
        }

        // NEW: Submit Supplier Payment
        document.getElementById('supPayForm').onsubmit = e => {
            e.preventDefault();
            const supId = parseInt(document.getElementById('spSupId').value);
            const amount = parseFloat(document.getElementById('spAmount').value);
            
            const sup = db.suppliers.find(s => s.id === supId);
            if(sup) {
                sup.balance -= amount; // Reduce debt
                db.transactions.push({
                    id: Date.now(),
                    type: 'payment_out', // Payment Outflow
                    date: new Date().toISOString(),
                    entityId: supId,
                    entityName: sup.name,
                    items: [], 
                    total: amount,
                    tax: 0
                });
                saveDB();
                window.closeModal();
                alert("Payment Recorded");
            }
        };

        // NEW: Download Supplier PDF
        window.downloadSupplierPDF = function() {
            if(!activeSupplierReportId) return;
            const sup = db.suppliers.find(s => s.id === activeSupplierReportId);
            const txns = db.transactions.filter(t => t.entityId === activeSupplierReportId && (t.type === 'purchase' || t.type === 'payment_out'))
                                        .sort((a,b) => new Date(b.date) - new Date(a.date));

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPos = 20;
            if(db.config.logo) {
                try {
                    doc.addImage(db.config.logo, 'JPEG', 14, 15, 20, 20);
                    yPos = 40;
                } catch(e) { }
            }

            // Header
            doc.setFontSize(18);
            doc.text(db.config.name, 14, yPos);
            doc.setFontSize(10);
            doc.text(db.config.address, 14, yPos + 5);
            doc.text("Supplier Account Statement", 14, yPos + 15);
            
            doc.setDrawColor(200);
            doc.line(14, yPos + 18, 196, yPos + 18);
            
            doc.setFontSize(12);
            doc.text(`Supplier: ${sup.name}`, 14, yPos + 28);
            doc.setFontSize(10);
            doc.text(`Contact: ${sup.contact || '-'}`, 14, yPos + 33);
            doc.text(`Phone: ${sup.phone || '-'}`, 14, yPos + 38);
            
            doc.text(`Current Balance Due: ${db.config.currency} ${sup.balance.toFixed(2)}`, 140, yPos + 28);

            const tableData = txns.map(t => [
                new Date(t.date).toLocaleDateString(),
                t.type === 'payment_out' ? 'PAYMENT SENT' : 'PURCHASE',
                t.ref || '-',
                t.type === 'purchase' ? (t.items && t.items[0] ? t.items.map(i=>`${i.qty}x ${i.name}`).join(', ') : '-') : 'Payment to Supplier',
                `${t.type === 'payment_out' ? '-' : ''}${db.config.currency} ${t.total.toFixed(2)}`
            ]);

            doc.autoTable({
                startY: yPos + 45,
                head: [['Date', 'Type', 'Ref', 'Details', 'Amount']],
                body: tableData,
                theme: 'grid',
                styles: { fontSize: 8 },
                headStyles: { fillColor: [66, 66, 66] }
            });
            
            doc.save(`${sup.name.replace(/\s+/g, '_')}_Statement.pdf`);
        }

        function renderSuppliers() {
            const tbody = document.getElementById('supBody');
            tbody.innerHTML = '';
            const search = document.getElementById('supSearch').value.toLowerCase();
            
            if (!db.suppliers) db.suppliers = [];
            
            // Calculate summary stats
            let totalDue = 0;
            let totalPurchased = 0;
            db.suppliers.forEach(s => {
                totalDue += s.balance;
                const purchases = (db.transactions || []).filter(t => t.entityId === s.id && t.type === 'purchase');
                totalPurchased += purchases.reduce((a, x) => a + x.total, 0);
            });
            
            // Update summary cards
            document.getElementById('supCount').innerText = db.suppliers.length;
            document.getElementById('supTotalDue').innerText = db.config.currency + totalDue.toFixed(2);
            document.getElementById('supTotalPurchased').innerText = db.config.currency + totalPurchased.toFixed(2);

            db.suppliers.filter(s => s.name.toLowerCase().includes(search)).forEach(s => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5";
                tr.innerHTML = `
                    <td class="p-3 text-white font-bold">${s.name}</td>
                    <td class="p-3 text-gray-400">${s.contact}</td>
                    <td class="p-3 text-gray-400">${s.phone}</td>
                    <td class="p-3 text-gray-400 text-xs">${s.taxId}</td>
                    <td class="p-3 text-right text-red-400 font-bold">${db.config.currency}${s.balance.toFixed(2)}</td>
                    <td class="p-3 text-center flex justify-center gap-2">
                         <button onclick="viewSupplierHistory(${s.id})" class="text-gray-400 hover:text-white" title="History"><i class="fa-solid fa-list-ul"></i></button>
                         <button onclick="editSupplier(${s.id})" class="text-blue-400 hover:text-blue-300" title="Edit"><i class="fa-solid fa-edit"></i></button>
                         <button onclick="openSupPayModal(${s.id}, '${s.name}')" class="text-green-500 hover:text-green-400" title="Settle Balance"><i class="fa-solid fa-money-bill-wave"></i></button>
                         <button onclick="delSup(${s.id})" class="text-red-500 hover:text-red-400" title="Delete"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        // Edit Supplier Function
        window.editSupplier = function(id) {
            const sup = db.suppliers.find(s => s.id === id);
            if(!sup) return;
            
            document.getElementById('supId').value = id;
            document.getElementById('sName').value = sup.name;
            document.getElementById('sContact').value = sup.contact || '';
            document.getElementById('sPhone').value = sup.phone || '';
            document.getElementById('sTax').value = sup.taxId || '';
            document.getElementById('sBalance').value = sup.balance || 0;
            
            window.openModal('supModal');
        };
        
        window.delSup = function(id) { if(confirm("Delete Supplier?")) { db.suppliers = db.suppliers.filter(s=>s.id!==id); saveDB(); renderSuppliers(); } }

        // --- Transactions (Purchase & Expense) ---
        // BULK PURCHASE SYSTEM
        let purchaseCart = [];

        function loadPurchSelects() {
            const sSel = document.getElementById('poSup');
            sSel.innerHTML = '<option value="">-- Choose Supplier --</option>';
            
            if (!db.suppliers) db.suppliers = [];
            db.suppliers.forEach(s => sSel.innerHTML += `<option value="${s.id}">${s.name}</option>`);
            
            purchaseCart = [];
            renderPurchaseItems();
        }

        window.loadSupplierProducts = function() {
            const supId = parseInt(document.getElementById('poSup').value);
            if (!supId) {
                purchaseCart = [];
                renderPurchaseItems();
                return;
            }
            // Clear cart when supplier changes
            purchaseCart = [];
            renderPurchaseItems();
        };

        window.addPurchaseItem = function() {
            const supId = parseInt(document.getElementById('poSup').value);
            if (!supId) {
                alert('Please select a supplier first');
                return;
            }
            
            purchaseCart.push({
                id: Date.now(),
                productId: null,
                productName: '',
                qty: 1,
                unitPrice: 0,
                batch: '',
                expiry: ''
            });
            renderPurchaseItems();
        };

        window.updatePurchaseItem = function(itemId, field, value) {
            const item = purchaseCart.find(i => i.id === itemId);
            if (!item) return;
            
            if (field === 'product') {
                const prod = db.products.find(p => p.id === parseInt(value));
                if (prod) {
                    item.productId = prod.id;
                    item.productName = prod.name;
                    item.unitPrice = prod.cost || 0;
                }
            } else if (field === 'qty') {
                item.qty = Math.max(0, parseInt(value) || 0);
            } else if (field === 'unitPrice') {
                item.unitPrice = moneyRound(parseFloat(value) || 0);
            } else if (field === 'batch') {
                item.batch = value;
            } else if (field === 'expiry') {
                item.expiry = value;
            }
            
            renderPurchaseItems();
        };

        window.removePurchaseItem = function(itemId) {
            purchaseCart = purchaseCart.filter(i => i.id !== itemId);
            renderPurchaseItems();
        };

        function renderPurchaseItems() {
            const tbody = document.getElementById('purchItemsBody');
            tbody.innerHTML = '';
            
            // Get selected supplier
            const supId = parseInt(document.getElementById('poSup').value);
            
            let totalItems = 0;
            let totalQty = 0;
            let grandTotal = 0;
            
            if (purchaseCart.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="7" class="p-8 text-center text-gray-500 text-sm">Click "Add Item" to start adding products</td>';
                tbody.appendChild(tr);
            } else {
                purchaseCart.forEach(item => {
                    const itemTotal = moneyRound(item.qty * item.unitPrice);
                    totalItems++;
                    totalQty += item.qty;
                    grandTotal = moneyRound(grandTotal + itemTotal);
                    
                    // Get supplier's products only, filtered for zero-stock duplicates
                    let supplierProducts = db.products.filter(p => !p.supplierId || p.supplierId === supId);
                    supplierProducts = filterDuplicateZeroStockProducts(supplierProducts);
                    
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-white/5 border-b border-gray-800 text-gray-300';
                    tr.innerHTML = `
                        <td class="p-3">
                            <select onchange="updatePurchaseItem(${item.id}, 'product', this.value)" class="input-field text-xs py-1.5" style="background-color: #0b0b0b;">
                                <option value="">Product</option>
                                ${supplierProducts.map(p => `<option value="${p.id}" ${item.productId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                        </td>
                        <td class="p-3 text-center">
                            <input type="number" min="0" value="${item.qty}" onchange="updatePurchaseItem(${item.id}, 'qty', this.value)" class="input-field text-xs text-center py-1.5 w-16" style="background-color: #0b0b0b;">
                        </td>
                        <td class="p-3 text-right">
                            <input type="number" step="0.01" value="${item.unitPrice.toFixed(2)}" onchange="updatePurchaseItem(${item.id}, 'unitPrice', this.value)" class="input-field text-xs text-right py-1.5 w-20" style="background-color: #0b0b0b;">
                        </td>
                        <td class="p-3 text-right font-bold text-karta-primary">${db.config.currency}${itemTotal.toFixed(2)}</td>
                        <td class="p-3 text-center">
                            <input type="text" placeholder="Batch" value="${item.batch}" onchange="updatePurchaseItem(${item.id}, 'batch', this.value)" class="input-field text-xs py-1.5 w-20" style="background-color: #0b0b0b;">
                        </td>
                        <td class="p-3 text-center">
                            <input type="date" value="${item.expiry}" onchange="updatePurchaseItem(${item.id}, 'expiry', this.value)" class="input-field text-xs py-1.5 w-24" style="background-color: #0b0b0b;">
                        </td>
                        <td class="p-3 text-center">
                            <button type="button" onclick="removePurchaseItem(${item.id})" class="text-gray-400 hover:text-red-400 transition">
                                <i class="fa-solid fa-trash-alt text-sm"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            document.getElementById('purchTotalItems').innerText = totalItems;
            document.getElementById('purchTotalQty').innerText = totalQty;
            document.getElementById('purchGrandTotal').innerText = db.config.currency + grandTotal.toFixed(2);
        }

        window.clearPurchaseForm = function() {
            if (confirm('Clear all items from purchase order?')) {
                purchaseCart = [];
                renderPurchaseItems();
            }
        };

        // Helper functions for split sales payment
        window.calculateSplitSales = function() {
            try {
                const totalEl = document.getElementById('splitSalesTotal');
                if(!totalEl) {
                    console.error('splitSalesTotal element not found');
                    return;
                }
                const totalText = totalEl.innerText;
                const total = parseFloat(totalText.replace(db.config.currency, '')) || 0;
                const cash = parseFloat(document.getElementById('splitSalesCash').value) || 0;
                const bank = parseFloat(document.getElementById('splitSalesBank').value) || 0;
                const credit = parseFloat(document.getElementById('splitSalesCredit').value) || 0;
                const sum = cash + bank + credit;
                const remaining = moneyRound(total - sum);
                
                const remainingEl = document.getElementById('splitSalesRemaining');
                if(remainingEl) {
                    remainingEl.innerText = `${db.config.currency}${Math.abs(remaining).toFixed(2)}`;
                    if(remaining < 0) {
                        remainingEl.style.color = '#ef4444';
                    } else if(remaining > 0) {
                        remainingEl.style.color = '#fbbf24';
                    } else {
                        remainingEl.style.color = '#4ade80';
                    }
                }
            } catch(e) {
                console.error('Error in calculateSplitSales:', e);
            }
        };

        window.confirmSplitSales = function() {
            const totalText = document.getElementById('splitSalesTotal').innerText;
            const total = parseFloat(totalText.replace(db.config.currency, '')) || 0;
            const cash = parseFloat(document.getElementById('splitSalesCash').value) || 0;
            const bank = parseFloat(document.getElementById('splitSalesBank').value) || 0;
            const credit = parseFloat(document.getElementById('splitSalesCredit').value) || 0;
            const sum = cash + bank + credit;
            
            if(sum !== total) {
                alert(`Amounts don't match!\nTotal: ${db.config.currency}${total.toFixed(2)}\nEntered: ${db.config.currency}${sum.toFixed(2)}`);
                return;
            }
            
            // Get customer info
            const custInput = document.getElementById('posCustomerInput').value;
            const custIdMatch = custInput.match(/\[ID:(\d+)\]/);
            let custId = custIdMatch ? parseInt(custIdMatch[1]) : null;
            let custName = custInput.split('[')[0].trim() || 'Guest Customer';

            // Get selected price type
            const priceType = document.querySelector('input[name="priceType"]:checked')?.value || 'retail';

            // Get discount percentage
            const discountPercent = parseFloat(document.getElementById('posDiscount').value) || 0;

            // Recalculate amounts
            const applyVat = document.getElementById('posVatToggle').checked;
            const sub = moneyRound(cart.reduce((a, c) => {
                const price = priceType === 'wholesale' ? (c.wholesale || c.retail) : c.retail;
                return a + c.qty * price;
            }, 0));
            const discount = moneyRound(sub * (discountPercent / 100));
            const subtotalAfterDiscount = moneyRound(sub - discount);
            
            let taxableAmount = 0;
            if(applyVat) {
                cart.forEach(item => {
                    if(!item.vatExempt) {
                        const price = priceType === 'wholesale' ? (item.wholesale || item.retail) : item.retail;
                        taxableAmount = moneyRound(taxableAmount + (item.qty * price));
                    }
                });
            }
            
            const taxableAfterDiscount = applyVat ? moneyRound(taxableAmount * (1 - (discountPercent / 100))) : 0;
            const tax = applyVat ? moneyRound(taxableAfterDiscount * (db.config.vatRate / 100)) : 0;
            const txnTotal = moneyRound(subtotalAfterDiscount + tax);

            if(credit > 0) {
                if(!custId) {
                    alert("Please select a registered customer for credit portion of split payment.");
                    return;
                }
                const customer = db.customers.find(c => c.id === custId);
                customer.balance += credit;
            }

            cart.forEach(item => {
                const prod = db.products.find(p => p.id === item.id);
                if(prod) prod.stock -= item.qty;
            });

            const itemsWithCost = cart.map(item => {
                const prod = db.products.find(p => p.id === item.id);
                return {
                    ...item,
                    cost: prod ? moneyRound(prod.cost) : 0,
                    vatExempt: item.vatExempt || false
                };
            });

            const txn = {
                id: Date.now(),
                type: 'sale',
                date: new Date().toISOString(),
                entityId: custId,
                entityName: custName,
                items: itemsWithCost,
                priceType: priceType,
                sub: sub,
                discount: discount,
                discountPercent: discountPercent,
                tax: tax,
                total: txnTotal,
                payType: 'split',
                splitCash: cash,
                splitBank: bank,
                splitCredit: credit
            };
            db.transactions.push(txn);
            saveDB();
            
            printInvoice(txn);
            document.getElementById('posDiscount').value = '0';
            clearCart();
            document.getElementById('posCustomerInput').value = '';
            window.closeModal();
            
            alert(`✅ Split Payment Sale Complete!\\nCash: ${db.config.currency}${cash.toFixed(2)}\\nBank: ${db.config.currency}${bank.toFixed(2)}\\nCredit: ${db.config.currency}${credit.toFixed(2)}`);
        };

        // Helper function for split payment display
        window.updatePaymentDisplay = function() {
            const paymentType = document.querySelector('input[name="purchPayment"]:checked').value;
            const splitSection = document.getElementById('splitPaymentSection');
            
            if(paymentType === 'split') {
                splitSection.classList.remove('hidden');
            } else {
                splitSection.classList.add('hidden');
            }
        };

        window.calculateSplitCredit = function() {
            const grandTotal = parseFloat(document.getElementById('purchGrandTotal').innerText.replace(db.config.currency, '') || 0);
            const cashAmount = parseFloat(document.getElementById('splitCashAmount').value) || 0;
            const creditAmount = moneyRound(grandTotal - cashAmount);
            
            document.getElementById('splitCreditAmount').value = creditAmount.toFixed(2);
            document.getElementById('splitTotalDisplay').innerText = `${db.config.currency}${grandTotal.toFixed(2)}`;
            document.getElementById('splitCashDisplay').innerText = `${db.config.currency}${cashAmount.toFixed(2)}`;
            document.getElementById('splitCreditDisplay').innerText = `${db.config.currency}${creditAmount.toFixed(2)}`;
        };

        document.getElementById('purchForm').onsubmit = e => {
            e.preventDefault();
            const supId = parseInt(document.getElementById('poSup').value);
            const ref = document.getElementById('poRef').value || 'PO-' + Date.now().toString().slice(-6);
            const paymentMethod = document.querySelector('input[name="purchPayment"]:checked').value;
            
            if (!supId) {
                alert('Please select a supplier');
                return;
            }
            
            if (purchaseCart.length === 0) {
                alert('Add at least one item to the purchase order');
                return;
            }
            
            const sup = db.suppliers.find(s => s.id === supId);
            if (!sup) return;
            
            let totalAmount = 0;
            const txnItems = [];
            
            purchaseCart.forEach(item => {
                if (!item.productId) {
                    alert('Please select a product for all items');
                    return;
                }
                
                const origProd = db.products.find(p => p.id === item.productId);
                if (!origProd) return;
                
                const newProductId = Math.floor(Date.now() + Math.random() * 10000);
                const itemTotal = moneyRound(item.qty * item.unitPrice);
                totalAmount = moneyRound(totalAmount + itemTotal);
                
                // Create new batch entry
                db.products.push({
                    id: newProductId,
                    name: origProd.name,
                    sku: origProd.sku + '-' + (item.batch ? item.batch.substring(0, 3).toUpperCase() : Date.now().toString().slice(-3)),
                    category: origProd.category,
                    batch: item.batch || 'N/A',
                    expiry: item.expiry || 'N/A',
                    cost: item.unitPrice,
                    retail: origProd.retail,
                    wholesale: origProd.wholesale,
                    stock: item.qty,
                    reorder: origProd.reorder,
                    purchaseDate: new Date().toISOString().split('T')[0],
                    supplierId: supId,
                    supplierName: sup.name,
                    ref: ref
                });
                
                if (!db.batches) db.batches = [];
                db.batches.push({
                    id: Math.floor(Date.now() + Math.random() * 10000),
                    productId: newProductId,
                    productName: origProd.name,
                    batchNumber: item.batch || 'N/A',
                    expiryDate: item.expiry || 'N/A',
                    quantity: item.qty,
                    costPrice: item.unitPrice,
                    purchaseDate: new Date().toISOString().split('T')[0],
                    supplierId: supId,
                    supplierName: sup.name,
                    ref: ref
                });
                
                txnItems.push({
                    id: newProductId,
                    name: origProd.name,
                    qty: item.qty,
                    cost: item.unitPrice
                });
            });
            
            // FIX: Handle payment method properly
            let creditAmount = 0;
            let cashAmount = 0;
            
            if(paymentMethod === 'credit') {
                // Full Credit Purchase
                creditAmount = totalAmount;
                sup.balance = moneyRound(sup.balance + totalAmount);
            } else if(paymentMethod === 'cash') {
                // Full Cash Purchase
                cashAmount = totalAmount;
                // Balance stays same
            } else if(paymentMethod === 'split') {
                // Split Payment
                cashAmount = moneyRound(parseFloat(document.getElementById('splitCashAmount').value) || 0);
                creditAmount = moneyRound(totalAmount - cashAmount);
                
                if(cashAmount < 0 || creditAmount < 0) {
                    alert('Invalid split payment amounts');
                    return;
                }
                
                // Only add credit portion to supplier balance
                if(creditAmount > 0) {
                    sup.balance = moneyRound(sup.balance + creditAmount);
                }
            }
            
            db.transactions.push({
                id: Date.now(),
                type: 'purchase',
                date: new Date().toISOString(),
                entityId: supId,
                entityName: sup.name,
                items: txnItems,
                total: totalAmount,
                payType: paymentMethod,
                cashAmount: cashAmount,
                creditAmount: creditAmount,
                ref: ref
            });
            
            saveDB();
            window.closeModal();
            
            let message = '';
            if(paymentMethod === 'cash') {
                message = `✅ CASH PURCHASE saved!\\nSupplier: ${sup.name}\\nAmount: ${db.config.currency}${totalAmount.toFixed(2)}\\nPaid in Cash\\n\\n${purchaseCart.length} items added.`;
            } else if(paymentMethod === 'credit') {
                message = `✅ PURCHASE ON CREDIT saved!\\nSupplier: ${sup.name}\\nAmount: ${db.config.currency}${totalAmount.toFixed(2)}\\nBalance Due: ${db.config.currency}${sup.balance.toFixed(2)}\\n\\n${purchaseCart.length} items added.`;
            } else if(paymentMethod === 'split') {
                message = `✅ SPLIT PAYMENT PURCHASE saved!\\nSupplier: ${sup.name}\\nTotal: ${db.config.currency}${totalAmount.toFixed(2)}\\n\\nCash Paid: ${db.config.currency}${cashAmount.toFixed(2)}\\nCredit: ${db.config.currency}${creditAmount.toFixed(2)}\\nBalance Due: ${db.config.currency}${sup.balance.toFixed(2)}\\n\\n${purchaseCart.length} items added.`;
            }
            
            alert(message);
            renderProducts();
        };

        document.getElementById('expForm').onsubmit = e => {
            e.preventDefault();
            db.transactions.push({
                id: Date.now(),
                type: 'expense',
                date: new Date().toISOString(),
                entityName: 'Overhead',
                items: [{ name: document.getElementById('expDesc').value }],
                total: moneyRound(parseFloat(document.getElementById('expAmt').value))
            });
            saveDB();
            window.closeModal();
        };

        // --- POS Logic ---
        function loadPOS() {
            // AUTO-CLEAN: Remove old stock products with 0 qty if newer stock exists
            if (!db.products) db.products = [];
            
            const productNames = {};
            db.products.forEach(p => {
                if (!productNames[p.name]) productNames[p.name] = [];
                productNames[p.name].push(p);
            });
            
            // For each product name, if we have multiple batches
            Object.keys(productNames).forEach(name => {
                const variants = productNames[name];
                if(variants.length > 1) {
                    // Sort by expiry date - oldest first (FEFO: First Expire, First Out)
                    variants.sort((a, b) => {
                        const expiryA = a.expiry ? new Date(a.expiry) : new Date('2099-12-31');
                        const expiryB = b.expiry ? new Date(b.expiry) : new Date('2099-12-31');
                        return expiryA - expiryB;
                    });
                    
                    // Check if we have at least one variant with stock > 0
                    const hasNewStock = variants.some(v => v.stock > 0);
                    
                    // If newer stock exists, delete old items with 0 quantity
                    if(hasNewStock) {
                        variants.forEach((v, idx) => {
                            if(idx > 0 && v.stock === 0) {
                                // FIX #4: MISSING HISTORY - Mark as hidden instead of deleting
                                v.hidden = true;
                            }
                        });
                    }
                }
            });
            
            const grid = document.getElementById('posGrid');
            grid.innerHTML = '';
            const search = document.getElementById('posSearch').value.toLowerCase();

            // Filter out zero-stock duplicates before displaying
            const displayProducts = filterDuplicateZeroStockProducts(db.products);
            
            displayProducts.filter(p => p.stock > 0 && (p.name.toLowerCase().includes(search) || p.sku.includes(search)))
            .forEach(p => {
                const el = document.createElement('div');
                el.className = "bg-karta-surface border border-karta-border p-3 rounded cursor-pointer hover:border-karta-primary transition";
                // FIX: Use closure or string ID
                el.onclick = () => addToCart(p);
                el.innerHTML = `
                    <div class="flex justify-between mb-1">
                        <span class="text-xs bg-gray-800 px-1 rounded text-gray-400">${p.sku}</span>
                        <span class="text-xs font-bold text-karta-primary">Qty: ${p.stock}</span>
                    </div>
                    <div class="font-bold text-white text-sm truncate">${p.name}</div>
                    <div class="text-xs text-gray-500 mt-1">
                        ${p.batch ? `<div>Batch: <span class="text-white">${p.batch}</span></div>` : ''}
                        ${p.expiry ? `<div>Exp: <span class="text-white">${p.expiry}</span></div>` : ''}
                    </div>
                    <div class="text-karta-primary font-bold mt-2">${db.config.currency}${p.retail}</div>
                `;
                grid.appendChild(el);
            });
        }

        function addToCart(p) {
            const qtyInput = document.getElementById('posQtyInput');
            let manualQty = parseInt(qtyInput.value) || 1;
            if(manualQty < 1) manualQty = 1;

            const exist = cart.find(i => i.id === p.id);
            
            if(exist) {
                if(exist.qty + manualQty <= p.stock) {
                    exist.qty += manualQty;
                } else {
                    alert("Not enough stock!");
                }
            } else {
                if(manualQty <= p.stock) {
                    cart.push({...p, qty: manualQty});
                } else {
                    alert("Not enough stock!");
                }
            }
            renderCart();
            qtyInput.value = 1; 
        }

        window.updateCartQty = function(idx, change) {
            const item = cart[idx];
            const product = db.products.find(p => p.id === item.id);
            const newQty = item.qty + change;
            
            if(newQty > 0 && newQty <= product.stock) {
                item.qty = newQty;
                renderCart();
            } else if (newQty > product.stock) {
                alert("Max stock reached!");
            }
        }

        window.removeFromCart = function(idx) {
            if(idx >= 0 && idx < cart.length) {
                cart.splice(idx, 1);
                renderCart();
            }
        }

        window.renderCart = function() {
            const body = document.getElementById('posCartBody');
            body.innerHTML = '';
            let sub = 0;
            let taxableAmount = 0;
            
            // Get selected price type
            const priceType = document.querySelector('input[name="priceType"]:checked')?.value || 'retail';
            
            // Check VAT Toggle
            const applyVat = document.getElementById('posVatToggle').checked;
            
            // Get discount percentage
            const discountPercent = parseFloat(document.getElementById('posDiscount').value) || 0;
            
            if(cart.length === 0) {
                body.innerHTML = `<div class="flex h-full items-center justify-center text-gray-600 flex-col py-8 md:py-0"><i class="fa-solid fa-basket-shopping text-4xl mb-2"></i><p>Cart is empty</p></div>`;
            } else {
                cart.forEach((item, idx) => {
                    // Use selected price type (retail or wholesale)
                    const price = priceType === 'wholesale' ? (item.wholesale || item.retail) : item.retail;
                    const itemTotal = moneyRound(price * item.qty);
                    sub = moneyRound(sub + itemTotal);
                    
                    // Track taxable amount (excluding VAT exempt items)
                    if(!item.vatExempt) {
                        taxableAmount = moneyRound(taxableAmount + itemTotal);
                    }
                    
                    const row = document.createElement('div');
                    row.className = "flex flex-col bg-white/5 p-2 rounded text-xs mb-1";
                    row.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <div class="text-white font-bold">${item.name}</div>
                                <div class="text-gray-400">${db.config.currency}${price.toFixed(2)} ${priceType === 'wholesale' ? '<span class="text-blue-400">(W)</span>' : ''}</div>
                            </div>
                            <div class="flex items-center gap-2 mx-2">
                                <button onclick="updateCartQty(${idx}, -1)" class="w-5 h-5 bg-gray-700 rounded hover:bg-gray-600 text-[10px]">-</button>
                                <span class="font-bold w-3 text-center text-[10px]">${item.qty}</span>
                                <button onclick="updateCartQty(${idx}, 1)" class="w-5 h-5 bg-gray-700 rounded hover:bg-gray-600 text-[10px]">+</button>
                            </div>
                            <div class="font-bold mr-2 w-14 text-right">${db.config.currency}${itemTotal.toFixed(2)}</div>
                            <button onclick="removeFromCart(${idx})" class="text-red-500 hover:text-red-400 transition p-1 text-[10px]"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <div class="mt-1 flex items-center gap-2">
                            <button onclick="toggleVatExempt(${idx})" class="flex-1 text-[9px] px-2 py-1 rounded ${item.vatExempt ? 'bg-red-600/50 text-red-300 border border-red-500' : 'bg-gray-700 text-gray-300 border border-gray-600'} hover:bg-opacity-75 transition">
                                <i class="fa-solid ${item.vatExempt ? 'fa-ban' : 'fa-receipt'} mr-1"></i>${item.vatExempt ? 'VAT Exempt' : 'Apply VAT'}
                            </button>
                        </div>
                    `;
                    body.appendChild(row);
                });
            }

            // Calculate discount amount
            const discountAmount = moneyRound(sub * (discountPercent / 100));
            const subtotalAfterDiscount = moneyRound(sub - discountAmount);
            
            // Calculate tax only on taxable items
            const tax = applyVat ? moneyRound(subtotalAfterDiscount * (taxableAmount / sub) * (db.config.vatRate / 100)) : 0;
            
            document.getElementById('posSubTotal').innerText = `${db.config.currency}${sub.toFixed(2)}`;
            document.getElementById('posVatRate').innerText = db.config.vatRate;
            document.getElementById('posTax').innerText = `${db.config.currency}${tax.toFixed(2)}`;
            // If No VAT, strike through or dim the tax text
            document.getElementById('posTax').className = applyVat ? "" : "line-through text-gray-600";
            
            document.getElementById('posTotal').innerText = `${db.config.currency}${moneyRound(subtotalAfterDiscount + tax).toFixed(2)}`;
        }

        window.toggleVatExempt = function(idx) {
            if(idx >= 0 && idx < cart.length) {
                cart[idx].vatExempt = !cart[idx].vatExempt;
                renderCart();
            }
        }

        window.clearCart = function() { cart = []; renderCart(); }

        window.checkout = function(type) {
            if(cart.length === 0) return alert("Empty Cart");
            
            // For split payment, show split modal instead of direct checkout
            if(type === 'split') {
                try {
                    const priceType = document.querySelector('input[name="priceType"]:checked')?.value || 'retail';
                    const discountPercent = parseFloat(document.getElementById('posDiscount').value) || 0;
                    const applyVat = document.getElementById('posVatToggle').checked;
                    
                    const sub = moneyRound(cart.reduce((a, c) => {
                        const price = priceType === 'wholesale' ? (c.wholesale || c.retail) : c.retail;
                        return a + c.qty * price;
                    }, 0));
                    
                    const discount = moneyRound(sub * (discountPercent / 100));
                    const subtotalAfterDiscount = moneyRound(sub - discount);
                    
                    let taxableAmount = 0;
                    if(applyVat) {
                        cart.forEach(item => {
                            if(!item.vatExempt) {
                                const price = priceType === 'wholesale' ? (item.wholesale || item.retail) : item.retail;
                                taxableAmount = moneyRound(taxableAmount + (item.qty * price));
                            }
                        });
                    }
                    
                    const taxableAfterDiscount = applyVat ? moneyRound(taxableAmount * (1 - (discountPercent / 100))) : 0;
                    const tax = applyVat ? moneyRound(taxableAfterDiscount * (db.config.vatRate / 100)) : 0;
                    const total = moneyRound(subtotalAfterDiscount + tax);
                    
                    const totalEl = document.getElementById('splitSalesTotal');
                    const cashEl = document.getElementById('splitSalesCash');
                    const bankEl = document.getElementById('splitSalesBank');
                    const creditEl = document.getElementById('splitSalesCredit');
                    
                    if(!totalEl || !cashEl || !bankEl || !creditEl) {
                        console.error('Split payment modal elements not found');
                        alert('Split payment modal not found. Please refresh the page.');
                        return;
                    }
                    
                    totalEl.innerText = `${db.config.currency}${total.toFixed(2)}`;
                    cashEl.value = '';
                    bankEl.value = '';
                    creditEl.value = '';
                    calculateSplitSales();
                    window.openModal('splitSalesModal');
                    return;
                } catch(e) {
                    console.error('Error in split payment:', e);
                    alert('Error opening split payment modal. Check console.');
                    return;
                }
            }
            
            const custInput = document.getElementById('posCustomerInput').value;
            const custIdMatch = custInput.match(/\[ID:(\d+)\]/);
            let custId = custIdMatch ? parseInt(custIdMatch[1]) : null;
            let custName = custInput.split('[')[0].trim() || 'Guest Customer';

            // Get selected price type
            const priceType = document.querySelector('input[name="priceType"]:checked')?.value || 'retail';

            // Get discount percentage
            const discountPercent = parseFloat(document.getElementById('posDiscount').value) || 0;

            // Recalculate based on current price type, discount, and VAT toggle
            const applyVat = document.getElementById('posVatToggle').checked;
            const sub = moneyRound(cart.reduce((a, c) => {
                const price = priceType === 'wholesale' ? (c.wholesale || c.retail) : c.retail;
                return a + c.qty * price;
            }, 0));
            const discount = moneyRound(sub * (discountPercent / 100));
            const subtotalAfterDiscount = moneyRound(sub - discount);
            
            // Calculate VAT only on taxable items (excluding VAT exempt items)
            let taxableAmount = 0;
            if(applyVat) {
                cart.forEach(item => {
                    if(!item.vatExempt) {
                        const price = priceType === 'wholesale' ? (item.wholesale || item.retail) : item.retail;
                        taxableAmount = moneyRound(taxableAmount + (item.qty * price));
                    }
                });
            }
            
            // Apply discount proportionally to taxable amount
            const taxableAfterDiscount = applyVat ? moneyRound(taxableAmount * (1 - (discountPercent / 100))) : 0;
            const tax = applyVat ? moneyRound(taxableAfterDiscount * (db.config.vatRate / 100)) : 0;
            const total = moneyRound(subtotalAfterDiscount + tax);

            if(type === 'credit') {
                if(!custId) return alert("Please select a registered customer for credit sales.");
                const customer = db.customers.find(c => c.id === custId);
                customer.balance += total;
            }

            cart.forEach(item => {
                const prod = db.products.find(p => p.id === item.id);
                if(prod) prod.stock -= item.qty;
            });

            // Store cost per unit and VAT exemption status with each item
            const itemsWithCost = cart.map(item => {
                const prod = db.products.find(p => p.id === item.id);
                return {
                    ...item,
                    cost: prod ? moneyRound(prod.cost) : 0,
                    vatExempt: item.vatExempt || false
                };
            });

            const txn = {
                id: Date.now(),
                type: 'sale',
                date: new Date().toISOString(),
                entityId: custId,
                entityName: custName,
                items: itemsWithCost,
                priceType: priceType,
                sub: sub,
                discount: discount,
                discountPercent: discountPercent,
                tax: tax,
                total: total,
                payType: type
            };

            // FIX #1: Track payment method amounts for proper accounting
            if(type === 'cash') {
                txn.cashAmount = total;
            } else if(type === 'bank') {
                txn.bankAmount = total;
            } else if(type === 'credit') {
                txn.creditAmount = total;
            }
            db.transactions.push(txn);
            saveDB();
            
            // Refresh POS grid instantly to hide sold-out items
            loadPOS();
            
            if(type === 'cash' || type === 'bank') printInvoice(txn);
            else alert("Sale Recorded Successfully - Payment: " + type.toUpperCase());
            
            document.getElementById('posDiscount').value = '0';
            clearCart();
            document.getElementById('posCustomerInput').value = '';
            // Reset to retail price after checkout
            document.querySelector('input[name="priceType"][value="retail"]').checked = true;
        };

        // --- RETURNS & REFUNDS LOGIC ---
        // Return carts for multiple items
        let retCustCart = [];
        let retSupCart = [];

        window.toggleReturnSplit = function(mode) {
            const paymentMode = document.querySelector(`input[name="ret${mode === 'cust' ? 'Cust' : 'Sup'}Payment"]:checked`)?.value || 'cash';
            const splitDiv = document.getElementById(`ret${mode === 'cust' ? 'Cust' : 'Sup'}SplitDiv`);
            const splitInputs = document.querySelectorAll(`#ret${mode === 'cust' ? 'Cust' : 'Sup'}Split${mode === 'cust' ? 'C' : ''}ash, #ret${mode === 'cust' ? 'Cust' : 'Sup'}SplitBank, #ret${mode === 'cust' ? 'Cust' : 'Sup'}SplitCredit`);
            
            if(paymentMode === 'split') {
                splitDiv.classList.remove('hidden');
                // Add change listeners to split inputs
                splitInputs.forEach(input => {
                    input.addEventListener('input', () => window.calculateReturnSplitTotal(mode));
                });
            } else {
                splitDiv.classList.add('hidden');
                // Reset split values
                document.getElementById(`ret${mode === 'cust' ? 'Cust' : 'Sup'}SplitCash`).value = '';
                document.getElementById(`ret${mode === 'cust' ? 'Cust' : 'Sup'}SplitBank`).value = '';
                document.getElementById(`ret${mode === 'cust' ? 'Cust' : 'Sup'}SplitCredit`).value = '';
                document.getElementById(`ret${mode === 'cust' ? 'Cust' : 'Sup'}SplitTotal`).innerText = '$0.00';
            }
        }

        window.calculateReturnSplitTotal = function(mode) {
            const prefix = mode === 'cust' ? 'retCust' : 'retSup';
            const cash = parseFloat(document.getElementById(`${prefix}SplitCash`).value) || 0;
            const bank = parseFloat(document.getElementById(`${prefix}SplitBank`).value) || 0;
            const credit = parseFloat(document.getElementById(`${prefix}SplitCredit`).value) || 0;
            const total = cash + bank + credit;
            document.getElementById(`${prefix}SplitTotal`).innerText = `${db.config.currency}${total.toFixed(2)}`;
        }

        window.loadReturnProducts = function(mode) {
            if(mode === 'cust') {
                const custVal = document.getElementById('retCustSelect').value || '';
                const isWalkin = custVal.startsWith('walkin:');
                const walkinName = isWalkin ? custVal.split(':')[1] : null;
                const custId = isWalkin ? null : (custVal ? parseInt(custVal) : null);

                const custSel = document.getElementById('retCustProd');
                custSel.innerHTML = '<option value="">Select Product...</option>';

                // Get all sales for this customer (not returns)
                const custTxns = db.transactions.filter(t => t.type === 'sale' && !t.isReturn && (isWalkin ? (!t.entityId && t.entityName === walkinName) : t.entityId === custId));
                const productQtyMap = {};

                custTxns.forEach(t => {
                    if(t.items && Array.isArray(t.items)) {
                        t.items.forEach(item => {
                            const itemId = item.id;
                            productQtyMap[itemId] = (productQtyMap[itemId] || 0) + (item.qty || 1);
                        });
                    }
                });

                // Get all returns for this customer
                const returnTxns = db.transactions.filter(t => t.type === 'sale' && t.isReturn && (isWalkin ? (!t.entityId && t.entityName === walkinName) : t.entityId === custId));
                const productReturnedMap = {};

                returnTxns.forEach(t => {
                    if(t.items && Array.isArray(t.items)) {
                        t.items.forEach(item => {
                            const itemId = item.id;
                            productReturnedMap[itemId] = (productReturnedMap[itemId] || 0) + (item.qty || 1);
                        });
                    }
                });

                // If customer has purchases, show returnable items
                if(Object.keys(productQtyMap).length > 0) {
                    // Filter out zero-stock duplicates
                    const displayProducts = filterDuplicateZeroStockProducts(db.products);
                    
                    displayProducts.forEach(p => {
                        const totalPurchased = productQtyMap[p.id] || 0;
                        const totalReturned = productReturnedMap[p.id] || 0;
                        const remaining = totalPurchased - totalReturned;

                        if(remaining > 0) {
                            custSel.innerHTML += `<option value="${p.id}" data-max-qty="${remaining}">${p.name} (Can return: ${remaining}/${totalPurchased})</option>`;
                        }
                    });
                } else {
                    // No purchase history - show all products as fallback
                    // Filter out zero-stock duplicates
                    const displayProducts = filterDuplicateZeroStockProducts(db.products);
                    displayProducts.forEach(p => {
                        custSel.innerHTML += `<option value="${p.id}" data-max-qty="${p.stock}">${p.name}</option>`;
                    });
                }

                document.getElementById('retCustQty').value = 1;
                document.getElementById('retCustQtyPurchased').innerText = '-';
                document.getElementById('retCustPrice').innerText = '-';
            }
        }

        window.loadReturnProductsSupplier = function() {
            const prodSel = document.getElementById('retSupProd');
            prodSel.innerHTML = '<option value="">Select Product...</option>';
            
            // Filter out zero-stock duplicates
            let supplierProducts = filterDuplicateZeroStockProducts(db.products).filter(p => p.stock > 0);
            
            supplierProducts.sort((a, b) => {
                const expA = a.expiry ? new Date(a.expiry) : new Date('9999-12-31');
                const expB = b.expiry ? new Date(b.expiry) : new Date('9999-12-31');
                return expA - expB;
            });
            
            supplierProducts.forEach(p => {
                const expiryText = p.expiry ? ` | Exp: ${p.expiry}` : ' | No Expiry';
                const batchText = p.batch ? ` | Batch: ${p.batch}` : '';
                prodSel.innerHTML += `<option value="${p.id}">${p.name} (Stock: ${p.stock}${batchText}${expiryText})</option>`;
            });
        }

        window.updateReturnPrice = function(mode) {
            if(mode === 'cust') {
                const prodSelect = document.getElementById('retCustProd');
                const selectedOption = prodSelect.options[prodSelect.selectedIndex] || {};
                const pid = parseInt(prodSelect.value);
                const qty = parseInt(document.getElementById('retCustQty').value) || 0;
                const maxQty = parseInt(selectedOption.getAttribute && selectedOption.getAttribute('data-max-qty')) || 0;
                const prod = db.products.find(p => p.id === pid);

                if(prod) {
                    document.getElementById('retCustQtyPurchased').innerText = maxQty;
                    document.getElementById('retCustPrice').innerText = `${db.config.currency}${prod.retail}`;
                }
            } else if(mode === 'sup') {
                const pid = parseInt(document.getElementById('retSupProd').value);
                const prod = db.products.find(p => p.id === pid);
                if(prod) {
                    document.getElementById('retSupCost').innerText = `${db.config.currency}${prod.cost}`;
                    document.getElementById('retSupStock').innerText = prod.stock;
                }
            }
        }

        window.addToReturnCart = function(mode) {
            if(mode === 'cust') {
                const custVal = document.getElementById('retCustSelect').value || '';
                const pid = parseInt(document.getElementById('retCustProd').value);
                const qty = parseInt(document.getElementById('retCustQty').value) || 0;

                if(!custVal || !pid || qty < 1) return alert('Please select customer, product, and quantity');

                const prod = db.products.find(p => p.id === pid);
                if(!prod) return alert('Product not found');

                const prodSelect = document.getElementById('retCustProd');
                const selectedOption = prodSelect.options[prodSelect.selectedIndex] || {};
                const maxQty = parseInt(selectedOption.getAttribute('data-max-qty')) || 0;

                if(qty > maxQty) return alert(`Cannot return more than ${maxQty} units`);

                // Check if already in cart
                const existingItem = retCustCart.find(item => item.pid === pid);
                
                if(existingItem) {
                    // Calculate total if we add this quantity
                    const newTotal = existingItem.qty + qty;
                    if(newTotal > maxQty) {
                        return alert(`Cannot exceed maximum returnable quantity!\nAlready in cart: ${existingItem.qty}\nMax returnable: ${maxQty}\nTrying to add: ${qty}`);
                    }
                    existingItem.qty += qty;
                    alert(`✓ Quantity updated to ${newTotal} units`);
                } else {
                    retCustCart.push({
                        pid: pid,
                        name: prod.name,
                        qty: qty,
                        price: prod.retail,
                        max: maxQty
                    });
                    alert(`✓ Added to cart`);
                }

                renderReturnCart('cust');
                document.getElementById('retCustQty').value = 1;
            } else if(mode === 'sup') {
                const supId = parseInt(document.getElementById('retSupSelect').value);
                const pid = parseInt(document.getElementById('retSupProd').value);
                const qty = parseInt(document.getElementById('retSupQty').value) || 0;
                const reason = document.getElementById('retSupReason').value || '';

                if(!supId || !pid || qty < 1) return alert('Please select supplier, product, and quantity');

                const prod = db.products.find(p => p.id === pid);
                if(!prod) return alert('Product not found');
                if(qty > prod.stock) return alert(`Cannot return more than ${prod.stock} units in stock`);

                const existingItem = retSupCart.find(item => item.pid === pid);
                
                if(existingItem) {
                    // Calculate total if we add this quantity
                    const newTotal = existingItem.qty + qty;
                    if(newTotal > prod.stock) {
                        return alert(`Cannot exceed stock!\nAlready in cart: ${existingItem.qty}\nStock available: ${prod.stock}\nTrying to add: ${qty}`);
                    }
                    existingItem.qty += qty;
                    alert(`✓ Quantity updated to ${newTotal} units`);
                } else {
                    retSupCart.push({
                        pid: pid,
                        name: prod.name,
                        qty: qty,
                        cost: prod.cost,
                        reason: reason
                    });
                    alert(`✓ Added to cart`);
                }

                renderReturnCart('sup');
                document.getElementById('retSupQty').value = 1;
                document.getElementById('retSupReason').value = '';
            }
        }

        window.renderReturnCart = function(mode) {
            if(mode === 'cust') {
                const cart = retCustCart;
                const container = document.getElementById('retCustCart');
                const countEl = document.getElementById('retCustCartCount');
                let total = 0;

                if(cart.length === 0) {
                    container.innerHTML = '<p class="text-xs text-gray-600">No items added</p>';
                    countEl.innerText = '0';
                } else {
                    container.innerHTML = cart.map((item, idx) => {
                        const itemTotal = item.price * item.qty;
                        total += itemTotal;
                        return `
                            <div class="flex justify-between items-center text-xs bg-white/5 p-1 rounded border border-gray-700">
                                <div>
                                    <span class="text-white">${item.name}</span>
                                    <span class="text-gray-500"> x${item.qty}</span>
                                </div>
                                <div class="flex items-center gap-1">
                                    <span class="text-karta-primary font-bold">${db.config.currency}${itemTotal.toFixed(2)}</span>
                                    <button onclick="removeFromReturnCart('cust', ${idx})" class="text-red-500 hover:text-red-400 text-xs">✕</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    countEl.innerText = cart.length;
                }

                document.getElementById('retCustTotal').innerText = `${db.config.currency}${total.toFixed(2)}`;
            } else if(mode === 'sup') {
                const cart = retSupCart;
                const container = document.getElementById('retSupCart');
                const countEl = document.getElementById('retSupCartCount');
                let total = 0;

                if(cart.length === 0) {
                    container.innerHTML = '<p class="text-xs text-gray-600">No items added</p>';
                    countEl.innerText = '0';
                } else {
                    container.innerHTML = cart.map((item, idx) => {
                        const itemTotal = item.cost * item.qty;
                        total += itemTotal;
                        return `
                            <div class="flex justify-between items-center text-xs bg-white/5 p-1 rounded border border-gray-700">
                                <div>
                                    <span class="text-white">${item.name}</span>
                                    <span class="text-gray-500"> x${item.qty}</span>
                                </div>
                                <div class="flex items-center gap-1">
                                    <span class="text-karta-primary font-bold">${db.config.currency}${itemTotal.toFixed(2)}</span>
                                    <button onclick="removeFromReturnCart('sup', ${idx})" class="text-red-500 hover:text-red-400 text-xs">✕</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    countEl.innerText = cart.length;
                }

                document.getElementById('retSupTotal').innerText = `${db.config.currency}${total.toFixed(2)}`;
            }
        }

        window.removeFromReturnCart = function(mode, idx) {
            if(mode === 'cust') {
                retCustCart.splice(idx, 1);
                renderReturnCart('cust');
            } else if(mode === 'sup') {
                retSupCart.splice(idx, 1);
                renderReturnCart('sup');
            }
        }

        window.clearReturnCart = function(mode) {
            if(mode === 'cust') {
                retCustCart = [];
                renderReturnCart('cust');
            } else if(mode === 'sup') {
                retSupCart = [];
                renderReturnCart('sup');
            }
        }

        window.processReturn = function(mode) {
            if(mode === 'cust') {
                if(retCustCart.length === 0) return alert('No items in return cart');

                const custVal = document.getElementById('retCustSelect').value || '';
                const isWalkin = custVal.startsWith('walkin:');
                const walkinName = isWalkin ? custVal.split(':')[1] : null;
                const custId = isWalkin ? null : (custVal ? parseInt(custVal) : null);
                const paymentMode = document.querySelector('input[name="retCustPayment"]:checked')?.value || 'cash';

                if(!isWalkin && !custId) return alert('Please select a customer');

                const cust = isWalkin ? null : db.customers.find(c => c.id === custId);
                if(!isWalkin && !cust) return alert('Customer not found');

                let totalRefund = 0;
                const returnItems = [];

                // Validate and calculate total
                for(let item of retCustCart) {
                    const prod = db.products.find(p => p.id === item.pid);
                    if(!prod) return alert(`Product ${item.name} not found`);
                    
                    const itemTotal = prod.retail * item.qty;
                    totalRefund += itemTotal;
                    returnItems.push({
                        id: item.pid,
                        name: item.name,
                        qty: item.qty,
                        retail: prod.retail
                    });
                    prod.stock += item.qty;
                }

                if(confirm(`Process return for ${retCustCart.length} items?\nTotal Refund: ${db.config.currency}${totalRefund.toFixed(2)}\nMethod: ${paymentMode.toUpperCase()}`)) {
                    // Update customer balance
                    if(!isWalkin && cust) {
                        cust.balance -= totalRefund;  // Customer owes less after refund
                    }

                    // Record transaction
                    const txn = {
                        id: Date.now(),
                        type: 'sale',
                        date: new Date().toISOString(),
                        entityId: custId,
                        entityName: isWalkin ? walkinName : (cust ? cust.name : 'Guest Customer'),
                        items: returnItems,
                        total: -totalRefund,
                        payType: paymentMode,
                        isReturn: true
                    };

                    // Track cash/bank/credit - for returns, we subtract from totals
                    if(paymentMode === 'cash') {
                        txn.cashAmount = -totalRefund;
                    } else if(paymentMode === 'bank') {
                        txn.bankAmount = -totalRefund;
                    } else if(paymentMode === 'credit') {
                        txn.creditAmount = -totalRefund;
                    } else if(paymentMode === 'split') {
                        // Get split payment values from inputs
                        const splitCash = parseFloat(document.getElementById('retCustSplitCash').value) || 0;
                        const splitBank = parseFloat(document.getElementById('retCustSplitBank').value) || 0;
                        const splitCredit = parseFloat(document.getElementById('retCustSplitCredit').value) || 0;
                        const splitTotal = splitCash + splitBank + splitCredit;
                        
                        if(splitTotal !== totalRefund) {
                            return alert(`Split payment total (${db.config.currency}${splitTotal.toFixed(2)}) doesn't match refund amount (${db.config.currency}${totalRefund.toFixed(2)})`);
                        }
                        
                        txn.splitCash = -splitCash;
                        txn.splitBank = -splitBank;
                        txn.splitCredit = -splitCredit;
                    }

                    db.transactions.push(txn);

                    saveDB();
                    alert(`✅ Return Processed!\nItems: ${retCustCart.length}\nRefund: ${db.config.currency}${totalRefund.toFixed(2)}\nMode: ${paymentMode.toUpperCase()}`);
                    
                    retCustCart = [];
                    renderReturnCart('cust');
                    loadDashboard();
                    document.getElementById('retCustSelect').value = '';
                    document.getElementById('retCustProd').innerHTML = '<option value="">Select Product...</option>';
                }
            } else if(mode === 'sup') {
                if(retSupCart.length === 0) return alert('No items in return cart');

                const supId = parseInt(document.getElementById('retSupSelect').value);
                const paymentMode = document.querySelector('input[name="retSupPayment"]:checked')?.value || 'cash';

                if(!supId) return alert('Please select a supplier');

                const sup = db.suppliers.find(s => s.id === supId);
                if(!sup) return alert('Supplier not found');

                let totalValue = 0;
                const returnItems = [];

                // Validate and calculate total
                for(let item of retSupCart) {
                    const prod = db.products.find(p => p.id === item.pid);
                    if(!prod) return alert(`Product ${item.name} not found`);
                    if(item.qty > prod.stock) return alert(`Cannot return more than ${prod.stock} units of ${item.name}`);
                    
                    const itemTotal = prod.cost * item.qty;
                    totalValue += itemTotal;
                    returnItems.push({
                        id: item.pid,
                        name: item.name,
                        qty: item.qty,
                        cost: prod.cost
                    });
                    prod.stock -= item.qty;
                }

                if(confirm(`Process supplier return for ${retSupCart.length} items?\nTotal Value: ${db.config.currency}${totalValue.toFixed(2)}\nMethod: ${paymentMode.toUpperCase()}`)) {
                    // Reduce supplier balance (what we owe them)
                    sup.balance = moneyRound(sup.balance - totalValue);

                    // Record transaction
                    const txn = {
                        id: Date.now(),
                        type: 'purchase',
                        date: new Date().toISOString(),
                        entityId: supId,
                        entityName: sup.name,
                        items: returnItems,
                        total: -totalValue,
                        payType: paymentMode,
                        ref: 'Supplier Return',
                        isReturn: true
                    };

                    // Track cash/bank/credit - for supplier returns, money comes IN (positive)
                    if(paymentMode === 'cash') {
                        txn.cashAmount = totalValue;
                    } else if(paymentMode === 'bank') {
                        txn.bankAmount = totalValue;
                    } else if(paymentMode === 'credit') {
                        txn.creditAmount = totalValue;
                    } else if(paymentMode === 'split') {
                        // Get split payment values from inputs
                        const splitCash = parseFloat(document.getElementById('retSupSplitCash').value) || 0;
                        const splitBank = parseFloat(document.getElementById('retSupSplitBank').value) || 0;
                        const splitCredit = parseFloat(document.getElementById('retSupSplitCredit').value) || 0;
                        const splitTotal = splitCash + splitBank + splitCredit;
                        
                        if(splitTotal !== totalValue) {
                            return alert(`Split payment total (${db.config.currency}${splitTotal.toFixed(2)}) doesn't match return value (${db.config.currency}${totalValue.toFixed(2)})`);
                        }
                        
                        txn.splitCash = splitCash;
                        txn.splitBank = splitBank;
                        txn.splitCredit = splitCredit;
                    }

                    db.transactions.push(txn);

                    saveDB();
                    alert(`✅ Supplier Return Processed!\nItems: ${retSupCart.length}\nValue: ${db.config.currency}${totalValue.toFixed(2)}\nMode: ${paymentMode.toUpperCase()}`);
                    
                    retSupCart = [];
                    renderReturnCart('sup');
                    loadDashboard();
                    document.getElementById('retSupSelect').value = '';
                    document.getElementById('retSupProd').innerHTML = '<option value="">Select Product...</option>';
                }
            }
        }
        window.loadReturns = function() {
            // Clear carts when page loads
            retCustCart = [];
            retSupCart = [];
            renderReturnCart('cust');
            renderReturnCart('sup');
            
            // Populate customer select for returns
            const custSel = document.getElementById('retCustSelect');
            custSel.innerHTML = '<option value="">Select Customer...</option>';
            
            // Add registered customers
            db.customers.forEach(c => {
                custSel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
            
            // Add walk-in customers (anyone with transactions but no customer ID)
            const walkInNames = new Set();
            db.transactions.forEach(t => {
                if(t.type === 'sale' && !t.entityId && t.entityName && t.entityName !== 'Guest Customer') {
                    walkInNames.add(t.entityName);
                }
            });
            
            // Add a separator and walk-in customers
            if(walkInNames.size > 0) {
                custSel.innerHTML += `<option value="" disabled>── Walk-in Customers ──</option>`;
                walkInNames.forEach(name => {
                    custSel.innerHTML += `<option value="walkin:${name}">${name} (Walk-in)</option>`;
                });
            }
            
            // Populate supplier select for returns
            const supSel = document.getElementById('retSupSelect');
            supSel.innerHTML = '<option value="">Select Supplier...</option>';
            db.suppliers.forEach(s => {
                supSel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });
        }

        // --- Invoice List Logic ---
        window.loadInvoices = function() {
            const tbody = document.getElementById('invoiceListBody');
            tbody.innerHTML = '';
            const search = document.getElementById('invoiceSearch').value.toLowerCase();
            const filterDate = document.getElementById('invoiceDateFilter').value;

            db.transactions.slice().reverse().filter(t => t.type === 'sale').forEach(t => {
                // Check search term
                if(search && !t.id.toString().includes(search) && !t.entityName.toLowerCase().includes(search)) {
                    return;
                }
                
                // Check exact date match
                const txnDate = t.date.substring(0, 10); // Extract YYYY-MM-DD
                if(filterDate && txnDate !== filterDate) {
                    return;
                }
                
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 border-b border-gray-800";
                tr.innerHTML = `
                    <td class="p-3 text-gray-400 text-xs">${new Date(t.date).toLocaleDateString()}</td>
                    <td class="p-3 font-mono">#${t.id.toString().slice(-6)}</td>
                    <td class="p-3 font-bold text-white">${t.entityName}</td>
                    <td class="p-3 text-right text-green-400">${db.config.currency}${t.total.toFixed(2)}</td>
                    <td class="p-3 text-center"><span class="px-2 py-1 rounded text-xs ${t.payType==='credit' ? 'bg-yellow-900 text-yellow-300' : 'bg-green-900 text-green-300'} uppercase">${t.payType || 'cash'}</span></td>
                    <td class="p-3 text-center">
                        <button onclick="editInvoice(${t.id})" class="text-gray-400 hover:text-white mx-1"><i class="fa-solid fa-pen"></i></button>
                        <button onclick='printInvoiceStr(${JSON.stringify(t)})' class="text-blue-400 hover:text-blue-300 mx-1"><i class="fa-solid fa-print"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Clear all filters
        window.clearInvoiceFilters = function() {
            document.getElementById('invoiceSearch').value = '';
            document.getElementById('invoiceDateFilter').value = '';
            loadInvoices();
        }
        
        // Helper to pass object in HTML string onclick
        window.printInvoiceStr = function(txn) {
            printInvoice(txn);
        }

        window.editInvoice = function(id) {
            editTxnId = id;
            const txn = db.transactions.find(t => t.id === id);
            if(!txn) return;

            window.openModal('invEditModal');
            document.getElementById('editInvId').innerText = id;
            
            const custSel = document.getElementById('editInvCust');
            custSel.innerHTML = db.customers.map(c => `<option value="${c.id}" ${c.id === txn.entityId ? 'selected' : ''}>${c.name}</option>`).join('');
            // If Guest, add option
            if(!txn.entityId) custSel.innerHTML += `<option value="" selected>Guest Customer</option>`;

            document.getElementById('editInvPay').value = txn.payType || 'cash';
            
            const container = document.getElementById('editInvItems');
            container.innerHTML = '';
            txn.items.forEach(item => {
                container.appendChild(createEditItemRow(item));
            });
        }

        function createEditItemRow(item = {name: '', qty: 1, retail: 0, id: 0}) {
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center";
            div.innerHTML = `
                <input type="hidden" class="product-id" value="${item.id || 0}">
                <input type="text" class="input-field w-1/2 text-xs" placeholder="Product" value="${item.name}">
                <input type="number" class="input-field w-16 text-xs" placeholder="Qty" value="${item.qty}">
                <input type="number" class="input-field w-20 text-xs" placeholder="Price" value="${item.retail}">
                <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-300"><i class="fa-solid fa-trash"></i></button>
            `;
            return div;
        }

        window.addEditItem = function() {
            document.getElementById('editInvItems').appendChild(createEditItemRow());
        }

        window.saveInvoiceEdit = function() {
            if(!editTxnId) return;
            // REVERSE OLD TXN
            const oldTxn = db.transactions.find(t => t.id === editTxnId);
            // Revert stock
            oldTxn.items.forEach(i => {
                const p = i.id ? db.products.find(x => x.id === i.id) : db.products.find(x => x.name === i.name);
                if(p) p.stock += i.qty;
            });
            // Revert customer balance
            if(oldTxn.payType === 'credit' && oldTxn.entityId) {
                const c = db.customers.find(x => x.id === oldTxn.entityId);
                if(c) c.balance -= oldTxn.total;
            }

            // BUILD NEW TXN DATA
            const rows = document.querySelectorAll('#editInvItems > div');
            const newItems = [];
            let sub = 0;
            rows.forEach(r => {
                const hiddenId = parseInt(r.querySelector('.product-id').value) || 0;
                const inputs = r.querySelectorAll('input[type="text"], input[type="number"]');
                const name = inputs[0].value;
                const qty = parseInt(inputs[1].value);
                const retail = moneyRound(parseFloat(inputs[2].value));
                if(name && qty > 0) {
                    // FIX #3: GHOST ITEM - Persist product_id from original transaction
                    newItems.push({name, qty, retail, id: hiddenId});
                    sub = moneyRound(sub + moneyRound(qty * retail));
                }
            });

            const tax = moneyRound(sub * (db.config.vatRate/100));
            const total = moneyRound(sub + tax);
            const payType = document.getElementById('editInvPay').value;
            const custIdVal = document.getElementById('editInvCust').value;
            const custId = custIdVal ? parseInt(custIdVal) : null;
            const custName = custId ? db.customers.find(c=>c.id === custId).name : 'Guest Customer';

            // APPLY NEW TXN
            // Deduct stock
            newItems.forEach(i => {
                const p = i.id ? db.products.find(x => x.id === i.id) : db.products.find(x => x.name === i.name);
                if(p) p.stock -= i.qty;
            });
            // Add balance
            if(payType === 'credit' && custId) {
                const c = db.customers.find(x => x.id === custId);
                if(c) c.balance += total;
            }

            // Update Record
            oldTxn.items = newItems;
            oldTxn.sub = sub;
            oldTxn.tax = tax;
            oldTxn.total = total;
            oldTxn.payType = payType;
            oldTxn.entityId = custId;
            oldTxn.entityName = custName;

            saveDB();
            window.closeModal();
            loadInvoices(); // Refresh list
            alert("Invoice Updated");
        }

        window.deleteInvoice = function() {
            if(!editTxnId || !confirm("Delete this invoice permanently? This will reverse stock changes.")) return;
            
            const oldTxn = db.transactions.find(t => t.id === editTxnId);
            // Revert stock
            oldTxn.items.forEach(i => {
                const p = db.products.find(x => x.name === i.name);
                if(p) p.stock += i.qty;
            });
            // Revert customer balance
            if(oldTxn.payType === 'credit' && oldTxn.entityId) {
                const c = db.customers.find(x => x.id === oldTxn.entityId);
                if(c) c.balance -= oldTxn.total;
            }

            db.transactions = db.transactions.filter(t => t.id !== editTxnId);
            saveDB();
            window.closeModal();
            loadInvoices();
        }

        // Load and display batches in the Stock Batches table
        window.loadBatches = function() {
            const tbody = document.getElementById('batchBody');
            if(!tbody) return; // Element doesn't exist if not on purchases page
            
            tbody.innerHTML = '';
            
            // Ensure batches array exists
            if(!db.batches) db.batches = [];
            
            // AUTO-CLEAN: Remove old stock products with 0 qty if newer stock exists
            const productNames = {};
            db.products.forEach(p => {
                if (!productNames[p.name]) productNames[p.name] = [];
                productNames[p.name].push(p);
            });
            
            // For each product name, if we have multiple batches
            Object.keys(productNames).forEach(name => {
                const variants = productNames[name];
                if(variants.length > 1) {
                    // Sort by expiry date - oldest first (FEFO: First Expire, First Out)
                    variants.sort((a, b) => {
                        const expiryA = a.expiry ? new Date(a.expiry) : new Date('2099-12-31');
                        const expiryB = b.expiry ? new Date(b.expiry) : new Date('2099-12-31');
                        return expiryA - expiryB;
                    });
                    
                    // Check if we have at least one variant with stock > 0
                    const hasNewStock = variants.some(v => v.stock > 0);
                    
                    // If newer stock exists, delete old items with 0 quantity
                    if(hasNewStock) {
                        variants.forEach((v, idx) => {
                            if(idx > 0 && v.stock === 0) {
                                // FIX #4: MISSING HISTORY - Mark as hidden instead of deleting
                                v.hidden = true;
                            }
                        });
                    }
                }
            });
            
            // Save cleanup changes to database
            saveDB();
            
            // Sort batches by purchase date (newest first)
            const sortedBatches = (db.batches && Array.isArray(db.batches)) ? db.batches.slice().reverse() : [];
            
            if(sortedBatches.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-400">No stock batches recorded yet</td></tr>`;
                return;
            }
            
            sortedBatches.forEach(batch => {
                // Determine expiry status for color coding
                let expiryClass = 'text-gray-400';
                let expiryText = batch.expiryDate || 'N/A';
                
                if(batch.expiryDate && batch.expiryDate !== 'N/A') {
                    const expireDate = new Date(batch.expiryDate);
                    const today = new Date();
                    const daysUntilExpiry = Math.floor((expireDate - today) / (1000 * 60 * 60 * 24));
                    
                    if(daysUntilExpiry <= 0) {
                        expiryClass = 'text-red-500 font-bold';
                    } else if(daysUntilExpiry <= 7) {
                        expiryClass = 'text-red-500 font-bold';
                    } else if(daysUntilExpiry <= 30) {
                        expiryClass = 'text-orange-500';
                    } else if(daysUntilExpiry <= 90) {
                        expiryClass = 'text-yellow-500';
                    }
                }
                
                const purchaseDate = batch.purchaseDate ? new Date(batch.purchaseDate).toLocaleDateString() : 'N/A';
                
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 border-b border-gray-800";
                tr.innerHTML = `
                    <td class="p-3 text-white">${batch.productName || '-'}</td>
                    <td class="p-3 text-gray-400">${batch.batchNumber || '-'}</td>
                    <td class="p-3 ${expiryClass}">${expiryText}</td>
                    <td class="p-3 text-right text-gray-300">${batch.quantity}</td>
                    <td class="p-3 text-right text-gray-400">${db.config.currency}${(batch.costPrice || 0).toFixed(2)}</td>
                    <td class="p-3 text-gray-400 text-sm">${purchaseDate}</td>
                    <td class="p-3 text-gray-400">${batch.supplierName || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- Dashboard & Charts ---
        let mainChart;
        let catChart;

        function loadDashboard() {
            // FIX: Ensure arrays exist
            if(!db.transactions) db.transactions = [];
            if(!db.products) db.products = [];
            if(!db.customers) db.customers = [];
            if(!db.suppliers) db.suppliers = [];

            const sales = db.transactions.filter(t => t.type === 'sale');
            const revenue = sales.reduce((a,c) => a + c.total, 0);
            const stockVal = db.products.reduce((a,c) => a + (c.stock * c.cost), 0);
            
            // Calculate Cash, Bank, and Credit totals from sales (including returns as negative amounts)
            let cashTotal = 0;
            let bankTotal = 0;
            let creditTotal = 0;
            
            sales.forEach(t => {
                // Use explicit amount fields if they exist (these are properly signed: positive for sales, negative for returns)
                if(t.cashAmount !== undefined) {
                    cashTotal += t.cashAmount;
                } else if(t.payType === 'cash') {
                    cashTotal += t.total;
                } else if(t.payType === 'split') {
                    // For sales without explicit cashAmount, fall back to split breakdown
                    cashTotal += t.splitCash || 0;
                }
                
                if(t.bankAmount !== undefined) {
                    bankTotal += t.bankAmount;
                } else if(t.payType === 'bank') {
                    bankTotal += t.total;
                } else if(t.payType === 'split') {
                    bankTotal += t.splitBank || 0;
                }
                
                if(t.creditAmount !== undefined) {
                    creditTotal += t.creditAmount;
                } else if(t.payType === 'credit') {
                    creditTotal += t.total;
                } else if(t.payType === 'split') {
                    creditTotal += t.splitCredit || 0;
                }
            });
            
            // Also add purchase transactions that affect cash/bank
            db.transactions.filter(t => t.type === 'purchase').forEach(t => {
                // Use explicit amount fields if they exist
                if(t.cashAmount !== undefined) {
                    cashTotal += t.cashAmount;
                } else if(t.payType === 'cash') {
                    cashTotal -= t.total;  // Negative because money is going out
                }
                
                if(t.bankAmount !== undefined) {
                    bankTotal += t.bankAmount;
                } else if(t.payType === 'bank') {
                    bankTotal -= t.total;
                }
                
                if(t.creditAmount !== undefined) {
                    creditTotal += t.creditAmount;
                } else if(t.payType === 'credit') {
                    creditTotal += t.total;  // FIX #2: Credit purchases ADD to payable (positive)
                }
            });
            
            // FIX #3: Account for expenses (subtract from cash as applicable)
            db.transactions.filter(t => t.type === 'expense').forEach(t => {
                if(t.total) cashTotal -= t.total;  // Expenses reduce cash
            });
            
            // Calculate customer balance due (receivables)
            const customerBalanceDue = db.customers.reduce((a, c) => a + c.balance, 0);
            
            // Calculate supplier balance due (payables)
            const supplierBalanceDue = db.suppliers.reduce((a, s) => a + s.balance, 0);
            
            // Net balance = Receivables - Payables
            const netBalance = customerBalanceDue - supplierBalanceDue;
            
            // Get expired/expiring products
            const today = new Date().toISOString().split('T')[0];
            const ninetyDaysLater = new Date();
            ninetyDaysLater.setDate(ninetyDaysLater.getDate() + 90);
            const expireThresholdDate = ninetyDaysLater.toISOString().split('T')[0];
            
            const lowStock = db.products.filter(p => p.stock <= p.reorder && p.stock > 0);
            
            // Show both expired AND expiring soon products (within 90 days from today)
            const expiredProducts = db.products.filter(p => {
                return p.expiry && p.expiry.trim() !== '' && p.expiry <= expireThresholdDate && p.stock > 0;
            }).sort((a, b) => new Date(a.expiry) - new Date(b.expiry));

            // Update KPI Elements with null checks
            if(document.getElementById('kpiRevenue')) document.getElementById('kpiRevenue').innerText = `${db.config.currency}${revenue.toFixed(2)}`;
            if(document.getElementById('kpiCash')) document.getElementById('kpiCash').innerText = `${db.config.currency}${cashTotal.toFixed(2)}`;
            if(document.getElementById('kpiBank')) document.getElementById('kpiBank').innerText = `${db.config.currency}${bankTotal.toFixed(2)}`;
            if(document.getElementById('kpiStockVal')) document.getElementById('kpiStockVal').innerText = `${db.config.currency}${stockVal.toFixed(2)}`;
            if(document.getElementById('kpiLowStock')) document.getElementById('kpiLowStock').innerText = `${lowStock.length}`;
            
            // Update Balance KPIs
            if(document.getElementById('kpiCustDue')) document.getElementById('kpiCustDue').innerText = `${db.config.currency}${customerBalanceDue.toFixed(2)}`;
            if(document.getElementById('kpiSupDue')) document.getElementById('kpiSupDue').innerText = `${db.config.currency}${supplierBalanceDue.toFixed(2)}`;
            if(document.getElementById('kpiNetBalance')) {
                document.getElementById('kpiNetBalance').innerText = `${db.config.currency}${netBalance.toFixed(2)}`;
                // Color code net balance - use theme colors
                const netEl = document.getElementById('kpiNetBalance');
                if(netBalance > 0) {
                    netEl.className = 'text-3xl font-bold text-green-500';
                } else if(netBalance < 0) {
                    netEl.className = 'text-3xl font-bold text-red-500';
                } else {
                    netEl.className = 'text-3xl font-bold text-karta-primary';
                }
            }

            const lsBody = document.getElementById('lowStockBody');
            if (lsBody) {
                lsBody.innerHTML = '';
                if(lowStock.length === 0) {
                    lsBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">✓ All products above reorder level</td></tr>`;
                } else {
                    lowStock.forEach(p => {
                        const percentOfReorder = Math.round((p.stock / p.reorder) * 100);
                        const rowClass = percentOfReorder < 25 ? 'bg-red-950/20 border-l-4 border-red-600' : 'bg-orange-950/20 border-l-4 border-orange-500';
                        lsBody.innerHTML += `
                            <tr class="hover:bg-white/5 ${rowClass}">
                                <td class="p-3 text-white font-bold">${p.name}</td>
                                <td class="p-3 text-gray-500">${p.sku || '-'}</td>
                                <td class="p-3 text-gray-500">${p.supplierName || 'Internal'}</td>
                                <td class="p-3 text-right font-bold ${percentOfReorder < 25 ? 'text-red-500' : 'text-orange-500'}">${p.stock}</td>
                                <td class="p-3 text-right text-gray-400">${p.reorder} (${percentOfReorder}%)</td>
                            </tr>
                        `;
                    });
                }
            }

            // Populate expired products table
            const expBody = document.getElementById('expiredBody');
            if (expBody) {
                expBody.innerHTML = '';
                if (expiredProducts.length === 0) {
                    expBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-400">✓ No expired or expiring products</td></tr>`;
                } else {
                    expiredProducts.forEach(p => {
                        const expiryDate = new Date(p.expiry);
                        const todayDate = new Date();
                        const daysExpired = Math.floor((todayDate - expiryDate) / (1000 * 60 * 60 * 24));
                        let statusClass, statusText, rowClass;
                        
                        if (daysExpired > 0) {
                            // Already expired
                            if(daysExpired > 90) {
                                statusClass = 'text-red-700 font-bold';
                                statusText = `🔴 ${daysExpired} days OVERDUE`;
                                rowClass = 'bg-red-950/40 border-l-4 border-red-700';
                            } else if(daysExpired > 30) {
                                statusClass = 'text-red-600 font-bold';
                                statusText = `🔴 ${daysExpired} days overdue`;
                                rowClass = 'bg-red-950/30 border-l-4 border-red-600';
                            } else {
                                statusClass = 'text-red-500 font-bold';
                                statusText = `🔴 Expired ${daysExpired} day(s) ago`;
                                rowClass = 'bg-red-950/20 border-l-4 border-red-500';
                            }
                        } else {
                            // Expiring soon
                            const daysUntilExpiry = Math.abs(daysExpired);
                            if (daysUntilExpiry <= 3) {
                                statusClass = 'text-red-600 font-bold';
                                statusText = ` EXPIRES IN ${daysUntilExpiry} DAY${daysUntilExpiry !== 1 ? 'S' : ''}`;
                                rowClass = 'bg-red-950/30 border-l-4 border-red-600';
                            } else if (daysUntilExpiry <= 7) {
                                statusClass = 'text-red-500 font-bold';
                                statusText = ` Expires in ${daysUntilExpiry} days`;
                                rowClass = 'bg-red-950/20 border-l-4 border-red-500';
                            } else if (daysUntilExpiry <= 30) {
                                statusClass = 'text-orange-500 font-bold';
                                statusText = ` Expires in ${daysUntilExpiry} days`;
                                rowClass = 'bg-orange-950/15 border-l-4 border-orange-500';
                            } else {
                                statusClass = 'text-yellow-600';
                                statusText = ` Expires in ${daysUntilExpiry} days`;
                                rowClass = 'bg-yellow-950/10 border-l-4 border-yellow-600';
                            }
                        }
                        
                        expBody.innerHTML += `
                            <tr class="hover:bg-white/5 ${rowClass}">
                                <td class="p-3 text-white font-bold">${p.name}</td>
                                <td class="p-3 text-gray-500">${p.sku || '-'}</td>
                                <td class="p-3 text-gray-400">${p.batch || 'N/A'}</td>
                                <td class="p-3 text-center font-mono text-sm text-gray-300">${p.expiry}</td>
                                <td class="p-3 text-right font-bold text-white">${p.stock} units</td>
                                <td class="p-3 text-center ${statusClass}">${statusText}</td>
                            </tr>
                        `;
                    });
                }
            }

            // Charts
            const labels = [], salesData = [], purchData = [];
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const dateKey = d.toISOString().split('T')[0];
                labels.push(d.toLocaleDateString(undefined, {weekday: 'short'}));
                const dayTxns = db.transactions.filter(t => t.date.startsWith(dateKey));
                salesData.push(dayTxns.filter(t => t.type === 'sale').reduce((sum, t) => sum + t.total, 0));
                purchData.push(dayTxns.filter(t => t.type === 'purchase').reduce((sum, t) => sum + t.total, 0));
            }

            const catTotals = {};
            db.transactions.filter(t => t.type === 'sale').forEach(t => {
                t.items.forEach(item => {
                    const prod = db.products.find(p => p.id === item.id) || db.products.find(p => p.name === item.name);
                    const cat = prod ? prod.category : 'Uncategorized';
                    const lineTotal = item.qty * (item.retail || 0);
                    catTotals[cat] = (catTotals[cat] || 0) + lineTotal;
                });
            });

            const ctxMain = document.getElementById('mainChart');
            if(ctxMain) {
                const mainCtx = ctxMain.getContext('2d');
                if(mainChart) mainChart.destroy();
                mainChart = new Chart(mainCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Sales', data: salesData, backgroundColor: '#00c853' },
                            { label: 'Purchases', data: purchData, backgroundColor: '#333333' }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            const ctxCat = document.getElementById('categoryChart');
            if(ctxCat) {
                const catCtx = ctxCat.getContext('2d');
                if(catChart) catChart.destroy();
                catChart = new Chart(catCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(catTotals).length ? Object.keys(catTotals) : ['No Sales'],
                        datasets: [{ data: Object.values(catTotals).length ? Object.values(catTotals) : [1], backgroundColor: ['#00c853', '#009624', '#69f0ae'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        }

        // --- Invoice Printing ---
        // Number to Nepali Words Converter
        function numberToWords(num) {
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
            const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            const scales = ['', 'Thousand', 'Million', 'Billion', 'Trillion'];
            
            if (num === 0) return 'Zero';
            if (num < 0) return 'Negative ' + numberToWords(-num);
            
            let words = '';
            let scaleIndex = 0;
            
            while (num > 0) {
                if (num % 1000 !== 0) {
                    words = convertHundreds(num % 1000) + (scales[scaleIndex] ? ' ' + scales[scaleIndex] + ' ' : '') + words;
                }
                num = Math.floor(num / 1000);
                scaleIndex++;
            }
            
            function convertHundreds(num) {
                let result = '';
                if (Math.floor(num / 100) > 0) {
                    result += ones[Math.floor(num / 100)] + ' Hundred ';
                }
                num %= 100;
                if (num >= 20) {
                    result += tens[Math.floor(num / 10)] + ' ';
                    if (num % 10 > 0) result += ones[num % 10];
                } else if (num >= 10) {
                    result += teens[num - 10];
                } else if (num > 0) {
                    result += ones[num];
                }
                return result.trim();
            }
            
            return words.trim();
        }

        function printInvoice(txn) {
            // SHOW INVOICE VIEW, HIDE REPORT VIEW
            document.getElementById('invoice-print-view').classList.remove('hidden');
            document.getElementById('report-print-view').classList.add('hidden');

            // Show logo if exists
            const logoImg = document.getElementById('printInvLogo');
            if(db.config.logo) {
                logoImg.src = db.config.logo;
                logoImg.style.display = 'block';
            } else {
                logoImg.style.display = 'none';
            }

            // Company Info
            document.getElementById('invCompName').innerText = db.config.name;
            document.getElementById('invCompAddr').innerText = 'Address: ' + (db.config.address || '-');
            document.getElementById('invCompPhone').innerText = 'Phone: ' + (db.config.phone || '-');
            document.getElementById('invCompTax').innerText = db.config.taxId || '123456789';
            document.getElementById('invCompRepName').innerText = db.config.name || 'Company';
            
            // Invoice Details
            document.getElementById('invNo').innerText = txn.id.toString().slice(-6);
            document.getElementById('invDate').innerText = new Date(txn.date).toLocaleDateString();
            document.getElementById('invSignDate').innerText = new Date(txn.date).toLocaleDateString();
            
            // Customer Info
            document.getElementById('invCustName').innerText = txn.entityName || 'Guest Customer';
            document.getElementById('invCustContact').innerText = txn.entityPhone ? 'Phone: ' + txn.entityPhone : '';
            document.getElementById('invCustTaxId').innerText = txn.entityTaxId ? 'Tax ID: ' + txn.entityTaxId : '';
            document.getElementById('invCustSignature').innerText = (txn.entityName || 'Customer') + ' - Signature';
            
            // Payment method
            document.getElementById('invPayMethod').innerText = txn.payType || 'Cash';
            
            // Items with VAT columns
            const tbody = document.getElementById('invItemsBody');
            tbody.innerHTML = '';
            const vatRate = db.config.vatRate || 13;
            let totalVatAmount = 0;
            
            txn.items.forEach((item, idx) => {
                const itemPrice = item.retail || 0;
                const itemQty = item.qty || 0;
                const itemTotal = itemQty * itemPrice;
                const vatStatus = item.vatExempt ? 'No' : 'Yes';
                const itemVat = item.vatExempt ? 0 : (itemTotal * vatRate / 100);
                totalVatAmount += itemVat;
                
                tbody.innerHTML += `
                    <tr style="border-right: 1px solid #000; border-bottom: 1px solid #000;">
                        <td style="padding: 8px; text-align: center; border-right: 1px solid #000; border-bottom: 1px solid #000;">${idx+1}</td>
                        <td style="padding: 8px; border-right: 1px solid #000; border-bottom: 1px solid #000;">
                            <strong>${item.name}</strong><br>
                            <span style="font-size: 10px; color: #666;">SKU: ${item.sku || 'N/A'}</span>
                        </td>
                        <td style="padding: 8px; text-align: center; border-right: 1px solid #000; border-bottom: 1px solid #000;">Pcs</td>
                        <td style="padding: 8px; text-align: right; border-right: 1px solid #000; border-bottom: 1px solid #000;">${itemQty}</td>
                        <td style="padding: 8px; text-align: right; border-right: 1px solid #000; border-bottom: 1px solid #000;">${itemPrice.toFixed(2)}</td>
                        <td style="padding: 8px; text-align: right; border-right: 1px solid #000; border-bottom: 1px solid #000;">${itemTotal.toFixed(2)}</td>
                        <td style="padding: 8px; text-align: center; border-right: 1px solid #000; border-bottom: 1px solid #000;">${vatStatus === 'Yes' ? vatRate : 0}%</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #000;">${itemVat.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            // Update summary
            document.getElementById('invSub').innerText = (txn.sub || 0).toFixed(2);
            document.getElementById('invTax').innerText = (txn.tax || 0).toFixed(2);
            document.getElementById('invTotal').innerText = (txn.total || 0).toFixed(2);
            document.getElementById('invTotalWords').innerText = numberToWords(Math.floor(txn.total || 0)) + ' Only';
            
            // Show discount if applicable
            const discountRow = document.getElementById('invDiscountRow');
            if(txn.discountPercent && txn.discountPercent > 0) {
                discountRow.style.display = 'table-row';
                document.getElementById('invDiscountPercent').innerText = txn.discountPercent.toFixed(1);
                document.getElementById('invDiscount').innerText = (txn.discount || 0).toFixed(2);
            } else {
                discountRow.style.display = 'none';
            }
            
            // Generate barcode (using first item's SKU)
            if(txn.items && txn.items.length > 0) {
                const barcodeText = txn.items[0].sku || txn.id.toString().slice(-8);
                document.getElementById('invBarcodeText').innerText = barcodeText;
                // Simple barcode visualization
                const barcodeSvg = document.getElementById('invBarcode');
                barcodeSvg.innerHTML = generateBarcodeDisplay(barcodeText);
            }
            
            // Try print, fallback to PDF for mobile apps
            setTimeout(() => {
                if(navigator.userAgent.toLowerCase().includes('twinr') || navigator.userAgent.toLowerCase().includes('mobile')) {
                    generateInvoicePDF(txn);
                } else {
                    window.print();
                }
            }, 200);
        }

        // Simple barcode display generator
        function generateBarcodeDisplay(text) {
            let svg = '<svg viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg">';
            svg += '<rect width="200" height="60" fill="white" stroke="black" stroke-width="1"/>';
            
            // Create pattern based on text
            let barPattern = '';
            for (let i = 0; i < text.length; i++) {
                const code = text.charCodeAt(i);
                barPattern += (code % 2 ? '█' : '░');
            }
            
            // Draw bars
            let x = 5;
            for (let i = 0; i < barPattern.length; i++) {
                const width = barPattern[i] === '█' ? 2.5 : 1.5;
                if (barPattern[i] === '█') {
                    svg += `<rect x="${x}" y="5" width="${width}" height="35" fill="black"/>`;
                }
                x += width + 0.5;
            }
            
            svg += `<text x="100" y="55" text-anchor="middle" font-size="10" font-family="Arial">${text}</text>`;
            svg += '</svg>';
            return svg;
        }

        // Generate Invoice as PDF (Mobile-friendly)
        function generateInvoicePDF(txn) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPos = 20;
                
                // Logo
                if(db.config.logo) {
                    try {
                        doc.addImage(db.config.logo, 'JPEG', 85, 10, 30, 30);
                        yPos = 45;
                    } catch(e) { }
                }
                
                // Header
                doc.setFontSize(16);
                doc.text(db.config.name, 14, yPos);
                doc.setFontSize(10);
                yPos += 7;
                doc.text(db.config.address, 14, yPos);
                yPos += 5;
                doc.text(db.config.phone, 14, yPos);
                yPos += 5;
                doc.text(`VAT: ${db.config.taxId}`, 14, yPos);
                
                // Invoice Details
                yPos += 10;
                doc.setFontSize(14);
                doc.text('INVOICE', 14, yPos);
                yPos += 7;
                doc.setFontSize(10);
                doc.text(`Invoice #: ${txn.id.toString().slice(-6)}`, 14, yPos);
                yPos += 5;
                doc.text(`Date: ${new Date(txn.date).toLocaleDateString()}`, 14, yPos);
                yPos += 5;
                doc.text(`Customer: ${txn.entityName}`, 14, yPos);
                
                // Items Table
                const tableData = txn.items.map((item, idx) => [
                    idx + 1,
                    item.name + (item.vatExempt ? ' [No VAT]' : ''),
                    item.qty,
                    item.retail.toFixed(2),
                    (item.qty * item.retail).toFixed(2)
                ]);
                
                doc.autoTable({
                    startY: yPos + 8,
                    head: [['SN', 'Description', 'Qty', 'Unit Price', 'Total']],
                    body: tableData,
                    theme: 'grid',
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [0, 200, 83], textColor: 255 }
                });
                
                yPos = doc.lastAutoTable.finalY + 10;
                
                // Totals
                doc.setFontSize(10);
                doc.text(`Subtotal: ${db.config.currency}${(txn.sub).toFixed(2)}`, 140, yPos);
                yPos += 5;
                
                if(txn.discountPercent && txn.discountPercent > 0) {
                    doc.text(`Discount (${txn.discountPercent}%): -${db.config.currency}${(txn.discount).toFixed(2)}`, 140, yPos);
                    yPos += 5;
                }
                
                doc.setFont(undefined, 'bold');
                doc.text(`VAT (${db.config.vatRate}%): ${db.config.currency}${(txn.tax).toFixed(2)}`, 140, yPos);
                yPos += 7;
                doc.setFontSize(12);
                doc.text(`TOTAL: ${db.config.currency}${(txn.total).toFixed(2)}`, 140, yPos);
                
                // Footer
                yPos += 15;
                doc.setFontSize(8);
                doc.text('Thank you for your business!', 105, yPos, { align: 'center' });
                yPos += 4;
                doc.text('Generated by KARTA System', 105, yPos, { align: 'center' });
                
                // Save or Open
                const filename = `Invoice_${txn.id.toString().slice(-6)}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                alert(`Invoice saved: ${filename}`);
            } catch(err) {
                console.error('PDF generation failed:', err);
                alert('PDF generation failed. Please try again.');
            }
        }

        // --- Debtors Report Filter ---
        window.filterDebtorsReport = function() {
            const searchLocation = document.getElementById('debtorLocationSearch').value.toLowerCase();
            const tbody = document.getElementById('repTable');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const locationCell = row.cells[1];
                const location = locationCell ? locationCell.textContent.toLowerCase() : '';
                
                if (searchLocation === '' || location.includes(searchLocation)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        };

        // --- Report Printing ---
        window.printReport = function() {
            // HIDE INVOICE VIEW, SHOW REPORT VIEW
            document.getElementById('invoice-print-view').classList.add('hidden');
            const reportView = document.getElementById('report-print-view');
            reportView.classList.remove('hidden');

            // GENERATE MINIMAL & ATTRACTIVE REPORT
            let logoHtml = '';
            if(db.config.logo) {
                logoHtml = `<img src="${db.config.logo}" style="width: 80px; height: 80px; object-fit: contain; margin: 0 auto 15px;">`;
            }

            let html = `
                <div style="text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #ddd;">
                    ${logoHtml}
                    <h1 style="font-size: 22px; font-weight: 700; margin: 0; color: #222;">${db.config.name}</h1>
                    <p style="margin: 5px 0 0 0; font-size: 11px; color: #999;">${db.config.address} • ${db.config.phone}</p>
                    <p style="margin: 2px 0 0 0; font-size: 10px; color: #bbb;">VAT ID: ${db.config.taxId || 'N/A'}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h2 style="font-size: 16px; font-weight: 600; margin: 0 0 5px 0; color: #222;">${currentReportTitle}</h2>
                    <p style="font-size: 10px; color: #999; margin: 0;">${new Date().toLocaleDateString()} • ${currentReportData.length} records</p>
                </div>
            `;

            // Table Construction
            if(currentReportTitle.includes("Balance Sheet")) {
                const stockVal = db.products.reduce((a,c) => a + (c.stock * c.cost), 0);
                const receivables = db.customers.reduce((a,c) => a + c.balance, 0);
                const payables = db.suppliers.reduce((a,c) => a + c.balance, 0);
                const salesCash = db.transactions.filter(t => t.type === 'sale' && t.payType !== 'credit').reduce((a,c) => a + c.total, 0);
                const custPayments = db.transactions.filter(t => t.type === 'payment' && !t.isReturn).reduce((a,c) => a + c.total, 0);
                const supReturnsCash = db.transactions.filter(t => (t.type === 'payment' || t.type === 'return_cash_in') && t.isReturn).reduce((a,c) => a + c.total, 0);
                const cashIn = salesCash + custPayments + supReturnsCash;
                const cashOut = db.transactions.filter(t => (t.type === 'expense') || (t.type === 'purchase' && t.payType === 'cash') || (t.type === 'payment_out')).reduce((a,c) => a + c.total, 0);
                const openingBalance = db.config.initialCash || 0;
                const cashHand = moneyRound(openingBalance + cashIn - cashOut);
                const assets = stockVal + receivables + cashHand;
                const equity = assets - payables;

                html += `<table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                    <tbody>
                        <tr style="font-weight: 600; border-bottom: 1px solid #ddd;"><td style="padding: 8px;">ASSETS</td><td style="text-align: right; padding: 8px;"></td></tr>
                        <tr style="border-bottom: 1px solid #f0f0f0;"><td style="padding: 8px; color: #666;">Stock Value</td><td style="text-align: right; padding: 8px;">${db.config.currency}${stockVal.toFixed(2)}</td></tr>
                        <tr style="border-bottom: 1px solid #f0f0f0;"><td style="padding: 8px; color: #666;">Receivables</td><td style="text-align: right; padding: 8px;">${db.config.currency}${receivables.toFixed(2)}</td></tr>
                        <tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px; color: #666;">Cash on Hand</td><td style="text-align: right; padding: 8px;">${db.config.currency}${cashHand.toFixed(2)}</td></tr>
                        <tr style="font-weight: 600; border-bottom: 1px solid #ddd;"><td style="padding: 8px;">Total Assets</td><td style="text-align: right; padding: 8px; color: #00c853;">${db.config.currency}${assets.toFixed(2)}</td></tr>
                        <tr style="font-weight: 600; border-bottom: 1px solid #ddd;"><td style="padding: 8px;">Payables</td><td style="text-align: right; padding: 8px;">${db.config.currency}${payables.toFixed(2)}</td></tr>
                        <tr style="font-weight: 600;"><td style="padding: 8px;">Net Equity</td><td style="text-align: right; padding: 8px; color: #00c853; font-size: 12px;">${db.config.currency}${equity.toFixed(2)}</td></tr>
                    </tbody>
                </table>`;
            } else {
                // Standard reports
                html += `<table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                    <thead>
                        <tr style="border-bottom: 1px solid #ddd; font-weight: 600; color: #666;">`;
                
                if(currentReportTitle.includes("VAT")) {
                    html += `<th style="padding: 8px; text-align: left;">Date</th>
                             <th style="padding: 8px; text-align: left;">Invoice</th>
                             <th style="padding: 8px; text-align: right;">Taxable</th>
                             <th style="padding: 8px; text-align: right; color: #00c853;">VAT</th>
                             <th style="padding: 8px; text-align: right;">Total</th></tr></thead><tbody>`;
                    currentReportData.forEach(t => {
                       html += `<tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 8px;">${new Date(t.date).toLocaleDateString()}</td>
                            <td style="padding: 8px;">#${t.id.toString().slice(-6)}</td>
                            <td style="padding: 8px; text-align: right;">${db.config.currency}${(t.sub||0).toFixed(2)}</td>
                            <td style="padding: 8px; text-align: right; color: #00c853; font-weight: 500;">${db.config.currency}${(t.tax||0).toFixed(2)}</td>
                            <td style="padding: 8px; text-align: right;">${db.config.currency}${t.total.toFixed(2)}</td>
                       </tr>`; 
                    });
                } else if (currentReportTitle.includes("DEBTOR")) {
                    // DEBTORS REPORT - Different table structure
                    // Filter debtors by location (area) if search field has value
                    const searchLocation = document.getElementById('debtorLocationSearch')?.value.toLowerCase() || '';
                    let filteredDebtors = currentReportData;
                    
                    if (searchLocation) {
                        filteredDebtors = currentReportData.filter(d => 
                            (d.address || '').toLowerCase().includes(searchLocation)
                        );
                    }
                    
                    html += `<th style="padding: 8px; text-align: left;">Customer Name</th>
                             <th style="padding: 8px; text-align: left;">Location</th>
                             <th style="padding: 8px; text-align: left;">Phone</th>
                             <th style="padding: 8px; text-align: right;">Amount Due</th></tr></thead><tbody>`;
                    
                    filteredDebtors.forEach(debtor => {
                       const balance = (debtor && debtor.balance !== undefined) ? debtor.balance : 0;
                       html += `<tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 8px; font-weight: 500;">${debtor.name}</td>
                            <td style="padding: 8px; color: #666;">${debtor.address || 'N/A'}</td>
                            <td style="padding: 8px; color: #666;">${debtor.phone}</td>
                            <td style="padding: 8px; text-align: right; font-weight: 500; color: #d32f2f;">${db.config.currency}${balance.toFixed(2)}</td>
                       </tr>`; 
                    });
                    
                    // Update total to only include filtered debtors
                    currentReportData = filteredDebtors;
                } else if (currentReportTitle.includes("PURCHASE")) {
                    // PURCHASE REPORT WITH DETAILED INVOICE FORMAT
                    html += `<th style="padding: 8px; text-align: left;">Date</th>
                             <th style="padding: 8px; text-align: left;">GRN #</th>
                             <th style="padding: 8px; text-align: left;">Supplier</th>
                             <th style="padding: 8px; text-align: left;">Item Details</th>
                             <th style="padding: 8px; text-align: center;">Qty</th>
                             <th style="padding: 8px; text-align: right;">Unit Price</th>
                             <th style="padding: 8px; text-align: right;">Line Total</th>
                             <th style="padding: 8px; text-align: right;">Grand Total</th>
                             <th style="padding: 8px; text-align: center;">Payment</th></tr></thead><tbody>`;
                    
                    if(currentReportData && currentReportData.length > 0) {
                        currentReportData.forEach(t => {
                            if(t.items && t.items.length > 0) {
                                let firstRow = true;
                                t.items.forEach((item, idx) => {
                                    const itemCost = item.cost || 0;
                                    const lineTotal = moneyRound((item.qty || 1) * itemCost);
                                    
                                    if(firstRow) {
                                        html += `<tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 8px;">${new Date(t.date).toLocaleDateString()}</td>
                                            <td style="padding: 8px; font-weight: 600;">#${t.id.toString().slice(-6)}</td>
                                            <td style="padding: 8px; font-weight: 500;">${t.entityName || '-'}</td>
                                            <td style="padding: 8px; color: #666;">${item.name || '-'}</td>
                                            <td style="padding: 8px; text-align: center; font-weight: 500;">${item.qty || 1}</td>
                                            <td style="padding: 8px; text-align: right;">${db.config.currency}${itemCost.toFixed(2)}</td>
                                            <td style="padding: 8px; text-align: right; color: #00c853; font-weight: 500;">${db.config.currency}${lineTotal.toFixed(2)}</td>
                                            <td style="padding: 8px; text-align: right; font-weight: 600; color: #0066cc;">${db.config.currency}${t.total.toFixed(2)}</td>
                                            <td style="padding: 8px; text-align: center; font-size: 10px; font-weight: 500; color: ${t.payType === 'credit' ? '#ff6600' : '#00aa00'};">${t.payType ? t.payType.toUpperCase() : 'CASH'}</td>
                                        </tr>`;
                                        firstRow = false;
                                    } else {
                                        html += `<tr style="border-bottom: 1px solid #f0f0f0; background-color: #f9f9f9;">
                                            <td colspan="2"></td>
                                            <td></td>
                                            <td style="padding: 8px; color: #666;">${item.name || '-'}</td>
                                            <td style="padding: 8px; text-align: center; font-weight: 500;">${item.qty || 1}</td>
                                            <td style="padding: 8px; text-align: right;">${db.config.currency}${itemCost.toFixed(2)}</td>
                                            <td style="padding: 8px; text-align: right; color: #00c853; font-weight: 500;">${db.config.currency}${lineTotal.toFixed(2)}</td>
                                            <td colspan="2"></td>
                                        </tr>`;
                                    }
                                });
                            } else {
                                html += `<tr style="border-bottom: 1px solid #f0f0f0;">
                                    <td style="padding: 8px;">${new Date(t.date).toLocaleDateString()}</td>
                                    <td style="padding: 8px; font-weight: 600;">#${t.id.toString().slice(-6)}</td>
                                    <td style="padding: 8px; font-weight: 500;">${t.entityName || '-'}</td>
                                    <td colspan="4" style="padding: 8px; color: #999;">-</td>
                                    <td style="padding: 8px; text-align: right; font-weight: 600; color: #0066cc;">${db.config.currency}${t.total.toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: center; font-size: 10px; font-weight: 500; color: ${t.payType === 'credit' ? '#ff6600' : '#00aa00'};">${t.payType ? t.payType.toUpperCase() : 'CASH'}</td>
                                </tr>`;
                            }
                        });
                    } else {
                        html += `<tr><td colspan="9" style="padding: 15px; text-align: center; color: #999;">No purchase records found for the selected date range</td></tr>`;
                    }
                } else {
                    // GENERIC TRANSACTION REPORTS (Daily, Sales, Expense)
                    html += `<th style="padding: 8px; text-align: left;">Date</th>
                             <th style="padding: 8px; text-align: left;">Type</th>
                             <th style="padding: 8px; text-align: left;">Description</th>
                             <th style="padding: 8px; text-align: right;">Amount</th></tr></thead><tbody>`;
                    
                    if(currentReportData && currentReportData.length > 0) {
                        currentReportData.forEach(t => {
                           const typeColor = t.type === 'sale' ? '#0066cc' : (t.type === 'purchase' ? '#ff6600' : (t.type === 'expense' ? '#cc0000' : '#666666'));
                           const description = t.entityName || t.items?.[0]?.name || '-';
                           html += `<tr style="border-bottom: 1px solid #f0f0f0;">
                                <td style="padding: 8px;">${new Date(t.date).toLocaleDateString()}</td>
                                <td style="padding: 8px; text-transform: uppercase; font-weight: 500; font-size: 10px; color: ${typeColor};">${t.type}</td>
                                <td style="padding: 8px; color: #666;">${description}</td>
                                <td style="padding: 8px; text-align: right; font-weight: 500;">${db.config.currency}${t.total.toFixed(2)}</td>
                           </tr>`; 
                        });
                    } else {
                        html += `<tr><td colspan="4" style="padding: 15px; text-align: center; color: #999;">No records found for the selected date range</td></tr>`;
                    }
                }
                
                html += `</tbody></table>`;
                
                // Summary Footer - Minimal
                let total = 0;
                if (currentReportTitle.includes("DEBTOR")) {
                    total = currentReportData.reduce((a,c) => a + c.balance, 0);
                } else {
                    total = currentReportData.reduce((a,c) => a + c.total, 0);
                }
                let footerHtml = '';
                
                if (currentReportTitle.includes("VAT")) {
                    const totalVat = currentReportData.reduce((a,c) => a + (c.tax || 0), 0);
                    const totalTaxable = currentReportData.reduce((a,c) => a + (c.sub || 0), 0);
                    footerHtml = `<div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd; text-align: right; font-size: 12px;">
                        <p style="margin: 3px 0; color: #666;">Taxable: <strong>${db.config.currency}${totalTaxable.toFixed(2)}</strong></p>
                        <p style="margin: 3px 0; color: #00c853;">VAT: <strong>${db.config.currency}${totalVat.toFixed(2)}</strong></p>
                        <p style="margin: 5px 0 0 0; font-weight: 700; font-size: 13px;">Total: ${db.config.currency}${total.toFixed(2)}</p>
                    </div>`;
                } else {
                    footerHtml = `<div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd; text-align: right; font-size: 12px; font-weight: 700;">
                        Total: ${db.config.currency}${total.toFixed(2)}
                    </div>`;
                }
                html += footerHtml;
            }

            // Minimal Footer
            html += `<div style="margin-top: 30px; padding-top: 10px; border-top: 1px solid #eee; text-align: center; font-size: 8px; color: #bbb;">
                Generated by KARTA • ${new Date().toLocaleString()}
            </div>`;

            reportView.innerHTML = html;
            
            // Try print, fallback to PDF for mobile apps
            setTimeout(() => {
                if(navigator.userAgent.toLowerCase().includes('twinr') || navigator.userAgent.toLowerCase().includes('mobile')) {
                    generateReportPDF(html);
                } else {
                    window.print();
                }
            }, 200);
        }

        // Generate Report as PDF (Mobile-friendly)
        function generateReportPDF(htmlContent) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Convert HTML to text-based layout
                let yPos = 20;
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 14;
                const maxWidth = pageWidth - (2 * margin);
                
                // Extract text from HTML and add to PDF
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                
                // Add logo if exists
                if(db.config.logo) {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const img = new Image();
                        img.onload = function() {
                            doc.addImage(img, 'JPEG', margin + (maxWidth/2) - 30, yPos, 60, 60);
                        };
                        img.src = db.config.logo;
                        yPos = 75;
                    } catch(e) { }
                }
                
                // Title
                doc.setFontSize(14);
                doc.text(db.config.name, pageWidth/2, yPos, { align: 'center' });
                yPos += 6;
                
                doc.setFontSize(9);
                doc.text(db.config.address + ' • ' + db.config.phone, pageWidth/2, yPos, { align: 'center' });
                yPos += 5;
                doc.text('VAT ID: ' + (db.config.taxId || 'N/A'), pageWidth/2, yPos, { align: 'center' });
                yPos += 10;
                
                // Report Title
                doc.setFontSize(12);
                doc.text(currentReportTitle, margin, yPos);
                yPos += 6;
                
                doc.setFontSize(8);
                doc.text(new Date().toLocaleString(), margin, yPos);
                yPos += 10;
                
                // Build table from data
                const tableData = [];
                if(currentReportTitle.includes("VAT")) {
                    tableData.push(['Date', 'Invoice', 'Taxable', 'VAT', 'Total']);
                    currentReportData.forEach(t => {
                        tableData.push([
                            new Date(t.date).toLocaleDateString(),
                            '#' + t.id.toString().slice(-6),
                            db.config.currency + (t.sub||0).toFixed(2),
                            db.config.currency + (t.tax||0).toFixed(2),
                            db.config.currency + t.total.toFixed(2)
                        ]);
                    });
                } else {
                    tableData.push(['Date', 'Type', 'Reference', 'Amount']);
                    currentReportData.forEach(t => {
                        tableData.push([
                            new Date(t.date).toLocaleDateString(),
                            t.type.toUpperCase(),
                            t.entityName || '-',
                            db.config.currency + t.total.toFixed(2)
                        ]);
                    });
                }
                
                // Add table
                doc.autoTable({
                    startY: yPos,
                    head: [tableData[0]],
                    body: tableData.slice(1),
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [0, 200, 83], textColor: 255 },
                    columnStyles: { 3: { halign: 'right' }, 4: { halign: 'right' } }
                });
                
                // Footer
                yPos = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(7);
                doc.text('Generated by KARTA System • ' + new Date().toLocaleString(), pageWidth/2, yPos, { align: 'center' });
                
                // Save
                const filename = `Report_${currentReportTitle.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                alert(`Report saved: ${filename}`);
            } catch(err) {
                console.error('PDF generation failed:', err);
                // Fallback: try to print anyway
                try {
                    window.print();
                } catch(e2) {
                    alert('Print/PDF generation not supported on this device.');
                }
            }
        }


        // --- Settings ---
        // Logo Handling
        document.getElementById('confLogoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    tempLogoBase64 = evt.target.result;
                    document.getElementById('confLogoPreview').src = tempLogoBase64;
                    document.getElementById('confLogoPreview').classList.remove('hidden');
                    document.getElementById('confLogoPlaceholder').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        window.clearLogo = function() {
            tempLogoBase64 = ''; // Empty string triggers removal
            document.getElementById('confLogoInput').value = '';
            document.getElementById('confLogoPreview').src = '';
            document.getElementById('confLogoPreview').classList.add('hidden');
            document.getElementById('confLogoPlaceholder').classList.remove('hidden');
        }

        document.getElementById('settingsForm').onsubmit = e => {
            e.preventDefault();
            db.config.name = document.getElementById('confName').value;
            db.config.address = document.getElementById('confAddr').value;
            db.config.phone = document.getElementById('confPhone').value;
            db.config.taxId = document.getElementById('confTax').value;
            db.config.vatRate = parseFloat(document.getElementById('confVatRate').value);
            db.config.currency = document.getElementById('confCurr').value;
            // FIX #5: EMPTY REGISTER - Add opening balance
            db.config.initialCash = moneyRound(parseFloat(document.getElementById('confInitialCash').value) || 0);

            // Save Logo if changed
            if(tempLogoBase64 !== null) {
                db.config.logo = tempLogoBase64;
            }

            saveDB();
            alert("Settings Saved");
        };

        function loadSettings() {
            document.getElementById('confName').value = db.config.name;
            document.getElementById('confAddr').value = db.config.address;
            document.getElementById('confPhone').value = db.config.phone;
            document.getElementById('confTax').value = db.config.taxId;
            document.getElementById('confVatRate').value = db.config.vatRate;
            document.getElementById('confCurr').value = db.config.currency;
            // FIX #5: EMPTY REGISTER - Load opening balance
            document.getElementById('confInitialCash').value = (db.config.initialCash || 0).toFixed(2);

            // Load Logo
            if(db.config.logo) {
                document.getElementById('confLogoPreview').src = db.config.logo;
                document.getElementById('confLogoPreview').classList.remove('hidden');
                document.getElementById('confLogoPlaceholder').classList.add('hidden');
                tempLogoBase64 = db.config.logo; // Initialize temp to current
            } else {
                clearLogo();
                tempLogoBase64 = null; // Reset temp
            }
        }

        // --- Reports Export Logic ---
        window.exportReportCSV = function() {
            if(!currentReportData || !currentReportData.length) {
                alert("No report data to export. Please run a report first.");
                return;
            }
            
            // Define CSV Header
            const headers = ["Date", "Type", "Entity/Ref", "Amount"];
            const rows = [headers];
            
            // Add Data Rows
            currentReportData.forEach(t => {
                rows.push([
                    new Date(t.date).toLocaleDateString(),
                    t.type,
                    t.entityName || '-',
                    t.total.toFixed(2)
                ]);
            });
            
            // Convert to CSV String
            const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
            
            // Trigger Download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "karta_report_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Reports ---
        window.runReports = function(type) {
            const tbody = document.getElementById('repTable');
            const thead = document.getElementById('repHead');
            const cards = document.getElementById('reportCards');
            tbody.innerHTML = ''; cards.innerHTML = '';
            
            // Hide location search filter by default (only show for debtors)
            const debtorFilterContainer = document.getElementById('debtorFilterContainer');
            if (type !== 'debtors') {
                debtorFilterContainer.classList.add('hidden');
            }
            
            const fromDate = document.getElementById('repFrom').value;
            const toDate = document.getElementById('repTo').value;

            // Filter transactions by date
            // FIX: Ensure transactions exists
            if(!db.transactions) db.transactions = [];
            
            let filteredTxns = db.transactions.slice().reverse();
            if(fromDate) filteredTxns = filteredTxns.filter(t => t.date.substring(0,10) >= fromDate);
            if(toDate) filteredTxns = filteredTxns.filter(t => t.date.substring(0,10) <= toDate);

            // Set Title
            currentReportTitle = type.toUpperCase() + " REPORT";
            document.getElementById('reportTitle').innerText = currentReportTitle;

            // Helper to create card
            const createCard = (title, value, color='white') => {
                return `<div class="bg-karta-surface border border-karta-border p-6 rounded-lg"><h4 class="text-gray-400 text-xs uppercase">${title}</h4><h2 class="text-2xl font-bold text-${color} mt-2">${db.config.currency}${value.toFixed(2)}</h2></div>`;
            };

            if(type === 'trading') {
                currentReportData = []; 
                const sales = filteredTxns.filter(t => t.type === 'sale').reduce((a,c)=>a+c.total, 0);
                const purchases = filteredTxns.filter(t => t.type === 'purchase').reduce((a,c)=>a+c.total, 0);
                
                // FIX #6: Use STORED cost from transaction items, not current product cost
                let cogs = 0;
                filteredTxns.filter(t => t.type === 'sale' && !t.isReturn).forEach(t => {
                    t.items.forEach(i => {
                        // Use stored cost if available, otherwise fallback to current product cost
                        const itemCost = i.cost !== undefined ? i.cost : (db.products.find(x => x.name === i.name)?.cost || 0);
                        cogs += moneyRound(itemCost * (i.qty || 1));
                    });
                });
                const grossProfit = moneyRound(sales - cogs);
                cards.innerHTML += createCard('Total Sales (Net)', sales, 'green-400');
                cards.innerHTML += createCard('COGS', Math.abs(cogs), 'red-400');
                cards.innerHTML += createCard('Gross Profit', grossProfit, 'karta-primary');
                thead.innerHTML = `<tr><th class="p-3">Metric</th><th class="p-3 text-right">Amount</th></tr>`;
                tbody.innerHTML += `<tr><td class="p-3">Sales Revenue (Net of Returns)</td><td class="p-3 text-right">${db.config.currency}${sales.toFixed(2)}</td></tr>`;
                tbody.innerHTML += `<tr><td class="p-3">Less: Cost of Goods Sold</td><td class="p-3 text-right text-red-400">(${db.config.currency}${Math.abs(cogs).toFixed(2)})</td></tr>`;
                tbody.innerHTML += `<tr class="font-bold border-t border-gray-700"><td class="p-3">Gross Profit</td><td class="p-3 text-right text-karta-primary">${db.config.currency}${grossProfit.toFixed(2)}</td></tr>`;
                return;
            }

            if(type === 'balance') {
                currentReportData = []; 
                currentReportTitle = "Balance Sheet";
                document.getElementById('reportTitle').innerText = currentReportTitle;
                
                const stockVal = db.products.reduce((a,c) => a + (c.stock * c.cost), 0);
                const receivables = db.customers.reduce((a,c) => a + c.balance, 0);
                const payables = db.suppliers.reduce((a,c) => a + c.balance, 0);
                
                // Cash In: Sales (cash only) + Customer Payments + Supplier Returns (cash)
                const salesCash = db.transactions.filter(t => t.type === 'sale' && t.payType !== 'credit').reduce((a,c) => a + c.total, 0);
                const custPayments = db.transactions.filter(t => t.type === 'payment' && !t.isReturn).reduce((a,c) => a + c.total, 0);
                const supReturnsCash = db.transactions.filter(t => (t.type === 'payment' || t.type === 'return_cash_in') && t.isReturn).reduce((a,c) => a + c.total, 0);
                const cashIn = salesCash + custPayments + supReturnsCash;
                
                // Cash Out: Expenses + Cash Purchases + Supplier Payments (payment_out)
                const cashOut = db.transactions.filter(t => (t.type === 'expense') || (t.type === 'purchase' && t.payType === 'cash') || (t.type === 'payment_out')).reduce((a,c) => a + c.total, 0);
                
                // FIX #5: EMPTY REGISTER - Include opening balance in calculation
                const openingBalance = db.config.initialCash || 0;
                const cashHand = moneyRound(openingBalance + cashIn - cashOut);
                const assets = stockVal + receivables + cashHand;
                const equity = assets - payables;
                
                cards.innerHTML += createCard('Total Assets', assets, 'blue-400');
                cards.innerHTML += createCard('Liabilities', payables, 'red-400');
                cards.innerHTML += createCard('Equity', equity, 'green-400');
                
                thead.innerHTML = `<tr><th class="p-3">Category</th><th class="p-3 text-right">Amount</th></tr>`;
                tbody.innerHTML += `<tr class="bg-gray-800"><td class="p-3 font-bold" colspan="2">Assets</td></tr>`;
                tbody.innerHTML += `<tr><td class="p-3">Current Stock</td><td class="p-3 text-right">${db.config.currency}${stockVal.toFixed(2)}</td></tr>`;
                tbody.innerHTML += `<tr><td class="p-3">Accounts Receivable</td><td class="p-3 text-right">${db.config.currency}${receivables.toFixed(2)}</td></tr>`;
                tbody.innerHTML += `<tr><td class="p-3 text-xs text-gray-500">  - Sales (Cash)</td><td class="p-3 text-right text-xs text-gray-500">${db.config.currency}${salesCash.toFixed(2)}</td></tr>`;
                tbody.innerHTML += `<tr><td class="p-3 text-xs text-gray-500">  - Customer Payments</td><td class="p-3 text-right text-xs text-gray-500">${db.config.currency}${custPayments.toFixed(2)}</td></tr>`;
                tbody.innerHTML += `<tr><td class="p-3 text-xs text-gray-500">  - Supplier Returns (Cash)</td><td class="p-3 text-right text-xs text-gray-500">${db.config.currency}${supReturnsCash.toFixed(2)}</td></tr>`;
                tbody.innerHTML += `<tr><td class="p-3 font-bold">Cash/Bank (Est.)</td><td class="p-3 text-right font-bold">${db.config.currency}${cashHand.toFixed(2)}</td></tr>`;
                tbody.innerHTML += `<tr class="bg-gray-800"><td class="p-3 font-bold" colspan="2">Liabilities</td></tr>`;
                tbody.innerHTML += `<tr><td class="p-3">Accounts Payable</td><td class="p-3 text-right">${db.config.currency}${payables.toFixed(2)}</td></tr>`;
                return;
            }

            // --- DEBTORS REPORT ---
            if(type === 'debtors') {
                const debtorFilterContainer = document.getElementById('debtorFilterContainer');
                debtorFilterContainer.classList.remove('hidden');
                
                const allDebtors = db.customers.filter(c => c.balance > 0);
                currentReportData = allDebtors;
                
                let totalDebtAmount = 0;
                allDebtors.forEach(d => totalDebtAmount += d.balance);
                
                // Create custom card for count (doesn't need currency prefix)
                cards.innerHTML += `<div class="bg-karta-surface border border-karta-border p-6 rounded-lg"><h4 class="text-gray-400 text-xs uppercase">Total Debtors</h4><h2 class="text-2xl font-bold text-white mt-2">${allDebtors.length}</h2></div>`;
                cards.innerHTML += createCard('Total Amount Due', totalDebtAmount, 'red-400');
                cards.innerHTML += createCard('Average Debt', (totalDebtAmount / (allDebtors.length || 1)), 'yellow-400');
                
                thead.innerHTML = `<tr>
                    <th class="p-3">Customer Name</th>
                    <th class="p-3">Location</th>
                    <th class="p-3">Phone</th>
                    <th class="p-3 text-right">Amount Due</th>
                    <th class="p-3 text-right">Credit Limit</th>
                </tr>`;
                
                allDebtors.forEach(debtor => {
                    tbody.innerHTML += `<tr class="hover:bg-white/5">
                        <td class="p-3 font-bold text-white">${debtor.name}</td>
                        <td class="p-3 text-gray-400">${debtor.address || 'N/A'}</td>
                        <td class="p-3 text-gray-400">${debtor.phone}</td>
                        <td class="p-3 text-right font-bold text-red-400">${db.config.currency}${debtor.balance.toFixed(2)}</td>
                        <td class="p-3 text-right text-gray-400">${db.config.currency}${(debtor.limit || 0).toFixed(2)}</td>
                    </tr>`;
                });
                return;
            }

            // --- VAT REPORT LOGIC ---
            if(type === 'vat') {
                const sales = filteredTxns.filter(t => t.type === 'sale');
                
                // Calculate taxable amount (excluding VAT exempt items)
                let totalTaxable = 0;
                let totalVatExempt = 0;
                let totalVat = 0;
                
                sales.forEach(t => {
                    let txnTaxable = 0;
                    let txnExempt = 0;
                    
                    // Calculate taxable and exempt amounts per transaction
                    if(t.items && Array.isArray(t.items)) {
                        const priceType = t.priceType || 'retail';
                        t.items.forEach(item => {
                            const price = priceType === 'wholesale' ? (item.wholesale || item.retail) : item.retail;
                            const itemTotal = item.qty * price;
                            
                            if(item.vatExempt) {
                                txnExempt += itemTotal;
                            } else {
                                txnTaxable += itemTotal;
                            }
                        });
                    } else {
                        // Fallback for old transactions without item-level VAT data
                        txnTaxable = t.sub || 0;
                    }
                    
                    // Apply discount proportionally to taxable amount
                    const discount = t.discountPercent ? (txnTaxable * (t.discountPercent / 100)) : 0;
                    const taxableAfterDiscount = moneyRound(txnTaxable - discount);
                    
                    totalTaxable = moneyRound(totalTaxable + taxableAfterDiscount);
                    totalVatExempt = moneyRound(totalVatExempt + txnExempt);
                    
                    // Calculate VAT on taxable items only
                    const txnVat = moneyRound(taxableAfterDiscount * (db.config.vatRate / 100));
                    totalVat = moneyRound(totalVat + txnVat);
                });
                
                const totalWithVat = moneyRound(totalTaxable + totalVatExempt + totalVat);

                cards.innerHTML += createCard('Taxable Sales', totalTaxable, 'white');
                cards.innerHTML += createCard('VAT Exempt Items', totalVatExempt, 'yellow-400');
                cards.innerHTML += createCard('Total VAT Collected', totalVat, 'karta-primary');
                cards.innerHTML += createCard('Grand Total', totalWithVat, 'green-400');

                thead.innerHTML = `<tr><th class="p-3">Date</th><th class="p-3">Invoice #</th><th class="p-3">Type</th><th class="p-3 text-right">Taxable</th><th class="p-3 text-right">Exempt</th><th class="p-3 text-right">VAT</th><th class="p-3 text-right">Total</th></tr>`;
                
                sales.forEach(t => {
                    let txnTaxable = 0;
                    let txnExempt = 0;
                    
                    // Calculate per transaction
                    if(t.items && Array.isArray(t.items)) {
                        const priceType = t.priceType || 'retail';
                        t.items.forEach(item => {
                            const price = priceType === 'wholesale' ? (item.wholesale || item.retail) : item.retail;
                            const itemTotal = item.qty * price;
                            
                            if(item.vatExempt) {
                                txnExempt += itemTotal;
                            } else {
                                txnTaxable += itemTotal;
                            }
                        });
                    } else {
                        txnTaxable = t.sub || 0;
                    }
                    
                    const discount = t.discountPercent ? (txnTaxable * (t.discountPercent / 100)) : 0;
                    const taxableAfterDiscount = moneyRound(txnTaxable - discount);
                    const txnVat = moneyRound(taxableAfterDiscount * (db.config.vatRate / 100));
                    const txnTotal = moneyRound(taxableAfterDiscount + txnExempt + txnVat);
                    
                    const tr = document.createElement('tr');
                    const isReturn = t.isReturn ? ' bg-red-900/20' : '';
                    const typeLabel = t.isReturn ? 'RETURN' : 'SALE';
                    tr.className = `border-b border-gray-800 text-gray-300${isReturn}`;
                    tr.innerHTML = `
                        <td class="p-3">${new Date(t.date).toLocaleDateString()}</td>
                        <td class="p-3 font-mono text-xs">#${t.id.toString().slice(-6)}</td>
                        <td class="p-3 text-xs font-bold ${t.isReturn ? 'text-red-400' : 'text-green-400'}">${typeLabel}</td>
                        <td class="p-3 text-right">${db.config.currency}${taxableAfterDiscount.toFixed(2)}</td>
                        <td class="p-3 text-right ${txnExempt > 0 ? 'text-yellow-400 font-bold' : ''}">${db.config.currency}${txnExempt.toFixed(2)}</td>
                        <td class="p-3 text-right text-karta-primary font-bold">${db.config.currency}${txnVat.toFixed(2)}</td>
                        <td class="p-3 text-right ${txnTotal < 0 ? 'text-red-400' : 'text-green-400'}">${db.config.currency}${txnTotal.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });
                currentReportData = sales;
                return;
            }

            // Standard Transaction Reports (Daily, Sales, Purchase, Expense)
            
            // Map 'sales' string to 'sale' database type
            let dbType = type;
            if(type === 'sales') dbType = 'sale'; 
            
            let total = 0;
            let reportTxns = [];

            if(type === 'daily') {
                reportTxns = filteredTxns; // Show all for daily
                thead.innerHTML = `<tr><th class="p-3">Date</th><th class="p-3">Type</th><th class="p-3">Details</th><th class="p-3 text-right">Amount</th></tr>`;
                reportTxns.forEach(t => {
                    const tr = document.createElement('tr');
                    let bgClass = '';
                    let color = 'text-green-500';
                    if(t.type === 'expense') color = 'text-red-500';
                    if(t.isReturn) { color = 'text-orange-500'; bgClass = ' bg-red-900/20'; }
                    tr.className = `border-b border-gray-800 text-gray-300${bgClass}`;
                    let typeLabel = t.type.toUpperCase();
                    if(t.isReturn) typeLabel += ' (RETURN)';
                    tr.innerHTML = `<td class="p-3">${new Date(t.date).toLocaleDateString()}</td><td class="p-3 uppercase text-xs font-bold">${typeLabel}</td><td class="p-3">${t.entityName || t.items[0]?.name || '-'}</td><td class="p-3 text-right ${color}">${db.config.currency}${t.total.toFixed(2)}</td>`;
                    tbody.appendChild(tr);
                });
                // Summary for daily
                const dSales = reportTxns.filter(t => t.type === 'sale').reduce((a,c)=>a+c.total,0);
                const dExp = reportTxns.filter(t => t.type === 'expense').reduce((a,c)=>a+c.total,0);
                cards.innerHTML += createCard('Sales (Net)', dSales, 'green-400');
                cards.innerHTML += createCard('Expenses', dExp, 'red-400');
                cards.innerHTML += createCard('Net', dSales - dExp, 'white');
            } else if(type === 'purchase') {
                // PURCHASE REPORT WITH DETAILED INVOICE INFORMATION
                reportTxns = filteredTxns.filter(t => t.type === dbType);
                
                // Summary Card
                let purchaseTotal = 0;
                let itemCount = 0;
                reportTxns.forEach(t => {
                    purchaseTotal += t.total;
                    if(t.items) itemCount += t.items.length;
                });
                cards.innerHTML += createCard('Total Purchases', purchaseTotal, 'karta-primary');
                cards.innerHTML += `<div class="bg-karta-surface border border-karta-border p-6 rounded-lg"><h4 class="text-gray-400 text-xs uppercase">Total Items Purchased</h4><h2 class="text-2xl font-bold text-white mt-2">${itemCount}</h2></div>`;
                cards.innerHTML += `<div class="bg-karta-surface border border-karta-border p-6 rounded-lg"><h4 class="text-gray-400 text-xs uppercase">Number of GRNs</h4><h2 class="text-2xl font-bold text-white mt-2">${reportTxns.length}</h2></div>`;
                
                // Detailed Header
                thead.innerHTML = `<tr>
                    <th class="p-3">Date</th>
                    <th class="p-3">GRN #</th>
                    <th class="p-3">Supplier</th>
                    <th class="p-3">Item Details</th>
                    <th class="p-3 text-center">Qty</th>
                    <th class="p-3 text-right">Unit Price</th>
                    <th class="p-3 text-right">Line Total</th>
                    <th class="p-3 text-right">Grand Total</th>
                    <th class="p-3 text-center">Payment</th>
                </tr>`;
                
                reportTxns.forEach(t => {
                    if(t.items && t.items.length > 0) {
                        let firstRow = true;
                        t.items.forEach((item, idx) => {
                            const tr = document.createElement('tr');
                            tr.className = "border-b border-gray-800 text-gray-300";
                            
                            const itemCost = item.cost || 0;
                            const lineTotal = moneyRound((item.qty || 1) * itemCost);
                            
                            if(firstRow) {
                                // Show transaction-level info only on first row
                                tr.innerHTML = `
                                    <td class="p-3 text-gray-400">${new Date(t.date).toLocaleDateString()}</td>
                                    <td class="p-3 font-mono font-bold text-white">#${t.id.toString().slice(-6)}</td>
                                    <td class="p-3 font-bold text-white">${t.entityName || '-'}</td>
                                    <td class="p-3">${item.name || '-'}</td>
                                    <td class="p-3 text-center text-white font-bold">${item.qty || 1}</td>
                                    <td class="p-3 text-right">${db.config.currency}${itemCost.toFixed(2)}</td>
                                    <td class="p-3 text-right text-green-400 font-bold">${db.config.currency}${lineTotal.toFixed(2)}</td>
                                    <td class="p-3 text-right font-bold text-karta-primary">${db.config.currency}${t.total.toFixed(2)}</td>
                                    <td class="p-3 text-center"><span class="px-2 py-1 rounded text-xs ${t.payType === 'credit' ? 'bg-yellow-900 text-yellow-300' : 'bg-green-900 text-green-300'}">${t.payType || 'CASH'}</span></td>
                                `;
                                firstRow = false;
                            } else {
                                // Additional items in same purchase
                                tr.innerHTML = `
                                    <td colspan="2"></td>
                                    <td></td>
                                    <td class="p-3">${item.name || '-'}</td>
                                    <td class="p-3 text-center text-white font-bold">${item.qty || 1}</td>
                                    <td class="p-3 text-right">${db.config.currency}${itemCost.toFixed(2)}</td>
                                    <td class="p-3 text-right text-green-400 font-bold">${db.config.currency}${lineTotal.toFixed(2)}</td>
                                    <td colspan="2"></td>
                                `;
                            }
                            
                            tr.style.backgroundColor = firstRow ? '' : 'rgba(255,255,255,0.02)';
                            tbody.appendChild(tr);
                        });
                    } else {
                        // Purchase with no items (older format)
                        const tr = document.createElement('tr');
                        tr.className = "border-b border-gray-800 text-gray-300";
                        tr.innerHTML = `
                            <td class="p-3 text-gray-400">${new Date(t.date).toLocaleDateString()}</td>
                            <td class="p-3 font-mono font-bold text-white">#${t.id.toString().slice(-6)}</td>
                            <td class="p-3 font-bold text-white">${t.entityName || '-'}</td>
                            <td class="p-3 text-gray-500">-</td>
                            <td class="p-3 text-center">-</td>
                            <td class="p-3 text-right">-</td>
                            <td class="p-3 text-right">-</td>
                            <td class="p-3 text-right font-bold text-karta-primary">${db.config.currency}${t.total.toFixed(2)}</td>
                            <td class="p-3 text-center"><span class="px-2 py-1 rounded text-xs ${t.payType === 'credit' ? 'bg-yellow-900 text-yellow-300' : 'bg-green-900 text-green-300'}">${t.payType || 'CASH'}</span></td>
                        `;
                        tbody.appendChild(tr);
                    }
                });
            } else {
                // Filter specific type (sales, expense, etc.)
                reportTxns = filteredTxns.filter(t => t.type === dbType);
                
                // Add Action Header for Sales/Invoices
                thead.innerHTML = `<tr><th class="p-3">Date</th><th class="p-3">Entity/Ref</th><th class="p-3 text-right">Amount</th><th class="p-3 text-center">Action</th></tr>`;
                
                reportTxns.forEach(t => {
                    total += t.total;
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-800 text-gray-300";
                    
                    // Action Button Logic
                    let actionBtn = '';
                    if(t.type === 'sale') {
                        actionBtn = `<button onclick='printInvoiceStr(${JSON.stringify(t)})' class="text-gray-400 hover:text-white" title="Print/Export Invoice"><i class="fa-solid fa-print"></i></button>`;
                    }

                    tr.innerHTML = `
                        <td class="p-3">${new Date(t.date).toLocaleDateString()}</td>
                        <td class="p-3">${t.entityName || '-'}</td>
                        <td class="p-3 text-right">${db.config.currency}${t.total.toFixed(2)}</td>
                        <td class="p-3 text-center">${actionBtn}</td>
                    `;
                    tbody.appendChild(tr);
                });
                cards.innerHTML += createCard(`Total ${type}`, total, 'karta-primary');
            }
            
            // Save for export
            currentReportData = reportTxns;
        }

        // --- Global Refresh ---
        function refreshUI() {
            // Run data migration on load
            migrateProductIds();
            
            // Update only visible sections to improve speed
            const currentSection = document.querySelector('main section:not(.hidden)');
            const sectionId = currentSection ? currentSection.id : '';
            
            // Always refresh core sections
            renderProducts();
            renderCustomers();
            renderSuppliers();
            loadSettings();
            
            // Update Dashboard if visible
            if(!sectionId || sectionId === 'dashboard') {
                loadDashboard();
            }
            
            // Ensure array exists before filtering
            const txns = db.transactions || [];

            // Populate Purch History (Last 5)
            const ph = document.getElementById('purchHistory');
            if(ph) {
                ph.innerHTML = '';
                txns.filter(t => t.type === 'purchase').slice().reverse().slice(0, 5).forEach(t => {
                    ph.innerHTML += `<div class="p-3 bg-white/5 rounded flex justify-between"><div><div class="font-bold text-white text-sm">${t.entityName}</div><div class="text-xs text-gray-500">${new Date(t.date).toLocaleDateString()}</div></div><div class="text-red-400 font-bold text-sm">-${t.total.toFixed(2)}</div></div>`;
                });
            }
            
            // Populate Expense History (Last 5)
            const eh = document.getElementById('expHistory');
            if(eh) {
                eh.innerHTML = '';
                txns.filter(t => t.type === 'expense').slice().reverse().slice(0, 5).forEach(t => {
                    eh.innerHTML += `<div class="p-3 bg-white/5 rounded flex justify-between"><div><div class="font-bold text-white text-sm">${t.items?.[0]?.name || 'Expense'}</div><div class="text-xs text-gray-500">${new Date(t.date).toLocaleDateString()}</div></div><div class="text-red-400 font-bold text-sm">-${t.total.toFixed(2)}</div></div>`;
                });
            }
        }
        
        // --- PRICE MANAGEMENT FUNCTIONS ---
        
        // Initialize price manager modal when opened
        function loadPriceManagerData() {
            // Populate product list
            const prodSel = document.getElementById('priceProductSelect');
            prodSel.innerHTML = '<option value="">-- Select Product --</option>';
            if(db.products) {
                db.products.forEach(p => {
                    prodSel.innerHTML += `<option value="${p.id}" data-name="${p.name}|${p.cost}|${p.retail}|${p.wholesale}">${p.name} (${p.sku})</option>`;
                });
            }
            
            // Populate category list
            const catSel = document.getElementById('priceCategoryFilter');
            catSel.innerHTML = '<option value="">-- Select Category --</option>';
            const categories = new Set();
            if(db.products) {
                db.products.forEach(p => {
                    if(p.category) categories.add(p.category);
                });
            }
            categories.forEach(cat => {
                catSel.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            
            // Setup percentage change preview
            document.getElementById('pricePercentage').addEventListener('input', updatePricePreview);
        }
        
        function updatePricePreview() {
            const percent = parseFloat(document.getElementById('pricePercentage').value) || 0;
            const original = 100;
            const newPrice = moneyRound(original * (1 + percent / 100));
            document.getElementById('pricePreview').innerText = `${db.config.currency}${original.toFixed(2)} → ${db.config.currency}${newPrice.toFixed(2)}`;
        }
        
        window.loadProductPriceFields = function() {
            const prodSel = document.getElementById('priceProductSelect');
            const selectedOption = prodSel.options[prodSel.selectedIndex];
            
            if(!selectedOption.value) {
                document.getElementById('priceProductCost').value = '';
                document.getElementById('priceProductRetail').value = '';
                document.getElementById('priceProductWholesale').value = '';
                document.getElementById('profitMarginDisplay').innerText = '--';
                return;
            }
            
            const prod = db.products.find(p => p.id === parseInt(prodSel.value));
            if(prod) {
                document.getElementById('priceProductCost').value = prod.cost.toFixed(2);
                document.getElementById('priceProductRetail').value = prod.retail.toFixed(2);
                document.getElementById('priceProductWholesale').value = (prod.wholesale || 0).toFixed(2);
                
                // Calculate margin
                const margin = moneyRound((prod.retail - prod.cost) / prod.retail * 100);
                document.getElementById('profitMarginDisplay').innerText = margin.toFixed(1) + '%';
                
                // Setup real-time margin calculation
                document.getElementById('priceProductRetail').addEventListener('input', function() {
                    const cost = parseFloat(document.getElementById('priceProductCost').value) || 0;
                    const retail = parseFloat(this.value) || 0;
                    const m = retail > 0 ? ((retail - cost) / retail * 100) : 0;
                    document.getElementById('profitMarginDisplay').innerText = m.toFixed(1) + '%';
                });
            }
        }
        
        window.updateIndividualProductPrice = function() {
            const prodId = parseInt(document.getElementById('priceProductSelect').value);
            const cost = moneyRound(parseFloat(document.getElementById('priceProductCost').value));
            const retail = moneyRound(parseFloat(document.getElementById('priceProductRetail').value));
            const wholesale = moneyRound(parseFloat(document.getElementById('priceProductWholesale').value) || 0);
            
            if(!prodId || !retail) return alert("Please select product and enter retail price");
            
            const prod = db.products.find(p => p.id === prodId);
            if(prod) {
                const oldRetail = prod.retail;
                const oldCost = prod.cost;
                
                prod.cost = cost;
                prod.retail = retail;
                prod.wholesale = wholesale;
                
                saveDB();
                renderProducts();
                
                alert(`✅ Price Updated!\n${prod.name}\n\nCost: ${db.config.currency}${oldCost.toFixed(2)} → ${db.config.currency}${cost.toFixed(2)}\nRetail: ${db.config.currency}${oldRetail.toFixed(2)} → ${db.config.currency}${retail.toFixed(2)}`);
                
                // Reload fields
                loadProductPriceFields();
            }
        }
        
        window.applyBulkPriceChange = function() {
            const percent = parseFloat(document.getElementById('pricePercentage').value);
            const adjustType = document.getElementById('priceAdjustType').value;
            
            if(isNaN(percent)) return alert("Please enter a percentage");
            if(!db.products) return;
            
            const affectedCount = db.products.length;
            if(affectedCount === 0) return alert("No products to update");
            
            if(!confirm(`Apply ${percent > 0 ? '+' : ''}${percent}% to ${adjustType} prices for ${affectedCount} product(s)?\n\nThis cannot be undone!`)) return;
            
            let updateCount = 0;
            db.products.forEach(p => {
                if(adjustType === 'retail') {
                    p.retail = moneyRound(p.retail * (1 + percent / 100));
                    updateCount++;
                } else if(adjustType === 'both') {
                    p.retail = moneyRound(p.retail * (1 + percent / 100));
                    if(p.wholesale) p.wholesale = moneyRound(p.wholesale * (1 + percent / 100));
                    updateCount++;
                } else if(adjustType === 'cost') {
                    p.cost = moneyRound(p.cost * (1 + percent / 100));
                    updateCount++;
                }
            });
            
            saveDB();
            renderProducts();
            
            alert(`✅ Price Updated!\n${updateCount} product(s) updated with ${percent > 0 ? '+' : ''}${percent}% change`);
            document.getElementById('pricePercentage').value = '';
            updatePricePreview();
        }
        
        window.applyBulkPriceChangeByCategory = function() {
            const category = document.getElementById('priceCategoryFilter').value;
            const percent = parseFloat(document.getElementById('priceCategoryPercentage').value);
            const adjustType = document.getElementById('priceCategoryAdjustType').value;
            
            if(!category) return alert("Please select a category");
            if(isNaN(percent)) return alert("Please enter a percentage");
            if(!db.products) return;
            
            const categoryProducts = db.products.filter(p => p.category === category);
            if(categoryProducts.length === 0) return alert("No products in this category");
            
            if(!confirm(`Apply ${percent > 0 ? '+' : ''}${percent}% to ${adjustType} prices for ${categoryProducts.length} product(s) in "${category}"?\n\nThis cannot be undone!`)) return;
            
            categoryProducts.forEach(p => {
                if(adjustType === 'retail') {
                    p.retail = moneyRound(p.retail * (1 + percent / 100));
                } else if(adjustType === 'both') {
                    p.retail = moneyRound(p.retail * (1 + percent / 100));
                    if(p.wholesale) p.wholesale = moneyRound(p.wholesale * (1 + percent / 100));
                }
            });
            
            saveDB();
            renderProducts();
            
            alert(`✅ Prices Updated!\n${categoryProducts.length} product(s) in "${category}" updated with ${percent > 0 ? '+' : ''}${percent}% change`);
            document.getElementById('priceCategoryFilter').value = '';
            document.getElementById('priceCategoryPercentage').value = '';
            document.getElementById('categoryProductCount').innerText = '0';
        }
        
        // Update product count when category selected
        document.addEventListener('change', function(e) {
            if(e.target.id === 'priceCategoryFilter') {
                const category = e.target.value;
                if(!db.products) return;
                const count = db.products.filter(p => p.category === category).length;
                document.getElementById('categoryProductCount').innerText = count;
            }
        });
        
        // --- Init ---
        document.getElementById('invSearch').addEventListener('input', renderProducts);
        document.getElementById('posSearch').addEventListener('input', loadPOS);
        document.getElementById('custSearch').addEventListener('input', renderCustomers);
        document.getElementById('supSearch').addEventListener('input', renderSuppliers);

        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
            document.getElementById('date').innerText = new Date().toLocaleDateString(undefined, {weekday:'short', year:'numeric', month:'short', day:'numeric'});
        }, 1000);

        window.onload = () => {
            refreshUI();
            nav('dashboard');
        };

        // ===== ADDITIONAL PROTECTION LAYER (Non-Blocking) =====
        window.addEventListener('load', function() {
            // Prevent iframe breaking out
            if (window.self !== window.top) {
                window.top.location = window.self.location;
            }

            // Monitor for injected content
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length > 0) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1) { // Element node
                                // Check for injected scripts from external sources
                                if (node.tagName === 'SCRIPT' && node.src && !node.src.includes(window.location.hostname) && !node.src.includes('cdn') && !node.src.includes('jsDelivr')) {
                                    originalConsole.warn('Security: Potential script injection detected');
                                    node.remove();
                                }
                            }
                        });
                    }
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: false,
                attributes: false
            });
        });

        // Monitor for source map attacks
        window.addEventListener('error', function(e) {
            if (e.filename && e.filename.includes('sourcemap')) {
                originalConsole.warn('Security: Source map access blocked');
                e.preventDefault();
            }
        }, true);

        // Log protection enabled to original console
        setTimeout(() => {
            originalConsole.log('%c🔐 KARTA Application Protected', 'color: #00c853; font-size: 14px; font-weight: bold;');
            originalConsole.log('%cRight-click, copying, and developer tools are disabled for security.', 'color: #888; font-size: 12px;');
        }, 1000);
    </script>
</body>

</html>
