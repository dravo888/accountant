<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" type="image/png" href="karta-logo-design.png">
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- Anti-Copy Protection Headers -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:;">
    <meta name="theme-color" content="#0b0b0b">
    <title>Karta</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF & AutoTable for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <!-- Nepali Date Converter -->
    <script src="https://cdn.jsdelivr.net/npm/nepali-date-converter@latest/dist/nepali-date-converter.umd.js"></script>
    <!-- Nepali Date Picker -->
    <link href="https://cdn.jsdelivr.net/npm/@anuz-pandey/nepali-date-picker@latest/dist/nepali-date-picker.min.css"
        rel="stylesheet">
    <script
        src="https://cdn.jsdelivr.net/npm/@anuz-pandey/nepali-date-picker@latest/dist/nepali-date-picker.bundle.min.js"></script>
    <script>
        // Compatibility fix for NepaliDate UMD export
        // This runs immediately to catch the constructor before any code uses it.
        (function () {
            if (window.NepaliDate && typeof window.NepaliDate !== 'function' && window.NepaliDate.default) {
                window.NepaliDate = window.NepaliDate.default;
                console.log('Fixed NepaliDate global export (immediate)');
            }
        })();

        // FIX: Define solveSimpleChallenge to prevent ReferenceError if called by legacy/cached code
        window.solveSimpleChallenge = function () {
            console.log("solveSimpleChallenge called (stub).");
        };
    </script>

    <script>
        // ===== ANTI-COPY & CODE PROTECTION =====
        // Store original console methods before any modifications
        const originalConsole = {
            log: console.log,
            warn: console.warn,
            error: console.error,
            info: console.info,
            debug: console.debug
        };

        // Wait for DOM to be ready before applying body styles
        if (document.body) {
            document.body.style.userSelect = 'none';
            document.body.style.webkitUserSelect = 'none';
            document.body.style.msUserSelect = 'none';
        } else {
            document.addEventListener('DOMContentLoaded', function () {
                document.body.style.userSelect = 'none';
                document.body.style.webkitUserSelect = 'none';
                document.body.style.msUserSelect = 'none';
            });
        }

        // Disable right-click context menu
        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
            return false;
        }, false);

        // Disable keyboard shortcuts for developer tools
        document.addEventListener('keydown', function (e) {
            // F12 - Developer Tools
            if (e.keyCode === 123) {
                e.preventDefault();
                return false;
            }
            // Ctrl+Shift+I - Inspect Element
            if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
                e.preventDefault();
                return false;
            }
            // Ctrl+Shift+J - Developer Console
            if (e.ctrlKey && e.shiftKey && e.keyCode === 74) {
                e.preventDefault();
                return false;
            }
            // Ctrl+Shift+C - Inspect Element (Alt)
            if (e.ctrlKey && e.shiftKey && e.keyCode === 67) {
                e.preventDefault();
                return false;
            }
            // Ctrl+Shift+K - Developer Console (Firefox)
            if (e.ctrlKey && e.shiftKey && e.keyCode === 75) {
                e.preventDefault();
                return false;
            }
        }, false);

        // Disable copy event
        document.addEventListener('copy', function (e) {
            e.preventDefault();
            return false;
        });

        // Disable cut event
        document.addEventListener('cut', function (e) {
            e.preventDefault();
            return false;
        });

        // Detect if Developer Tools are open (non-blocking)
        let devToolsOpen = false;
        const checkDevTools = setInterval(function () {
            if (window.outerHeight - window.innerHeight > 100 ||
                window.outerWidth - window.innerWidth > 100) {
                devToolsOpen = true;
            }
        }, 500);

        // ===== AGGRESSIVE SAVE-AS PROTECTION SYSTEM =====
        // Multi-layered approach to ensure saved files ALWAYS show Access Denied

        const ACCESS_DENIED_HTML = `<!DOCTYPE html>
<html>
<head>
    <title>Access Denied</title>
    <meta charset="UTF-8">
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #0b0b0b;
            font-family: 'Courier New', monospace;
        }
        .access-denied {
            text-align: center;
            padding: 60px 40px;
            background: #1a1a1a;
            border: 2px solid #ef4444;
            border-radius: 12px;
            max-width: 500px;
        }
        .icon {
            font-size: 80px;
            margin-bottom: 20px;
            color: #ef4444;
        }
        h1 {
            color: #ef4444;
            font-size: 32px;
            margin: 0 0 16px 0;
            font-weight: 700;
        }
        p {
            color: #9e9e9e;
            font-size: 16px;
            line-height: 1.6;
            margin: 0;
        }
        .code {
            margin-top: 24px;
            padding: 12px;
            background: #000;
            border-radius: 6px;
            color: #00c853;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="access-denied">
        <div class="icon">⛔</div>
        <h1>ACCESS DENIED</h1>
        <p>This application is protected and cannot be saved or copied.</p>
        <p style="margin-top: 16px;">Unauthorized access attempts are logged and monitored.</p>
        <div class="code">ERROR: SAVE_NOT_PERMITTED</div>
    </div>
</body>
</html>`;

        let saveProtectionActive = false;

        function replaceWithAccessDenied() {
            if (!saveProtectionActive) {
                saveProtectionActive = true;
                document.documentElement.innerHTML = ACCESS_DENIED_HTML;
            }
        }

        // Layer 1: Detect Ctrl+S keyboard shortcut
        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey && e.keyCode === 83) { // Ctrl+S
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                replaceWithAccessDenied();
                return false;
            }
        }, true); // Use capture phase

        // Layer 2: beforeunload event (fires on save attempts)
        window.addEventListener('beforeunload', function (e) {
            replaceWithAccessDenied();
        }, true);

        // Layer 3: pagehide event (more reliable than beforeunload)
        window.addEventListener('pagehide', function (e) {
            replaceWithAccessDenied();
        }, true);

        // Layer 4: visibilitychange (detects when page becomes hidden - save dialog opens)
        document.addEventListener('visibilitychange', function () {
            if (document.hidden) {
                replaceWithAccessDenied();
            }
        }, true);

        // Layer 5: blur event (window loses focus - save dialog)
        window.addEventListener('blur', function () {
            replaceWithAccessDenied();
        }, true);

        // Layer 6: Continuous monitoring - check every 100ms if page is being saved
        setInterval(function () {
            // If document is hidden or page has lost visibility, replace content
            if (document.hidden || document.visibilityState === 'hidden') {
                replaceWithAccessDenied();
            }
        }, 100);

        // Layer 7: Override native save functions if exposed
        if (window.external && window.external.AddFavorite) {
            window.external.AddFavorite = function () { replaceWithAccessDenied(); };
        }

        // Disable drag and drop for copying
        document.addEventListener('dragstart', function (e) {
            e.preventDefault();
            return false;
        });

        // Watermark detection - Add hidden marker
        document.documentElement.setAttribute('data-protected', 'true');
        document.documentElement.setAttribute('data-source', 'KARTA_PROPRIETARY');

        // ===== SERVER-ONLY PROTECTION SYSTEM =====
        // Blocks file:// protocol to make saved files completely unusable

        // Layer 1: Strict File Protocol Blocking - MUST RUN FROM WEB SERVER
        (function () {
            // Check if page is opened from file:// (saved file)
            if (window.location.protocol === 'file:') {
                // Immediate block - prevent any code execution
                document.addEventListener('DOMContentLoaded', function () {
                    document.documentElement.innerHTML = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Access Denied</title>
                            <style>
                                body {
                                    margin: 0;
                                    padding: 0;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    min-height: 100vh;
                                    background: #0b0b0b;
                                    font-family: monospace;
                                    color: #ef4444;
                                }
                                .error-container {
                                    text-align: center;
                                    padding: 40px;
                                    max-width: 600px;
                                }
                                .error-icon {
                                    font-size: 72px;
                                    margin-bottom: 20px;
                                }
                                .error-title {
                                    font-size: 24px;
                                    font-weight: bold;
                                    margin-bottom: 16px;
                                }
                                .error-message {
                                    font-size: 14px;
                                    color: #9e9e9e;
                                    line-height: 1.6;
                                }
                            </style>
                        </head>
                        <body>
                            <div class="error-container">
                                <div class="error-icon">⛔</div>
                                <div class="error-title">Access Denied</div>
                                <div class="error-message">
                                    This application must be accessed through a web server.<br><br>
                                    Direct file access is not permitted for security reasons.<br><br>
                                    Contact your administrator for proper access.
                                </div>
                            </div>
                        </body>
                        </html>
                    `;
                    // Remove all scripts to prevent any execution
                    const scripts = document.querySelectorAll('script');
                    scripts.forEach(s => s.remove());
                });
                // Throw error to stop script execution
                throw new Error('File protocol not allowed');
            }

            // Additional check for null origin (some edge cases)
            if (window.location.origin === 'null') {
                document.addEventListener('DOMContentLoaded', function () {
                    document.body.innerHTML = '<div style="color:red;padding:20px;font-family:monospace;">Unauthorized Access</div>';
                });
                throw new Error('Invalid origin');
            }
        })();

        // Continuous validation - re-check every 2 seconds
        setInterval(function () {
            if (window.location.protocol === 'file:' || window.location.origin === 'null') {
                document.body.innerHTML = '';
                document.head.innerHTML = '<title>Access Denied</title>';
                throw new Error('Unauthorized file access detected');
            }
        }, 2000);


        // REMOVED: Layer 2 code integrity monitoring was causing false positives
        // Firebase auto-login and dynamic scripts trigger legitimate checksum changes

        // REMOVED: Layers 3-5 (anti-debugging, runtime validation, DOM observer)
        // These are unnecessary since file:// blocking prevents all saved file access

        // ===== END PROTECTION SYSTEM =====

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        karta: {
                            bg: '#0b0b0b',
                            surface: '#121212',
                            border: '#27272a',
                            primary: '#00c853',
                            primaryDark: '#009624',
                            text: '#e0e0e0',
                            muted: '#9e9e9e',
                            danger: '#ef4444',
                            warning: '#f59e0b'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        /* ===== CODE PROTECTION STYLES ===== */
        /* Prevent text selection globally */
        * {
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            -webkit-user-drag: none !important;
            -webkit-touch-callout: none !important;
        }

        /* Allow selection only in specific input fields */
        input,
        textarea,
        select {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }

        /* Disable inspect element highlighting */
        *::-webkit-scrollbar-button {
            pointer-events: none;
        }

        /* Hide during inspection */
        @supports (-webkit-appearance: none) {
            @media screen and (prefers-reduced-motion: no-preference) {
                body::-webkit-scrollbar {
                    width: 0 !important;
                    height: 0 !important;
                }
            }
        }

        body {
            background-color: #0b0b0b;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #121212;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #00c853;
        }

        /* Utilities */
        .glass-panel {
            background: rgba(18, 18, 18, 0.95);
            border: 1px solid #27272a;
        }

        .input-field {
            background-color: #1a1a1a;
            border: 1px solid #333;
            color: white;
            padding: 0.5rem;
            border-radius: 0.375rem;
            width: 100%;
            transition: all 0.2s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #00c853;
            box-shadow: 0 0 8px rgba(0, 200, 83, 0.3);
        }

        .input-field:hover {
            border-color: #555;
        }

        .input-field:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Button Styles */
        button {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button:focus-visible {
            outline: 2px solid #00c853;
            outline-offset: 2px;
        }

        /* Primary Button */
        .btn-primary {
            background-color: #00c853;
            color: black;
            font-weight: 600;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.25s ease;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #00e676;
            box-shadow: 0 8px 16px rgba(0, 200, 83, 0.3);
            transform: translateY(-2px);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        /* Secondary Button */
        .btn-secondary {
            background-color: transparent;
            border: 1.5px solid #333;
            color: #e0e0e0;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.25s ease;
        }

        .btn-secondary:hover:not(:disabled) {
            border-color: #00c853;
            color: #00c853;
            background-color: rgba(0, 200, 83, 0.1);
        }

        /* Danger Button */
        .btn-danger {
            background-color: #ef4444;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            transition: all 0.25s ease;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
            box-shadow: 0 8px 16px rgba(239, 68, 68, 0.3);
            transform: translateY(-2px);
        }

        /* Success/Confirmation Animation */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        .animate-slideIn {
            animation: slideIn 0.3s ease-out;
        }

        /* Loading State */
        .loading::after {
            content: '';
            display: inline-block;
            width: 4px;
            height: 4px;
            margin-left: 4px;
            background: currentColor;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Modal Content Fixes */
        .modal-content {
            pointer-events: auto !important;
            z-index: 51 !important;
            position: relative !important;
            animation: slideIn 0.3s ease-out;
        }

        #modalBackdrop {
            z-index: 50 !important;
            pointer-events: auto;
        }

        #modalBackdrop.hidden {
            pointer-events: none;
        }

        /* Responsive Table Wrapper */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Success Toast */
        .toast-success {
            animation: slideIn 0.3s ease-out, slideIn 0.3s ease-in 4.7s reverse;
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22c55e;
        }

        /* Card Hover Effects */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 200, 83, 0.15);
            border-color: #00c853 !important;
        }

        /* Table Row Hover */
        tbody tr {
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background-color: rgba(0, 200, 83, 0.05) !important;
        }

        /* KPI Cards */
        .kpi-card {
            transition: all 0.3s ease;
            position: relative;
        }

        .kpi-card:hover {
            transform: scale(1.02);
        }

        /* Smooth Transitions */
        * {
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        /* Focus States for Accessibility */
        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 2px solid #00c853;
            outline-offset: 2px;
        }

        /* Placeholder Styling */
        ::placeholder {
            color: #666;
            opacity: 0.8;
        }

        /* Select Element Styling */
        select {
            background-color: #1a1a1a;
            border: 1px solid #333;
            color: white;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }

        select:hover {
            border-color: #555;
        }

        select:focus {
            outline: none;
            border-color: #00c853;
            box-shadow: 0 0 8px rgba(0, 200, 83, 0.3);
        }

        /* Checkbox & Radio Styling */
        input[type="checkbox"],
        input[type="radio"] {
            accent-color: #00c853;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        input[type="checkbox"]:hover,
        input[type="radio"]:hover {
            transform: scale(1.1);
        }

        /* Number Input */
        input[type="number"] {
            transition: all 0.2s ease;
        }

        /* Skeleton Loading */
        .skeleton {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            background: linear-gradient(90deg, #1a1a1a 25%, #242424 50%, #1a1a1a 75%);
            background-size: 200% 100%;
        }

        /* Print Layout - A4 Specification Fixed */
        @media print {
            @page {
                size: A4;
                margin: 10mm;
            }

            body {
                background: white;
                color: black;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                margin: 0;
                padding: 0;
                overflow: visible !important;
            }

            /* Hide everything by default */
            body * {
                visibility: hidden;
            }

            /* Show ONLY the printable area and its children */
            #printable-area,
            #printable-area * {
                visibility: visible !important;
            }

            #printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                background: white;
                color: black;
                z-index: 9999;
            }

            .no-print {
                display: none !important;
            }
        }

        /* ===== ENHANCED UX IMPROVEMENTS ===== */

        /* Empty State Styling */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: #ccc;
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 14px;
            color: #999;
        }

        /* Enhanced Input Feedback */
        .input-field:valid {
            border-color: #00c853;
        }

        .input-field:invalid:not(:placeholder-shown) {
            border-color: #ef4444;
        }

        /* Tooltip Styling */
        [data-tooltip] {
            position: relative;
            cursor: help;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: #00c853;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            border: 1px solid #333;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            max-width: 400px;
            padding: 16px;
            border-radius: 8px;
            font-weight: 500;
            z-index: 1000;
            animation: slideInUp 0.3s ease-out;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .toast-success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22c55e;
            color: #86efac;
        }

        .toast-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #fca5a5;
        }

        .toast-info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
            color: #93c5fd;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Breadcrumb Navigation */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #999;
            margin-bottom: 16px;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .breadcrumb-item.active {
            color: #00c853;
            font-weight: 600;
        }

        .breadcrumb-separator {
            color: #555;
        }

        /* Badge Styling */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
            border: 1px solid #22c55e;
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
            border: 1px solid #f59e0b;
        }

        .badge-error {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid #ef4444;
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            border: 1px solid #3b82f6;
        }

        /* Help Text */
        .help-text {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
            display: block;
        }

        /* Form Group Spacing */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* Confirmation Dialog */
        .confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #121212;
            border: 1px solid #27272a;
            padding: 24px;
            border-radius: 8px;
            z-index: 1001;
            min-width: 320px;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .confirm-dialog-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        /* Expandable Row */
        .expandable-row {
            cursor: pointer;
            user-select: none;
        }

        .expandable-row:hover {
            background: rgba(0, 200, 83, 0.05);
        }

        .expandable-row.expanded {
            background: rgba(0, 200, 83, 0.08);
        }

        /* Loading Bar */
        .progress-bar {
            height: 3px;
            background: linear-gradient(90deg, #00c853, #00e676);
            animation: progress 2s ease-in-out infinite;
            border-radius: 2px;
        }

        @keyframes progress {
            0% {
                width: 0%;
            }

            50% {
                width: 100%;
            }

            100% {
                width: 0%;
            }
        }

        /* Status Indicator */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-indicator.online::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* ===== MOVABLE CALENDAR STYLES ===== */
        .ap-card {
            z-index: 9999 !important;
            padding-top: 0 !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5) !important;
            overflow: hidden !important;
            cursor: grab;
            /* Indicate draggable */
        }

        .ap-card:active {
            cursor: grabbing;
        }

        .calendar-drag-handle {
            background: #27272a;
            color: #bdc3c7;
            padding: 8px 12px;
            border-bottom: 1px solid #3f3f46;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            user-select: none;
            transition: all 0.2s ease;
        }

        .calendar-drag-handle:active {
            cursor: grabbing;
            background: #3f3f46;
        }

        .calendar-drag-handle.locked {
            background: #7f1d1d;
            color: #fecaca;
            cursor: default;
            border-bottom-color: #991b1b;
        }

        .calendar-lock-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .calendar-lock-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .status-indicator.offline::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
        }

        /* Fix Nepali Date Picker Z-Index & Positioning */
        .ndp-popup,
        .ndp-container {
            z-index: 99999 !important;
            margin-top: 40px !important;
            /* Force drop-down below input */
            /* Reverting large offset/scale request to match English behavior */
        }

        /* Responsive Table Fixes */
        table {
            border-collapse: collapse;
        }

        thead th {
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            transition: background-color 0.2s ease;
        }

        tbody tr:hover {
            background-color: rgba(0, 200, 83, 0.05);
        }

        /* Mobile-First Improvements */
        @media (max-width: 768px) {
            .breadcrumb {
                font-size: 11px;
            }

            .badge {
                font-size: 10px;
                padding: 3px 6px;
            }

            button {
                font-size: 14px !important;
                padding: 10px 16px !important;
            }

            .input-field {
                font-size: 16px;
                padding: 12px;
            }
        }

        /* Section Transitions */
        section {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Icon Loading Animation */
        .fa-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>

<body class="h-screen overflow-hidden text-sm relative">

    <!-- AUTH LOGIN SCREEN -->
    <div id="auth-screen" class="absolute inset-0 z-50 bg-karta-bg flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-karta-surface border border-karta-border p-8 rounded-lg shadow-2xl">
            <div class="text-center mb-8">
                <div
                    class="w-16 h-16 rounded bg-karta-primary flex items-center justify-center text-black font-bold text-3xl mx-auto mb-4">
                    <i class="fa-solid fa-leaf"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">Welcome to KARTA</h1>
                <p class="text-karta-muted mt-2">Secure Business Accounting System</p>
                <div class="mt-4 p-3 bg-blue-900/20 border border-blue-800 rounded text-xs text-blue-300 text-left">
                    <i class="fa-solid fa-shield-halved mr-2"></i> <strong>Private Database:</strong> Each user has a
                    completely separate database. Data is never shared between accounts.
                </div>
            </div>

            <form id="authForm" class="space-y-4">
                <div>
                    <label class="text-xs text-gray-400">Email Address</label>
                    <input type="email" id="authEmail" class="input-field mt-1" placeholder="admin@karta.com" required>
                </div>
                <div>
                    <label class="text-xs text-gray-400">Password</label>
                    <input type="password" id="authPass" class="input-field mt-1" placeholder="••••••••" required>
                </div>

                <div id="authError" class="text-red-500 text-xs hidden"></div>

                <div class="pt-4 flex flex-col gap-3">
                    <button type="submit" id="btnSignIn"
                        class="w-full bg-karta-primary hover:bg-karta-primaryDark text-black font-bold py-3 rounded transition-all duration-200 hover:shadow-lg hover:shadow-green-500/50 active:scale-95">
                        <i class="fa-solid fa-lock mr-2"></i> Sign In
                    </button>
                    <button type="button" onclick="openSignUpModal()"
                        class="w-full bg-transparent border border-karta-border hover:border-karta-primary hover:bg-white/5 text-white py-2 rounded transition-all duration-200 active:scale-95">
                        <i class="fa-solid fa-user-plus mr-2"></i> Sign Up
                    </button>
                </div>
            </form>
            <div class="mt-6 text-center text-xs text-gray-500">
                Secured by Firebase
            </div>
        </div>
    </div>

    <!-- BLOCKED USER OVERLAY - Shows when user is blocked by admin -->
    <div id="blocked-overlay"
        class="hidden fixed inset-0 z-[9999] bg-karta-bg flex items-center justify-center p-4 w-screen h-screen">
        <div
            class="w-full max-w-md bg-karta-surface border border-red-800 p-6 md:p-8 rounded-lg shadow-2xl text-center">
            <div
                class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-red-900/30 border-2 border-red-600 flex items-center justify-center text-red-500 text-3xl md:text-4xl mx-auto mb-4 md:mb-6">
                <i class="fa-solid fa-ban"></i>
            </div>
            <h1 class="text-xl md:text-2xl font-bold text-red-400 mb-3 md:mb-4">Service Temporarily Paused</h1>
            <p class="text-sm md:text-base text-gray-400 mb-4 md:mb-6">
                Your access has been temporarily paused due to a pending payment.
                To continue using the application, please settle the outstanding balance.
                Once payment is verified, access will be restored Automatically.
            </p>

            <!-- Payment Trigger & QR -->
            <div id="paymentSection" class="mb-4">
                <button
                    onclick="document.getElementById('qrCodeContainer').classList.remove('hidden'); this.classList.add('hidden');"
                    class="w-full bg-karta-primary hover:bg-karta-primaryDark text-black font-bold py-2.5 md:py-3 text-sm md:text-base rounded transition-all duration-200 hover:shadow-lg mb-4">
                    <i class="fa-solid fa-wallet mr-2"></i> Proceed to Payment
                </button>

                <!-- Hidden QR Code Section -->
                <div id="qrCodeContainer" class="hidden animate-slideIn">
                    <div class="bg-white/5 border border-white/10 rounded-lg p-4 mb-4 flex flex-col items-center">
                        <div class="bg-white p-2 rounded-lg mb-3">
                            <img src="payment-qr.jpg" alt="eSewa QR Code" class="w-48 h-48 object-contain">
                        </div>
                        <p class="text-karta-primary text-xs md:text-sm font-semibold mb-4">
                            <i class="fa-solid fa-qrcode mr-2"></i>Scan using eSewa App
                        </p>

                        <button onclick="window.notifyPaymentDone()"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-check"></i> I Have Made Payment
                        </button>
                    </div>
                </div>
            </div>


            <button onclick="window.logoutBlockedUser()"
                class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 md:py-3 text-sm md:text-base rounded transition-all duration-200 hover:shadow-lg">
                <i class="fa-solid fa-sign-out-alt mr-2"></i> Logout
            </button>
        </div>
    </div>

    <!-- SIGNUP MODAL -->
    <div id="signupModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-karta-surface border border-karta-border rounded-lg shadow-2xl p-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                    <i class="fa-solid fa-user-plus text-karta-primary"></i> Create New Account
                </h2>
                <button onclick="closeSignUpModal()" class="text-gray-400 hover:text-white text-2xl">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <form id="signupForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-400 block mb-2">Full Name *</label>
                        <input type="text" id="signupName" class="input-field" placeholder="Ram Doe" required>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-2">Email Address *</label>
                        <input type="email" id="signupEmail" class="input-field" placeholder="Ram@example.com" required>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-2">Business Name *</label>
                        <input type="text" id="signupBusiness" class="input-field" placeholder="My Business" required>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-2">Business Type *</label>
                        <select id="signupBusinessType" class="input-field" required>
                            <option value="">Select Type</option>
                            <option value="retail">Retail</option>
                            <option value="wholesale">Wholesale</option>
                            <option value="pharmacy">Pharmacy</option>
                            <option value="services">Services</option>
                            <option value="general">General</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-2">Phone Number *</label>
                        <input type="tel" id="signupPhone" class="input-field" placeholder="+977-9800000000" required>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-2">Address</label>
                        <input type="text" id="signupAddress" class="input-field" placeholder="City, Country">
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-xs text-gray-400 block mb-2">Tax ID / VAT Number</label>
                        <input type="text" id="signupTaxId" class="input-field" placeholder="PAN-000000">
                    </div>
                </div>

                <div id="signupError"
                    class="text-red-500 text-xs hidden p-3 bg-red-900/20 rounded border border-red-800"></div>

                <div class="pt-4 flex gap-3 justify-end">
                    <button type="button" onclick="closeSignUpModal()"
                        class="px-6 py-2 bg-transparent border border-karta-border hover:border-gray-400 text-gray-400 rounded transition">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-6 py-2 bg-karta-primary hover:bg-karta-primaryDark text-black font-bold rounded transition flex items-center gap-2">
                        <i class="fa-solid fa-paper-plane"></i> Submit Request
                    </button>
                </div>
            </form>

            <p class="text-xs text-gray-500 mt-6 text-center">
                Your request will be sent to the admin for review. You'll receive an email with login credentials
                once
                approved.
            </p>
        </div>
    </div>

    <!-- Mobile Sidebar Overlay Backdrop -->
    <div id="mobile-backdrop" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden glass-panel"
        onclick="toggleSidebar()"></div>

    <!-- Wrapper for Main App (to hide during print) -->
    <div id="app-root" class="flex h-full w-full hidden opacity-0 transition-opacity duration-500">

        <!-- Sidebar -->
        <!-- CHANGED: Added mobile specific classes for slide-out drawer behavior -->
        <aside id="sidebar"
            class="fixed md:relative inset-y-0 left-0 transform -translate-x-full md:translate-x-0 w-64 bg-karta-surface border-r border-karta-border flex flex-col z-30 transition-transform duration-300 ease-in-out">
            <div class="p-6 flex items-center justify-between border-b border-karta-border">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded bg-karta-primary flex items-center justify-center text-black font-bold text-xl">
                        <i class="fa-solid fa-leaf"></i>
                    </div>
                    <div class="overflow-hidden">
                        <h1 class="text-xl font-bold tracking-tight text-white">KARTA</h1>
                        <p class="text-xs text-karta-primary truncate max-w-[100px]" id="userEmailDisplay">User</p>
                    </div>
                </div>
                <!-- Mobile Close Button -->
                <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-white">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <nav class="flex-1 p-3 space-y-1 overflow-y-auto">
                <div class="text-xs font-bold text-karta-muted uppercase px-3 py-2 mt-2">Core</div>
                <button onclick="nav('dashboard')"
                    class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:border-l-2 hover:border-karta-primary transition-all text-karta-primary bg-white/5">
                    <i class="fa-solid fa-chart-pie w-5 text-center"></i> <span>Dashboard</span>
                </button>
                <button onclick="nav('pos')"
                    class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:text-karta-primary transition-all text-gray-400">
                    <i class="fa-solid fa-cash-register w-5 text-center"></i> <span>POS Terminal</span>
                </button>
                <button onclick="nav('invoices')"
                    class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:text-karta-primary transition-all text-gray-400">
                    <i class="fa-solid fa-receipt w-5 text-center"></i> <span>Invoices</span>
                </button>

                <button onclick="nav('returns')"
                    class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:text-karta-primary transition-all text-gray-400">
                    <i class="fa-solid fa-rotate-left w-5 text-center"></i> <span>Returns & Refunds</span>
                </button>

                <div class="text-xs font-bold text-karta-muted uppercase px-3 py-2 mt-4">Management</div>
                <button onclick="nav('inventory')"
                    class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:text-karta-primary transition-all text-gray-400">
                    <i class="fa-solid fa-box w-5 text-center"></i> <span>Products & Stock</span>
                </button>
                <button onclick="nav('customers')"
                    class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:text-karta-primary transition-all text-gray-400">
                    <i class="fa-solid fa-users w-5 text-center"></i> <span>Customers</span>
                </button>
                <button onclick="nav('suppliers')"
                    class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:text-karta-primary transition-all text-gray-400">
                    <i class="fa-solid fa-truck-field w-5 text-center"></i> <span>Suppliers</span>
                </button>
                <button onclick="nav('productSuppliers')"
                    class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:text-karta-primary transition-all text-gray-400">
                    <i class="fa-solid fa-link w-5 text-center"></i> <span>Product-Supplier</span>
                </button>

                <div class="text-xs font-bold text-karta-muted uppercase px-3 py-2 mt-4">Finance</div>
                <button onclick="nav('purchases')"
                    class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:text-karta-primary transition-all text-gray-400">
                    <i class="fa-solid fa-file-invoice w-5 text-center"></i> <span>Purchases & Exp</span>
                </button>
                <button onclick="nav('reports')"
                    class="nav-btn w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 hover:text-karta-primary transition-all text-gray-400">
                    <i class="fa-solid fa-chart-line w-5 text-center"></i> <span>Reports</span>
                </button>
            </nav>

            <div class="p-4 border-t border-karta-border space-y-2">
                <div class="text-xs text-center text-gray-500 mb-2 animate-pulse">
                    <span id="syncStatusIndicator" class="text-green-500"><i class="fa-solid fa-circle"></i>
                        Synced</span>
                </div>
                <button onclick="nav('settings'); if(window.loadSettings) window.loadSettings();"
                    class="flex items-center gap-2 text-gray-400 hover:text-karta-primary hover:bg-white/5 transition-all w-full p-2 rounded">
                    <i class="fa-solid fa-gear"></i> Settings
                </button>
                <button onclick="handleLogout()"
                    class="flex items-center gap-2 text-red-500 hover:text-red-400 hover:bg-red-500/10 transition-all w-full p-2 rounded">
                    <i class="fa-solid fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-karta-bg relative overflow-hidden">

            <!-- Top Bar -->
            <header
                class="h-16 border-b border-karta-border bg-karta-bg flex items-center justify-between px-4 md:px-6 z-10 shrink-0">
                <div class="flex items-center gap-3 flex-1 min-w-0">
                    <!-- Mobile Menu Button -->
                    <button onclick="toggleSidebar()"
                        class="md:hidden text-white p-2 hover:bg-white/5 rounded transition" title="Menu">
                        <i class="fa-solid fa-bars fa-lg"></i>
                    </button>
                    <!-- Breadcrumb Navigation -->
                    <div class="breadcrumb hidden sm:flex overflow-x-auto">
                        <span class="breadcrumb-item active">
                            <i class="fa-solid fa-home text-xs"></i>
                            <span id="pageTitle" class="font-bold text-white truncate">Dashboard</span>
                        </span>
                    </div>
                    <h2 id="pageTitleMobile" class="text-lg md:text-xl font-bold text-white truncate sm:hidden">
                        Dashboard</h2>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <div class="text-sm font-bold text-white" id="clock">12:00 PM</div>
                        <div class="text-xs text-karta-muted" id="date">Jan 01, 2025</div>
                    </div>
                    <div class="h-8 w-8 rounded-full bg-gray-800 border border-gray-700 flex items-center justify-center text-karta-primary hover:bg-gray-700 transition cursor-pointer"
                        title="User Profile">
                        <i class="fa-solid fa-user-shield"></i>
                    </div>
                </div>
            </header>

            <!-- Content Scroll Area -->
            <div class="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth" id="mainContainer">

                <!-- DASHBOARD -->
                <section id="dashboard" class="space-y-6 animate-fade pb-20 md:pb-0">
                    <!-- KPI Grid - Sales & Payments -->
                    <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-5 gap-4">
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg relative overflow-hidden group hover:border-karta-primary transition cursor-pointer"
                            data-tooltip="Total revenue from all sales">
                            <div
                                class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition text-karta-primary">
                                <i class="fa-solid fa-sack-dollar fa-3x"></i>
                            </div>
                            <p class="text-karta-muted text-xs uppercase tracking-wider">Total Revenue</p>
                            <h3 class="text-2xl font-bold text-karta-primary mt-1" id="kpiRevenue">$0.00</h3>
                        </div>
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg relative overflow-hidden group hover:border-green-600 transition cursor-pointer"
                            data-tooltip="Cash received from customers">
                            <div class="absolute right-0 top-0 p-4 opacity-10 text-green-500"><i
                                    class="fa-solid fa-money-bill fa-3x"></i></div>
                            <p class="text-karta-muted text-xs uppercase tracking-wider">Cash Received</p>
                            <h3 class="text-2xl font-bold text-green-500 mt-1" id="kpiCash">$0.00</h3>
                        </div>
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg relative overflow-hidden group hover:border-blue-600 transition cursor-pointer"
                            data-tooltip="Bank deposits and transfers">
                            <div class="absolute right-0 top-0 p-4 opacity-10 text-blue-500"><i
                                    class="fa-solid fa-building fa-3x"></i></div>
                            <p class="text-karta-muted text-xs uppercase tracking-wider">Bank Received</p>
                            <h3 class="text-2xl font-bold text-blue-500 mt-1" id="kpiBank">$0.00</h3>
                        </div>
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg relative overflow-hidden group hover:border-orange-600 transition cursor-pointer"
                            data-tooltip="Products below reorder level">
                            <div class="absolute right-0 top-0 p-4 opacity-10 text-orange-600"><i
                                    class="fa-solid fa-triangle-exclamation fa-3x"></i></div>
                            <p class="text-karta-muted text-xs uppercase tracking-wider">Low Stock Items</p>
                            <h3 class="text-2xl font-bold text-orange-500 mt-1" id="kpiLowStock">0</h3>
                        </div>
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg relative overflow-hidden group hover:border-gray-500 transition cursor-pointer"
                            data-tooltip="Total value of inventory at cost">
                            <div class="absolute right-0 top-0 p-4 opacity-10 text-gray-500"><i
                                    class="fa-solid fa-boxes-stacked fa-3x"></i></div>
                            <p class="text-karta-muted text-xs uppercase tracking-wider">Stock Value</p>
                            <h3 class="text-2xl font-bold text-gray-300 mt-1" id="kpiStockVal">$0.00</h3>
                        </div>
                    </div>

                    <!-- Balance Summary Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div
                            class="bg-karta-surface border border-karta-border p-4 rounded-lg hover:border-red-700 transition">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Customer Balance
                                        Due
                                    </p>
                                    <h3 class="text-3xl font-bold text-red-500" id="kpiCustDue">$0.00</h3>
                                    <p class="text-xs text-gray-500 mt-2">Receivables from customers</p>
                                </div>
                                <div class="text-red-600/20"><i class="fa-solid fa-users fa-4x"></i></div>
                            </div>
                        </div>

                        <div
                            class="bg-karta-surface border border-karta-border p-4 rounded-lg hover:border-orange-700 transition">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Supplier Balance
                                        Due
                                    </p>
                                    <h3 class="text-3xl font-bold text-orange-600" id="kpiSupDue">$0.00</h3>
                                    <p class="text-xs text-gray-500 mt-2">Payables to suppliers</p>
                                </div>
                                <div class="text-orange-700/20"><i class="fa-solid fa-handshake fa-4x"></i></div>
                            </div>
                        </div>

                        <div
                            class="bg-karta-surface border border-karta-border p-4 rounded-lg hover:border-karta-primary transition">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Net Balance</p>
                                    <h3 class="text-3xl font-bold text-karta-primary" id="kpiNetBalance">$0.00</h3>
                                    <p class="text-xs text-gray-500 mt-2">Receivables - Payables</p>
                                </div>
                                <div class="text-karta-primary/20"><i class="fa-solid fa-scale-balanced fa-4x"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Area -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-karta-surface border border-karta-border rounded-lg p-4">
                            <h3 class="font-bold mb-4 text-white">Sales & Purchase Volume</h3>
                            <!-- Fixed Container for Chart -->
                            <div class="relative h-64 md:h-80 w-full">
                                <canvas id="mainChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-karta-surface border border-karta-border rounded-lg p-4 flex flex-col">
                            <h3 class="font-bold mb-4 text-white">Top Categories</h3>
                            <div class="flex-1 flex items-center justify-center relative h-64">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Low Stock Table (Restored) -->
                    <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                        <div class="p-4 border-b border-karta-border flex justify-between items-center">
                            <h3 class="font-bold text-white text-sm"><i
                                    class="fa-solid fa-circle-exclamation text-amber-600 mr-2"></i>Critical Low
                                Stock
                            </h3>
                            <button onclick="nav('purchases')" class="text-xs text-karta-primary hover:underline">Order
                                Stock</button>
                        </div>
                        <div class="table-container">
                            <table class="w-full text-left text-xs min-w-[500px]">
                                <thead class="bg-white/5 text-gray-400">
                                    <tr>
                                        <th class="p-3">Product</th>
                                        <th class="p-3">SKU</th>
                                        <th class="p-3">Supplier</th>
                                        <th class="p-3 text-right">Stock</th>
                                        <th class="p-3 text-right">Reorder Lvl</th>
                                    </tr>
                                </thead>
                                <tbody id="lowStockBody" class="divide-y divide-gray-800">
                                    <tr>
                                        <td colspan="5" class="p-8">
                                            <div class="empty-state">
                                                <div class="empty-state-icon"><i class="fa-solid fa-check-circle"></i>
                                                </div>
                                                <div class="empty-state-title">All Items in Stock</div>
                                                <div class="empty-state-text">No products are below their reorder
                                                    level
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Expired Products Alert -->
                    <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                        <div class="p-4 border-b border-karta-border flex justify-between items-center">
                            <h3 class="font-bold text-white text-sm"><i
                                    class="fa-solid fa-calendar-xmark text-red-600 mr-2"></i>Expired Products Alert
                            </h3>
                            <button onclick="nav('inventory')" class="text-xs text-karta-primary hover:underline">View &
                                Remove</button>
                        </div>
                        <div class="table-container">
                            <table class="w-full text-left text-xs min-w-[500px]">
                                <thead class="bg-white/5 text-gray-400">
                                    <tr>
                                        <th class="p-3">Product</th>
                                        <th class="p-3">SKU</th>
                                        <th class="p-3">Batch</th>
                                        <th class="p-3 text-center">Expiry Date</th>
                                        <th class="p-3 text-right">Stock</th>
                                        <th class="p-3 text-center">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="expiredBody" class="divide-y divide-gray-800">
                                    <tr>
                                        <td colspan="6" class="p-8">
                                            <div class="empty-state">
                                                <div class="empty-state-icon"><i class="fa-solid fa-calendar-check"></i>
                                                </div>
                                                <div class="empty-state-title">No Expired Products</div>
                                                <div class="empty-state-text">All products are within their expiry
                                                    dates
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- POS TERMINAL -->
                <section id="pos" class="hidden h-full flex flex-col md:flex-row gap-4 pb-20 md:pb-0">
                    <!-- Left: Catalog -->
                    <div class="w-full md:w-2/3 flex flex-col gap-4 h-auto md:h-full order-1">
                        <div
                            class="bg-karta-surface p-3 rounded-lg border border-karta-border flex flex-col md:flex-row items-center gap-3">
                            <div class="relative flex-1">
                                <i class="fa-solid fa-search absolute left-3 top-3 text-gray-500"></i>
                                <input type="text" id="posSearch" placeholder="Scan Barcode or Search..."
                                    class="input-field pl-10 h-10 md:h-full">
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-24">
                                    <input type="number" id="posQtyInput" value="1" min="1"
                                        class="input-field text-center h-10" placeholder="Qty">
                                </div>
                                <select id="posCatFilter" class="input-field md:w-40 h-10">
                                    <option value="all">All Cats</option>
                                </select>
                                <div class="flex items-center bg-gray-800/30 px-2 py-1 rounded border border-gray-700">
                                    <i class="fa-solid fa-calendar-days text-gray-300 mr-2"></i>
                                    <!-- Dual inputs -->
                                    <input type="date" id="posManualDate" title="AD Date"
                                        class="bg-transparent text-xs text-gray-200 focus:outline-none w-24">
                                    <input type="text" id="posManualDateNep" placeholder="YYYY-MM-DD (BS)"
                                        class="bg-transparent text-xs text-karta-primary focus:outline-none w-24 hidden"
                                        title="BS Date">
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 md:overflow-y-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 content-start pr-1 min-h-[300px] auto-rows-max"
                            id="posGrid">
                            <!-- Products JS -->
                        </div>
                    </div>

                    <!-- Right: Cart -->
                    <div
                        class="w-full md:w-1/3 bg-karta-surface border border-karta-border rounded-lg flex flex-col h-auto md:h-full order-2 shrink-0">
                        <div class="p-3 border-b border-karta-border">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-white">Current Sale</h3>
                                <button onclick="clearCart()"
                                    class="text-xs text-red-400 hover:text-red-300">Clear</button>
                            </div>
                            <!-- Customer Select -->
                            <div class="relative mb-2">
                                <input list="custDataList" id="posCustomerInput" placeholder="Guest Customer (Walk-in)"
                                    class="input-field text-xs">
                                <datalist id="custDataList"></datalist>
                            </div>

                            <!-- Price Type Selector -->
                            <div class="flex gap-2 mb-2">
                                <label
                                    class="flex-1 flex items-center justify-center px-2 py-1 rounded border border-karta-border bg-karta-primary/20 text-xs cursor-pointer"
                                    title="Retail/Customer Price">
                                    <input type="radio" name="priceType" value="retail" checked onchange="renderCart()"
                                        class="mr-1"> Retail
                                </label>
                                <label
                                    class="flex-1 flex items-center justify-center px-2 py-1 rounded border border-karta-border hover:bg-white/5 text-xs cursor-pointer"
                                    title="Wholesale Price">
                                    <input type="radio" name="priceType" value="wholesale" onchange="renderCart()"
                                        class="mr-1"> Wholesale
                                </label>
                            </div>
                            <!-- Discount Input -->
                            <div class="flex gap-2 items-center">
                                <label class="text-xs text-gray-400 flex-1">Discount %</label>
                                <div class="flex items-center gap-1 flex-1">
                                    <input type="number" id="posDiscount" value="0" min="0" max="100" step="0.1"
                                        class="input-field text-right text-xs" onchange="renderCart()"
                                        onkeyup="renderCart()">
                                    <span class="text-xs text-gray-400">%</span>
                                </div>
                            </div>
                            <!-- Freight Charge Input (Optional) -->
                            <div class="flex gap-2 items-center">
                                <label class="text-xs text-gray-400 flex-1">Freight Charge</label>
                                <div class="flex items-center gap-1 flex-1">
                                    <input type="number" id="posFreight" value="0" min="0" step="0.01"
                                        class="input-field text-right text-xs" onchange="renderCart()"
                                        onkeyup="renderCart()" placeholder="Transport cost">
                                    <span class="text-xs text-gray-400">Rs.</span>
                                </div>
                            </div>
                        </div>

                        <div class="flex-1 md:overflow-y-auto p-2 space-y-1 min-h-[150px] max-h-[300px] md:max-h-none"
                            id="posCartBody">
                            <!-- Cart Items -->
                            <div class="flex h-full items-center justify-center text-gray-600 flex-col py-8 md:py-0">
                                <i class="fa-solid fa-basket-shopping text-4xl mb-2"></i>
                                <p>Cart is empty</p>
                            </div>
                        </div>

                        <!-- EDIT PRICE MODAL -->
                        <div id="editPriceModal"
                            class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-sm">
                            <h3 class="text-lg font-bold mb-4 text-white">Edit Item Price</h3>
                            <div class="bg-white/5 p-3 rounded mb-4 border border-gray-700">
                                <div class="text-sm text-gray-400 mb-1">Product: <span id="editPriceItemName"
                                        class="text-white font-bold">-</span></div>
                                <div class="text-sm text-gray-400">Original Price: <span id="editPriceOriginal"
                                        class="text-yellow-400 font-bold">-</span></div>
                            </div>
                            <div class="space-y-3 mb-6">
                                <div>
                                    <label class="text-xs text-gray-400 font-bold block mb-2">Retail Price</label>
                                    <input type="number" id="editPriceInput" class="input-field w-full" min="0"
                                        step="0.01" placeholder="Enter retail price">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400 font-bold block mb-2">Wholesale
                                        Price</label>
                                    <input type="number" id="editPriceWholesaleInput" class="input-field w-full" min="0"
                                        step="0.01" placeholder="Enter wholesale price">
                                </div>
                            </div>
                            <div class="flex gap-3 justify-end">
                                <button type="button" onclick="closeModal()"
                                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-white text-sm transition">Cancel</button>
                                <button type="button" onclick="applyEditPrice()"
                                    class="px-4 py-2 bg-karta-primary hover:bg-green-600 text-black font-bold rounded text-sm transition"><i
                                        class="fa-solid fa-save mr-1"></i>Save Price</button>
                            </div>
                        </div>

                        <div class="p-4 bg-white/5 border-t border-karta-border space-y-2">
                            <div class="flex justify-between text-xs text-gray-400 items-center">
                                <span>Subtotal</span>
                                <span id="posSubTotal">$0.00</span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-400 items-center">
                                <label class="flex items-center cursor-pointer select-none">
                                    <input type="checkbox" id="posVatToggle" checked onchange="renderCart()"
                                        class="mr-2"> Apply VAT (<span id="posVatRate">0</span>%)
                                </label>
                                <span id="posTax">$0.00</span>
                            </div>
                            <div
                                class="flex justify-between text-xl font-bold text-karta-primary border-t border-gray-700 pt-2">
                                <span>Total</span>
                                <span id="posTotal">$0.00</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <button onclick="checkout('credit')"
                                    class="bg-yellow-600 hover:bg-yellow-700 text-black py-3 rounded font-bold transition text-xs md:text-sm"><i
                                        class="fa-solid fa-credit-card mr-1"></i>Credit</button>
                                <button onclick="checkout('cash')"
                                    class="bg-karta-primary hover:bg-karta-primaryDark text-black py-3 rounded font-bold transition text-xs md:text-sm"><i
                                        class="fa-solid fa-money-bill mr-1"></i>Cash</button>
                                <button onclick="checkout('bank')"
                                    class="bg-blue-600 hover:bg-blue-700 text-black py-3 rounded font-bold transition text-xs md:text-sm"><i
                                        class="fa-solid fa-university mr-1"></i>Bank</button>
                                <button onclick="checkout('split')"
                                    class="bg-purple-600 hover:bg-purple-700 text-white py-3 rounded font-bold transition text-xs md:text-sm"><i
                                        class="fa-solid fa-arrows-split-up-and-left mr-1"></i>Split</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- INVOICES -->
                <section id="invoices" class="hidden space-y-6 pb-20 md:pb-0">
                    <!-- INVOICES SECTION WITH TABS -->
                    <div class="flex gap-2 mb-4 border-b border-gray-800">
                        <button onclick="switchInvoiceTab('sales')" id="tabSalesInv"
                            class="px-4 py-3 font-bold text-sm border-b-2 border-karta-primary text-karta-primary transition-all">
                            <i class="fa-solid fa-receipt mr-2"></i>Sales Invoices
                        </button>
                        <button onclick="switchInvoiceTab('purchase')" id="tabPurchaseInv"
                            class="px-4 py-3 font-bold text-sm border-b-2 border-transparent text-gray-400 hover:text-white transition-all">
                            <i class="fa-solid fa-file-invoice mr-2"></i>Purchase Invoices
                        </button>
                        <button onclick="switchInvoiceTab('settlement')" id="tabSettlement"
                            class="px-4 py-3 font-bold text-sm border-b-2 border-transparent text-gray-400 hover:text-white transition-all">
                            <i class="fa-solid fa-handshake mr-2"></i>Credit Settlement
                        </button>
                    </div>

                    <!-- TAB 1: SALES INVOICES -->
                    <div id="tabContentSales" class="space-y-6">
                        <div class="flex flex-col gap-4">
                            <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-end">
                                <input type="text" id="invoiceSearch" placeholder="Search Invoice # or Customer Name..."
                                    class="input-field flex-1" onkeyup="loadInvoices()">
                                <input type="date" id="invoiceDateFilter" class="input-field md:w-48"
                                    onchange="loadInvoices()" title="Filter by Date">
                                <input type="text" id="invoiceDateFilterNep"
                                    class="input-field md:w-48 hidden text-karta-primary" placeholder="Filter Date (BS)"
                                    title="Filter by Date (BS)">
                                <button onclick="clearInvoiceFilters()"
                                    class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded font-bold text-xs whitespace-nowrap">Clear
                                    All</button>
                            </div>
                        </div>
                        <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                            <div class="table-container">
                                <table class="w-full text-left text-sm min-w-[600px]">
                                    <thead class="bg-white/5 text-gray-400">
                                        <tr>
                                            <th class="p-3">Date</th>
                                            <th class="p-3">Invoice #</th>
                                            <th class="p-3">Customer</th>
                                            <th class="p-3 text-right">Amount</th>
                                            <th class="p-3 text-center">Status</th>
                                            <th class="p-3 text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="invoiceListBody" class="divide-y divide-gray-800">
                                        <tr>
                                            <td colspan="6" class="p-8">
                                                <div class="empty-state">
                                                    <div class="empty-state-icon"><i
                                                            class="fa-solid fa-file-invoice"></i></div>
                                                    <div class="empty-state-title">No Sales Invoices Yet</div>
                                                    <div class="empty-state-text">Create your first invoice from the
                                                        POS
                                                        terminal</div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 2: PURCHASE INVOICES -->
                    <div id="tabContentPurchase" class="space-y-6 hidden">
                        <div class="flex flex-col gap-4">
                            <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-end">
                                <div class="flex-1">
                                    <input type="date" id="purchInvFromDate" class="input-field w-full"
                                        placeholder="From Date" title="Filter from this date (AD)">
                                    <input type="text" id="purchInvFromDateNep"
                                        class="input-field w-full mt-1 hidden text-karta-primary"
                                        placeholder="From Date (BS)" title="Filter from this date (BS)">
                                </div>
                                <div class="flex-1">
                                    <input type="date" id="purchInvToDate" class="input-field w-full"
                                        placeholder="To Date" title="Filter to this date (AD)">
                                    <input type="text" id="purchInvToDateNep"
                                        class="input-field w-full mt-1 hidden text-karta-primary"
                                        placeholder="To Date (BS)" title="Filter to this date (BS)">
                                </div>
                                <button onclick="filterPurchaseInvoices()"
                                    class="flex-1 md:flex-none bg-karta-primary hover:bg-karta-primaryDark text-black px-4 py-2 rounded font-bold text-xs transition-all"><i
                                        class="fa-solid fa-filter mr-1"></i>Filter</button>
                                <button onclick="clearPurchaseFilters()"
                                    class="flex-1 md:flex-none bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded font-bold text-xs whitespace-nowrap">Clear
                                    All</button>
                            </div>
                        </div>
                        <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                            <div class="table-container">
                                <table class="w-full text-left text-sm min-w-[600px]">
                                    <thead class="bg-white/5 text-gray-400 border-b border-karta-border">
                                        <tr>
                                            <th class="p-3">Date</th>
                                            <th class="p-3">Invoice #</th>
                                            <th class="p-3">Supplier</th>
                                            <th class="p-3 text-right">Amount</th>
                                            <th class="p-3 text-center">Payment</th>
                                            <th class="p-3 text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="purchInvoiceBody" class="divide-y divide-gray-800">
                                        <!-- JS Populated -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 3: CREDIT SETTLEMENTS -->
                    <div id="tabContentSettlement" class="space-y-6 hidden">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                                <div class="text-gray-400 text-sm mb-1 flex items-center gap-2"><i
                                        class="fa-solid fa-handshake"></i> Total Settlements</div>
                                <div class="text-3xl font-bold text-karta-primary" id="settlementCount">0</div>
                            </div>
                            <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                                <div class="text-gray-400 text-sm mb-1 flex items-center gap-2"><i
                                        class="fa-solid fa-money-bill"></i> Cash Settled</div>
                                <div class="text-3xl font-bold text-green-500" id="settlementCashTotal">$0</div>
                            </div>
                            <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                                <div class="text-gray-400 text-sm mb-1 flex items-center gap-2"><i
                                        class="fa-solid fa-building"></i> Bank Settled</div>
                                <div class="text-3xl font-bold text-blue-500" id="settlementBankTotal">$0</div>
                            </div>
                            <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                                <div class="text-gray-400 text-sm mb-1 flex items-center gap-2"><i
                                        class="fa-solid fa-receipt"></i> Pending</div>
                                <div class="text-3xl font-bold text-yellow-500" id="settlementPendingCount">0</div>
                            </div>
                        </div>

                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                            <div class="flex gap-2 flex-col md:flex-row w-full md:w-auto">
                                <input type="text" id="settlementSearch"
                                    placeholder="Search by Customer/Supplier name..." class="input-field w-full md:w-96"
                                    oninput="renderSettlements()">
                                <select id="settlementTypeFilter" class="input-field w-full md:w-48"
                                    onchange="renderSettlements()">
                                    <option value="">All Types</option>
                                    <option value="customer">Customer Dues</option>
                                    <option value="supplier">Supplier Dues</option>
                                </select>
                            </div>
                            <div class="flex gap-2 w-full md:w-auto">
                                <button onclick="renderSettlements()"
                                    class="flex-1 md:flex-none bg-gray-700 text-white px-4 py-2 rounded font-bold hover:bg-gray-600 transition flex items-center justify-center gap-2"
                                    title="Refresh settlements list">
                                    <i class="fa-solid fa-refresh"></i> Refresh
                                </button>
                                <button onclick="openModal('newSettlementModal')"
                                    class="flex-1 md:flex-none bg-karta-primary text-black px-4 py-2 rounded font-bold hover:bg-karta-primaryDark transition flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-plus"></i> New Settlement
                                </button>
                            </div>
                        </div>

                        <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                            <div class="table-container">
                                <table class="w-full text-left text-sm min-w-[1000px]">
                                    <thead class="bg-white/5 text-gray-400 border-b border-karta-border">
                                        <tr>
                                            <th class="p-3">Settlement Date</th>
                                            <th class="p-3">Type</th>
                                            <th class="p-3">Name</th>
                                            <th class="p-3">Amount</th>
                                            <th class="p-3">Payment Method</th>
                                            <th class="p-3">Cheque #</th>
                                            <th class="p-3 text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="settlementBody" class="divide-y divide-gray-800"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- RETURNS & REFUNDS -->
                <section id="returns" class="hidden space-y-6 pb-20 md:pb-0">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                        <!-- LEFT: CUSTOMER RETURN (SALES RETURN) -->
                        <div class="bg-karta-surface border border-karta-border rounded-lg p-4 flex flex-col h-full">
                            <div class="border-b border-gray-700 pb-3 mb-3">
                                <h3 class="font-bold text-white text-lg"><i
                                        class="fa-solid fa-user-tag text-blue-500 mr-2"></i>Sales Return (From
                                    Customer)
                                </h3>
                                <p class="text-xs text-gray-400">Process customer returns. Restocks items & refunds
                                    payment.</p>
                            </div>

                            <div class="space-y-3 mb-auto">
                                <div>
                                    <label class="text-xs text-gray-400">Select Customer</label>
                                    <select id="retCustSelect" class="input-field"
                                        onchange="loadReturnProducts('cust')"></select>
                                </div>

                                <div>
                                    <label class="text-xs text-gray-400">Select Product to Return</label>
                                    <select id="retCustProd" class="input-field"
                                        onchange="updateReturnPrice('cust')"></select>
                                </div>

                                <div class="grid grid-cols-2 gap-2">
                                    <div class="bg-white/5 p-2 rounded border border-gray-700">
                                        <div class="text-xs text-gray-500">Price</div>
                                        <div class="text-lg font-bold text-white" id="retCustPrice">-</div>
                                    </div>
                                    <div class="bg-white/5 p-2 rounded border border-gray-700">
                                        <div class="text-xs text-gray-500">Max Qty</div>
                                        <div class="text-lg font-bold text-white" id="retCustQtyPurchased">-</div>
                                    </div>
                                </div>

                                <div>
                                    <label class="text-xs text-gray-400">Quantity to Return</label>
                                    <input type="number" id="retCustQty" class="input-field text-sm" value="1" min="1"
                                        onchange="updateReturnPrice('cust')">
                                </div>

                                <button onclick="addToReturnCart('cust')"
                                    class="w-full bg-karta-primary text-black py-2 rounded font-bold text-sm hover:bg-karta-primaryDark transition">
                                    <i class="fa-solid fa-plus mr-1"></i> Add to Return Cart
                                </button>
                            </div>

                            <!-- Return Cart -->
                            <div class="border-t border-gray-700 mt-3 pt-3">
                                <p class="text-xs text-gray-400 mb-2">Return Items (<span
                                        id="retCustCartCount">0</span>):</p>
                                <div id="retCustCart" class="space-y-1 max-h-48 overflow-y-auto mb-3">
                                    <p class="text-xs text-gray-600">No items added</p>
                                </div>

                                <div class="bg-white/5 p-2 rounded border border-gray-700 mb-3 space-y-1">
                                    <div class="flex justify-between text-xs text-gray-400">
                                        <span>Subtotal:</span>
                                        <span class="font-bold text-gray-300" id="retCustSubtotal">$0.00</span>
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-400">
                                        <span>VAT (13%):</span>
                                        <span class="font-bold text-yellow-400" id="retCustVAT">$0.00</span>
                                    </div>
                                    <div
                                        class="flex justify-between text-sm text-gray-300 border-t border-gray-600 pt-1">
                                        <span>Grand Total:</span>
                                        <span class="font-bold text-karta-primary" id="retCustTotal">$0.00</span>
                                    </div>
                                </div>

                                <!-- Payment Method -->
                                <div class="mb-3">
                                    <label class="text-xs text-gray-400 mb-2 block">Refund Mode</label>
                                    <div class="grid grid-cols-2 gap-1">
                                        <label
                                            class="flex items-center px-2 py-1 rounded border border-karta-border bg-karta-primary/20 text-xs cursor-pointer">
                                            <input type="radio" name="retCustPayment" value="cash" checked
                                                onchange="toggleReturnSplit('cust')"> Cash
                                        </label>
                                        <label
                                            class="flex items-center px-2 py-1 rounded border border-karta-border hover:bg-white/5 text-xs cursor-pointer">
                                            <input type="radio" name="retCustPayment" value="bank"
                                                onchange="toggleReturnSplit('cust')"> Bank
                                        </label>
                                        <label
                                            class="flex items-center px-2 py-1 rounded border border-karta-border hover:bg-white/5 text-xs cursor-pointer">
                                            <input type="radio" name="retCustPayment" value="credit"
                                                onchange="toggleReturnSplit('cust')"> Credit
                                        </label>
                                        <label
                                            class="flex items-center px-2 py-1 rounded border border-karta-border hover:bg-white/5 text-xs cursor-pointer">
                                            <input type="radio" name="retCustPayment" value="split"
                                                onchange="toggleReturnSplit('cust')"> Split
                                        </label>
                                    </div>
                                </div>

                                <!-- Split Payment Input (Hidden by default) -->
                                <div id="retCustSplitDiv"
                                    class="hidden bg-white/5 p-3 rounded border border-karta-border space-y-2">
                                    <p class="text-xs text-gray-400 font-bold">Split Payment:</p>
                                    <div class="flex gap-1">
                                        <div class="flex-1">
                                            <label class="text-xs text-gray-500">Cash</label>
                                            <input type="number" id="retCustSplitCash" class="input-field text-xs"
                                                placeholder="0" min="0" step="0.01" onchange="autoCalculateSplitCust()">
                                        </div>
                                        <div class="flex-1">
                                            <label class="text-xs text-gray-500">Bank</label>
                                            <input type="number" id="retCustSplitBank" class="input-field text-xs"
                                                placeholder="0" min="0" step="0.01" onchange="autoCalculateSplitCust()">
                                        </div>
                                        <div class="flex-1">
                                            <label class="text-xs text-gray-500">Credit</label>
                                            <input type="number" id="retCustSplitCredit" class="input-field text-xs"
                                                placeholder="0" min="0" step="0.01" onchange="autoCalculateSplitCust()">
                                        </div>
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-400">
                                        <span>Total:</span>
                                        <span id="retCustSplitTotal" class="font-bold">$0.00</span>
                                    </div>
                                </div>

                                <button onclick="processReturn('cust')"
                                    class="w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded font-bold text-sm transition">
                                    <i class="fa-solid fa-check mr-1"></i> Process Refund
                                </button>
                                <button onclick="clearReturnCart('cust')"
                                    class="w-full bg-gray-700 hover:bg-gray-600 text-white py-1 rounded text-xs mt-1 transition">Clear
                                    Cart</button>
                            </div>
                        </div>

                        <!-- RIGHT: SUPPLIER RETURN (PURCHASE RETURN) -->
                        <div class="bg-karta-surface border border-karta-border rounded-lg p-4 flex flex-col h-full">
                            <div class="border-b border-gray-700 pb-3 mb-3">
                                <h3 class="font-bold text-white text-lg"><i
                                        class="fa-solid fa-truck-ramp-box text-orange-500 mr-2"></i>Purchase Return
                                    (To
                                    Supplier)</h3>
                                <p class="text-xs text-gray-400">Return items to supplier. Reduces stock & balance.
                                </p>
                            </div>

                            <div class="space-y-3 mb-auto">
                                <div>
                                    <label class="text-xs text-gray-400">Select Supplier</label>
                                    <select id="retSupSelect" class="input-field"
                                        onchange="loadReturnProductsSupplier()"></select>
                                </div>

                                <div>
                                    <label class="text-xs text-gray-400">Select Product to Return</label>
                                    <select id="retSupProd" class="input-field"
                                        onchange="updateReturnPrice('sup')"></select>
                                </div>

                                <div class="grid grid-cols-2 gap-2">
                                    <div class="bg-white/5 p-2 rounded border border-gray-700">
                                        <div class="text-xs text-gray-500">Cost</div>
                                        <div class="text-lg font-bold text-white" id="retSupCost">-</div>
                                    </div>
                                    <div class="bg-white/5 p-2 rounded border border-gray-700">
                                        <div class="text-xs text-gray-500">Stock</div>
                                        <div class="text-lg font-bold text-white" id="retSupStock">-</div>
                                    </div>
                                </div>

                                <div>
                                    <label class="text-xs text-gray-400">Quantity to Return</label>
                                    <input type="number" id="retSupQty" class="input-field text-sm" value="1" min="1"
                                        onchange="updateReturnPrice('sup')">
                                </div>

                                <div>
                                    <label class="text-xs text-gray-400">Reason / Notes</label>
                                    <input type="text" id="retSupReason" class="input-field text-sm"
                                        placeholder="e.g. Expired, Damaged">
                                </div>

                                <button onclick="addToReturnCart('sup')"
                                    class="w-full bg-karta-primary text-black py-2 rounded font-bold text-sm hover:bg-karta-primaryDark transition">
                                    <i class="fa-solid fa-plus mr-1"></i> Add to Return Cart
                                </button>
                            </div>

                            <!-- Return Cart -->
                            <div class="border-t border-gray-700 mt-3 pt-3">
                                <p class="text-xs text-gray-400 mb-2">Return Items (<span
                                        id="retSupCartCount">0</span>):</p>
                                <div id="retSupCart" class="space-y-1 max-h-48 overflow-y-auto mb-3">
                                    <p class="text-xs text-gray-600">No items added</p>
                                </div>

                                <div class="bg-white/5 p-2 rounded border border-gray-700 mb-3 space-y-1">
                                    <div class="flex justify-between text-xs text-gray-400">
                                        <span>Subtotal:</span>
                                        <span class="font-bold text-gray-300" id="retSupSubtotal">$0.00</span>
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-400">
                                        <span>VAT (13%):</span>
                                        <span class="font-bold text-yellow-400" id="retSupVAT">$0.00</span>
                                    </div>
                                    <div
                                        class="flex justify-between text-sm text-gray-300 border-t border-gray-600 pt-1">
                                        <span>Grand Total:</span>
                                        <span class="font-bold text-karta-primary" id="retSupTotal">$0.00</span>
                                    </div>
                                </div>

                                <!-- Payment Method -->
                                <div class="mb-3">
                                    <label class="text-xs text-gray-400 mb-2 block">Payment Mode</label>
                                    <div class="grid grid-cols-2 gap-1">
                                        <label
                                            class="flex items-center px-2 py-1 rounded border border-karta-border bg-karta-primary/20 text-xs cursor-pointer">
                                            <input type="radio" name="retSupPayment" value="cash" checked
                                                onchange="toggleReturnSplit('sup')"> Cash
                                        </label>
                                        <label
                                            class="flex items-center px-2 py-1 rounded border border-karta-border hover:bg-white/5 text-xs cursor-pointer">
                                            <input type="radio" name="retSupPayment" value="bank"
                                                onchange="toggleReturnSplit('sup')"> Bank
                                        </label>
                                        <label
                                            class="flex items-center px-2 py-1 rounded border border-karta-border hover:bg-white/5 text-xs cursor-pointer">
                                            <input type="radio" name="retSupPayment" value="credit"
                                                onchange="toggleReturnSplit('sup')"> Credit
                                        </label>
                                        <label
                                            class="flex items-center px-2 py-1 rounded border border-karta-border hover:bg-white/5 text-xs cursor-pointer">
                                            <input type="radio" name="retSupPayment" value="split"
                                                onchange="toggleReturnSplit('sup')"> Split
                                        </label>
                                    </div>
                                </div>

                                <!-- Split Payment Input (Hidden by default) -->
                                <div id="retSupSplitDiv"
                                    class="hidden bg-white/5 p-3 rounded border border-karta-border space-y-2">
                                    <p class="text-xs text-gray-400 font-bold">Split Payment:</p>
                                    <div class="flex gap-1">
                                        <div class="flex-1">
                                            <label class="text-xs text-gray-500">Cash</label>
                                            <input type="number" id="retSupSplitCash" class="input-field text-xs"
                                                placeholder="0" min="0" step="0.01" onchange="autoCalculateSplitSup()">
                                        </div>
                                        <div class="flex-1">
                                            <label class="text-xs text-gray-500">Bank</label>
                                            <input type="number" id="retSupSplitBank" class="input-field text-xs"
                                                placeholder="0" min="0" step="0.01" onchange="autoCalculateSplitSup()">
                                        </div>
                                        <div class="flex-1">
                                            <label class="text-xs text-gray-500">Credit</label>
                                            <input type="number" id="retSupSplitCredit" class="input-field text-xs"
                                                placeholder="0" min="0" step="0.01" onchange="autoCalculateSplitSup()">
                                        </div>
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-400">
                                        <span>Total:</span>
                                        <span id="retSupSplitTotal" class="font-bold">$0.00</span>
                                    </div>
                                </div>

                                <button onclick="processReturn('sup')"
                                    class="w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded font-bold text-sm transition">
                                    <i class="fa-solid fa-check mr-1"></i> Process Return
                                </button>
                                <button onclick="clearReturnCart('sup')"
                                    class="w-full bg-gray-700 hover:bg-gray-600 text-white py-1 rounded text-xs mt-1 transition">Clear
                                    Cart</button>
                            </div>
                        </div>

                    </div>
                </section>

                <!-- INVENTORY -->
                <section id="inventory" class="hidden space-y-6 pb-20 md:pb-0">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div class="flex gap-2 w-full md:w-auto">
                            <input type="text" id="invSearch" placeholder="Search Inventory..."
                                class="input-field w-full md:w-64">
                        </div>
                        <div class="flex gap-2 flex-col md:flex-row w-full md:w-auto">
                            <button onclick="openModal('priceManagerModal')"
                                class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold flex items-center justify-center gap-2 text-sm">
                                <i class="fa-solid fa-percent"></i> Bulk Price Adjust
                            </button>
                            <button
                                onclick="document.getElementById('prodId').value=''; document.getElementById('prodForm').reset(); openModal('prodModal')"
                                class="w-full md:w-auto bg-karta-primary text-black px-4 py-2 rounded font-bold hover:bg-karta-primaryDark transition flex items-center justify-center gap-2">
                                <i class="fa-solid fa-plus"></i> New Product
                            </button>
                        </div>
                    </div>

                    <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                        <div class="table-container">
                            <table class="w-full text-left text-sm min-w-[1000px]">
                                <thead class="bg-white/5 text-gray-400 border-b border-karta-border">
                                    <tr>
                                        <th class="p-3">Product Name</th>
                                        <th class="p-3">SKU</th>
                                        <th class="p-3">Batch/Expiry</th>
                                        <th class="p-3">Category</th>
                                        <th class="p-3 text-right">Stock</th>
                                        <th class="p-3 text-right">Cost</th>
                                        <th class="p-3 text-right">Retail Price</th>
                                        <th class="p-3 text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="invBody" class="divide-y divide-gray-800">
                                    <tr>
                                        <td colspan="8" class="p-8">
                                            <div class="empty-state">
                                                <div class="empty-state-icon"><i class="fa-solid fa-box-open"></i>
                                                </div>
                                                <div class="empty-state-title">No Products Yet</div>
                                                <div class="empty-state-text">Add your first product using the "New
                                                    Product" button above</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- CUSTOMERS -->
                <section id="customers" class="hidden space-y-6 pb-20 md:pb-0">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                            <div class="text-gray-400 text-sm mb-1 flex items-center gap-2"><i
                                    class="fa-solid fa-users"></i> Total Customers</div>
                            <div class="text-3xl font-bold text-karta-primary" id="custCount">0</div>
                        </div>
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                            <div class="text-gray-400 text-sm mb-1 flex items-center gap-2"><i
                                    class="fa-solid fa-credit-card"></i> Total Due</div>
                            <div class="text-3xl font-bold text-red-500" id="custTotalDue">$0</div>
                        </div>
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                            <div class="text-gray-400 text-sm mb-1 flex items-center gap-2"><i
                                    class="fa-solid fa-handshake"></i> Active Customers</div>
                            <div class="text-3xl font-bold text-green-500" id="custActive">0</div>
                        </div>
                    </div>
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <input type="text" id="custSearch" placeholder="Search Customers..."
                            class="input-field w-full md:w-80">
                        <button
                            onclick="document.getElementById('custId').value=''; document.getElementById('custForm').reset(); openModal('custModal')"
                            class="w-full md:w-auto bg-karta-primary text-black px-4 py-2 rounded font-bold hover:bg-karta-primaryDark transition">
                            <i class="fa-solid fa-user-plus"></i> Add Customer
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="custGrid">
                        <!-- Customer Cards JS -->
                        <div class="col-span-full">
                            <div class="empty-state">
                                <div class="empty-state-icon"><i class="fa-solid fa-user-group"></i></div>
                                <div class="empty-state-title">No Customers Yet</div>
                                <div class="empty-state-text">Click "Add Customer" to create a new customer profile
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SUPPLIERS -->
                <section id="suppliers" class="hidden space-y-6 pb-20 md:pb-0">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                            <div class="text-gray-400 text-sm mb-1 flex items-center gap-2"><i
                                    class="fa-solid fa-truck"></i> Total Suppliers</div>
                            <div class="text-3xl font-bold text-karta-primary" id="supCount">0</div>
                        </div>
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                            <div class="text-gray-400 text-sm mb-1 flex items-center gap-2"><i
                                    class="fa-solid fa-money-check"></i> Total Payable</div>
                            <div class="text-3xl font-bold text-orange-500" id="supTotalDue">$0</div>
                        </div>
                        <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                            <div class="text-gray-400 text-sm mb-1 flex items-center gap-2"><i
                                    class="fa-solid fa-inbox"></i> Total Purchased</div>
                            <div class="text-3xl font-bold text-blue-500" id="supTotalPurchased">$0</div>
                        </div>
                    </div>
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <input type="text" id="supSearch" placeholder="Search Suppliers..."
                            class="input-field w-full md:w-64">
                        <button
                            onclick="document.getElementById('supId').value=''; document.getElementById('supForm').reset(); openModal('supModal')"
                            class="w-full md:w-auto bg-karta-primary text-black px-4 py-2 rounded font-bold hover:bg-karta-primaryDark transition">
                            <i class="fa-solid fa-truck"></i> Add Supplier
                        </button>
                    </div>
                    <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                        <div class="table-container">
                            <table class="w-full text-left text-sm min-w-[700px]">
                                <thead class="bg-white/5 text-gray-400">
                                    <tr>
                                        <th class="p-3">Company Name</th>
                                        <th class="p-3">Contact Person</th>
                                        <th class="p-3">Phone</th>
                                        <th class="p-3">Tax/VAT ID</th>
                                        <th class="p-3 text-right">Balance Due</th>
                                        <th class="p-3 text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="supBody" class="divide-y divide-gray-800">
                                    <tr>
                                        <td colspan="6" class="p-8">
                                            <div class="empty-state">
                                                <div class="empty-state-icon"><i class="fa-solid fa-truck"></i>
                                                </div>
                                                <div class="empty-state-title">No Suppliers Yet</div>
                                                <div class="empty-state-text">Click "Add Supplier" to create a new
                                                    supplier account</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- PRODUCT SUPPLIER ASSIGNMENT -->
                <section id="productSuppliers" class="hidden space-y-6 pb-20 md:pb-0">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-white">Product Supplier Management</h2>
                        <p class="text-xs text-gray-400">Assign products to specific suppliers</p>
                    </div>

                    <div class="space-y-4">
                        <div class="flex flex-col md:flex-row gap-4">
                            <input type="text" id="psmSearch" placeholder="Search products..."
                                class="input-field flex-1" oninput="renderProductSupplierAssignment()">
                            <select id="psmSupplierFilter" class="input-field md:w-64"
                                onchange="renderProductSupplierAssignment()">
                                <option value="">-- All Suppliers --</option>
                            </select>
                        </div>

                        <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                            <div class="table-container">
                                <table class="w-full text-left text-sm min-w-[800px]">
                                    <thead class="bg-white/5 text-gray-400 border-b border-karta-border">
                                        <tr>
                                            <th class="p-3">Product Name</th>
                                            <th class="p-3">SKU</th>
                                            <th class="p-3">Current Supplier</th>
                                            <th class="p-3">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="psmBody" class="divide-y divide-gray-800"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SUPPLIER ASSIGNMENT MODAL -->
                <div id="assignSupplierModal"
                    class="hidden modal-content bg-karta-surface border border-karta-border p-8 rounded-lg w-full max-w-md">
                    <h3 class="text-xl font-bold mb-6 text-white">Assign Supplier to Product</h3>
                    <div id="assignProdInfo" class="bg-white/5 p-4 rounded mb-6 border border-gray-700">
                        <div class="text-base text-gray-400">Product: <span id="assignProdName"
                                class="text-white font-bold text-lg">-</span></div>
                        <div class="text-sm text-gray-500 mt-2">SKU: <span id="assignProdSKU"
                                class="text-gray-300 font-mono">-</span></div>
                        <div id="assignCurrentSupplier"
                            class="text-sm text-gray-400 mt-3 pt-3 border-t border-gray-600">
                            Current: <span id="assignCurrentSupplierName"
                                class="text-yellow-400 font-bold">Unassigned</span>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="text-sm text-gray-400 block mb-3">Select Supplier</label>
                        <select id="assignSupplierSelect" class="input-field w-full text-base">
                            <option value="">-- No Supplier (Unassign) --</option>
                        </select>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="unassignProductSupplier()"
                            class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded text-white text-sm font-bold transition"
                            title="Remove supplier assignment">
                            <i class="fa-solid fa-unlink mr-1"></i> Unassign
                        </button>
                        <button type="button" onclick="closeModal()"
                            class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-white text-sm transition">Cancel</button>
                        <button type="button" onclick="saveProductSupplierAssignment()"
                            class="px-4 py-2 bg-karta-primary hover:bg-green-600 text-black font-bold rounded text-sm transition">
                            <i class="fa-solid fa-check mr-1"></i> Assign
                        </button>
                    </div>
                </div>

                <!-- PURCHASES & EXPENSES -->
                <section id="purchases" class="hidden space-y-6 pb-20 md:pb-0">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                        <h3 class="text-white font-bold text-lg">Transactions & Expenses</h3>
                        <div class="flex gap-2 w-full md:w-auto">
                            <button onclick="openModal('expModal')"
                                class="flex-1 md:flex-none bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-bold text-xs md:text-sm">
                                <i class="fa-solid fa-receipt"></i> Record Expense
                            </button>

                            <button onclick="openModal('assetModal')"
                                class="flex-1 md:flex-none bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded font-bold text-xs md:text-sm">
                                <i class="fa-solid fa-box"></i> Purchase Asset
                            </button>

                            <button onclick="openModal('purchModal')"
                                class="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold text-xs md:text-sm">
                                <i class="fa-solid fa-cart-shopping"></i> Purchase Order
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-karta-surface border border-karta-border rounded-lg p-4 h-96 overflow-y-auto">
                            <h4 class="font-bold mb-3 text-karta-primary">Purchase History (GRN)</h4>
                            <div id="purchHistory" class="space-y-2"></div>
                        </div>
                        <div class="bg-karta-surface border border-karta-border rounded-lg p-4 h-96 overflow-y-auto">
                            <h4 class="font-bold mb-3 text-red-500">Expense Log</h4>
                            <div id="expHistory" class="space-y-2"></div>
                        </div>
                        <div class="bg-karta-surface border border-karta-border rounded-lg p-4 h-96 overflow-y-auto">
                            <h4 class="font-bold mb-3 text-purple-500">Assets Purchased</h4>
                            <div id="assetHistory" class="space-y-2"></div>
                        </div>
                    </div>

                    <!-- Batch Tracking -->
                    <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                        <div class="p-4 border-b border-karta-border flex justify-between items-center">
                            <h3 class="font-bold text-white text-sm"><i
                                    class="fa-solid fa-layer-group text-blue-400 mr-2"></i>Stock Batches (Old & New)
                            </h3>
                            <button onclick="loadBatches()"
                                class="text-xs text-karta-primary hover:underline">Refresh</button>
                        </div>
                        <div class="table-container">
                            <table class="w-full text-left text-xs min-w-[900px]">
                                <thead class="bg-white/5 text-gray-400">
                                    <tr>
                                        <th class="p-3">Product</th>
                                        <th class="p-3">Batch Number</th>
                                        <th class="p-3">Expiry Date</th>
                                        <th class="p-3 text-right">Qty</th>
                                        <th class="p-3 text-right">Cost/Unit</th>
                                        <th class="p-3">Purchase Date</th>
                                        <th class="p-3">Supplier</th>
                                    </tr>
                                </thead>
                                <tbody id="batchBody" class="divide-y divide-gray-800">
                                    <!-- JS Populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- REPORTS -->
                <section id="reports" class="hidden space-y-6 pb-20 md:pb-0">
                    <div class="bg-karta-surface border border-karta-border p-4 rounded-lg flex flex-col gap-4">
                        <div class="flex flex-col md:flex-row gap-4 items-end">
                            <div class="w-full md:w-auto">
                                <label class="text-xs text-gray-400">From Date</label>
                                <input type="date" id="repFrom" class="input-field" title="Adjust date (AD)">
                                <input type="text" id="repFromNep" class="input-field hidden text-karta-primary mt-1"
                                    placeholder="YYYY-MM-DD (BS)" title="Adjust date (BS)">
                            </div>
                            <div class="w-full md:w-auto">
                                <label class="text-xs text-gray-400">To Date</label>
                                <input type="date" id="repTo" class="input-field" title="Adjust date (AD)">
                                <input type="text" id="repToNep" class="input-field hidden text-karta-primary mt-1"
                                    placeholder="YYYY-MM-DD (BS)" title="Adjust date (BS)">
                            </div>
                            <div class="w-full md:flex-1 flex justify-end gap-2">
                                <button onclick="exportReportCSV()"
                                    class="flex-1 md:flex-none bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded font-bold flex items-center justify-center gap-2 text-xs md:text-sm"><i
                                        class="fa-solid fa-file-csv"></i> Export CSV</button>
                                <button onclick="printReport()"
                                    class="flex-1 md:flex-none bg-white text-black px-4 py-2 rounded font-bold flex items-center justify-center gap-2 text-xs md:text-sm"><i
                                        class="fa-solid fa-print"></i> Print Report</button>
                            </div>
                        </div>
                        <div id="agingDateContainer" class="hidden">
                            <label class="text-xs text-gray-400">As of Date (for Aging Reports)</label>
                            <input type="date" id="agingAsOfDate" class="input-field"
                                title="Select date for aging calculation">
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2">
                            <button onclick="runReports('daily')"
                                class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs">Daily
                                Report</button>
                            <button onclick="runReports('sales')"
                                class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs">Sales
                                Report</button>
                            <button onclick="runReports('vat')"
                                class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs">VAT
                                Report</button>
                            <button onclick="runReports('purchase')"
                                class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs">Purchase
                                Report</button>
                            <button onclick="runReports('expense')"
                                class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs">Expense
                                Report</button>
                            <button onclick="runReports('balance')"
                                class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs">Financial
                                Statements</button>
                            <button onclick="runReports('debtors')"
                                class="bg-red-700 hover:bg-red-600 text-white py-2 rounded text-xs">Debtors
                                List</button>
                            <button onclick="runReports('aging')"
                                class="bg-orange-700 hover:bg-orange-600 text-white py-2 rounded text-xs">Debtors
                                Aging</button>
                            <button onclick="runReports('creditors_aging')"
                                class="bg-purple-700 hover:bg-purple-600 text-white py-2 rounded text-xs">Creditors
                                Aging</button>
                            <button onclick="runReports('journal')"
                                class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs">Journal
                                Book</button>
                            <button onclick="runReports('ledger')"
                                class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs">General
                                Ledger</button>
                            <button onclick="runReports('trial')"
                                class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs">Trial
                                Balance</button>
                        </div>
                        <div id="debtorFilterContainer" class="hidden">
                            <label class="text-xs text-gray-400">Search by Location</label>
                            <input type="text" id="debtorLocationSearch" placeholder="e.g., Bharatpur"
                                class="input-field" onkeyup="filterDebtorsReport()">
                        </div>
                    </div>

                    <!-- Dynamic Report Title -->
                    <h3 id="reportTitle" class="text-xl font-bold text-white">Select a Report</h3>

                    <!-- Dynamic Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="reportCards">
                        <!-- Injected via JS -->
                    </div>

                    <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                        <div class="p-3 bg-white/5 font-bold">Details</div>
                        <div class="table-container">
                            <table class="w-full text-left text-xs min-w-[500px]">
                                <thead class="text-gray-400 border-b border-gray-700" id="repHead"></thead>
                                <tbody id="repTable" class="divide-y divide-gray-800"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- SETTINGS -->
                <section id="settings" class="hidden space-y-6 max-w-2xl pb-20 md:pb-0">
                    <div class="bg-karta-surface border border-karta-border rounded-lg p-6">
                        <h3 class="text-xl font-bold mb-4 text-karta-primary">Business Configuration & Setup</h3>
                        <form id="settingsForm" class="space-y-4">
                            <!-- BUSINESS TYPE SELECTION -->
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Business Type *</label>
                                <select id="confBusinessType" class="input-field">
                                    <option value="general">General/Other Business</option>
                                    <option value="wholesale">Wholesale/Distributor</option>
                                    <option value="retail">Retail Store</option>
                                    <option value="pharmacy">Pharmacy</option>
                                    <option value="services">Services Business</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Select your business type for better
                                    organization
                                    and compliance.</p>
                            </div>

                            <!-- LOGO UPLOAD SECTION -->
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Brand Logo</label>
                                <div class="flex items-center gap-4">
                                    <div
                                        class="h-16 w-16 bg-gray-800 rounded flex items-center justify-center overflow-hidden border border-gray-700 shrink-0">
                                        <img id="confLogoPreview" src="" class="h-full w-full object-contain hidden">
                                        <i id="confLogoPlaceholder" class="fa-solid fa-image text-gray-600"></i>
                                    </div>
                                    <input type="file" id="confLogoInput" accept="image/*"
                                        class="text-xs text-gray-400 w-full">
                                    <button type="button" onclick="clearLogo()"
                                        class="text-xs text-red-500 hover:text-red-400">Remove</button>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Company Name</label>
                                <input type="text" id="confName" class="input-field">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Address</label>
                                <input type="text" id="confAddr" class="input-field">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Phone</label>
                                    <input type="text" id="confPhone" class="input-field">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Tax/VAT ID</label>
                                    <input type="text" id="confTax" class="input-field">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Default VAT Rate (%)</label>
                                    <input type="number" id="confVatRate" class="input-field">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Currency Symbol</label>
                                    <input type="text" id="confCurr" class="input-field">
                                </div>
                            </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Initial Cash on Hand (Opening
                                Balance)</label>
                            <input type="number" id="confInitialCash" step="0.01" class="input-field"
                                placeholder="0.00">
                            <p class="text-xs text-gray-500 mt-1">Cash at business start.</p>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Initial Bank Balance</label>
                            <input type="number" id="confInitialBank" step="0.01" class="input-field"
                                placeholder="0.00">
                            <p class="text-xs text-gray-500 mt-1">Bank funds at business start.</p>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Date System</label>
                            <select id="confDateMode" class="input-field">
                                <option value="english">English (AD)</option>
                                <option value="nepali">Nepali (BS)</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Choose your preferred calendar system for invoices and
                                reports.</p>
                        </div>
                    </div>
                    <button type="submit"
                        class="w-full md:w-auto bg-karta-primary text-black font-bold py-2 px-6 rounded hover:bg-green-600">Save
                        Changes</button>
                    </form>

                    <div class="mt-10 pt-6 border-t border-gray-700 space-y-4">
                        <h4 class="font-bold text-white">Invoice Settings</h4>

                        <!-- INVOICE NUMBER MANAGEMENT -->
                        <div class="p-4 bg-white/5 rounded border border-gray-700 mb-4">
                            <h5 class="text-karta-primary font-bold mb-2"><i class="fa-solid fa-receipt"></i>
                                Sales
                                Invoice Numbering</h5>
                            <p class="text-xs text-gray-400 mb-3">Control how your sales invoices are numbered.
                            </p>

                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-2">Current Invoice
                                        Number</label>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="currentInvoiceNumber" class="input-field flex-1"
                                            readonly>
                                        <span class="text-xs text-gray-500">(Auto-generated)</span>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-2">Reset Starting
                                            Number</label>
                                        <input type="number" id="invoiceStartNumber" class="input-field"
                                            placeholder="e.g., 1001" value="1">
                                    </div>
                                    <div class="flex items-end">
                                        <button type="button" onclick="resetInvoiceNumbering()"
                                            class="w-full bg-orange-700 text-white px-4 py-2 rounded text-xs hover:bg-orange-600 text-center">
                                            <i class="fa-solid fa-redo"></i> Reset & Start Fresh
                                        </button>
                                    </div>
                                </div>

                                <div
                                    class="flex items-center gap-2 p-2 bg-blue-900/20 rounded border border-blue-700/50">
                                    <input type="checkbox" id="autoInvoiceNumber" class="w-4 h-4" checked>
                                    <label for="autoInvoiceNumber"
                                        class="text-xs text-gray-300 cursor-pointer">Auto-increment invoice
                                        numbers
                                        (recommended)</label>
                                </div>

                                <p class="text-xs text-gray-500 mt-2">
                                    <i class="fa-solid fa-info-circle"></i> Next invoice will be #<span
                                        id="nextInvoicePreview">1</span>
                                </p>
                            </div>
                        </div>

                        <div class="mt-10 pt-6 border-t border-gray-700 space-y-4">
                            <h4 class="font-bold text-white">Data Management</h4>

                            <!-- FIREBASE CLOUD SYNC -->
                            <div class="p-4 bg-white/5 rounded border border-gray-700 mb-4">
                                <h5 class="text-karta-primary font-bold mb-2"><i class="fa-solid fa-cloud"></i>
                                    Private Database</h5>
                                <p class="text-xs text-gray-400 mb-3">You are connected to your private isolated
                                    database. Data is synced in real-time only to your account.</p>
                                <div class="text-xs text-green-500"><i class="fa-solid fa-check-circle"></i>
                                    Status:
                                    Secured & Synced</div>
                                <div class="mt-2 text-xs text-gray-500">Database ID: <span id="dbIdDisplay"
                                        class="font-mono text-white">...</span></div>
                            </div>

                            <div class="flex flex-col md:flex-row gap-4">
                                <button onclick="exportDB()"
                                    class="bg-gray-700 text-white px-4 py-2 rounded text-xs hover:bg-gray-600 text-center"><i
                                        class="fa-solid fa-download"></i> Backup (Export File)</button>
                                <label
                                    class="bg-gray-700 text-white px-4 py-2 rounded text-xs hover:bg-gray-600 cursor-pointer text-center">
                                    <i class="fa-solid fa-upload"></i> Restore (Import File)
                                    <input type="file" id="importFile" class="hidden" onchange="importDB(this)">
                                </label>
                                <button onclick="repairCashAndBankBalances()"
                                    class="bg-orange-700 text-white px-4 py-2 rounded text-xs hover:bg-orange-600 text-center"><i
                                        class="fa-solid fa-wrench"></i> Repair Balances</button>
                            </div>
                            <div class="mt-4">
                                <button onclick="resetData()"
                                    class="text-red-500 text-xs hover:text-red-400 underline">Danger: Wipe My
                                    Data</button>
                            </div>
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <!-- MODALS -->
    <div id="modalBackdrop" onclick="if(event.target === this) closeModal();"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">

        <!-- Product Modal -->
        <div id="prodModal"
            class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-white">Product Details</h3>
            <form id="prodForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="prodId">
                <div class="md:col-span-2">
                    <label class="text-xs text-gray-400 font-bold">Product Name <span
                            class="text-red-500">*</span></label>
                    <input type="text" id="pName" required class="input-field" placeholder="e.g., Paracetamol 500mg">
                    <span class="help-text">The name displayed in reports and invoices</span>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">SKU / Barcode <span
                            class="text-red-500">*</span></label>
                    <input type="text" id="pSku" required class="input-field" placeholder="e.g., PAR-500-001">
                    <span class="help-text">Unique identifier for scanning</span>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">Category</label>
                    <input type="text" id="pCat" list="catList" class="input-field" placeholder="e.g., Medicine">
                    <datalist id="catList">
                        <option value="Medicine">
                        <option value="Equipment">
                        <option value="Supplement">
                    </datalist>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">Batch Number</label>
                    <input type="text" id="pBatch" class="input-field" placeholder="e.g., BATCH-001">
                    <span class="help-text">For tracking and expiry management</span>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">Expiry Date</label>
                    <input type="date" id="pExpiry" class="input-field">
                    <span class="help-text">Leave blank if not applicable</span>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">Cost Price <span
                            class="text-red-500">*</span></label>
                    <input type="number" step="0.01" id="pCost" required class="input-field" placeholder="0.00">
                    <span class="help-text">What you paid the supplier</span>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">Retail Price <span
                            class="text-red-500">*</span></label>
                    <input type="number" step="0.01" id="pRetail" required class="input-field" placeholder="0.00">
                    <span class="help-text">Customer/walk-in price</span>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">Wholesale Price</label>
                    <input type="number" step="0.01" id="pWhole" class="input-field" placeholder="0.00">
                    <span class="help-text">For bulk orders (optional)</span>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">Current Stock <span
                            class="text-red-500">*</span></label>
                    <input type="number" id="pStock" required class="input-field" placeholder="0">
                    <span class="help-text">Available quantity now</span>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">Reorder Level</label>
                    <input type="number" id="pReorder" class="input-field" value="10" placeholder="10">
                    <span class="help-text">Alert when stock falls below this</span>
                </div>
                <div class="md:col-span-2">
                    <label class="text-xs text-gray-400 font-bold">Default Supplier (Optional)</label>
                    <select id="pSupplier" class="input-field">
                        <option value="">-- No specific supplier --</option>
                    </select>
                    <span class="help-text">Assign for automatic purchase suggestions</span>
                </div>
                <div class="md:col-span-2 flex justify-end gap-2 mt-4">
                    <button type="button" onclick="closeModal()"
                        class="px-4 py-2 bg-gray-700 rounded text-white hover:bg-gray-600 transition">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-karta-primary text-black font-bold rounded hover:bg-karta-primaryDark transition">Save</button>
                </div>
            </form>
        </div>

        <!-- Invoice Edit Modal -->
        <div id="invEditModal"
            class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Edit Invoice #<span id="editInvId"></span></h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i
                        class="fa-solid fa-times"></i></button>
            </div>
            <div class="mb-4 bg-red-900/20 p-3 rounded border border-red-800 text-red-200 text-xs">
                <i class="fa-solid fa-triangle-exclamation mr-2"></i> Warning: Editing an invoice reverses original
                stock/balance changes and applies new ones.
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="text-xs text-gray-400">Customer</label>
                    <select id="editInvCust" class="input-field"></select>
                </div>
                <div>
                    <label class="text-xs text-gray-400">Payment Type</label>
                    <select id="editInvPay" class="input-field">
                        <option value="cash">Cash</option>
                        <option value="credit">Credit</option>
                    </select>
                </div>
            </div>

            <div class="mb-4">
                <h4 class="text-gray-400 text-xs font-bold mb-2">Items</h4>
                <div id="editInvItems" class="space-y-2 max-h-64 overflow-y-auto"></div>
                <button onclick="addEditItem()" class="mt-2 text-xs text-karta-primary hover:underline">+ Add Item
                    Row</button>
            </div>

            <div class="flex flex-col md:flex-row justify-end gap-2 mt-4 border-t border-gray-700 pt-4">
                <button type="button" onclick="deleteInvoice()"
                    class="px-4 py-2 bg-red-600 rounded text-white md:mr-auto">Delete/Void Invoice</button>
                <button type="button" onclick="closeModal()"
                    class="px-4 py-2 bg-gray-700 rounded text-white">Cancel</button>
                <button type="button" onclick="saveInvoiceEdit()"
                    class="px-4 py-2 bg-karta-primary text-black font-bold rounded">Save Changes</button>
            </div>
        </div>

        <!-- Journal Entry Modal -->
        <div id="journalModal"
            class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-lg">
            <h3 class="text-xl font-bold mb-4 text-white">New Journal Entry</h3>
            <form id="journalForm" onsubmit="saveJournalEntry(event)" class="space-y-4">
                <div>
                    <label class="text-xs text-gray-400 font-bold">Date</label>
                    <input type="date" id="jouDate" required class="input-field">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-400 font-bold">Debit Account (Dr)</label>
                        <select id="jouDrAccount" required class="input-field">
                            <option value="">-- Select Account --</option>
                            <option value="Cash A/c">Cash A/c</option>
                            <option value="Bank A/c">Bank A/c</option>
                            <option value="Sales A/c">Sales A/c</option>
                            <option value="Purchase A/c">Purchase A/c</option>
                            <option value="Expense A/c">Expense A/c</option>
                            <option value="Assets A/c">Assets A/c</option>
                            <option value="Capital A/c">Capital A/c</option>
                            <option value="Drawings A/c">Drawings A/c</option>
                            <!-- Customers and Suppliers will be added via JS if needed, or typed -->
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 font-bold">Credit Account (Cr)</label>
                        <select id="jouCrAccount" required class="input-field">
                            <option value="">-- Select Account --</option>
                            <option value="Cash A/c">Cash A/c</option>
                            <option value="Bank A/c">Bank A/c</option>
                            <option value="Sales A/c">Sales A/c</option>
                            <option value="Capital A/c">Capital A/c</option>
                            <option value="Liabilities A/c">Liabilities A/c</option>
                            <option value="Income A/c">Other Income A/c</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">Amount</label>
                    <input type="number" id="jouAmount" step="0.01" required class="input-field" placeholder="0.00">
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">Narration / Particulars</label>
                    <textarea id="jouNarration" required class="input-field h-20" placeholder="Being..."></textarea>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="closeModal()"
                        class="px-4 py-2 bg-gray-700 rounded text-white hover:bg-gray-600 transition">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-yellow-600 text-white font-bold rounded hover:bg-yellow-700 transition">Save
                        Entry</button>
                </div>
            </form>
        </div>

        <!-- Customer Modal -->
        <div id="custModal"
            class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-white">Customer Profile</h3>
            <form id="custForm" class="space-y-4">
                <input type="hidden" id="custId">
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Full Name <span class="text-red-500">*</span></label>
                    <input type="text" id="cName" placeholder="e.g., Raj Poudel" required class="input-field">
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Phone Number <span
                            class="text-red-500">*</span></label>
                    <input type="text" id="cPhone" placeholder="e.g., 9841234567" required class="input-field">
                    <span class="help-text">For SMS updates and reminders</span>
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Address</label>
                    <input type="text" id="cAddr" placeholder="e.g., Bharatpur, Chitwan" class="input-field">
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">VAT/Tax ID</label>
                    <input type="text" id="cTax" placeholder="e.g., 123456789" class="input-field">
                    <span class="help-text">For business customers (optional)</span>
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Credit Limit</label>
                    <input type="number" id="cLimit" placeholder="0.00" class="input-field">
                    <span class="help-text">Maximum amount they can owe</span>
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Initial Balance Due</label>
                    <input type="number" id="cBalance" placeholder="0.00" step="0.01" class="input-field">
                    <span class="help-text">Amount they owe from previous transactions</span>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeModal()"
                        class="px-4 py-2 bg-gray-700 rounded text-white hover:bg-gray-600 transition">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-karta-primary text-black font-bold rounded hover:bg-karta-primaryDark transition">Save
                        Customer</button>
                </div>
            </form>
        </div>

        <!-- Customer History & PDF Modal -->
        <div id="custHistoryModal"
            class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-4xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-start mb-6 shrink-0">
                <div>
                    <h3 class="text-2xl font-bold text-white" id="chName">Customer Name</h3>
                    <p class="text-gray-400 text-sm mt-1"><i class="fa-solid fa-phone mr-2"></i><span
                            id="chPhone"></span> | <i class="fa-solid fa-location-dot mx-2"></i><span
                            id="chAddr"></span></p>
                </div>
                <div class="text-right flex flex-col items-end gap-2">
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i
                            class="fa-solid fa-times fa-lg"></i></button>
                    <button onclick="downloadCustomerPDF()"
                        class="bg-white text-black px-4 py-2 rounded font-bold text-xs hover:bg-gray-200 transition">
                        <i class="fa-solid fa-file-pdf mr-2"></i>Export
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 shrink-0">
                <div class="bg-white/5 p-4 rounded border border-karta-border">
                    <div class="text-gray-400 text-xs uppercase">Current Balance</div>
                    <div class="text-2xl font-bold text-white mt-1" id="chBalance">$0.00</div>
                </div>
                <div class="bg-white/5 p-4 rounded border border-karta-border">
                    <div class="text-gray-400 text-xs uppercase">Total Spent</div>
                    <div class="text-2xl font-bold text-karta-primary mt-1" id="chTotalSpent">$0.00</div>
                </div>
                <div class="bg-white/5 p-4 rounded border border-karta-border">
                    <div class="text-gray-400 text-xs uppercase">Total Transactions</div>
                    <div class="text-2xl font-bold text-blue-400 mt-1" id="chTxnCount">0</div>
                </div>
            </div>

            <div class="flex-1 overflow-hidden flex flex-col border border-karta-border rounded-lg">
                <div class="bg-white/5 p-3 font-bold border-b border-karta-border text-sm shrink-0">Transaction
                    History
                </div>
                <div class="overflow-y-auto flex-1">
                    <table class="w-full text-left text-xs" id="chTableContainer">
                        <thead class="bg-karta-surface text-gray-400 sticky top-0">
                            <tr>
                                <th class="p-3">Date</th>
                                <th class="p-3">Type</th>
                                <th class="p-3">Ref</th>
                                <th class="p-3">Details</th>
                                <th class="p-3 text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="chTableBody" class="divide-y divide-gray-800">
                            <!-- Populated via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- NEW: Supplier History Modal -->
        <div id="supHistoryModal"
            class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-4xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-start mb-6 shrink-0">
                <div>
                    <h3 class="text-2xl font-bold text-white" id="shName">Supplier Name</h3>
                    <p class="text-gray-400 text-sm mt-1"><i class="fa-solid fa-phone mr-2"></i><span
                            id="shPhone"></span> | <i class="fa-solid fa-user-tie mx-2"></i><span id="shContact"></span>
                    </p>
                </div>
                <div class="text-right flex flex-col items-end gap-2">
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i
                            class="fa-solid fa-times fa-lg"></i></button>
                    <button onclick="downloadSupplierPDF()"
                        class="bg-white text-black px-4 py-2 rounded font-bold text-xs hover:bg-gray-200 transition">
                        <i class="fa-solid fa-file-pdf mr-2"></i>Export
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 shrink-0">
                <div class="bg-white/5 p-4 rounded border border-karta-border">
                    <div class="text-gray-400 text-xs uppercase">Current Balance Due</div>
                    <div class="text-2xl font-bold text-red-500 mt-1" id="shBalance">$0.00</div>
                </div>
                <div class="bg-white/5 p-4 rounded border border-karta-border">
                    <div class="text-gray-400 text-xs uppercase">Total Purchased</div>
                    <div class="text-2xl font-bold text-white mt-1" id="shTotalPurchased">$0.00</div>
                </div>
            </div>

            <div class="flex-1 overflow-hidden flex flex-col border border-karta-border rounded-lg">
                <div class="bg-white/5 p-3 font-bold border-b border-karta-border text-sm shrink-0">Supplier
                    Transaction
                    History</div>
                <div class="overflow-y-auto flex-1">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-karta-surface text-gray-400 sticky top-0">
                            <tr>
                                <th class="p-3">Date</th>
                                <th class="p-3">Type</th>
                                <th class="p-3">Ref</th>
                                <th class="p-3">Items/Desc</th>
                                <th class="p-3 text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="shTableBody" class="divide-y divide-gray-800">
                            <!-- Populated via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Customer Payment Modal -->
        <div id="payModal"
            class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-white"><i
                    class="fa-solid fa-cash-register mr-2 text-green-500"></i>Receive Payment</h3>
            <p id="payCustName" class="text-gray-400 mb-4 text-sm font-bold"></p>
            <form id="payForm" class="space-y-4">
                <input type="hidden" id="payCustId">
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Amount Received <span
                            class="text-red-500">*</span></label>
                    <input type="number" step="0.01" id="payAmount" placeholder="0.00" required
                        class="input-field text-lg font-bold">
                    <span class="help-text">Amount to deduct from customer balance</span>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeModal()"
                        class="px-4 py-2 bg-gray-700 rounded text-white hover:bg-gray-600 transition">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-green-600 text-white font-bold rounded hover:bg-green-700 transition flex items-center gap-2">
                        <i class="fa-solid fa-check"></i> Record Receipt
                    </button>
                </div>
            </form>
        </div>

        <!-- NEW: Supplier Payment Modal -->
        <div id="supPayModal"
            class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-white"><i
                    class="fa-solid fa-money-bill mr-2 text-orange-500"></i>Record Payment to Supplier</h3>
            <p id="spSupName" class="text-gray-400 mb-4 text-sm font-bold"></p>
            <form id="supPayForm" class="space-y-4">
                <input type="hidden" id="spSupId">
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Amount Paid <span
                            class="text-red-500">*</span></label>
                    <input type="number" step="0.01" id="spAmount" placeholder="0.00" required
                        class="input-field text-lg font-bold">
                    <span class="help-text">Amount to deduct from your payable balance</span>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeModal()"
                        class="px-4 py-2 bg-gray-700 rounded text-white hover:bg-gray-600 transition">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-orange-600 text-white font-bold rounded hover:bg-orange-700 transition flex items-center gap-2">
                        <i class="fa-solid fa-check"></i> Record Payment
                    </button>
                </div>
            </form>
        </div>

        <!-- Supplier Modal -->
        <div id="supModal"
            class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-white">Supplier Profile</h3>
            <form id="supForm" class="space-y-4">
                <input type="hidden" id="supId">
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Company Name <span
                            class="text-red-500">*</span></label>
                    <input type="text" id="sName" placeholder="e.g., ABC Pharma Ltd" required class="input-field">
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Contact Person</label>
                    <input type="text" id="sContact" placeholder="e.g., Ram poudel" class="input-field">
                    <span class="help-text">Name of primary contact</span>
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Phone</label>
                    <input type="text" id="sPhone" placeholder="e.g., 9841234567" class="input-field">
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">VAT Registration No</label>
                    <input type="text" id="sTax" placeholder="e.g., 123456789" class="input-field">
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Amount You Owe</label>
                    <input type="number" id="sBalance" placeholder="0.00" step="0.01" class="input-field">
                    <span class="help-text">Outstanding balance payable to this supplier. Can be manually adjusted
                        if
                        needed.</span>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeModal()"
                        class="px-4 py-2 bg-gray-700 rounded text-white hover:bg-gray-600 transition">Cancel</button>
                    <button type="button" id="fixBalanceBtn" onclick="fixSupplierBalance()"
                        class="px-4 py-2 bg-orange-700 text-white rounded hover:bg-orange-600 transition hidden"><i
                            class="fa-solid fa-wrench mr-2"></i>Fix Negative Balance</button>
                    <button type="submit"
                        class="px-4 py-2 bg-karta-primary text-black font-bold rounded hover:bg-karta-primaryDark transition">Save
                        Supplier</button>
                </div>
            </form>
        </div>

        <!-- Purchase Modal -->
        <div id="purchModal"
            class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-5xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-karta-border">
                <h3 class="text-2xl font-bold text-white flex items-center gap-2"><i
                        class="fa-solid fa-cart-shopping text-karta-primary"></i>Purchase Order</h3>
                <button type="button" onclick="closeModal()" class="text-gray-400 hover:text-white text-xl"><i
                        class="fa-solid fa-times"></i></button>
            </div>

            <form id="purchForm" class="space-y-6">
                <!-- Supplier Selection & Purchase Date -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-400 mb-2 block uppercase tracking-wide">🏢 Select
                            Supplier</label>
                        <select id="poSup" onchange="loadSupplierProducts()" class="input-field w-full" required>
                            <option value="">-- Choose Supplier --</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 mb-2 block uppercase tracking-wide">📅
                            Purchase
                            Date</label>
                        <input type="date" id="purchaseDate" class="input-field w-full" required>
                        <input type="text" id="purchaseDateNep" class="input-field w-full hidden text-karta-primary"
                            required placeholder="Purchase Date (BS)">
                        <span class="help-text text-xs text-gray-500">Can be today, yesterday, or future date</span>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 mb-2 block uppercase tracking-wide">📋
                            Supplier
                            Invoice #</label>
                        <input type="text" id="supplierInvoiceNumber" class="input-field w-full"
                            placeholder="e.g., INV-2025-001" required>
                        <span class="help-text text-xs text-gray-500">Supplier's invoice number</span>
                    </div>
                </div>

                <!-- Purchase Items -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wide">📦 Purchase
                            Items</label>
                        <button type="button" onclick="addPurchaseItem()"
                            class="bg-karta-primary hover:bg-karta-primaryDark text-black px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-1">
                            <i class="fa-solid fa-plus"></i> Add Item
                        </button>
                    </div>
                    <div class="bg-karta-surface border border-karta-border rounded-lg overflow-hidden">
                        <div class="table-container">
                            <table class="w-full text-xs min-w-[1000px]">
                                <thead class="bg-white/5 text-gray-400 border-b border-karta-border">
                                    <tr>
                                        <th class="p-3 text-left font-bold">Product</th>
                                        <th class="p-3 text-center font-bold w-20">Qty</th>
                                        <th class="p-3 text-right font-bold w-24">Unit Price</th>
                                        <th class="p-3 text-right font-bold w-20">Total</th>
                                        <th class="p-3 text-center font-bold w-20">VAT</th>
                                        <th class="p-3 text-center font-bold w-24">Batch #</th>
                                        <th class="p-3 text-center font-bold w-28">Expiry</th>
                                        <th class="p-3 text-center font-bold w-12">✕</th>
                                    </tr>
                                </thead>
                                <tbody id="purchItemsBody" class="divide-y divide-gray-800">
                                    <tr>
                                        <td colspan="7" class="p-6 text-center text-gray-500 text-sm">Click "Add
                                            Item"
                                            to start adding products</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-2 lg:grid-cols-5 gap-3">
                    <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                        <p class="text-xs text-gray-400 mb-1">Items</p>
                        <p class="text-2xl font-bold text-karta-primary" id="purchTotalItems">0</p>
                    </div>
                    <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                        <p class="text-xs text-gray-400 mb-1">Total Qty</p>
                        <p class="text-2xl font-bold text-white" id="purchTotalQty">0</p>
                    </div>
                    <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                        <p class="text-xs text-gray-400 mb-1">Subtotal</p>
                        <p class="text-2xl font-bold text-white" id="purchSubtotal">$0.00</p>
                    </div>
                    <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                        <p class="text-xs text-gray-400 mb-1">VAT Amount</p>
                        <p class="text-2xl font-bold text-yellow-400" id="purchVATAmount">$0.00</p>
                    </div>
                    <div class="bg-karta-surface border border-karta-border p-4 rounded-lg">
                        <p class="text-xs text-gray-400 mb-1">Grand Total</p>
                        <p class="text-2xl font-bold text-green-400" id="purchGrandTotal">$0.00</p>
                    </div>
                </div>

                <!-- Discount Input -->
                <div class="border-t border-karta-border pt-4">
                    <label class="text-xs font-bold text-gray-400 mb-3 block uppercase tracking-wide">🏷️ Discount
                        (Optional)</label>
                    <div class="flex gap-2 items-center max-w-xs">
                        <label class="text-xs text-gray-400 flex-1">Discount %</label>
                        <div class="flex items-center gap-1 flex-1">
                            <input type="number" id="purchDiscount" value="0" min="0" max="100" step="0.1"
                                class="input-field text-right text-xs" onchange="renderPurchaseItems()"
                                onkeyup="renderPurchaseItems()">
                            <span class="text-xs text-gray-400">%</span>
                        </div>
                    </div>
                </div>

                <!-- Payment Method Selection -->
                <div class="border-t border-karta-border pt-4">
                    <label class="text-xs font-bold text-gray-400 mb-3 block uppercase tracking-wide">💳 Payment
                        Method</label>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <label
                            class="flex items-center justify-center px-4 py-3 rounded border-2 border-karta-border bg-karta-primary/20 text-karta-primary cursor-pointer transition hover:bg-karta-primary/40"
                            title="Pay cash now - Reduces cash balance">
                            <input type="radio" name="purchPayment" value="cash" checked class="mr-2"
                                onchange="updatePaymentDisplay()">
                            <span class="font-bold"><i class="fa-solid fa-money-bill mr-1"></i>Cash</span>
                        </label>
                        <label
                            class="flex items-center justify-center px-4 py-3 rounded border-2 border-karta-border hover:bg-white/5 text-white cursor-pointer transition"
                            title="Bank transfer/cheque - Reduces bank balance">
                            <input type="radio" name="purchPayment" value="bank" class="mr-2"
                                onchange="updatePaymentDisplay()">
                            <span class="font-bold"><i class="fa-solid fa-university mr-1"></i>Bank</span>
                        </label>
                        <label
                            class="flex items-center justify-center px-4 py-3 rounded border-2 border-karta-border hover:bg-white/5 text-white cursor-pointer transition"
                            title="Purchase on credit - Add to supplier balance">
                            <input type="radio" name="purchPayment" value="credit" class="mr-2"
                                onchange="updatePaymentDisplay()">
                            <span class="font-bold"><i class="fa-solid fa-handshake mr-1"></i>Credit</span>
                        </label>
                        <label
                            class="flex items-center justify-center px-4 py-3 rounded border-2 border-karta-border hover:bg-white/5 text-white cursor-pointer transition"
                            title="Split payment - Part cash, bank, and/or credit">
                            <input type="radio" name="purchPayment" value="split" class="mr-2"
                                onchange="updatePaymentDisplay()">
                            <span class="font-bold"><i
                                    class="fa-solid fa-arrows-split-up-and-left mr-1"></i>Split</span>
                        </label>
                    </div>

                    <!-- Split Payment Input (Hidden by default) -->
                    <div id="splitPaymentSection" class="hidden bg-white/5 p-4 rounded border border-karta-border mb-4">
                        <label class="text-xs font-bold text-gray-400 mb-3 block">💰 Split Payment Details</label>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs text-gray-400">Cash Amount</label>
                                <input type="number" id="splitCashAmount" class="input-field" placeholder="0.00"
                                    step="0.01" min="0" oninput="calculateSplitCredit()">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">Bank Amount</label>
                                <input type="number" id="splitBankAmount" class="input-field" placeholder="0.00"
                                    step="0.01" min="0" oninput="calculateSplitCredit()">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">Credit Amount</label>
                                <input type="number" id="splitCreditAmount" class="input-field" placeholder="0.00"
                                    step="0.01" min="0" readonly style="background-color: #0a0a0a; opacity: 0.7;">
                            </div>
                        </div>
                        <div class="mt-3 p-3 bg-blue-900/20 border border-blue-800 rounded text-xs text-blue-300">
                            <i class="fa-solid fa-info-circle mr-2"></i>
                            Grand Total: <span id="splitTotalDisplay" class="font-bold">$0.00</span> | Cash: <span
                                id="splitCashDisplay" class="font-bold text-green-400">$0.00</span> | Bank: <span
                                id="splitBankDisplay" class="font-bold text-blue-400">$0.00</span> | Credit: <span
                                id="splitCreditDisplay" class="font-bold text-yellow-400">$0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end gap-2 pt-4 border-t border-karta-border">
                    <button type="button" onclick="clearPurchaseForm()"
                        class="px-4 py-2.5 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded text-sm font-bold transition">Clear
                        All</button>
                    <button type="button" onclick="closeModal()"
                        class="px-4 py-2.5 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded text-sm font-bold transition">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2.5 bg-karta-primary hover:bg-karta-primaryDark text-black rounded text-sm font-bold transition flex items-center gap-2">
                        <i class="fa-solid fa-check"></i> Confirm Purchase
                    </button>
                </div>
            </form>
        </div>

        <!-- Expense Modal -->
        <div id="expModal"
            class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-red-500"><i class="fa-solid fa-receipt mr-2"></i>Record Expense
            </h3>
            <form id="expForm" class="space-y-4">
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Description <span
                            class="text-red-500">*</span></label>
                    <input type="text" id="expDesc" placeholder="e.g., Office Rent, Utilities, Transport" required
                        class="input-field">
                    <span class="help-text">What is this expense for?</span>
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Amount <span class="text-red-500">*</span></label>
                    <input type="number" step="0.01" id="expAmt" placeholder="0.00" required
                        class="input-field text-lg font-bold">
                    <span class="help-text">Expense amount</span>
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Payment Mode <span
                            class="text-red-500">*</span></label>
                    <div class="flex gap-2 mt-2">
                        <label
                            class="flex items-center gap-2 px-3 py-2 rounded border-2 border-karta-border hover:bg-white/5 cursor-pointer transition"
                            title="Deduct from cash">
                            <input type="radio" name="expPayment" value="cash" checked class="cursor-pointer">
                            <span class="text-xs">Cash</span>
                        </label>
                        <label
                            class="flex items-center gap-2 px-3 py-2 rounded border-2 border-karta-border hover:bg-white/5 cursor-pointer transition"
                            title="Deduct from bank">
                            <input type="radio" name="expPayment" value="bank" class="cursor-pointer">
                            <span class="text-xs">Bank</span>
                        </label>
                    </div>
                    <span class="help-text text-xs">Which account to deduct from?</span>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeModal()"
                        class="px-4 py-2 bg-gray-700 rounded text-white hover:bg-gray-600 transition">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-red-600 text-white font-bold rounded hover:bg-red-700 transition flex items-center gap-2">
                        <i class="fa-solid fa-check"></i> Save Expense
                    </button>
                </div>
            </form>
        </div>

        <!-- Asset Purchase Modal -->
        <div id="assetModal"
            class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-md">
            <h3 class="text-xl font-bold mb-4 text-purple-500"><i class="fa-solid fa-box mr-2"></i>Purchase Asset
            </h3>
            <form id="assetForm" class="space-y-4">
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Asset Name <span
                            class="text-red-500">*</span></label>
                    <input type="text" id="assetName" placeholder="e.g., Office Furniture, Computer, Vehicle" required
                        class="input-field">
                    <span class="help-text">What asset are you purchasing?</span>
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Asset Type <span
                            class="text-red-500">*</span></label>
                    <select id="assetType" required class="input-field">
                        <option value="">Select Type</option>
                        <option value="furniture">Furniture & Fixtures</option>
                        <option value="equipment">Equipment & Machinery</option>
                        <option value="vehicle">Vehicle</option>
                        <option value="building">Building & Property</option>
                        <option value="computer">Computer & IT Equipment</option>
                        <option value="other">Other</option>
                    </select>
                    <span class="help-text">Category of the asset</span>
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Cost <span class="text-red-500">*</span></label>
                    <input type="number" step="0.01" id="assetCost" placeholder="0.00" required
                        class="input-field text-lg font-bold">
                    <span class="help-text">Purchase price</span>
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Payment Method <span
                            class="text-red-500">*</span></label>
                    <div class="flex gap-2 mt-2">
                        <label
                            class="flex items-center gap-2 px-3 py-2 rounded border-2 border-karta-border hover:bg-white/5 cursor-pointer transition"
                            title="Pay by cash">
                            <input type="radio" name="assetPayment" value="cash" checked class="cursor-pointer">
                            <span class="text-xs">Cash</span>
                        </label>
                        <label
                            class="flex items-center gap-2 px-3 py-2 rounded border-2 border-karta-border hover:bg-white/5 cursor-pointer transition"
                            title="Pay by bank">
                            <input type="radio" name="assetPayment" value="bank" class="cursor-pointer">
                            <span class="text-xs">Bank</span>
                        </label>
                        <label
                            class="flex items-center gap-2 px-3 py-2 rounded border-2 border-karta-border hover:bg-white/5 cursor-pointer transition"
                            title="Credit purchase">
                            <input type="radio" name="assetPayment" value="credit" class="cursor-pointer">
                            <span class="text-xs">Credit</span>
                        </label>
                    </div>
                    <span class="help-text text-xs">How are you paying?</span>
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Supplier Name (Optional)</label>
                    <input type="text" id="assetSupplier" placeholder="Supplier or vendor name" class="input-field">
                    <span class="help-text">Who did you buy from?</span>
                </div>
                <div class="form-group">
                    <label class="text-xs text-gray-400 font-bold">Description (Optional)</label>
                    <textarea id="assetDescription" placeholder="Additional notes about this asset" rows="2"
                        class="input-field"></textarea>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeModal()"
                        class="px-4 py-2 bg-gray-700 rounded text-white hover:bg-gray-600 transition">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-purple-600 text-white font-bold rounded hover:bg-purple-700 transition flex items-center gap-2">
                        <i class="fa-solid fa-check"></i> Purchase Asset
                    </button>
                </div>
            </form>
        </div>

        <!-- PRICE MANAGER MODAL - NEW FEATURE -->
        <!-- Split Sales Payment Modal -->
        <div id="splitSalesModal"
            class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-md">
            <h3 class="text-xl font-bold mb-4 text-white">Split Payment - Sales</h3>
            <div class="bg-white/5 p-4 rounded border border-gray-700 mb-4">
                <div class="text-gray-400 text-sm">Total Amount:</div>
                <div class="text-2xl font-bold text-karta-primary" id="splitSalesTotal">$0.00</div>
            </div>

            <div class="space-y-3 mb-6">
                <div>
                    <label class="text-xs text-gray-400">💰 Cash Amount</label>
                    <input type="number" id="splitSalesCash" class="input-field" placeholder="0.00" step="0.01" min="0"
                        oninput="calculateSplitSales()" value="0">
                </div>
                <div>
                    <label class="text-xs text-gray-400">🏦 Bank Amount</label>
                    <input type="number" id="splitSalesBank" class="input-field" placeholder="0.00" step="0.01" min="0"
                        oninput="calculateSplitSales()" value="0">
                </div>
                <div>
                    <label class="text-xs text-gray-400">💳 Credit Amount</label>
                    <input type="number" id="splitSalesCredit" class="input-field" placeholder="0.00" step="0.01"
                        min="0" oninput="calculateSplitSales()" value="0">
                </div>
            </div>

            <div class="bg-blue-900/20 p-3 rounded border border-blue-800 text-xs text-blue-300 mb-4">
                <i class="fa-solid fa-info-circle mr-2"></i>
                Remaining: <span id="splitSalesRemaining" class="font-bold">$0.00</span>
            </div>

            <div class="flex justify-end gap-2">
                <button type="button" onclick="closeModal()"
                    class="px-4 py-2 bg-gray-700 rounded text-white">Cancel</button>
                <button type="button" onclick="confirmSplitSales()"
                    class="px-4 py-2 bg-karta-primary text-black font-bold rounded">Confirm Payment</button>
            </div>
        </div>

        <div id="priceManagerModal"
            class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-karta-primary"><i class="fa-solid fa-percent mr-2"></i>Bulk Price
                Adjustment</h3>

            <div class="space-y-6">
                <!-- Only individual product adjustment is available now -->
                <!-- TAB: INDIVIDUAL PRODUCT (kept) -->

                <!-- TAB 3: INDIVIDUAL PRODUCT -->
                <div class="border border-karta-border rounded-lg p-4">
                    <h4 class="font-bold text-white mb-3"><i class="fa-solid fa-pen"></i> Edit Individual Product
                    </h4>
                    <p class="text-xs text-gray-400 mb-3">Update price for a single product</p>

                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-400">Select Product</label>
                            <select id="priceProductSelect" class="input-field" onchange="loadProductPriceFields()">
                                <option value="">-- Select Product --</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs text-gray-400">Cost Price</label>
                                <input type="number" id="priceProductCost" class="input-field" step="0.01"
                                    placeholder="Cost">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">Retail Price</label>
                                <input type="number" id="priceProductRetail" class="input-field" step="0.01"
                                    placeholder="Retail">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">Wholesale Price</label>
                                <input type="number" id="priceProductWholesale" class="input-field" step="0.01"
                                    placeholder="Wholesale">
                            </div>
                        </div>
                        <div class="bg-blue-900/20 p-3 rounded border border-blue-800 text-xs text-blue-300">
                            <i class="fa-solid fa-info-circle mr-2"></i>
                            Profit Margin: <span id="profitMarginDisplay" class="font-bold">--</span>
                        </div>
                        <button type="button" onclick="updateIndividualProductPrice()"
                            class="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 rounded font-bold text-sm">
                            <i class="fa-solid fa-save mr-2"></i>Save Individual Price
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-6 border-t border-gray-700 pt-4">
                <button type="button" onclick="closeModal()"
                    class="px-4 py-2 bg-gray-700 rounded text-white">Close</button>
            </div>
        </div>

        <!-- NEW SETTLEMENT MODAL -->
        <div id="newSettlementModal"
            class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-6 text-white"><i
                    class="fa-solid fa-handshake mr-2 text-karta-primary"></i>New Credit Settlement</h3>

            <form id="settlementForm" class="space-y-4">
                <!-- Settlement Type -->
                <div>
                    <label class="text-xs text-gray-400 font-bold mb-2 block">Settlement Type</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label
                            class="flex items-center justify-center px-4 py-3 rounded border-2 border-karta-border bg-karta-primary/20 text-karta-primary cursor-pointer transition hover:bg-karta-primary/40">
                            <input type="radio" name="settlementType" value="customer" checked
                                onchange="loadSettlementEntities()" class="mr-2">
                            <span class="font-bold"><i class="fa-solid fa-user mr-1"></i>Customer Due</span>
                        </label>
                        <label
                            class="flex items-center justify-center px-4 py-3 rounded border-2 border-karta-border hover:bg-white/5 text-white cursor-pointer transition">
                            <input type="radio" name="settlementType" value="supplier"
                                onchange="loadSettlementEntities()" class="mr-2">
                            <span class="font-bold"><i class="fa-solid fa-truck mr-1"></i>Supplier Due</span>
                        </label>
                    </div>
                </div>

                <!-- Customer/Supplier Selection -->
                <div>
                    <label class="text-xs text-gray-400 font-bold mb-2 block">Select Entity</label>
                    <select id="settlementEntity" class="input-field" onchange="updateSettlementAmount()" required>
                        <option value="">-- Choose --</option>
                    </select>
                </div>

                <!-- Invoice Selection (Optional) -->
                <div>
                    <label class="text-xs text-gray-400 font-bold mb-2 block">Link to Invoice (Optional)</label>
                    <select id="settlementInvoice" class="input-field bg-gray-800"
                        onchange="updateSettlementAmountFromInvoice()">
                        <option value="">-- General Payment (FIFO) --</option>
                    </select>
                </div>

                <!-- Date Selection -->
                <div>
                    <label class="text-xs text-gray-400 font-bold mb-2 block">Settlement Date</label>
                    <input type="date" id="settlementDate" class="input-field bg-gray-800">
                </div>

                <!-- Amount Due Display -->
                <div class="bg-white/5 p-4 rounded border border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-400 text-sm">Outstanding Balance:</span>
                        <span class="text-2xl font-bold text-red-500" id="settlementDueAmount">$0.00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400 text-sm">Amount to Settle:</span>
                        <span class="text-2xl font-bold text-karta-primary" id="settlementDisplayAmount">$0.00</span>
                    </div>
                </div>

                <!-- Amount Input -->
                <div>
                    <label class="text-xs text-gray-400 font-bold mb-2 block">Settlement Amount</label>
                    <input type="number" id="settlementAmount" class="input-field text-lg font-bold" placeholder="0.00"
                        step="0.01" onchange="updateSettlementDisplay()" oninput="updateSettlementDisplay()" required>
                </div>

                <!-- Payment Method -->
                <div>
                    <label class="text-xs text-gray-400 font-bold mb-2 block">Payment Method</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label
                            class="flex items-center justify-center px-4 py-3 rounded border-2 border-karta-border bg-green-900/20 text-green-400 cursor-pointer transition hover:bg-green-900/40">
                            <input type="radio" name="settlementPayment" value="cash" checked
                                onchange="toggleChequeInput()" class="mr-2">
                            <span class="font-bold"><i class="fa-solid fa-money-bill mr-1"></i>Cash</span>
                        </label>
                        <label
                            class="flex items-center justify-center px-4 py-3 rounded border-2 border-karta-border hover:bg-white/5 text-white cursor-pointer transition">
                            <input type="radio" name="settlementPayment" value="bank" onchange="toggleChequeInput()"
                                class="mr-2">
                            <span class="font-bold"><i class="fa-solid fa-university mr-1"></i>Bank/Cheque</span>
                        </label>
                    </div>
                </div>

                <!-- Cheque Details (Hidden by default) -->
                <div id="chequeDetailsDiv" class="hidden space-y-3 bg-blue-900/20 p-4 rounded border border-blue-800">
                    <label class="text-xs text-gray-400 font-bold mb-2 block">Cheque Details</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs text-gray-400">Cheque Number</label>
                            <input type="text" id="settlementChequeNo" class="input-field"
                                placeholder="e.g., CHQ-123456">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Cheque Date</label>
                            <input type="date" id="settlementChequeDate" class="input-field">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Bank Name (Optional)</label>
                        <input type="text" id="settlementBankName" class="input-field"
                            placeholder="e.g., Nepal Bank Ltd">
                    </div>
                </div>

                <!-- Notes -->
                <div>
                    <label class="text-xs text-gray-400 font-bold mb-2 block">Notes/Remarks (Optional)</label>
                    <textarea id="settlementNotes" class="input-field" placeholder="e.g., Payment received via..."
                        rows="2"></textarea>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end gap-2 pt-4 border-t border-gray-700">
                    <button type="button" onclick="closeModal()"
                        class="px-4 py-2 bg-gray-700 rounded text-white hover:bg-gray-600 transition">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-karta-primary text-black font-bold rounded hover:bg-karta-primaryDark transition flex items-center gap-2">
                        <i class="fa-solid fa-check"></i> Save Settlement
                    </button>
                </div>
            </form>
        </div>

        <!-- EDIT PURCHASE INVOICE MODAL -->
        <div id="editPurchaseModal"
            class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-6">
                <h3 class="text-2xl font-bold text-white"><i class="fa-solid fa-edit mr-2"></i>Edit Purchase Invoice
                </h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>

            <form id="editPurchaseForm" class="space-y-6">
                <!-- Invoice Details Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Supplier (Read-only) -->
                    <div>
                        <label class="text-xs text-gray-400 font-bold mb-2 block">Supplier</label>
                        <input type="text" id="editPurchSupplier" class="input-field bg-gray-800" readonly>
                    </div>

                    <!-- Invoice Number -->
                    <div>
                        <label class="text-xs text-gray-400 font-bold mb-2 block">Invoice Number</label>
                        <input type="text" id="editPurchInvoiceNo" class="input-field" required
                            placeholder="Enter invoice number">
                    </div>

                    <!-- Purchase Date - Dual Mode -->
                    <div>
                        <label class="text-xs text-gray-400 font-bold mb-2 block">Purchase Date</label>
                        <input type="date" id="editPurchDate" class="input-field" required title="AD Date">
                        <input type="text" id="editPurchDateNep" class="input-field mt-2 hidden text-karta-primary"
                            placeholder="YYYY-MM-DD (BS)" title="BS Date">
                    </div>

                    <!-- Payment Method (Read-only) -->
                    <div>
                        <label class="text-xs text-gray-400 font-bold mb-2 block">Payment Method</label>
                        <input type="text" id="editPurchPayment" class="input-field bg-gray-800" readonly>
                    </div>
                </div>

                <!-- Products Section -->
                <div class="border border-gray-700 rounded-lg p-4">
                    <h4 class="font-bold text-white mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-box"></i> Products
                    </h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-white/5 text-gray-400">
                                <tr>
                                    <th class="p-2">Product</th>
                                    <th class="p-2 text-right">Quantity</th>
                                    <th class="p-2 text-right">Cost Price</th>
                                    <th class="p-2 text-right">Total</th>
                                    <th class="p-2 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="editPurchProductsBody" class="divide-y divide-gray-800">
                                <!-- Populated via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Summary Section -->
                <div class="border-t border-gray-700 pt-4">
                    <div class="flex justify-between items-center text-lg font-bold">
                        <span class="text-white">Total Amount:</span>
                        <span id="editPurchTotal" class="text-karta-primary">Rs.0.00</span>
                    </div>
                </div>

                <!-- Hidden field to store transaction ID -->
                <input type="hidden" id="editPurchTxnId">

                <!-- Action Buttons -->
                <div class="flex gap-3 pt-4 border-t border-gray-700">
                    <button type="submit"
                        class="flex-1 bg-karta-primary hover:bg-karta-primaryDark text-black px-6 py-3 rounded font-bold transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-save"></i> Save Changes
                    </button>
                    <button type="button" onclick="closeModal()"
                        class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 rounded font-bold transition">
                        Cancel
                    </button>
                </div>
            </form>
        </div>

        <!-- VIEW SETTLEMENT INVOICE MODAL -->
        <div id="settlementViewModal"
            class="hidden modal-content bg-karta-surface border border-karta-border p-6 rounded-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-6">
                <h3 class="text-xl font-bold text-white">Settlement Invoice</h3>
                <div class="flex gap-2">
                    <button onclick="printSettlementInvoice()"
                        class="bg-white text-black px-4 py-2 rounded font-bold text-xs hover:bg-gray-200 transition flex items-center gap-2">
                        <i class="fa-solid fa-print"></i> Print
                    </button>
                    <button onclick="downloadSettlementPDF()"
                        class="bg-green-600 text-white px-4 py-2 rounded font-bold text-xs hover:bg-green-700 transition flex items-center gap-2">
                        <i class="fa-solid fa-file-pdf"></i> PDF
                    </button>
                    <button onclick="closeModal()"
                        class="bg-gray-700 text-white px-4 py-2 rounded font-bold text-xs hover:bg-gray-600 transition">Close</button>
                </div>
            </div>

            <!-- Settlement Invoice Display -->
            <div id="settlementInvoiceContent" class="bg-white text-black p-6 rounded border-2 border-black space-y-4">
                <!-- Generated via JS -->
            </div>
        </div>
    </div>


    <!-- Hidden Printable Invoice Area -->
    <div id="printable-area">
        <!-- INVOICE VIEW - Nepali VAT Format -->
        <div id="invoice-print-view"
            style="font-family: Arial, sans-serif; color: #000; background: white; padding: 0;">
            <!-- Main Border Container -->
            <div style="border: 2px solid #000; padding: 20px; width: 100%; box-sizing: border-box;">

                <!-- Header Section with Border -->
                <div style="border-bottom: 2px solid #000; padding-bottom: 12px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <!-- Company Logo & Info -->
                        <div style="display: flex; gap: 12px; flex: 1;">
                            <img id="printInvLogo" src=""
                                style="width: 70px; height: 70px; object-fit: contain; display: none; border: 1px solid #000; padding: 2px;">
                            <div>
                                <h1 style="font-size: 22px; font-weight: bold; margin: 0; color: #000;"
                                    id="invCompName">KARTA BUSINESS</h1>
                                <p style="margin: 3px 0; font-size: 12px; font-weight: bold;">VAT Registration
                                    Number:
                                    <span id="invCompTax" style="font-weight: normal;">123456789</span>
                                </p>
                                <p style="margin: 2px 0; font-size: 11px;" id="invCompAddr">Address: 123 Green
                                    Street
                                </p>
                                <p style="margin: 2px 0; font-size: 11px;" id="invCompPhone">Phone: 9800000000</p>
                            </div>
                        </div>

                        <!-- Invoice Title & Number -->
                        <div style="text-align: center; border-left: 2px solid #000; padding-left: 15px;">
                            <h2 style="font-size: 24px; font-weight: bold; color: #000; margin: 0;" id="invTitle">
                                TAX
                                INVOICE</h2>
                            <p style="margin: 5px 0; font-size: 13px; font-weight: bold;">Invoice No: <span
                                    id="invNo">INV-001</span></p>
                            <p style="margin: 2px 0; font-size: 11px;">Date: <span id="invDate">2025-01-01</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Customer Info Box with Borders -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <!-- Bill To -->
                    <div style="border: 1px solid #000; padding: 10px;">
                        <p
                            style="margin: 0; font-weight: bold; font-size: 12px; border-bottom: 1px solid #000; padding-bottom: 5px;">
                            BILL TO:</p>
                        <p style="margin: 5px 0; font-size: 12px; font-weight: bold;" id="invCustName">Guest
                            Customer
                        </p>
                        <p style="margin: 2px 0; font-size: 11px;" id="invCustContact"></p>
                        <p style="margin: 2px 0; font-size: 11px;" id="invCustTaxId"></p>
                    </div>

                    <!-- Barcode Section -->
                    <div
                        style="border: 1px solid #000; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <p style="margin: 0 0 8px 0; font-size: 10px; font-weight: bold;">BARCODE / SKU</p>
                        <svg id="invBarcode" style="width: 100px; height: 50px;"></svg>
                        <p style="margin: 5px 0 0 0; font-size: 10px;" id="invBarcodeText">N/A</p>
                    </div>
                </div>

                <!-- Items Table with Full Borders -->
                <table
                    style="width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 12px; border: 1px solid #000;">
                    <thead>
                        <tr style="background: #e8e8e8; border-bottom: 2px solid #000;">
                            <th style="padding: 8px; text-align: center; border-right: 1px solid #000; width: 5%;">
                                S.N.
                            </th>
                            <th style="padding: 8px; text-align: left; border-right: 1px solid #000; flex: 1;">
                                Description / Item Details</th>
                            <th style="padding: 8px; text-align: center; border-right: 1px solid #000; width: 10%;">
                                Unit
                            </th>
                            <th style="padding: 8px; text-align: right; border-right: 1px solid #000; width: 12%;">
                                Qty
                            </th>
                            <th style="padding: 8px; text-align: right; border-right: 1px solid #000; width: 12%;">
                                Unit
                                Price</th>
                            <th style="padding: 8px; text-align: right; border-right: 1px solid #000; width: 12%;">
                                Amount</th>
                            <th style="padding: 8px; text-align: center; border-right: 1px solid #000; width: 8%;">
                                VAT%
                            </th>
                            <th style="padding: 8px; text-align: right; width: 12%;">VAT Amt</th>
                        </tr>
                    </thead>
                    <tbody id="invItemsBody" style="border-bottom: 2px solid #000;">
                        <!-- Items with individual VAT columns -->
                    </tbody>
                </table>

                <!-- Summary Section with Borders -->
                <div style="border: 1px solid #000; margin-bottom: 15px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <tr>
                            <td style="padding: 8px; text-align: right; border-right: 1px solid #000; width: 85%;">
                                <strong>Taxable Amount (VAT Items):</strong>
                            </td>
                            <td style="padding: 8px; text-align: right; width: 15%; border-bottom: 1px solid #000;">
                                <span id="invTaxableAmount">0.00</span>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; text-align: right; border-right: 1px solid #000;">
                                <strong>Subtotal (All Items):</strong>
                            </td>
                            <td style="padding: 8px; text-align: right;">
                                <span id="invSub">0.00</span>
                            </td>
                        </tr>
                        <tr id="invDiscountRow" style="display: none; border-top: 1px solid #000;">
                            <td style="padding: 8px; text-align: right; border-right: 1px solid #000;">
                                <strong>Discount (<span id="invDiscountPercent">0</span>%):</strong>
                            </td>
                            <td style="padding: 8px; text-align: right;">
                                <span id="invDiscount">0.00</span>
                            </td>
                        </tr>
                        <tr style="background: #f5f5f5; border-top: 1px solid #000;">
                            <td style="padding: 8px; text-align: right; border-right: 1px solid #000;">
                                <strong>Total VAT (13%):</strong>
                            </td>
                            <td style="padding: 8px; text-align: right;">
                                <span id="invTax">0.00</span>
                            </td>
                        </tr>
                        <tr id="invFreightRowInSummary" style="display: none; border-top: 1px solid #000;">
                            <td style="padding: 8px; text-align: right; border-right: 1px solid #000;">
                                <strong>Freight Charge:</strong>
                            </td>
                            <td style="padding: 8px; text-align: right;">
                                <span id="invFreightAmount">0.00</span>
                            </td>
                        </tr>
                        <tr style="background: #ffeb99; border-top: 2px solid #000; border-bottom: 2px solid #000;">
                            <td
                                style="padding: 10px; text-align: right; border-right: 1px solid #000; font-weight: bold; font-size: 13px;">
                                GRAND TOTAL (INCL. VAT):
                            </td>
                            <td style="padding: 10px; text-align: right; font-weight: bold; font-size: 14px;">
                                <span id="invTotal">0.00</span>
                            </td>
                        </tr>
                        <tr style="background: #ffeb99; border-bottom: 2px solid #000;">
                            <td colspan="2" style="padding: 10px; font-weight: bold; font-size: 11px;">
                                <strong>Amount in Words:</strong> <span id="invTotalWords"
                                    style="font-weight: normal; font-style: italic;">Zero Only</span>
                            </td>
                        </tr>
                    </table>
                </div>

                <!-- Payment & Notes Section -->
                <div style="border: 1px solid #000; padding: 10px; margin-bottom: 15px; font-size: 11px;">
                    <p style="margin: 0 0 5px 0;"><strong>Payment Method:</strong> <span id="invPayMethod">Cash</span>
                    </p>
                    <p id="invFreightRow" style="margin: 0 0 5px 0; display: none;"><strong>Freight Charge:</strong>
                        <span id="invFreight">0.00</span>
                    </p>
                    <p style="margin: 0;"><strong>Notes:</strong> <span id="invNotes">Thank you for your business.
                            Get
                            well soon!</span></p>
                </div>

                <!-- Signature Section with Boxes -->
                <div style="border: 1px solid #000; padding: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; font-size: 11px;">
                        <!-- Checked By -->
                        <div style="text-align: center; border-top: 1px solid #000; padding-top: 40px;">
                            <p style="margin: 0; font-weight: bold;">Checked By</p>
                            <p style="margin: 3px 0 0 0; font-size: 10px;">(Authorized Signatory)</p>
                            <p style="margin: 3px 0 0 0; font-size: 9px;">Signature & Seal</p>
                        </div>

                        <!-- Company Representative -->
                        <div style="text-align: center; border-top: 1px solid #000; padding-top: 40px;">
                            <p style="margin: 0; font-weight: bold;">Issued By</p>
                            <p style="margin: 3px 0 0 0; font-size: 10px;">(<span id="invCompRepName">Company
                                    Name</span>)</p>
                            <p style="margin: 3px 0 0 0; font-size: 9px;">Name & Signature</p>
                        </div>

                        <!-- Buyer Signature -->
                        <div style="text-align: center; border-top: 1px solid #000; padding-top: 40px;">
                            <p style="margin: 0; font-weight: bold;">Buyer/Customer</p>
                            <p style="margin: 3px 0 0 0; font-size: 10px;" id="invCustSignature">Signature</p>
                            <p style="margin: 3px 0 0 0; font-size: 9px;">Date: <span id="invSignDate"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div
                    style="margin-top: 15px; text-align: center; font-size: 10px; border-top: 1px solid #000; padding-top: 10px;">
                    <p style="margin: 3px 0;">This is a Computer Generated Invoice. Authorized signatory is not
                        required.</p>
                    <p style="margin: 3px 0;">Generated by KARTA Business OS</p>
                </div>
            </div>
        </div>

        <!-- REPORT VIEW (Hidden by default) -->
        <div id="report-print-view" class="hidden">
            <!-- Generated via JS -->
        </div>
    </div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        // IMPORT ONVALUE FOR REALTIME UPDATES
        import { getDatabase, ref, set, get, child, update, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAR_ZXBaDY19TwNpK-grHbrQM-E1nadDp8",
            authDomain: "account-9482d.firebaseapp.com",
            databaseURL: "https://account-9482d-default-rtdb.firebaseio.com",
            projectId: "account-9482d",
            storageBucket: "account-9482d.firebasestorage.app",
            messagingSenderId: "742088303662",
            appId: "1:742088303662:web:c23726104923389f156bbf",
            measurementId: "G-K165K36HRF"
        };

        // Initialize Firebase with Error Handling
        let firebaseAvailable = false;
        let app, auth, dbRealtime;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            dbRealtime = getDatabase(app);
            firebaseAvailable = true;
        } catch (error) {
            console.warn("Firebase not available in this environment:", error.message);
            firebaseAvailable = false;
            auth = null;
            dbRealtime = null;
        }

        // --- Firebase Auth & Sync Logic ---
        const authScreen = document.getElementById('auth-screen');
        const appRoot = document.getElementById('app-root');
        const authError = document.getElementById('authError');
        const syncStatusIndicator = document.getElementById('syncStatusIndicator');
        let currentUser = null;
        let dbUnsubscribe = null; // Store listener to detach on logout
        let DB_KEY = ''; // DYNAMIC KEY: Will be set to 'karta_db_UID'

        // --- DATE CONVERSION HELPERS ---
        window.formatDate = function (isoDateString) {
            if (!isoDateString) return '-';

            // Handle special values
            if (isoDateString === 'N/A' || isoDateString === '-') return isoDateString;

            const date = new Date(isoDateString);

            // Check if date is valid
            if (isNaN(date.getTime())) {
                return isoDateString; // Return original string if invalid
            }

            if (db.config.dateMode === 'nepali' && window.NepaliDate) {
                try {
                    // Lazy fix for UMD export issue
                    if (window.NepaliDate && typeof window.NepaliDate !== 'function' && window.NepaliDate.default) {
                        window.NepaliDate = window.NepaliDate.default;
                    }

                    // Check if date is within valid Nepali calendar range (2000-2090 AD)
                    const year = date.getFullYear();
                    if (year < 2000 || year > 2090) {
                        // Date outside valid range, return English format
                        return date.toLocaleDateString();
                    }

                    // Convert JS Date to Nepali Date
                    const nd = new NepaliDate(date);
                    return nd.format('YYYY-MM-DD');
                } catch (e) {
                    // Silently fall back to English format on error
                    return date.toLocaleDateString();
                }
            } else {
                return date.toLocaleDateString();
            }
        };

        window.convertEngToNep = function (isoDateString) {
            if (!isoDateString || !window.NepaliDate) return '';
            try {
                if (window.NepaliDate && typeof window.NepaliDate !== 'function' && window.NepaliDate.default) {
                    window.NepaliDate = window.NepaliDate.default;
                }
                const nd = new NepaliDate(new Date(isoDateString));
                return nd.format('YYYY-MM-DD');
            } catch (e) {
                return '';
            }
        };

        window.convertNepToEng = function (nepDateString) {
            if (!nepDateString || !window.NepaliDate) return '';
            try {
                if (window.NepaliDate && typeof window.NepaliDate !== 'function' && window.NepaliDate.default) {
                    window.NepaliDate = window.NepaliDate.default;
                }
                // NepaliDate constructor accepts 'YYYY-MM-DD' string
                const nd = new NepaliDate(nepDateString);
                const engDate = nd.toJsDate();
                return engDate.toISOString().split('T')[0];
            } catch (e) {
                return '';
            }
        };

        // --- NEPALI DATE PICKER INITIALIZATION ---
        window.initializeNepaliDatePicker = function (elementId) {
            const el = document.getElementById(elementId);
            if (!el) return;

            // Wait for library to load if not ready
            if (!window.NepaliDate || !el.nepaliDatePicker) {
                // If the library attaches itself to prototype or global, we might not need explicit check if we trust CDN
                // The library used operates by instantiating or attaching.
                // Based on standard usage: var picker = new NepaliDatePicker(el, options);
            }

            try {
                /* Initialize using the library's expected syntax.
                   The library @anuz-pandey/nepali-date-picker attaches to elements using a specific constructor or selector.
                   Based on docs: it auto-initializes if data attributes are present, or we can force it.
                   Let's assume standard initialization:
                */
                if (window.NepaliDatePicker) {
                    const picker = new NepaliDatePicker(el, {
                        format: 'YYYY-MM-DD',
                        closeOnDateSelect: true,
                        onChange: function (date) {
                            // Manually trigger change event for sync logic
                            const event = new Event('change', { bubbles: true });
                            el.dispatchEvent(event);
                        }
                    });
                }
            } catch (e) {
                console.warn('Failed to init Nepali Date Picker:', e);
            }
        };

        // --- DUAL MODE INPUT HANDLER ---
        window.enableDualDateInput = function (engInputId, nepInputId) {
            // Robust checks for NepaliDate library
            if (window.NepaliDate && typeof window.NepaliDate !== 'function' && window.NepaliDate.default) {
                window.NepaliDate = window.NepaliDate.default;
            }

            const engInput = document.getElementById(engInputId);
            const nepInput = document.getElementById(nepInputId);

            if (!engInput || !nepInput) return;

            // Initialize Visual Picker for Nepali Input
            if (window.NepaliDatePicker) {
                // Check if already initialized to prevent double-init crash
                if (nepInput.dataset.nepaliDatePickerInitialized) return;
                nepInput.dataset.nepaliDatePickerInitialized = 'true';

                setTimeout(() => {
                    try {
                        /* The library initializes on the element.
                           We need to hook into its selection to trigger our sync.
                        */
                        new window.NepaliDatePicker("#" + nepInputId, {
                            format: 'YYYY-MM-DD',
                            ndpYear: true,
                            ndpMonth: true,
                            disableAfter: '2099-12-30',
                            onChange: function (e) {
                                // Force trigger change for our sync listener
                                nepInput.dispatchEvent(new Event('change'));
                            }
                        });
                    } catch (err) {
                        console.warn('NepaliDatePicker init warning:', err);
                    }
                }, 100);
            }

            // Sync: English -> Nepali
            engInput.addEventListener('change', function () {
                if (this.value) {
                    nepInput.value = window.convertEngToNep(this.value);
                } else {
                    nepInput.value = '';
                }
            });

            // Sync: Nepali -> English
            nepInput.addEventListener('change', function () {
                if (this.value) {
                    const engDate = window.convertNepToEng(this.value);
                    if (engDate) {
                        engInput.value = engDate;
                    }
                } else {
                    engInput.value = '';
                }
            });

            // Initial sync (if English has value)
            if (engInput.value) {
                nepInput.value = window.convertEngToNep(engInput.value);
            }
        };

        window.updateDateModeVisibility = function () {
            const isNepali = db.config.dateMode === 'nepali';

            // Pairs of [English ID, Nepali ID]
            const pairs = [
                ['posManualDate', 'posManualDateNep'],
                ['purchInvFromDate', 'purchInvFromDateNep'],
                ['purchInvToDate', 'purchInvToDateNep'],
                ['repFrom', 'repFromNep'],
                ['repTo', 'repToNep'],
                ['purchaseDate', 'purchaseDateNep'],
                ['invoiceDateFilter', 'invoiceDateFilterNep']
            ];

            pairs.forEach(([engId, nepId]) => {
                const engEl = document.getElementById(engId);
                const nepEl = document.getElementById(nepId);

                if (engEl && nepEl) {
                    if (isNepali) {
                        // Nepali Mode: Hide English, Show Nepali
                        engEl.classList.add('hidden');
                        nepEl.classList.remove('hidden');
                    } else {
                        // English Mode: Show English, Hide Nepali
                        engEl.classList.remove('hidden');
                        nepEl.classList.add('hidden');
                    }
                }
            });
        };

        /** CORE INITIAL STATE - No data loaded yet **/
        const APP_STATE = {
            config: {
                businessName: 'My Business',
                businessType: 'general', // 'pharmacy', 'wholesale', 'retail', 'services', 'general'
                address: 'Kathmandu, Nepal',
                phone: '+977-9800000000',
                taxId: 'PAN-000000',
                vatRate: 13,
                currency: 'Rs.',
                logo: null,
                cashBalance: 0,
                cashBalance: 0,
                bankBalance: 0,
                dateMode: 'english' // 'english' (AD) or 'nepali' (BS)
            },
            products: [],
            customers: [],
            suppliers: [],
            batches: [],
            transactions: [],
            settlements: [],
            assets: []
        };

        // Start with empty state
        let db = JSON.parse(JSON.stringify(APP_STATE));
        let cart = [];
        let editTxnId = null;
        let currentReportData = [];
        let currentReportTitle = "";
        let activeCustomerReportId = null;
        let activeSupplierReportId = null;
        let tempLogoBase64 = null;

        /**
         * CRITICAL FIX: Ensure DB integrity
         * Firebase Realtime Database deletes keys if they are empty arrays (e.g. products: []).
         * When data comes back from cloud, if products is missing, the app crashes.
         * This function forces empty arrays to exist if they are missing.
         */
        function ensureDbStructure(data) {
            if (!data) return JSON.parse(JSON.stringify(APP_STATE));

            const config = data.config || APP_STATE.config;
            // Ensure cashBalance and bankBalance exist
            if (config.cashBalance === undefined) config.cashBalance = 0;
            if (config.bankBalance === undefined) config.bankBalance = 0;

            return {
                config: config,
                // If Array is missing (deleted by Firebase optimization), force empty array []
                products: Array.isArray(data.products) ? data.products : [],
                customers: Array.isArray(data.customers) ? data.customers : [],
                suppliers: Array.isArray(data.suppliers) ? data.suppliers : [],
                transactions: Array.isArray(data.transactions) ? data.transactions : [],
                settlements: Array.isArray(data.settlements) ? data.settlements : [],
                assets: Array.isArray(data.assets) ? data.assets : []
            };
        }

        // AUTH & ISOLATION LOGIC
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                currentUser = user;

                // 1. GENERATE UNIQUE KEY FOR THIS USER
                DB_KEY = `karta_db_${user.uid}`;
                const BLOCK_KEY = `karta_blocked_${user.uid}`;

                // *** SECURITY: CHECK LOCAL BLOCK STATUS FIRST (before showing anything) ***
                const localBlockStatus = localStorage.getItem(BLOCK_KEY);
                if (localBlockStatus === 'blocked') {
                    console.warn('⛔ User is BLOCKED (from local cache)');
                    authScreen.classList.add('hidden');
                    appRoot.classList.add('hidden');
                    document.getElementById('blocked-overlay').classList.remove('hidden');
                    document.getElementById('blocked-overlay').style.display = 'flex';

                    // Still try to verify with server if online
                    if (navigator.onLine && firebaseAvailable) {
                        try {
                            const recheck = await get(ref(dbRealtime, 'registeredUsers/' + user.uid + '/status'));
                            if (recheck.exists() && recheck.val() !== 'blocked') {
                                // Admin has unblocked - remove local block
                                localStorage.removeItem(BLOCK_KEY);
                                // Reload to show app
                                window.location.reload();
                            }
                        } catch (e) {
                            // Offline or error - stay blocked (fail-safe)
                        }
                    }
                    return; // Stop here - don't load app
                }

                // 2. CHECK SERVER BLOCK STATUS BEFORE SHOWING APP (if online)
                let isBlocked = false;
                if (firebaseAvailable && dbRealtime) {
                    try {
                        const registeredUserRef = ref(dbRealtime, 'registeredUsers/' + user.uid);
                        const existingUser = await get(registeredUserRef);

                        if (existingUser.exists()) {
                            const userData = existingUser.val();

                            if (userData.status === 'blocked') {
                                console.warn('⛔ User is BLOCKED by admin');
                                isBlocked = true;

                                // SAVE BLOCK STATUS LOCALLY (persists offline)
                                localStorage.setItem(BLOCK_KEY, 'blocked');

                                authScreen.classList.add('hidden');
                                appRoot.classList.add('hidden');
                                document.getElementById('blocked-overlay').classList.remove('hidden');
                                document.getElementById('blocked-overlay').style.display = 'flex';
                                return; // Stop - don't show app
                            } else {
                                // User is NOT blocked - clear any stale local block status
                                localStorage.removeItem(BLOCK_KEY);

                                // Update last login time
                                await set(ref(dbRealtime, 'registeredUsers/' + user.uid + '/lastLogin'), new Date().toISOString());
                                await set(ref(dbRealtime, 'registeredUsers/' + user.uid + '/loginCount'), (userData.loginCount || 0) + 1);
                            }
                        } else {
                            // New user - create full record
                            await set(registeredUserRef, {
                                email: user.email,
                                uid: user.uid,
                                createdAt: new Date().toISOString(),
                                lastLogin: new Date().toISOString(),
                                loginCount: 1,
                                status: 'active'
                            });
                        }
                        console.log('✓ User tracked in registeredUsers');
                    } catch (regError) {
                        console.warn('Could not check block status:', regError.message);
                        // If offline and check fails, we already checked local block status above
                        // So only users without local block flag will reach here
                    }
                }

                // 3. ONLY NOW SHOW THE APP (after block check passes)
                const localData = localStorage.getItem(DB_KEY);
                if (localData) {
                    db = ensureDbStructure(JSON.parse(localData));
                } else {
                    db = JSON.parse(JSON.stringify(APP_STATE));
                }

                refreshUI();

                authScreen.classList.add('hidden');
                appRoot.classList.remove('hidden');
                appRoot.classList.remove('opacity-0');
                document.getElementById('userEmailDisplay').innerText = user.email;
                document.getElementById('dbIdDisplay').innerText = user.uid.slice(0, 8) + "...";

                console.log("Logged in as: ", user.email);

                // 3. START SECURE CLOUD SYNC
                // Path is securely isolated to users/{uid}/data
                const userRef = ref(dbRealtime, 'users/' + user.uid + '/data');

                // Set up real-time listener
                dbUnsubscribe = onValue(userRef, (snapshot) => {
                    const cloudData = snapshot.val();
                    if (cloudData) {
                        // Data exists in cloud, update local state
                        // FIX: Run through sanitizer to prevent "undefined" arrays crash
                        db = ensureDbStructure(cloudData);

                        localStorage.setItem(DB_KEY, JSON.stringify(db)); // Update Isolated Local Storage
                        refreshUI();
                        console.log("Data synced from Cloud");
                        updateSyncStatus("Synced", "text-green-500");
                    } else {
                        // No data in cloud (New User), upload current local default
                        updateSyncStatus("Initializing Private DB...", "text-yellow-500");
                        set(userRef, db);
                    }
                });

                // 4. REAL-TIME BLOCK STATUS LISTENER - Immediately locks out if blocked
                // 4. REAL-TIME BLOCK STATUS LISTENER - Immediately locks out if blocked
                // Listen to the whole user object to get paymentStatus updates too
                const userGlobalRef = ref(dbRealtime, 'registeredUsers/' + user.uid);
                onValue(userGlobalRef, (snapshot) => {
                    const userData = snapshot.val();

                    // Check for Auto-Block Expiration
                    if (userData && userData.status !== 'blocked' && userData.autoBlockDate) {
                        const autoBlockTime = new Date(userData.autoBlockDate).getTime();
                        if (Date.now() > autoBlockTime) {
                            console.warn('⏳ Auto-block period expired. Blocking user...');
                            update(ref(dbRealtime, 'registeredUsers/' + user.uid), {
                                status: 'blocked'
                            }).catch(err => console.error('Auto-block failed:', err));
                        }
                    }

                    if (userData && userData.status === 'blocked') {
                        console.warn('⛔ USER BLOCKED IN REAL-TIME - Locking out immediately');

                        // Hide app completely
                        appRoot.classList.add('hidden');
                        appRoot.classList.add('opacity-0');
                        authScreen.classList.add('hidden');

                        // Show blocked overlay
                        document.getElementById('blocked-overlay').classList.remove('hidden');
                        document.getElementById('blocked-overlay').style.display = 'flex'; // FORCE DISPLAY

                        // UPDATE UI for Payment Status (Review/Rejected)
                        if (window.updateBlockedOverlayUI) {
                            window.updateBlockedOverlayUI(userData);
                        }

                        // Stop data sync
                        if (dbUnsubscribe) dbUnsubscribe();
                    }
                });

            } else {
                // User is signed out
                currentUser = null;
                DB_KEY = ''; // Clear key
                if (dbUnsubscribe) dbUnsubscribe(); // Stop listening

                // WIPE MEMORY FOR SECURITY
                db = JSON.parse(JSON.stringify(APP_STATE));

                appRoot.classList.add('hidden');
                appRoot.classList.add('opacity-0');
                document.getElementById('blocked-overlay').classList.add('hidden'); // Hide blocked overlay too
                document.getElementById('blocked-overlay').style.display = '';
                authScreen.classList.remove('hidden');
            }
        });

        // Notify Admin of Payment
        window.notifyPaymentDone = async () => {
            if (!currentUser) return;
            try {
                // Update registeredUsers status to 'review'
                // We use update() to add paymentStatus without overwriting other fields
                // The rules allow this because we are NOT changing 'status' here
                const userRef = ref(dbRealtime, 'registeredUsers/' + currentUser.uid);
                await update(userRef, {
                    paymentStatus: 'review',
                    paymentRequestTime: new Date().toISOString()
                });

                alert('Payment notification sent! The admin will verify and restore your access shortly.');

                // Update UI immediately (redundant if listener is fast, but good for UX)
                const paySection = document.getElementById('paymentSection');
                if (paySection) {
                    paySection.innerHTML = '<p class="text-green-400 font-bold"><i class="fa-solid fa-check-circle mr-2"></i>Payment Submitted for Review</p>';
                }
            } catch (error) {
                console.error('Error sending payment notification:', error);
                alert('Error sending notification: ' + error.message);
            }
        };

        // Helper to update Blocked Overlay based on payment status
        window.updateBlockedOverlayUI = (userData) => {
            const paymentSection = document.getElementById('paymentSection');

            // Reset to default state first
            paymentSection.innerHTML = `
                <button
                    onclick="document.getElementById('qrCodeContainer').classList.remove('hidden'); this.classList.add('hidden');"
                    class="w-full bg-karta-primary hover:bg-karta-primaryDark text-black font-bold py-2.5 md:py-3 text-sm md:text-base rounded transition-all duration-200 hover:shadow-lg mb-4">
                    <i class="fa-solid fa-wallet mr-2"></i> Proceed to Payment
                </button>
                <div id="qrCodeContainer" class="hidden animate-slideIn">
                    <div class="bg-white/5 border border-white/10 rounded-lg p-4 mb-4 flex flex-col items-center">
                        <div class="bg-white p-2 rounded-lg mb-3">
                            <img src="payment-qr.jpg" alt="eSewa QR Code" class="w-48 h-48 object-contain">
                        </div>
                        <p class="text-karta-primary text-xs md:text-sm font-semibold mb-4">
                            <i class="fa-solid fa-qrcode mr-2"></i>Scan using eSewa App
                        </p>
                        <button onclick="window.notifyPaymentDone()"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-check"></i> I Have Made Payment
                        </button>
                    </div>
                </div>
            `;

            if (userData.paymentStatus === 'review') {
                paymentSection.innerHTML = '<p class="text-green-400 font-bold"><i class="fa-solid fa-check-circle mr-2"></i>Payment Submitted for Review</p>';
            } else if (userData.paymentStatus === 'rejected') {
                // If rejected, prepend a rejection message
                const rejectMsg = document.createElement('div');
                rejectMsg.className = 'bg-red-900/50 border border-red-600 text-red-200 p-3 rounded mb-4 text-sm';
                rejectMsg.innerHTML = '<i class="fa-solid fa-triangle-exclamation mr-2"></i>Your previous payment was rejected. Please try again.';
                paymentSection.prepend(rejectMsg);
            }
        };

        // Logout function for blocked users
        window.logoutBlockedUser = async () => {
            try {
                await signOut(auth);
                document.getElementById('blocked-overlay').classList.add('hidden');
                document.getElementById('blocked-overlay').style.display = '';
                authScreen.classList.remove('hidden');
                console.log('Blocked user logged out');
            } catch (error) {
                console.error('Error logging out:', error);
                alert('Error logging out: ' + error.message);
            }
        };

        function updateSyncStatus(text, colorClass) {
            syncStatusIndicator.innerHTML = `<i class="fa-solid fa-circle text-[8px]"></i> ${text}`;
            syncStatusIndicator.className = colorClass;
        }

        // Sign In
        document.getElementById('authForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            authError.classList.add('hidden');

            signInWithEmailAndPassword(auth, email, pass)
                .then((userCredential) => {
                    // Signed in via onAuthStateChanged
                })
                .catch((error) => {
                    authError.innerText = error.message;
                    authError.classList.remove('hidden');
                });
        });

        // Global Logout
        window.handleLogout = () => {
            if (confirm("Are you sure you want to logout?")) {
                signOut(auth).then(() => {
                    location.reload(); // Reload to clear memory completely
                }).catch((error) => {
                    alert("Error signing out");
                });
            }
        };

        // SIGNUP MODAL FUNCTIONS
        window.openSignUpModal = () => {
            document.getElementById('signupModal').classList.remove('hidden');
        };

        window.closeSignUpModal = () => {
            document.getElementById('signupModal').classList.add('hidden');
            document.getElementById('signupForm').reset();
            document.getElementById('signupError').classList.add('hidden');
        };

        // HANDLE SIGNUP FORM SUBMISSION
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const signupError = document.getElementById('signupError');
            signupError.classList.add('hidden');

            const formData = {
                name: document.getElementById('signupName').value.trim(),
                email: document.getElementById('signupEmail').value.trim(),
                business: document.getElementById('signupBusiness').value.trim(),
                businessType: document.getElementById('signupBusinessType').value,
                phone: document.getElementById('signupPhone').value.trim(),
                address: document.getElementById('signupAddress').value.trim(),
                taxId: document.getElementById('signupTaxId').value.trim(),
                status: 'pending',
                createdAt: new Date().toISOString(),
                id: Date.now().toString()
            };

            // Validate required fields
            if (!formData.name || !formData.email || !formData.business || !formData.businessType || !formData.phone) {
                signupError.innerText = 'Please fill in all required fields.';
                signupError.classList.remove('hidden');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(formData.email)) {
                signupError.innerText = 'Please enter a valid email address.';
                signupError.classList.remove('hidden');
                return;
            }

            try {
                // Save to Firebase FIRST (primary storage for cross-device access)
                const signupRef = ref(dbRealtime, 'signupRequests/' + formData.id);
                await set(signupRef, formData);
                console.log('✓ Signup request saved to Firebase');

                // Also save to localStorage as backup
                let localRequests = JSON.parse(localStorage.getItem('signupRequests') || '[]');
                localRequests.push(formData);
                localStorage.setItem('signupRequests', JSON.stringify(localRequests));

                // Show success message
                alert('Your signup request has been submitted successfully!\n\nThe admin will review your request and send you login credentials via email.');
                window.closeSignUpModal();
            } catch (error) {
                console.error('Error submitting signup request:', error);
                signupError.innerText = 'Error submitting request: ' + error.message;
                signupError.classList.remove('hidden');
            }
        });


        /** KARTA CORE LOGIC **/

        // --- PRODUCT SUPPLIER ASSIGNMENT (EARLY DEFINITION) ---
        window.loadSupplierSelectForProduct = function () {
            const supSelect = document.getElementById('pSupplier');
            if (!supSelect) {
                console.warn('Supplier select element not found');
                return;
            }
            supSelect.innerHTML = '<option value="">-- No specific supplier --</option>';
            if (!db.suppliers) db.suppliers = [];
            db.suppliers.forEach(supplier => {
                const opt = document.createElement('option');
                opt.value = supplier.id;
                opt.textContent = supplier.name;
                supSelect.appendChild(opt);
            });
        };

        // --- NEW: Toggle Sidebar for Mobile ---
        window.toggleSidebar = function () {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('mobile-backdrop');

            // Check if closed
            const isClosed = sidebar.classList.contains('-translate-x-full');

            if (isClosed) {
                // Open
                sidebar.classList.remove('-translate-x-full');
                backdrop.classList.remove('hidden');
            } else {
                // Close
                sidebar.classList.add('-translate-x-full');
                backdrop.classList.add('hidden');
            }
        }

        // MONEY ROUNDING UTILITY - Fixes Penny Drift
        // Round to 2 decimal places to prevent floating point errors
        function moneyRound(value) {
            return Math.round(value * 100) / 100;
        }

        // MODIFIED AUTO-SAVE FUNCTION
        // Debounce saveDB to prevent excessive saves
        let saveTimeout = null;
        function saveDB() {
            if (!currentUser || !DB_KEY) return;

            // Clear previous timeout
            if (saveTimeout) clearTimeout(saveTimeout);

            // Debounce: Save after 500ms of inactivity
            saveTimeout = setTimeout(() => {
                // 1. Save Locally to ISOLATED Key
                localStorage.setItem(DB_KEY, JSON.stringify(db));

                // 2. Auto-Save to Cloud (If Logged In)
                updateSyncStatus("Saving...", "text-yellow-500");
                const userRef = ref(dbRealtime, 'users/' + currentUser.uid + '/data');
                set(userRef, db)
                    .then(() => updateSyncStatus("Synced ✓", "text-green-500"))
                    .catch((err) => {
                        console.error(err);
                        updateSyncStatus("Sync Error", "text-red-500");
                    });
            }, 500);

            // Update UI immediately (no debounce for UI)
            refreshUI();
        }

        // Data Migration: Fix products with decimal IDs
        function migrateProductIds() {
            if (!db.products) return;
            let hasDecimalIds = false;
            db.products.forEach(p => {
                if (p.id && !Number.isInteger(p.id)) {
                    p.id = Math.floor(p.id);
                    hasDecimalIds = true;
                }
            });
            if (hasDecimalIds) {
                console.log('✓ Fixed product IDs with decimal values');
                saveDB();
            }
        }

        // REPAIR FUNCTION: Recalculate cash, bank, AND credit balances from transactions
        // This fixes negative balances and incorrect credit amounts caused by improper deletes or past bugs
        window.repairCashAndBankBalances = function () {
            console.log(`\n=== STARTING DATABASE REPAIR (CASH + BANK + CREDIT) ===`);

            // Step 1: Reset ALL balances to 0
            db.config.cashBalance = 0;
            db.config.bankBalance = 0;

            if (db.customers) {
                db.customers.forEach(c => { c.balance = 0; });
                console.log(`✓ Reset ${db.customers.length} customer balances to 0`);
            }
            if (db.suppliers) {
                db.suppliers.forEach(s => { s.balance = 0; });
                console.log(`✓ Reset ${db.suppliers.length} supplier balances to 0`);
            }

            // Step 2: Recalculate ONLY from SALES and EXPENSES (most reliable)
            if (db.transactions) {
                db.transactions.forEach(txn => {
                    if (txn.type === 'sale' && !txn.isReturn) {
                        // Add to cash/bank based on payment type
                        if (txn.payType === 'cash') {
                            db.config.cashBalance = moneyRound(db.config.cashBalance + (txn.total || 0));
                            console.log(`  Sale (cash): +${db.config.currency}${(txn.total || 0).toFixed(2)} → Cash: ${db.config.currency}${db.config.cashBalance.toFixed(2)}`);
                        } else if (txn.payType === 'bank') {
                            db.config.bankBalance = moneyRound(db.config.bankBalance + (txn.total || 0));
                            console.log(`  Sale (bank): +${db.config.currency}${(txn.total || 0).toFixed(2)} → Bank: ${db.config.currency}${db.config.bankBalance.toFixed(2)}`);
                        } else if (txn.payType === 'credit') {
                            const cust = db.customers.find(c => c.id === txn.entityId);
                            if (cust) {
                                cust.balance = moneyRound(cust.balance + (txn.total || 0));
                                console.log(`  Sale (credit): +${db.config.currency}${(txn.total || 0).toFixed(2)} → Customer ${cust.name}: ${db.config.currency}${cust.balance.toFixed(2)}`);
                            }
                        } else if (txn.payType === 'split') {
                            if (txn.cashAmount) {
                                db.config.cashBalance = moneyRound(db.config.cashBalance + txn.cashAmount);
                            }
                            if (txn.bankAmount) {
                                db.config.bankBalance = moneyRound(db.config.bankBalance + txn.bankAmount);
                            }
                            if (txn.splitCredit) {
                                const cust = db.customers.find(c => c.id === txn.entityId);
                                if (cust) {
                                    cust.balance = moneyRound(cust.balance + txn.splitCredit);
                                }
                            }
                            console.log(`  Sale (split): +${db.config.currency}${(txn.total || 0).toFixed(2)}`);
                        }
                    } else if (txn.type === 'expense') {
                        // Subtract expenses from cash
                        db.config.cashBalance = moneyRound(db.config.cashBalance - (txn.total || 0));
                        console.log(`  Expense: -${db.config.currency}${(txn.total || 0).toFixed(2)} → Cash: ${db.config.currency}${db.config.cashBalance.toFixed(2)}`);
                    }
                });
            }

            console.log(`\n✓ Database Repaired!`);
            console.log(`New Cash Balance: ${db.config.cashBalance}`);
            console.log(`New Bank Balance: ${db.config.bankBalance}`);

            // Log credit balances
            console.log(`\nCustomer Credit Balances (what customers owe us):`);
            if (db.customers && Array.isArray(db.customers)) {
                db.customers.forEach(c => {
                    // FIX: If balance is NaN, set to 0
                    if (isNaN(c.balance)) {
                        console.warn(`⚠ Customer "${c.name}" had NaN balance - setting to 0`);
                        c.balance = 0;
                    }
                    if (c.balance !== 0) {
                        console.log(`  ${c.name}: ${db.config.currency}${c.balance.toFixed(2)}`);
                    }
                });
            }

            console.log(`\nSupplier Credit Balances (what we owe suppliers):`);
            if (db.suppliers && Array.isArray(db.suppliers)) {
                db.suppliers.forEach(s => {
                    // FIX: If balance is NaN, set to 0
                    if (isNaN(s.balance)) {
                        console.warn(`⚠ Supplier "${s.name}" had NaN balance - setting to 0`);
                        s.balance = 0;
                    }
                    if (s.balance !== 0) {
                        console.log(`  ${s.name}: ${db.config.currency}${s.balance.toFixed(2)}`);
                    }
                });
            }

            // Save the repaired database
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            if (firebaseAvailable && dbRealtime && currentUser) {
                const userRef = ref(dbRealtime, 'users/' + currentUser.uid + '/data');
                set(userRef, db).catch(err => console.error("Firebase error:", err));
            }

            refreshUI();
            loadDashboard();

            let repairSummary = `✓ DATABASE REPAIRED\n\n`;
            repairSummary += `Cash Balance: ${db.config.currency}${db.config.cashBalance.toFixed(2)}\n`;
            repairSummary += `Bank Balance: ${db.config.currency}${db.config.bankBalance.toFixed(2)}\n\n`;

            const totalCustomerCredit = db.customers ? db.customers.reduce((a, c) => a + c.balance, 0) : 0;
            const totalSupplierCredit = db.suppliers ? db.suppliers.reduce((a, s) => a + s.balance, 0) : 0;

            repairSummary += `Customer Credit (Receivables): ${db.config.currency}${totalCustomerCredit.toFixed(2)}\n`;
            repairSummary += `Supplier Credit (Payables): ${db.config.currency}${totalSupplierCredit.toFixed(2)}\n\n`;
            repairSummary += `Recalculated from SALES and EXPENSES only.`;

            alert(repairSummary);
        }

        // Helper function: Filter out zero-stock products if duplicates with stock exist
        window.filterDuplicateZeroStockProducts = function (products) {
            const grouped = {};
            products.forEach(p => {
                if (!grouped[p.name]) grouped[p.name] = [];
                grouped[p.name].push(p);
            });

            let filtered = [];
            Object.keys(grouped).forEach(name => {
                const variants = grouped[name];
                if (variants.length > 1) {
                    // Multiple variants of same product name
                    const hasStock = variants.some(v => v.stock > 0);
                    if (hasStock) {
                        // Hide zero-stock variants
                        filtered = filtered.concat(variants.filter(v => v.stock > 0));
                    } else {
                        // All have 0 stock, keep all
                        filtered = filtered.concat(variants);
                    }
                } else {
                    // Single variant, keep it
                    filtered = filtered.concat(variants);
                }
            });
            return filtered;
        };

        // Attach global functions to window so HTML onclick works
        window.nav = function (page) {
            document.querySelectorAll('main section').forEach(el => el.classList.add('hidden'));
            document.getElementById(page).classList.remove('hidden');

            document.getElementById('pageTitle').innerText = page.charAt(0).toUpperCase() + page.slice(1);

            // Close Sidebar on Mobile when nav clicked
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('mobile-backdrop').classList.add('hidden');
            }

            // Specific Loaders - Load fresh data when navigating
            if (page === 'dashboard') loadDashboard();
            if (page === 'pos') loadPOS();
            if (page === 'invoices') {
                loadInvoices();
                switchInvoiceTab('sales'); // Default to Sales Invoices tab
            }
            if (page === 'purchases') loadBatches();
            if (page === 'returns') loadReturns();
            if (page === 'reports') runReports('daily');
            if (page === 'productSuppliers') loadProductSupplierPage();
        }

        // Tab Switching for Invoices Section
        window.switchInvoiceTab = function (tab) {
            // Hide all tabs
            document.getElementById('tabContentSales').classList.add('hidden');
            document.getElementById('tabContentPurchase').classList.add('hidden');
            document.getElementById('tabContentSettlement').classList.add('hidden');

            // Remove active state from all tabs
            document.getElementById('tabSalesInv').classList.remove('border-b-2', 'border-karta-primary', 'text-karta-primary');
            document.getElementById('tabSalesInv').classList.add('border-b-2', 'border-transparent', 'text-gray-400');

            document.getElementById('tabPurchaseInv').classList.remove('border-b-2', 'border-karta-primary', 'text-karta-primary');
            document.getElementById('tabPurchaseInv').classList.add('border-b-2', 'border-transparent', 'text-gray-400');

            document.getElementById('tabSettlement').classList.remove('border-b-2', 'border-karta-primary', 'text-karta-primary');
            document.getElementById('tabSettlement').classList.add('border-b-2', 'border-transparent', 'text-gray-400');

            // Show selected tab and set active
            if (tab === 'sales') {
                document.getElementById('tabContentSales').classList.remove('hidden');
                document.getElementById('tabSalesInv').classList.remove('border-transparent', 'text-gray-400');
                document.getElementById('tabSalesInv').classList.add('border-b-2', 'border-karta-primary', 'text-karta-primary');
                loadInvoices();
            } else if (tab === 'purchase') {
                document.getElementById('tabContentPurchase').classList.remove('hidden');
                document.getElementById('tabPurchaseInv').classList.remove('border-transparent', 'text-gray-400');
                document.getElementById('tabPurchaseInv').classList.add('border-b-2', 'border-karta-primary', 'text-karta-primary');
                loadPurchaseInvoices();
            } else if (tab === 'settlement') {
                document.getElementById('tabContentSettlement').classList.remove('hidden');
                document.getElementById('tabSettlement').classList.remove('border-transparent', 'text-gray-400');
                document.getElementById('tabSettlement').classList.add('border-b-2', 'border-karta-primary', 'text-karta-primary');
                // Reload from localStorage before rendering settlements
                if (currentUser && DB_KEY) {
                    const localData = localStorage.getItem(DB_KEY);
                    if (localData) {
                        db = ensureDbStructure(JSON.parse(localData));
                    }
                }
                renderSettlements();
            }
        };

        let isModalOpen = false;

        window.openModal = function (id) {
            // Prevent rapid repeated calls
            if (isModalOpen) return;
            isModalOpen = true;

            try {
                const backdrop = document.getElementById('modalBackdrop');
                const modal = document.getElementById(id);

                if (!backdrop || !modal) {
                    console.error('Modal or backdrop not found', id);
                    isModalOpen = false;
                    return;
                }

                console.log('Opening modal:', id);

                // Show backdrop and modal
                backdrop.classList.remove('hidden');
                backdrop.style.display = 'flex';
                modal.classList.remove('hidden');
                modal.style.display = 'block';

                // Load data immediately
                if (id === 'purchModal') {
                    console.log('Loading purchase data');
                    loadPurchSelects();
                }
                else if (id === 'priceManagerModal') {
                    console.log('Loading price manager data');
                    loadPriceManagerData();
                }
                else if (id === 'prodModal') {
                    console.log('Loading supplier select for product');
                    if (window.loadSupplierSelectForProduct && typeof window.loadSupplierSelectForProduct === 'function') {
                        loadSupplierSelectForProduct();
                    }
                }
                else if (id === 'assignSupplierModal') {
                    console.log('Loading suppliers for assignment');
                    loadSuppliersForAssignment();
                    console.log('Suppliers for assignment loaded');
                }
                else if (id === 'newSettlementModal') {
                    console.log('Loading settlement entities');
                    loadSettlementEntities();
                }

                console.log('Modal should now be visible');
                isModalOpen = false;
            } catch (e) {
                console.error('Error opening modal:', e);
                isModalOpen = false;
            }
        }

        window.closeModal = function () {
            const backdrop = document.getElementById('modalBackdrop');
            backdrop.classList.add('hidden');
            backdrop.style.display = 'none';
            document.querySelectorAll('.modal-content').forEach(el => {
                el.classList.add('hidden');
                el.style.display = 'none';
            });
            document.querySelectorAll('form').forEach(f => f.reset());
            editTxnId = null;
            activeCustomerReportId = null;
            activeSupplierReportId = null;
            isModalOpen = false; // Reset flag
        }

        window.openPaymentModal = function (custId, custName) {
            document.getElementById('payCustId').value = custId;
            document.getElementById('payCustName').innerText = "Settling due for: " + custName;
            window.openModal('payModal');
        }

        window.resetData = function () {
            if (confirm("⚠️  DANGER: This will wipe ALL old data from localStorage and cloud!\n\nYou will start fresh with empty database.\n\nContinue?")) {
                // Step 1: Clear localStorage for this user
                if (DB_KEY) {
                    console.log(`Clearing localStorage key: ${DB_KEY}`);
                    localStorage.removeItem(DB_KEY);
                }

                // Step 2: Clear cloud if connected
                if (currentUser) {
                    console.log(`Clearing cloud data for user: ${currentUser.uid}`);
                    set(ref(dbRealtime, 'users/' + currentUser.uid + '/data'), APP_STATE);
                }

                // Step 3: Reset in-memory database
                db = JSON.parse(JSON.stringify(APP_STATE));

                // Step 4: Reload page to reinitialize everything fresh
                console.log('Reloading application with fresh database...');
                setTimeout(() => {
                    location.reload();
                }, 500);
            }
        }

        window.clearOldData = function () {
            if (confirm("This will remove all old transactions & data but keep product/customer/supplier setup.\n\nClear old data?")) {
                db.transactions = [];
                db.settlements = [];
                db.batches = [];
                // Reset balances
                db.config.cashBalance = 0;
                db.config.bankBalance = 0;
                db.customers.forEach(c => c.balance = 0);
                db.suppliers.forEach(s => s.balance = 0);
                saveDB();
                location.reload();
            }
        }

        window.exportDB = function () {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "karta_backup_" + (currentUser ? currentUser.uid.slice(0, 5) : 'local') + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        window.importDB = function (input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function (e) {
                try {
                    let imported = JSON.parse(e.target.result);

                    // COMPATIBILITY FIX: Handle Admin Panel Export format
                    if (imported.appData && imported.userId) {
                        console.log("Detected Admin Panel backup format. Unwrapping data...");
                        imported = imported.appData;
                    }

                    if (confirm("This will overwrite current data with the backup. Continue?")) {
                        // FIX: Sanitize import data too
                        db = ensureDbStructure(imported);

                        // Force save to cloud if logged in
                        if (currentUser && DB_KEY) {
                            localStorage.setItem(DB_KEY, JSON.stringify(db));
                            if (dbRealtime) {
                                const userRef = ref(dbRealtime, 'users/' + currentUser.uid + '/data');
                                try {
                                    console.log('Syncing restored data to cloud...');
                                    await set(userRef, db);
                                    console.log('✓ Restored data synced to cloud');
                                } catch (syncErr) {
                                    console.error("Cloud sync failed:", syncErr);
                                    alert("Warning: Saved locally but cloud sync failed. Check internet.");
                                }
                            }
                        } else {
                            saveDB();
                        }

                        refreshUI();
                        alert("Database Restored Successfully! Page will now reload.");

                        // Reload to ensure all states (like ID sequences) are fresh
                        location.reload();
                    }
                } catch (err) {
                    console.error("Import Error:", err);
                    alert("Invalid Backup File: " + err.message);
                }
            };
            reader.readAsText(file);
        }

        // --- Product Management ---
        document.getElementById('prodForm').onsubmit = e => {
            e.preventDefault();
            const supplierId = document.getElementById('pSupplier').value || null;
            const supplierName = supplierId ? (db.suppliers.find(s => s.id === parseInt(supplierId))?.name || '') : null;
            const existingId = document.getElementById('prodId').value;

            const pData = {
                name: document.getElementById('pName').value,
                sku: document.getElementById('pSku').value,
                category: document.getElementById('pCat').value,
                batch: document.getElementById('pBatch').value,
                expiry: document.getElementById('pExpiry').value,
                cost: parseFloat(document.getElementById('pCost').value),
                retail: parseFloat(document.getElementById('pRetail').value),
                wholesale: parseFloat(document.getElementById('pWhole').value) || 0,
                stock: parseInt(document.getElementById('pStock').value),
                reorder: parseInt(document.getElementById('pReorder').value),
                supplierId: supplierId ? parseInt(supplierId) : null,
                supplierName: supplierName
            };

            if (existingId) {
                // EDIT MODE
                const prodIndex = db.products.findIndex(p => p.id == existingId);
                if (prodIndex > -1) {
                    // Start with existing product to keep other fields safe, then overwrite with form data
                    // Ensure ID remains an integer/original format
                    const originalId = db.products[prodIndex].id;
                    db.products[prodIndex] = {
                        ...db.products[prodIndex],
                        ...pData,
                        id: originalId
                    };
                    alert("✅ Product Updated Successfully!");
                }
            } else {
                // CREATE MODE
                const newProduct = {
                    id: Date.now(),
                    ...pData
                };
                db.products.push(newProduct);
                alert("✅ New Product Added!");
            }

            saveDB();
            renderProducts();
            loadDashboard();
            window.closeModal();
        };

        window.editProduct = function (id) {
            const prod = db.products.find(p => p.id === id);
            if (!prod) return;

            // Populate hidden ID
            document.getElementById('prodId').value = prod.id;

            // Populate fields
            document.getElementById('pName').value = prod.name;
            document.getElementById('pSku').value = prod.sku;
            document.getElementById('pCat').value = prod.category || '';
            document.getElementById('pBatch').value = prod.batch || '';
            document.getElementById('pExpiry').value = prod.expiry || '';
            document.getElementById('pCost').value = prod.cost;
            document.getElementById('pRetail').value = prod.retail;
            document.getElementById('pWhole').value = prod.wholesale || '';
            document.getElementById('pStock').value = prod.stock;
            document.getElementById('pReorder').value = prod.reorder || '10';

            // Handle Supplier Select
            // We need to ensure the select options are loaded first
            if (window.loadSupplierSelectForProduct) {
                window.loadSupplierSelectForProduct();
                // Small delay to let options render if not synchronous (though it is sync currently)
                setTimeout(() => {
                    if (prod.supplierId) {
                        document.getElementById('pSupplier').value = prod.supplierId;
                    }
                }, 0);
            }

            // Change Modal Title or styling if desired (Optional)
            // document.querySelector('#prodModal h3').innerText = "Edit Product"; 

            window.openModal('prodModal');
        }

        function renderProducts() {
            // AUTO-CLEAN: Remove old stock products with 0 qty if newer stock exists
            if (!db.products) db.products = [];

            // Also pre-load suppliers for the product form (if function is defined)
            if (window.loadSupplierSelectForProduct && typeof window.loadSupplierSelectForProduct === 'function') {
                loadSupplierSelectForProduct();
            }

            const productNames = {};
            db.products.forEach(p => {
                if (!productNames[p.name]) productNames[p.name] = [];
                productNames[p.name].push(p);
            });

            // For each product name, if we have multiple batches
            Object.keys(productNames).forEach(name => {
                const variants = productNames[name];
                if (variants.length > 1) {
                    // Sort by expiry date - oldest first (FEFO: First Expire, First Out)
                    variants.sort((a, b) => {
                        const expiryA = a.expiry ? new Date(a.expiry) : new Date('2099-12-31');
                        const expiryB = b.expiry ? new Date(b.expiry) : new Date('2099-12-31');
                        return expiryA - expiryB;
                    });

                    // Check if we have at least one variant with stock > 0
                    const hasNewStock = variants.some(v => v.stock > 0);

                    // If newer stock exists, delete old items with 0 quantity
                    if (hasNewStock) {
                        variants.forEach((v, idx) => {
                            if (idx > 0 && v.stock === 0) {
                                // This is an older batch with 0 stock - delete it
                                db.products = db.products.filter(p => p.id !== v.id);
                            }
                        });
                    }
                }
            });

            const tbody = document.getElementById('invBody');
            tbody.innerHTML = '';
            const search = document.getElementById('invSearch').value.toLowerCase();

            // Safety Check: ensure db.products exists
            if (!db.products) db.products = [];

            // Filter out zero-stock duplicates
            const displayProducts = filterDuplicateZeroStockProducts(db.products);

            displayProducts.filter(p => p.name.toLowerCase().includes(search) || p.sku.toLowerCase().includes(search))
                .forEach(p => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-white/5 transition";

                    // Batch/Expiry Info
                    let batchInfo = `<div class="text-xs text-gray-500">N/A</div>`;
                    if (p.batch || p.expiry) {
                        batchInfo = `
                        <div class="text-xs text-gray-400">Batch: <span class="text-white">${p.batch || '-'}</span></div>
                        <div class="text-[10px] text-gray-500">Exp: ${p.expiry ? window.formatDate(p.expiry) : '-'}</div>
                    `;
                    }

                    tr.innerHTML = `
                    <td class="p-3 font-bold text-white">${p.name}</td>
                    <td class="p-3 text-gray-400 font-mono text-xs">${p.sku}</td>
                    <td class="p-3">${batchInfo}</td>
                    <td class="p-3"><span class="px-2 py-1 bg-gray-800 rounded text-xs">${p.category}</span></td>
                    <td class="p-3 text-right font-bold ${p.stock <= p.reorder ? 'text-red-500' : 'text-green-500'}">${p.stock}</td>
                    <td class="p-3 text-right text-gray-500">${db.config.currency} ${p.cost}</td>
                    <td class="p-3 text-right text-white">${db.config.currency} ${p.retail}</td>
                    <td class="p-3 text-center flex gap-1 justify-center">
                        <button onclick="editProduct(${p.id})" class="text-blue-400 hover:text-blue-300 w-8 h-8 rounded hover:bg-white/10 transition" title="Edit Product"><i class="fa-solid fa-edit"></i></button>
                        <button onclick="delProd(${p.id})" class="text-red-500 hover:text-red-400 w-8 h-8 rounded hover:bg-white/10 transition" title="Delete Product"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                    tbody.appendChild(tr);
                });
        }
        window.delProd = function (id) {
            if (confirm("Delete Product? This will remove it permanently from inventory.")) {
                db.products = db.products.filter(p => p.id !== id);
                saveDB();
                renderProducts();
                alert("Product deleted successfully!");
            }
        }

        window.renderProductSupplierAssignment = function () {
            const tbody = document.getElementById('psmBody');
            tbody.innerHTML = '';
            const search = document.getElementById('psmSearch').value.toLowerCase();
            const supplierFilter = document.getElementById('psmSupplierFilter').value;

            if (!db.products) db.products = [];

            // Get unique products (by name) and their latest supplier assignment
            const productMap = {};
            db.products.forEach(p => {
                const key = p.name.toLowerCase();
                if (!productMap[key] || p.id > productMap[key].id) {
                    productMap[key] = p;
                }
            });

            const filteredProducts = Object.values(productMap)
                .filter(p => (p.name.toLowerCase().includes(search) || p.sku.toLowerCase().includes(search)))
                .filter(p => !supplierFilter || (p.supplierId && p.supplierId === parseInt(supplierFilter)))
                .sort((a, b) => a.name.localeCompare(b.name));

            if (filteredProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">No products found</td></tr>';
                return;
            }

            filteredProducts.forEach(p => {
                const supplier = p.supplierId ? db.suppliers.find(s => s.id === p.supplierId) : null;
                const tr = document.createElement('tr');
                tr.className = `hover:bg-white/5 border-b border-gray-800 ${supplier ? 'bg-green-950/10' : ''}`;
                tr.innerHTML = `
                    <td class="p-3 font-bold text-white">${p.name}</td>
                    <td class="p-3 text-gray-400 text-xs font-mono">${p.sku}</td>
                    <td class="p-3">
                        ${supplier ? `<span class="px-3 py-1 bg-green-900/40 text-green-300 rounded text-xs font-bold border border-green-700"><i class="fa-solid fa-check-circle mr-1"></i>${supplier.name}</span>` : '<span class="px-3 py-1 bg-gray-800/50 text-gray-500 text-xs rounded border border-gray-700"><i class="fa-solid fa-circle-xmark mr-1\"></i>Unassigned</span>'}
                    </td>
                    <td class="p-3 text-center flex gap-1 justify-center">
                        <button onclick="openProductAssignModal(${p.id})" class="text-blue-400 hover:text-blue-300 text-xs font-bold px-3 py-1.5 bg-blue-900/30 hover:bg-blue-900/50 rounded transition border border-blue-800" title="Assign supplier">
                            <i class="fa-solid fa-link"></i>
                        </button>
                        ${supplier ? `<button onclick="quickUnassignProduct(${p.id})" class="text-red-400 hover:text-red-300 text-xs font-bold px-3 py-1.5 bg-red-900/30 hover:bg-red-900/50 rounded transition border border-red-800" title="Remove supplier"><i class="fa-solid fa-unlink"></i></button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        let currentAssignProductId = null;
        window.openProductAssignModal = function (productId) {
            // Handle both integer and decimal product IDs for backwards compatibility
            const numProductId = Math.floor(parseInt(productId) || productId);
            const product = db.products.find(p => Math.floor(p.id) === numProductId);
            if (!product) {
                console.error('Product not found with ID:', productId);
                return;
            }

            currentAssignProductId = Math.floor(product.id);
            document.getElementById('assignProdName').innerText = product.name;
            document.getElementById('assignProdSKU').innerText = product.sku;

            // Show current supplier
            const currentSupplier = product.supplierId ? db.suppliers.find(s => s.id === product.supplierId) : null;
            const supplierDisplay = document.getElementById('assignCurrentSupplierName');
            if (currentSupplier) {
                supplierDisplay.innerHTML = `<i class="fa-solid fa-check-circle text-green-400 mr-1"></i>${currentSupplier.name}`;
                supplierDisplay.className = 'text-green-400 font-bold';
            } else {
                supplierDisplay.innerHTML = '<i class="fa-solid fa-circle-xmark text-gray-500 mr-1"></i>Unassigned';
                supplierDisplay.className = 'text-gray-500 font-bold';
            }

            window.openModal('assignSupplierModal');
        }

        window.loadSuppliersForAssignment = function () {
            try {
                const supSelect = document.getElementById('assignSupplierSelect');
                if (!supSelect) {
                    console.error('Supplier select element not found');
                    return;
                }

                if (!db.suppliers) db.suppliers = [];

                console.log('Loading suppliers. Count:', db.suppliers.length);

                // Build HTML efficiently
                let html = '<option value="">-- Remove Supplier Assignment --</option>';
                if (db.suppliers.length === 0) {
                    html += '<option value="" disabled>No suppliers available</option>';
                } else {
                    db.suppliers.forEach(s => {
                        html += `<option value="${s.id}">${s.name}</option>`;
                    });
                }
                supSelect.innerHTML = html;

                console.log('Suppliers loaded successfully');

                // Pre-select current supplier if assigned
                if (currentAssignProductId) {
                    const product = db.products.find(p => Math.floor(p.id) === Math.floor(currentAssignProductId));
                    if (product && product.supplierId) {
                        supSelect.value = product.supplierId;
                        console.log('Pre-selected supplier:', product.supplierId);
                    }
                }
            } catch (e) {
                console.error('Error loading suppliers:', e);
            }
        }

        window.saveProductSupplierAssignment = function () {
            if (!currentAssignProductId) {
                console.error('No product selected for assignment');
                alert('Error: No product selected');
                return;
            }

            // Handle both integer and decimal product IDs
            const product = db.products.find(p => Math.floor(p.id) === Math.floor(currentAssignProductId));
            if (!product) {
                console.error('Product not found with ID:', currentAssignProductId);
                alert('Error: Product not found');
                return;
            }

            const supplierId = document.getElementById('assignSupplierSelect').value;

            if (supplierId) {
                const supplier = db.suppliers.find(s => s.id === parseInt(supplierId));
                if (supplier) {
                    product.supplierId = parseInt(supplierId);
                    product.supplierName = supplier.name;
                    saveDB();
                    renderProductSupplierAssignment();
                    window.closeModal();
                    alert('✓ Supplier assigned successfully!');
                } else {
                    alert('Error: Supplier not found');
                    return;
                }
            } else {
                alert('Please select a supplier to assign');
                return;
            }
        }

        window.unassignProductSupplier = function () {
            if (!currentAssignProductId) {
                alert('Error: No product selected');
                return;
            }

            const product = db.products.find(p => Math.floor(p.id) === Math.floor(currentAssignProductId));
            if (!product) {
                alert('Error: Product not found');
                return;
            }

            if (confirm(`Remove supplier assignment for "${product.name}"?`)) {
                product.supplierId = null;
                product.supplierName = null;
                saveDB();
                renderProductSupplierAssignment();
                window.closeModal();
                alert('✓ Supplier removed! Product is now unassigned.');
            }
        }

        window.quickUnassignProduct = function (productId) {
            // Handle both integer and decimal product IDs
            const numProductId = Math.floor(parseInt(productId) || productId);
            const product = db.products.find(p => Math.floor(p.id) === numProductId);
            if (!product) return;

            if (confirm(`Unassign "${product.name}" from its supplier?`)) {
                product.supplierId = null;
                product.supplierName = null;
                saveDB();
                renderProductSupplierAssignment();
                alert('✓ Product unassigned!');
            }
        }

        // Load supplier filter dropdown for product suppliers page
        window.loadProductSupplierPage = function () {
            const filter = document.getElementById('psmSupplierFilter');
            filter.innerHTML = '<option value="">-- All Suppliers --</option>';
            if (!db.suppliers) db.suppliers = [];
            db.suppliers.forEach(s => {
                filter.innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });
            renderProductSupplierAssignment();
        }

        // --- Customer Management ---
        document.getElementById('custForm').onsubmit = e => {
            e.preventDefault();
            const custId = document.getElementById('custId').value;
            const name = document.getElementById('cName').value;
            const phone = document.getElementById('cPhone').value;
            const address = document.getElementById('cAddr').value;
            const taxId = document.getElementById('cTax').value;
            const limit = parseFloat(document.getElementById('cLimit').value) || 0;
            const balance = parseFloat(document.getElementById('cBalance').value) || 0;

            if (custId) {
                // Edit existing customer
                const cust = db.customers.find(c => c.id === parseInt(custId));
                if (cust) {
                    cust.name = name;
                    cust.phone = phone;
                    cust.address = address;
                    cust.taxId = taxId;
                    cust.limit = limit;
                    cust.balance = balance;
                }
            } else {
                // Add new customer
                db.customers.push({
                    id: Date.now(),
                    name: name,
                    phone: phone,
                    address: address,
                    taxId: taxId,
                    limit: limit,
                    balance: balance
                });
            }
            saveDB();
            window.closeModal();
            renderCustomers();
        };

        // --- Customer Payment Form Handler ---
        document.getElementById('payForm').onsubmit = e => {
            e.preventDefault();
            const custId = parseInt(document.getElementById('payCustId').value);
            const amount = parseFloat(document.getElementById('payAmount').value);

            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            const cust = db.customers.find(c => c.id === custId);
            if (cust) {
                // Ensure balances exist
                if (!db.config.cashBalance) db.config.cashBalance = 0;
                if (!db.config.bankBalance) db.config.bankBalance = 0;

                // Reduce customer's balance owed to us (they're paying us)
                cust.balance = moneyRound(cust.balance - amount);

                // Increase cash balance (customer is paying us in cash)
                db.config.cashBalance = moneyRound(db.config.cashBalance + amount);

                // Record transaction with payment details
                db.transactions.push({
                    id: Date.now(),
                    type: 'payment', // payment received from customer
                    date: new Date().toISOString(),
                    entityId: custId,
                    entityName: cust.name,
                    items: [], // no items for payment
                    total: amount,
                    paymentMethod: 'cash', // Customer payments default to cash
                    cashAmount: amount,
                    tax: 0,
                    cashBalance: db.config.cashBalance,
                    bankBalance: db.config.bankBalance
                });
                saveDB();
                window.closeModal();
                alert(`Payment Recorded!\nCustomer: ${cust.name}\nAmount: ${db.config.currency}${amount.toFixed(2)}\nMethod: Cash\n\nUpdated Balance: ${db.config.currency}${cust.balance.toFixed(2)}\nCash Balance: ${db.config.currency}${db.config.cashBalance.toFixed(2)}`);
                loadDashboard();
            }
        };

        // --- Debtors Report Filter ---
        window.filterDebtorsReport = function () {
            const searchLocation = document.getElementById('debtorLocationSearch').value.toLowerCase();
            const tbody = document.getElementById('repTable');
            const rows = tbody.getElementsByTagName('tr');

            for (let row of rows) {
                const locationCell = row.cells[1];
                const location = locationCell ? locationCell.textContent.toLowerCase() : '';

                if (searchLocation === '' || location.includes(searchLocation)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        };

        // Edit Customer Function
        window.editCustomer = function (id) {
            const cust = db.customers.find(c => c.id === id);
            if (!cust) return;

            document.getElementById('custId').value = id;
            document.getElementById('cName').value = cust.name;
            document.getElementById('cPhone').value = cust.phone;
            document.getElementById('cAddr').value = cust.address || '';
            document.getElementById('cTax').value = cust.taxId || '';
            document.getElementById('cLimit').value = cust.limit || 0;
            document.getElementById('cBalance').value = cust.balance || 0;

            window.openModal('custModal');
        };

        function renderCustomers() {
            const grid = document.getElementById('custGrid');
            grid.innerHTML = '';
            const search = document.getElementById('custSearch').value.toLowerCase();

            if (!db.customers) db.customers = [];

            // Calculate summary stats
            let totalDue = 0;
            let activeCount = 0;
            db.customers.forEach(c => {
                totalDue += c.balance;
                if (c.balance > 0) activeCount++;
            });

            // Update summary cards
            document.getElementById('custCount').innerText = db.customers.length;
            document.getElementById('custTotalDue').innerText = db.config.currency + totalDue.toFixed(2);
            document.getElementById('custActive').innerText = activeCount;

            db.customers.filter(c => c.name.toLowerCase().includes(search) || (c.address && c.address.toLowerCase().includes(search))).forEach(c => {
                const el = document.createElement('div');
                el.className = "bg-karta-surface border border-karta-border p-4 rounded-lg hover:border-karta-primary transition group flex flex-col h-full";

                // Calculate quick stats for the card
                const txns = (db.transactions || []).filter(t => t.entityId === c.id);
                const totalSpent = txns.filter(t => t.type === 'sale').reduce((a, x) => a + x.total, 0);

                el.innerHTML = `
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-white text-lg">${c.name}</h4>
                            <span class="text-xs ${c.balance > 0 ? 'text-red-500' : 'text-green-500'} font-bold border border-current px-2 py-0.5 rounded">
                                ${c.balance > 0 ? 'Due' : 'Bal'}: ${db.config.currency}${c.balance.toFixed(2)}
                            </span>
                        </div>
                        <div class="text-xs text-gray-400 mb-1 flex items-center"><i class="fa-solid fa-location-dot w-4"></i> ${c.address || 'No Address'}</div>
                        <div class="text-xs text-gray-400 mb-2 flex items-center"><i class="fa-solid fa-phone w-4"></i> ${c.phone}</div>
                        <div class="text-xs text-gray-500 mt-2 mb-4">Total Orders: <span class="text-white">${txns.length}</span> | Spent: <span class="text-white">${db.config.currency}${totalSpent.toFixed(0)}</span></div>
                    </div>
                    
                    <div class="mt-auto pt-3 border-t border-gray-800 flex gap-2">
                         <button onclick="viewCustomerHistory(${c.id})" class="flex-1 bg-white/10 hover:bg-white/20 text-white text-xs py-2 rounded transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-list-ul"></i> History
                         </button>
                         <button onclick="editCustomer(${c.id})" class="flex-1 bg-blue-700 hover:bg-blue-600 text-white text-xs py-2 rounded transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-edit"></i> Edit
                         </button>
                    </div>
                `;
                grid.appendChild(el);
            });

            const dl = document.getElementById('custDataList');
            dl.innerHTML = '';
            db.customers.forEach(c => {
                dl.innerHTML += `<option value="${c.name} [ID:${c.id}]">`;
            });
        }

        // --- NEW: Customer History & PDF Logic ---
        window.viewCustomerHistory = function (id) {
            activeCustomerReportId = id;
            const cust = db.customers.find(c => c.id === id);
            if (!cust) return;

            // Gather Data
            const txns = db.transactions.filter(t => t.entityId === id).sort((a, b) => new Date(b.date) - new Date(a.date));
            const totalSpent = txns.filter(t => t.type === 'sale').reduce((a, x) => a + x.total, 0);

            // Populate Modal Header
            document.getElementById('chName').innerText = cust.name;
            document.getElementById('chPhone').innerText = cust.phone;
            document.getElementById('chAddr').innerText = cust.address || "N/A";

            document.getElementById('chBalance').innerText = `${db.config.currency}${cust.balance.toFixed(2)}`;
            document.getElementById('chBalance').className = `text-2xl font-bold mt-1 ${cust.balance > 0 ? 'text-red-500' : 'text-green-500'}`;

            document.getElementById('chTotalSpent').innerText = `${db.config.currency}${totalSpent.toFixed(2)}`;
            document.getElementById('chTxnCount').innerText = txns.length;

            // Populate Table
            const tbody = document.getElementById('chTableBody');
            tbody.innerHTML = '';

            if (txns.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">No transactions found for this customer.</td></tr>`;
            } else {
                txns.forEach(t => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-white/5 border-b border-gray-800 text-gray-300";

                    // Format Items String
                    let itemsStr = '-';
                    if (t.items && t.items.length > 0) {
                        itemsStr = t.items.map(i => `${i.qty}x ${i.name}`).join(', ');
                        if (itemsStr.length > 40) itemsStr = itemsStr.substring(0, 40) + '...';
                    } else if (t.type === 'payment') {
                        itemsStr = 'Payment Received';
                    }

                    // Type styling
                    const typeColor = t.type === 'sale' ? 'text-blue-400' : (t.type === 'payment' ? 'text-green-400' : 'text-gray-400');

                    // Use invoiceNumber if available, otherwise fall back to ref or last 6 of id
                    const invoiceNum = t.invoiceNumber || t.ref || t.id.toString().slice(-6);

                    tr.innerHTML = `
                        <td class="p-3">${window.formatDate(t.date)}</td>
                        <td class="p-3 uppercase text-xs font-bold ${typeColor}">${t.type}</td>
                        <td class="p-3 font-mono text-xs">#${invoiceNum}</td>
                        <td class="p-3 text-xs text-gray-400 max-w-[150px] truncate">${itemsStr}</td>
                        <td class="p-3 text-right font-bold">${db.config.currency}${t.total.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            window.openModal('custHistoryModal');
        }

        window.downloadCustomerPDF = function () {
            if (!activeCustomerReportId) return;
            const cust = db.customers.find(c => c.id === activeCustomerReportId);
            const txns = db.transactions.filter(t => t.entityId === activeCustomerReportId).sort((a, b) => new Date(b.date) - new Date(a.date));

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Logo for PDF
            let yPos = 20;
            if (db.config.logo) {
                try {
                    doc.addImage(db.config.logo, 'JPEG', 14, 15, 20, 20); // x, y, w, h
                    yPos = 40; // Push text down if logo exists
                } catch (e) { console.error("Logo error", e); }
            }

            // Header
            doc.setFontSize(18);
            doc.text(db.config.name, 14, yPos);
            doc.setFontSize(10);
            doc.text(db.config.address, 14, yPos + 5);
            doc.text("Customer Account Statement", 14, yPos + 15);

            // Customer Details
            doc.setDrawColor(200);
            doc.line(14, yPos + 18, 196, yPos + 18);

            doc.setFontSize(12);
            doc.text(`Customer: ${cust.name}`, 14, yPos + 28);
            doc.setFontSize(10);
            doc.text(`Phone: ${cust.phone}`, 14, yPos + 33);
            doc.text(`Address: ${cust.address || '-'}`, 14, yPos + 38);

            // Summary
            doc.text(`Current Balance Due: ${db.config.currency} ${cust.balance.toFixed(2)}`, 140, yPos + 28);
            doc.text(`Total Lifetime Spend: ${db.config.currency} ${txns.filter(t => t.type === 'sale').reduce((a, x) => a + x.total, 0).toFixed(2)}`, 140, yPos + 33);

            // Table
            const tableData = txns.map(t => {
                const invoiceNum = t.invoiceNumber || t.ref || t.id.toString().slice(-6);
                return [
                    window.formatDate(t.date),
                    t.type.toUpperCase(),
                    `#${invoiceNum}`,
                    t.type === 'sale' ? t.items.map(i => `${i.qty}x ${i.name}`).join(', ') : 'Payment Received',
                    `${db.config.currency} ${t.total.toFixed(2)}`
                ];
            });

            doc.autoTable({
                startY: yPos + 45,
                head: [['Date', 'Type', 'Ref #', 'Description / Items', 'Amount']],
                body: tableData,
                theme: 'grid',
                styles: { fontSize: 8 },
                headStyles: { fillColor: [0, 200, 83] } // Green header
            });

            // Footer
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(8);
            doc.text("Generated by Karta Business OS", 14, finalY);
            doc.text(window.formatDate(new Date().toISOString()), 14, finalY + 5);

            doc.save(`${cust.name.replace(/\s+/g, '_')}_History.pdf`);
        }

        // --- Supplier Management ---
        document.getElementById('supForm').onsubmit = e => {
            e.preventDefault();
            const supId = document.getElementById('supId').value;
            const name = document.getElementById('sName').value;
            const contact = document.getElementById('sContact').value;
            const phone = document.getElementById('sPhone').value;
            const taxId = document.getElementById('sTax').value;
            const balance = moneyRound(parseFloat(document.getElementById('sBalance').value) || 0);

            if (supId) {
                // Edit existing supplier
                const sup = db.suppliers.find(s => s.id === parseInt(supId));
                if (sup) {
                    sup.name = name;
                    sup.contact = contact;
                    sup.phone = phone;
                    sup.taxId = taxId;
                    sup.balance = balance;
                    console.log(`✓ Supplier updated: ${name} with balance: ${db.config.currency}${balance.toFixed(2)}`);
                }
            } else {
                // Add new supplier
                db.suppliers.push({
                    id: Date.now(),
                    name: name,
                    contact: contact,
                    phone: phone,
                    taxId: taxId,
                    balance: balance
                });
                console.log(`✓ New supplier created: ${name} with balance: ${db.config.currency}${balance.toFixed(2)}`);
            }
            // Save immediately without debounce for critical data
            if (currentUser && DB_KEY) {
                localStorage.setItem(DB_KEY, JSON.stringify(db));
                console.log('✓ Balance saved to localStorage');
            }
            saveDB();
            window.closeModal();
            renderSuppliers();
            if (window.loadSupplierSelectForProduct && typeof window.loadSupplierSelectForProduct === 'function') {
                loadSupplierSelectForProduct();
            }
        };

        // NEW: Supplier History & Logic
        window.viewSupplierHistory = function (id) {
            activeSupplierReportId = id;
            const sup = db.suppliers.find(s => s.id === id);
            if (!sup) return;

            // Fetch Transactions (Purchases and Payments Out)
            const txns = db.transactions.filter(t => t.entityId === id && (t.type === 'purchase' || t.type === 'payment_out'))
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const totalPurchased = txns.filter(t => t.type === 'purchase').reduce((a, x) => a + x.total, 0);

            // Populate Header
            document.getElementById('shName').innerText = sup.name;
            document.getElementById('shContact').innerText = sup.contact || 'N/A';
            document.getElementById('shPhone').innerText = sup.phone || 'N/A';

            const balanceStatus = sup.balance > 0 ? 'We Owe' : (sup.balance < 0 ? 'They Owe Us' : 'Settled');
            const balanceColor = sup.balance > 0 ? '#f87171' : (sup.balance < 0 ? '#4ade80' : '#9ca3af');
            document.getElementById('shBalance').innerHTML = `<span style="color: ${balanceColor}; font-weight: bold;">${db.config.currency}${Math.abs(sup.balance).toFixed(2)}</span> <span style="font-size: 0.75rem; color: #9ca3af;">(${balanceStatus})</span>`;
            document.getElementById('shTotalPurchased').innerText = `${db.config.currency}${totalPurchased.toFixed(2)}`;

            // Populate Table
            const tbody = document.getElementById('shTableBody');
            tbody.innerHTML = '';

            if (txns.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">No transactions found for this supplier.</td></tr>`;
            } else {
                txns.forEach(t => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-white/5 border-b border-gray-800 text-gray-300";

                    let itemsStr = '-';
                    if (t.type === 'purchase' && t.items) {
                        itemsStr = t.items.map(i => `${i.qty}x ${i.name}`).join(', ');
                    } else if (t.type === 'payment_out') {
                        itemsStr = 'Payment Sent to Supplier';
                    }

                    const typeColor = t.type === 'purchase' ? 'text-blue-400' : 'text-red-400';
                    const amountSign = t.type === 'payment_out' ? '-' : '';

                    tr.innerHTML = `
                        <td class="p-3">${window.formatDate(t.date)}</td>
                        <td class="p-3 uppercase text-xs font-bold ${typeColor}">${t.type === 'payment_out' ? 'Payment' : 'Purchase'}</td>
                        <td class="p-3 text-xs text-gray-500">${t.ref || '-'}</td>
                        <td class="p-3 text-xs text-gray-400 max-w-[150px] truncate">${itemsStr}</td>
                        <td class="p-3 text-right font-bold">${amountSign}${db.config.currency}${t.total.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            window.openModal('supHistoryModal');
        }

        // NEW: Open Supplier Pay Modal
        window.openSupPayModal = function (id, name) {
            document.getElementById('spSupId').value = id;
            document.getElementById('spSupName').innerText = "Recording payment to: " + name;
            window.openModal('supPayModal');
        }

        // NEW: Submit Supplier Payment
        document.getElementById('supPayForm').onsubmit = e => {
            e.preventDefault();
            const supId = parseInt(document.getElementById('spSupId').value);
            const amount = parseFloat(document.getElementById('spAmount').value);

            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            const sup = db.suppliers.find(s => s.id === supId);
            if (sup) {
                // Ensure balances exist
                if (!db.config.cashBalance) db.config.cashBalance = 0;
                if (!db.config.bankBalance) db.config.bankBalance = 0;

                // Reduce our debt to supplier (we're paying them)
                sup.balance = moneyRound(sup.balance - amount);

                // Decrease cash balance (we're paying supplier in cash)
                db.config.cashBalance = moneyRound(db.config.cashBalance - amount);

                // Record transaction with payment details
                db.transactions.push({
                    id: Date.now(),
                    type: 'payment_out', // Payment Outflow to supplier
                    date: new Date().toISOString(),
                    entityId: supId,
                    entityName: sup.name,
                    items: [],
                    total: amount,
                    paymentMethod: 'cash', // Supplier payments default to cash
                    cashAmount: -amount, // Negative because cash is going out
                    tax: 0,
                    cashBalance: db.config.cashBalance,
                    bankBalance: db.config.bankBalance
                });
                saveDB();
                window.closeModal();
                alert(`Payment Recorded!\nSupplier: ${sup.name}\nAmount: ${db.config.currency}${amount.toFixed(2)}\nMethod: Cash\n\nRemaining Balance: ${db.config.currency}${sup.balance.toFixed(2)}\nCash Balance: ${db.config.currency}${db.config.cashBalance.toFixed(2)}`);
                loadDashboard();
            }
        };

        // NEW: Download Supplier PDF
        window.downloadSupplierPDF = function () {
            if (!activeSupplierReportId) return;
            const sup = db.suppliers.find(s => s.id === activeSupplierReportId);
            const txns = db.transactions.filter(t => t.entityId === activeSupplierReportId && (t.type === 'purchase' || t.type === 'payment_out'))
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let yPos = 20;
            if (db.config.logo) {
                try {
                    doc.addImage(db.config.logo, 'JPEG', 14, 15, 20, 20);
                    yPos = 40;
                } catch (e) { }
            }

            // Header
            doc.setFontSize(18);
            doc.text(db.config.name, 14, yPos);
            doc.setFontSize(10);
            doc.text(db.config.address, 14, yPos + 5);
            doc.text("Supplier Account Statement", 14, yPos + 15);

            doc.setDrawColor(200);
            doc.line(14, yPos + 18, 196, yPos + 18);

            doc.setFontSize(12);
            doc.text(`Supplier: ${sup.name}`, 14, yPos + 28);
            doc.setFontSize(10);
            doc.text(`Contact: ${sup.contact || '-'}`, 14, yPos + 33);
            doc.text(`Phone: ${sup.phone || '-'}`, 14, yPos + 38);

            const balanceStatus = sup.balance > 0 ? 'Balance Due (We Owe)' : (sup.balance < 0 ? 'Refund Due (They Owe Us)' : 'Settled');
            doc.text(`${balanceStatus}: ${db.config.currency} ${Math.abs(sup.balance).toFixed(2)}`, 140, yPos + 28);

            const tableData = txns.map(t => [
                window.formatDate(t.date),
                t.type === 'payment_out' ? 'PAYMENT SENT' : 'PURCHASE',
                t.ref || '-',
                t.type === 'purchase' ? (t.items && t.items[0] ? t.items.map(i => `${i.qty}x ${i.name}`).join(', ') : '-') : 'Payment to Supplier',
                `${t.type === 'payment_out' ? '-' : ''}${db.config.currency} ${t.total.toFixed(2)}`
            ]);

            doc.autoTable({
                startY: yPos + 45,
                head: [['Date', 'Type', 'Ref', 'Details', 'Amount']],
                body: tableData,
                theme: 'grid',
                styles: { fontSize: 8 },
                headStyles: { fillColor: [66, 66, 66] }
            });

            doc.save(`${sup.name.replace(/\s+/g, '_')}_Statement.pdf`);
        }

        function renderSuppliers() {
            const tbody = document.getElementById('supBody');
            tbody.innerHTML = '';
            const search = document.getElementById('supSearch').value.toLowerCase();

            if (!db.suppliers) db.suppliers = [];

            // Calculate summary stats
            let totalDue = 0;
            let totalPurchased = 0;
            db.suppliers.forEach(s => {
                totalDue += s.balance;
                const purchases = (db.transactions || []).filter(t => t.entityId === s.id && t.type === 'purchase');
                totalPurchased += purchases.reduce((a, x) => a + x.total, 0);
            });

            // Update summary cards
            document.getElementById('supCount').innerText = db.suppliers.length;
            document.getElementById('supTotalDue').innerText = db.config.currency + totalDue.toFixed(2);
            document.getElementById('supTotalPurchased').innerText = db.config.currency + totalPurchased.toFixed(2);

            db.suppliers.filter(s => s.name.toLowerCase().includes(search)).forEach(s => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5";
                // Color balance: red if positive (we owe), green if negative (they owe us)
                const balanceColor = s.balance > 0 ? 'text-red-400' : (s.balance < 0 ? 'text-green-400' : 'text-gray-400');
                const balanceLabel = s.balance > 0 ? '(We Owe)' : (s.balance < 0 ? '(They Owe Us)' : '(Settled)');
                tr.innerHTML = `
                    <td class="p-3 text-white font-bold">${s.name}</td>
                    <td class="p-3 text-gray-400">${s.contact}</td>
                    <td class="p-3 text-gray-400">${s.phone}</td>
                    <td class="p-3 text-gray-400 text-xs">${s.taxId}</td>
                    <td class="p-3 text-right font-bold"><span class="${balanceColor}">${db.config.currency}${Math.abs(s.balance).toFixed(2)}</span> <span class="text-xs text-gray-400">${balanceLabel}</span></td>
                    <td class="p-3 text-center flex justify-center gap-2">
                         <button onclick="viewSupplierHistory(${s.id})" class="text-gray-400 hover:text-white" title="History"><i class="fa-solid fa-list-ul"></i></button>
                         <button onclick="editSupplier(${s.id})" class="text-blue-400 hover:text-blue-300" title="Edit"><i class="fa-solid fa-edit"></i></button>
                         <button onclick="delSup(${s.id})" class="text-red-500 hover:text-red-400" title="Delete"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        // Edit Supplier Function
        window.editSupplier = function (id) {
            const sup = db.suppliers.find(s => s.id === id);
            if (!sup) return;

            document.getElementById('supId').value = id;
            document.getElementById('sName').value = sup.name;
            document.getElementById('sContact').value = sup.contact || '';
            document.getElementById('sPhone').value = sup.phone || '';
            document.getElementById('sTax').value = sup.taxId || '';
            document.getElementById('sBalance').value = sup.balance || 0;

            // Show "Fix Balance" button only if balance is negative (glitch)
            const fixBtn = document.getElementById('fixBalanceBtn');
            if (sup.balance < 0) {
                fixBtn.classList.remove('hidden');
                fixBtn.innerHTML = `<i class="fa-solid fa-wrench mr-2"></i>Fix Negative Balance (${db.config.currency}${Math.abs(sup.balance).toFixed(2)})`;
            } else {
                fixBtn.classList.add('hidden');
            }

            window.openModal('supModal');
        };

        // FIX SUPPLIER NEGATIVE BALANCE - Reset to 0 and recalculate properly
        window.fixSupplierBalance = function () {
            const supId = parseInt(document.getElementById('supId').value);
            const sup = db.suppliers.find(s => s.id === supId);

            if (!sup) {
                alert('Supplier not found!');
                return;
            }

            if (sup.balance >= 0) {
                alert('This supplier balance is not negative. No fix needed.');
                return;
            }

            if (!confirm(`Fix negative balance for "${sup.name}"?\n\nCurrent: ${db.config.currency}${sup.balance.toFixed(2)}\n\nThis will:\n1. Set balance to 0\n2. Recalculate from actual purchase transactions\n3. Remove glitched duplicate deletes\n\nContinue?`)) {
                return;
            }

            console.log(`\n=== FIXING SUPPLIER NEGATIVE BALANCE ===`);
            console.log(`Supplier: ${sup.name}`);
            console.log(`Before: ${sup.balance}`);

            // Step 1: Set to 0
            sup.balance = 0;

            // Step 2: Recalculate from ONLY valid purchase transactions for this supplier
            const purchaseTransactions = db.transactions.filter(t =>
                t.type === 'purchase' &&
                t.entityId === supId &&
                !t.isReturn  // Exclude returns
            );

            console.log(`Found ${purchaseTransactions.length} valid purchase transactions`);

            // Step 3: Add up all valid purchases (credit and split portions)
            purchaseTransactions.forEach(txn => {
                let amountOwed = 0;

                if (txn.payType === 'credit') {
                    amountOwed = txn.total;
                } else if (txn.payType === 'split' && txn.creditAmount) {
                    amountOwed = txn.creditAmount;
                }

                sup.balance = moneyRound(sup.balance + amountOwed);
                console.log(`  + Purchase: ${db.config.currency}${amountOwed.toFixed(2)} → Balance: ${db.config.currency}${sup.balance.toFixed(2)}`);
            });

            // Step 4: Subtract any payments made to this supplier
            const paymentTransactions = db.transactions.filter(t =>
                (t.type === 'payment_out') &&
                t.entityId === supId
            );

            console.log(`Found ${paymentTransactions.length} payment transactions`);

            paymentTransactions.forEach(txn => {
                sup.balance = moneyRound(sup.balance - txn.amount);
                console.log(`  - Payment: ${db.config.currency}${txn.amount.toFixed(2)} → Balance: ${db.config.currency}${sup.balance.toFixed(2)}`);
            });

            console.log(`After: ${sup.balance}`);
            console.log(`=== BALANCE FIX COMPLETE ===\n`);

            // Step 5: Save immediately without debounce
            if (currentUser && DB_KEY) {
                localStorage.setItem(DB_KEY, JSON.stringify(db));
                console.log('✓ Saved to localStorage');
            }

            // Also sync to Firebase if available
            if (firebaseAvailable && dbRealtime) {
                const userRef = ref(dbRealtime, 'users/' + currentUser.uid + '/data');
                set(userRef, db)
                    .then(() => console.log('✓ Synced to Firebase'))
                    .catch((err) => console.error('Firebase sync error:', err));
            }

            // Update display
            document.getElementById('sBalance').value = sup.balance;
            renderSuppliers();
            refreshUI();

            alert(`✓ SUPPLIER BALANCE FIXED!\n\nSupplier: ${sup.name}\nNew Balance: ${db.config.currency}${sup.balance.toFixed(2)}\n\nRecalculated from all valid purchases and payments.`);
        };

        window.delSup = function (id) { if (confirm("Delete Supplier?")) { db.suppliers = db.suppliers.filter(s => s.id !== id); saveDB(); renderSuppliers(); } }

        // --- Transactions (Purchase & Expense) ---
        // BULK PURCHASE SYSTEM
        let purchaseCart = [];

        function loadPurchSelects() {
            const sSel = document.getElementById('poSup');
            sSel.innerHTML = '<option value="">-- Choose Supplier --</option>';

            if (!db.suppliers) db.suppliers = [];
            db.suppliers.forEach(s => sSel.innerHTML += `<option value="${s.id}">${s.name}</option>`);

            // Initialize purchase date to today
            const purchaseDateField = document.getElementById('purchaseDate');
            if (purchaseDateField) {
                const today = new Date().toISOString().split('T')[0];
                purchaseDateField.value = today;
            }

            // Reset payment method to cash
            const cashRadio = document.querySelector('input[name="purchPayment"][value="cash"]');
            if (cashRadio) {
                cashRadio.checked = true;
                // Hide split payment section
                const splitSection = document.getElementById('splitPaymentSection');
                if (splitSection) {
                    splitSection.classList.add('hidden');
                }
            }

            purchaseCart = [];
            renderPurchaseItems();
        }

        window.loadSupplierProducts = function () {
            const supId = parseInt(document.getElementById('poSup').value);
            if (!supId) {
                purchaseCart = [];
                renderPurchaseItems();
                return;
            }
            // Clear cart when supplier changes
            purchaseCart = [];
            renderPurchaseItems();
        };

        window.addPurchaseItem = function () {
            const supId = parseInt(document.getElementById('poSup').value);
            if (!supId) {
                alert('Please select a supplier first');
                return;
            }

            purchaseCart.push({
                id: Date.now(),
                productId: null,
                productName: '',
                qty: 1,
                unitPrice: 0,
                batch: '',
                expiry: '',
                vatStatus: 'vat' // 'vat' or 'exempt'
            });
            renderPurchaseItems();
        };

        window.updatePurchaseItem = function (itemId, field, value) {
            const item = purchaseCart.find(i => i.id === itemId);
            if (!item) return;

            if (field === 'product') {
                const prod = db.products.find(p => p.id === parseInt(value));
                if (prod) {
                    item.productId = prod.id;
                    item.productName = prod.name;
                    item.unitPrice = prod.cost || 0;
                }
            } else if (field === 'qty') {
                item.qty = Math.max(0, parseInt(value) || 0);
            } else if (field === 'unitPrice') {
                item.unitPrice = moneyRound(parseFloat(value) || 0);
            } else if (field === 'batch') {
                item.batch = value;
            } else if (field === 'expiry') {
                item.expiry = value;
            } else if (field === 'vatStatus') {
                item.vatStatus = value;
            }

            renderPurchaseItems();
        };

        window.removePurchaseItem = function (itemId) {
            purchaseCart = purchaseCart.filter(i => i.id !== itemId);
            renderPurchaseItems();
        };

        window.renderPurchaseItems = function () {
            const tbody = document.getElementById('purchItemsBody');
            tbody.innerHTML = '';

            // Get selected supplier
            const supId = parseInt(document.getElementById('poSup').value);

            let totalItems = 0;
            let totalQty = 0;
            let grandTotal = 0;
            let totalVAT = 0;

            if (purchaseCart.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="8" class="p-8 text-center text-gray-500 text-sm">Click "Add Item" to start adding products</td>';
                tbody.appendChild(tr);
            } else {
                purchaseCart.forEach(item => {
                    const itemTotal = moneyRound(item.qty * item.unitPrice);
                    const itemVAT = item.vatStatus === 'vat' ? moneyRound(itemTotal * db.config.vatRate / 100) : 0;
                    totalVAT = moneyRound(totalVAT + itemVAT);
                    totalItems++;
                    totalQty += item.qty;
                    grandTotal = moneyRound(grandTotal + itemTotal);

                    // Get supplier's products only, filtered for zero-stock duplicates
                    let supplierProducts = db.products.filter(p => !p.supplierId || p.supplierId === supId);
                    supplierProducts = filterDuplicateZeroStockProducts(supplierProducts);

                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-white/5 border-b border-gray-800 text-gray-300';
                    tr.innerHTML = `
                        <td class="p-3">
                            <select onchange="updatePurchaseItem(${item.id}, 'product', this.value)" class="input-field text-xs py-1.5" style="background-color: #0b0b0b;">
                                <option value="">Select Product</option>
                                ${supplierProducts.map(p => `<option value="${p.id}" ${item.productId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                        </td>
                        <td class="p-3 text-center">
                            <input type="number" min="0" value="${item.qty}" onchange="updatePurchaseItem(${item.id}, 'qty', this.value)" class="input-field text-xs text-center py-1.5 w-16" style="background-color: #0b0b0b;">
                        </td>
                        <td class="p-3 text-right">
                            <input type="number" step="0.01" value="${item.unitPrice.toFixed(2)}" onchange="updatePurchaseItem(${item.id}, 'unitPrice', this.value)" class="input-field text-xs text-right py-1.5 w-20" style="background-color: #0b0b0b;">
                        </td>
                        <td class="p-3 text-right font-bold text-karta-primary text-sm">${db.config.currency}${itemTotal.toFixed(2)}</td>
                        <td class="p-3 text-center">
                            <select onchange="updatePurchaseItem(${item.id}, 'vatStatus', this.value)" class="input-field text-xs py-1.5 w-full" style="background-color: #0b0b0b;">
                                <option value="vat" ${item.vatStatus === 'vat' ? 'selected' : ''}>VAT</option>
                                <option value="exempt" ${item.vatStatus === 'exempt' ? 'selected' : ''}>Exempt</option>
                            </select>
                        </td>
                        <td class="p-3 text-center">
                            <input type="text" placeholder="Batch" value="${item.batch}" onchange="updatePurchaseItem(${item.id}, 'batch', this.value)" class="input-field text-xs py-1.5 w-full" style="background-color: #0b0b0b;" title="Batch number">
                        </td>
                        <td class="p-3 text-center">
                            <input type="date" value="${item.expiry}" onchange="updatePurchaseItem(${item.id}, 'expiry', this.value)" class="input-field text-xs py-1.5 w-full" style="background-color: #0b0b0b;" title="Expiry date">
                        </td>
                        <td class="p-3 text-center">
                            <button type="button" onclick="removePurchaseItem(${item.id})" class="text-gray-400 hover:text-red-400 transition text-sm" title="Remove item">
                                <i class="fa-solid fa-trash-alt"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            const grandTotalWithVAT = moneyRound(grandTotal + totalVAT);

            // Get discount percentage
            const discountPercent = parseFloat(document.getElementById('purchDiscount').value) || 0;
            const discountAmount = moneyRound(grandTotal * (discountPercent / 100));
            const subtotalAfterDiscount = moneyRound(grandTotal - discountAmount);

            // Apply discount proportionally to VAT calculation
            const vatAfterDiscount = moneyRound(totalVAT * (1 - (discountPercent / 100)));
            const finalTotal = moneyRound(subtotalAfterDiscount + vatAfterDiscount);

            document.getElementById('purchTotalItems').innerText = totalItems;
            document.getElementById('purchTotalQty').innerText = totalQty;
            document.getElementById('purchSubtotal').innerText = db.config.currency + grandTotal.toFixed(2);
            document.getElementById('purchVATAmount').innerText = db.config.currency + totalVAT.toFixed(2);
            document.getElementById('purchGrandTotal').innerText = db.config.currency + finalTotal.toFixed(2);
        }

        window.clearPurchaseForm = function () {
            if (confirm('Clear all items from purchase order?')) {
                purchaseCart = [];
                // Also reset payment method to cash
                const cashRadio = document.querySelector('input[name="purchPayment"][value="cash"]');
                if (cashRadio) {
                    cashRadio.checked = true;
                }
                // Reset discount
                const discountInput = document.getElementById('purchDiscount');
                if (discountInput) {
                    discountInput.value = '0';
                }
                renderPurchaseItems();
            }
        };

        // Helper functions for split sales payment
        window.calculateSplitSales = function () {
            try {
                const totalEl = document.getElementById('splitSalesTotal');
                if (!totalEl) {
                    console.error('splitSalesTotal element not found');
                    return;
                }
                const totalText = totalEl.innerText;
                const total = parseFloat(totalText.replace(db.config.currency, '')) || 0;
                const cash = parseFloat(document.getElementById('splitSalesCash').value) || 0;
                const bank = parseFloat(document.getElementById('splitSalesBank').value) || 0;
                const credit = parseFloat(document.getElementById('splitSalesCredit').value) || 0;
                const sum = cash + bank + credit;
                const remaining = moneyRound(total - sum);

                const remainingEl = document.getElementById('splitSalesRemaining');
                if (remainingEl) {
                    remainingEl.innerText = `${db.config.currency}${Math.abs(remaining).toFixed(2)}`;
                    if (remaining < 0) {
                        remainingEl.style.color = '#ef4444';
                    } else if (remaining > 0) {
                        remainingEl.style.color = '#fbbf24';
                    } else {
                        remainingEl.style.color = '#4ade80';
                    }
                }
            } catch (e) {
                console.error('Error in calculateSplitSales:', e);
            }
        };

        window.confirmSplitSales = function () {
            const totalText = document.getElementById('splitSalesTotal').innerText;
            const total = moneyRound(parseFloat(totalText.replace(db.config.currency, '')) || 0);
            let cash = moneyRound(parseFloat(document.getElementById('splitSalesCash').value) || 0);
            let bank = moneyRound(parseFloat(document.getElementById('splitSalesBank').value) || 0);
            let credit = moneyRound(parseFloat(document.getElementById('splitSalesCredit').value) || 0);

            // Apply round-up to the overall total for split payments as well
            const chargedTotal = Math.ceil(total);
            const roundingDiff = moneyRound(chargedTotal - total);

            // If rounding is needed, allocate it to cash first, then bank, then credit
            if (roundingDiff > 0) {
                if (cash > 0) {
                    cash = moneyRound(cash + roundingDiff);
                } else if (bank > 0) {
                    bank = moneyRound(bank + roundingDiff);
                } else {
                    credit = moneyRound(credit + roundingDiff);
                }
            }

            const sum = moneyRound(cash + bank + credit);

            // Validate split payment integrity against chargedTotal
            if (Math.abs(sum - chargedTotal) > 0.01) {
                alert(`❌ SPLIT PAYMENT MISMATCH!\n\nTotal Amount: ${db.config.currency}${chargedTotal.toFixed(2)}\nEntered Sum: ${db.config.currency}${sum.toFixed(2)}\nDifference: ${db.config.currency}${Math.abs(chargedTotal - sum).toFixed(2)}\n\nPlease correct the amounts so they match the total exactly.`);
                return;
            }

            if (cash < 0 || bank < 0 || credit < 0) {
                alert('❌ ERROR: Negative amounts not allowed!');
                return;
            }

            // Get customer info
            const custInput = document.getElementById('posCustomerInput').value;
            const custIdMatch = custInput.match(/\[ID:(\d+)\]/);
            let custId = custIdMatch ? parseInt(custIdMatch[1]) : null;
            let custName = custInput.split('[')[0].trim() || 'Guest Customer';

            // Get selected price type
            const priceType = document.querySelector('input[name="priceType"]:checked')?.value || 'retail';

            // Get discount percentage
            const discountPercent = parseFloat(document.getElementById('posDiscount').value) || 0;

            // Recalculate amounts
            const applyVat = document.getElementById('posVatToggle').checked;
            const freightCost = parseFloat(document.getElementById('posFreight').value) || 0;

            const sub = moneyRound(cart.reduce((a, c) => {
                const price = priceType === 'wholesale' ? (c.wholesale || c.retail) : c.retail;
                return a + c.qty * price;
            }, 0));
            const discount = moneyRound(sub * (discountPercent / 100));
            const subtotalAfterDiscount = moneyRound(sub - discount);

            let taxableAmount = 0;
            if (applyVat) {
                cart.forEach(item => {
                    if (!item.vatExempt) {
                        const price = priceType === 'wholesale' ? (item.wholesale || item.retail) : item.retail;
                        taxableAmount = moneyRound(taxableAmount + (item.qty * price));
                    }
                });
            }

            const taxableAfterDiscount = applyVat ? moneyRound(taxableAmount * (1 - (discountPercent / 100))) : 0;
            const tax = applyVat ? moneyRound(taxableAfterDiscount * (db.config.vatRate / 100)) : 0;
            const txnTotal = moneyRound(subtotalAfterDiscount + tax + freightCost);

            // Final validation - calculated total should match split total
            if (Math.abs(txnTotal - total) > 0.01) {
                console.warn(`WARNING: Recalculated total (${txnTotal}) differs from modal total (${total}). Using modal total.`);
            }

            if (credit > 0) {
                if (!custId) {
                    alert("Please select a registered customer for credit portion of split payment.");
                    return;
                }
                const customer = db.customers.find(c => c.id === custId);
                if (!customer) {
                    alert("Customer not found!");
                    return;
                }
                customer.balance = moneyRound(customer.balance + credit);
            }

            cart.forEach(item => {
                const prod = db.products.find(p => p.id === item.id);
                if (prod) prod.stock -= item.qty;
            });

            const itemsWithCost = cart.map(item => {
                const prod = db.products.find(p => p.id === item.id);
                return {
                    ...item,
                    cost: prod ? moneyRound(prod.cost) : 0,
                    vatExempt: item.vatExempt || false
                };
            });

            // UPDATE CASH/BANK BALANCES FOR SPLIT PAYMENT
            // FIX: Always initialize balances to 0 if undefined or NaN
            if (db.config.cashBalance === undefined || db.config.cashBalance === null || isNaN(db.config.cashBalance)) {
                db.config.cashBalance = 0;
            }
            if (db.config.bankBalance === undefined || db.config.bankBalance === null || isNaN(db.config.bankBalance)) {
                db.config.bankBalance = 0;
            }

            db.config.cashBalance = moneyRound(db.config.cashBalance + cash);
            db.config.bankBalance = moneyRound(db.config.bankBalance + bank);

            // Allow manual override of sale date via POS date picker (optional)
            const manualDateVal = document.getElementById('posManualDate')?.value;
            const txnDate = manualDateVal ? new Date(manualDateVal + 'T00:00:00').toISOString() : new Date().toISOString();

            const txn = {
                id: Date.now(),
                type: 'sale',
                date: txnDate,
                entityId: custId,
                entityName: custName,
                items: itemsWithCost,
                priceType: priceType,
                sub: sub,
                discount: discount,
                discountPercent: discountPercent,
                freight: freightCost,
                tax: tax,
                total: chargedTotal,  // Use rounded split total
                payType: 'split',
                splitCash: cash,
                splitBank: bank,
                splitCredit: credit,
                cashAmount: cash,
                bankAmount: bank,
                creditAmount: credit,
                cashBalance: db.config.cashBalance,
                bankBalance: db.config.bankBalance,
                invoiceNumber: getNextInvoiceNumber()
            };
            db.transactions.push(txn);
            saveDB();

            printInvoice(txn);
            document.getElementById('posDiscount').value = '0';
            clearCart();
            document.getElementById('posCustomerInput').value = '';
            window.closeModal();

            alert(`Split Payment Sale Complete!
Total: ${db.config.currency}${chargedTotal.toFixed(2)}

    Cash: ${db.config.currency}${cash.toFixed(2)}
    Bank: ${db.config.currency}${bank.toFixed(2)}
    Credit: ${db.config.currency}${credit.toFixed(2)}

Updated Balances:
    Cash: ${db.config.currency}${db.config.cashBalance.toFixed(2)}
    Bank: ${db.config.currency}${db.config.bankBalance.toFixed(2)}`);
        };

        // Helper function for split payment display
        window.updatePaymentDisplay = function () {
            const paymentEl = document.querySelector('input[name="purchPayment"]:checked');
            const splitSection = document.getElementById('splitPaymentSection');

            if (!paymentEl || !splitSection) return; // Elements don't exist yet

            const paymentType = paymentEl.value;

            if (paymentType === 'split') {
                splitSection.classList.remove('hidden');
            } else {
                splitSection.classList.add('hidden');
            }
        };

        window.calculateSplitCredit = function () {
            const subtotalEl = document.getElementById('purchSubtotal');
            const vatEl = document.getElementById('purchVATAmount');

            if (!subtotalEl || !vatEl) return; // Elements don't exist yet

            const subtotal = parseFloat(subtotalEl.innerText.replace(db.config.currency, '') || 0);
            const vat = parseFloat(vatEl.innerText.replace(db.config.currency, '') || 0);
            const grandTotal = subtotal + vat;
            const cashAmount = parseFloat(document.getElementById('splitCashAmount').value) || 0;
            const bankAmount = parseFloat(document.getElementById('splitBankAmount').value) || 0;
            const creditAmount = moneyRound(grandTotal - cashAmount - bankAmount);

            document.getElementById('splitCreditAmount').value = Math.max(0, creditAmount).toFixed(2);
            document.getElementById('splitTotalDisplay').innerText = `${db.config.currency}${grandTotal.toFixed(2)}`;
            document.getElementById('splitCashDisplay').innerText = `${db.config.currency}${cashAmount.toFixed(2)}`;
            document.getElementById('splitBankDisplay').innerText = `${db.config.currency}${bankAmount.toFixed(2)}`;
            document.getElementById('splitCreditDisplay').innerText = `${db.config.currency}${Math.max(0, creditAmount).toFixed(2)}`;
        };

        document.getElementById('purchForm').onsubmit = e => {
            e.preventDefault();
            const supEl = document.getElementById('poSup');
            let paymentEl = document.querySelector('input[name="purchPayment"]:checked');
            const dateEl = document.getElementById('purchaseDate');

            // Default to cash if no payment method selected
            if (!paymentEl) {
                const cashRadio = document.querySelector('input[name="purchPayment"][value="cash"]');
                if (cashRadio) {
                    cashRadio.checked = true;
                    paymentEl = cashRadio;
                }
            }

            if (!supEl || !paymentEl || !dateEl) {
                alert('Form elements not found. Please refresh the page.');
                return;
            }

            const supId = parseInt(supEl.value);
            const ref = 'PO-' + Date.now().toString().slice(-6);
            const paymentMethod = paymentEl.value;
            console.log('Purchase Form - Payment Method Selected:', paymentMethod);
            const purchaseDateInput = dateEl.value;

            if (!supId) {
                alert('Please select a supplier');
                return;
            }

            if (!purchaseDateInput) {
                alert('Please select a purchase date');
                return;
            }

            if (purchaseCart.length === 0) {
                alert('Add at least one item to the purchase order');
                return;
            }

            const sup = db.suppliers.find(s => s.id === supId);
            if (!sup) return;

            let subtotalAmount = 0;
            let totalVAT = 0;
            const txnItems = [];
            // COMPREHENSIVE DATE HANDLING FOR PURCHASE: Check both English and Nepali fields
            const purchaseDateEngVal = document.getElementById('purchaseDate')?.value;
            const purchaseDateNepVal = document.getElementById('purchaseDateNep')?.value;
            const isNepaliMode = db.config.dateMode === 'nepali';

            let purchaseDate;

            console.log('=== PURCHASE ORDER DATE DEBUG ===');
            console.log('Date Mode:', db.config.dateMode);
            console.log('English Date Field Value:', purchaseDateEngVal);
            console.log('Nepali Date Field Value:', purchaseDateNepVal);

            // Determine which date to use based on mode and which field has a value
            if (isNepaliMode && purchaseDateNepVal) {
                // Nepali mode with Nepali date selected
                console.log('Using Nepali date field for purchase');
                const convertedEngDate = window.convertNepToEng(purchaseDateNepVal);
                console.log('Converted to English date:', convertedEngDate);

                if (convertedEngDate) {
                    purchaseDate = convertedEngDate; // Already in YYYY-MM-DD format
                    console.log('Purchase Date set to:', purchaseDate);
                } else {
                    console.warn('Nepali date conversion failed, using current date');
                    purchaseDate = new Date().toISOString().split('T')[0];
                }
            } else if (purchaseDateEngVal) {
                // English mode or English date is available
                console.log('Using English date field for purchase');
                purchaseDate = purchaseDateEngVal;
                console.log('Purchase Date set to:', purchaseDate);
            } else {
                // No manual date selected, use current date
                console.log('No manual date selected, using current date');
                purchaseDate = new Date().toISOString().split('T')[0];
            }

            console.log('Final Purchase Date:', purchaseDate);
            console.log('Formatted for display:', window.formatDate(purchaseDate));
            console.log('==================================');
            const vatRate = db.config.vatRate || 13;
            const discountPercent = parseFloat(document.getElementById('purchDiscount').value) || 0;

            purchaseCart.forEach(item => {
                if (!item.productId) {
                    alert('Please select a product for all items');
                    return;
                }

                const origProd = db.products.find(p => p.id === item.productId);
                if (!origProd) return;

                const newProductId = Math.floor(Date.now() + Math.random() * 10000);
                const itemTotal = moneyRound(item.qty * item.unitPrice);
                subtotalAmount = moneyRound(subtotalAmount + itemTotal);

                // Calculate VAT for this item
                const itemVAT = item.vatStatus === 'vat' ? moneyRound(itemTotal * vatRate / 100) : 0;
                totalVAT = moneyRound(totalVAT + itemVAT);

                // Create new batch entry
                db.products.push({
                    id: newProductId,
                    name: origProd.name,
                    sku: origProd.sku,
                    category: origProd.category,
                    batch: item.batch || 'N/A',
                    expiry: item.expiry || 'N/A',
                    cost: item.unitPrice,
                    retail: origProd.retail,
                    wholesale: origProd.wholesale,
                    stock: item.qty,
                    reorder: origProd.reorder,
                    purchaseDate: purchaseDate,
                    supplierId: supId,
                    supplierName: sup.name,
                    ref: ref
                });

                if (!db.batches) db.batches = [];
                db.batches.push({
                    id: Math.floor(Date.now() + Math.random() * 10000),
                    productId: newProductId,
                    productName: origProd.name,
                    batchNumber: item.batch || 'N/A',
                    expiryDate: item.expiry || 'N/A',
                    quantity: item.qty,
                    costPrice: item.unitPrice,
                    purchaseDate: purchaseDate,
                    supplierId: supId,
                    supplierName: sup.name,
                    ref: ref
                });

                txnItems.push({
                    id: newProductId,
                    name: origProd.name,
                    qty: item.qty,
                    cost: item.unitPrice,
                    unitPrice: item.unitPrice,
                    total: moneyRound(item.qty * item.unitPrice),
                    vatStatus: item.vatStatus || 'vat',
                    batch: item.batch || 'N/A',
                    expiry: item.expiry || 'N/A'
                });
            });

            // Calculate discount amount
            const discountAmount = moneyRound(subtotalAmount * (discountPercent / 100));
            const subtotalAfterDiscount = moneyRound(subtotalAmount - discountAmount);

            // FIX: Discount should apply to VAT base (subtotal BEFORE VAT), not to VAT itself
            // Recalculate VAT on the discounted subtotal
            const vatAfterDiscount = moneyRound(subtotalAfterDiscount * (db.config.vatRate / 100));

            // Calculate grand total with VAT
            const totalAmount = moneyRound(subtotalAfterDiscount + vatAfterDiscount);

            // FIX: Handle payment method properly
            let creditAmount = 0;
            let cashAmount = 0;
            let bankAmount = 0;

            // Initialize balances
            if (!db.config.cashBalance) db.config.cashBalance = 0;
            if (!db.config.bankBalance) db.config.bankBalance = 0;
            if (sup.balance === undefined || sup.balance === null) sup.balance = 0; // FIX: Initialize supplier balance to prevent NaN

            console.log('Before payment logic - paymentMethod:', paymentMethod, 'supplier.balance:', sup.balance);

            if (paymentMethod === 'credit') {
                creditAmount = totalAmount;
                sup.balance = moneyRound((sup.balance || 0) + totalAmount);
                console.log('CREDIT payment - supplier balance increased to:', sup.balance);
            } else if (paymentMethod === 'cash') {
                cashAmount = totalAmount;
                db.config.cashBalance = moneyRound(db.config.cashBalance - totalAmount);
                console.log('CASH payment - cash balance decreased, supplier balance unchanged:', sup.balance);
            } else if (paymentMethod === 'bank') {
                bankAmount = totalAmount;
                db.config.bankBalance = moneyRound(db.config.bankBalance - totalAmount);
                console.log('BANK payment - bank balance decreased, supplier balance unchanged:', sup.balance);
            } else if (paymentMethod === 'split') {
                cashAmount = moneyRound(parseFloat(document.getElementById('splitCashAmount').value) || 0);
                bankAmount = moneyRound(parseFloat(document.getElementById('splitBankAmount').value) || 0);
                creditAmount = moneyRound(totalAmount - cashAmount - bankAmount);
                db.config.cashBalance = moneyRound(db.config.cashBalance - cashAmount);
                db.config.bankBalance = moneyRound(db.config.bankBalance - bankAmount);

                if (cashAmount < 0 || bankAmount < 0 || creditAmount < 0) {
                    alert('Invalid split payment amounts');
                    return;
                }

                // Only add credit portion to supplier balance
                if (creditAmount > 0) {
                    sup.balance = moneyRound((sup.balance || 0) + creditAmount);
                }
            }

            db.transactions.push({
                id: Date.now(),
                type: 'purchase',
                date: purchaseDate,
                entityId: supId,
                entityName: sup.name,
                items: txnItems,
                discount: discountAmount,
                discountPercent: discountPercent,
                subtotal: subtotalAmount,
                total: totalAmount,
                payType: paymentMethod,
                cashAmount: cashAmount,
                bankAmount: bankAmount,
                creditAmount: creditAmount,
                ref: ref,
                supplierInvoiceNumber: document.getElementById('supplierInvoiceNumber').value,
                cashBalance: db.config.cashBalance,
                bankBalance: db.config.bankBalance,
                purchaseDate: purchaseDate
            });

            // Store the purchase for printing
            const purchaseInvoice = {
                id: Date.now(),
                ref: ref,
                supplierInvoiceNumber: document.getElementById('supplierInvoiceNumber').value,
                date: purchaseDate,
                supplier: sup.name,
                supplierId: supId,
                items: purchaseCart.map(item => ({
                    ...item,
                    productId: item.productId,
                    productName: item.productName,
                    qty: item.qty,
                    unitPrice: item.unitPrice,
                    total: moneyRound(item.qty * item.unitPrice),
                    vatStatus: item.vatStatus || 'vat',
                    batch: item.batch || 'N/A',
                    expiry: item.expiry || 'N/A'
                })),
                subtotal: subtotalAmount,
                discount: discountAmount,
                discountPercent: discountPercent,
                totalVAT: totalVAT,
                totalAmount: totalAmount,
                paymentMethod: paymentMethod,
                payType: paymentMethod,
                cashAmount: cashAmount,
                bankAmount: bankAmount,
                creditAmount: creditAmount
            };

            saveDB();
            window.closeModal();

            // Reset purchase cart and discount
            purchaseCart = [];
            document.getElementById('purchDiscount').value = '0';
            renderPurchaseItems();

            let message = '';
            if (paymentMethod === 'cash') {
                message = `CASH PURCHASE saved!\nSupplier: ${sup.name}\nAmount: ${db.config.currency}${totalAmount.toFixed(2)}\nPaid in Cash\n\nCash Balance: ${db.config.currency}${db.config.cashBalance.toFixed(2)}\nBank Balance: ${db.config.currency}${db.config.bankBalance.toFixed(2)}`;
            } else if (paymentMethod === 'bank') {
                message = `BANK PAYMENT PURCHASE saved!\nSupplier: ${sup.name}\nAmount: ${db.config.currency}${totalAmount.toFixed(2)}\nPaid via Bank\n\nCash Balance: ${db.config.currency}${db.config.cashBalance.toFixed(2)}\nBank Balance: ${db.config.currency}${db.config.bankBalance.toFixed(2)}`;
            } else if (paymentMethod === 'credit') {
                message = `PURCHASE ON CREDIT saved!\nSupplier: ${sup.name}\nAmount: ${db.config.currency}${totalAmount.toFixed(2)}\nBalance Due: ${db.config.currency}${sup.balance.toFixed(2)}`;
            } else if (paymentMethod === 'split') {
                message = `SPLIT PAYMENT PURCHASE saved!\nSupplier: ${sup.name}\nTotal: ${db.config.currency}${totalAmount.toFixed(2)}\n\nCash: ${db.config.currency}${cashAmount.toFixed(2)}\nBank: ${db.config.currency}${bankAmount.toFixed(2)}\nCredit: ${db.config.currency}${creditAmount.toFixed(2)}\nBalance Due: ${db.config.currency}${sup.balance.toFixed(2)}\n\nCash Balance: ${db.config.currency}${db.config.cashBalance.toFixed(2)}\nBank Balance: ${db.config.currency}${db.config.bankBalance.toFixed(2)}`;
            }

            // Show a non-blocking toast and open the print preview (print dialog)
            try {
                showToast(message, 'success');
            } catch (e) {
                // fallback to alert if toast is not available
                try { alert(message); } catch (err) { console.log(message); }
            }

            renderProducts();

            // Automatically open print preview (browser print dialog)
            try {
                if (typeof printPurchaseInvoice === 'function') {
                    // This function opens a new window and triggers print()
                    printPurchaseInvoice(purchaseInvoice);
                } else if (typeof displayPurchaseInvoiceModal === 'function') {
                    // Fallback to modal preview if print function missing
                    displayPurchaseInvoiceModal(purchaseInvoice);
                }
            } catch (err) {
                console.error('Error opening purchase print preview:', err);
            }
        };

        document.getElementById('expForm').onsubmit = e => {
            e.preventDefault();

            const expenseAmount = moneyRound(parseFloat(document.getElementById('expAmt').value));
            const expenseDesc = document.getElementById('expDesc').value;
            const paymentMode = document.querySelector('input[name="expPayment"]:checked').value;

            // Initialize balances if needed
            if (!db.config.cashBalance && db.config.cashBalance !== 0) db.config.cashBalance = 0;
            if (!db.config.bankBalance && db.config.bankBalance !== 0) db.config.bankBalance = 0;

            // Deduct from selected payment mode
            if (paymentMode === 'cash') {
                db.config.cashBalance = moneyRound(db.config.cashBalance - expenseAmount);
            } else if (paymentMode === 'bank') {
                db.config.bankBalance = moneyRound(db.config.bankBalance - expenseAmount);
            }

            // Record expense transaction with payment mode
            const expenseId = Date.now();
            db.transactions.push({
                id: expenseId,
                type: 'expense',
                date: new Date().toISOString(),
                description: expenseDesc,
                items: [{ name: expenseDesc }],
                total: expenseAmount,
                paymentMode: paymentMode,
                cashBalance: db.config.cashBalance,
                bankBalance: db.config.bankBalance
            });

            // Save immediately without debounce for critical data
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            if (firebaseAvailable && dbRealtime && currentUser) {
                const userRef = ref(dbRealtime, 'users/' + currentUser.uid + '/data');
                set(userRef, db).catch(err => console.error("Firebase error:", err));
            }

            saveDB();
            window.closeModal();

            alert(`✓ Expense Recorded!\n\nDescription: ${expenseDesc}\nAmount: ${db.config.currency}${expenseAmount.toFixed(2)}\nPaid from: ${paymentMode.toUpperCase()}\n\nCash Balance: ${db.config.currency}${db.config.cashBalance.toFixed(2)}\nBank Balance: ${db.config.currency}${db.config.bankBalance.toFixed(2)}`);

            loadDashboard();
        };

        // DELETE EXPENSE FUNCTION - Undo the expense and restore payment mode
        window.deleteExpense = function (expenseId) {
            const expense = db.transactions.find(t => t.id === expenseId && t.type === 'expense');

            if (!expense) {
                alert('Expense not found!');
                return;
            }

            if (!confirm(`Delete this expense?\n\nDescription: ${expense.description}\nAmount: ${db.config.currency}${expense.total.toFixed(2)}\nPaid from: ${(expense.paymentMode || 'cash').toUpperCase()}\n\nThis will restore the amount to ${(expense.paymentMode || 'cash').toUpperCase()}.`)) {
                return;
            }

            console.log('=== DELETING EXPENSE ===');
            console.log('Expense:', expense);

            // Restore payment mode
            const payMode = expense.paymentMode || 'cash';
            if (payMode === 'cash') {
                db.config.cashBalance = moneyRound(db.config.cashBalance + expense.total);
                console.log(`✓ Cash restored: +${db.config.currency}${expense.total.toFixed(2)} → Cash: ${db.config.currency}${db.config.cashBalance.toFixed(2)}`);
            } else if (payMode === 'bank') {
                db.config.bankBalance = moneyRound(db.config.bankBalance + expense.total);
                console.log(`✓ Bank restored: +${db.config.currency}${expense.total.toFixed(2)} → Bank: ${db.config.currency}${db.config.bankBalance.toFixed(2)}`);
            }

            // Delete expense from transactions
            db.transactions = db.transactions.filter(t => t.id !== expenseId);
            console.log(`✓ Expense deleted from database`);

            // Save immediately without debounce for critical delete
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            if (firebaseAvailable && dbRealtime && currentUser) {
                const userRef = ref(dbRealtime, 'users/' + currentUser.uid + '/data');
                set(userRef, db).catch(err => console.error("Firebase error:", err));
            }

            saveDB();
            loadDashboard();

            alert(`✓ EXPENSE DELETED!\n\n${(expense.paymentMode || 'cash').toUpperCase()}: +${db.config.currency}${expense.total.toFixed(2)}\n\nCash Balance: ${db.config.currency}${db.config.cashBalance.toFixed(2)}\nBank Balance: ${db.config.currency}${db.config.bankBalance.toFixed(2)}`);
        };

        // --- POS Logic ---
        function loadPOS() {
            // AUTO-CLEAN: Remove old stock products with 0 qty if newer stock exists
            if (!db.products) db.products = [];

            const productNames = {};
            db.products.forEach(p => {
                if (!productNames[p.name]) productNames[p.name] = [];
                productNames[p.name].push(p);
            });

            // For each product name, if we have multiple batches
            Object.keys(productNames).forEach(name => {
                const variants = productNames[name];
                if (variants.length > 1) {
                    // Sort by expiry date - oldest first (FEFO: First Expire, First Out)
                    variants.sort((a, b) => {
                        const expiryA = a.expiry ? new Date(a.expiry) : new Date('2099-12-31');
                        const expiryB = b.expiry ? new Date(b.expiry) : new Date('2099-12-31');
                        return expiryA - expiryB;
                    });

                    // Check if we have at least one variant with stock > 0
                    const hasNewStock = variants.some(v => v.stock > 0);

                    // If newer stock exists, delete old items with 0 quantity
                    if (hasNewStock) {
                        variants.forEach((v, idx) => {
                            if (idx > 0 && v.stock === 0) {
                                // FIX #4: MISSING HISTORY - Mark as hidden instead of deleting
                                v.hidden = true;
                            }
                        });
                    }
                }
            });

            const grid = document.getElementById('posGrid');
            grid.innerHTML = '';
            const rawSearch = document.getElementById('posSearch').value || '';
            const search = rawSearch.trim().toLowerCase();
            const tokens = search.split(/\s+/).filter(Boolean);

            // Filter out zero-stock duplicates before displaying
            const displayProducts = filterDuplicateZeroStockProducts(db.products);

            displayProducts.filter(p => {
                if (!p || p.stock <= 0) return false;
                // If no search query, include product
                if (tokens.length === 0) return true;

                const name = (p.name || '').toLowerCase();
                const sku = (p.sku || '').toLowerCase();
                const batch = (p.batch || '').toLowerCase();
                const category = (p.category || '').toLowerCase();

                // Require every token to match at least one searchable field (name, sku, batch, category)
                return tokens.every(tok => name.includes(tok) || sku.includes(tok) || batch.includes(tok) || category.includes(tok));
            }).forEach(p => {
                const el = document.createElement('div');
                el.className = "bg-gradient-to-br from-karta-surface to-gray-900 border-2 border-karta-border p-4 rounded-lg cursor-pointer hover:border-karta-primary hover:shadow-lg hover:shadow-karta-primary/30 transition-all transform hover:scale-105 flex flex-col h-full min-h-[200px]";
                // FIX: Use closure or string ID
                el.onclick = () => addToCart(p);
                el.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs bg-karta-primary text-black px-2 py-1 rounded font-bold">${p.sku}</span>
                        <span class="text-sm font-bold text-karta-primary bg-gray-800 px-2 py-1 rounded">Stock: ${p.stock}</span>
                    </div>
                    <div class="font-bold text-white text-base mb-2 leading-snug flex-1">${p.name}</div>
                    <div class="text-xs text-gray-400 space-y-1 mb-3 border-t border-gray-700 pt-2">
                        <div><span class="text-gray-500">Batch:</span> <span class="${p.batch && p.batch !== 'N/A' ? 'text-white font-semibold' : 'text-gray-500'}">${p.batch || 'N/A'}</span></div>
                        <div><span class="text-gray-500">Expires:</span> <span class="${p.expiry && p.expiry !== 'N/A' ? 'text-yellow-400 font-semibold' : 'text-gray-500'}">${p.expiry ? window.formatDate(p.expiry) : 'N/A'}</span></div>
                    </div>
                    <div class="text-karta-primary font-bold text-lg mt-auto">${db.config.currency}${p.retail}</div>
                `;
                grid.appendChild(el);
            });
        }

        function addToCart(p) {
            const qtyInput = document.getElementById('posQtyInput');
            let manualQty = parseInt(qtyInput.value) || 1;
            if (manualQty < 1) manualQty = 1;

            const exist = cart.find(i => i.id === p.id);

            if (exist) {
                if (exist.qty + manualQty <= p.stock) {
                    exist.qty += manualQty;
                } else {
                    alert("Not enough stock!");
                }
            } else {
                if (manualQty <= p.stock) {
                    cart.push({ ...p, qty: manualQty });
                } else {
                    alert("Not enough stock!");
                }
            }
            renderCart();
            qtyInput.value = 1;
        }

        window.updateCartQty = function (idx, change) {
            const item = cart[idx];
            const product = db.products.find(p => p.id === item.id);
            const newQty = item.qty + change;

            if (newQty > 0 && newQty <= product.stock) {
                item.qty = newQty;
                renderCart();
            } else if (newQty > product.stock) {
                alert("Max stock reached!");
            }
        }

        window.removeFromCart = function (idx) {
            if (idx >= 0 && idx < cart.length) {
                cart.splice(idx, 1);
                renderCart();
            }
        }

        let editPriceIdx = null;
        window.openEditPriceModal = function (idx) {
            if (idx < 0 || idx >= cart.length) return;
            editPriceIdx = idx;
            const item = cart[idx];
            document.getElementById('editPriceItemName').innerText = item.name;
            document.getElementById('editPriceOriginal').innerText = `${db.config.currency}${item.retail.toFixed(2)}`;
            document.getElementById('editPriceInput').value = item.retail;
            document.getElementById('editPriceWholesaleInput').value = item.wholesale || item.retail;
            window.openModal('editPriceModal');
        }

        window.applyEditPrice = function () {
            if (editPriceIdx === null || editPriceIdx < 0 || editPriceIdx >= cart.length) return;
            const newRetailPrice = parseFloat(document.getElementById('editPriceInput').value);
            const newWholesalePrice = parseFloat(document.getElementById('editPriceWholesaleInput').value);

            if (isNaN(newRetailPrice) || newRetailPrice < 0) {
                alert('Please enter a valid retail price');
                return;
            }
            if (isNaN(newWholesalePrice) || newWholesalePrice < 0) {
                alert('Please enter a valid wholesale price');
                return;
            }

            cart[editPriceIdx].retail = newRetailPrice;
            cart[editPriceIdx].wholesale = newWholesalePrice;
            renderCart();
            closeModal();
            editPriceIdx = null;
        }

        window.renderCart = function () {
            const body = document.getElementById('posCartBody');
            body.innerHTML = '';
            let sub = 0;
            let taxableAmount = 0;

            // Get selected price type
            const priceType = document.querySelector('input[name="priceType"]:checked')?.value || 'retail';

            // Check VAT Toggle
            const applyVat = document.getElementById('posVatToggle').checked;

            // Get discount percentage
            const discountPercent = parseFloat(document.getElementById('posDiscount').value) || 0;

            if (cart.length === 0) {
                body.innerHTML = `<div class="flex h-full items-center justify-center text-gray-600 flex-col py-8 md:py-0"><i class="fa-solid fa-basket-shopping text-4xl mb-2"></i><p>Cart is empty</p></div>`;
            } else {
                cart.forEach((item, idx) => {
                    // Use selected price type (retail or wholesale)
                    const price = priceType === 'wholesale' ? (item.wholesale || item.retail) : item.retail;
                    const itemTotal = moneyRound(price * item.qty);
                    sub = moneyRound(sub + itemTotal);

                    // Track taxable amount (excluding VAT exempt items)
                    if (!item.vatExempt) {
                        taxableAmount = moneyRound(taxableAmount + itemTotal);
                    }

                    const row = document.createElement('div');
                    row.className = "flex flex-col bg-white/5 p-2 rounded text-xs mb-1";
                    row.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <div class="text-white font-bold">${item.name}</div>
                                <div class="text-gray-400">${db.config.currency}${price.toFixed(2)} ${priceType === 'wholesale' ? '<span class="text-blue-400">(W)</span>' : ''}</div>
                            </div>
                            <div class="flex items-center gap-2 mx-2">
                                <button onclick="updateCartQty(${idx}, -1)" class="w-5 h-5 bg-gray-700 rounded hover:bg-gray-600 text-[10px]">-</button>
                                <span class="font-bold w-3 text-center text-[10px]">${item.qty}</span>
                                <button onclick="updateCartQty(${idx}, 1)" class="w-5 h-5 bg-gray-700 rounded hover:bg-gray-600 text-[10px]">+</button>
                            </div>
                            <div class="font-bold mr-2 w-14 text-right">${db.config.currency}${itemTotal.toFixed(2)}</div>
                            <button onclick="openEditPriceModal(${idx})" class="text-blue-400 hover:text-blue-300 transition p-1 text-[10px]" title="Edit Price"><i class="fa-solid fa-edit"></i></button>
                            <button onclick="removeFromCart(${idx})" class="text-red-500 hover:text-red-400 transition p-1 text-[10px]"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <div class="mt-1 flex items-center gap-2">
                            <button onclick="toggleVatExempt(${idx})" class="flex-1 text-[9px] px-2 py-1 rounded ${item.vatExempt ? 'bg-red-600/50 text-red-300 border border-red-500' : 'bg-gray-700 text-gray-300 border border-gray-600'} hover:bg-opacity-75 transition">
                                <i class="fa-solid ${item.vatExempt ? 'fa-ban' : 'fa-receipt'} mr-1"></i>${item.vatExempt ? 'VAT Exempt' : 'Apply VAT'}
                            </button>
                        </div>
                    `;
                    body.appendChild(row);
                });
            }

            // Get Freight Charge
            const freightCost = parseFloat(document.getElementById('posFreight').value) || 0;

            // Calculate discount amount
            const discountAmount = moneyRound(sub * (discountPercent / 100));
            const subtotalAfterDiscount = moneyRound(sub - discountAmount);

            // Calculate tax only on taxable items
            const tax = applyVat ? moneyRound(subtotalAfterDiscount * (taxableAmount / sub) * (db.config.vatRate / 100)) : 0;

            // Calculate final total with Freight Charge
            const finalTotal = moneyRound(subtotalAfterDiscount + tax + freightCost);

            document.getElementById('posSubTotal').innerText = `${db.config.currency}${sub.toFixed(2)}`;
            document.getElementById('posVatRate').innerText = db.config.vatRate;
            document.getElementById('posTax').innerText = `${db.config.currency}${tax.toFixed(2)}`;
            // If No VAT, strike through or dim the tax text
            document.getElementById('posTax').className = applyVat ? "" : "line-through text-gray-600";

            document.getElementById('posTotal').innerText = `${db.config.currency}${finalTotal.toFixed(2)}`;
        }

        window.toggleVatExempt = function (idx) {
            if (idx >= 0 && idx < cart.length) {
                cart[idx].vatExempt = !cart[idx].vatExempt;
                renderCart();
            }
        }

        window.clearCart = function () { cart = []; renderCart(); }

        window.checkout = function (type) {
            if (cart.length === 0) return alert("Empty Cart");

            // For split payment, show split modal instead of direct checkout
            if (type === 'split') {
                try {
                    const priceType = document.querySelector('input[name="priceType"]:checked')?.value || 'retail';
                    const discountPercent = parseFloat(document.getElementById('posDiscount').value) || 0;
                    const freightCost = parseFloat(document.getElementById('posFreight').value) || 0;
                    const applyVat = document.getElementById('posVatToggle').checked;

                    const sub = moneyRound(cart.reduce((a, c) => {
                        const price = priceType === 'wholesale' ? (c.wholesale || c.retail) : c.retail;
                        return a + c.qty * price;
                    }, 0));

                    const discount = moneyRound(sub * (discountPercent / 100));
                    const subtotalAfterDiscount = moneyRound(sub - discount);

                    let taxableAmount = 0;
                    if (applyVat) {
                        cart.forEach(item => {
                            if (!item.vatExempt) {
                                const price = priceType === 'wholesale' ? (item.wholesale || item.retail) : item.retail;
                                taxableAmount = moneyRound(taxableAmount + (item.qty * price));
                            }
                        });
                    }

                    const taxableAfterDiscount = applyVat ? moneyRound(taxableAmount * (1 - (discountPercent / 100))) : 0;
                    const tax = applyVat ? moneyRound(taxableAfterDiscount * (db.config.vatRate / 100)) : 0;
                    const total = moneyRound(subtotalAfterDiscount + tax + freightCost);

                    const totalEl = document.getElementById('splitSalesTotal');
                    const cashEl = document.getElementById('splitSalesCash');
                    const bankEl = document.getElementById('splitSalesBank');
                    const creditEl = document.getElementById('splitSalesCredit');

                    if (!totalEl || !cashEl || !bankEl || !creditEl) {
                        console.error('Split payment modal elements not found');
                        alert('Split payment modal not found. Please refresh the page.');
                        return;
                    }

                    totalEl.innerText = `${db.config.currency}${total.toFixed(2)}`;
                    cashEl.value = '';
                    bankEl.value = '';
                    creditEl.value = '';
                    calculateSplitSales();
                    window.openModal('splitSalesModal');
                    return;
                } catch (e) {
                    console.error('Error in split payment:', e);
                    alert('Error opening split payment modal. Check console.');
                    return;
                }
            }

            const custInput = document.getElementById('posCustomerInput').value;
            const custIdMatch = custInput.match(/\[ID:(\d+)\]/);
            let custId = custIdMatch ? parseInt(custIdMatch[1]) : null;
            let custName = custInput.split('[')[0].trim() || 'Guest Customer';

            // Get selected price type
            const priceType = document.querySelector('input[name="priceType"]:checked')?.value || 'retail';

            // Get discount percentage
            const discountPercent = parseFloat(document.getElementById('posDiscount').value) || 0;

            // Get Freight Charge
            const freightCost = parseFloat(document.getElementById('posFreight').value) || 0;

            // Recalculate based on current price type, discount, and VAT toggle
            const applyVat = document.getElementById('posVatToggle').checked;
            const sub = moneyRound(cart.reduce((a, c) => {
                const price = priceType === 'wholesale' ? (c.wholesale || c.retail) : c.retail;
                return a + c.qty * price;
            }, 0));
            const discount = moneyRound(sub * (discountPercent / 100));
            const subtotalAfterDiscount = moneyRound(sub - discount);

            // Calculate VAT only on taxable items (excluding VAT exempt items)
            let taxableAmount = 0;
            if (applyVat) {
                cart.forEach(item => {
                    if (!item.vatExempt) {
                        const price = priceType === 'wholesale' ? (item.wholesale || item.retail) : item.retail;
                        taxableAmount = moneyRound(taxableAmount + (item.qty * price));
                    }
                });
            }

            // Apply discount proportionally to taxable amount
            const taxableAfterDiscount = applyVat ? moneyRound(taxableAmount * (1 - (discountPercent / 100))) : 0;
            const tax = applyVat ? moneyRound(taxableAfterDiscount * (db.config.vatRate / 100)) : 0;
            const total = moneyRound(subtotalAfterDiscount + tax + freightCost);

            // Compute chargedTotal (round-up) early so credit handling uses it as well
            let chargedTotal = total;
            if (type === 'cash' || type === 'bank' || type === 'credit') {
                chargedTotal = Math.ceil(total);
            }

            if (type === 'credit') {
                if (!custId) return alert("Please select a registered customer for credit sales.");
                const customer = db.customers.find(c => c.id === custId);
                if (!customer) return alert("Customer not found.");
                // Credit sales are rounded up too
                customer.balance = moneyRound(customer.balance + chargedTotal);
            }

            cart.forEach(item => {
                const prod = db.products.find(p => p.id === item.id);
                if (prod) prod.stock -= item.qty;
            });

            // Store cost per unit and VAT exemption status with each item
            const itemsWithCost = cart.map(item => {
                const prod = db.products.find(p => p.id === item.id);
                return {
                    ...item,
                    cost: prod ? moneyRound(prod.cost) : 0,
                    vatExempt: item.vatExempt || false
                };
            });

            // UPDATE CASH/BANK BALANCES BEFORE TRANSACTION
            // FIX: Always initialize balances to 0 if undefined
            if (db.config.cashBalance === undefined || db.config.cashBalance === null || isNaN(db.config.cashBalance)) {
                db.config.cashBalance = 0;
            }
            if (db.config.bankBalance === undefined || db.config.bankBalance === null || isNaN(db.config.bankBalance)) {
                db.config.bankBalance = 0;
            }

            // Round-up behavior already computed earlier (chargedTotal). Example: 999.34 -> 1000
            if (type === 'cash') {
                // Don't prevent negative balance, but warn user
                db.config.cashBalance = moneyRound(db.config.cashBalance + chargedTotal);
            } else if (type === 'bank') {
                // Don't prevent negative balance, but warn user
                db.config.bankBalance = moneyRound(db.config.bankBalance + chargedTotal);
            }

            // Allow manual override of sale date via POS date picker (optional)
            // COMPREHENSIVE DATE HANDLING: Check both English and Nepali fields
            const manualDateEngVal = document.getElementById('posManualDate')?.value;
            const manualDateNepVal = document.getElementById('posManualDateNep')?.value;
            const isNepaliMode = db.config.dateMode === 'nepali';

            let txnDate;
            let selectedDateForDisplay = '';

            console.log('=== POS CHECKOUT DATE DEBUG ===');
            console.log('Date Mode:', db.config.dateMode);
            console.log('English Date Field Value:', manualDateEngVal);
            console.log('Nepali Date Field Value:', manualDateNepVal);

            // Determine which date to use based on mode and which field has a value
            if (isNepaliMode && manualDateNepVal) {
                // Nepali mode with Nepali date selected
                console.log('Using Nepali date field');
                // Convert Nepali date to English date
                const convertedEngDate = window.convertNepToEng(manualDateNepVal);
                console.log('Converted to English date:', convertedEngDate);

                if (convertedEngDate) {
                    const dateParts = convertedEngDate.split('-');
                    const year = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1;
                    const day = parseInt(dateParts[2]);
                    const localDate = new Date(year, month, day, 0, 0, 0, 0);
                    txnDate = localDate.toISOString();
                    selectedDateForDisplay = manualDateNepVal; // Store the Nepali date for logging
                    console.log('Created ISO date:', txnDate);
                } else {
                    console.warn('Nepali date conversion failed, using current date');
                    txnDate = new Date().toISOString();
                }
            } else if (manualDateEngVal) {
                // English mode or English date is available
                console.log('Using English date field');
                const dateParts = manualDateEngVal.split('-');
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]) - 1;
                const day = parseInt(dateParts[2]);
                const localDate = new Date(year, month, day, 0, 0, 0, 0);
                txnDate = localDate.toISOString();
                selectedDateForDisplay = manualDateEngVal;
                console.log('Created ISO date:', txnDate);
            } else {
                // No manual date selected, use current date
                console.log('No manual date selected, using current date');
                txnDate = new Date().toISOString();
            }

            console.log('Final ISO Date:', txnDate);
            console.log('Formatted for display:', window.formatDate(txnDate));
            console.log('===============================');

            const txn = {
                id: Date.now(),
                type: 'sale',
                date: txnDate,
                entityId: custId,
                entityName: custName,
                items: itemsWithCost,
                priceType: priceType,
                sub: sub,
                discount: discount,
                discountPercent: discountPercent,
                freight: freightCost,
                tax: tax,
                total: chargedTotal,
                payType: type,
                cashAmount: type === 'cash' ? chargedTotal : 0,
                bankAmount: type === 'bank' ? chargedTotal : 0,
                creditAmount: type === 'credit' ? chargedTotal : 0,
                cashBalance: db.config.cashBalance,
                bankBalance: db.config.bankBalance,
                invoiceNumber: getNextInvoiceNumber()
            };
            db.transactions.push(txn);
            saveDB();

            // Refresh POS grid instantly to hide sold-out items
            loadPOS();

            if (type === 'cash' || type === 'bank' || type === 'credit') {
                printInvoice(txn);
                if (type === 'cash' || type === 'bank') {
                    alert(`✅ Sale Recorded!\nAmount: ${db.config.currency}${total.toFixed(2)}\nPayment: ${type.toUpperCase()}\n\n💰 Cash Balance: ${db.config.currency}${db.config.cashBalance.toFixed(2)}\n🏦 Bank Balance: ${db.config.currency}${db.config.bankBalance.toFixed(2)}`);
                } else {
                    alert(`✅ Sale Recorded Successfully!\nPayment: ${type.toUpperCase()}\nAmount: ${db.config.currency}${total.toFixed(2)}`);
                }
            } else {
                alert(`✅ Sale Recorded Successfully!\nPayment: ${type.toUpperCase()}\nAmount: ${db.config.currency}${total.toFixed(2)}`);
            }

            document.getElementById('posDiscount').value = '0';
            clearCart();
            document.getElementById('posCustomerInput').value = '';
            // Reset to retail price after checkout
            document.querySelector('input[name="priceType"][value="retail"]').checked = true;

            // Refresh dashboard to update KPIs
            loadDashboard();
        };

        // --- RETURNS & REFUNDS LOGIC ---
        // Return carts for multiple items
        let retCustCart = [];
        let retSupCart = [];

        window.toggleReturnSplit = function (mode) {
            const paymentMode = document.querySelector(`input[name="ret${mode === 'cust' ? 'Cust' : 'Sup'}Payment"]:checked`)?.value || 'cash';
            const splitDiv = document.getElementById(`ret${mode === 'cust' ? 'Cust' : 'Sup'}SplitDiv`);
            const splitInputs = document.querySelectorAll(`#ret${mode === 'cust' ? 'Cust' : 'Sup'}Split${mode === 'cust' ? 'C' : ''}ash, #ret${mode === 'cust' ? 'Cust' : 'Sup'}SplitBank, #ret${mode === 'cust' ? 'Cust' : 'Sup'}SplitCredit`);

            if (paymentMode === 'split') {
                splitDiv.classList.remove('hidden');
                // Add change listeners to split inputs
                splitInputs.forEach(input => {
                    input.addEventListener('input', () => window.calculateReturnSplitTotal(mode));
                });
            } else {
                splitDiv.classList.add('hidden');
                // Reset split values
                document.getElementById(`ret${mode === 'cust' ? 'Cust' : 'Sup'}SplitCash`).value = '';
                document.getElementById(`ret${mode === 'cust' ? 'Cust' : 'Sup'}SplitBank`).value = '';
                document.getElementById(`ret${mode === 'cust' ? 'Cust' : 'Sup'}SplitCredit`).value = '';
                document.getElementById(`ret${mode === 'cust' ? 'Cust' : 'Sup'}SplitTotal`).innerText = '$0.00';
            }
        }

        window.calculateReturnSplitTotal = function (mode) {
            const prefix = mode === 'cust' ? 'retCust' : 'retSup';
            const cash = parseFloat(document.getElementById(`${prefix}SplitCash`).value) || 0;
            const bank = parseFloat(document.getElementById(`${prefix}SplitBank`).value) || 0;
            const credit = parseFloat(document.getElementById(`${prefix}SplitCredit`).value) || 0;
            const total = cash + bank + credit;
            document.getElementById(`${prefix}SplitTotal`).innerText = `${db.config.currency}${total.toFixed(2)}`;
        }

        window.autoCalculateSplitCust = function () {
            // Get return cart grand total
            const totalText = document.getElementById('retCustTotal')?.innerText || '$0.00';
            const totalAmount = parseFloat(totalText.replace(/[^0-9.]/g, '')) || 0;

            const cash = parseFloat(document.getElementById('retCustSplitCash').value) || 0;
            const bank = parseFloat(document.getElementById('retCustSplitBank').value) || 0;
            const credit = parseFloat(document.getElementById('retCustSplitCredit').value) || 0;

            const entered = cash + bank + credit;
            const remaining = totalAmount - entered;

            if (remaining > 0 && remaining !== cash + bank + credit) {
                // Auto-fill the last empty field with remaining amount
                if (cash > 0 && bank === 0 && credit === 0) {
                    document.getElementById('retCustSplitBank').value = moneyRound(remaining).toFixed(2);
                } else if (cash > 0 && bank > 0 && credit === 0) {
                    document.getElementById('retCustSplitCredit').value = moneyRound(remaining).toFixed(2);
                } else if (cash === 0 && bank > 0 && credit === 0) {
                    document.getElementById('retCustSplitCredit').value = moneyRound(remaining).toFixed(2);
                } else if (cash === 0 && bank === 0 && credit > 0) {
                    document.getElementById('retCustSplitCash').value = moneyRound(remaining).toFixed(2);
                }
            }
            calculateReturnSplitTotal('cust');
        }

        window.autoCalculateSplitSup = function () {
            // Get return cart grand total
            const totalText = document.getElementById('retSupTotal')?.innerText || '$0.00';
            const totalAmount = parseFloat(totalText.replace(/[^0-9.]/g, '')) || 0;

            const cash = parseFloat(document.getElementById('retSupSplitCash').value) || 0;
            const bank = parseFloat(document.getElementById('retSupSplitBank').value) || 0;
            const credit = parseFloat(document.getElementById('retSupSplitCredit').value) || 0;

            const entered = cash + bank + credit;
            const remaining = totalAmount - entered;

            if (remaining > 0 && remaining !== cash + bank + credit) {
                // Auto-fill the last empty field with remaining amount
                if (cash > 0 && bank === 0 && credit === 0) {
                    document.getElementById('retSupSplitBank').value = moneyRound(remaining).toFixed(2);
                } else if (cash > 0 && bank > 0 && credit === 0) {
                    document.getElementById('retSupSplitCredit').value = moneyRound(remaining).toFixed(2);
                } else if (cash === 0 && bank > 0 && credit === 0) {
                    document.getElementById('retSupSplitCredit').value = moneyRound(remaining).toFixed(2);
                } else if (cash === 0 && bank === 0 && credit > 0) {
                    document.getElementById('retSupSplitCash').value = moneyRound(remaining).toFixed(2);
                }
            }
            calculateReturnSplitTotal('sup');
        }

        window.loadReturnProducts = function (mode) {
            if (mode === 'cust') {
                const custVal = document.getElementById('retCustSelect').value || '';
                const isWalkin = custVal.startsWith('walkin:');
                const walkinName = isWalkin ? custVal.split(':')[1] : null;
                const custId = isWalkin ? null : (custVal ? parseInt(custVal) : null);

                const custSel = document.getElementById('retCustProd');
                custSel.innerHTML = '<option value="">Select Product...</option>';

                // Get all sales for this customer (not returns)
                const custTxns = db.transactions.filter(t => t.type === 'sale' && !t.isReturn && (isWalkin ? (!t.entityId && t.entityName === walkinName) : t.entityId === custId));
                const productQtyMap = {};

                custTxns.forEach(t => {
                    if (t.items && Array.isArray(t.items)) {
                        t.items.forEach(item => {
                            const itemId = item.id;
                            productQtyMap[itemId] = (productQtyMap[itemId] || 0) + (item.qty || 1);
                        });
                    }
                });

                // Get all returns for this customer
                const returnTxns = db.transactions.filter(t => t.type === 'sale' && t.isReturn && (isWalkin ? (!t.entityId && t.entityName === walkinName) : t.entityId === custId));
                const productReturnedMap = {};

                returnTxns.forEach(t => {
                    if (t.items && Array.isArray(t.items)) {
                        t.items.forEach(item => {
                            const itemId = item.id;
                            productReturnedMap[itemId] = (productReturnedMap[itemId] || 0) + (item.qty || 1);
                        });
                    }
                });

                // Only show products this customer has purchased (no fallback)
                if (Object.keys(productQtyMap).length > 0) {
                    // Filter out zero-stock duplicates
                    const displayProducts = filterDuplicateZeroStockProducts(db.products);

                    displayProducts.forEach(p => {
                        const totalPurchased = productQtyMap[p.id] || 0;
                        const totalReturned = productReturnedMap[p.id] || 0;
                        const remaining = totalPurchased - totalReturned;

                        if (remaining > 0) {
                            custSel.innerHTML += `<option value="${p.id}" data-max-qty="${remaining}">${p.name} (Can return: ${remaining}/${totalPurchased})</option>`;
                        }
                    });
                } else {
                    custSel.innerHTML += `<option value="" disabled>No purchase history - select customer first</option>`;
                }

                document.getElementById('retCustQty').value = 1;
                document.getElementById('retCustQtyPurchased').innerText = '-';
                document.getElementById('retCustPrice').innerText = '-';
            }
        }

        window.loadReturnProductsSupplier = function () {
            const prodSel = document.getElementById('retSupProd');
            prodSel.innerHTML = '<option value="">Select Product...</option>';

            // Filter out zero-stock duplicates
            let supplierProducts = filterDuplicateZeroStockProducts(db.products).filter(p => p.stock > 0);

            supplierProducts.sort((a, b) => {
                const expA = a.expiry ? new Date(a.expiry) : new Date('9999-12-31');
                const expB = b.expiry ? new Date(b.expiry) : new Date('9999-12-31');
                return expA - expB;
            });

            supplierProducts.forEach(p => {
                const expiryText = p.expiry ? ` | Exp: ${p.expiry}` : ' | No Expiry';
                const batchText = p.batch ? ` | Batch: ${p.batch}` : '';
                prodSel.innerHTML += `<option value="${p.id}">${p.name} (Stock: ${p.stock}${batchText}${expiryText})</option>`;
            });
        }

        window.updateReturnPrice = function (mode) {
            if (mode === 'cust') {
                const prodSelect = document.getElementById('retCustProd');
                const selectedOption = prodSelect.options[prodSelect.selectedIndex] || {};
                const pid = parseInt(prodSelect.value);
                const qty = parseInt(document.getElementById('retCustQty').value) || 0;
                const maxQty = parseInt(selectedOption.getAttribute && selectedOption.getAttribute('data-max-qty')) || 0;
                const prod = db.products.find(p => p.id === pid);

                if (prod) {
                    document.getElementById('retCustQtyPurchased').innerText = maxQty;
                    document.getElementById('retCustPrice').innerText = `${db.config.currency}${prod.retail}`;
                }
            } else if (mode === 'sup') {
                const pid = parseInt(document.getElementById('retSupProd').value);
                const prod = db.products.find(p => p.id === pid);
                if (prod) {
                    document.getElementById('retSupCost').innerText = `${db.config.currency}${prod.cost}`;
                    document.getElementById('retSupStock').innerText = prod.stock;
                }
            }
        }

        window.addToReturnCart = function (mode) {
            if (mode === 'cust') {
                const custVal = document.getElementById('retCustSelect').value || '';
                const pid = parseInt(document.getElementById('retCustProd').value);
                const qty = parseInt(document.getElementById('retCustQty').value) || 0;

                if (!custVal || !pid || qty < 1) return alert('Please select customer, product, and quantity');

                const prod = db.products.find(p => p.id === pid);
                if (!prod) return alert('Product not found');

                const prodSelect = document.getElementById('retCustProd');
                const selectedOption = prodSelect.options[prodSelect.selectedIndex] || {};
                const maxQty = parseInt(selectedOption.getAttribute('data-max-qty')) || 0;

                if (qty > maxQty) return alert(`Cannot return more than ${maxQty} units`);

                // Check if already in cart
                const existingItem = retCustCart.find(item => item.pid === pid);

                if (existingItem) {
                    // Calculate total if we add this quantity
                    const newTotal = existingItem.qty + qty;
                    if (newTotal > maxQty) {
                        return alert(`Cannot exceed maximum returnable quantity!\nAlready in cart: ${existingItem.qty}\nMax returnable: ${maxQty}\nTrying to add: ${qty}`);
                    }
                    existingItem.qty += qty;
                    alert(`✓ Quantity updated to ${newTotal} units`);
                } else {
                    retCustCart.push({
                        pid: pid,
                        name: prod.name,
                        qty: qty,
                        price: prod.retail,
                        max: maxQty
                    });
                    alert(`✓ Added to cart`);
                }

                renderReturnCart('cust');
                document.getElementById('retCustQty').value = 1;
            } else if (mode === 'sup') {
                const supId = parseInt(document.getElementById('retSupSelect').value);
                const pid = parseInt(document.getElementById('retSupProd').value);
                const qty = parseInt(document.getElementById('retSupQty').value) || 0;
                const reason = document.getElementById('retSupReason').value || '';

                if (!supId || !pid || qty < 1) return alert('Please select supplier, product, and quantity');

                const prod = db.products.find(p => p.id === pid);
                if (!prod) return alert('Product not found');
                if (qty > prod.stock) return alert(`Cannot return more than ${prod.stock} units in stock`);

                const existingItem = retSupCart.find(item => item.pid === pid);

                if (existingItem) {
                    // Calculate total if we add this quantity
                    const newTotal = existingItem.qty + qty;
                    if (newTotal > prod.stock) {
                        return alert(`Cannot exceed stock!\nAlready in cart: ${existingItem.qty}\nStock available: ${prod.stock}\nTrying to add: ${qty}`);
                    }
                    existingItem.qty += qty;
                    alert(`✓ Quantity updated to ${newTotal} units`);
                } else {
                    retSupCart.push({
                        pid: pid,
                        name: prod.name,
                        qty: qty,
                        cost: prod.cost,
                        reason: reason
                    });
                    alert(`✓ Added to cart`);
                }

                renderReturnCart('sup');
                document.getElementById('retSupQty').value = 1;
                document.getElementById('retSupReason').value = '';
            }
        }

        window.renderReturnCart = function (mode) {
            if (mode === 'cust') {
                const cart = retCustCart;
                const container = document.getElementById('retCustCart');
                const countEl = document.getElementById('retCustCartCount');
                let subtotal = 0;
                const vatRate = db.config.vatRate || 13;

                if (cart.length === 0) {
                    container.innerHTML = '<p class="text-xs text-gray-600">No items added</p>';
                    countEl.innerText = '0';
                    document.getElementById('retCustSubtotal').innerText = `${db.config.currency}$0.00`;
                    document.getElementById('retCustVAT').innerText = `${db.config.currency}$0.00`;
                    document.getElementById('retCustTotal').innerText = `${db.config.currency}$0.00`;
                } else {
                    container.innerHTML = cart.map((item, idx) => {
                        const itemTotal = moneyRound(item.price * item.qty);
                        subtotal = moneyRound(subtotal + itemTotal);
                        return `
                            <div class="flex justify-between items-center text-xs bg-white/5 p-1 rounded border border-gray-700">
                                <div>
                                    <span class="text-white">${item.name}</span>
                                    <span class="text-gray-500"> x${item.qty}</span>
                                </div>
                                <div class="flex items-center gap-1">
                                    <span class="text-karta-primary font-bold">${db.config.currency}${itemTotal.toFixed(2)}</span>
                                    <button onclick="removeFromReturnCart('cust', ${idx})" class="text-red-500 hover:text-red-400 text-xs">✕</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    countEl.innerText = cart.length;

                    // Calculate VAT on subtotal
                    const vat = moneyRound(subtotal * (vatRate / 100));
                    const total = moneyRound(subtotal + vat);

                    document.getElementById('retCustSubtotal').innerText = `${db.config.currency}${subtotal.toFixed(2)}`;
                    document.getElementById('retCustVAT').innerText = `${db.config.currency}${vat.toFixed(2)}`;
                    document.getElementById('retCustTotal').innerText = `${db.config.currency}${total.toFixed(2)}`;
                }
            } else if (mode === 'sup') {
                const cart = retSupCart;
                const container = document.getElementById('retSupCart');
                const countEl = document.getElementById('retSupCartCount');
                let subtotal = 0;
                const vatRate = db.config.vatRate || 13;

                if (cart.length === 0) {
                    container.innerHTML = '<p class="text-xs text-gray-600">No items added</p>';
                    countEl.innerText = '0';
                    document.getElementById('retSupSubtotal').innerText = `${db.config.currency}$0.00`;
                    document.getElementById('retSupVAT').innerText = `${db.config.currency}$0.00`;
                    document.getElementById('retSupTotal').innerText = `${db.config.currency}$0.00`;
                } else {
                    container.innerHTML = cart.map((item, idx) => {
                        const itemTotal = moneyRound(item.cost * item.qty);
                        subtotal = moneyRound(subtotal + itemTotal);
                        return `
                            <div class="flex justify-between items-center text-xs bg-white/5 p-1 rounded border border-gray-700">
                                <div>
                                    <span class="text-white">${item.name}</span>
                                    <span class="text-gray-500"> x${item.qty}</span>
                                </div>
                                <div class="flex items-center gap-1">
                                    <span class="text-karta-primary font-bold">${db.config.currency}${itemTotal.toFixed(2)}</span>
                                    <button onclick="removeFromReturnCart('sup', ${idx})" class="text-red-500 hover:text-red-400 text-xs">✕</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    countEl.innerText = cart.length;

                    // Calculate VAT on subtotal
                    const vat = moneyRound(subtotal * (vatRate / 100));
                    const total = moneyRound(subtotal + vat);

                    document.getElementById('retSupSubtotal').innerText = `${db.config.currency}${subtotal.toFixed(2)}`;
                    document.getElementById('retSupVAT').innerText = `${db.config.currency}${vat.toFixed(2)}`;
                    document.getElementById('retSupTotal').innerText = `${db.config.currency}${total.toFixed(2)}`;
                }
            }
        }

        window.removeFromReturnCart = function (mode, idx) {
            if (mode === 'cust') {
                retCustCart.splice(idx, 1);
                renderReturnCart('cust');
            } else if (mode === 'sup') {
                retSupCart.splice(idx, 1);
                renderReturnCart('sup');
            }
        }

        window.clearReturnCart = function (mode) {
            if (mode === 'cust') {
                retCustCart = [];
                renderReturnCart('cust');
            } else if (mode === 'sup') {
                retSupCart = [];
                renderReturnCart('sup');
            }
        }

        // SMART SPLIT LOGIC: Helper to calculate refund breakdown based on LIFO sales history
        window.calculateRefundBreakdown = function (returnItems, custId, isWalkin, walkinName) {
            // 1. Get all past sales for this customer, sorted Newest -> Oldest (LIFO)
            const pastSales = db.transactions.filter(t =>
                t.type === 'sale' &&
                !t.isReturn &&
                (isWalkin ? (!t.entityId && t.entityName === walkinName) : t.entityId === custId)
            ).sort((a, b) => b.id - a.id); // Descending order by ID (timestamp)

            let breakdown = {
                credit: 0,
                cash: 0,
                bank: 0,
                split: 0 // Accumulator for misc
            };

            // Clone items to track remaining qty validation without mutating original cart
            let itemsToTrace = returnItems.map(i => ({ ...i }));

            // 2. Iterate through past sales and attribute quantities
            for (let sale of pastSales) {
                if (itemsToTrace.every(i => i.qty <= 0)) break; // All items accounted for

                if (sale.items && Array.isArray(sale.items)) {
                    // Check if this sale contains any of our return items
                    let saleUsed = false;
                    let saleCreditAmount = 0;
                    let saleOtherAmount = 0;

                    sale.items.forEach(saleItem => {
                        let returnItem = itemsToTrace.find(ri => ri.id === saleItem.id && ri.qty > 0);
                        if (returnItem) {
                            // Found a match! How many from this sale?
                            // Note: We don't have per-item batch tracking perfectly here, so we assume simple LIFO on product ID
                            // We take as much as possible from this sale
                            let qtyToTake = Math.min(returnItem.qty, saleItem.qty);

                            // Calculate value of this portion
                            // Use CURRENT return price/retail to ensure refund total matches
                            // (Or should we use historical? User said "credited product's price". 
                            // Usually refund is at current selling price, but attribution is based on origin method.)

                            let itemValue = returnItem.retail * qtyToTake;
                            // Add VAT if applicable
                            let itemVat = !returnItem.vatExempt ? moneyRound(itemValue * (db.config.vatRate / 100)) : 0;
                            let itemTotal = moneyRound(itemValue + itemVat);

                            // Attribute to payment method
                            if (sale.payType === 'credit') {
                                breakdown.credit += itemTotal;
                            } else if (sale.payType === 'split') {
                                // Complex case: Proportional split? Or determine per item?
                                // Simplified: If split, we default to Cash for refund safety, or proportional.
                                // Let's attribute to 'cash' to allow flexibility, or 'split' bucket.
                                // For now, treat non-credit splits as 'cash' equivalent for refund ability 
                                // UNLESS we want to be strict. Let's map to Cash for simplicity as user emphasized "Cash/Bank" vs "Credit".
                                breakdown.cash += itemTotal;
                            } else {
                                // Cash or Bank
                                if (sale.payType === 'bank') breakdown.bank += itemTotal;
                                else breakdown.cash += itemTotal;
                            }

                            returnItem.qty -= qtyToTake;
                        }
                    });
                }
            }

            // Any remaining items (not found in history)? Default to 'Cash' (safety) or current selection.
            itemsToTrace.forEach(i => {
                if (i.qty > 0) {
                    let val = i.retail * i.qty;
                    let vat = !i.vatExempt ? moneyRound(val * (db.config.vatRate / 100)) : 0;
                    breakdown.cash += moneyRound(val + vat);
                }
            });

            return breakdown;
        }

        window.processReturn = function (mode) {
            if (mode === 'cust') {
                if (retCustCart.length === 0) return alert('No items in return cart');

                const custVal = document.getElementById('retCustSelect').value || '';
                const isWalkin = custVal.startsWith('walkin:');
                const walkinName = isWalkin ? custVal.split(':')[1] : null;
                const custId = isWalkin ? null : (custVal ? parseInt(custVal) : null);

                if (!isWalkin && !custId) return alert('Please select a customer');

                const cust = isWalkin ? null : db.customers.find(c => c.id === custId);
                if (!isWalkin && !cust) return alert('Customer not found');

                let subtotal = 0;
                let totalVat = 0;
                const returnItems = [];
                const vatRate = db.config.vatRate || 13;

                // Validate and calculate total WITH VAT
                for (let item of retCustCart) {
                    const prod = db.products.find(p => p.id === item.pid);
                    if (!prod) return alert(`Product ${item.name} not found`);

                    const itemPrice = prod.retail * item.qty;
                    // FIX: Only charge VAT if product is NOT vat exempt
                    const itemVat = !prod.vatExempt ? moneyRound(itemPrice * (vatRate / 100)) : 0;

                    subtotal = moneyRound(subtotal + itemPrice);
                    totalVat = moneyRound(totalVat + itemVat);

                    returnItems.push({
                        id: item.pid,
                        name: item.name,
                        qty: item.qty,
                        retail: prod.retail,
                        vatExempt: prod.vatExempt || false
                    });
                    prod.stock += item.qty;
                }

                const totalRefund = moneyRound(subtotal + totalVat);

                // --- SMART SPLIT LOGIC INTERCEPTION ---
                // Get recommended breakdown based on history
                const breakdown = calculateRefundBreakdown(returnItems, custId, isWalkin, walkinName);

                // Determine original payment method (simple fallback)
                let originalPaymentMethod = 'cash';
                const originalSales = db.transactions.filter(t => t.type === 'sale' && !t.isReturn && (isWalkin ? (!t.entityId && t.entityName === walkinName) : t.entityId === custId));
                if (originalSales.length > 0) {
                    originalPaymentMethod = originalSales[originalSales.length - 1].payType || 'cash';
                }

                // Get currently selected refund method
                const refundMethodRadio = document.querySelector('input[name="retCustPayment"]:checked');
                let refundMethod = refundMethodRadio ? refundMethodRadio.value : originalPaymentMethod;

                // CHECK FOR MIXED ORIGINS or STRICT CREDIT
                if (breakdown.credit > 0) {
                    // We have some items to be refunded to Credit
                    const nonCreditTotal = breakdown.cash + breakdown.bank + breakdown.split;

                    if (nonCreditTotal > 0) {
                        // MIXED SCENARIO (Part Credit, Part Cash/Bank)
                        // Force Split Mode
                        console.log("Smart Split Triggered:", breakdown);
                        alert(`⚠ Mixed Payment Origins Detected!\n\n${db.config.currency}${breakdown.credit.toFixed(2)} from Credit Sales\n${db.config.currency}${nonCreditTotal.toFixed(2)} from Cash/Bank Sales\n\nAuto-switching to SPLIT refund.`);

                        refundMethod = 'split';

                        // Auto-fill split inputs
                        // If "split" payment mode is selected, we need to show the split UI
                        document.querySelector('input[name="retCustPayment"][value="split"]').checked = true;
                        window.toggleReturnSplit('cust'); // Ensure UI is shown

                        // Fill values
                        // Credit goes to Credit
                        document.getElementById('retCustSplitCredit').value = breakdown.credit.toFixed(2);
                        // Rest goes to Cash (defaulting non-credit to Cash for simplicity as per user req)
                        document.getElementById('retCustSplitCash').value = nonCreditTotal.toFixed(2);
                        document.getElementById('retCustSplitBank').value = '';

                        window.calculateReturnSplitTotal('cust');

                    } else {
                        // ALL Credit
                        if (refundMethod !== 'credit') {
                            alert("Original items purchased on Credit. Refund switching to Credit Balance.");
                            refundMethod = 'credit';
                            document.querySelector('input[name="retCustPayment"][value="credit"]').checked = true;
                            window.toggleReturnSplit('cust');
                        }
                    }
                } else {
                    // NO Credit origin
                    // Allow cashier choice (already handled by default logic, but ensure 'credit' isn't forced unless chosen)
                }

                // (Legacy simple check removed - replaced by Smart Split Logic above)
                // Else: If original was Cash/Bank/Split, we ALLOW the cashier to choose any refund method (Cash, Bank, Split)
                // The logical default is the original method, but we don't block them from changing it.

                // For split, get the amounts
                let splitCash = 0, splitBank = 0, splitCredit = 0;
                if (refundMethod === 'split') {
                    splitCash = parseFloat(document.getElementById('retCustSplitCash').value) || 0;
                    splitBank = parseFloat(document.getElementById('retCustSplitBank').value) || 0;
                    splitCredit = parseFloat(document.getElementById('retCustSplitCredit').value) || 0;

                    // Check if any split amounts are entered
                    if (splitCash === 0 && splitBank === 0 && splitCredit === 0) {
                        return alert('Please enter split payment amounts');
                    }

                    const splitTotal = moneyRound(splitCash + splitBank + splitCredit);
                    if (Math.abs(splitTotal - totalRefund) > 0.01) {
                        return alert(`Split refund total (${db.config.currency}${splitTotal.toFixed(2)}) doesn't match return total (${db.config.currency}${totalRefund.toFixed(2)})`);
                    }
                }

                if (!confirm(`Process return for ${retCustCart.length} items?\nSubtotal: ${db.config.currency}${subtotal.toFixed(2)}\nVAT (${vatRate}%): ${db.config.currency}${totalVat.toFixed(2)}\nTotal Refund: ${db.config.currency}${totalRefund.toFixed(2)}\nRefunding via: ${refundMethod.toUpperCase()}`)) {
                    return;
                }

                // Initialize cash/bank balances
                if (!db.config.cashBalance) db.config.cashBalance = 0;
                if (!db.config.bankBalance) db.config.bankBalance = 0;

                // Update balances based on refund method selected
                // When customer returns, they get money back - so WE DECREASE our money
                if (refundMethod === 'cash') {
                    // We give cash back to customer (cash DECREASES)
                    db.config.cashBalance = moneyRound(db.config.cashBalance - totalRefund);
                } else if (refundMethod === 'bank') {
                    // We refund via bank transfer (bank DECREASES)
                    db.config.bankBalance = moneyRound(db.config.bankBalance - totalRefund);
                } else if (refundMethod === 'credit') {
                    // We owe customer - customer credit balance DECREASES (Debt Reduces)
                    if (!isWalkin && cust) {
                        // FIX: Subtraction because returning a credit purchase reduces the debt
                        cust.balance = moneyRound((cust.balance || 0) - totalRefund);
                    }
                } else if (refundMethod === 'split') {
                    // Split: decrease cash/bank, decrease customer debt for credit portion
                    if (splitCash > 0) {
                        db.config.cashBalance = moneyRound(db.config.cashBalance - splitCash);
                    }
                    if (splitBank > 0) {
                        db.config.bankBalance = moneyRound(db.config.bankBalance - splitBank);
                    }
                    if (splitCredit > 0 && !isWalkin && cust) {
                        // FIX: Subtraction for credit portion
                        cust.balance = moneyRound((cust.balance || 0) - splitCredit);
                    }
                }

                // Record transaction
                const txn = {
                    id: Date.now(),
                    type: 'sale',
                    date: new Date().toISOString(),
                    entityId: custId,
                    entityName: isWalkin ? walkinName : (cust ? cust.name : 'Guest Customer'),
                    items: returnItems,
                    sub: subtotal,
                    tax: totalVat,
                    total: -totalRefund,
                    payType: refundMethod,
                    isReturn: true,
                    cashBalance: db.config.cashBalance,
                    bankBalance: db.config.bankBalance,
                    invoiceNumber: getNextInvoiceNumber()
                };

                // Add payment amounts based on refund method
                if (refundMethod === 'cash') {
                    txn.cashAmount = -totalRefund;
                } else if (refundMethod === 'bank') {
                    txn.bankAmount = -totalRefund;
                } else if (refundMethod === 'credit') {
                    txn.creditAmount = -totalRefund;
                } else if (refundMethod === 'split') {
                    txn.splitCash = -splitCash;
                    txn.splitBank = -splitBank;
                    txn.splitCredit = -splitCredit;
                    txn.cashAmount = -splitCash;
                    txn.bankAmount = -splitBank;
                    txn.creditAmount = -splitCredit;
                }

                db.transactions.push(txn);

                saveDB();

                // Print invoice directly without confirmation
                const printChoice = true;

                if (printChoice) {
                    setTimeout(() => printInvoice(txn), 300);
                }

                retCustCart = [];
                renderReturnCart('cust');
                loadDashboard();
                document.getElementById('retCustSelect').value = '';
                document.getElementById('retCustProd').innerHTML = '<option value="">Select Product...</option>';
            } else if (mode === 'sup') {
                if (retSupCart.length === 0) return alert('No items in return cart');

                const supId = parseInt(document.getElementById('retSupSelect').value);

                if (!supId) return alert('Please select a supplier');

                const sup = db.suppliers.find(s => s.id === supId);
                if (!sup) return alert('Supplier not found');

                let subtotal = 0;
                let totalVat = 0;
                const returnItems = [];
                const vatRate = db.config.vatRate || 13;

                // Validate and calculate total WITH VAT
                for (let item of retSupCart) {
                    const prod = db.products.find(p => p.id === item.pid);
                    if (!prod) return alert(`Product ${item.name} not found`);
                    if (item.qty > prod.stock) return alert(`Cannot return more than ${prod.stock} units of ${item.name}`);

                    const itemCost = prod.cost * item.qty;
                    // FIX: Only charge VAT if product is NOT vat exempt
                    const itemVat = !prod.vatExempt ? moneyRound(itemCost * (vatRate / 100)) : 0;

                    subtotal = moneyRound(subtotal + itemCost);
                    totalVat = moneyRound(totalVat + itemVat);

                    returnItems.push({
                        id: item.pid,
                        name: item.name,
                        qty: item.qty,
                        cost: prod.cost,
                        vatExempt: prod.vatExempt || false
                    });
                }

                const totalValue = moneyRound(subtotal + totalVat);

                // Get original purchase method for this supplier to validate refund method
                const originalPurchases = db.transactions.filter(t => t.type === 'purchase' && !t.isReturn && t.entityId === supId);
                let originalPaymentMethod = 'credit'; // Default to credit if no purchase found
                if (originalPurchases.length > 0) {
                    originalPaymentMethod = originalPurchases[originalPurchases.length - 1].payType || 'credit';
                }

                // Get refund method from selected radio button (or split if selected)
                const refundMethodRadio = document.querySelector('input[name="retSupPayment"]:checked');
                let refundMethod = refundMethodRadio ? refundMethodRadio.value : 'cash';

                if (!refundMethod || !['cash', 'bank', 'credit', 'split'].includes(refundMethod)) {
                    return alert('Invalid refund method. Please select a payment method');
                }

                // Validate refund method matches original payment method (warning only)
                if (refundMethod !== 'split' && refundMethod !== originalPaymentMethod) {
                    const confirmed = confirm(`⚠️ Original payment was ${originalPaymentMethod.toUpperCase()}, but you're refunding via ${refundMethod.toUpperCase()}.\n\nThis may indicate an error. Continue anyway?`);
                    if (!confirmed) return;
                }

                // Initialize cash/bank balances
                if (!db.config.cashBalance) db.config.cashBalance = 0;
                if (!db.config.bankBalance) db.config.bankBalance = 0;

                // STEP 1: Validate all items have sufficient stock BEFORE deducting
                for (let item of retSupCart) {
                    const prod = db.products.find(p => p.id === item.pid);
                    if (!prod || item.qty > prod.stock) {
                        return alert(`Insufficient stock for ${item.name}`);
                    }
                }

                // STEP 2: Decrease product stock (now we know it's safe)
                for (let item of retSupCart) {
                    const prod = db.products.find(p => p.id === item.pid);
                    if (prod) {
                        prod.stock -= item.qty;
                    }
                }

                // Handle split payment if selected
                let splitCash = 0, splitBank = 0, splitCredit = 0;
                if (refundMethod === 'split') {
                    splitCash = parseFloat(document.getElementById('retSupSplitCash').value) || 0;
                    splitBank = parseFloat(document.getElementById('retSupSplitBank').value) || 0;
                    splitCredit = parseFloat(document.getElementById('retSupSplitCredit').value) || 0;

                    const splitTotal = moneyRound(splitCash + splitBank + splitCredit);
                    if (Math.abs(splitTotal - totalValue) > 0.01) {
                        return alert(`Split payment total (${db.config.currency}${splitTotal.toFixed(2)}) doesn't match return total (${db.config.currency}${totalValue.toFixed(2)})`);
                    }
                }

                // STEP 3: Update supplier balance
                if (refundMethod === 'credit') {
                    sup.balance = moneyRound(sup.balance - totalValue);
                } else if (refundMethod === 'split') {
                    // For split: credit portion reduces supplier balance
                    if (splitCredit > 0) {
                        sup.balance = moneyRound(sup.balance - splitCredit);
                    }
                }

                // STEP 4: Update cash/bank ONLY based on what user selected
                if (refundMethod === 'cash') {
                    // Supplier gives us cash back: our cash INCREASES
                    db.config.cashBalance = moneyRound(db.config.cashBalance + totalValue);
                } else if (refundMethod === 'bank') {
                    // Supplier deposits to our bank: our bank INCREASES
                    db.config.bankBalance = moneyRound(db.config.bankBalance + totalValue);
                } else if (refundMethod === 'split') {
                    // Split: add cash and bank portions
                    if (splitCash > 0) {
                        db.config.cashBalance = moneyRound(db.config.cashBalance + splitCash);
                    }
                    if (splitBank > 0) {
                        db.config.bankBalance = moneyRound(db.config.bankBalance + splitBank);
                    }
                }
                // If credit: only supplier balance decreases, no cash/bank change

                // STEP 5: Record transaction
                const txn = {
                    id: Date.now(),
                    type: 'purchase',
                    date: new Date().toISOString(),
                    entityId: supId,
                    entityName: sup.name,
                    items: returnItems,
                    sub: subtotal,
                    tax: totalVat,
                    total: -totalValue,
                    payType: refundMethod,
                    ref: 'Supplier Return',
                    isReturn: true,
                    cashBalance: db.config.cashBalance,
                    bankBalance: db.config.bankBalance,
                    cashAmount: refundMethod === 'cash' ? totalValue : (refundMethod === 'split' ? splitCash : 0),
                    bankAmount: refundMethod === 'bank' ? totalValue : (refundMethod === 'split' ? splitBank : 0),
                    creditAmount: refundMethod === 'credit' ? totalValue : (refundMethod === 'split' ? splitCredit : 0)
                };

                db.transactions.push(txn);
                saveDB();

                // Print invoice directly without confirmation
                const purchaseInvoice = {
                    id: txn.id,
                    ref: txn.ref || txn.id.toString().slice(-6),
                    supplierInvoiceNumber: txn.supplierInvoiceNumber || null,
                    date: txn.date,
                    supplier: txn.entityName,
                    supplierId: txn.entityId,
                    items: txn.items || [],
                    subtotal: txn.sub || 0,
                    discount: 0,
                    discountPercent: 0,
                    totalVAT: txn.tax || 0,
                    totalAmount: txn.total,
                    payType: txn.payType,
                    isReturn: txn.isReturn
                };
                printPurchaseInvoice(purchaseInvoice);

                retSupCart = [];
                renderReturnCart('sup');
                loadDashboard();
                document.getElementById('retSupSelect').value = '';
                document.getElementById('retSupProd').innerHTML = '<option value="">Select Product...</option>';
            }
        }
        window.loadReturns = function () {
            // Clear carts when page loads
            retCustCart = [];
            retSupCart = [];
            renderReturnCart('cust');
            renderReturnCart('sup');

            // Populate customer select for returns
            const custSel = document.getElementById('retCustSelect');
            custSel.innerHTML = '<option value="">Select Customer...</option>';

            // Add registered customers
            db.customers.forEach(c => {
                custSel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });

            // Add walk-in customers (anyone with transactions but no customer ID)
            const walkInNames = new Set();
            db.transactions.forEach(t => {
                // FIX: Allow Guest Customer (Walk-in) to appear in returns
                if (t.type === 'sale' && !t.entityId && t.entityName) {
                    walkInNames.add(t.entityName);
                }
            });

            // Add a separator and walk-in customers
            if (walkInNames.size > 0) {
                custSel.innerHTML += `<option value="" disabled>── Walk-in Customers ──</option>`;
                walkInNames.forEach(name => {
                    custSel.innerHTML += `<option value="walkin:${name}">${name} (Walk-in)</option>`;
                });
            }

            // Populate supplier select for returns
            const supSel = document.getElementById('retSupSelect');
            supSel.innerHTML = '<option value="">Select Supplier...</option>';
            db.suppliers.forEach(s => {
                supSel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });
        }

        // --- Invoice List Logic ---
        window.loadInvoices = function () {
            const tbody = document.getElementById('invoiceListBody');
            tbody.innerHTML = '';
            const search = document.getElementById('invoiceSearch').value.toLowerCase();
            const filterDate = document.getElementById('invoiceDateFilter').value;

            // Get all sales sorted by date for legacy numbering (assigns sequential numbers starting from config.invoiceStartNumber)
            const allSales = db.transactions.filter(t => t.type === 'sale').sort((a, b) => new Date(a.date) - new Date(b.date));

            db.transactions.slice().reverse().filter(t => t.type === 'sale').forEach(t => {
                let invoiceNum = t.invoiceNumber;

                // For invoices created before invoiceNumber field was added:
                // Assign number based on position in chronological order ONLY (not based on reset number)
                if (!invoiceNum) {
                    const position = allSales.findIndex(s => s.id === t.id);
                    // IMPORTANT: Use position directly, starting from 1
                    // If you have invoices 1-10 already, they will always stay 1-10
                    // Only NEW invoices will use the reset start number
                    invoiceNum = 'INV-' + String(1 + position).padStart(3, '0');

                    // Backfill the invoiceNumber into the transaction
                    t.invoiceNumber = invoiceNum;
                }

                // Check search term - search by invoice number or customer name
                if (search && !invoiceNum.toLowerCase().includes(search) && !t.entityName.toLowerCase().includes(search)) {
                    return;
                }

                // Check exact date match
                const txnDate = t.date.substring(0, 10); // Extract YYYY-MM-DD
                if (filterDate && txnDate !== filterDate) {
                    return;
                }

                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 border-b border-gray-800";
                tr.innerHTML = `
                    <td class="p-3 text-gray-400 text-xs">${window.formatDate(t.date)}</td>
                    <td class="p-3 font-mono">${invoiceNum}</td>
                    <td class="p-3 font-bold text-white">${t.entityName}</td>
                    <td class="p-3 text-right text-green-400">${db.config.currency}${t.total.toFixed(2)}</td>
                    <td class="p-3 text-center"><span class="px-2 py-1 rounded text-xs ${t.payType === 'credit' ? 'bg-yellow-900 text-yellow-300' : 'bg-green-900 text-green-300'} uppercase">${t.payType || 'cash'}</span></td>
                    <td class="p-3 text-center">
                        <button onclick="editInvoice(${t.id})" class="text-gray-400 hover:text-white mx-1"><i class="fa-solid fa-pen"></i></button>
                        <button onclick='printInvoiceStr(${JSON.stringify(t)})' class="text-blue-400 hover:text-blue-300 mx-1"><i class="fa-solid fa-print"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Save backfilled invoiceNumbers
            saveDB();
        }

        // Clear all filters
        window.clearInvoiceFilters = function () {
            document.getElementById('invoiceSearch').value = '';
            document.getElementById('invoiceDateFilter').value = '';
            loadInvoices();
        }

        // --- PURCHASE INVOICES SECTION ---
        window.loadPurchaseInvoices = function () {
            const tbody = document.getElementById('purchInvoiceBody');
            if (!tbody) return; // Element doesn't exist if not on purchase invoices page

            tbody.innerHTML = '';

            // Get date filter values
            const fromDate = document.getElementById('purchInvFromDate')?.value || '';
            const toDate = document.getElementById('purchInvToDate')?.value || '';

            // Filter purchase transactions
            let purchases = db.transactions.filter(t => t.type === 'purchase');

            // Apply date filters if set
            if (fromDate) {
                purchases = purchases.filter(t => {
                    const txnDate = t.purchaseDate ? t.purchaseDate : t.date.substring(0, 10);
                    return txnDate >= fromDate;
                });
            }

            if (toDate) {
                purchases = purchases.filter(t => {
                    const txnDate = t.purchaseDate ? t.purchaseDate : t.date.substring(0, 10);
                    return txnDate <= toDate;
                });
            }

            // Sort by date (newest first)
            purchases = purchases.sort((a, b) => {
                const dateA = a.purchaseDate ? new Date(a.purchaseDate) : new Date(a.date);
                const dateB = b.purchaseDate ? new Date(b.purchaseDate) : new Date(b.date);
                return dateB - dateA;
            });

            if (purchases.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-400"><i class="fa-solid fa-inbox mr-2"></i>No purchase invoices found</td></tr>`;
                return;
            }

            purchases.forEach(t => {
                const invoiceDate = t.purchaseDate ? window.formatDate(t.purchaseDate) : window.formatDate(t.date);
                // Prefer supplier-provided invoice number; fallback to internal ref or id
                const invoiceNo = t.supplierInvoiceNumber || t.ref || t.id.toString().slice(-6);

                const paymentColor = t.payType === 'credit' ? 'bg-yellow-900 text-yellow-300' : 'bg-green-900 text-green-300';

                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 transition-colors";
                tr.innerHTML = `
                    <td class="p-3 text-gray-400 text-sm">${invoiceDate}</td>
                    <td class="p-3 font-mono text-sm">#${invoiceNo}</td>
                    <td class="p-3 font-bold text-white text-sm">${t.entityName || '-'}</td>
                    <td class="p-3 text-right text-karta-primary font-bold text-sm">${db.config.currency}${t.total.toFixed(2)}</td>
                    <td class="p-3 text-center"><span class="px-2 py-1 rounded text-xs ${paymentColor} uppercase inline-block">${t.payType || 'cash'}</span></td>
                    <td class="p-3 text-center">
                        <button onclick="viewPurchaseInvoice('${t.id}')" class="text-green-400 hover:text-green-300 mx-1" title="View"><i class="fa-solid fa-eye"></i></button>
                        <button onclick="editPurchaseInvoice('${t.id}')" class="text-yellow-400 hover:text-yellow-300 mx-1" title="Edit"><i class="fa-solid fa-edit"></i></button>
                        <button onclick="printPurchaseInvoiceFromTxn('${t.id}')" class="text-blue-400 hover:text-blue-300 mx-1" title="Print"><i class="fa-solid fa-print"></i></button>
                        <button onclick="deletePurchase('${t.id}')" class="text-red-400 hover:text-red-300 mx-1" title="Delete"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.filterPurchaseInvoices = function () {
            loadPurchaseInvoices();
        }

        // DELETE PURCHASE - Completely undo the purchase transaction
        // Reverses: Product stock, Supplier balance, Cash/Bank amounts, Batch entries
        window.deletePurchase = function (txnId) {
            const txn = db.transactions.find(t => t.id == txnId && t.type === 'purchase');
            if (!txn) {
                alert('Purchase not found!');
                return;
            }

            // Confirmation dialog with details
            if (!confirm(`Are you sure you want to DELETE this purchase?\n\nSupplier: ${txn.entityName}\nTotal: ${db.config.currency}${txn.total.toFixed(2)}\n\nThis will undo ALL effects:\n- Removing purchased stock\n- Reversing supplier balance\n- Refunding payment amounts\n\nThis action CANNOT be undone.`)) {
                return;
            }

            console.log('=== DELETING PURCHASE ===');
            console.log('Transaction:', txn);

            // STEP 1: REMOVE PURCHASED STOCK (Reduce quantity, do NOT delete product)
            if (txn.items && Array.isArray(txn.items)) {
                txn.items.forEach(item => {
                    // Find the product
                    const prod = db.products.find(p => p.id === item.id);
                    if (prod) {
                        console.log(`✓ Removing stock: ${item.qty} units of "${item.name}" (ID: ${item.id})`);
                        // FIX: Reduce stock quantity instead of deleting the product
                        prod.stock = Math.max(0, (prod.stock || 0) - item.qty);
                        console.log(`  New stock: ${prod.stock}`);
                    } else {
                        console.warn(`⚠ Product not found: ${item.name} (ID: ${item.id})`);
                    }
                });
            }

            // STEP 2: Reverse supplier balance change
            const supplier = db.suppliers.find(s => s.id === txn.entityId);
            if (supplier) {
                const originalBalance = supplier.balance;

                // Credit payment: supplier balance was increased, so reverse it
                if (txn.payType === 'credit' && txn.creditAmount && txn.creditAmount > 0) {
                    supplier.balance = moneyRound(supplier.balance - txn.creditAmount);
                    console.log(`✓ CREDIT REVERSAL: Balance ${originalBalance} → ${supplier.balance} (reduced by ${txn.creditAmount})`);
                }
                // Split payment: only credit portion affected supplier balance
                else if (txn.payType === 'split' && txn.creditAmount && txn.creditAmount > 0) {
                    supplier.balance = moneyRound(supplier.balance - txn.creditAmount);
                    console.log(`✓ SPLIT CREDIT REVERSAL: Balance ${originalBalance} → ${supplier.balance} (reduced by ${txn.creditAmount})`);
                }
                // Cash/Bank payments don't affect supplier balance
                else if (txn.payType === 'cash' || txn.payType === 'bank') {
                    console.log(`✓ ${txn.payType.toUpperCase()} payment - supplier balance unchanged: ${supplier.balance}`);
                }
            } else {
                console.warn(`⚠ Supplier not found: ${txn.entityId}`);
            }

            // STEP 3: Refund CASH amount
            if (txn.cashAmount && txn.cashAmount > 0) {
                if (!db.config.cashBalance) db.config.cashBalance = 0;
                const originalCash = db.config.cashBalance;
                db.config.cashBalance = moneyRound(db.config.cashBalance + txn.cashAmount);
                console.log(`✓ CASH REFUND: ${originalCash} → ${db.config.cashBalance} (added ${txn.cashAmount})`);
            } else if (txn.payType === 'cash' && txn.total && txn.total > 0) {
                // Fallback: if cashAmount is not set but payType is cash, refund the total
                if (!db.config.cashBalance) db.config.cashBalance = 0;
                const originalCash = db.config.cashBalance;
                db.config.cashBalance = moneyRound(db.config.cashBalance + txn.total);
                console.log(`✓ CASH REFUND (fallback): ${originalCash} → ${db.config.cashBalance} (added ${txn.total})`);
            }

            // STEP 4: Refund BANK amount
            if (txn.bankAmount && txn.bankAmount > 0) {
                if (!db.config.bankBalance) db.config.bankBalance = 0;
                const originalBank = db.config.bankBalance;
                db.config.bankBalance = moneyRound(db.config.bankBalance + txn.bankAmount);
                console.log(`✓ BANK REFUND: ${originalBank} → ${db.config.bankBalance} (added ${txn.bankAmount})`);
            } else if (txn.payType === 'bank' && txn.total && txn.total > 0) {
                // Fallback: if bankAmount is not set but payType is bank, refund the total
                if (!db.config.bankBalance) db.config.bankBalance = 0;
                const originalBank = db.config.bankBalance;
                db.config.bankBalance = moneyRound(db.config.bankBalance + txn.total);
                console.log(`✓ BANK REFUND (fallback): ${originalBank} → ${db.config.bankBalance} (added ${txn.total})`);
            }

            // STEP 5: Delete batch entries that were created for this purchase
            if (!db.batches) db.batches = [];
            const originalBatchCount = db.batches.length;
            const purchaseBatches = db.batches.filter(batch => batch.ref === txn.ref);
            db.batches = db.batches.filter(batch => batch.ref !== txn.ref);
            console.log(`✓ Removed ${purchaseBatches.length} batch entries`);

            // STEP 6: Delete the transaction itself from db.transactions
            const originalTxnCount = db.transactions.length;
            db.transactions = db.transactions.filter(t => t.id !== txnId);
            console.log(`✓ Deleted purchase transaction #${txnId} (removed 1 of ${originalTxnCount})`);

            // STEP 7: Ensure purchase is completely removed from all storage
            // Double-check that no trace of this purchase remains
            const purchaseStillExists = db.transactions.some(t => t.id == txnId && t.type === 'purchase');
            if (purchaseStillExists) {
                console.warn(`⚠ WARNING: Purchase still exists after deletion attempt!`);
                // Force removal again
                db.transactions = db.transactions.filter(t => !(t.id == txnId && t.type === 'purchase'));
            }

            console.log('=== PURCHASE DELETION COMPLETE ===');

            // IMMEDIATE SAVE - Don't use debounced saveDB() for critical deletes
            // Save synchronously to ensure data is persisted before refresh
            if (currentUser && DB_KEY) {
                // 1. Save to localStorage IMMEDIATELY without debounce
                localStorage.setItem(DB_KEY, JSON.stringify(db));
                console.log('✓ Saved to localStorage immediately');

                // 2. Also save to Firebase if available
                if (firebaseAvailable && dbRealtime) {
                    const userRef = ref(dbRealtime, 'users/' + currentUser.uid + '/data');
                    set(userRef, db)
                        .then(() => {
                            console.log('✓ Synced to Firebase');
                            updateSyncStatus("Synced ✓", "text-green-500");
                        })
                        .catch((err) => {
                            console.error('Firebase sync error:', err);
                            updateSyncStatus("Sync Error", "text-red-500");
                        });
                }
            }

            // Force immediate UI update
            setTimeout(() => {
                loadPurchaseInvoices();
                refreshUI();
            }, 100);

            // Show success message
            alert(`✓ PURCHASE DELETED PERMANENTLY!\n\n${txn.entityName}\nInvoice #${txn.ref || txn.id.toString().slice(-6)}\nAmount: ${db.config.currency}${txn.total.toFixed(2)}\n\nAll records have been permanently removed from database.`);
        }

        window.clearPurchaseFilters = function () {
            document.getElementById('purchInvFromDate').value = '';
            document.getElementById('purchInvToDate').value = '';
            loadPurchaseInvoices();
        }

        // ===== EDIT PURCHASE INVOICE FUNCTIONALITY =====

        // Global array to track edited products
        let editPurchProducts = [];

        window.editPurchaseInvoice = function (txnId) {
            const txn = db.transactions.find(t => t.id == txnId && t.type === 'purchase');
            if (!txn) {
                alert('Purchase invoice not found!');
                return;
            }

            console.log('Editing purchase invoice:', txn);

            // Populate form fields
            const supplier = db.suppliers.find(s => s.id === txn.entityId);
            document.getElementById('editPurchSupplier').value = supplier ? supplier.name : txn.entityName || '-';
            document.getElementById('editPurchInvoiceNo').value = txn.supplierInvoiceNumber || txn.ref || '';
            document.getElementById('editPurchPayment').value = (txn.payType || 'cash').toUpperCase();
            document.getElementById('editPurchTxnId').value = txnId;

            // Set purchase date (handle both purchaseDate and date fields)
            const purchaseDate = txn.purchaseDate ? txn.purchaseDate : txn.date.substring(0, 10);
            document.getElementById('editPurchDate').value = purchaseDate;

            // Convert to Nepali if in Nepali mode
            if (db.config.dateMode === 'nepali') {
                const nepaliDate = window.convertEngToNep(purchaseDate);
                document.getElementById('editPurchDateNep').value = nepaliDate || '';
            }

            // Populate products table
            renderEditPurchProducts(txn.items || []);

            // Enable dual date input for the edit modal
            window.enableDualDateInput('editPurchDate', 'editPurchDateNep');

            // Update date field visibility based on mode
            window.updateDateModeVisibility();

            // Open modal
            openModal('editPurchaseModal');
        };

        function renderEditPurchProducts(items) {
            editPurchProducts = JSON.parse(JSON.stringify(items)); // Deep copy
            const tbody = document.getElementById('editPurchProductsBody');
            tbody.innerHTML = '';

            editPurchProducts.forEach((item, index) => {
                const total = (item.qty || 0) * (item.cost || 0);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2 text-white">${item.name}</td>
                    <td class="p-2">
                        <input type="number" value="${item.qty}" min="1" 
                            class="input-field text-right w-20" 
                            onchange="updateEditPurchProduct(${index}, 'qty', this.value)">
                    </td>
                    <td class="p-2">
                        <input type="number" value="${item.cost}" min="0" step="0.01" 
                            class="input-field text-right w-24" 
                            onchange="updateEditPurchProduct(${index}, 'cost', this.value)">
                    </td>
                    <td class="p-2 text-right font-bold text-karta-primary">${db.config.currency}${total.toFixed(2)}</td>
                    <td class="p-2 text-center">
                        <button type="button" onclick="removeEditPurchProduct(${index})" 
                            class="text-red-400 hover:text-red-300" title="Remove">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            updateEditPurchTotal();
        }

        window.updateEditPurchProduct = function (index, field, value) {
            editPurchProducts[index][field] = parseFloat(value) || 0;
            renderEditPurchProducts(editPurchProducts);
        };

        window.removeEditPurchProduct = function (index) {
            if (editPurchProducts.length <= 1) {
                alert('Cannot remove the last product. Purchase must have at least one item.');
                return;
            }
            editPurchProducts.splice(index, 1);
            renderEditPurchProducts(editPurchProducts);
        };

        function updateEditPurchTotal() {
            const total = editPurchProducts.reduce((sum, item) =>
                sum + ((item.qty || 0) * (item.cost || 0)), 0);
            document.getElementById('editPurchTotal').innerText = `${db.config.currency}${total.toFixed(2)}`;
        }

        // Handle Edit Purchase Form Submission
        document.getElementById('editPurchaseForm').onsubmit = function (e) {
            e.preventDefault();

            const txnId = document.getElementById('editPurchTxnId').value;
            const txn = db.transactions.find(t => t.id == txnId);

            if (!txn) {
                alert('Transaction not found!');
                return;
            }

            console.log('=== SAVING PURCHASE EDIT ===');
            console.log('Original transaction:', JSON.parse(JSON.stringify(txn)));

            // Get updated values
            const invoiceNo = document.getElementById('editPurchInvoiceNo').value;
            const dateEng = document.getElementById('editPurchDate').value;
            const dateNep = document.getElementById('editPurchDateNep').value;

            // Determine which date to use (same logic as POS/Purchase)
            const isNepaliMode = db.config.dateMode === 'nepali';
            let purchaseDate;

            if (isNepaliMode && dateNep) {
                const converted = window.convertNepToEng(dateNep);
                purchaseDate = converted || dateEng;
            } else {
                purchaseDate = dateEng;
            }

            // Calculate new totals
            const newTotal = moneyRound(editPurchProducts.reduce((sum, item) =>
                sum + ((item.qty || 0) * (item.cost || 0)), 0));

            const oldItems = txn.items || [];
            const oldTotal = txn.total;

            console.log(`Old total: ${oldTotal}, New total: ${newTotal}`);

            // STEP 1: Reverse old stock changes
            oldItems.forEach(oldItem => {
                const prod = db.products.find(p => p.id === oldItem.id);
                if (prod) {
                    prod.stock = Math.max(0, prod.stock - oldItem.qty);
                    console.log(`Reversed stock for ${oldItem.name}: -${oldItem.qty}, new stock: ${prod.stock}`);
                }
            });

            // STEP 2: Apply new stock changes
            editPurchProducts.forEach(newItem => {
                const prod = db.products.find(p => p.id === newItem.id);
                if (prod) {
                    prod.stock += newItem.qty;
                    console.log(`Applied new stock for ${newItem.name}: +${newItem.qty}, new stock: ${prod.stock}`);
                }
            });

            // STEP 3: Update supplier balance (only for credit purchases)
            const totalDiff = newTotal - oldTotal;
            if (totalDiff !== 0 && txn.payType === 'credit') {
                const supplier = db.suppliers.find(s => s.id === txn.entityId);
                if (supplier) {
                    supplier.balance = moneyRound(supplier.balance + totalDiff);
                    console.log(`Updated supplier balance by ${totalDiff}: ${supplier.balance}`);
                }
            }

            // STEP 4: Update transaction
            txn.supplierInvoiceNumber = invoiceNo;
            txn.purchaseDate = purchaseDate;
            txn.items = editPurchProducts;
            txn.total = newTotal;
            txn.sub = newTotal; // Assuming no additional tax/discount

            console.log('Updated transaction:', txn);

            // Save and refresh
            saveDB();
            closeModal();
            loadPurchaseInvoices();
            alert('✅ Purchase invoice updated successfully!');
        };

        // Update loadPOS to also call loadPurchaseInvoices if on that page
        window.nav_original = window.nav;
        window.nav = function (page) {
            window.nav_original(page);
            if (page === 'purchaseInvoices') {
                setTimeout(() => loadPurchaseInvoices(), 100);
            }
        }

        // Helper to pass object in HTML string onclick
        window.printInvoiceStr = function (txn) {
            printInvoice(txn);
        }

        window.editInvoice = function (id) {
            editTxnId = id;
            const txn = db.transactions.find(t => t.id === id);
            if (!txn) return;

            window.openModal('invEditModal');
            document.getElementById('editInvId').innerText = id;

            const custSel = document.getElementById('editInvCust');
            custSel.innerHTML = db.customers.map(c => `<option value="${c.id}" ${c.id === txn.entityId ? 'selected' : ''}>${c.name}</option>`).join('');
            // If Guest, add option
            if (!txn.entityId) custSel.innerHTML += `<option value="" selected>Guest Customer</option>`;

            document.getElementById('editInvPay').value = txn.payType || 'cash';

            const container = document.getElementById('editInvItems');
            container.innerHTML = '';
            txn.items.forEach(item => {
                container.appendChild(createEditItemRow(item));
            });
        }

        function createEditItemRow(item = { name: '', qty: 1, retail: 0, id: 0 }) {
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center";
            div.innerHTML = `
                <input type="hidden" class="product-id" value="${item.id || 0}">
                <input type="text" class="input-field w-1/2 text-xs" placeholder="Product" value="${item.name}">
                <input type="number" class="input-field w-16 text-xs" placeholder="Qty" value="${item.qty}">
                <input type="number" class="input-field w-20 text-xs" placeholder="Price" value="${item.retail}">
                <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-300"><i class="fa-solid fa-trash"></i></button>
            `;
            return div;
        }

        window.addEditItem = function () {
            document.getElementById('editInvItems').appendChild(createEditItemRow());
        }

        window.saveInvoiceEdit = function () {
            if (!editTxnId) return;

            // REVERSE OLD TXN - Completely undo all effects
            const oldTxn = db.transactions.find(t => t.id === editTxnId);

            // 1. Revert stock back to what it was before original transaction
            oldTxn.items.forEach(i => {
                const p = i.id ? db.products.find(x => x.id === i.id) : db.products.find(x => x.name === i.name);
                if (p) p.stock += i.qty;  // Return the items to stock
            });

            // 2. Revert customer balance (reduce what they owe if was credit sale)
            if (oldTxn.payType === 'credit' && oldTxn.entityId) {
                const c = db.customers.find(x => x.id === oldTxn.entityId);
                if (c) c.balance -= oldTxn.total;
            }

            // 3. CRITICAL: Revert cash/bank balance updates
            if (!db.config.cashBalance) db.config.cashBalance = 0;
            if (!db.config.bankBalance) db.config.bankBalance = 0;

            if (oldTxn.payType === 'cash') {
                // Cash sale: return the cash
                db.config.cashBalance = moneyRound(db.config.cashBalance - oldTxn.total);
            } else if (oldTxn.payType === 'bank') {
                // Bank sale: return the bank deposit
                db.config.bankBalance = moneyRound(db.config.bankBalance - oldTxn.total);
            } else if (oldTxn.payType === 'split' && oldTxn.cashAmount) {
                // Split sale: return cash and bank portions
                if (oldTxn.cashAmount) db.config.cashBalance = moneyRound(db.config.cashBalance - oldTxn.cashAmount);
                if (oldTxn.bankAmount) db.config.bankBalance = moneyRound(db.config.bankBalance - oldTxn.bankAmount);
            }

            // BUILD NEW TXN DATA
            const rows = document.querySelectorAll('#editInvItems > div');
            const newItems = [];
            let sub = 0;
            rows.forEach(r => {
                const hiddenId = parseInt(r.querySelector('.product-id').value) || 0;
                const inputs = r.querySelectorAll('input[type="text"], input[type="number"]');
                const name = inputs[0].value;
                const qty = parseInt(inputs[1].value);
                const retail = moneyRound(parseFloat(inputs[2].value));
                if (name && qty > 0) {
                    // FIX #3: GHOST ITEM - Persist product_id from original transaction
                    newItems.push({ name, qty, retail, id: hiddenId });
                    sub = moneyRound(sub + moneyRound(qty * retail));
                }
            });

            const tax = moneyRound(sub * (db.config.vatRate / 100));
            const newTotal = moneyRound(sub + tax);
            const payType = document.getElementById('editInvPay').value;
            const custIdVal = document.getElementById('editInvCust').value;
            const custId = custIdVal ? parseInt(custIdVal) : null;
            const custName = custId ? db.customers.find(c => c.id === custId).name : 'Guest Customer';

            // APPLY NEW TXN - Apply all effects of the new transaction
            // 1. Deduct stock
            newItems.forEach(i => {
                const p = i.id ? db.products.find(x => x.id === i.id) : db.products.find(x => x.name === i.name);
                if (p) p.stock -= i.qty;
            });

            // 2. Update customer balance
            if (payType === 'credit' && custId) {
                const c = db.customers.find(x => x.id === custId);
                if (c) c.balance += newTotal;
            }

            // 3. CRITICAL: Update cash/bank balances based on new payment type
            if (payType === 'cash') {
                // Cash sale: increase cash
                db.config.cashBalance = moneyRound(db.config.cashBalance + newTotal);
            } else if (payType === 'bank') {
                // Bank sale: increase bank
                db.config.bankBalance = moneyRound(db.config.bankBalance + newTotal);
            } else if (payType === 'split') {
                // Split sale: need to split the amount
                // For now, split evenly (can be customized)
                const cashPortion = moneyRound(newTotal / 2);
                const bankPortion = moneyRound(newTotal - cashPortion);
                db.config.cashBalance = moneyRound(db.config.cashBalance + cashPortion);
                db.config.bankBalance = moneyRound(db.config.bankBalance + bankPortion);
            }

            // Update Record with all new data
            oldTxn.items = newItems;
            oldTxn.sub = sub;
            oldTxn.tax = tax;
            oldTxn.total = newTotal;
            oldTxn.payType = payType;
            oldTxn.entityId = custId;
            oldTxn.entityName = custName;
            oldTxn.cashBalance = db.config.cashBalance;  // Store snapshot
            oldTxn.bankBalance = db.config.bankBalance;  // Store snapshot

            // Update amount tracking for payment method
            if (payType === 'cash') {
                oldTxn.cashAmount = newTotal;
                oldTxn.bankAmount = 0;
                oldTxn.creditAmount = 0;
            } else if (payType === 'bank') {
                oldTxn.cashAmount = 0;
                oldTxn.bankAmount = newTotal;
                oldTxn.creditAmount = 0;
            } else if (payType === 'credit') {
                oldTxn.cashAmount = 0;
                oldTxn.bankAmount = 0;
                oldTxn.creditAmount = newTotal;
            }

            saveDB();
            window.closeModal();
            loadInvoices(); // Refresh invoice list
            loadDashboard(); // Refresh dashboard KPIs
            alert(`Invoice Updated!\n\nNew Total: ${db.config.currency}${newTotal.toFixed(2)}\nPayment Type: ${payType.toUpperCase()}\n\nCash Balance: ${db.config.currency}${db.config.cashBalance.toFixed(2)}\nBank Balance: ${db.config.currency}${db.config.bankBalance.toFixed(2)}`);
        }

        window.deleteInvoice = function () {
            if (!editTxnId || !confirm("Delete this invoice permanently? This will restore stock and refund money.")) return;

            const oldTxn = db.transactions.find(t => t.id === editTxnId);
            if (!oldTxn) {
                alert('Invoice not found or already deleted.');
                return;
            }

            // REVERSE ALL EFFECTS
            // CHECK IF THIS IS A RETURN OR A SALE
            if (oldTxn.isReturn) {
                // === DELETING A RETURN TRANSACTION ===
                // This means the return never happened.
                // 1. UNDO RESTOCK (Remove the items that were returned)
                if (oldTxn.items && Array.isArray(oldTxn.items)) {
                    oldTxn.items.forEach(i => {
                        const p = db.products.find(x => x.id === i.id);
                        if (p) {
                            console.log(`✓ Un-Restocking (Return Deleted): Removing ${i.qty} units of "${i.name}" from inventory`);
                            // Remove stock quantity (Reverse of "stock += qty")
                            p.stock = Math.max(0, (p.stock || 0) - i.qty);
                            console.log(`  New stock: ${p.stock} units`);
                        }
                    });
                }

                // 2. UNDO REFUND (Add money/credit back to our accounts/customer balance)
                // If we gave Cash/Bank, we get it back. If we gave Credit, Customer owes us again.

                // 2a. Revert Customer Balance (if Refund was to Credit)
                if (oldTxn.payType === 'credit' && oldTxn.entityId) {
                    const c = db.customers.find(x => x.id === oldTxn.entityId);
                    // We reduced their debt, now we increase it back
                    if (c) c.balance = moneyRound((c.balance || 0) + oldTxn.total);
                } else if (oldTxn.payType === 'split' && oldTxn.entityId) {
                    const c = db.customers.find(x => x.id === oldTxn.entityId);
                    // If split had credit part (stored in duplicate logic unfortunately, relying on creditAmount or total if needed)
                    // But simplest is: oldTxn.creditAmount was negative during return? 
                    // Let's use computed total logic from Refund
                    if (oldTxn.creditAmount && c) {
                        // creditAmount is usually negative in DB for sales... wait. 
                        // For returns, let's verify storage. In processReturn, total is negative.
                        // But we store absolute value usually? No, let's check processReturn.
                        // processReturn stores total as NEGATIVE.
                        // So here oldTxn.total is negative (e.g., -100).
                        // If we subtract negative (-(-100)), we add 100.
                        // Wait, for standard sale: total is positive. "balance -= total" -> 500 - 100 = 400.
                        // For return: total is negative (-100).

                        // Let's rely on explicit Inversion Logic rather than math tricks for clarity.
                        // Return Refunded $100 Credit -> Balance Reduced by 100.
                        // Undo -> Balance Increased by 100.
                        if (oldTxn.creditAmount) {
                            const mag = Math.abs(oldTxn.creditAmount);
                            if (c) c.balance = moneyRound((c.balance || 0) + mag);
                        } else if (oldTxn.splitCredit) {
                            const mag = Math.abs(oldTxn.splitCredit);
                            if (c) c.balance = moneyRound((c.balance || 0) + mag);
                        }
                    }
                }

                // 2b. Revert Cash/Bank Balance (We gave money out, now we put it back in system)
                if (!db.config.cashBalance) db.config.cashBalance = 0;
                if (!db.config.bankBalance) db.config.bankBalance = 0;

                const absTotal = Math.abs(oldTxn.total); // Return totals are stored as negative usually

                if (oldTxn.payType === 'cash') {
                    db.config.cashBalance = moneyRound(db.config.cashBalance + absTotal);
                } else if (oldTxn.payType === 'bank') {
                    db.config.bankBalance = moneyRound(db.config.bankBalance + absTotal);
                } else if (oldTxn.payType === 'split') {
                    if (oldTxn.cashAmount || oldTxn.splitCash) db.config.cashBalance = moneyRound(db.config.cashBalance + Math.abs(oldTxn.cashAmount || oldTxn.splitCash || 0));
                    if (oldTxn.bankAmount || oldTxn.splitBank) db.config.bankBalance = moneyRound(db.config.bankBalance + Math.abs(oldTxn.bankAmount || oldTxn.splitBank || 0));
                }

            } else {
                // === DELETING A STANDARD SALE === (Original Logic)
                // 1. RESTORE SOLD STOCK (add back quantity to inventory)
                if (oldTxn.items && Array.isArray(oldTxn.items)) {
                    oldTxn.items.forEach(i => {
                        const p = db.products.find(x => x.id === i.id);
                        if (p) {
                            console.log(`✓ Restocking: Adding ${i.qty} units of "${i.name}" back to inventory`);
                            // Restore stock quantity
                            p.stock = (p.stock || 0) + i.qty;
                            console.log(`  New stock: ${p.stock} units`);
                        } else {
                            console.warn(`⚠ Product not found: ${i.name} (ID: ${i.id})`);
                        }
                    });
                }

                // 2. Revert customer balance
                if (oldTxn.payType === 'credit' && oldTxn.entityId) {
                    const c = db.customers.find(x => x.id === oldTxn.entityId);
                    if (c) c.balance -= oldTxn.total;
                }

                // 3. CRITICAL: Reverse cash/bank balance
                if (!db.config.cashBalance) db.config.cashBalance = 0;
                if (!db.config.bankBalance) db.config.bankBalance = 0;

                if (oldTxn.payType === 'cash') {
                    db.config.cashBalance = moneyRound(db.config.cashBalance - oldTxn.total);
                } else if (oldTxn.payType === 'bank') {
                    db.config.bankBalance = moneyRound(db.config.bankBalance - oldTxn.total);
                } else if (oldTxn.payType === 'split') {
                    if (oldTxn.cashAmount) db.config.cashBalance = moneyRound(db.config.cashBalance - oldTxn.cashAmount);
                    if (oldTxn.bankAmount) db.config.bankBalance = moneyRound(db.config.bankBalance - oldTxn.bankAmount);
                }
            }

            db.transactions = db.transactions.filter(t => t.id !== editTxnId);

            // CRITICAL: Save immediately to localStorage (without debounce for permanent deletion)
            localStorage.setItem(DB_KEY, JSON.stringify(db));

            // Also sync to Firebase if available
            if (firebaseAvailable && dbRealtime && currentUser) {
                const userRef = ref(dbRealtime, 'users/' + currentUser.uid + '/data');
                set(userRef, db)
                    .then(() => console.log("✓ Invoice deletion synced to Firebase"))
                    .catch((err) => console.error("Firebase sync error:", err));
            }

            window.closeModal();
            loadInvoices();
            loadDashboard(); // Refresh dashboard KPIs
            alert(`✓ INVOICE DELETED PERMANENTLY!\n\nCash Balance: ${db.config.currency}${db.config.cashBalance.toFixed(2)}\nBank Balance: ${db.config.currency}${db.config.bankBalance.toFixed(2)}\n\nInvoice has been completely removed from database.`);
        }

        // Load and display batches in the Stock Batches table
        window.loadBatches = function () {
            const tbody = document.getElementById('batchBody');
            if (!tbody) return; // Element doesn't exist if not on purchases page

            tbody.innerHTML = '';

            // Ensure batches array exists
            if (!db.batches) db.batches = [];

            // AUTO-CLEAN: Remove old stock products with 0 qty if newer stock exists
            const productNames = {};
            db.products.forEach(p => {
                if (!productNames[p.name]) productNames[p.name] = [];
                productNames[p.name].push(p);
            });

            // For each product name, if we have multiple batches
            Object.keys(productNames).forEach(name => {
                const variants = productNames[name];
                if (variants.length > 1) {
                    // Sort by expiry date - oldest first (FEFO: First Expire, First Out)
                    variants.sort((a, b) => {
                        const expiryA = a.expiry ? new Date(a.expiry) : new Date('2099-12-31');
                        const expiryB = b.expiry ? new Date(b.expiry) : new Date('2099-12-31');
                        return expiryA - expiryB;
                    });

                    // Check if we have at least one variant with stock > 0
                    const hasNewStock = variants.some(v => v.stock > 0);

                    // If newer stock exists, delete old items with 0 quantity
                    if (hasNewStock) {
                        variants.forEach((v, idx) => {
                            if (idx > 0 && v.stock === 0) {
                                // FIX #4: MISSING HISTORY - Mark as hidden instead of deleting
                                v.hidden = true;
                            }
                        });
                    }
                }
            });

            // Save cleanup changes to database
            saveDB();

            // Sort batches by purchase date (newest first)
            const sortedBatches = (db.batches && Array.isArray(db.batches)) ? db.batches.slice().reverse() : [];

            if (sortedBatches.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-400">No stock batches recorded yet</td></tr>`;
                return;
            }

            sortedBatches.forEach(batch => {
                // Determine expiry status for color coding
                let expiryClass = 'text-gray-400';
                let expiryText = batch.expiryDate || 'N/A';

                if (batch.expiryDate && batch.expiryDate !== 'N/A') {
                    const expireDate = new Date(batch.expiryDate);
                    const today = new Date();
                    const daysUntilExpiry = Math.floor((expireDate - today) / (1000 * 60 * 60 * 24));

                    if (daysUntilExpiry <= 0) {
                        expiryClass = 'text-red-500 font-bold';
                    } else if (daysUntilExpiry <= 7) {
                        expiryClass = 'text-red-500 font-bold';
                    } else if (daysUntilExpiry <= 30) {
                        expiryClass = 'text-orange-500';
                    } else if (daysUntilExpiry <= 90) {
                        expiryClass = 'text-yellow-500';
                    }
                }

                const purchaseDate = batch.purchaseDate ? window.formatDate(batch.purchaseDate) : 'N/A';

                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 border-b border-gray-800";
                tr.innerHTML = `
                    <td class="p-3 text-white">${batch.productName || '-'}</td>
                    <td class="p-3 text-gray-400">${batch.batchNumber || '-'}</td>
                    <td class="p-3 ${expiryClass}">${expiryText}</td>
                    <td class="p-3 text-right text-gray-300">${batch.quantity}</td>
                    <td class="p-3 text-right text-gray-400">${db.config.currency}${(batch.costPrice || 0).toFixed(2)}</td>
                    <td class="p-3 text-gray-400 text-sm">${purchaseDate}</td>
                    <td class="p-3 text-gray-400">${batch.supplierName || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- Dashboard & Charts ---
        let mainChart;
        let catChart;

        function loadDashboard() {
            // FIX: Ensure arrays exist
            if (!db.transactions) db.transactions = [];
            if (!db.products) db.products = [];
            if (!db.customers) db.customers = [];
            if (!db.suppliers) db.suppliers = [];
            if (!db.config) db.config = APP_STATE.config;

            const sales = db.transactions.filter(t => t.type === 'sale');
            const revenue = sales.reduce((a, c) => a + c.total, 0);
            const stockVal = db.products.reduce((a, c) => a + (c.stock * c.cost), 0);

            // FIX #4: CRITICAL - USE db.config balances directly (source of truth)
            // These are updated in real-time by ALL transactions (sales, purchases, expenses, returns, settlements)
            // Do NOT recalculate from transactions as this causes rounding errors and accounting inaccuracies
            // db.config.cashBalance and db.config.bankBalance are the SINGLE SOURCE OF TRUTH
            const cashTotal = moneyRound(db.config.cashBalance || 0);
            const bankTotal = moneyRound(db.config.bankBalance || 0);

            // Calculate Credit totals from customer/supplier balances (receivables/payables)
            // This is NOT affected by cash/bank as credit transactions don't affect liquid balances
            let creditTotal = 0;

            // Calculate customer balance due (receivables)
            const customerBalanceDue = db.customers.reduce((a, c) => a + c.balance, 0);

            // Calculate supplier balance due (payables)
            const supplierBalanceDue = db.suppliers.reduce((a, s) => a + s.balance, 0);

            // Net balance = Receivables - Payables
            const netBalance = customerBalanceDue - supplierBalanceDue;

            // Get expired/expiring products
            const today = new Date().toISOString().split('T')[0];
            const ninetyDaysLater = new Date();
            ninetyDaysLater.setDate(ninetyDaysLater.getDate() + 90);
            const expireThresholdDate = ninetyDaysLater.toISOString().split('T')[0];

            const lowStock = db.products.filter(p => p.stock <= p.reorder && p.stock > 0);

            // Show both expired AND expiring soon products (within 90 days from today)
            const expiredProducts = db.products.filter(p => {
                return p.expiry && p.expiry.trim() !== '' && p.expiry <= expireThresholdDate && p.stock > 0;
            }).sort((a, b) => new Date(a.expiry) - new Date(b.expiry));

            // Update KPI Elements with null checks
            if (document.getElementById('kpiRevenue')) document.getElementById('kpiRevenue').innerText = `${db.config.currency}${revenue.toFixed(2)}`;
            if (document.getElementById('kpiCash')) document.getElementById('kpiCash').innerText = `${db.config.currency}${cashTotal.toFixed(2)}`;
            if (document.getElementById('kpiBank')) document.getElementById('kpiBank').innerText = `${db.config.currency}${bankTotal.toFixed(2)}`;
            if (document.getElementById('kpiStockVal')) document.getElementById('kpiStockVal').innerText = `${db.config.currency}${stockVal.toFixed(2)}`;
            if (document.getElementById('kpiLowStock')) document.getElementById('kpiLowStock').innerText = `${lowStock.length}`;

            // Update Balance KPIs
            if (document.getElementById('kpiCustDue')) document.getElementById('kpiCustDue').innerText = `${db.config.currency}${customerBalanceDue.toFixed(2)}`;
            if (document.getElementById('kpiSupDue')) document.getElementById('kpiSupDue').innerText = `${db.config.currency}${supplierBalanceDue.toFixed(2)}`;
            if (document.getElementById('kpiNetBalance')) {
                document.getElementById('kpiNetBalance').innerText = `${db.config.currency}${netBalance.toFixed(2)}`;
                // Color code net balance - use theme colors
                const netEl = document.getElementById('kpiNetBalance');
                if (netBalance > 0) {
                    netEl.className = 'text-3xl font-bold text-green-500';
                } else if (netBalance < 0) {
                    netEl.className = 'text-3xl font-bold text-red-500';
                } else {
                    netEl.className = 'text-3xl font-bold text-karta-primary';
                }
            }

            const lsBody = document.getElementById('lowStockBody');
            if (lsBody) {
                lsBody.innerHTML = '';
                if (lowStock.length === 0) {
                    lsBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">✓ All products above reorder level</td></tr>`;
                } else {
                    lowStock.forEach(p => {
                        const percentOfReorder = Math.round((p.stock / p.reorder) * 100);
                        const rowClass = percentOfReorder < 25 ? 'bg-red-950/20 border-l-4 border-red-600' : 'bg-orange-950/20 border-l-4 border-orange-500';
                        lsBody.innerHTML += `
                            <tr class="hover:bg-white/5 ${rowClass}">
                                <td class="p-3 text-white font-bold">${p.name}</td>
                                <td class="p-3 text-gray-500">${p.sku || '-'}</td>
                                <td class="p-3 text-gray-500">${p.supplierName || 'Internal'}</td>
                                <td class="p-3 text-right font-bold ${percentOfReorder < 25 ? 'text-red-500' : 'text-orange-500'}">${p.stock}</td>
                                <td class="p-3 text-right text-gray-400">${p.reorder} (${percentOfReorder}%)</td>
                            </tr>
                        `;
                    });
                }
            }

            // Populate expired products table
            const expBody = document.getElementById('expiredBody');
            if (expBody) {
                expBody.innerHTML = '';
                if (expiredProducts.length === 0) {
                    expBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-400">✓ No expired or expiring products</td></tr>`;
                } else {
                    expiredProducts.forEach(p => {
                        const expiryDate = new Date(p.expiry);
                        const todayDate = new Date();
                        const daysExpired = Math.floor((todayDate - expiryDate) / (1000 * 60 * 60 * 24));
                        let statusClass, statusText, rowClass;

                        if (daysExpired > 0) {
                            // Already expired
                            if (daysExpired > 90) {
                                statusClass = 'text-red-700 font-bold';
                                statusText = `🔴 ${daysExpired} days OVERDUE`;
                                rowClass = 'bg-red-950/40 border-l-4 border-red-700';
                            } else if (daysExpired > 30) {
                                statusClass = 'text-red-600 font-bold';
                                statusText = `🔴 ${daysExpired} days overdue`;
                                rowClass = 'bg-red-950/30 border-l-4 border-red-600';
                            } else {
                                statusClass = 'text-red-500 font-bold';
                                statusText = `🔴 Expired ${daysExpired} day(s) ago`;
                                rowClass = 'bg-red-950/20 border-l-4 border-red-500';
                            }
                        } else {
                            // Expiring soon
                            const daysUntilExpiry = Math.abs(daysExpired);
                            if (daysUntilExpiry <= 3) {
                                statusClass = 'text-red-600 font-bold';
                                statusText = ` EXPIRES IN ${daysUntilExpiry} DAY${daysUntilExpiry !== 1 ? 'S' : ''}`;
                                rowClass = 'bg-red-950/30 border-l-4 border-red-600';
                            } else if (daysUntilExpiry <= 7) {
                                statusClass = 'text-red-500 font-bold';
                                statusText = ` Expires in ${daysUntilExpiry} days`;
                                rowClass = 'bg-red-950/20 border-l-4 border-red-500';
                            } else if (daysUntilExpiry <= 30) {
                                statusClass = 'text-orange-500 font-bold';
                                statusText = ` Expires in ${daysUntilExpiry} days`;
                                rowClass = 'bg-orange-950/15 border-l-4 border-orange-500';
                            } else {
                                statusClass = 'text-yellow-600';
                                statusText = ` Expires in ${daysUntilExpiry} days`;
                                rowClass = 'bg-yellow-950/10 border-l-4 border-yellow-600';
                            }
                        }

                        expBody.innerHTML += `
                            <tr class="hover:bg-white/5 ${rowClass}">
                                <td class="p-3 text-white font-bold">${p.name}</td>
                                <td class="p-3 text-gray-500">${p.sku || '-'}</td>
                                <td class="p-3 text-gray-400">${p.batch || 'N/A'}</td>
                                <td class="p-3 text-center font-mono text-sm text-gray-300">${p.expiry}</td>
                                <td class="p-3 text-right font-bold text-white">${p.stock} units</td>
                                <td class="p-3 text-center ${statusClass}">${statusText}</td>
                            </tr>
                        `;
                    });
                }
            }

            // Charts
            const labels = [], salesData = [], purchData = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const dateKey = d.toISOString().split('T')[0];
                labels.push(d.toLocaleDateString(undefined, { weekday: 'short' }));
                const dayTxns = db.transactions.filter(t => t.date.startsWith(dateKey));
                salesData.push(dayTxns.filter(t => t.type === 'sale').reduce((sum, t) => sum + t.total, 0));
                purchData.push(dayTxns.filter(t => t.type === 'purchase').reduce((sum, t) => sum + t.total, 0));
            }

            const catTotals = {};
            db.transactions.filter(t => t.type === 'sale').forEach(t => {
                t.items.forEach(item => {
                    const prod = db.products.find(p => p.id === item.id) || db.products.find(p => p.name === item.name);
                    const cat = prod ? prod.category : 'Uncategorized';
                    const lineTotal = item.qty * (item.retail || 0);
                    catTotals[cat] = (catTotals[cat] || 0) + lineTotal;
                });
            });

            const ctxMain = document.getElementById('mainChart');
            if (ctxMain) {
                const mainCtx = ctxMain.getContext('2d');
                if (mainChart) mainChart.destroy();
                mainChart = new Chart(mainCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Sales', data: salesData, backgroundColor: '#00c853' },
                            { label: 'Purchases', data: purchData, backgroundColor: '#333333' }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            const ctxCat = document.getElementById('categoryChart');
            if (ctxCat) {
                const catCtx = ctxCat.getContext('2d');
                if (catChart) catChart.destroy();
                catChart = new Chart(catCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(catTotals).length ? Object.keys(catTotals) : ['No Sales'],
                        datasets: [{ data: Object.values(catTotals).length ? Object.values(catTotals) : [1], backgroundColor: ['#00c853', '#009624', '#69f0ae'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        }

        // --- Invoice Printing ---
        // Number to Nepali Words Converter
        function numberToWords(num) {
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
            const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            const scales = ['', 'Thousand', 'Million', 'Billion', 'Trillion'];

            if (num === 0) return 'Zero';
            if (num < 0) return 'Negative ' + numberToWords(-num);

            let words = '';
            let scaleIndex = 0;

            while (num > 0) {
                if (num % 1000 !== 0) {
                    words = convertHundreds(num % 1000) + (scales[scaleIndex] ? ' ' + scales[scaleIndex] + ' ' : '') + words;
                }
                num = Math.floor(num / 1000);
                scaleIndex++;
            }

            function convertHundreds(num) {
                let result = '';
                if (Math.floor(num / 100) > 0) {
                    result += ones[Math.floor(num / 100)] + ' Hundred ';
                }
                num %= 100;
                if (num >= 20) {
                    result += tens[Math.floor(num / 10)] + ' ';
                    if (num % 10 > 0) result += ones[num % 10];
                } else if (num >= 10) {
                    result += teens[num - 10];
                } else if (num > 0) {
                    result += ones[num];
                }
                return result.trim();
            }

            return words.trim();
        }

        function printInvoice(txn) {
            // SHOW INVOICE VIEW, HIDE REPORT VIEW
            document.getElementById('invoice-print-view').classList.remove('hidden');
            document.getElementById('report-print-view').classList.add('hidden');

            // Show logo if exists
            const logoImg = document.getElementById('printInvLogo');
            if (db.config.logo) {
                logoImg.src = db.config.logo;
                logoImg.style.display = 'block';
            } else {
                logoImg.style.display = 'none';
            }

            // Company Info
            document.getElementById('invCompName').innerText = db.config.name;
            document.getElementById('invCompAddr').innerText = 'Address: ' + (db.config.address || '-');
            document.getElementById('invCompPhone').innerText = 'Phone: ' + (db.config.phone || '-');
            document.getElementById('invCompTax').innerText = db.config.taxId || '123456789';
            document.getElementById('invCompRepName').innerText = db.config.name || 'Company';

            // Invoice Details - Get the same invoice number as shown in list
            let invoiceNum = txn.invoiceNumber;
            if (!invoiceNum) {
                // For old invoices without invoiceNumber field, assign based on chronological position
                const allSales = db.transactions.filter(t => t.type === 'sale').sort((a, b) => new Date(a.date) - new Date(b.date));
                const position = allSales.findIndex(s => s.id === txn.id);
                // Use position directly, not reset number - keeps old invoices unchanged
                invoiceNum = 'INV-' + String(1 + position).padStart(3, '0');
            }
            document.getElementById('invNo').innerText = invoiceNum;
            document.getElementById('invDate').innerText = window.formatDate(txn.date);
            document.getElementById('invSignDate').innerText = window.formatDate(txn.date);

            // Customer Info - Enhanced with full details
            const customer = db.customers.find(c => c.id === txn.entityId) || {};
            let custDetailsHTML = '<strong>' + (txn.entityName || 'Guest Customer') + '</strong>';
            if (customer.id) {
                custDetailsHTML += '<br><small>Customer ID: ' + customer.id + '</small>';
            }
            if (customer.address) {
                custDetailsHTML += '<br><small>Address: ' + customer.address + '</small>';
            }
            if (txn.entityPhone) {
                custDetailsHTML += '<br><small>Phone: ' + txn.entityPhone + '</small>';
            }
            if (txn.entityTaxId || customer.taxId) {
                custDetailsHTML += '<br><small>VAT ID: ' + (txn.entityTaxId || customer.taxId) + '</small>';
            }
            document.getElementById('invCustName').innerHTML = custDetailsHTML;
            document.getElementById('invCustContact').innerText = '';
            document.getElementById('invCustTaxId').innerText = '';
            document.getElementById('invCustSignature').innerText = (txn.entityName || 'Customer') + ' - Signature';

            // Payment method
            document.getElementById('invPayMethod').innerText = txn.payType || 'Cash';

            // Set invoice title - check if this is a return
            const invTitle = document.getElementById('invTitle');
            if (txn.isReturn) {
                invTitle.innerText = 'SALES RETURN';
                invTitle.style.color = 'red';
            } else {
                invTitle.innerText = 'TAX INVOICE';
                invTitle.style.color = '#000';
            }

            // Items with VAT columns
            const tbody = document.getElementById('invItemsBody');
            tbody.innerHTML = '';
            const vatRate = db.config.vatRate || 13;
            let totalVatAmount = 0;
            let taxableAmountForVat = 0;  // Sum of VAT items only
            let subtotalAllItems = 0;     // Sum of all items

            txn.items.forEach((item, idx) => {
                const itemPrice = item.retail || 0;
                const itemQty = item.qty || 0;
                const itemTotal = itemQty * itemPrice;
                const vatStatus = item.vatExempt ? 'No' : 'Yes';
                const itemVat = item.vatExempt ? 0 : (itemTotal * vatRate / 100);
                totalVatAmount += itemVat;
                subtotalAllItems += itemTotal;

                // Track taxable amount (only VAT items)
                if (!item.vatExempt) {
                    taxableAmountForVat += itemTotal;
                }

                tbody.innerHTML += `
                    <tr style="border-right: 1px solid #000; border-bottom: 1px solid #000;">
                        <td style="padding: 8px; text-align: center; border-right: 1px solid #000; border-bottom: 1px solid #000;">${idx + 1}</td>
                        <td style="padding: 8px; border-right: 1px solid #000; border-bottom: 1px solid #000;">
                            <strong>${item.name}</strong><br>
                            <span style="font-size: 10px; color: #666;">SKU: ${item.sku || 'N/A'}</span>
                        </td>
                        <td style="padding: 8px; text-align: center; border-right: 1px solid #000; border-bottom: 1px solid #000;">Pcs</td>
                        <td style="padding: 8px; text-align: right; border-right: 1px solid #000; border-bottom: 1px solid #000;">${itemQty}</td>
                        <td style="padding: 8px; text-align: right; border-right: 1px solid #000; border-bottom: 1px solid #000;">${itemPrice.toFixed(2)}</td>
                        <td style="padding: 8px; text-align: right; border-right: 1px solid #000; border-bottom: 1px solid #000;">${itemTotal.toFixed(2)}</td>
                        <td style="padding: 8px; text-align: center; border-right: 1px solid #000; border-bottom: 1px solid #000;">${vatStatus === 'Yes' ? vatRate : 0}%</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #000;">${itemVat.toFixed(2)}</td>
                    </tr>
                `;
            });

            // Update summary
            document.getElementById('invTaxableAmount').innerText = taxableAmountForVat.toFixed(2);
            document.getElementById('invSub').innerText = subtotalAllItems.toFixed(2);
            document.getElementById('invTax').innerText = (txn.tax || 0).toFixed(2);
            document.getElementById('invTotal').innerText = (txn.total || 0).toFixed(2);
            document.getElementById('invTotalWords').innerText = numberToWords(Math.floor(txn.total || 0)) + ' Only';

            // Show discount if applicable
            const discountRow = document.getElementById('invDiscountRow');
            if (txn.discountPercent && txn.discountPercent > 0) {
                discountRow.style.display = 'table-row';
                document.getElementById('invDiscountPercent').innerText = txn.discountPercent.toFixed(1);
                document.getElementById('invDiscount').innerText = (txn.discount || 0).toFixed(2);
            } else {
                discountRow.style.display = 'none';
            }

            // Show Freight Charge if applicable
            const freightRow = document.getElementById('invFreightRow');
            if (txn.freight && txn.freight > 0) {
                freightRow.style.display = 'block';
                document.getElementById('invFreight').innerText = (txn.freight || 0).toFixed(2);
            } else {
                freightRow.style.display = 'none';
            }

            // Show Freight Charge in summary table if applicable
            const freightRowInSummary = document.getElementById('invFreightRowInSummary');
            if (txn.freight && txn.freight > 0) {
                freightRowInSummary.style.display = 'table-row';
                document.getElementById('invFreightAmount').innerText = (txn.freight || 0).toFixed(2);
            } else {
                freightRowInSummary.style.display = 'none';
            }

            // Generate barcode (using first item's SKU)
            if (txn.items && txn.items.length > 0) {
                const barcodeText = txn.items[0].sku || txn.id.toString().slice(-8);
                document.getElementById('invBarcodeText').innerText = barcodeText;
                // Simple barcode visualization
                const barcodeSvg = document.getElementById('invBarcode');
                barcodeSvg.innerHTML = generateBarcodeDisplay(barcodeText);
            }

            // Try print, fallback to PDF for mobile apps
            setTimeout(() => {
                if (navigator.userAgent.toLowerCase().includes('twinr') || navigator.userAgent.toLowerCase().includes('mobile')) {
                    generateInvoicePDF(txn);
                } else {
                    window.print();
                }
            }, 200);
        }

        // Simple barcode display generator
        function generateBarcodeDisplay(text) {
            let svg = '<svg viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg">';
            svg += '<rect width="200" height="60" fill="white" stroke="black" stroke-width="1"/>';

            // Create pattern based on text
            let barPattern = '';
            for (let i = 0; i < text.length; i++) {
                const code = text.charCodeAt(i);
                barPattern += (code % 2 ? '█' : '░');
            }

            // Draw bars
            let x = 5;
            for (let i = 0; i < barPattern.length; i++) {
                const width = barPattern[i] === '█' ? 2.5 : 1.5;
                if (barPattern[i] === '█') {
                    svg += `<rect x="${x}" y="5" width="${width}" height="35" fill="black"/>`;
                }
                x += width + 0.5;
            }

            svg += `<text x="100" y="55" text-anchor="middle" font-size="10" font-family="Arial">${text}</text>`;
            svg += '</svg>';
            return svg;
        }

        // Generate Invoice as PDF (Mobile-friendly)
        function generateInvoicePDF(txn) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                let yPos = 20;

                // Logo
                if (db.config.logo) {
                    try {
                        doc.addImage(db.config.logo, 'JPEG', 85, 10, 30, 30);
                        yPos = 45;
                    } catch (e) { }
                }

                // Header
                doc.setFontSize(16);
                doc.text(db.config.name, 14, yPos);
                doc.setFontSize(10);
                yPos += 7;
                doc.text(db.config.address, 14, yPos);
                yPos += 5;
                doc.text(db.config.phone, 14, yPos);
                yPos += 5;
                doc.text(`VAT: ${db.config.taxId}`, 14, yPos);

                // Invoice Details
                yPos += 10;
                doc.setFontSize(14);
                doc.text('INVOICE', 14, yPos);
                yPos += 7;
                doc.setFontSize(10);
                doc.text(`Invoice #: ${txn.id.toString().slice(-6)}`, 14, yPos);
                yPos += 5;
                doc.text(`Date: ${window.formatDate(txn.date)}`, 14, yPos);
                yPos += 5;
                doc.text(`Customer: ${txn.entityName}`, 14, yPos);

                // Items Table
                const tableData = txn.items.map((item, idx) => [
                    idx + 1,
                    item.name + (item.vatExempt ? ' [No VAT]' : ''),
                    item.qty,
                    item.retail.toFixed(2),
                    (item.qty * item.retail).toFixed(2)
                ]);

                doc.autoTable({
                    startY: yPos + 8,
                    head: [['SN', 'Description', 'Qty', 'Unit Price', 'Total']],
                    body: tableData,
                    theme: 'grid',
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [0, 200, 83], textColor: 255 }
                });

                yPos = doc.lastAutoTable.finalY + 10;

                // Totals
                doc.setFontSize(10);
                doc.text(`Subtotal: ${db.config.currency}${(txn.sub).toFixed(2)}`, 140, yPos);
                yPos += 5;

                if (txn.discountPercent && txn.discountPercent > 0) {
                    doc.text(`Discount (${txn.discountPercent}%): -${db.config.currency}${(txn.discount).toFixed(2)}`, 140, yPos);
                    yPos += 5;
                }

                doc.setFont(undefined, 'bold');
                doc.text(`VAT (${db.config.vatRate}%): ${db.config.currency}${(txn.tax).toFixed(2)}`, 140, yPos);
                yPos += 7;
                doc.setFontSize(12);
                doc.text(`TOTAL: ${db.config.currency}${(txn.total).toFixed(2)}`, 140, yPos);

                // Footer
                yPos += 15;
                doc.setFontSize(8);
                doc.text('Thank you for your business!', 105, yPos, { align: 'center' });
                yPos += 4;
                doc.text('Generated by KARTA System', 105, yPos, { align: 'center' });

                // Save or Open
                const filename = `Invoice_${txn.id.toString().slice(-6)}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                alert(`Invoice saved: ${filename}`);
            } catch (err) {
                console.error('PDF generation failed:', err);
                alert('PDF generation failed. Please try again.');
            }
        }

        // --- Debtors Report Filter ---
        window.filterDebtorsReport = function () {
            const searchLocation = document.getElementById('debtorLocationSearch').value.toLowerCase();
            const tbody = document.getElementById('repTable');
            const rows = tbody.getElementsByTagName('tr');

            for (let row of rows) {
                const locationCell = row.cells[1];
                const location = locationCell ? locationCell.textContent.toLowerCase() : '';

                if (searchLocation === '' || location.includes(searchLocation)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        };

        // Helper function to print from transaction list
        window.printPurchaseInvoiceFromTxn = function (txnId) {
            const txn = db.transactions.find(t => t.id === parseInt(txnId));
            if (!txn || txn.type !== 'purchase') {
                alert('Invalid transaction');
                return;
            }

            const supplier = db.suppliers.find(s => s.id === txn.entityId) || {};
            const purchaseInvoice = {
                id: txn.id,
                ref: txn.ref || txn.id.toString().slice(-6),
                supplierInvoiceNumber: txn.supplierInvoiceNumber || null,
                date: txn.purchaseDate || txn.date,
                supplier: txn.entityName,
                supplierId: txn.entityId,
                items: (txn.items || []).map(item => ({
                    productId: item.id,
                    productName: item.name,
                    sku: item.sku || 'N/A',
                    qty: item.qty || 0,
                    unitPrice: item.unitPrice || item.cost || 0,
                    batch: item.batch || 'N/A',
                    expiry: item.expiry || 'N/A',
                    vatStatus: item.vatStatus || 'vat'
                })),
                subtotal: txn.subtotal || 0,
                discount: txn.discount || 0,
                discountPercent: txn.discountPercent || 0,
                totalVAT: 0,
                totalAmount: txn.total || 0,
                payType: txn.payType,
                cashAmount: txn.cashAmount,
                bankAmount: txn.bankAmount,
                creditAmount: txn.creditAmount
            };

            printPurchaseInvoice(purchaseInvoice);
        };

        // View Purchase Invoice in Modal
        window.viewPurchaseInvoice = function (txnId) {
            const txn = db.transactions.find(t => t.id === parseInt(txnId));
            if (!txn || txn.type !== 'purchase') {
                alert('Invalid transaction');
                return;
            }

            const supplier = db.suppliers.find(s => s.id === txn.entityId) || {};
            const purchaseInvoice = {
                id: txn.id,
                ref: txn.ref || txn.id.toString().slice(-6),
                supplierInvoiceNumber: txn.supplierInvoiceNumber || null,
                date: txn.purchaseDate || txn.date,
                supplier: txn.entityName,
                supplierId: txn.entityId,
                items: (txn.items || []).map(item => ({
                    productId: item.id,
                    productName: item.name,
                    sku: item.sku || 'N/A',
                    qty: item.qty || 0,
                    unitPrice: item.unitPrice || item.cost || 0,
                    batch: item.batch || 'N/A',
                    expiry: item.expiry || 'N/A',
                    vatStatus: item.vatStatus || 'vat'
                })),
                subtotal: txn.subtotal || 0,
                discount: txn.discount || 0,
                discountPercent: txn.discountPercent || 0,
                totalVAT: 0,
                totalAmount: txn.total || 0,
                payType: txn.payType,
                cashAmount: txn.cashAmount,
                bankAmount: txn.bankAmount,
                creditAmount: txn.creditAmount
            };

            // Display invoice in modal using the same HTML generation
            displayPurchaseInvoiceModal(purchaseInvoice);
        };

        // Display Purchase Invoice in Modal
        window.displayPurchaseInvoiceModal = function (purchaseInvoice) {
            try {
                // Get supplier details
                const supplier = db.suppliers.find(s => s.id === purchaseInvoice.supplierId) || {};
                const supplierPhone = supplier.phone || supplier.contact || '-';
                const supplierLocation = supplier.location || supplier.address || '-';
                const supplierVat = supplier.taxId || supplier.vat || '-';

                const vatRate = db.config.vatRate || 13;

                // Use stored totals from purchaseInvoice object
                let subtotal = purchaseInvoice.subtotal || 0;
                let discountAmount = purchaseInvoice.discount || 0;
                let discountPercent = purchaseInvoice.discountPercent || 0;

                // Calculate VAT from items if not stored
                let totalTax = purchaseInvoice.totalVAT || 0;
                if (totalTax === 0 && purchaseInvoice.items && purchaseInvoice.items.length > 0) {
                    purchaseInvoice.items.forEach(item => {
                        const itemTotal = (item.qty || 0) * (item.unitPrice || 0);
                        if (item.vatStatus !== 'exempt') {
                            totalTax += itemTotal * vatRate / 100;
                        }
                    });
                    totalTax = moneyRound(totalTax);
                }

                // If subtotal is 0 but items exist, calculate it
                if (subtotal === 0 && purchaseInvoice.items && purchaseInvoice.items.length > 0) {
                    purchaseInvoice.items.forEach(item => {
                        subtotal += (item.qty || 0) * (item.unitPrice || 0);
                    });
                    subtotal = moneyRound(subtotal);
                }

                // If discount is not stored, calculate it from discount percent
                if (discountPercent > 0 && discountAmount === 0) {
                    discountAmount = moneyRound(subtotal * (discountPercent / 100));
                }

                // Calculate grand total using the stored/calculated discount
                const subtotalAfterDiscount = moneyRound(subtotal - discountAmount);
                const vatAfterDiscount = moneyRound(totalTax * (1 - (discountPercent / 100)));
                const grandTotal = moneyRound(subtotalAfterDiscount + vatAfterDiscount);

                // Create modal HTML
                const modalHTML = document.createElement('div');
                modalHTML.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    padding: 20px;
                `;

                const container = document.createElement('div');
                container.style.cssText = `
                    background: white;
                    width: 100%;
                    max-width: 900px;
                    max-height: 90vh;
                    overflow-y: auto;
                    border-radius: 8px;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                    position: relative;
                `;

                // Close button
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '×';
                closeBtn.style.cssText = `
                    position: sticky;
                    top: 0;
                    right: 0;
                    z-index: 10001;
                    background: #000;
                    color: #fff;
                    border: none;
                    font-size: 32px;
                    cursor: pointer;
                    padding: 5px 15px;
                    width: 100%;
                    text-align: right;
                `;
                closeBtn.onclick = () => modalHTML.remove();

                // Generate invoice content (same as printPurchaseInvoice)
                const invoiceContent = generatePurchaseInvoiceHTML(purchaseInvoice, supplier, supplierPhone, supplierLocation, supplierVat, vatRate, subtotal, discountAmount, discountPercent, totalTax, subtotalAfterDiscount, vatAfterDiscount, grandTotal);

                const invoiceDiv = document.createElement('div');
                invoiceDiv.innerHTML = invoiceContent;

                container.appendChild(closeBtn);
                container.appendChild(invoiceDiv);
                modalHTML.appendChild(container);
                document.body.appendChild(modalHTML);
            } catch (err) {
                console.error('Error displaying purchase invoice:', err);
                alert('Error displaying invoice. Please check the console for details.');
            }
        };

        // Generate Purchase Invoice HTML (shared function for modal and print)
        window.generatePurchaseInvoiceHTML = function (purchaseInvoice, supplier, supplierPhone, supplierLocation, supplierVat, vatRate, subtotal, discountAmount, discountPercent, totalTax, subtotalAfterDiscount, vatAfterDiscount, grandTotal) {
            return `
                    <div style="font-family: Arial, sans-serif; color: #000; background: white; padding: 0;">
                    <!-- Main Border Container -->
                    <div style="border: 3px solid #000; padding: 25px; box-shadow: 0 0 0 1px #000;">
                    <!-- Header Section -->
                    <div style="border-bottom: 3px solid #000; padding-bottom: 15px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px;">
                            <div style="display: flex; gap: 15px; flex: 1;">
                                ${db.config.logo ? `<img src="${db.config.logo}" style="width: 85px; height: 85px; object-fit: contain; border: 2px solid #000; padding: 4px; background: white;" alt="Logo" />` : ''}
                                <div>
                                    <h1 style="font-size: 28px; font-weight: bold; margin: 0 0 2px 0; color: #000; letter-spacing: 1px;">${db.config.name}</h1>
                                    <p style="margin: 3px 0; font-size: 12px; font-weight: bold;">VAT Registration: ${db.config.taxId || 'N/A'}</p>
                                    <p style="margin: 2px 0; font-size: 11px;">${db.config.address || '-'}</p>
                                    <p style="margin: 2px 0; font-size: 11px;">Tel: ${db.config.phone || '-'}</p>
                                </div>
                            </div>
                            <div style="text-align: center; border-left: 3px solid #000; padding-left: 20px; background: #f9f9f9; padding: 15px 20px; min-width: 220px;">
                                <h2 id="purchInvTitle" style="font-size: 32px; font-weight: bold; color: #000; margin: 0 0 10px 0; letter-spacing: 2px;">PURCHASE</h2>
                                <p style="font-size: 24px; font-weight: bold; color: #000; margin: 0 0 8px 0;">INVOICE</p>
                                <p style="margin: 4px 0; font-size: 12px; font-weight: bold; border-top: 2px solid #000; padding-top: 10px;">Invoice: <span style="font-size: 14px;">#${purchaseInvoice.supplierInvoiceNumber || purchaseInvoice.ref || purchaseInvoice.id.toString().slice(-6)}</span></p>
                                <p style="margin: 4px 0; font-size: 11px;">Date: ${window.formatDate(purchaseInvoice.date)}</p>
                            </div>
                        </div>
                    </div>                    <!-- Supplier Information Box -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                        <div style="border: 2px solid #000; padding: 15px; font-size: 11px; background: #fafafa;">
                            <div style="font-weight: bold; border-bottom: 2px solid #000; padding-bottom: 8px; margin-bottom: 12px; font-size: 13px; text-transform: uppercase; letter-spacing: 1px;">Supplier Details</div>
                            <div style="font-weight: bold; font-size: 12px; margin: 5px 0 3px 0;">${purchaseInvoice.supplier || '-'}</div>
                            ${purchaseInvoice.supplierId ? `<div style="margin: 2px 0; font-size: 11px;"><strong>Supplier ID:</strong> ${purchaseInvoice.supplierId}</div>` : ''}
                            <div style="margin: 2px 0; font-size: 11px;"><strong>Location:</strong> ${supplierLocation}</div>
                            <div style="margin: 2px 0; font-size: 11px;"><strong>Phone:</strong> ${supplierPhone}</div>
                            <div style="margin: 2px 0; font-size: 11px;"><strong>VAT:</strong> ${supplierVat}</div>
                        </div>
                        <div style="border: 2px solid #000; padding: 15px; font-size: 11px; background: #fafafa;">
                            <div style="font-weight: bold; border-bottom: 2px solid #000; padding-bottom: 8px; margin-bottom: 12px; font-size: 13px; text-transform: uppercase; letter-spacing: 1px;">Our Company</div>
                            <div style="font-weight: bold; font-size: 12px; margin: 5px 0 3px 0;">${db.config.name}</div>
                            <div style="margin: 2px 0; font-size: 11px;">${db.config.address || '-'}</div>
                            <div style="margin: 2px 0; font-size: 11px;">${db.config.phone || '-'}</div>
                            <div style="margin: 2px 0; font-size: 11px;"><strong>VAT:</strong> ${db.config.taxId || '-'}</div>
                        </div>
                    </div>

                    <!-- Items Table -->
                    <div style="margin: 25px 0; border: 2px solid #000; box-shadow: inset 0 0 0 1px #000;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px; background: white;">
                            <thead>
                                <tr style="background: #e8e8e8;">
                                    <th style="padding: 8px; text-align: center; border-right: 1px solid #000; border-bottom: 2px solid #000; font-weight: bold; font-size: 10px; width: 5%;">S.N.</th>
                                    <th style="padding: 8px; text-align: center; border-right: 1px solid #000; border-bottom: 2px solid #000; font-weight: bold; font-size: 10px; width: 25%;">Product Name / Details</th>
                                    <th style="padding: 8px; text-align: center; border-right: 1px solid #000; border-bottom: 2px solid #000; font-weight: bold; font-size: 10px; width: 8%;">Qty</th>
                                    <th style="padding: 8px; text-align: center; border-right: 1px solid #000; border-bottom: 2px solid #000; font-weight: bold; font-size: 10px; width: 12%;">Unit Price</th>
                                    <th style="padding: 8px; text-align: center; border-right: 1px solid #000; border-bottom: 2px solid #000; font-weight: bold; font-size: 10px; width: 12%;">Amount</th>
                                    <th style="padding: 8px; text-align: center; border-right: 1px solid #000; border-bottom: 2px solid #000; font-weight: bold; font-size: 10px; width: 12%;">Batch No.</th>
                                    <th style="padding: 8px; text-align: center; border-right: 1px solid #000; border-bottom: 2px solid #000; font-weight: bold; font-size: 10px; width: 12%;">Expiry</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 2px solid #000; font-weight: bold; font-size: 10px; width: 8%;">VAT</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${(purchaseInvoice.items || []).map((item, idx) => {
                const itemTotal = (item.qty || 0) * (item.unitPrice || 0);
                const itemVatAmount = item.vatStatus === 'exempt' ? 0 : (itemTotal * vatRate / 100);
                const vatDisplay = itemVatAmount > 0 ? db.config.currency + ' ' + itemVatAmount.toFixed(2) : '00';
                return `
                                        <tr style="border-bottom: 1px solid #000;">
                                            <td style="padding: 8px; text-align: center; border-right: 1px solid #000;">${idx + 1}</td>
                                            <td style="padding: 8px; border-right: 1px solid #000;">
                                                <strong>${item.productName || item.name || '-'}</strong><br>
                                                <span style="font-size: 9px; color: #666;">SKU: ${item.sku || 'N/A'}</span>
                                            </td>
                                            <td style="padding: 8px; text-align: center; border-right: 1px solid #000;"><strong>${item.qty || 0}</strong></td>
                                            <td style="padding: 8px; text-align: right; border-right: 1px solid #000;">${db.config.currency} ${(item.unitPrice || 0).toFixed(2)}</td>
                                            <td style="padding: 8px; text-align: right; border-right: 1px solid #000;"><strong>${db.config.currency} ${itemTotal.toFixed(2)}</strong></td>
                                            <td style="padding: 8px; text-align: center; border-right: 1px solid #000;">${item.batch || 'N/A'}</td>
                                            <td style="padding: 8px; text-align: center; border-right: 1px solid #000;">${item.expiry || 'N/A'}</td>
                                            <td style="padding: 8px; text-align: right;"><strong>${vatDisplay}</strong></td>
                                        </tr>
                                    `;
            }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <!-- Summary Section -->
                    <div style="margin-top: 25px; margin-bottom: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 0; border: 2px solid #000; box-shadow: inset 0 0 0 1px #000;">
                        ${(() => {
                    let taxableAmount = 0;
                    (purchaseInvoice.items || []).forEach(item => {
                        if (item.vatStatus !== 'exempt') {
                            taxableAmount += (item.qty || 0) * (item.unitPrice || 0);
                        }
                    });
                    taxableAmount = moneyRound(taxableAmount);
                    let html = '';
                    if (taxableAmount > 0) {
                        html += `
                                    <div style="padding: 8px; border-right: 1px solid #000; border-bottom: 1px solid #000;">
                                        <strong>Taxable Amount:</strong>
                                    </div>
                                    <div style="padding: 8px; border-bottom: 1px solid #000; text-align: right;">
                                        ${db.config.currency} ${taxableAmount.toFixed(2)}
                                    </div>
                                `;
                    }
                    html += `
                                <div style="padding: 8px; border-right: 1px solid #000; border-bottom: 1px solid #000;">
                                    <strong>Subtotal:</strong>
                                </div>
                                <div style="padding: 8px; border-bottom: 1px solid #000; text-align: right;">
                                    ${db.config.currency} ${subtotal.toFixed(2)}
                                </div>
                            `;
                    if (discountPercent > 0) {
                        html += `
                                    <div style="padding: 8px; border-right: 1px solid #000; border-bottom: 1px solid #000;">
                                        <strong>Discount (${discountPercent.toFixed(1)}%):</strong>
                                    </div>
                                    <div style="padding: 8px; border-bottom: 1px solid #000; text-align: right;">
                                        - ${db.config.currency} ${discountAmount.toFixed(2)}
                                    </div>
                                `;
                    }
                    if (vatAfterDiscount > 0) {
                        html += `
                                    <div style="padding: 8px; border-right: 1px solid #000; border-bottom: 1px solid #000;">
                                        <strong>Total VAT (${vatRate}%):</strong>
                                    </div>
                                    <div style="padding: 8px; border-bottom: 1px solid #000; text-align: right;">
                                        ${db.config.currency} ${vatAfterDiscount.toFixed(2)}
                                    </div>
                                `;
                    }
                    html += `
                                <div style="padding: 12px; border-right: 2px solid #000; background: linear-gradient(135deg, #ffeb99 0%, #ffe066 100%); border-bottom: 2px solid #000; font-weight: bold;">
                                    GRAND TOTAL:
                                </div>
                                <div style="padding: 12px; background: linear-gradient(135deg, #ffeb99 0%, #ffe066 100%); text-align: right; border-bottom: 2px solid #000; font-weight: bold; font-size: 13px;">
                                    ${db.config.currency} ${grandTotal.toFixed(2)}
                                </div>
                                <div style="padding: 12px; border-right: 2px solid #000; background: #f0f0f0; border-bottom: 2px solid #000;">
                                    <strong>Amount in Words:</strong>
                                </div>
                                <div style="padding: 12px; background: #f0f0f0; text-align: right; font-style: italic; border-bottom: 2px solid #000; word-wrap: break-word;">
                                    ${numberToWords(Math.floor(grandTotal))} Only
                                </div>
                            `;
                    return html;
                })()}
                    </div>

                    <!-- Notes -->
                    <div style="margin-top: 20px; padding: 12px; border: 2px solid #000; background: #f9f9f9;">
                        <p style="margin: 3px 0; font-size: 11px;"><strong>Payment Method:</strong> ${purchaseInvoice.payType || 'Cash'}</p>
                        <p style="margin: 3px 0; font-size: 11px;"><strong>Notes:</strong> Thank you for your business. All products are quality assured.</p>
                    </div>

                    <!-- Signatures -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 3px solid #000;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; text-align: center; font-size: 11px;">
                        <div style="padding: 15px; border: 2px solid #000; background: white; border-radius: 2px;">
                                <p style="margin: 0 0 35px 0; font-weight: bold; font-size: 12px;">Checked By</p>
                                <p style="margin: 2px 0; font-size: 10px; color: #666;">(Authorized Signatory)</p>
                                <p style="margin: 5px 0 0 0; font-size: 10px; color: #666;">Date: ___________</p>
                            </div>
                            <div style="padding: 15px; border: 2px solid #000; background: white; border-radius: 2px;">
                                <p style="margin: 0 0 35px 0; font-weight: bold; font-size: 12px;">Received By</p>
                                <p style="margin: 2px 0; font-size: 10px; color: #666;">(Store Manager)</p>
                                <p style="margin: 5px 0 0 0; font-size: 10px; color: #666;">Date: ___________</p>
                            </div>
                            <div style="padding: 15px; border: 2px solid #000; background: white; border-radius: 2px;">
                                <p style="margin: 0 0 35px 0; font-weight: bold; font-size: 12px;">Supplier</p>
                                <p style="margin: 2px 0; font-size: 10px; color: #666;">${purchaseInvoice.supplier || 'Supplier Name'}</p>
                                <p style="margin: 5px 0 0 0; font-size: 10px; color: #666;">Date: ___________</p>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="margin-top: 20px; text-align: center; font-size: 10px; border-top: 2px solid #000; padding-top: 15px;">
                        <p style="margin: 3px 0;">This is a Computer Generated Purchase Invoice. No signature required.</p>
                        <p style="margin: 3px 0;">Generated by KARTA Business OS</p>
                    </div>
                    </div>
                </div>
            `;
        };

        // --- Purchase Invoice Printing (Matches POS Terminal Invoice Style) ---
        window.printPurchaseInvoice = function (purchaseInvoice) {
            try {
                // Get supplier details
                const supplier = db.suppliers.find(s => s.id === purchaseInvoice.supplierId) || {};
                const supplierPhone = supplier.phone || supplier.contact || '-';
                const supplierLocation = supplier.location || supplier.address || '-';
                const supplierVat = supplier.taxId || supplier.vat || '-';

                const vatRate = db.config.vatRate || 13;

                // Use stored totals from purchaseInvoice object
                let subtotal = purchaseInvoice.subtotal || 0;
                let discountAmount = purchaseInvoice.discount || 0;
                let discountPercent = purchaseInvoice.discountPercent || 0;

                // Calculate VAT from items if not stored
                let totalTax = purchaseInvoice.totalVAT || 0;
                if (totalTax === 0 && purchaseInvoice.items && purchaseInvoice.items.length > 0) {
                    purchaseInvoice.items.forEach(item => {
                        const itemTotal = (item.qty || 0) * (item.unitPrice || 0);
                        if (item.vatStatus !== 'exempt') {
                            totalTax += itemTotal * vatRate / 100;
                        }
                    });
                    totalTax = moneyRound(totalTax);
                }

                // If subtotal is 0 but items exist, calculate it
                if (subtotal === 0 && purchaseInvoice.items && purchaseInvoice.items.length > 0) {
                    purchaseInvoice.items.forEach(item => {
                        subtotal += (item.qty || 0) * (item.unitPrice || 0);
                    });
                    subtotal = moneyRound(subtotal);
                }

                // If discount is not stored, calculate it from discount percent
                if (discountPercent > 0 && discountAmount === 0) {
                    discountAmount = moneyRound(subtotal * (discountPercent / 100));
                }

                // Calculate grand total using the stored/calculated discount
                const subtotalAfterDiscount = moneyRound(subtotal - discountAmount);
                const vatAfterDiscount = moneyRound(totalTax * (1 - (discountPercent / 100)));
                const grandTotal = moneyRound(subtotalAfterDiscount + vatAfterDiscount);

                // Generate invoice content using shared function
                const invoiceContent = generatePurchaseInvoiceHTML(purchaseInvoice, supplier, supplierPhone, supplierLocation, supplierVat, vatRate, subtotal, discountAmount, discountPercent, totalTax, subtotalAfterDiscount, vatAfterDiscount, grandTotal);

                // Create wrapper to detect and update title for returns
                let finalHTML = invoiceContent;
                if (purchaseInvoice.isReturn) {
                    finalHTML = invoiceContent.replace('<h2 id="purchInvTitle"', '<h2 id="purchInvTitle" style="color: red;"');
                    finalHTML = finalHTML.replace('>PURCHASE</h2>', '>PURCHASE RETURN</h2>');
                }

                const invoiceHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Purchase Invoice #${purchaseInvoice.ref || purchaseInvoice.id}</title>
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            html, body { 
                                font-family: Arial, sans-serif; 
                                color: #000; 
                                background: white; 
                                padding: 0;
                                margin: 0;
                            }
                            body { padding: 20px; }
                        </style>
                    </head>
                    <body>
                        ${finalHTML}
                    </body>
                    </html>
                `;

                // Open print dialog
                const printWindow = window.open('', '', 'width=1000,height=1200');

                if (!printWindow) {
                    alert('Please disable popup blocker and try again.');
                    return;
                }

                printWindow.document.write(invoiceHTML);
                printWindow.document.close();

                setTimeout(() => {
                    printWindow.print();
                }, 500);
            } catch (err) {
                console.error('Error printing purchase invoice:', err);
                alert('Error printing invoice. Please check the console for details.');
            }
        };

        // --- Print Purchase from Report ---
        window.printPurchaseFromReport = function (transaction) {
            try {
                // Reconstruct purchase invoice object from transaction data
                const supplier = db.suppliers.find(s => s.id === transaction.entityId);
                const supplierName = supplier ? supplier.name : transaction.entityName;

                const purchaseInvoice = {
                    id: transaction.id,
                    ref: transaction.ref || transaction.id.toString().slice(-6),
                    supplierInvoiceNumber: transaction.supplierInvoiceNumber || null,
                    date: transaction.purchaseDate || transaction.date,
                    supplier: supplierName,
                    supplierId: transaction.entityId,
                    items: transaction.items || [],
                    totalAmount: transaction.total,
                    paymentMethod: transaction.payType,
                    cashAmount: transaction.cashAmount || (transaction.payType === 'cash' ? transaction.total : 0),
                    bankAmount: transaction.bankAmount || (transaction.payType === 'bank' ? transaction.total : 0),
                    creditAmount: transaction.creditAmount || (transaction.payType === 'credit' ? transaction.total : 0)
                };

                // Call the existing print function with reconstructed invoice object
                printPurchaseInvoice(purchaseInvoice);
            } catch (err) {
                console.error('Error printing purchase from report:', err);
                alert('Error printing invoice. Please check the console for details.');
            }
        };

        // --- Report Printing ---
        window.printReport = function () {
            // GENERATE MINIMAL & ATTRACTIVE REPORT
            let logoHtml = '';
            if (db.config.logo) {
                logoHtml = `<img src="${db.config.logo}" style="width: 80px; height: 80px; object-fit: contain; margin: 0 auto 15px;">`;
            }

            let html = `
                <div style="text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #ddd;">
                    ${logoHtml}
                    <h1 style="font-size: 22px; font-weight: 700; margin: 0; color: #222;">${db.config.name}</h1>
                    <p style="margin: 5px 0 0 0; font-size: 11px; color: #999;">${db.config.address} • ${db.config.phone}</p>
                    <p style="margin: 2px 0 0 0; font-size: 10px; color: #bbb;">VAT ID: ${db.config.taxId || 'N/A'}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h2 style="font-size: 16px; font-weight: 600; margin: 0 0 5px 0; color: #222;">${currentReportTitle}</h2>
                    <p style="font-size: 10px; color: #999; margin: 0;">${window.formatDate(new Date().toISOString())} • ${currentReportData.length} records</p>
                </div>
            `;

            // Table Construction
            if (currentReportTitle.includes("Financial Statements") || currentReportTitle.includes("Balance Sheet")) {
                currentReportTitle = "Financial Statements (Balance Sheet & P&L)";

                // --- PROFIT & LOSS CALCULATIONS (Re-calculated for Print) ---
                const sales = db.transactions.filter(t => t.type === 'sale').reduce((a, c) => a + c.total, 0);

                let cogs = 0;
                db.transactions.filter(t => t.type === 'sale').forEach(t => {
                    const isReturn = t.isReturn;
                    t.items.forEach(i => {
                        const itemCost = i.cost !== undefined ? i.cost : (db.products.find(x => x.name === i.name)?.cost || 0);
                        const costTotal = moneyRound(itemCost * (i.qty || 1));

                        // Sync with runReports logic: Reduce COGS for returns
                        if (isReturn) {
                            cogs -= costTotal;
                        } else {
                            cogs += costTotal;
                        }
                    });
                });

                const grossProfit = moneyRound(sales - Math.abs(cogs));
                const expenses = db.transactions.filter(t => t.type === 'expense').reduce((a, c) => a + c.total, 0);
                const netProfit = moneyRound(grossProfit - expenses);

                // --- BALANCE SHEET CALCULATIONS ---
                const stockVal = db.products.reduce((a, c) => a + (c.stock * c.cost), 0);
                const receivables = db.customers.reduce((a, c) => a + c.balance, 0);
                const payables = db.suppliers.reduce((a, c) => a + c.balance, 0);

                const cashBalance = moneyRound(db.config.cashBalance || 0);
                const bankBalance = moneyRound(db.config.bankBalance || 0);
                const totalLiquidAssets = moneyRound(cashBalance + bankBalance);

                // Calculate Fixed Assets
                const fixedAssets = (db.assets || []).reduce((a, c) => a + c.cost, 0);

                const assets = moneyRound(stockVal + receivables + totalLiquidAssets + fixedAssets);
                const equity = moneyRound(assets - payables);

                // Calculate Fiscal Year (Approximate)
                const today = new Date();
                const currentMonth = today.getMonth() + 1; // 1-12
                const currentYear = today.getFullYear();
                const nepaliYear = currentYear + 57; // Rough conversion
                const fiscalYear = currentMonth > 3 ? `${nepaliYear}/${(nepaliYear + 1).toString().slice(-3)}` : `${nepaliYear - 1}/${nepaliYear.toString().slice(-3)}`;

                // --- STANDARD NEPALI FORM LAYOUT ---
                html = `
                    <div style="font-family: 'Times New Roman', serif; padding: 40px; max-width: 800px; margin: 0 auto; line-height: 1.4;">
                        
                        <!-- Header -->
                        <div style="text-align: center; margin-bottom: 30px;">
                            ${db.config.logo ? `<img src="${db.config.logo}" style="width: 80px; height: auto; margin-bottom: 10px;">` : ''}
                            <h1 style="font-size: 24px; font-weight: bold; text-transform: uppercase; margin: 0;">${db.config.name}</h1>
                            <p style="margin: 5px 0 0 0; font-size: 14px;">${db.config.address}</p>
                            <p style="margin: 2px 0 0 0; font-size: 14px;">PAN/VAT: <b>${db.config.taxId || 'N/A'}</b></p>
                            <div style="margin-top: 15px; border-top: 2px solid #000; border-bottom: 2px solid #000; padding: 8px 0;">
                                <h2 style="font-size: 18px; font-weight: bold; margin: 0;">FINANCIAL STATEMENTS</h2>
                                <p style="margin: 5px 0 0 0; font-size: 14px;">Fiscal Year: <b>2081/082</b></p>
                                <p style="margin: 2px 0 0 0; font-size: 12px; font-style: italic;">As of ${window.formatDate ? window.formatDate(new Date().toISOString()) : new Date().toLocaleDateString()}</p>
                            </div>
                        </div>

                        <!-- 1. PROFIT & LOSS STATEMENT -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="font-size: 16px; font-weight: bold; text-decoration: underline; margin-bottom: 10px;">I. PROFIT & LOSS STATEMENT</h3>
                            <table style="width: 100%; border-collapse: collapse; font-size: 14px; border: 1px solid #000;">
                                <thead>
                                    <tr style="background-color: #f0f0f0;">
                                        <th style="border: 1px solid #000; padding: 8px; text-align: left;">PARTICULARS</th>
                                        <th style="border: 1px solid #000; padding: 8px; text-align: right; width: 150px;">AMOUNT (${db.config.currency})</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="border: 1px solid #000; padding: 8px;">Sales Revenue</td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">${sales.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #000; padding: 8px;">Less: Cost of Goods Sold</td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">(${Math.abs(cogs).toFixed(2)})</td>
                                    </tr>
                                    <tr style="font-weight: bold; background-color: #fafafa;">
                                        <td style="border: 1px solid #000; padding: 8px;">GROSS PROFIT</td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">${grossProfit.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #000; padding: 8px;">Less: Operating Expenses</td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">(${expenses.toFixed(2)})</td>
                                    </tr>
                                    <tr style="font-weight: bold; background-color: #e8e8e8;">
                                        <td style="border: 1px solid #000; padding: 8px;">NET PROFIT / (LOSS)</td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">${netProfit.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- 2. BALANCE SHEET -->
                        <div style="margin-bottom: 40px;">
                            <h3 style="font-size: 16px; font-weight: bold; text-decoration: underline; margin-bottom: 10px;">II. BALANCE SHEET</h3>
                            <table style="width: 100%; border-collapse: collapse; font-size: 14px; border: 1px solid #000;">
                                <thead>
                                    <tr style="background-color: #f0f0f0;">
                                        <th style="border: 1px solid #000; padding: 8px; text-align: left;">CAPITAL & LIABILITIES</th>
                                        <th style="border: 1px solid #000; padding: 8px; text-align: right; width: 150px;">AMOUNT (${db.config.currency})</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">Owners Equity</td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">${equity.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #000; padding: 8px;">Accounts Payable (Creditors)</td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">${payables.toFixed(2)}</td>
                                    </tr>
                                    <tr style="font-weight: bold; background-color: #e8e8e8;">
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">TOTAL CAPITAL & LIABILITIES</td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">${(equity + payables).toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <br>

                            <table style="width: 100%; border-collapse: collapse; font-size: 14px; border: 1px solid #000;">
                                <thead>
                                    <tr style="background-color: #f0f0f0;">
                                        <th style="border: 1px solid #000; padding: 8px; text-align: left;">ASSETS</th>
                                        <th style="border: 1px solid #000; padding: 8px; text-align: right; width: 150px;">AMOUNT (${db.config.currency})</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${fixedAssets > 0 ? `
                                    <tr>
                                        <td style="border: 1px solid #000; padding: 8px;">Fixed Assets</td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">${fixedAssets.toFixed(2)}</td>
                                    </tr>` : ''}
                                    <tr>
                                        <td style="border: 1px solid #000; padding: 8px;">Closing Stock</td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">${stockVal.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #000; padding: 8px;">Accounts Receivable (Debtors)</td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">${receivables.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #000; padding: 8px;">Cash on Hand</td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">${cashBalance.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #000; padding: 8px;">Bank Balance</td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">${bankBalance.toFixed(2)}</td>
                                    </tr>
                                    <tr style="font-weight: bold; background-color: #e8e8e8;">
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">TOTAL ASSETS</td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">${assets.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Footer Signatures -->
                        <div style="margin-top: 80px; display: flex; justify-content: space-between; font-size: 14px;">
                            <div style="text-align: center; border-top: 1px solid #000; width: 200px; padding-top: 10px;">
                                <b>Prepared By</b><br>
                                (Accountant)
                            </div>
                             <div style="text-align: center; border-top: 1px solid #000; width: 200px; padding-top: 10px;">
                                <b>Approved By</b><br>
                                (Proprietor/Manager)
                            </div>
                        </div>

                        <div style="margin-top: 40px; text-align: center; font-size: 10px; color: #666; border-top: 1px solid #ccc; padding-top: 10px;">
                            <p>Generated by KARTA Business System • ${new Date().toLocaleString()}</p>
                        </div>
                    </div>
                `;
            } else {
                // Standard reports
                html += `<table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                    <thead>
                        <tr style="border-bottom: 1px solid #ddd; font-weight: 600; color: #666;">`;

                if (currentReportTitle.includes("VAT")) {
                    html += `<th style="padding: 8px; text-align: left;">Date</th>
                             <th style="padding: 8px; text-align: left;">Invoice</th>
                             <th style="padding: 8px; text-align: right;">Taxable</th>
                             <th style="padding: 8px; text-align: right; color: #00c853;">VAT</th>
                             <th style="padding: 8px; text-align: right;">Total</th></tr></thead><tbody>`;
                    currentReportData.forEach(t => {
                        html += `<tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 8px;">${new Date(t.date).toLocaleDateString()}</td>
                            <td style="padding: 8px;">#${t.id.toString().slice(-6)}</td>
                            <td style="padding: 8px; text-align: right;">${db.config.currency}${(t.sub || 0).toFixed(2)}</td>
                            <td style="padding: 8px; text-align: right; color: #00c853; font-weight: 500;">${db.config.currency}${(t.tax || 0).toFixed(2)}</td>
                            <td style="padding: 8px; text-align: right;">${db.config.currency}${t.total.toFixed(2)}</td>
                       </tr>`;
                    });
                } else if (currentReportTitle.includes("DEBTOR")) {
                    // DEBTORS REPORT - Different table structure
                    // Filter debtors by location (area) if search field has value
                    const searchLocation = document.getElementById('debtorLocationSearch')?.value.toLowerCase() || '';
                    let filteredDebtors = currentReportData;

                    if (searchLocation) {
                        filteredDebtors = currentReportData.filter(d =>
                            (d.address || '').toLowerCase().includes(searchLocation)
                        );
                    }

                    html += `<th style="padding: 8px; text-align: left;">Customer Name</th>
                             <th style="padding: 8px; text-align: left;">Location</th>
                             <th style="padding: 8px; text-align: left;">Phone</th>
                             <th style="padding: 8px; text-align: right;">Amount Due</th></tr></thead><tbody>`;

                    filteredDebtors.forEach(debtor => {
                        const balance = (debtor && debtor.balance !== undefined) ? debtor.balance : 0;
                        html += `<tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 8px; font-weight: 500;">${debtor.name}</td>
                            <td style="padding: 8px; color: #666;">${debtor.address || 'N/A'}</td>
                            <td style="padding: 8px; color: #666;">${debtor.phone}</td>
                            <td style="padding: 8px; text-align: right; font-weight: 500; color: #d32f2f;">${db.config.currency}${balance.toFixed(2)}</td>
                       </tr>`;
                    });

                    // Update total to only include filtered debtors
                    currentReportData = filteredDebtors;
                } else if (currentReportTitle.includes("PURCHASE")) {
                    // PURCHASE REPORT WITH DETAILED INVOICE FORMAT
                    html += `<th style="padding: 8px; text-align: left;">Date</th>
                             <th style="padding: 8px; text-align: left;">GRN #</th>
                             <th style="padding: 8px; text-align: left;">Supplier</th>
                             <th style="padding: 8px; text-align: left;">Product Name</th>
                             <th style="padding: 8px; text-align: center;">Qty</th>
                             <th style="padding: 8px; text-align: right;">Unit Price</th>
                             <th style="padding: 8px; text-align: right;">Line Total</th>
                             <th style="padding: 8px; text-align: center;">VAT</th>
                             <th style="padding: 8px; text-align: right;">Invoice Total</th>
                             <th style="padding: 8px; text-align: center;">Payment</th></tr></thead><tbody>`;

                    if (currentReportData && currentReportData.length > 0) {
                        currentReportData.forEach(t => {
                            if (t.items && t.items.length > 0) {
                                let firstRow = true;
                                t.items.forEach((item, idx) => {
                                    const itemCost = item.unitPrice || item.cost || 0;
                                    const itemQty = item.qty || 1;
                                    const lineTotal = moneyRound(itemQty * itemCost);
                                    const vatStatus = item.vatStatus || 'vat';
                                    const vatBg = vatStatus === 'exempt' ? '#ffe5e5' : '#e5f7e5';
                                    const vatColor = vatStatus === 'exempt' ? '#cc0000' : '#00aa00';
                                    const vatLabel = vatStatus === 'exempt' ? 'EXEMPT' : 'VAT';

                                    if (firstRow) {
                                        html += `<tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 8px; font-size: 10px;">${window.formatDate(t.date)}</td>
                                            <td style="padding: 8px; font-weight: 600; color: #0066cc;">#${t.id.toString().slice(-6)}</td>
                                            <td style="padding: 8px; font-weight: 500;">${t.entityName || '-'}</td>
                                            <td style="padding: 8px; color: #333;">${item.productName || item.name || '-'}</td>
                                            <td style="padding: 8px; text-align: center; font-weight: 500;">${itemQty}</td>
                                            <td style="padding: 8px; text-align: right; font-weight: 500;">${db.config.currency}${itemCost.toFixed(2)}</td>
                                            <td style="padding: 8px; text-align: right; color: #00aa00; font-weight: 600;">${db.config.currency}${lineTotal.toFixed(2)}</td>
                                            <td style="padding: 8px; text-align: center; background-color: ${vatBg}; border-radius: 3px; font-weight: 600; color: ${vatColor}; font-size: 9px;">${vatLabel}</td>
                                            <td style="padding: 8px; text-align: right; font-weight: 700; color: #0066cc; font-size: 11px;">${db.config.currency}${t.total.toFixed(2)}</td>
                                            <td style="padding: 8px; text-align: center; font-size: 10px; font-weight: 500; background-color: ${t.payType === 'credit' ? '#fff4e5' : '#e5f9e5'}; color: ${t.payType === 'credit' ? '#ff6600' : '#00aa00'}; border-radius: 3px;">${t.payType ? t.payType.toUpperCase() : 'CASH'}</td>
                                        </tr>`;
                                        firstRow = false;
                                    } else {
                                        html += `<tr style="border-bottom: 1px solid #f0f0f0; background-color: #fafafa;">
                                            <td colspan="2"></td>
                                            <td></td>
                                            <td style="padding: 8px; color: #333;">${item.productName || item.name || '-'}</td>
                                            <td style="padding: 8px; text-align: center; font-weight: 500;">${itemQty}</td>
                                            <td style="padding: 8px; text-align: right; font-weight: 500;">${db.config.currency}${itemCost.toFixed(2)}</td>
                                            <td style="padding: 8px; text-align: right; color: #00aa00; font-weight: 600;">${db.config.currency}${lineTotal.toFixed(2)}</td>
                                            <td style="padding: 8px; text-align: center; background-color: ${vatBg}; border-radius: 3px; font-weight: 600; color: ${vatColor}; font-size: 9px;">${vatLabel}</td>
                                            <td colspan="2"></td>
                                        </tr>`;
                                    }
                                });
                            } else {
                                html += `<tr style="border-bottom: 1px solid #f0f0f0;">
                                    <td style="padding: 8px; font-size: 10px;">${new Date(t.date).toLocaleDateString()}</td>
                                    <td style="padding: 8px; font-weight: 600; color: #0066cc;">#${t.id.toString().slice(-6)}</td>
                                    <td style="padding: 8px; font-weight: 500;">${t.entityName || '-'}</td>
                                    <td colspan="4" style="padding: 8px; color: #999;">-</td>
                                    <td style="padding: 8px; text-align: center; background-color: #f0f0f0; font-size: 9px; color: #999;">-</td>
                                    <td style="padding: 8px; text-align: right; font-weight: 700; color: #0066cc; font-size: 11px;">${db.config.currency}${t.total.toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: center; font-size: 10px; font-weight: 500; background-color: ${t.payType === 'credit' ? '#fff4e5' : '#e5f9e5'}; color: ${t.payType === 'credit' ? '#ff6600' : '#00aa00'}; border-radius: 3px;">${t.payType ? t.payType.toUpperCase() : 'CASH'}</td>
                                </tr>`;
                            }
                        });
                    } else {
                        html += `<tr><td colspan="10" style="padding: 15px; text-align: center; color: #999;">No purchase records found for the selected date range</td></tr>`;
                    }
                } else if (currentReportTitle.includes("Journal Book")) {
                    // --- JOURNAL BOOK PRINT ---
                    html += `<th style="padding: 8px; text-align: left;">Date</th>
                              <th style="padding: 8px; text-align: left;">Particulars</th>
                              <th style="padding: 8px; text-align: center;">L.F.</th>
                              <th style="padding: 8px; text-align: right;">Debit (${db.config.currency})</th>
                              <th style="padding: 8px; text-align: right;">Credit (${db.config.currency})</th></tr></thead><tbody>`;

                    let totalDr = 0;
                    let totalCr = 0;

                    // Filter and sort should already be done in 'currentReportData' from runReports
                    if (currentReportData && currentReportData.length > 0) {
                        currentReportData.forEach(txn => {
                            let drAccount = '';
                            let crAccount = '';
                            let amount = 0;
                            let narration = '';
                            let showEntry = false;

                            // Same mapping logic as View
                            if (txn.type === 'sale') {
                                showEntry = true;
                                amount = txn.total;
                                const entity = txn.entityName || 'Walk-in Customer';
                                narration = `Being goods sold to ${entity} (Inv #${txn.id})`;
                                crAccount = 'Sales A/c';
                                if (txn.payType === 'credit') drAccount = `${entity} (Debtor)`;
                                else if (txn.payType === 'bank') drAccount = 'Bank A/c';
                                else if (txn.payType === 'cash') drAccount = 'Cash A/c';
                                else if (txn.payType === 'split') drAccount = 'Cash/Bank (Split)';
                                else drAccount = 'Cash A/c';
                            }
                            else if (txn.type === 'purchase') {
                                showEntry = true;
                                amount = txn.total;
                                const entity = txn.entityName || 'Supplier';
                                narration = `Being goods purchased from ${entity} (Ref #${txn.ref || txn.id})`;
                                drAccount = 'Purchase A/c';
                                if (txn.payType === 'credit') crAccount = `${entity} (Creditor)`;
                                else if (txn.payType === 'bank') crAccount = 'Bank A/c';
                                else crAccount = 'Cash A/c';
                            }
                            else if (txn.type === 'expense') {
                                showEntry = true;
                                amount = txn.total;
                                narration = `Being expenses paid for ${txn.entityName || txn.category || 'General'}`;
                                drAccount = 'Expense A/c';
                                crAccount = 'Cash A/c';
                            }
                            else if (txn.type === 'payment') {
                                showEntry = true;
                                amount = txn.total;
                                narration = `Being payment received from ${txn.entityName}`;
                                drAccount = 'Cash A/c';
                                crAccount = `${txn.entityName} (Debtor)`;
                            }
                            else if (txn.type === 'payment_out') {
                                showEntry = true;
                                amount = txn.total;
                                narration = `Being payment made to ${txn.entityName}`;
                                drAccount = `${txn.entityName} (Creditor)`;
                                crAccount = 'Cash A/c';
                            }
                            else if (txn.type === 'return_cash_out' || (txn.type === 'sale' && txn.isReturn)) {
                                showEntry = true;
                                amount = Math.abs(txn.total);
                                const entity = txn.entityName || 'Customer';
                                narration = `Being goods returned by ${entity} (Inv #${txn.ref || txn.id})`;
                                drAccount = 'Sales Return A/c';
                                crAccount = 'Cash A/c';
                            }

                            if (showEntry) {
                                totalDr += amount;
                                totalCr += amount;
                                html += `<tr style="border-bottom: 1px solid #f0f0f0;">
                                    <td style="padding: 8px;">${window.formatDate(txn.date)}</td>
                                    <td style="padding: 8px;">
                                        <b>${drAccount} Dr.</b><br>
                                        <span style="padding-left: 20px;">To ${crAccount}</span><br>
                                        <span style="font-size: 10px; font-style: italic;">(${narration})</span>
                                    </td>
                                    <td style="padding: 8px; text-align: center;">-</td>
                                    <td style="padding: 8px; text-align: right;">${moneyRound(amount).toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: right;"></td>
                                </tr>`;
                                html += `<tr style="border-bottom: 1px solid #ddd;">
                                    <td colspan="3"></td>
                                    <td style="padding: 8px; text-align: right;"></td>
                                    <td style="padding: 8px; text-align: right;">${moneyRound(amount).toFixed(2)}</td>
                                </tr>`;
                            }
                        });

                        // Total Row
                        html += `<tr style="font-weight: bold; background-color: #eee;">
                            <td colspan="3" style="padding: 8px; text-align: right; text-transform: uppercase;">Total</td>
                            <td style="padding: 8px; text-align: right;">${moneyRound(totalDr).toFixed(2)}</td>
                            <td style="padding: 8px; text-align: right;">${moneyRound(totalCr).toFixed(2)}</td>
                         </tr>`;
                    } else {
                        html += `<tr><td colspan="5" style="padding: 20px; text-align: center;">No transactions found.</td></tr>`;
                    }

                } else if (currentReportTitle.includes("General Ledger")) {
                    // --- GENERAL LEDGER PRINT ---
                    const selectedAccount = document.getElementById('ledgerAccountSelect')?.value || 'Unknown Account';

                    html += `<tr style="background: #eee;"><td colspan="6" style="padding: 10px; font-size: 14px; font-weight: bold; text-align: center;">Account: ${selectedAccount}</td></tr>`;
                    html += `<tr style="border-bottom: 1px solid #000; font-weight: 600;">
                              <th style="padding: 8px; text-align: left;">Date</th>
                              <th style="padding: 8px; text-align: left;">Particulars</th>
                              <th style="padding: 8px; text-align: center;">J.F.</th>
                              <th style="padding: 8px; text-align: right;">Debit</th>
                              <th style="padding: 8px; text-align: right;">Credit</th>
                              <th style="padding: 8px; text-align: right;">Balance</th></tr></thead><tbody>`;

                    let balance = 0;
                    let totalDr = 0;
                    let totalCr = 0;
                    let hasData = false;

                    if (currentReportData && currentReportData.length > 0) {
                        currentReportData.forEach(txn => {
                            let dr = 0;
                            let cr = 0;
                            let particular = '';
                            let isRelevant = false;

                            // Re-use Logic from View for filtering relevant txns
                            if (selectedAccount === 'Cash A/c') {
                                if (txn.payType === 'cash' || txn.cashAmount > 0) {
                                    const amt = (txn.payType === 'split' ? txn.cashAmount : txn.total);
                                    if (txn.type === 'sale') { dr = amt; particular = `To Sales (Inv #${txn.id})`; isRelevant = true; }
                                    if (txn.type === 'expense') { cr = amt; particular = `By Expense (${txn.category || 'General'})`; isRelevant = true; }
                                    if (txn.type === 'purchase') { cr = amt; particular = `By Purchase (Inv #${txn.ref || txn.id})`; isRelevant = true; }
                                    if (txn.type === 'payment') { dr = amt; particular = `To Customer Payment (${txn.entityName})`; isRelevant = true; }
                                    if (txn.type === 'payment_out') { cr = amt; particular = `By Supplier Payment (${txn.entityName})`; isRelevant = true; }
                                }
                            } else if (selectedAccount === 'Sales A/c') {
                                if (txn.type === 'sale') { cr = txn.total; particular = `By ${txn.payType === 'credit' ? 'Debtors' : 'Cash/Bank'}`; isRelevant = true; }
                                if (txn.type === 'return_cash_out' || (txn.type === 'sale' && txn.isReturn)) { dr = txn.total; particular = `To Return In`; isRelevant = true; }
                            } else if (selectedAccount === 'Purchase A/c') {
                                if (txn.type === 'purchase') { dr = txn.total; particular = `To ${txn.payType === 'credit' ? 'Creditors' : 'Cash/Bank'}`; isRelevant = true; }
                            } else if (selectedAccount === 'Expense A/c') {
                                if (txn.type === 'expense') { dr = txn.total; particular = `To Cash/Bank`; isRelevant = true; }
                            } else if (selectedAccount === 'Bank A/c') {
                                if (txn.payType === 'bank' || txn.bankAmount > 0) {
                                    const amt = (txn.payType === 'split' ? txn.bankAmount : txn.total);
                                    if (txn.type === 'sale') { dr = amt; particular = `To Sales (Inv #${txn.id})`; isRelevant = true; }
                                    if (txn.type === 'purchase') { cr = amt; particular = `By Purchase (Inv #${txn.ref || txn.id})`; isRelevant = true; }
                                }
                            }

                            if (isRelevant) {
                                balance = balance + dr - cr;
                                totalDr += dr;
                                totalCr += cr;
                                hasData = true;
                                html += `<tr style="border-bottom: 1px solid #f0f0f0;">
                                    <td style="padding: 8px;">${window.formatDate(txn.date)}</td>
                                    <td style="padding: 8px;">${particular}</td>
                                    <td style="padding: 8px; text-align: center;">-</td>
                                    <td style="padding: 8px; text-align: right;">${dr ? moneyRound(dr).toFixed(2) : ''}</td>
                                    <td style="padding: 8px; text-align: right;">${cr ? moneyRound(cr).toFixed(2) : ''}</td>
                                    <td style="padding: 8px; text-align: right; font-weight: bold;">${Math.abs(moneyRound(balance)).toFixed(2)} ${balance >= 0 ? 'Dr' : 'Cr'}</td>
                                </tr>`;
                            }
                        });
                    }

                    if (hasData) {
                        // Add Balance c/d entry before totals to balance both sides
                        const finalBalance = moneyRound(balance);
                        if (finalBalance !== 0) {
                            const absBalance = Math.abs(finalBalance);
                            if (finalBalance > 0) {
                                // Debit balance: add Balance c/d on Credit side
                                html += `<tr style="border-bottom: 1px solid #f0f0f0; background-color: #fffef5;">
                                    <td style="padding: 8px;"></td>
                                    <td style="padding: 8px; font-weight: bold; font-style: italic;">To Balance c/d</td>
                                    <td style="padding: 8px; text-align: center;">-</td>
                                    <td style="padding: 8px; text-align: right;"></td>
                                    <td style="padding: 8px; text-align: right; font-weight: bold; color: #0066cc;">${absBalance.toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: right;"></td>
                                </tr>`;
                                totalCr += absBalance;
                            } else {
                                // Credit balance: add Balance c/d on Debit side
                                html += `<tr style="border-bottom: 1px solid #f0f0f0; background-color: #fffef5;">
                                    <td style="padding: 8px;"></td>
                                    <td style="padding: 8px; font-weight: bold; font-style: italic;">To Balance c/d</td>
                                    <td style="padding: 8px; text-align: center;">-</td>
                                    <td style="padding: 8px; text-align: right; font-weight: bold; color: #0066cc;">${absBalance.toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: right;"></td>
                                    <td style="padding: 8px; text-align: right;"></td>
                                </tr>`;
                                totalDr += absBalance;
                            }
                        }

                        // Total row - now both sides should be equal
                        html += `<tr style="font-weight: bold; background-color: #eee; border-top: 2px solid #000; border-bottom: 2px solid #000;">
                            <td colspan="3" style="padding: 8px; text-align: right; text-transform: uppercase;">Total</td>
                            <td style="padding: 8px; text-align: right;">${moneyRound(totalDr).toFixed(2)}</td>
                            <td style="padding: 8px; text-align: right;">${moneyRound(totalCr).toFixed(2)}</td>
                            <td></td>
                         </tr>`;

                        // Add Balance b/d entry after totals (opening balance for next period)
                        if (finalBalance !== 0) {
                            const absBalance = Math.abs(finalBalance);
                            if (finalBalance > 0) {
                                // Debit balance brought down
                                html += `<tr style="background-color: #f0f9ff; border-top: 1px solid #ccc;">
                                    <td style="padding: 8px;"></td>
                                    <td style="padding: 8px; font-weight: bold; font-style: italic;">By Balance b/d</td>
                                    <td style="padding: 8px; text-align: center;">-</td>
                                    <td style="padding: 8px; text-align: right; font-weight: bold; color: #00aa00;">${absBalance.toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: right;"></td>
                                    <td style="padding: 8px; text-align: right; font-weight: bold;">${absBalance.toFixed(2)} Dr</td>
                                </tr>`;
                            } else {
                                // Credit balance brought down
                                html += `<tr style="background-color: #f0f9ff; border-top: 1px solid #ccc;">
                                    <td style="padding: 8px;"></td>
                                    <td style="padding: 8px; font-weight: bold; font-style: italic;">By Balance b/d</td>
                                    <td style="padding: 8px; text-align: center;">-</td>
                                    <td style="padding: 8px; text-align: right;"></td>
                                    <td style="padding: 8px; text-align: right; font-weight: bold; color: #00aa00;">${absBalance.toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: right; font-weight: bold;">${absBalance.toFixed(2)} Cr</td>
                                </tr>`;
                            }
                        }
                    } else {
                        html += `<tr><td colspan="6" style="padding: 20px; text-align: center;">No transactions found.</td></tr>`;
                    }
                } else if (currentReportTitle.includes("Trial Balance")) {
                    // --- TRIAL BALANCE PRINT ---
                    html += `<th style="padding: 8px; text-align: left;">Account Name</th>
                              <th style="padding: 8px; text-align: right;">Debit (${db.config.currency})</th>
                              <th style="padding: 8px; text-align: right;">Credit (${db.config.currency})</th></tr></thead><tbody>`;

                    let totalDr = 0;
                    let totalCr = 0;

                    if (currentReportData && currentReportData.length > 0) {
                        currentReportData.forEach(acc => {
                            totalDr += acc.debit || 0;
                            totalCr += acc.credit || 0;
                            html += `<tr style="border-bottom: 1px solid #f0f0f0;">
                                <td style="padding: 8px;">${acc.name}</td>
                                <td style="padding: 8px; text-align: right; ${acc.debit > 0 ? 'font-weight: bold; color: #0066cc;' : 'color: #999;'}">${acc.debit > 0 ? moneyRound(acc.debit).toFixed(2) : '-'}</td>
                                <td style="padding: 8px; text-align: right; ${acc.credit > 0 ? 'font-weight: bold; color: #00aa00;' : 'color: #999;'}">${acc.credit > 0 ? moneyRound(acc.credit).toFixed(2) : '-'}</td>
                            </tr>`;
                        });

                        // Total row
                        html += `<tr style="font-weight: bold; background-color: #eee; border-top: 2px solid #000;">
                            <td style="padding: 8px; text-align: right; text-transform: uppercase;">Total</td>
                            <td style="padding: 8px; text-align: right; color: #0066cc;">${moneyRound(totalDr).toFixed(2)}</td>
                            <td style="padding: 8px; text-align: right; color: #00aa00;">${moneyRound(totalCr).toFixed(2)}</td>
                         </tr>`;
                    } else {
                        html += `<tr><td colspan="3" style="padding: 20px; text-align: center;">No accounts found.</td></tr>`;
                    }
                } else {
                    // GENERIC TRANSACTION REPORTS (Daily, Sales, Expense)
                    html += `<th style="padding: 8px; text-align: left;">Date</th>
                             <th style="padding: 8px; text-align: left;">Type</th>
                             <th style="padding: 8px; text-align: left;">Description</th>
                             <th style="padding: 8px; text-align: right;">Amount</th></tr></thead><tbody>`;

                    if (currentReportData && currentReportData.length > 0) {
                        currentReportData.forEach(t => {
                            const typeColor = t.type === 'sale' ? '#0066cc' : (t.type === 'purchase' ? '#ff6600' : (t.type === 'expense' ? '#cc0000' : '#666666'));
                            const description = t.entityName || t.items?.[0]?.name || '-';
                            html += `<tr style="border-bottom: 1px solid #f0f0f0;">
                                <td style="padding: 8px;">${new Date(t.date).toLocaleDateString()}</td>
                                <td style="padding: 8px; text-transform: uppercase; font-weight: 500; font-size: 10px; color: ${typeColor};">${t.type}</td>
                                <td style="padding: 8px; color: #666;">${description}</td>
                                <td style="padding: 8px; text-align: right; font-weight: 500;">${db.config.currency}${t.total.toFixed(2)}</td>
                           </tr>`;
                        });
                    } else {
                        html += `<tr><td colspan="4" style="padding: 15px; text-align: center; color: #999;">No records found for the selected date range</td></tr>`;
                    }
                }

                html += `</tbody></table>`;

                // Summary Footer - Minimal
                let total = 0;
                if (currentReportTitle.includes("DEBTOR")) {
                    total = currentReportData.reduce((a, c) => a + c.balance, 0);
                } else {
                    total = currentReportData.reduce((a, c) => a + c.total, 0);
                }
                let footerHtml = '';

                if (currentReportTitle.includes("VAT")) {
                    const totalVat = currentReportData.reduce((a, c) => a + (c.tax || 0), 0);
                    const totalTaxable = currentReportData.reduce((a, c) => a + (c.sub || 0), 0);
                    footerHtml = `<div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd; text-align: right; font-size: 12px;">
                        <p style="margin: 3px 0; color: #666;">Taxable: <strong>${db.config.currency}${totalTaxable.toFixed(2)}</strong></p>
                        <p style="margin: 3px 0; color: #00c853;">VAT: <strong>${db.config.currency}${totalVat.toFixed(2)}</strong></p>
                        <p style="margin: 5px 0 0 0; font-weight: 700; font-size: 13px;">Total: ${db.config.currency}${total.toFixed(2)}</p>
                    </div>`;
                } else {
                    footerHtml = `<div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd; text-align: right; font-size: 12px; font-weight: 700;">
                        Total: ${db.config.currency}${total.toFixed(2)}
                    </div>`;
                }
                html += footerHtml;
            }

            // Minimal Footer
            html += `<div style="margin-top: 30px; padding-top: 10px; border-top: 1px solid #eee; text-align: center; font-size: 8px; color: #bbb;">
                Generated by KARTA • ${new Date().toLocaleString()}
            </div>`;

            // Wrap the report in a complete HTML document structure
            const reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${currentReportTitle} - ${db.config.name}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        html, body { 
                            font-family: Arial, sans-serif; 
                            color: #000; 
                            background: white; 
                            padding: 0;
                            margin: 0;
                        }
                        body { padding: 20px; }
                    </style>
                </head>
                <body>
                    <div style="font-family: Arial, sans-serif; color: #000; background: white; padding: 0;">
                        ${html}
                    </div>
                </body>
                </html>
            `;

            // Use window.open() and print() pattern (same as purchase invoice) for mobile compatibility
            const printWindow = window.open('', '', 'width=1000,height=1200');

            if (!printWindow) {
                alert('Please disable popup blocker and try again.');
                return;
            }

            printWindow.document.write(reportHTML);
            printWindow.document.close();

            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        // Generate Report as PDF (Mobile-friendly)
        function generateReportPDF(htmlContent) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Convert HTML to text-based layout
                let yPos = 20;
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 14;
                const maxWidth = pageWidth - (2 * margin);

                // Extract text from HTML and add to PDF
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;

                // Add logo if exists
                if (db.config.logo) {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const img = new Image();
                        img.onload = function () {
                            doc.addImage(img, 'JPEG', margin + (maxWidth / 2) - 30, yPos, 60, 60);
                        };
                        img.src = db.config.logo;
                        yPos = 75;
                    } catch (e) { }
                }

                // Title
                doc.setFontSize(14);
                doc.text(db.config.name, pageWidth / 2, yPos, { align: 'center' });
                yPos += 6;

                doc.setFontSize(9);
                doc.text(db.config.address + ' • ' + db.config.phone, pageWidth / 2, yPos, { align: 'center' });
                yPos += 5;
                doc.text('VAT ID: ' + (db.config.taxId || 'N/A'), pageWidth / 2, yPos, { align: 'center' });
                yPos += 10;

                // Report Title
                doc.setFontSize(12);
                doc.text(currentReportTitle, margin, yPos);
                yPos += 6;

                doc.setFontSize(8);
                doc.text(window.formatDate(new Date().toISOString()), margin, yPos);
                yPos += 10;

                // Build table from data
                const tableData = [];
                if (currentReportTitle.includes("VAT")) {
                    tableData.push(['Date', 'Invoice', 'Taxable', 'VAT', 'Total']);
                    currentReportData.forEach(t => {
                        tableData.push([
                            window.formatDate(t.date),
                            '#' + t.id.toString().slice(-6),
                            db.config.currency + (t.sub || 0).toFixed(2),
                            db.config.currency + (t.tax || 0).toFixed(2),
                            db.config.currency + t.total.toFixed(2)
                        ]);
                    });
                } else {
                    tableData.push(['Date', 'Type', 'Reference', 'Amount']);
                    currentReportData.forEach(t => {
                        tableData.push([
                            window.formatDate(t.date),
                            t.type.toUpperCase(),
                            t.entityName || '-',
                            db.config.currency + t.total.toFixed(2)
                        ]);
                    });
                }

                // Add table
                doc.autoTable({
                    startY: yPos,
                    head: [tableData[0]],
                    body: tableData.slice(1),
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [0, 200, 83], textColor: 255 },
                    columnStyles: { 3: { halign: 'right' }, 4: { halign: 'right' } }
                });

                // Footer
                yPos = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(7);
                doc.text('Generated by KARTA System • ' + window.formatDate(new Date().toISOString()), pageWidth / 2, yPos, { align: 'center' });

                // Save
                const filename = `Report_${currentReportTitle.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                alert(`Report saved: ${filename}`);
            } catch (err) {
                console.error('PDF generation failed:', err);
                // Fallback: try to print anyway
                try {
                    window.print();
                } catch (e2) {
                    alert('Print/PDF generation not supported on this device.');
                }
            }
        }


        // --- Settings ---
        // Logo Handling
        document.getElementById('confLogoInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (evt) {
                    tempLogoBase64 = evt.target.result;
                    document.getElementById('confLogoPreview').src = tempLogoBase64;
                    document.getElementById('confLogoPreview').classList.remove('hidden');
                    document.getElementById('confLogoPlaceholder').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        window.clearLogo = function () {
            tempLogoBase64 = ''; // Empty string triggers removal
            document.getElementById('confLogoInput').value = '';
            document.getElementById('confLogoPreview').src = '';
            document.getElementById('confLogoPreview').classList.add('hidden');
            document.getElementById('confLogoPlaceholder').classList.remove('hidden');
        }

        document.getElementById('settingsForm').onsubmit = e => {
            e.preventDefault();
            db.config.businessType = document.getElementById('confBusinessType').value;
            db.config.businessName = document.getElementById('confName').value;
            db.config.name = document.getElementById('confName').value; // Keep for backwards compatibility
            db.config.address = document.getElementById('confAddr').value;
            db.config.phone = document.getElementById('confPhone').value;
            db.config.taxId = document.getElementById('confTax').value;
            db.config.vatRate = parseFloat(document.getElementById('confVatRate').value);
            db.config.currency = document.getElementById('confCurr').value;
            db.config.currency = document.getElementById('confCurr').value;
            // FIX #5: EMPTY REGISTER - Add opening balance
            db.config.initialCash = moneyRound(parseFloat(document.getElementById('confInitialCash').value) || 0);

            // Save Date Mode
            db.config.dateMode = document.getElementById('confDateMode').value;

            // Save Logo if changed
            if (tempLogoBase64 !== null) {
                db.config.logo = tempLogoBase64;
            }

            saveDB();
            alert("✓ Settings Saved!\nBusiness Type: " + db.config.businessType.toUpperCase());
        };

        function loadSettings() {
            document.getElementById('confBusinessType').value = db.config.businessType || 'general';
            document.getElementById('confName').value = db.config.businessName || db.config.name || '';
            document.getElementById('confAddr').value = db.config.address || '';
            document.getElementById('confPhone').value = db.config.phone || '';
            document.getElementById('confTax').value = db.config.taxId || '';
            document.getElementById('confVatRate').value = db.config.vatRate || 13;
            document.getElementById('confCurr').value = db.config.currency || 'Rs.';
            // FIX #5: EMPTY REGISTER - Load opening balance
            document.getElementById('confInitialCash').value = (db.config.initialCash || 0).toFixed(2);

            // Load Date Mode
            document.getElementById('confDateMode').value = db.config.dateMode || 'english';

            // Load Logo
            if (db.config.logo) {
                document.getElementById('confLogoPreview').src = db.config.logo;
                document.getElementById('confLogoPreview').classList.remove('hidden');
                document.getElementById('confLogoPlaceholder').classList.add('hidden');
                tempLogoBase64 = db.config.logo; // Initialize temp to current
            } else {
                clearLogo();
                tempLogoBase64 = null; // Reset temp
            }

            // Load Invoice Settings
            db.config.invoiceStartNumber = db.config.invoiceStartNumber || 1;
            db.config.nextInvoiceNumber = db.config.nextInvoiceNumber || 1;
            db.config.autoInvoiceNumber = db.config.autoInvoiceNumber !== false; // Default true

            document.getElementById('invoiceStartNumber').value = db.config.invoiceStartNumber;
            document.getElementById('currentInvoiceNumber').value = 'INV-' + String(db.config.nextInvoiceNumber).padStart(3, '0');
            document.getElementById('autoInvoiceNumber').checked = db.config.autoInvoiceNumber;
            document.getElementById('nextInvoicePreview').innerText = db.config.nextInvoiceNumber;
        }

        // --- INVOICE NUMBERING FUNCTIONS ---
        window.getNextInvoiceNumber = function () {
            if (!db.config.autoInvoiceNumber) return null;

            const invNum = db.config.nextInvoiceNumber || 1;
            db.config.nextInvoiceNumber = (invNum + 1);

            const invoiceNum = 'INV-' + String(invNum).padStart(3, '0');

            saveDB();

            // Update UI preview
            document.getElementById('nextInvoicePreview').innerText = db.config.nextInvoiceNumber;
            document.getElementById('currentInvoiceNumber').value = invoiceNum;

            return invoiceNum;
        };

        window.resetInvoiceNumbering = function () {
            const startNum = parseInt(document.getElementById('invoiceStartNumber').value) || 1;

            if (confirm(`Reset invoice numbering to start at #${startNum}? This will affect all future invoices.`)) {
                db.config.invoiceStartNumber = startNum;
                db.config.nextInvoiceNumber = startNum;
                db.config.autoInvoiceNumber = document.getElementById('autoInvoiceNumber').checked;
                saveDB();

                document.getElementById('currentInvoiceNumber').value = 'INV-' + String(startNum).padStart(3, '0');
                document.getElementById('nextInvoicePreview').innerText = startNum;

                alert(`✓ Invoice numbering reset! Next invoice will be #${startNum}`);
            }
        };

        window.setAutoInvoiceNumbering = function (enabled) {
            db.config.autoInvoiceNumber = enabled;
            saveDB();
        };

        // Auto-invoice checkbox event listener
        document.addEventListener('DOMContentLoaded', function () {
            const autoCheckbox = document.getElementById('autoInvoiceNumber');
            if (autoCheckbox) {
                autoCheckbox.addEventListener('change', function () {
                    setAutoInvoiceNumbering(this.checked);
                });
            }
        });

        // --- REPAIR BALANCES FUNCTION ---
        window.repairCashAndBankBalances = function () {
            if (!confirm("Recalculate Cash & Bank Balances from the beginning?\\n\\nThis will:\\n1. Reset balances to 'Initial Cash/Bank' settings.\\n2. Replay all transactions to calculate current values.\\n3. Fix any discrepancies.")) return;

            // 1. Reset to Initial
            let runningCash = db.config.initialCash || 0;
            let runningBank = db.config.initialBank || 0;

            console.log("Starting Repair...");
            console.log('Initial: Cash=' + runningCash + ', Bank=' + runningBank);

            // 2. Sort transactions by date (oldest first)
            const sortedTxns = (db.transactions || []).sort((a, b) => new Date(a.date) - new Date(b.date));
            let count = 0;

            sortedTxns.forEach(txn => {
                const amt = parseFloat(txn.total) || 0;

                // --- SALES ---
                if (txn.type === 'sale') {
                    if (txn.payType === 'split') {
                        runningCash += (parseFloat(txn.cashAmount) || parseFloat(txn.splitCash) || 0);
                        runningBank += (parseFloat(txn.bankAmount) || parseFloat(txn.splitBank) || 0);
                    } else if (txn.payType === 'bank') {
                        runningBank += amt;
                    } else if (txn.payType === 'credit') {
                        // Credit sales don't affect liquid cash/bank
                    } else {
                        // Default 'cash'
                        runningCash += amt;
                    }
                }

                // --- PURCHASES ---
                else if (txn.type === 'purchase') {
                    if (txn.payType === 'split') {
                        runningCash -= (parseFloat(txn.cashAmount) || 0);
                        runningBank -= (parseFloat(txn.bankAmount) || 0);
                    } else if (txn.payType === 'bank') {
                        runningBank -= amt;
                    } else if (txn.payType === 'credit') {
                        // Credit purchase doesn't affect liquid cash/bank
                    } else {
                        // Default 'cash'
                        runningCash -= amt;
                    }
                }

                // --- EXPENSES ---
                else if (txn.type === 'expense') {
                    if (txn.payType === 'bank') {
                        runningBank -= amt;
                    } else {
                        runningCash -= amt;
                    }
                }

                // --- CUSTOMER PAYMENTS (Inflow) ---
                else if (txn.type === 'payment') {
                    const method = txn.paymentMethod || txn.payType || 'cash';
                    if (method === 'bank') {
                        runningBank += amt;
                    } else {
                        runningCash += amt;
                    }
                }

                // --- SUPPLIER PAYMENTS (Outflow) ---
                else if (txn.type === 'payment_out') {
                    const method = txn.paymentMethod || txn.payType || 'cash';
                    if (method === 'bank') {
                        runningBank -= amt;
                    } else {
                        runningCash -= amt;
                    }
                }

                // --- ASSET PURCHASES ---
                else if (txn.type === 'asset_purchase') {
                    const method = txn.payType || 'cash';
                    if (method === 'bank') {
                        runningBank -= amt;
                    } else {
                        runningCash -= amt;
                    }
                }

                // --- EXPLICIT CASH RETURNS ---
                else if (txn.type === 'return_cash_out') {
                    runningCash -= Math.abs(amt);
                }

                count++;
            });

            // 3. Update Config
            db.config.cashBalance = moneyRound(runningCash);
            db.config.bankBalance = moneyRound(runningBank);

            console.log('Final: Cash=' + db.config.cashBalance + ', Bank=' + db.config.bankBalance);

            // 4. Save & Refresh
            saveDB();
            refreshUI();
            alert('✓ Balances Repaired Successfully!\\nProcessed ' + count + ' transactions.\\n\\nNew Cash Balance: ' + db.config.currency + db.config.cashBalance.toFixed(2) + '\\nNew Bank Balance: ' + db.config.currency + db.config.bankBalance.toFixed(2));
        };

        // --- Settings Management ---
        window.loadSettings = function () {
            if (!db.config) return;
            document.getElementById('confName').value = db.config.companyName || '';
            document.getElementById('confAddr').value = db.config.address || '';
            document.getElementById('confPhone').value = db.config.phone || '';
            document.getElementById('confTax').value = db.config.taxId || '';
            document.getElementById('confVatRate').value = db.config.vatRate || 13;
            document.getElementById('confCurr').value = db.config.currency || 'Rs ';
            document.getElementById('confInitialCash').value = db.config.initialCash || 0;
            document.getElementById('confInitialBank').value = db.config.initialBank || 0;
            document.getElementById('confDateMode').value = (db.config.dateMode || 'english');
            document.getElementById('confBusinessType').value = (db.config.businessType || 'general');

            // Show Logo if exists
            const logoImg = document.getElementById('confLogoPreview');
            const placeholder = document.getElementById('confLogoPlaceholder');
            if (db.config.logo) {
                logoImg.src = db.config.logo;
                logoImg.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else {
                logoImg.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
        };

        // Settings Form Submission
        const settingsForm = document.getElementById('settingsForm');
        if (settingsForm) {
            settingsForm.addEventListener('submit', function (e) {
                e.preventDefault();

                db.config.companyName = document.getElementById('confName').value;
                db.config.address = document.getElementById('confAddr').value;
                db.config.phone = document.getElementById('confPhone').value;
                db.config.taxId = document.getElementById('confTax').value;
                db.config.vatRate = parseFloat(document.getElementById('confVatRate').value) || 0;
                db.config.currency = document.getElementById('confCurr').value;

                // Handle Opening Balances - Update Config & Re-calculate Current Balances
                const oldInitialCash = db.config.initialCash || 0;
                const newInitialCash = parseFloat(document.getElementById('confInitialCash').value) || 0;
                db.config.initialCash = newInitialCash;

                const oldInitialBank = db.config.initialBank || 0;
                const newInitialBank = parseFloat(document.getElementById('confInitialBank').value) || 0;
                db.config.initialBank = newInitialBank;

                // Adjust current balances by the difference if they exist, else set to initial
                if (db.config.cashBalance === undefined) db.config.cashBalance = newInitialCash;
                else db.config.cashBalance += (newInitialCash - oldInitialCash);

                if (db.config.bankBalance === undefined) db.config.bankBalance = newInitialBank;
                else db.config.bankBalance += (newInitialBank - oldInitialBank);

                db.config.dateMode = document.getElementById('confDateMode').value;
                db.config.businessType = document.getElementById('confBusinessType').value;

                // Handle Logo Upload (if new file selected)
                const logoInput = document.getElementById('confLogoInput');
                if (logoInput.files && logoInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        db.config.logo = e.target.result;
                        saveDB();
                        alert("Settings saved successfully!");
                        loadDashboard(); // Refresh UI
                    };
                    reader.readAsDataURL(logoInput.files[0]);
                } else {
                    saveDB();
                    alert("Settings saved successfully!");
                    loadDashboard(); // Refresh UI
                }

                // Update calendar visibility immediately
                if (window.updateDateModeVisibility) window.updateDateModeVisibility();
            });
        }

        window.clearLogo = function () {
            db.config.logo = null;
            document.getElementById('confLogoInput').value = '';
            if (window.loadSettings) window.loadSettings(); // Refresh view
        };

        // --- Reports Export Logic ---
        window.exportReportCSV = function () {
            if (!currentReportData || !currentReportData.length) {
                alert("No report data to export. Please run a report first.");
                return;
            }

            // Define CSV Header
            const headers = ["Date", "Type", "Entity/Ref", "Amount"];
            const rows = [headers];

            // Add Data Rows
            currentReportData.forEach(t => {
                rows.push([
                    window.formatDate(t.date),
                    t.type,
                    t.entityName || '-',
                    t.total.toFixed(2)
                ]);
            });

            // Convert to CSV String
            const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");

            // Trigger Download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "karta_report_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Reports ---
        window.runReports = function (type) {
            const tbody = document.getElementById('repTable');
            const thead = document.getElementById('repHead');
            const cards = document.getElementById('reportCards');
            tbody.innerHTML = ''; cards.innerHTML = '';

            // Show/hide aging date picker for aging reports
            const agingDateContainer = document.getElementById('agingDateContainer');
            const agingDateInput = document.getElementById('agingAsOfDate');
            if (type === 'aging' || type === 'creditors_aging') {
                agingDateContainer.classList.remove('hidden');
                // Set default to today if not already set
                if (!agingDateInput.value) {
                    agingDateInput.value = new Date().toISOString().split('T')[0];
                }
            } else {
                agingDateContainer.classList.add('hidden');
            }

            // Hide location search filter by default (only show for debtors)
            const debtorFilterContainer = document.getElementById('debtorFilterContainer');
            if (type !== 'debtors') {
                debtorFilterContainer.classList.add('hidden');
            }

            const fromDate = document.getElementById('repFrom').value;
            const toDate = document.getElementById('repTo').value;


            // Get "As of Date" for aging reports (defaults to today)
            let agingAsOfDate = new Date();
            if (agingDateInput && agingDateInput.value && (type === 'aging' || type === 'creditors_aging')) {
                agingAsOfDate = new Date(agingDateInput.value + 'T23:59:59');
            }

            // Filter transactions by date
            // FIX: Ensure transactions exists
            if (!db.transactions) db.transactions = [];

            let filteredTxns = db.transactions.slice().reverse();
            if (fromDate) filteredTxns = filteredTxns.filter(t => t.date.substring(0, 10) >= fromDate);
            if (toDate) filteredTxns = filteredTxns.filter(t => t.date.substring(0, 10) <= toDate);

            // Set Title
            currentReportTitle = type.toUpperCase() + " REPORT";
            document.getElementById('reportTitle').innerText = currentReportTitle;

            // Helper to create card
            const createCard = (title, value, color = 'white') => {
                return `<div class="bg-karta-surface border border-karta-border p-6 rounded-lg"><h4 class="text-gray-400 text-xs uppercase">${title}</h4><h2 class="text-2xl font-bold text-${color} mt-2">${db.config.currency}${value.toFixed(2)}</h2></div>`;
            };

            if (type === 'trading') {
                currentReportData = [];
                const sales = filteredTxns.filter(t => t.type === 'sale').reduce((a, c) => a + c.total, 0);
                const purchases = filteredTxns.filter(t => t.type === 'purchase').reduce((a, c) => a + c.total, 0);

                // FIX #6: Use STORED cost from transaction items, not current product cost
                let cogs = 0;
                filteredTxns.filter(t => t.type === 'sale').forEach(t => {
                    const isReturn = t.isReturn;
                    t.items.forEach(i => {
                        // Use stored cost if available, otherwise fallback to current product cost
                        const itemCost = i.cost !== undefined ? i.cost : (db.products.find(x => x.name === i.name)?.cost || 0);
                        const costTotal = moneyRound(itemCost * (i.qty || 1));

                        // If return, REDUCE COGS. If sale, INCREASE COGS.
                        if (isReturn) {
                            cogs -= costTotal;
                        } else {
                            cogs += costTotal;
                        }
                    });
                });
                const grossProfit = moneyRound(sales - cogs);
                cards.innerHTML += createCard('Total Sales (Net)', sales, 'green-400');
                cards.innerHTML += createCard('COGS', Math.abs(cogs), 'red-400');
                cards.innerHTML += createCard('Gross Profit', grossProfit, 'karta-primary');
                thead.innerHTML = `<tr><th class="p-3">Metric</th><th class="p-3 text-right">Amount</th></tr>`;
                tbody.innerHTML += `<tr><td class="p-3">Sales Revenue (Net of Returns)</td><td class="p-3 text-right">${db.config.currency}${sales.toFixed(2)}</td></tr>`;
                tbody.innerHTML += `<tr><td class="p-3">Less: Cost of Goods Sold</td><td class="p-3 text-right text-red-400">(${db.config.currency}${Math.abs(cogs).toFixed(2)})</td></tr>`;
                tbody.innerHTML += `<tr class="font-bold border-t border-gray-700"><td class="p-3">Gross Profit</td><td class="p-3 text-right text-karta-primary">${db.config.currency}${grossProfit.toFixed(2)}</td></tr>`;
                return;
            }

            if (type === 'balance') {
                currentReportData = [];
                currentReportTitle = "Financial Statements (Balance Sheet & P&L)";
                document.getElementById('reportTitle').innerText = currentReportTitle;

                // --- PROFIT & LOSS CALCULATIONS ---
                const sales = filteredTxns.filter(t => t.type === 'sale').reduce((a, c) => a + c.total, 0);

                // COGS Calculation
                let cogs = 0;
                filteredTxns.filter(t => t.type === 'sale').forEach(t => {
                    const isReturn = t.isReturn;
                    t.items.forEach(i => {
                        const itemCost = i.cost !== undefined ? i.cost : (db.products.find(x => x.name === i.name)?.cost || 0);
                        const costTotal = moneyRound(itemCost * (i.qty || 1));
                        if (isReturn) {
                            cogs -= costTotal;
                        } else {
                            cogs += costTotal;
                        }
                    });
                });

                const grossProfit = moneyRound(sales - Math.abs(cogs));
                const expenses = filteredTxns.filter(t => t.type === 'expense').reduce((a, c) => a + c.total, 0);
                const netProfit = moneyRound(grossProfit - expenses);

                // --- BALANCE SHEET CALCULATIONS ---
                const stockVal = db.products.reduce((a, c) => a + (c.stock * c.cost), 0);
                const receivables = db.customers.reduce((a, c) => a + c.balance, 0);
                const payables = db.suppliers.reduce((a, c) => a + c.balance, 0);

                const cashBalance = moneyRound(db.config.cashBalance || 0);
                const bankBalance = moneyRound(db.config.bankBalance || 0);
                const totalLiquidAssets = moneyRound(cashBalance + bankBalance);

                // Calculate Fixed Assets
                const fixedAssets = (db.assets || []).reduce((a, c) => a + c.cost, 0);

                const assets = moneyRound(stockVal + receivables + totalLiquidAssets + fixedAssets);
                // Equity = Assets - Liabilities
                const equity = moneyRound(assets - payables);

                // --- DISPLAY CARDS ---
                cards.innerHTML += createCard('Net Profit', netProfit, netProfit >= 0 ? 'green-400' : 'red-400');
                cards.innerHTML += createCard('Total Assets', assets, 'blue-400');
                cards.innerHTML += createCard('Total Equity', equity, 'karta-primary');

                // --- GENERATE REPORT TABLE ---
                thead.innerHTML = `<tr><th class="p-3">Category</th><th class="p-3 text-right">Amount</th></tr>`;

                // Part 1: Profit & Loss Statement
                tbody.innerHTML += `<tr class="bg-gray-700 border-b border-gray-600"><td class="p-3 font-bold text-white" colspan="2">I. PROFIT & LOSS STATEMENT</td></tr>`;
                tbody.innerHTML += `<tr><td class="p-3 pl-6">Total Revenue (Sales)</td><td class="p-3 text-right text-green-400">+${db.config.currency}${sales.toFixed(2)}</td></tr>`;
                tbody.innerHTML += `<tr><td class="p-3 pl-6">Cost of Goods Sold (COGS)</td><td class="p-3 text-right text-red-300">-${db.config.currency}${Math.abs(cogs).toFixed(2)}</td></tr>`;
                tbody.innerHTML += `<tr class="border-t border-gray-800"><td class="p-3 pl-6 font-bold">Gross Profit</td><td class="p-3 text-right font-bold text-white">${db.config.currency}${grossProfit.toFixed(2)}</td></tr>`;
                tbody.innerHTML += `<tr><td class="p-3 pl-6">Operating Expenses</td><td class="p-3 text-right text-red-300">-${db.config.currency}${expenses.toFixed(2)}</td></tr>`;
                tbody.innerHTML += `<tr class="bg-white/5 border-t border-gray-600"><td class="p-3 font-bold text-karta-primary pl-6">NET PROFIT / (LOSS)</td><td class="p-3 text-right font-bold text-karta-primary">${db.config.currency}${netProfit.toFixed(2)}</td></tr>`;

                tbody.innerHTML += `<tr><td colspan="2" class="p-2"></td></tr>`; // Spacer

                // Part 2: Balance Sheet
                tbody.innerHTML += `<tr class="bg-gray-700 border-b border-gray-600"><td class="p-3 font-bold text-white" colspan="2">II. BALANCE SHEET</td></tr>`;

                // Assets
                tbody.innerHTML += `<tr class="bg-gray-800"><td class="p-3 pl-6 font-bold text-gray-300" colspan="2">ASSETS</td></tr>`;
                tbody.innerHTML += `<tr><td class="p-3 pl-8">Cash on Hand</td><td class="p-3 text-right">${db.config.currency}${cashBalance.toFixed(2)}</td></tr>`;
                tbody.innerHTML += `<tr><td class="p-3 pl-8">Bank Balance</td><td class="p-3 text-right">${db.config.currency}${bankBalance.toFixed(2)}</td></tr>`;
                tbody.innerHTML += `<tr><td class="p-3 pl-8">Accounts Receivable (Debtors)</td><td class="p-3 text-right">${db.config.currency}${receivables.toFixed(2)}</td></tr>`;
                tbody.innerHTML += `<tr><td class="p-3 pl-8">Closing Stock Value</td><td class="p-3 text-right">${db.config.currency}${stockVal.toFixed(2)}</td></tr>`;
                if (fixedAssets > 0) {
                    tbody.innerHTML += `<tr><td class="p-3 pl-8">Fixed Assets</td><td class="p-3 text-right text-purple-400">${db.config.currency}${fixedAssets.toFixed(2)}</td></tr>`;
                }
                tbody.innerHTML += `<tr class="border-t border-gray-700"><td class="p-3 pl-6 font-bold">Total Assets</td><td class="p-3 text-right font-bold text-blue-400">${db.config.currency}${assets.toFixed(2)}</td></tr>`;

                // Liabilities
                tbody.innerHTML += `<tr class="bg-gray-800"><td class="p-3 pl-6 font-bold text-gray-300" colspan="2">LIABILITIES</td></tr>`;
                tbody.innerHTML += `<tr><td class="p-3 pl-8">Accounts Payable (Creditors)</td><td class="p-3 text-right">${db.config.currency}${payables.toFixed(2)}</td></tr>`;
                tbody.innerHTML += `<tr class="border-t border-gray-700"><td class="p-3 pl-6 font-bold">Total Liabilities</td><td class="p-3 text-right font-bold text-red-400">${db.config.currency}${payables.toFixed(2)}</td></tr>`;

                // Equity
                tbody.innerHTML += `<tr class="bg-gray-800"><td class="p-3 pl-6 font-bold text-gray-300" colspan="2">EQUITY</td></tr>`;
                tbody.innerHTML += `<tr><td class="p-3 pl-8">Owner's Equity (Net Assets)</td><td class="p-3 text-right text-green-400">${db.config.currency}${equity.toFixed(2)}</td></tr>`;

                return;
            }

            // --- JOURNAL BOOK REPORT (AUTOMATIC) ---
            if (type === 'journal') {
                currentReportTitle = "Journal Book (Automatic)";
                document.getElementById('reportTitle').innerText = currentReportTitle;

                let html = `<table id="repTable" style="width:100%; text-align: left; border-collapse: collapse;">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-6">Date</th>
                            <th class="py-3 px-6">Particulars</th>
                            <th class="py-3 px-6 text-center">L.F.</th>
                            <th class="py-3 px-6 text-right">Debit (${db.config.currency})</th>
                            <th class="py-3 px-6 text-right">Credit (${db.config.currency})</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">`;

                // Use FILTERED transactions by date
                const allTxns = filteredTxns.slice().sort((a, b) => new Date(a.date) - new Date(b.date));
                currentReportData = allTxns; // Export uses this data

                if (allTxns.length === 0) {
                    html += `<tr><td colspan="5" class="text-center py-4">No transactions found.</td></tr>`;
                } else {
                    allTxns.forEach(txn => {
                        let drAccount = '';
                        let crAccount = '';
                        let amount = 0;
                        let narration = '';
                        let showEntry = false;

                        // --- MAP TRANSACTIONS TO JOURNAL ENTRIES ---

                        // 1. SALES (Income)
                        if (txn.type === 'sale') {
                            showEntry = true;
                            amount = txn.total;
                            const entity = txn.entityName || 'Walk-in Customer';
                            narration = `Being goods sold to ${entity} (Inv #${txn.id})`;

                            // Credit: Sales A/c (Always)
                            crAccount = 'Sales A/c';

                            // Debit: Cash, Bank, or Debtor
                            if (txn.payType === 'credit') drAccount = `${entity} (Debtor)`;
                            else if (txn.payType === 'bank') drAccount = 'Bank A/c';
                            else if (txn.payType === 'cash') drAccount = 'Cash A/c';
                            else if (txn.payType === 'split') drAccount = 'Cash/Bank (Split)';
                            else drAccount = 'Cash A/c';
                        }

                        // 2. PURCHASES (Expense/Asset)
                        else if (txn.type === 'purchase') {
                            showEntry = true;
                            amount = txn.total;
                            const entity = txn.entityName || 'Supplier';
                            narration = `Being goods purchased from ${entity} (Ref #${txn.ref || txn.id})`;

                            // Debit: Purchase A/c (Always)
                            drAccount = 'Purchase A/c';

                            // Credit: Cash, Bank, or Creditor
                            if (txn.payType === 'credit') crAccount = `${entity} (Creditor)`;
                            else if (txn.payType === 'bank') crAccount = 'Bank A/c';
                            else if (txn.payType === 'cash') crAccount = 'Cash A/c';
                            else crAccount = 'Cash A/c';
                        }

                        // 3. EXPENSES (Nominal)
                        else if (txn.type === 'expense') {
                            showEntry = true;
                            amount = txn.total;
                            narration = `Being expenses paid for ${txn.entityName || txn.category || 'General'}`;

                            drAccount = 'Expense A/c';
                            crAccount = 'Cash A/c'; // Assuming expenses paid by cash mostly
                        }

                        // 3b. ASSET PURCHASE (Fixed Assets)
                        else if (txn.type === 'asset_purchase') {
                            showEntry = true;
                            amount = txn.total;
                            narration = `Being ${txn.assetName} purchased (Ref #${txn.id})`;

                            drAccount = `${txn.assetName} A/c`;
                            if (txn.payType === 'credit' && txn.supplierName && txn.supplierName !== 'N/A') {
                                crAccount = `${txn.supplierName} (Creditor)`;
                            } else if (txn.payType === 'bank') {
                                crAccount = 'Bank A/c';
                            } else {
                                crAccount = 'Cash A/c';
                            }
                        }

                        // 4. PAYMENTS IN (Received from Debtor)
                        else if (txn.type === 'payment') {
                            showEntry = true;
                            amount = txn.total;
                            narration = `Being payment received from ${txn.entityName}`;

                            drAccount = 'Cash A/c';
                            crAccount = `${txn.entityName} (Debtor)`;
                        }

                        // 5. PAYMENTS OUT (Paid to Creditor)
                        else if (txn.type === 'payment_out') {
                            showEntry = true;
                            amount = txn.total;
                            narration = `Being payment made to ${txn.entityName}`;

                            drAccount = `${txn.entityName} (Creditor)`;
                            crAccount = 'Cash A/c';
                        }

                        // 6. RETURNS (Sales Return)
                        else if (txn.type === 'return_cash_out' || (txn.type === 'sale' && txn.isReturn)) {
                            showEntry = true;
                            amount = Math.abs(txn.total);
                            const entity = txn.entityName || 'Customer';
                            narration = `Being goods returned by ${entity} (Inv #${txn.ref || txn.id})`;

                            drAccount = 'Sales Return A/c';
                            crAccount = 'Cash A/c'; // Or Customer if credit, simplification here
                        }


                        if (showEntry) {
                            html += `
                                <tr class="border-b border-gray-200 hover:bg-gray-100">
                                    <td class="py-3 px-6 text-left whitespace-nowrap align-top">${window.formatDate ? window.formatDate(txn.date) : txn.date}</td>
                                    <td class="py-3 px-6 text-left">
                                        <div class="font-bold">${drAccount} <span class="text-xs text-gray-500 font-normal">Dr.</span></div>
                                        <div class="pl-8 text-gray-500">To ${crAccount}</div>
                                        <div class="text-xs italic text-gray-400 mt-1">(${narration})</div>
                                    </td>
                                    <td class="py-3 px-6 text-center align-top">-</td>
                                    <td class="py-3 px-6 text-right font-bold align-top">${moneyRound(amount).toFixed(2)}</td>
                                    <td class="py-3 px-6 text-right align-top"></td>
                                </tr>
                                <tr class="border-b border-gray-200 hover:bg-gray-100">
                                    <td class="py-3 px-6"></td>
                                    <td class="py-3 px-6"></td>
                                    <td class="py-3 px-6"></td>
                                    <td class="py-3 px-6"></td>
                                    <td class="py-3 px-6 text-right font-bold align-top">${moneyRound(amount).toFixed(2)}</td>
                                </tr>
                            `;
                        }
                    });

                    // Add Totals Row
                    const totalDebit = allTxns.reduce((sum, txn) => sum + txn.total, 0); // Simplified: Assuming logic loops all valid entries
                    // Actually, specific accumulation is needed inside the loop because not all txns have same Dr/Cr logic
                    // Re-calculating correctly below:
                }

                // Recalculate Totals more accurately based on displayed entries
                let totalDr = 0;
                let totalCr = 0;

                if (allTxns.length > 0) {
                    allTxns.forEach(txn => {
                        // Simplify: Since every system txn is balanced, Total Dr = Total Cr = Sum of all txn totals
                        // However, returns are negative/different. 
                        // Let's rely on the displayed amount.
                        // For Sales/Purchase/Expense/Payment, the amount displayed is txn.total
                        // For Returns, it is abs(txn.total)
                        const amt = (txn.type === 'return_cash_out' || (txn.type === 'sale' && txn.isReturn)) ? Math.abs(txn.total) : txn.total;
                        totalDr += amt;
                        totalCr += amt;
                    });
                }

                html += `
                    <tr class="bg-gray-200 font-bold border-t-2 border-gray-400">
                        <td colspan="3" class="py-3 px-6 text-right uppercase">Total</td>
                        <td class="py-3 px-6 text-right">${moneyRound(totalDr).toFixed(2)}</td>
                        <td class="py-3 px-6 text-right">${moneyRound(totalCr).toFixed(2)}</td>
                    </tr>
                `;

                html += `</tbody></table>`;
                tbody.innerHTML = html;
                return;
            }

            // --- GENERAL LEDGER REPORT ---
            if (type === 'ledger') {
                currentReportTitle = "General Ledger";
                document.getElementById('reportTitle').innerText = currentReportTitle;

                // Account Selector
                cards.innerHTML = `
                    <div class="mb-4 flex gap-2 items-center print:hidden w-full max-w-md">
                        <label class="font-bold text-gray-400">Select Account:</label>
                        <select id="ledgerAccountSelect" onchange="runReports('ledger', this.value)" class="flex-1 p-2 bg-karta-input border border-karta-border rounded text-white focus:outline-none focus:border-green-500">
                            <option value="">-- Choose Account --</option>
                            <option value="Cash A/c">Cash A/c</option>
                            <option value="Bank A/c">Bank A/c</option>
                            <option value="Sales A/c">Sales A/c</option>
                            <option value="Purchase A/c">Purchase A/c</option>
                            <option value="Expense A/c">Expense A/c</option>
                            <option value="Capital A/c">Capital A/c</option>
                        </select>
                    </div>
                `;

                // Quick hack: runReports(type, filter) - read from arguments if passed
                const selectedAccount = arguments[1] || '';

                // Set dropdown value if selected
                setTimeout(() => {
                    const sel = document.getElementById('ledgerAccountSelect');
                    if (sel && selectedAccount) sel.value = selectedAccount;
                }, 50);

                if (selectedAccount) {
                    let html = `<div class="mb-4"><h3 class="text-center font-bold text-xl underline uppercase text-white">${selectedAccount}</h3></div>`;
                    html += `<table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-700 text-gray-300 uppercase text-sm">
                                <th class="py-3 px-4 border border-gray-600">Date</th>
                                <th class="py-3 px-4 border border-gray-600">Particulars</th>
                                <th class="py-3 px-4 border border-gray-600 text-center">J.F.</th>
                                <th class="py-3 px-4 border border-gray-600 text-right">Debit</th>
                                <th class="py-3 px-4 border border-gray-600 text-right">Credit</th>
                                <th class="py-3 px-4 border border-gray-600 text-right">Balance</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm text-gray-300">`;

                    let balance = 0;
                    let totalDr = 0;
                    let totalCr = 0;

                    // Filter and Sort filtered transactions
                    const allTxns = filteredTxns.slice().sort((a, b) => new Date(a.date) - new Date(b.date));
                    let hasData = false;

                    allTxns.forEach(txn => {
                        let dr = 0;
                        let cr = 0;
                        let particular = '';
                        let isRelevant = false;

                        // Identify if transaction affects selected account
                        if (txn.type === 'journal') {
                            if (txn.drAccount === selectedAccount) { dr = txn.total; particular = `To ${txn.crAccount}`; isRelevant = true; }
                            if (txn.crAccount === selectedAccount) { cr = txn.total; particular = `By ${txn.drAccount}`; isRelevant = true; }
                        } else if (selectedAccount === 'Cash A/c') {
                            if (txn.payType === 'cash' || txn.cashAmount > 0) {
                                const amt = (txn.payType === 'split' ? txn.cashAmount : txn.total);
                                if (txn.type === 'sale') { dr = amt; particular = `To Sales (Inv #${txn.id})`; isRelevant = true; }
                                if (txn.type === 'expense') { cr = amt; particular = `By Expense (${txn.category || 'General'})`; isRelevant = true; }
                                if (txn.type === 'purchase') { cr = amt; particular = `By Purchase (Inv #${txn.ref || txn.id})`; isRelevant = true; }
                                if (txn.type === 'payment') { dr = amt; particular = `To Customer Payment (${txn.entityName})`; isRelevant = true; } // Receiving Money
                                if (txn.type === 'payment_out') { cr = amt; particular = `By Supplier Payment (${txn.entityName})`; isRelevant = true; } // Paying Money
                                if (txn.type === 'asset_purchase') { cr = amt; particular = `By Asset (${txn.assetName})`; isRelevant = true; }
                                if (txn.type === 'return_cash_out') { cr = Math.abs(txn.total); particular = `By Cash Return (${txn.entityName || 'Customer'})`; isRelevant = true; }
                            }
                        } else if (selectedAccount === 'Bank A/c') {
                            if (txn.payType === 'bank' || txn.bankAmount > 0) {
                                const amt = (txn.payType === 'split' ? txn.bankAmount : txn.total);
                                if (txn.type === 'sale') { dr = amt; particular = `To Sales (Inv #${txn.id})`; isRelevant = true; }
                                if (txn.type === 'purchase') { cr = amt; particular = `By Purchase (Inv #${txn.ref || txn.id})`; isRelevant = true; }
                                if (txn.type === 'expense') { cr = amt; particular = `By Expense (${txn.category || 'General'})`; isRelevant = true; }
                                if (txn.type === 'asset_purchase') { cr = amt; particular = `By Asset (${txn.assetName})`; isRelevant = true; }
                                if (txn.type === 'payment') { dr = amt; particular = `To Customer Payment (${txn.entityName})`; isRelevant = true; }
                                if (txn.type === 'payment_out') { cr = amt; particular = `By Supplier Payment (${txn.entityName})`; isRelevant = true; }
                            }
                        } else if (selectedAccount === 'Sales A/c') {
                            if (txn.type === 'sale') { cr = txn.total; particular = `By ${txn.payType === 'credit' ? 'Debtors' : 'Cash/Bank'}`; isRelevant = true; }
                            if (txn.type === 'return_cash_out' || (txn.type === 'sale' && txn.isReturn)) { dr = txn.total; particular = `To Return In`; isRelevant = true; }
                        } else if (selectedAccount === 'Purchase A/c') {
                            if (txn.type === 'purchase') { dr = txn.total; particular = `To ${txn.payType === 'credit' ? 'Creditors' : 'Cash/Bank'}`; isRelevant = true; }
                        } else if (selectedAccount === 'Expense A/c') {
                            if (txn.type === 'expense') { dr = txn.total; particular = `To Cash/Bank`; isRelevant = true; }
                        }

                        if (isRelevant) {
                            hasData = true;
                            // Calculate running balance 
                            // Asset/Expense Nature: Dr (+), Cr (-)
                            // Liability/Income Nature: Cr (+), Dr (-)
                            // For simplified view, we will use Dr (+) Cr (-) logic basically
                            balance = balance + dr - cr;

                            totalDr += dr;
                            totalCr += cr;

                            html += `
                                <tr class="border-b border-gray-700 hover:bg-white/5">
                                    <td class="py-2 px-4 border border-gray-600">${window.formatDate ? window.formatDate(txn.date) : txn.date}</td>
                                    <td class="py-2 px-4 border border-gray-600">${particular}</td>
                                    <td class="py-2 px-4 border border-gray-600 text-center">-</td>
                                    <td class="py-2 px-4 border border-gray-600 text-right">${dr ? moneyRound(dr).toFixed(2) : ''}</td>
                                    <td class="py-2 px-4 border border-gray-600 text-right">${cr ? moneyRound(cr).toFixed(2) : ''}</td>
                                    <td class="py-2 px-4 border border-gray-600 text-right font-bold">${Math.abs(moneyRound(balance)).toFixed(2)} ${balance >= 0 ? 'Dr' : 'Cr'}</td>
                                </tr>
                            `;
                        }
                    });

                    if (hasData) {
                        // Add Balance c/d entry before totals to balance both sides
                        const finalBalance = moneyRound(balance);
                        if (finalBalance !== 0) {
                            const absBalance = Math.abs(finalBalance);
                            if (finalBalance > 0) {
                                // Debit balance: add Balance c/d on Credit side
                                html += `
                                    <tr class="border-b border-gray-700 bg-yellow-900/20">
                                        <td class="py-2 px-4 border border-gray-600"></td>
                                        <td class="py-2 px-4 border border-gray-600 font-bold italic text-yellow-300">To Balance c/d</td>
                                        <td class="py-2 px-4 border border-gray-600 text-center">-</td>
                                        <td class="py-2 px-4 border border-gray-600 text-right"></td>
                                        <td class="py-2 px-4 border border-gray-600 text-right font-bold text-blue-400">${absBalance.toFixed(2)}</td>
                                        <td class="py-2 px-4 border border-gray-600 text-right"></td>
                                    </tr>
                                `;
                                totalCr += absBalance;
                            } else {
                                // Credit balance: add Balance c/d on Debit side
                                html += `
                                    <tr class="border-b border-gray-700 bg-yellow-900/20">
                                        <td class="py-2 px-4 border border-gray-600"></td>
                                        <td class="py-2 px-4 border border-gray-600 font-bold italic text-yellow-300">To Balance c/d</td>
                                        <td class="py-2 px-4 border border-gray-600 text-center">-</td>
                                        <td class="py-2 px-4 border border-gray-600 text-right font-bold text-blue-400">${absBalance.toFixed(2)}</td>
                                        <td class="py-2 px-4 border border-gray-600 text-right"></td>
                                        <td class="py-2 px-4 border border-gray-600 text-right"></td>
                                    </tr>
                                `;
                                totalDr += absBalance;
                            }
                        }

                        // Total row - now both sides should be equal
                        html += `
                            <tr class="bg-gray-600 font-bold text-white border-t-2 border-gray-500">
                                <td colspan="3" class="py-2 px-4 border border-gray-600 text-right uppercase">Total</td>
                                <td class="py-2 px-4 border border-gray-600 text-right">${moneyRound(totalDr).toFixed(2)}</td>
                                <td class="py-2 px-4 border border-gray-600 text-right">${moneyRound(totalCr).toFixed(2)}</td>
                                <td class="py-2 px-4 border border-gray-600 text-right"></td>
                            </tr>
                        `;

                        // Add Balance b/d entry after totals (opening balance for next period)
                        if (finalBalance !== 0) {
                            const absBalance = Math.abs(finalBalance);
                            if (finalBalance > 0) {
                                // Debit balance brought down
                                html += `
                                    <tr class="bg-blue-900/20 border-t border-gray-500">
                                        <td class="py-2 px-4 border border-gray-600"></td>
                                        <td class="py-2 px-4 border border-gray-600 font-bold italic text-green-300">By Balance b/d</td>
                                        <td class="py-2 px-4 border border-gray-600 text-center">-</td>
                                        <td class="py-2 px-4 border border-gray-600 text-right font-bold text-green-400">${absBalance.toFixed(2)}</td>
                                        <td class="py-2 px-4 border border-gray-600 text-right"></td>
                                        <td class="py-2 px-4 border border-gray-600 text-right font-bold">${absBalance.toFixed(2)} Dr</td>
                                    </tr>
                                `;
                            } else {
                                // Credit balance brought down
                                html += `
                                    <tr class="bg-blue-900/20 border-t border-gray-500">
                                        <td class="py-2 px-4 border border-gray-600"></td>
                                        <td class="py-2 px-4 border border-gray-600 font-bold italic text-green-300">By Balance b/d</td>
                                        <td class="py-2 px-4 border border-gray-600 text-center">-</td>
                                        <td class="py-2 px-4 border border-gray-600 text-right"></td>
                                        <td class="py-2 px-4 border border-gray-600 text-right font-bold text-green-400">${absBalance.toFixed(2)}</td>
                                        <td class="py-2 px-4 border border-gray-600 text-right font-bold">${absBalance.toFixed(2)} Cr</td>
                                    </tr>
                                `;
                            }
                        }
                    }

                    if (!hasData) {
                        html += `<tr><td colspan="6" class="text-center py-4 text-gray-500">No transactions found for ${selectedAccount}</td></tr>`;
                    }
                    html += `</tbody></table>`;
                    tbody.innerHTML = html;

                } else {
                    tbody.innerHTML = `<p class="text-center text-gray-500 italic p-10">Select an account above to view its General Ledger.</p>`;
                }
                return;
            }

            // --- TRIAL BALANCE REPORT ---
            if (type === 'trial') {
                currentReportTitle = "Trial Balance";
                document.getElementById('reportTitle').innerText = currentReportTitle;

                // Calculate balances for all accounts using filtered transactions
                const allTxns = filteredTxns.slice();

                // Initialize account balances
                let cashBalance = db.config.cashBalance || 0;
                let bankBalance = db.config.bankBalance || 0;

                // Calculate Sales A/c balance (Credit nature)
                let salesBalance = 0;
                allTxns.forEach(t => {
                    if (t.type === 'sale') salesBalance += t.total;
                    if (t.type === 'return_cash_out' || (t.type === 'sale' && t.isReturn)) salesBalance -= t.total;
                });

                // Calculate Purchase A/c balance (Debit nature)
                let purchaseBalance = 0;
                allTxns.forEach(t => {
                    if (t.type === 'purchase') purchaseBalance += t.total;
                });

                // Calculate Expense A/c balance (Debit nature)
                let expenseBalance = 0;
                allTxns.forEach(t => {
                    if (t.type === 'expense') expenseBalance += t.total;
                });

                // Calculate Assets balance (Debit nature)
                let assetsBalance = 0;
                if (db.assets && db.assets.length > 0) {
                    assetsBalance = db.assets.reduce((a, c) => a + c.cost, 0);
                }

                // Calculate Stock Value (Debit nature - Asset)
                let stockValue = 0;
                if (db.products && db.products.length > 0) {
                    stockValue = db.products.reduce((a, c) => a + (c.stock * c.cost), 0);
                }

                // Calculate Debtors (Receivables) - Debit nature
                let debtorsBalance = 0;
                if (db.customers && db.customers.length > 0) {
                    debtorsBalance = db.customers.reduce((a, c) => a + c.balance, 0);
                }

                // Calculate Creditors (Payables) - Credit nature
                let creditorsBalance = 0;
                if (db.suppliers && db.suppliers.length > 0) {
                    creditorsBalance = db.suppliers.reduce((a, c) => a + c.balance, 0);
                }

                // Build accounts array with balances
                const accounts = [];

                // Assets (Debit side)
                if (cashBalance > 0) accounts.push({ name: 'Cash A/c', debit: cashBalance, credit: 0 });
                else if (cashBalance < 0) accounts.push({ name: 'Cash A/c', debit: 0, credit: Math.abs(cashBalance) });

                if (bankBalance > 0) accounts.push({ name: 'Bank A/c', debit: bankBalance, credit: 0 });
                else if (bankBalance < 0) accounts.push({ name: 'Bank A/c', debit: 0, credit: Math.abs(bankBalance) });

                if (debtorsBalance > 0) accounts.push({ name: 'Debtors A/c', debit: debtorsBalance, credit: 0 });
                if (stockValue > 0) accounts.push({ name: 'Closing Stock A/c', debit: stockValue, credit: 0 });
                if (assetsBalance > 0) accounts.push({ name: 'Fixed Assets A/c', debit: assetsBalance, credit: 0 });

                // Expenses (Debit side)
                if (purchaseBalance > 0) accounts.push({ name: 'Purchase A/c', debit: purchaseBalance, credit: 0 });
                if (expenseBalance > 0) accounts.push({ name: 'Expense A/c', debit: expenseBalance, credit: 0 });

                // Liabilities and Income (Credit side)
                if (creditorsBalance > 0) accounts.push({ name: 'Creditors A/c', debit: 0, credit: creditorsBalance });
                if (salesBalance > 0) accounts.push({ name: 'Sales A/c', debit: 0, credit: salesBalance });

                // Calculate totals
                let totalDr = accounts.reduce((a, c) => a + c.debit, 0);
                let totalCr = accounts.reduce((a, c) => a + c.credit, 0);

                // Calculate Capital/Equity (Balancing figure)
                const difference = totalDr - totalCr;
                if (difference > 0) {
                    // Debit > Credit, add Capital on Credit side
                    accounts.push({ name: 'Capital A/c', debit: 0, credit: difference });
                    totalCr += difference;
                } else if (difference < 0) {
                    // Credit > Debit, add Capital on Debit side (loss)
                    accounts.push({ name: 'Capital A/c', debit: Math.abs(difference), credit: 0 });
                    totalDr += Math.abs(difference);
                }

                // Display summary cards
                cards.innerHTML = `
                    <div class="bg-karta-surface border border-karta-border p-6 rounded-lg">
                        <h4 class="text-gray-400 text-xs uppercase">Total Debits</h4>
                        <h2 class="text-2xl font-bold text-blue-400 mt-2">${db.config.currency}${moneyRound(totalDr).toFixed(2)}</h2>
                    </div>
                    <div class="bg-karta-surface border border-karta-border p-6 rounded-lg">
                        <h4 class="text-gray-400 text-xs uppercase">Total Credits</h4>
                        <h2 class="text-2xl font-bold text-green-400 mt-2">${db.config.currency}${moneyRound(totalCr).toFixed(2)}</h2>
                    </div>
                    <div class="bg-karta-surface border border-karta-border p-6 rounded-lg">
                        <h4 class="text-gray-400 text-xs uppercase">Status</h4>
                        <h2 class="text-2xl font-bold text-karta-primary mt-2">${totalDr === totalCr ? 'Balanced ✓' : 'Not Balanced'}</h2>
                    </div>
                `;

                // Generate table
                thead.innerHTML = `<tr>
                    <th class="p-3 text-left">Account Name</th>
                    <th class="p-3 text-right">Debit (${db.config.currency})</th>
                    <th class="p-3 text-right">Credit (${db.config.currency})</th>
                </tr>`;

                let html = '';
                accounts.forEach(acc => {
                    html += `<tr class="border-b border-gray-700">
                        <td class="p-3">${acc.name}</td>
                        <td class="p-3 text-right ${acc.debit > 0 ? 'text-blue-400 font-semibold' : 'text-gray-600'}">${acc.debit > 0 ? moneyRound(acc.debit).toFixed(2) : '-'}</td>
                        <td class="p-3 text-right ${acc.credit > 0 ? 'text-green-400 font-semibold' : 'text-gray-600'}">${acc.credit > 0 ? moneyRound(acc.credit).toFixed(2) : '-'}</td>
                    </tr>`;
                });

                // Total row
                html += `<tr class="bg-gray-700 font-bold border-t-2 border-gray-500">
                    <td class="p-3 uppercase">Total</td>
                    <td class="p-3 text-right text-blue-300">${moneyRound(totalDr).toFixed(2)}</td>
                    <td class="p-3 text-right text-green-300">${moneyRound(totalCr).toFixed(2)}</td>
                </tr>`;

                tbody.innerHTML = html;
                currentReportData = accounts; // For export
                return;
            }

            // --- DEBTORS REPORT ---
            if (type === 'debtors') {
                const debtorFilterContainer = document.getElementById('debtorFilterContainer');
                debtorFilterContainer.classList.remove('hidden');

                const allDebtors = db.customers.filter(c => c.balance > 0);
                currentReportData = allDebtors;

                let totalDebtAmount = 0;
                allDebtors.forEach(d => totalDebtAmount += d.balance);

                // Create custom card for count (doesn't need currency prefix)
                cards.innerHTML += `<div class="bg-karta-surface border border-karta-border p-6 rounded-lg"><h4 class="text-gray-400 text-xs uppercase">Total Debtors</h4><h2 class="text-2xl font-bold text-white mt-2">${allDebtors.length}</h2></div>`;
                cards.innerHTML += createCard('Total Amount Due', totalDebtAmount, 'red-400');
                cards.innerHTML += createCard('Average Debt', (totalDebtAmount / (allDebtors.length || 1)), 'yellow-400');

                thead.innerHTML = `<tr>
                    <th class="p-3">Customer Name</th>
                    <th class="p-3">Location</th>
                    <th class="p-3">Phone</th>
                    <th class="p-3 text-right">Amount Due</th>
                    <th class="p-3 text-right">Credit Limit</th>
                </tr>`;

                allDebtors.forEach(debtor => {
                    tbody.innerHTML += `<tr class="hover:bg-white/5">
                        <td class="p-3 font-bold text-white">${debtor.name}</td>
                        <td class="p-3 text-gray-400">${debtor.address || 'N/A'}</td>
                        <td class="p-3 text-gray-400">${debtor.phone}</td>
                        <td class="p-3 text-right font-bold text-red-400">${db.config.currency}${debtor.balance.toFixed(2)}</td>
                        <td class="p-3 text-right text-gray-400">${db.config.currency}${(debtor.limit || 0).toFixed(2)}</td>
                    </tr>`;
                });
                return;
            }

            if (type === 'aging') {
                const debtorFilterContainer = document.getElementById('debtorFilterContainer');
                debtorFilterContainer.classList.add('hidden'); // No filter for aging yet

                // Format the "as of" date for display
                const asOfDateStr = window.formatDate ? window.formatDate(agingAsOfDate.toISOString()) : agingAsOfDate.toLocaleDateString();
                currentReportTitle = `DEBTORS AGING REPORT (As of ${asOfDateStr})`;
                document.getElementById('reportTitle').innerText = currentReportTitle;

                // Get debtors
                const debtors = db.customers.filter(c => c.balance > 1); // Ignore tiny fractions
                if (debtors.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">No debtors found.</td></tr>';
                    return;
                }

                currentReportData = [];
                const now = agingAsOfDate; // Use selected date instead of new Date()

                // --- AGING CALCULATION LOGIC ---
                debtors.forEach(cust => {
                    let remainingBal = cust.balance;
                    const buckets = { '0-30': 0, '31-60': 0, '61-90': 0, '90+': 0 };

                    // Get all credit sales for this customer (sorted oldest first - FIFO)
                    const creditSales = db.transactions
                        .filter(t => t.type === 'sale' &&
                            t.entityId === cust.id &&
                            (t.payType === 'credit' || t.creditAmount > 0) &&
                            !t.isReturn)
                        .sort((a, b) => new Date(a.date) - new Date(b.date));

                    // Allocate remaining balance to sales invoices (oldest first - FIFO)
                    creditSales.forEach(txn => {
                        if (remainingBal <= 0.01) return;

                        let debtAmount = (txn.payType === 'credit') ? txn.total : (txn.creditAmount || 0);


                        // Check if there are payments handling this invoice (same logic as creditors)

                        // Also check for payments made after this sale
                        const linkedPayments = (db.transactions || []).filter(t =>
                            t.type === 'payment' &&
                            t.entityId === cust.id &&
                            new Date(t.date) >= new Date(txn.date));
                        const linkedPaidAmount = linkedPayments.reduce((sum, p) => sum + p.total, 0) / creditSales.length;

                        debtAmount -= linkedPaidAmount;

                        if (debtAmount <= 0.01) return; // Invoice fully paid

                        const allocated = Math.min(remainingBal, debtAmount);

                        // Calculate age from invoice date to "as of" date
                        let invoiceDate = new Date(txn.date);

                        // NEPALI DATE FIX: Check if date is in BS format (year > 2080)
                        const dateStr = txn.date.toString();
                        const yearMatch = dateStr.match(/^(\d{4})-/);
                        if (yearMatch && parseInt(yearMatch[1]) > 2080) {
                            // This is a Nepali BS date - convert to approximate AD
                            // BS to AD conversion: subtract 57 years (approximate)
                            const bsYear = parseInt(yearMatch[1]);
                            const adYear = bsYear - 57;
                            const adDateStr = dateStr.replace(yearMatch[1], adYear.toString());
                            invoiceDate = new Date(adDateStr);
                        }

                        const diffTime = Math.abs(now - invoiceDate);
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                        // DEBUG: Show what's being calculated
                        console.log(`[AGING] Customer: ${cust.name}, Invoice #${txn.id}, Invoice Date: ${txn.date}, As Of: ${now.toISOString().split('T')[0]}, Age: ${diffDays} days, Amount: Rs.${allocated.toFixed(2)}`);

                        if (diffDays <= 30) buckets['0-30'] += allocated;
                        else if (diffDays <= 60) buckets['31-60'] += allocated;
                        else if (diffDays <= 90) buckets['61-90'] += allocated;
                        else buckets['90+'] += allocated;

                        remainingBal -= allocated;
                    });

                    // If balance still remains (e.g. Opening Balance or unrecorded legacy sales), put in 90+
                    if (remainingBal > 0.01) {
                        buckets['90+'] += remainingBal;
                    }

                    currentReportData.push({
                        name: cust.name,
                        location: cust.address || '-',
                        phone: cust.phone,
                        total: cust.balance,
                        b1: buckets['0-30'],
                        b2: buckets['31-60'],
                        b3: buckets['61-90'],
                        b4: buckets['90+']
                    });
                });

                // Render Aging Table
                thead.innerHTML = `<tr>
                    <th class="p-3 text-left">Customer</th>
                    <th class="p-3 text-right">0-30 Days</th>
                    <th class="p-3 text-right">31-60 Days</th>
                    <th class="p-3 text-right">61-90 Days</th>
                    <th class="p-3 text-right">90+ Days</th>
                    <th class="p-3 text-right">Total Due</th>
                </tr>`;

                currentReportData.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-800 text-gray-300 hover:bg-white/5";
                    tr.innerHTML = `
                        <td class="p-3 font-bold text-white">
                            ${row.name}<br>
                            <span class="text-xs text-gray-500">${row.phone}</span>
                        </td>
                        <td class="p-3 text-right ${row.b1 > 0 ? 'text-green-400' : 'text-gray-600'}">${row.b1 > 0 ? db.config.currency + row.b1.toFixed(2) : '-'}</td>
                        <td class="p-3 text-right ${row.b2 > 0 ? 'text-yellow-500' : 'text-gray-600'}">${row.b2 > 0 ? db.config.currency + row.b2.toFixed(2) : '-'}</td>
                        <td class="p-3 text-right ${row.b3 > 0 ? 'text-orange-500' : 'text-gray-600'}">${row.b3 > 0 ? db.config.currency + row.b3.toFixed(2) : '-'}</td>
                        <td class="p-3 text-right ${row.b4 > 0 ? 'text-red-500 font-bold' : 'text-gray-600'}">${row.b4 > 0 ? db.config.currency + row.b4.toFixed(2) : '-'}</td>
                        <td class="p-3 text-right font-bold text-white text-lg">${db.config.currency}${row.total.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });
                return;
            }

            // --- CREDITORS AGING REPORT (New) ---
            if (type === 'creditors_aging') {
                const debtorFilterContainer = document.getElementById('debtorFilterContainer');
                debtorFilterContainer.classList.add('hidden');

                // Format the "as of" date for display
                const asOfDateStr = window.formatDate ? window.formatDate(agingAsOfDate.toISOString()) : agingAsOfDate.toLocaleDateString();
                currentReportTitle = `CREDITORS AGING REPORT (As of ${asOfDateStr})`;
                document.getElementById('reportTitle').innerText = currentReportTitle;

                // Get creditors (suppliers we owe money to)
                const creditors = db.suppliers.filter(s => s.balance > 1); // Ignore tiny fractions
                if (creditors.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">No creditors found.</td></tr>';
                    return;
                }

                currentReportData = [];
                const now = agingAsOfDate; // Use selected date

                // --- AGING CALCULATION LOGIC (for suppliers) ---
                creditors.forEach(supplier => {
                    let remainingBal = supplier.balance;
                    const buckets = { '0-30': 0, '31-60': 0, '61-90': 0, '90+': 0 };

                    // Get all credit purchases for this supplier (sorted oldest first)
                    const creditPurchases = db.transactions
                        .filter(t => t.type === 'purchase' &&
                            t.entityId === supplier.id &&
                            (t.payType === 'credit' || t.creditAmount > 0) &&
                            !t.isReturn)
                        .sort((a, b) => new Date(a.date) - new Date(b.date));

                    // Allocate remaining balance to purchases (oldest first - FIFO)
                    creditPurchases.forEach(txn => {
                        if (remainingBal <= 0.01) return;

                        let debtAmount = (txn.payType === 'credit') ? txn.total : (txn.creditAmount || 0);

                        // Check if there are specific payments handling this purchase
                        const linkedPayments = (db.transactions || []).filter(t =>
                            t.type === 'payment_out' &&
                            t.entityId === supplier.id &&
                            new Date(t.date) >= new Date(txn.date));
                        const linkedPaidAmount = linkedPayments.reduce((sum, p) => sum + p.total, 0) / creditPurchases.length; // Simplified allocation

                        debtAmount -= linkedPaidAmount;

                        if (debtAmount <= 0.01) return;

                        const allocated = Math.min(remainingBal, debtAmount);

                        // Calculate age from purchase date to "as of" date
                        let purchaseDate = new Date(txn.purchaseDate || txn.date);

                        // NEPALI DATE FIX: Check if date is in BS format (year > 2080)
                        const dateStr = (txn.purchaseDate || txn.date).toString();
                        const yearMatch = dateStr.match(/^(\d{4})-/);
                        if (yearMatch && parseInt(yearMatch[1]) > 2080) {
                            // This is a Nepali BS date - convert to approximate AD
                            // BS to AD conversion: subtract 57 years (approximate)
                            const bsYear = parseInt(yearMatch[1]);
                            const adYear = bsYear - 57;
                            const adDateStr = dateStr.replace(yearMatch[1], adYear.toString());
                            purchaseDate = new Date(adDateStr);
                        }

                        const diffTime = Math.abs(now - purchaseDate);
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                        if (diffDays <= 30) buckets['0-30'] += allocated;
                        else if (diffDays <= 60) buckets['31-60'] += allocated;
                        else if (diffDays <= 90) buckets['61-90'] += allocated;
                        else buckets['90+'] += allocated;

                        remainingBal -= allocated;
                    });

                    // If balance still remains, put in 90+
                    if (remainingBal > 0.01) {
                        buckets['90+'] += remainingBal;
                    }

                    currentReportData.push({
                        name: supplier.name,
                        contact: supplier.contact || '-',
                        phone: supplier.phone || '-',
                        total: supplier.balance,
                        b1: buckets['0-30'],
                        b2: buckets['31-60'],
                        b3: buckets['61-90'],
                        b4: buckets['90+']
                    });
                });

                // Render Creditors Aging Table
                thead.innerHTML = `<tr>
                    <th class="p-3 text-left">Supplier</th>
                    <th class="p-3 text-right">0-30 Days</th>
                    <th class="p-3 text-right">31-60 Days</th>
                    <th class="p-3 text-right">61-90 Days</th>
                    <th class="p-3 text-right">90+ Days</th>
                    <th class="p-3 text-right">Total Due</th>
                </tr>`;

                currentReportData.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-800 text-gray-300 hover:bg-white/5";
                    tr.innerHTML = `
                        <td class="p-3 font-bold text-white">
                            ${row.name}<br>
                            <span class="text-xs text-gray-500">${row.phone}</span>
                        </td>
                        <td class="p-3 text-right ${row.b1 > 0 ? 'text-green-400' : 'text-gray-600'}">${row.b1 > 0 ? db.config.currency + row.b1.toFixed(2) : '-'}</td>
                        <td class="p-3 text-right ${row.b2 > 0 ? 'text-yellow-500' : 'text-gray-600'}">${row.b2 > 0 ? db.config.currency + row.b2.toFixed(2) : '-'}</td>
                        <td class="p-3 text-right ${row.b3 > 0 ? 'text-orange-500' : 'text-gray-600'}">${row.b3 > 0 ? db.config.currency + row.b3.toFixed(2) : '-'}</td>
                        <td class="p-3 text-right ${row.b4 > 0 ? 'text-red-500 font-bold' : 'text-gray-600'}">${row.b4 > 0 ? db.config.currency + row.b4.toFixed(2) : '-'}</td>
                        <td class="p-3 text-right font-bold text-white text-lg">${db.config.currency}${row.total.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });
                return;
            }

            // --- VAT REPORT LOGIC ---
            if (type === 'vat') {
                const sales = filteredTxns.filter(t => t.type === 'sale' && !t.isReturn);
                const returns = filteredTxns.filter(t => t.type === 'sale' && t.isReturn);

                // Calculate taxable amount (excluding VAT exempt items)
                let totalTaxable = 0;
                let totalVatExempt = 0;
                let totalVat = 0;
                let totalReturns = 0;
                let returnTax = 0;

                sales.forEach(t => {
                    let txnTaxable = 0;
                    let txnExempt = 0;

                    // Calculate taxable and exempt amounts per transaction
                    if (t.items && Array.isArray(t.items)) {
                        const priceType = t.priceType || 'retail';
                        t.items.forEach(item => {
                            const price = priceType === 'wholesale' ? (item.wholesale || item.retail) : item.retail;
                            const itemTotal = item.qty * price;

                            if (item.vatExempt) {
                                txnExempt += itemTotal;
                            } else {
                                txnTaxable += itemTotal;
                            }
                        });
                    } else {
                        // Fallback for old transactions without item-level VAT data
                        txnTaxable = t.sub || 0;
                    }

                    // Apply discount proportionally to taxable amount
                    const discount = t.discountPercent ? (txnTaxable * (t.discountPercent / 100)) : 0;
                    const taxableAfterDiscount = moneyRound(txnTaxable - discount);

                    totalTaxable = moneyRound(totalTaxable + taxableAfterDiscount);
                    totalVatExempt = moneyRound(totalVatExempt + txnExempt);

                    // Calculate VAT on taxable items only
                    const txnVat = moneyRound(taxableAfterDiscount * (db.config.vatRate / 100));
                    totalVat = moneyRound(totalVat + txnVat);
                });

                // Calculate VAT from returns
                returns.forEach(t => {
                    let txnTaxable = 0;

                    if (t.items && Array.isArray(t.items)) {
                        const priceType = t.priceType || 'retail';
                        t.items.forEach(item => {
                            if (!item.vatExempt) {
                                const price = priceType === 'wholesale' ? (item.wholesale || item.retail) : item.retail;
                                txnTaxable += item.qty * price;
                            }
                        });
                    }

                    const discount = t.discountPercent ? (txnTaxable * (t.discountPercent / 100)) : 0;
                    const taxableAfterDiscount = moneyRound(txnTaxable - discount);
                    totalReturns = moneyRound(totalReturns + Math.abs(taxableAfterDiscount));

                    const txnVat = moneyRound(taxableAfterDiscount * (db.config.vatRate / 100));
                    returnTax = moneyRound(returnTax + Math.abs(txnVat));
                });

                // Net VAT = Output VAT (from sales) - Input VAT (from purchases) - Returned VAT
                // --- NEW: Calculate Input VAT from Purchases ---
                const purchases = filteredTxns.filter(t => t.type === 'purchase');
                let inputVat = 0;
                purchases.forEach(t => {
                    let txnTaxable = 0;
                    if (t.items && Array.isArray(t.items)) {
                        t.items.forEach(item => {
                            if (!item.vatExempt) { // Assuming imports match this structure or default to taxable
                                txnTaxable += (item.qty || 1) * (item.cost || 0);
                            }
                        });
                    } else {
                        // Fallback structure
                        txnTaxable = t.total; // Default to assuming total is taxable if no item breakdown
                    }
                    // Assuming 13% for now as backward compatibility
                    const tax = moneyRound(txnTaxable * 0.13);
                    inputVat += tax;
                });

                // Net VAT = Output VAT (Sales) - Return VAT (Sales Returns) - Input VAT (Purchases)
                const netVat = moneyRound(totalVat - returnTax - inputVat);
                const totalWithVat = moneyRound(totalTaxable + totalVatExempt + totalVat);

                cards.innerHTML += createCard('Taxable Sales', totalTaxable, 'white');
                cards.innerHTML += createCard('Output VAT (Sales)', totalVat, 'karta-primary');
                if (returnTax > 0) {
                    cards.innerHTML += createCard('Less: Return VAT', returnTax, 'red-500');
                }
                cards.innerHTML += createCard('Less: Input VAT (Purch)', inputVat, 'blue-400');
                cards.innerHTML += createCard('NET VAT PAYABLE', netVat, netVat >= 0 ? 'green-400' : 'yellow-400');
                cards.innerHTML += `<div class="text-xs text-gray-400 mt-2"><i class="fa-solid fa-info-circle mr-1"></i>Note: If you have returns, they reduce VAT payable. Check the table below for details.</div>`;

                thead.innerHTML = `<tr><th class="p-3">Date</th><th class="p-3">Invoice #</th><th class="p-3">Type</th><th class="p-3 text-right">Taxable</th><th class="p-3 text-right">Exempt</th><th class="p-3 text-right">VAT</th><th class="p-3 text-right">Total</th></tr>`;

                // Display sales
                sales.forEach(t => {
                    let txnTaxable = 0;
                    let txnExempt = 0;

                    // Calculate per transaction
                    if (t.items && Array.isArray(t.items)) {
                        const priceType = t.priceType || 'retail';
                        t.items.forEach(item => {
                            const price = priceType === 'wholesale' ? (item.wholesale || item.retail) : item.retail;
                            const itemTotal = item.qty * price;

                            if (item.vatExempt) {
                                txnExempt += itemTotal;
                            } else {
                                txnTaxable += itemTotal;
                            }
                        });
                    } else {
                        txnTaxable = t.sub || 0;
                    }

                    const discount = t.discountPercent ? (txnTaxable * (t.discountPercent / 100)) : 0;
                    const taxableAfterDiscount = moneyRound(txnTaxable - discount);
                    const txnVat = moneyRound(taxableAfterDiscount * (db.config.vatRate / 100));
                    const txnTotal = moneyRound(taxableAfterDiscount + txnExempt + txnVat);

                    const tr = document.createElement('tr');
                    const typeLabel = 'SALE';
                    tr.className = `border-b border-gray-800 text-gray-300`;
                    tr.innerHTML = `
                        <td class="p-3">${window.formatDate(t.date)}</td>
                        <td class="p-3 font-mono text-xs">#${t.id.toString().slice(-6)}</td>
                        <td class="p-3 text-xs font-bold text-green-400">${typeLabel}</td>
                        <td class="p-3 text-right">${db.config.currency}${taxableAfterDiscount.toFixed(2)}</td>
                        <td class="p-3 text-right ${txnExempt > 0 ? 'text-yellow-400 font-bold' : ''}">${db.config.currency}${txnExempt.toFixed(2)}</td>
                        <td class="p-3 text-right text-karta-primary font-bold">${db.config.currency}${txnVat.toFixed(2)}</td>
                        <td class="p-3 text-right text-green-400">${db.config.currency}${txnTotal.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });

                // Display returns
                returns.forEach(t => {
                    let txnTaxable = 0;
                    let txnExempt = 0;

                    if (t.items && Array.isArray(t.items)) {
                        const priceType = t.priceType || 'retail';
                        t.items.forEach(item => {
                            const price = priceType === 'wholesale' ? (item.wholesale || item.retail) : item.retail;
                            const itemTotal = item.qty * price;

                            if (item.vatExempt) {
                                txnExempt += itemTotal;
                            } else {
                                txnTaxable += itemTotal;
                            }
                        });
                    }

                    const discount = t.discountPercent ? (txnTaxable * (t.discountPercent / 100)) : 0;
                    const taxableAfterDiscount = moneyRound(txnTaxable - discount);
                    const txnVat = moneyRound(taxableAfterDiscount * (db.config.vatRate / 100));
                    const txnTotal = moneyRound(-(taxableAfterDiscount + txnExempt + txnVat));

                    const tr = document.createElement('tr');
                    tr.className = `border-b border-gray-800 text-gray-300 bg-red-900/20`;
                    tr.innerHTML = `
                        <td class="p-3">${window.formatDate(t.date)}</td>
                        <td class="p-3 font-mono text-xs">#${t.id.toString().slice(-6)}</td>
                        <td class="p-3 text-xs font-bold text-red-400">RETURN</td>
                        <td class="p-3 text-right">${db.config.currency}${taxableAfterDiscount.toFixed(2)}</td>
                        <td class="p-3 text-right">${db.config.currency}${txnExempt.toFixed(2)}</td>
                        <td class="p-3 text-right text-red-400 font-bold">(${db.config.currency}${txnVat.toFixed(2)})</td>
                        <td class="p-3 text-right text-red-400">${db.config.currency}${txnTotal.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });

                currentReportData = sales;
                return;
            }

            // Standard Transaction Reports (Daily, Sales, Purchase, Expense)

            // Map 'sales' string to 'sale' database type
            let dbType = type;
            if (type === 'sales') dbType = 'sale';

            let total = 0;
            let reportTxns = [];

            if (type === 'daily') {
                reportTxns = filteredTxns; // Show all for daily
                thead.innerHTML = `<tr><th class="p-3">Date</th><th class="p-3">Type</th><th class="p-3">Details</th><th class="p-3 text-right">Amount</th></tr>`;
                reportTxns.forEach(t => {
                    const tr = document.createElement('tr');
                    let bgClass = '';
                    let color = 'text-green-500';
                    if (t.type === 'expense' || t.type === 'purchase' || t.type === 'asset_purchase' || t.type === 'payment_out') color = 'text-red-500';
                    if (t.isReturn) { color = 'text-orange-500'; bgClass = ' bg-red-900/20'; }
                    tr.className = `border-b border-gray-800 text-gray-300${bgClass}`;
                    let typeLabel = t.type.toUpperCase();
                    if (t.isReturn) typeLabel += ' (RETURN)';
                    if (t.type === 'asset_purchase') typeLabel = 'ASSET';
                    tr.innerHTML = `<td class="p-3">${window.formatDate(t.date)}</td><td class="p-3 uppercase text-xs font-bold">${typeLabel}</td><td class="p-3">${t.entityName || t.assetName || t.items?.[0]?.name || '-'}</td><td class="p-3 text-right ${color}">${db.config.currency}${t.total.toFixed(2)}</td>`;
                    tbody.appendChild(tr);
                });
                // Summary for daily
                const dSales = reportTxns.filter(t => t.type === 'sale').reduce((a, c) => a + c.total, 0);
                const dExp = reportTxns.filter(t => t.type === 'expense').reduce((a, c) => a + c.total, 0);
                const dPurch = reportTxns.filter(t => t.type === 'purchase').reduce((a, c) => a + c.total, 0);
                const dAsset = reportTxns.filter(t => t.type === 'asset_purchase').reduce((a, c) => a + c.total, 0);


                const dPayIn = reportTxns.filter(t => t.type === 'payment').reduce((a, c) => a + c.total, 0);
                const dPayOut = reportTxns.filter(t => t.type === 'payment_out').reduce((a, c) => a + c.total, 0);
                const dReturnOut = reportTxns.filter(t => t.type === 'return_cash_out').reduce((a, c) => a + Math.abs(c.total), 0);

                // True Cash Flow Net Change = Sales(Cash) + PayIn - Exp - Purch(Cash) - Asset(Cash) - PayOut - Returns
                // Simplified Net Change (Total Volume) = Sales + PayIn - Exp - Purch - Asset - PayOut - Returns
                const netChange = (dSales + dPayIn) - (dExp + dPurch + dAsset + dPayOut + dReturnOut);

                cards.innerHTML += createCard('Sales', dSales, 'green-400');
                if (dPayIn !== 0) cards.innerHTML += createCard('Inflows (Pay)', dPayIn, 'green-200');
                if (dPurch !== 0) cards.innerHTML += createCard('Purchases', dPurch, 'white');
                if (dAsset !== 0) cards.innerHTML += createCard('Assets', dAsset, 'purple-400');
                cards.innerHTML += createCard('Expenses', dExp, 'red-400');
                if (dPayOut !== 0) cards.innerHTML += createCard('Outflows (Pay)', dPayOut, 'red-200');
                if (dReturnOut !== 0) cards.innerHTML += createCard('Returns (Out)', dReturnOut, 'red-500');
                cards.innerHTML += createCard('Net Cash Flow', netChange, 'karta-primary');
            } else if (type === 'purchase') {
                // PURCHASE REPORT WITH DETAILED INVOICE INFORMATION
                reportTxns = filteredTxns.filter(t => t.type === dbType);

                // Summary Card
                let purchaseTotal = 0;
                let itemCount = 0;
                let totalQty = 0;
                reportTxns.forEach(t => {
                    purchaseTotal += t.total;
                    if (t.items) {
                        itemCount += t.items.length;
                        t.items.forEach(item => {
                            totalQty += (item.qty || 1);
                        });
                    }
                });
                cards.innerHTML += createCard('Total Purchases', purchaseTotal, 'karta-primary');
                cards.innerHTML += `<div class="bg-karta-surface border border-karta-border p-6 rounded-lg"><h4 class="text-gray-400 text-xs uppercase">Total Items Purchased</h4><h2 class="text-2xl font-bold text-white mt-2">${itemCount}</h2></div>`;
                cards.innerHTML += `<div class="bg-karta-surface border border-karta-border p-6 rounded-lg"><h4 class="text-gray-400 text-xs uppercase">Total Quantity</h4><h2 class="text-2xl font-bold text-white mt-2">${totalQty}</h2></div>`;
                cards.innerHTML += `<div class="bg-karta-surface border border-karta-border p-6 rounded-lg"><h4 class="text-gray-400 text-xs uppercase">Number of GRNs</h4><h2 class="text-2xl font-bold text-white mt-2">${reportTxns.length}</h2></div>`;

                // Detailed Header with all necessary columns
                thead.innerHTML = `<tr>
                    <th class="p-3">Date</th>
                    <th class="p-3">GRN #</th>
                    <th class="p-3">Supplier</th>
                    <th class="p-3">Product Name</th>
                    <th class="p-3 text-center">Qty</th>
                    <th class="p-3 text-right">Unit Price</th>
                    <th class="p-3 text-right">Line Total</th>
                    <th class="p-3 text-center">VAT</th>
                    <th class="p-3 text-right">Invoice Total</th>
                    <th class="p-3 text-center">Payment</th>
                </tr>`;

                reportTxns.forEach(t => {
                    if (t.items && t.items.length > 0) {
                        let firstRow = true;
                        t.items.forEach((item, idx) => {
                            const tr = document.createElement('tr');
                            tr.className = "border-b border-gray-800 text-gray-300";

                            const itemCost = item.unitPrice || item.cost || 0;
                            const itemQty = item.qty || 1;
                            const lineTotal = moneyRound(itemQty * itemCost);
                            const vatStatus = item.vatStatus || 'vat';

                            if (firstRow) {
                                // Show transaction-level info only on first row
                                tr.innerHTML = `
                                    <td class="p-3 text-gray-400 text-sm">${new Date(t.date).toLocaleDateString()}</td>
                                    <td class="p-3 font-mono font-bold text-karta-primary text-sm">#${t.id.toString().slice(-6)}</td>
                                    <td class="p-3 font-bold text-white text-sm">${t.entityName || '-'}</td>
                                    <td class="p-3 text-sm">${item.productName || item.name || '-'}</td>
                                    <td class="p-3 text-center text-white font-bold text-sm">${itemQty}</td>
                                    <td class="p-3 text-right text-gray-300 text-sm font-medium">${db.config.currency}${itemCost.toFixed(2)}</td>
                                    <td class="p-3 text-right text-green-400 font-bold text-sm">${db.config.currency}${lineTotal.toFixed(2)}</td>
                                    <td class="p-3 text-center"><span class="px-2 py-0.5 rounded text-xs font-bold ${vatStatus === 'exempt' ? 'bg-red-900/40 text-red-300' : 'bg-green-900/40 text-green-300'}">${vatStatus === 'exempt' ? 'EXEMPT' : 'VAT'}</span></td>
                                    <td class="p-3 text-right font-bold text-karta-primary text-sm">${db.config.currency}${t.total.toFixed(2)}</td>
                                    <td class="p-3 text-center"><span class="px-2 py-0.5 rounded text-xs font-bold ${t.payType === 'credit' ? 'bg-yellow-900/40 text-yellow-300' : 'bg-green-900/40 text-green-300'}">${t.payType || 'CASH'}</span></td>
                                `;
                                firstRow = false;
                            } else {
                                // Additional items in same purchase
                                tr.innerHTML = `
                                    <td colspan="2"></td>
                                    <td></td>
                                    <td class="p-3 text-sm">${item.productName || item.name || '-'}</td>
                                    <td class="p-3 text-center text-white font-bold text-sm">${itemQty}</td>
                                    <td class="p-3 text-right text-gray-300 text-sm font-medium">${db.config.currency}${itemCost.toFixed(2)}</td>
                                    <td class="p-3 text-right text-green-400 font-bold text-sm">${db.config.currency}${lineTotal.toFixed(2)}</td>
                                    <td class="p-3 text-center"><span class="px-2 py-0.5 rounded text-xs font-bold ${vatStatus === 'exempt' ? 'bg-red-900/40 text-red-300' : 'bg-green-900/40 text-green-300'}">${vatStatus === 'exempt' ? 'EXEMPT' : 'VAT'}</span></td>
                                    <td colspan="2"></td>
                                `;
                            }

                            tr.style.backgroundColor = firstRow ? '' : 'rgba(255,255,255,0.02)';
                            tbody.appendChild(tr);
                        });
                    } else {
                        // Purchase with no items (older format)
                        const tr = document.createElement('tr');
                        tr.className = "border-b border-gray-800 text-gray-300";
                        tr.innerHTML = `
                            <td class="p-3 text-gray-400 text-sm">${new Date(t.date).toLocaleDateString()}</td>
                            <td class="p-3 font-mono font-bold text-karta-primary text-sm">#${t.id.toString().slice(-6)}</td>
                            <td class="p-3 font-bold text-white text-sm">${t.entityName || '-'}</td>
                            <td class="p-3 text-gray-500 text-sm">-</td>
                            <td class="p-3 text-center text-sm">-</td>
                            <td class="p-3 text-right text-sm">-</td>
                            <td class="p-3 text-right text-sm">-</td>
                            <td class="p-3 text-center text-sm">-</td>
                            <td class="p-3 text-right font-bold text-karta-primary text-sm">${db.config.currency}${t.total.toFixed(2)}</td>
                            <td class="p-3 text-center"><span class="px-2 py-0.5 rounded text-xs font-bold ${t.payType === 'credit' ? 'bg-yellow-900/40 text-yellow-300' : 'bg-green-900/40 text-green-300'}">${t.payType || 'CASH'}</span></td>
                        `;
                        tbody.appendChild(tr);
                    }
                });
            } else {
                // Filter specific type (sales, expense, etc.)
                reportTxns = filteredTxns.filter(t => t.type === dbType);

                // Add Action Header for Sales/Invoices/Expenses
                thead.innerHTML = `<tr><th class="p-3">Date</th><th class="p-3">Entity/Ref</th><th class="p-3 text-right">Amount</th><th class="p-3 text-center">Action</th></tr>`;

                reportTxns.forEach(t => {
                    total += t.total;
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-800 text-gray-300";

                    // Action Button Logic
                    let actionBtn = '';
                    if (t.type === 'sale') {
                        actionBtn = `<button onclick='printInvoiceStr(${JSON.stringify(t)})' class="text-gray-400 hover:text-white" title="Print/Export Invoice"><i class="fa-solid fa-print"></i></button>`;
                    } else if (t.type === 'expense') {
                        actionBtn = `<button onclick='deleteExpense(${t.id})' class="text-red-400 hover:text-red-300" title="Delete Expense"><i class="fa-solid fa-trash"></i></button>`;
                    }

                    tr.innerHTML = `
                        <td class="p-3">${window.formatDate(t.date)}</td>
                        <td class="p-3">${t.entityName || t.description || '-'}</td>
                        <td class="p-3 text-right">${db.config.currency}${t.total.toFixed(2)}</td>
                        <td class="p-3 text-center">${actionBtn}</td>
                    `;
                    tbody.appendChild(tr);
                });
                cards.innerHTML += createCard(`Total ${type}`, total, 'karta-primary');
            }

            // Save for export
            currentReportData = reportTxns;
        }

        // --- DATA INTEGRITY CHECKER (Run silently on load) ---
        function verifyAccountingIntegrity() {
            // This function checks for broken references and missing fields
            const issues = [];

            if (!db.transactions) db.transactions = [];
            if (!db.customers) db.customers = [];
            if (!db.suppliers) db.suppliers = [];
            if (!db.products) db.products = [];

            // Verify each transaction
            db.transactions.forEach(t => {
                // Check for missing required fields
                if (!t.id) issues.push(`Transaction missing ID`);
                if (!t.type) issues.push(`Transaction ${t.id} missing type`);
                if (t.total === undefined) issues.push(`Transaction ${t.id} missing total`);

                // Check customer references
                if (t.entityId && t.type === 'sale') {
                    const cust = db.customers.find(c => c.id === t.entityId);
                    if (!cust && t.entityId !== 'walk-in') {
                        issues.push(`Sale ${t.id} references missing customer ${t.entityId}`);
                    }
                }

                // Check supplier references
                if (t.entityId && (t.type === 'purchase' || t.type === 'payment_out')) {
                    const sup = db.suppliers.find(s => s.id === t.entityId);
                    if (!sup) {
                        issues.push(`Purchase ${t.id} references missing supplier ${t.entityId}`);
                    }
                }

                // Verify split payments sum to total
                if (t.payType === 'split' && t.type === 'sale') {
                    const splitSum = (t.splitCash || 0) + (t.splitBank || 0) + (t.splitCredit || 0);
                    if (Math.abs(splitSum - t.total) > 0.01) {
                        issues.push(`Sale ${t.id} split payments (${splitSum}) don't sum to total (${t.total})`);
                    }
                }

                // Check cash/bank balance tracking fields
                if (t.type === 'sale' || t.type === 'purchase' || t.type === 'expense' || t.type === 'payment') {
                    if (t.cashBalance === undefined && (t.payType === 'cash' || t.payType === 'split')) {
                        // Not critical, but worth noting
                    }
                }
            });

            // Log issues (silently - don't break the app)
            if (issues.length > 0) {
                console.warn('DATA INTEGRITY WARNINGS:', issues);
            }

            return issues.length === 0;
        };

        // --- Subscription Enforcement ---
        function checkSubscriptionStatus() {
            // Skip if no config or no expiry set (lifetime)
            if (!db.config || !db.config.expiryDate) return;

            const expiry = new Date(db.config.expiryDate);
            const now = new Date();
            // Reset time part to ensure accurate day comparison
            expiry.setHours(23, 59, 59, 999);

            const diffTime = expiry - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            // Remove existing lock screen if valid
            const existingLock = document.getElementById('subscription-lock-screen');

            if (diffDays < 0) {
                // EXPIRED
                if (!existingLock) {
                    const lockScreen = document.createElement('div');
                    lockScreen.id = 'subscription-lock-screen';
                    lockScreen.className = 'fixed inset-0 bg-black/95 z-[9999] flex items-center justify-center p-4';
                    lockScreen.innerHTML = `
                        <div class="bg-gray-900 border border-red-600 rounded-lg p-8 max-w-md w-full text-center shadow-2xl shadow-red-900/50">
                            <div class="w-20 h-20 bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fa-solid fa-lock text-4xl text-red-500"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-white mb-2">Subscription Expired</h2>
                            <p class="text-gray-400 mb-6">Your license for Karta expired on <span class="text-red-400 font-mono">${expiry.toLocaleDateString()}</span>.</p>
                            <div class="bg-red-900/20 rounded p-4 mb-6 border border-red-800/50">
                                <p class="text-xs text-red-300">Please contact the administrator to renew your subscription and restore access.</p>
                            </div>
                            <button onclick="location.reload()" class="w-full bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 rounded border border-gray-600 transition">
                                <i class="fa-solid fa-rotate-right mr-2"></i>Refresh Status
                            </button>
                            <div class="mt-6 text-xs text-gray-600">
                                ID: <span class="font-mono">${currentUser ? currentUser.uid.slice(0, 8) : 'Unknown'}</span>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(lockScreen);
                }
            } else {
                // VALID - Remove lock if it exists (e.g. after renewal sync)
                if (existingLock) existingLock.remove();

                // Show warning if expiring soon (optional)
                // if (diffDays <= 7) { ... }
            }
        }

        // --- XSS Protection - escape HTML entities ---
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // --- Global Announcement Check (Real-time) ---
        let announcementUnsubscribe = null;

        function initAnnouncementListener() {
            // Only check if firebase available and user logged in (implicit)
            if (!dbRealtime) return;

            // Unsubscribe from previous listener if exists
            if (announcementUnsubscribe) {
                announcementUnsubscribe();
            }

            const annRef = query(ref(dbRealtime, 'announcements'), limitToLast(1));

            // Set up real-time listener - updates automatically when data changes
            announcementUnsubscribe = onValue(annRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const ann = Object.values(data)[0]; // Get the single latest

                    // Check if dismissed
                    const dismissedId = localStorage.getItem('dismissedAnnouncement');
                    if (dismissedId === ann.id) {
                        // Still dismissed - ensure banner is removed
                        const existingBanner = document.getElementById('announcement-banner');
                        if (existingBanner) existingBanner.remove();
                        return;
                    }

                    // Remove existing banner if any (e.g. replacing old one)
                    const existingBanner = document.getElementById('announcement-banner');
                    if (existingBanner) existingBanner.remove();

                    // Create Banner
                    const colorClass = ann.type === 'urgent' ? 'bg-red-600' : (ann.type === 'warning' ? 'bg-orange-600' : 'bg-blue-600');
                    const banner = document.createElement('div');
                    banner.id = 'announcement-banner';
                    banner.className = `${colorClass} text-white px-4 py-3 text-center text-sm font-bold relative z-[9999] shadow-lg flex items-center justify-center gap-3`;
                    banner.innerHTML = `
                        <span>
                            <i class="fa-solid fa-bullhorn mr-2"></i>
                            ${escapeHtml(ann.message)}
                        </span>
                        <button onclick="dismissAnnouncement('${ann.id}')" class="bg-black/20 hover:bg-black/40 text-white rounded-full w-6 h-6 flex items-center justify-center ml-4 transition">
                            <i class="fa-solid fa-times text-xs"></i>
                        </button>
                    `;

                    // Prepend to body
                    document.body.prepend(banner);
                } else {
                    // No active announcements, ensure banner removed
                    const existingBanner = document.getElementById('announcement-banner');
                    if (existingBanner) existingBanner.remove();
                }
            }, (error) => {
                // Suppress permission denied errors which happen before auth is ready
                if (error.code && error.code.includes('PERMISSION_DENIED')) {
                    // console.debug('Waiting for permissions...');
                    return;
                }
                console.error('Announcement listener error:', error);
            });
        }

        // Keep legacy function name for compatibility
        function checkAnnouncements() {
            initAnnouncementListener();
        }

        window.dismissAnnouncement = (id) => {
            localStorage.setItem('dismissedAnnouncement', id);
            const banner = document.getElementById('announcement-banner');
            if (banner) banner.remove();
        };

        // --- Global Refresh ---
        function refreshUI() {
            // 0a. Check Announcements
            checkAnnouncements();

            // 0b. Check Subscription Status First
            checkSubscriptionStatus();

            // Run data migration on load
            migrateProductIds();

            // Run integrity check (non-blocking)
            verifyAccountingIntegrity();

            // Update only visible sections to improve speed
            const currentSection = document.querySelector('main section:not(.hidden)');
            const sectionId = currentSection ? currentSection.id : '';

            // Always refresh core sections
            renderProducts();
            renderCustomers();
            renderSuppliers();
            renderSuppliers();
            loadSettings();

            // Update Date Mode Visibility
            if (window.updateDateModeVisibility) window.updateDateModeVisibility();

            // Update Dashboard if visible
            if (!sectionId || sectionId === 'dashboard') {
                loadDashboard();
            }

            // Ensure array exists before filtering
            const txns = db.transactions || [];

            // Populate Purch History (Last 5)
            const ph = document.getElementById('purchHistory');
            if (ph) {
                ph.innerHTML = '';
                txns.filter(t => t.type === 'purchase').slice().reverse().slice(0, 5).forEach(t => {
                    ph.innerHTML += `<div class="p-3 bg-white/5 rounded flex justify-between"><div><div class="font-bold text-white text-sm">${t.entityName}</div><div class="text-xs text-gray-500">${window.formatDate(t.date)}</div></div><div class="text-red-400 font-bold text-sm">-${t.total.toFixed(2)}</div></div>`;
                });
            }

            // Populate Expense History (Last 5)
            const eh = document.getElementById('expHistory');
            if (eh) {
                eh.innerHTML = '';
                txns.filter(t => t.type === 'expense').slice().reverse().slice(0, 5).forEach(t => {
                    eh.innerHTML += `<div class="p-3 bg-white/5 rounded flex justify-between"><div><div class="font-bold text-white text-sm">${t.items?.[0]?.name || 'Expense'}</div><div class="text-xs text-gray-500">${window.formatDate(t.date)}</div></div><div class="text-red-400 font-bold text-sm">-${t.total.toFixed(2)}</div></div>`;
                });
            }

            // Populate Asset History (Call render function)
            if (window.renderAssets) window.renderAssets();
        }

        // --- PRICE MANAGEMENT FUNCTIONS ---

        // Initialize price manager modal when opened
        function loadPriceManagerData() {
            // Populate product list for individual adjustment
            const prodSel = document.getElementById('priceProductSelect');
            prodSel.innerHTML = '<option value="">-- Select Product --</option>';
            if (db.products) {
                db.products.forEach(p => {
                    prodSel.innerHTML += `<option value="${p.id}" data-name="${p.name}|${p.cost}|${p.retail}|${p.wholesale}">${p.name} (${p.sku})</option>`;
                });
            }
        }

        window.loadProductPriceFields = function () {
            const prodSel = document.getElementById('priceProductSelect');
            const selectedOption = prodSel.options[prodSel.selectedIndex];

            if (!selectedOption.value) {
                document.getElementById('priceProductCost').value = '';
                document.getElementById('priceProductRetail').value = '';
                document.getElementById('priceProductWholesale').value = '';
                document.getElementById('profitMarginDisplay').innerText = '--';
                return;
            }

            const prod = db.products.find(p => p.id === parseInt(prodSel.value));
            if (prod) {
                document.getElementById('priceProductCost').value = prod.cost.toFixed(2);
                document.getElementById('priceProductRetail').value = prod.retail.toFixed(2);
                document.getElementById('priceProductWholesale').value = (prod.wholesale || 0).toFixed(2);

                // Calculate margin (guard against division by zero)
                const retailVal = parseFloat(prod.retail) || 0;
                if (retailVal > 0) {
                    const margin = moneyRound((retailVal - (parseFloat(prod.cost) || 0)) / retailVal * 100);
                    document.getElementById('profitMarginDisplay').innerText = margin.toFixed(1) + '%';
                } else {
                    document.getElementById('profitMarginDisplay').innerText = '--';
                }

                // Setup real-time margin calculation (use oninput to avoid duplicate listeners)
                document.getElementById('priceProductRetail').oninput = function () {
                    const cost = parseFloat(document.getElementById('priceProductCost').value) || 0;
                    const retail = parseFloat(this.value) || 0;
                    if (retail > 0) {
                        const m = ((retail - cost) / retail * 100);
                        document.getElementById('profitMarginDisplay').innerText = moneyRound(m).toFixed(1) + '%';
                    } else {
                        document.getElementById('profitMarginDisplay').innerText = '--';
                    }
                };
            }
        }

        window.updateIndividualProductPrice = function () {
            const prodId = parseInt(document.getElementById('priceProductSelect').value);
            const cost = moneyRound(parseFloat(document.getElementById('priceProductCost').value));
            const retail = moneyRound(parseFloat(document.getElementById('priceProductRetail').value));
            const wholesale = moneyRound(parseFloat(document.getElementById('priceProductWholesale').value) || 0);

            if (!prodId || !retail) return alert("Please select product and enter retail price");

            const prod = db.products.find(p => p.id === prodId);
            if (prod) {
                const oldRetail = prod.retail;
                const oldCost = prod.cost;

                prod.cost = cost;
                prod.retail = retail;
                prod.wholesale = wholesale;

                saveDB();
                renderProducts();

                alert(`✅ Price Updated!\n${prod.name}\n\nCost: ${db.config.currency}${oldCost.toFixed(2)} → ${db.config.currency}${cost.toFixed(2)}\nRetail: ${db.config.currency}${oldRetail.toFixed(2)} → ${db.config.currency}${retail.toFixed(2)}`);

                // Reload fields
                loadProductPriceFields();
            }
        }

        // Individual product update handlers remain

        // --- Init ---
        document.getElementById('invSearch').addEventListener('input', renderProducts);
        document.getElementById('posSearch').addEventListener('input', loadPOS);
        document.getElementById('custSearch').addEventListener('input', renderCustomers);
        document.getElementById('supSearch').addEventListener('input', renderSuppliers);

        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
            document.getElementById('date').innerText = window.formatDate(new Date().toISOString());
        }, 1000);

        window.onload = () => {
            refreshUI();
            nav('dashboard');
        };

        // ===== ADDITIONAL PROTECTION LAYER (Non-Blocking) =====
        window.addEventListener('load', function () {
            // Prevent iframe breaking out
            if (window.self !== window.top) {
                window.top.location = window.self.location;
            }

            // Monitor for injected content
            const observer = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if (mutation.addedNodes.length > 0) {
                        mutation.addedNodes.forEach(function (node) {
                            if (node.nodeType === 1) { // Element node
                                // Check for injected scripts from external sources
                                if (node.tagName === 'SCRIPT' && node.src && !node.src.includes(window.location.hostname) && !node.src.includes('cdn') && !node.src.includes('jsDelivr')) {
                                    originalConsole.warn('Security: Potential script injection detected');
                                    node.remove();
                                }
                            }
                        });
                    }
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: false,
                attributes: false
            });
        });

        // Monitor for source map attacks
        window.addEventListener('error', function (e) {
            // Just log errors, don't put application code here
            if (e.message && e.message.includes('sourceMap')) {
                console.warn('Source map error detected');
            }
        });

        // --- CREDIT SETTLEMENT FUNCTIONS ---
        let currentSettlementData = null;

        window.loadSettlementEntities = function () {
            const type = document.querySelector('input[name="settlementType"]:checked').value;
            const entitySelect = document.getElementById('settlementEntity');
            entitySelect.innerHTML = '<option value="">-- Choose --</option>';

            // Clear Invoice Dropdown
            const invoiceSelect = document.getElementById('settlementInvoice');
            if (invoiceSelect) invoiceSelect.innerHTML = '<option value="">-- General Payment (FIFO) --</option>';

            // Set default date to today
            const dp = document.getElementById('settlementDate');
            if (dp) dp.value = new Date().toISOString().split('T')[0];

            if (type === 'customer') {
                if (!db.customers) db.customers = [];
                db.customers.filter(c => c.balance > 0).forEach(c => {
                    entitySelect.innerHTML += `<option value="${c.id}|${c.name}|${c.balance}">${c.name} (Due: ${db.config.currency}${c.balance.toFixed(2)})</option>`;
                });
            } else {
                if (!db.suppliers) db.suppliers = [];
                db.suppliers.filter(s => s.balance > 0).forEach(s => {
                    entitySelect.innerHTML += `<option value="${s.id}|${s.name}|${s.balance}">${s.name} (Due: ${db.config.currency}${s.balance.toFixed(2)})</option>`;
                });
            }
        };

        window.loadSettlementInvoices = function () {
            const entityOption = document.getElementById('settlementEntity').value;
            const invoiceSelect = document.getElementById('settlementInvoice');
            if (!invoiceSelect) return;

            invoiceSelect.innerHTML = '<option value="">-- General Payment (FIFO) --</option>';

            if (!entityOption) return;

            const [id, name, balance] = entityOption.split('|');
            const entityId = parseInt(id);
            const type = document.querySelector('input[name="settlementType"]:checked').value;

            // Find unpaid or partially paid sales/purchases for this entity
            const txns = (db.transactions || []).filter(t =>
                t.entityId === entityId &&
                ((type === 'customer' && t.type === 'sale') || (type === 'supplier' && t.type === 'purchase')) &&
                (t.payType === 'credit' || t.payType === 'split')
            );

            // Calculate remaining due for each invoice
            // Note: This needs to account for previous settlements linked to specific invoices
            // For now, simpler approach: Just show recent credit transactions
            // Ideally, we sum up all linked payments for each invoice.

            txns.sort((a, b) => new Date(b.date) - new Date(a.date)); // Newest first

            txns.forEach(t => {
                // Determine how much is already paid off specifically for this invoice
                // Use loose equality (==) for ID to handle string/number mismatch potentially
                const alreadyPaid = (db.settlements || []).filter(s => s.linkedInvoiceId == t.id).reduce((sum, s) => sum + s.settlementAmount, 0);

                // Also consider split payment initial cash
                const initialPaid = (t.payType === 'split') ? ((t.cashAmount || 0) + (t.bankAmount || 0)) : 0;

                // For 'cash' invoices (should be filtered out, but just in case)
                if (t.payType === 'cash') return;

                const totalDue = t.total - initialPaid - alreadyPaid;

                // Strict check: Must be greater than 0.1 (floating point epsilon)
                if (totalDue > 0.1) {
                    const dateStr = window.formatDate(t.date);
                    const invoiceNum = t.invoiceNumber || t.ref || t.id.toString().slice(-6);
                    invoiceSelect.innerHTML += `<option value="${t.id}|${totalDue}">${dateStr} - #${invoiceNum} (Due: ${db.config.currency}${totalDue.toFixed(2)})</option>`;
                }
            });
        };

        window.updateSettlementAmountFromInvoice = function () {
            const invoiceOption = document.getElementById('settlementInvoice').value;
            if (!invoiceOption) return; // Don't reset if they choose General, let them type

            const [invId, dueAmount] = invoiceOption.split('|');
            const amount = parseFloat(dueAmount);

            document.getElementById('settlementAmount').value = amount.toFixed(2);
            updateSettlementDisplay();
        };

        window.updateSettlementAmount = function () {
            const entityOption = document.getElementById('settlementEntity').value;

            // Trigger invoice load
            window.loadSettlementInvoices();

            if (!entityOption) {
                document.getElementById('settlementDueAmount').innerText = '$0.00';
                document.getElementById('settlementAmount').value = '';
                return;
            }

            const [id, name, balance] = entityOption.split('|');
            const balanceAmount = parseFloat(balance) || 0;
            document.getElementById('settlementDueAmount').innerText = `${db.config.currency}${balanceAmount.toFixed(2)}`;
            // document.getElementById('settlementAmount').max = balanceAmount; // Don't restrict, can overpay
            document.getElementById('settlementAmount').value = balanceAmount;
            updateSettlementDisplay();
        };

        window.updateSettlementDisplay = function () {
            const amount = parseFloat(document.getElementById('settlementAmount').value) || 0;
            document.getElementById('settlementDisplayAmount').innerText = `${db.config.currency}${amount.toFixed(2)}`;
        };

        window.toggleChequeInput = function () {
            const paymentMethod = document.querySelector('input[name="settlementPayment"]:checked').value;
            const chequeDiv = document.getElementById('chequeDetailsDiv');

            if (paymentMethod === 'bank') {
                chequeDiv.classList.remove('hidden');
            } else {
                chequeDiv.classList.add('hidden');
            }
        };

        document.getElementById('settlementForm').onsubmit = function (e) {
            e.preventDefault();

            const type = document.querySelector('input[name="settlementType"]:checked').value;
            const entityOption = document.getElementById('settlementEntity').value;
            const amount = parseFloat(document.getElementById('settlementAmount').value);
            const paymentMethod = document.querySelector('input[name="settlementPayment"]:checked').value;
            const chequeNo = document.getElementById('settlementChequeNo').value;
            const chequeDate = document.getElementById('settlementChequeDate').value;
            const bankName = document.getElementById('settlementBankName').value;
            const notes = document.getElementById('settlementNotes').value;

            // NEW: Invoice Linking and Date
            const invoiceOption = document.getElementById('settlementInvoice') ? document.getElementById('settlementInvoice').value : null;
            let linkedInvoiceId = null;
            if (invoiceOption) {
                const [invId, invAmt] = invoiceOption.split('|');
                linkedInvoiceId = parseInt(invId);
            }

            const dateInput = document.getElementById('settlementDate') ? document.getElementById('settlementDate').value : null;
            // Use manual date if provided, otherwise 'now'
            // If manual date is just YYYY-MM-DD, append current time to keep sorting roughly correct or just use 00:00
            const settlementDate = dateInput ? new Date(dateInput + 'T12:00:00').toISOString() : new Date().toISOString();


            if (!entityOption || !amount) {
                alert('Please select entity and amount');
                return;
            }

            const [id, name, balance] = entityOption.split('|');
            const entityId = parseInt(id);

            if (paymentMethod === 'bank' && !chequeNo && !bankName) {
                alert('Please provide Cheque Number or Bank Name for bank payment');
                return;
            }

            // Create settlement record
            if (!db.settlements) db.settlements = [];

            // CRITICAL: Initialize config and balances if they don't exist
            if (!db.config) db.config = APP_STATE.config;
            if (db.config.cashBalance === undefined || db.config.cashBalance === null) db.config.cashBalance = 0;
            if (db.config.bankBalance === undefined || db.config.bankBalance === null) db.config.bankBalance = 0;

            console.log(`INITIAL db.config:`, JSON.stringify(db.config));

            const settlement = {
                id: Date.now(),
                date: settlementDate,
                type: type,
                entityId: entityId,
                entityName: name,
                dueAmount: parseFloat(balance),
                settlementAmount: moneyRound(amount),
                paymentMethod: paymentMethod,
                chequeNo: chequeNo || null,
                chequeDate: chequeDate || null,
                bankName: bankName || null,
                notes: notes,
                status: 'settled',
                linkedInvoiceId: linkedInvoiceId // Save linked invoice
            };

            db.settlements.push(settlement);

            // Update customer/supplier balance
            if (type === 'customer') {
                const cust = db.customers.find(c => c.id === entityId);
                if (cust) {
                    cust.balance = moneyRound(cust.balance - amount);
                }
            } else {
                const sup = db.suppliers.find(s => s.id === entityId);
                if (sup) {
                    sup.balance = moneyRound(sup.balance - amount);
                }
            }

            // Update cash/bank balance based on payment method and settlement type
            console.log(`DEBUG: type=${type}, paymentMethod=${paymentMethod}, amount=${amount}`);
            console.log(`BEFORE Settlement: Cash=${db.config.cashBalance}, Bank=${db.config.bankBalance}, Type of Cash=${typeof db.config.cashBalance}`);

            let balanceChanged = false;

            if (paymentMethod === 'cash') {
                if (type === 'customer') {
                    // Customer settlement in cash: INCREASE cash (customer paying us)
                    const newCash = db.config.cashBalance + amount;
                    db.config.cashBalance = moneyRound(newCash);
                    balanceChanged = true;
                    console.log(`Customer CASH settlement: +${amount}, Calculation: ${db.config.cashBalance} + ${amount} = ${newCash}, Rounded: ${db.config.cashBalance}`);
                } else {
                    // Supplier settlement in cash: DECREASE cash (we paying supplier)
                    const newCash = db.config.cashBalance - amount;
                    db.config.cashBalance = moneyRound(newCash);
                    balanceChanged = true;
                    console.log(`Supplier CASH settlement: -${amount}, Calculation: ${db.config.cashBalance} - ${amount} = ${newCash}, Rounded: ${db.config.cashBalance}`);
                }
            } else if (paymentMethod === 'bank') {
                if (type === 'customer') {
                    // Customer settlement in bank: INCREASE bank (customer paying us)
                    const newBank = db.config.bankBalance + amount;
                    db.config.bankBalance = moneyRound(newBank);
                    balanceChanged = true;
                    console.log(`Customer BANK settlement: +${amount}, Calculation: ${db.config.bankBalance} + ${amount} = ${newBank}, Rounded: ${db.config.bankBalance}`);
                } else {
                    // Supplier settlement in bank: DECREASE bank (we paying supplier)
                    const newBank = db.config.bankBalance - amount;
                    db.config.bankBalance = moneyRound(newBank);
                    balanceChanged = true;
                    console.log(`Supplier BANK settlement: -${amount}, Calculation: ${db.config.bankBalance} - ${amount} = ${newBank}, Rounded: ${db.config.bankBalance}`);
                }
            }

            if (!balanceChanged) {
                console.warn(`WARNING: Balance was NOT changed! type=${type}, paymentMethod=${paymentMethod}`);
            }

            console.log(`AFTER Settlement: Cash=${db.config.cashBalance}, Bank=${db.config.bankBalance}`);

            // Record transaction
            if (!db.transactions) db.transactions = [];
            db.transactions.push({
                id: Date.now(),
                type: type === 'customer' ? 'payment' : 'payment_out',
                date: settlementDate, // Use manual date
                entityId: entityId,
                entityName: name,
                items: [],
                total: amount,
                paymentMethod: paymentMethod,
                chequeNo: chequeNo,
                settlementId: settlement.id,
                cashBalance: db.config.cashBalance,
                bankBalance: db.config.bankBalance,
                linkedInvoiceId: linkedInvoiceId // Save linked invoice to txn too
            });

            saveDB();
            console.log(`SAVED db.config.cashBalance=${db.config.cashBalance}, db.config.bankBalance=${db.config.bankBalance}`);
            window.closeModal();
            alert(`Settlement Recorded\nEntity: ${name}\nAmount: ${db.config.currency}${amount.toFixed(2)}\nMethod: ${paymentMethod.toUpperCase()}${chequeNo ? '\nCheque: ' + chequeNo : ''}\n\nCash: ${db.config.currency}${db.config.cashBalance.toFixed(2)}\nBank: ${db.config.currency}${db.config.bankBalance.toFixed(2)}`);
            renderSettlements();
            loadDashboard();
            refreshUI();
        };

        // --- EXPENSE FORM HANDLER ---
        const expForm = document.getElementById('expForm');
        if (expForm) {
            expForm.onsubmit = function (e) {
                e.preventDefault();

                const desc = document.getElementById('expDesc').value;
                const amount = parseFloat(document.getElementById('expAmt').value);
                const paymentMethod = document.querySelector('input[name="expPayment"]:checked').value;

                if (!desc || !amount) {
                    alert('Please fill in all required fields');
                    return;
                }

                // Update Balance
                if (paymentMethod === 'cash') {
                    db.config.cashBalance = moneyRound(db.config.cashBalance - amount);
                } else {
                    db.config.bankBalance = moneyRound(db.config.bankBalance - amount);
                }

                // Record Transaction
                const expenseTxn = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    type: 'expense',
                    entityName: desc, // Using entityName to store description
                    category: 'General', // Default category
                    items: [{ name: desc, qty: 1, cost: amount, total: amount }],
                    total: amount,
                    payType: paymentMethod,
                    cashBalance: db.config.cashBalance,
                    bankBalance: db.config.bankBalance
                };

                if (!db.transactions) db.transactions = [];
                db.transactions.push(expenseTxn);

                saveDB();
                window.closeModal();
                alert('Expense Recorded Successfully');
                refreshUI();

                // Reset form
                expForm.reset();
            };
        }

        // --- DELETE EXPENSE FUNCTION ---
        window.deleteExpense = function (id) {
            if (!confirm('Are you sure you want to delete this expense?')) return;

            const idx = db.transactions.findIndex(t => t.id === id);
            if (idx === -1) return;

            const t = db.transactions[idx];

            // Refund Amount (Reverse the expense)
            if (t.payType === 'cash') {
                db.config.cashBalance = moneyRound(db.config.cashBalance + t.total);
            } else {
                db.config.bankBalance = moneyRound(db.config.bankBalance + t.total);
            }

            db.transactions.splice(idx, 1);
            saveDB();
            alert('Expense deleted and amount refunded to ' + t.payType.toUpperCase());
            refreshUI();
        };

        // --- ASSET PURCHASE FORM HANDLER ---
        const assetForm = document.getElementById('assetForm');
        if (assetForm) {
            assetForm.onsubmit = function (e) {
                e.preventDefault();

                const assetName = document.getElementById('assetName').value.trim();
                const assetType = document.getElementById('assetType').value;
                const cost = parseFloat(document.getElementById('assetCost').value);
                const paymentMethod = document.querySelector('input[name="assetPayment"]:checked').value;
                const supplier = document.getElementById('assetSupplier').value.trim();
                const description = document.getElementById('assetDescription').value.trim();

                if (!assetName || !assetType || !cost) {
                    alert('Please fill in all required fields');
                    return;
                }

                // Update Balance
                if (paymentMethod === 'cash') {
                    if (db.config.cashBalance < cost) {
                        if (!confirm(`Insufficient cash balance (${db.config.currency}${db.config.cashBalance.toFixed(2)}). Continue anyway?`)) {
                            return;
                        }
                    }
                    db.config.cashBalance = moneyRound(db.config.cashBalance - cost);
                } else if (paymentMethod === 'bank') {
                    if (db.config.bankBalance < cost) {
                        if (!confirm(`Insufficient bank balance (${db.config.currency}${db.config.bankBalance.toFixed(2)}). Continue anyway?`)) {
                            return;
                        }
                    }
                    db.config.bankBalance = moneyRound(db.config.bankBalance - cost);
                }
                // For credit, no immediate balance change

                // Record Asset
                const assetObj = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    assetName: assetName,
                    assetType: assetType,
                    cost: cost,
                    payType: paymentMethod,
                    supplierName: supplier || 'N/A',
                    description: description || '',
                    cashBalance: db.config.cashBalance,
                    bankBalance: db.config.bankBalance
                };

                if (!db.assets) db.assets = [];
                db.assets.push(assetObj);

                // Also create a transaction for journal purposes
                const assetTxn = {
                    id: Date.now() + 1, // Slightly different ID
                    date: new Date().toISOString(),
                    type: 'asset_purchase',
                    assetName: assetName,
                    assetType: assetType,
                    total: cost,
                    payType: paymentMethod,
                    supplierName: supplier || 'N/A',
                    description: description || '',
                    cashBalance: db.config.cashBalance,
                    bankBalance: db.config.bankBalance
                };

                if (!db.transactions) db.transactions = [];
                db.transactions.push(assetTxn);

                saveDB();
                window.closeModal();
                alert(`Asset "${assetName}" purchased successfully for ${db.config.currency}${cost.toFixed(2)}`);
                refreshUI();

                // Reset form
                assetForm.reset();
            };
        }

        // --- RENDER ASSETS FUNCTION ---
        window.renderAssets = function () {
            const container = document.getElementById('assetHistory');
            if (!container) return;

            if (!db.assets || db.assets.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-xs text-center py-4">No assets purchased yet</p>';
                return;
            }

            let html = '';
            db.assets.slice().reverse().forEach(asset => {
                const typeLabels = {
                    'furniture': 'Furniture',
                    'equipment': 'Equipment',
                    'vehicle': 'Vehicle',
                    'building': 'Property',
                    'computer': 'IT Equipment',
                    'other': 'Other'
                };
                const typeLabel = typeLabels[asset.assetType] || asset.assetType;

                html += `
                        <div class="bg-gray-800 border border-gray-700 rounded p-3 hover:bg-gray-750 transition">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <h5 class="font-bold text-white text-sm">${asset.assetName}</h5>
                                    <p class="text-xs text-gray-400">${typeLabel} | ${window.formatDate(asset.date)}</p>
                                </div>
                                <button onclick="deleteAsset(${asset.id})" 
                                    class="text-red-500 hover:text-red-400 text-xs"
                                    title="Delete asset">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                            <div class="flex justify-between items-center text-xs mt-2">
                                <span class="text-gray-400">Cost:</span>
                                <span class="font-bold text-purple-400">${db.config.currency}${asset.cost.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between items-center text-xs mt-1">
                                <span class="text-gray-400">Payment:</span>
                                <span class="text-white uppercase">${asset.payType}</span>
                            </div>
                            ${asset.supplierName && asset.supplierName !== 'N/A' ? `
                            <div class="flex justify-between items-center text-xs mt-1">
                                <span class="text-gray-400">Supplier:</span>
                                <span class="text-white">${asset.supplierName}</span>
                            </div>
                            ` : ''}
                        </div>
                    `;
            });

            container.innerHTML = html;
        };

        // --- DELETE ASSET FUNCTION ---
        window.deleteAsset = function (id) {
            if (!confirm('Are you sure you want to delete this asset? The amount will be refunded.')) return;

            const idx = db.assets.findIndex(a => a.id === id);
            if (idx === -1) {
                alert('Asset not found');
                return;
            }

            const asset = db.assets[idx];

            // Refund Amount
            if (asset.payType === 'cash') {
                db.config.cashBalance = moneyRound(db.config.cashBalance + asset.cost);
            } else if (asset.payType === 'bank') {
                db.config.bankBalance = moneyRound(db.config.bankBalance + asset.cost);
            }
            // For credit, no balance change

            // Also remove from transactions
            const txnIdx = db.transactions.findIndex(t => t.type === 'asset_purchase' && t.assetName === asset.assetName && Math.abs(t.total - asset.cost) < 0.01);
            if (txnIdx !== -1) {
                db.transactions.splice(txnIdx, 1);
            }

            db.assets.splice(idx, 1);
            saveDB();
            alert(`Asset deleted and ${db.config.currency}${asset.cost.toFixed(2)} refunded to ${asset.payType.toUpperCase()}`);
            refreshUI();
        };

        // --- LOAD BATCHES FUNCTION ---
        window.loadBatches = function () {
            const tbody = document.getElementById('batchBody');
            if (!tbody) return;

            // Collect all batch data from purchase transactions
            const batches = [];

            if (db.transactions && Array.isArray(db.transactions)) {
                db.transactions.forEach(txn => {
                    if (txn.type === 'purchase' && txn.items && Array.isArray(txn.items)) {
                        txn.items.forEach(item => {
                            // Only add items that have batch or expiry information
                            if (item.batch || item.expiry) {
                                batches.push({
                                    productName: item.name || 'Unknown Product',
                                    batch: item.batch || 'N/A',
                                    expiry: item.expiry || 'N/A',
                                    qty: item.qty || 0,
                                    cost: item.cost || 0,
                                    purchaseDate: txn.date || new Date().toISOString(),
                                    supplierName: txn.entityName || 'Unknown Supplier'
                                });
                            }
                        });
                    }
                });
            }

            // Clear table
            tbody.innerHTML = '';

            // If no batches, show empty message
            if (batches.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="p-8 text-center text-gray-500 text-sm">
                            <i class="fa-solid fa-box-open text-4xl mb-3 block text-gray-700"></i>
                            No batch records found. Batches are created when you add batch/expiry info during purchase.
                        </td>
                    </tr>
                `;
                return;
            }

            // Sort by purchase date (newest first)
            batches.sort((a, b) => new Date(b.purchaseDate) - new Date(a.purchaseDate));

            // Populate table
            batches.forEach(batch => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-white/5 transition';

                const expiryDate = batch.expiry !== 'N/A' ? window.formatDate(batch.expiry) : 'N/A';
                const purchaseDate = window.formatDate(batch.purchaseDate);

                tr.innerHTML = `
                    <td class="p-3 text-white font-medium">${batch.productName}</td>
                    <td class="p-3 text-gray-300 font-mono text-xs">${batch.batch}</td>
                    <td class="p-3 text-gray-400">${expiryDate}</td>
                    <td class="p-3 text-right text-white font-bold">${batch.qty}</td>
                    <td class="p-3 text-right text-karta-primary">${db.config.currency}${batch.cost.toFixed(2)}</td>
                    <td class="p-3 text-gray-400">${purchaseDate}</td>
                    <td class="p-3 text-gray-300">${batch.supplierName}</td>
                `;

                tbody.appendChild(tr);
            });
        };


        window.renderSettlements = function () {
            // CRITICAL: Ensure settlements array exists with proper default
            if (!db || !db.settlements || !Array.isArray(db.settlements)) {
                console.warn('WARNING: db.settlements is missing or invalid! Reinitializing...');
                if (!db) db = JSON.parse(JSON.stringify(APP_STATE));
                if (!db.settlements) db.settlements = [];
            }

            console.log('===== RENDERING SETTLEMENTS =====');
            console.log('Total settlements in db:', db.settlements.length);
            console.log('All settlement records:', JSON.stringify(db.settlements, null, 2));
            console.log('Local storage key:', DB_KEY);
            const localStorageData = localStorage.getItem(DB_KEY);
            console.log('LocalStorage settlements count:', localStorageData ? JSON.parse(localStorageData).settlements.length : 'N/A');
            console.log('==================================');

            const search = document.getElementById('settlementSearch') ? document.getElementById('settlementSearch').value.toLowerCase() : '';
            const typeFilter = document.getElementById('settlementTypeFilter') ? document.getElementById('settlementTypeFilter').value : '';

            let filtered = db.settlements.filter(s => {
                const matchesSearch = !search || (s.entityName && s.entityName.toLowerCase().includes(search));
                const matchesType = !typeFilter || s.type === typeFilter;
                return matchesSearch && matchesType;
            });

            console.log('Filtered settlements after search/type:', filtered.length);

            // Update summary cards
            let cashTotal = 0, bankTotal = 0;
            db.settlements.forEach(s => {
                if (s.paymentMethod === 'cash') cashTotal += s.settlementAmount;
                else if (s.paymentMethod === 'bank') bankTotal += s.settlementAmount;
            });

            const countEl = document.getElementById('settlementCount');
            const cashEl = document.getElementById('settlementCashTotal');
            const bankEl = document.getElementById('settlementBankTotal');

            if (countEl) countEl.innerText = db.settlements.length;
            if (cashEl) cashEl.innerText = `${db.config.currency}${cashTotal.toFixed(2)}`;
            if (bankEl) bankEl.innerText = `${db.config.currency}${bankTotal.toFixed(2)}`;

            // Find pending dues
            let pendingCount = 0;
            if (db.customers) {
                pendingCount += db.customers.filter(c => c.balance > 0).length;
            }
            if (db.suppliers) {
                pendingCount += db.suppliers.filter(s => s.balance > 0).length;
            }
            const pendingEl = document.getElementById('settlementPendingCount');
            if (pendingEl) pendingEl.innerText = pendingCount;

            // Render table
            const tbody = document.getElementById('settlementBody');
            if (!tbody) {
                console.error('ERROR: settlementBody element not found!');
                return;
            }
            tbody.innerHTML = '';

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="p-8"><div class="empty-state"><div class="empty-state-icon"><i class="fa-solid fa-handshake"></i></div><div class="empty-state-title">No Settlements Found</div><div class="empty-state-text">Create a settlement or adjust filters</div></div></td></tr>`;
                return;
            }

            filtered.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-white/5 border-b border-gray-800';

                const paymentBadge = s.paymentMethod === 'cash'
                    ? '<span class="px-3 py-1 bg-green-900/40 text-green-300 rounded text-xs font-bold"><i class="fa-solid fa-money-bill mr-1"></i>Cash</span>'
                    : '<span class="px-3 py-1 bg-blue-900/40 text-blue-300 rounded text-xs font-bold"><i class="fa-solid fa-university mr-1"></i>Bank</span>';

                const typeBadge = s.type === 'customer'
                    ? '<span class="px-2 py-1 bg-blue-900/30 text-blue-300 text-xs rounded"><i class="fa-solid fa-user mr-1"></i>Customer</span>'
                    : '<span class="px-2 py-1 bg-orange-900/30 text-orange-300 text-xs rounded"><i class="fa-solid fa-truck mr-1"></i>Supplier</span>';

                tr.innerHTML = `
                    <td class="p-3">${window.formatDate(s.date)}</td>
                    <td class="p-3">${typeBadge}</td>
                    <td class="p-3 font-bold text-white">${s.entityName}</td>
                    <td class="p-3 text-right text-karta-primary font-bold">${db.config.currency}${s.settlementAmount.toFixed(2)}</td>
                    <td class="p-3">${paymentBadge}</td>
                    <td class="p-3 text-xs font-mono">${s.chequeNo || '-'}</td>
                    <td class="p-3"><span class="px-2 py-1 bg-green-900/40 text-green-300 rounded text-xs font-bold">✓ Settled</span></td>
                    <td class="p-3 text-center flex gap-2 justify-center">
                        <button onclick="viewSettlementInvoice(${s.id})" class="text-blue-400 hover:text-blue-300" title="View Invoice"><i class="fa-solid fa-eye"></i></button>
                        <button onclick="printSettlementInvoiceQuick(${s.id})" class="text-white hover:text-gray-300" title="Print"><i class="fa-solid fa-print"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        };

        // Debug function to diagnose settlement issues
        window.debugSettlements = function () {
            console.clear();
            console.log('========== SETTLEMENT DEBUG INFO ==========');
            console.log('Current User:', currentUser ? currentUser.email : 'Not logged in');
            console.log('DB_KEY:', DB_KEY);
            console.log('');

            console.log('DATABASE STATE (db object):');
            console.log('  db.settlements length:', db.settlements ? db.settlements.length : 'UNDEFINED');
            console.log('  db.settlements:', JSON.stringify(db.settlements || [], null, 2));
            console.log('');

            console.log('LOCAL STORAGE:');
            if (DB_KEY && localStorage.getItem(DB_KEY)) {
                const stored = JSON.parse(localStorage.getItem(DB_KEY));
                console.log('  Settlements in localStorage:', stored.settlements ? stored.settlements.length : 'NONE');
                console.log('  First settlement:', stored.settlements && stored.settlements.length > 0 ? JSON.stringify(stored.settlements[0], null, 2) : 'NO DATA');
            } else {
                console.log('  No data in localStorage');
            }
            console.log('');

            console.log('DOM ELEMENTS:');
            console.log('  settlementBody exists:', !!document.getElementById('settlementBody'));
            console.log('  settlementCount exists:', !!document.getElementById('settlementCount'));
            console.log('  settlementBody innerHTML length:', document.getElementById('settlementBody')?.innerHTML.length || 0);
            console.log('');

            console.log('========== END DEBUG INFO ==========');
            alert('Debug info logged to console (F12). Check the browser console for details.');
        };

        window.viewSettlementInvoice = function (settlementId) {
            const settlement = db.settlements.find(s => s.id === settlementId);
            if (!settlement) return;

            currentSettlementData = settlement;
            const content = generateSettlementInvoiceHTML(settlement);
            document.getElementById('settlementInvoiceContent').innerHTML = content;
            openModal('settlementViewModal');
        };

        function generateSettlementInvoiceHTML(settlement) {
            const entity = settlement.type === 'customer'
                ? db.customers.find(c => c.id === settlement.entityId)
                : db.suppliers.find(s => s.id === settlement.entityId);

            const logoHTML = db.config.logo ? `<img src="${db.config.logo}" style="width: 80px; height: 80px; object-fit: contain; margin-right: 16px;">` : '';

            // NEW: Linked Invoice Logic
            let linkedInvoiceHTML = '';
            if (settlement.linkedInvoiceId) {
                // Loose equality for safety
                const linkedTxn = db.transactions.find(t => t.id == settlement.linkedInvoiceId);
                if (linkedTxn) {
                    const invDate = window.formatDate(linkedTxn.date);
                    const invNum = linkedTxn.invoiceNumber || linkedTxn.ref || linkedTxn.id.toString().slice(-6);
                    linkedInvoiceHTML = `
                        <tr style="border-bottom: 1px solid #ddd; background-color: #ffffdd;">
                            <td style="padding: 4px 0; font-weight: bold; color: #d35400;">Payment For:</td>
                            <td style="padding: 4px 0; text-align: right; font-weight: bold; color: #d35400;">
                                Invoice #${invNum}<br>
                                <span style="font-size: 9px; font-weight: normal; color: #666;">Dated: ${invDate}</span>
                            </td>
                        </tr>
                    `;
                }
            }

            return `
                <div style="border: 2px solid #000; padding: 20px; font-family: Arial, sans-serif; color: #000;">
                    <!-- HEADER WITH LOGO AND COMPANY INFO -->
                    <div style="display: flex; align-items: flex-start; border-bottom: 3px solid #000; padding-bottom: 16px; margin-bottom: 16px;">
                        <div style="flex: 1;">
                            ${logoHTML}
                        </div>
                        <div style="flex: 3; text-align: center;">
                            <h1 style="margin: 0; font-size: 28px; font-weight: bold; color: #000;">${db.config.name}</h1>
                            <p style="margin: 4px 0 0 0; font-size: 12px; font-weight: bold;">चलु खाता बन्द गरीकरण</p>
                            <p style="margin: 4px 0 0 0; font-size: 14px; font-weight: bold;">CREDIT SETTLEMENT CERTIFICATE</p>
                        </div>
                        <div style="flex: 1;"></div>
                    </div>

                    <!-- COMPANY DETAILS BOX -->
                    <div style="background: #f5f5f5; border: 1px solid #000; padding: 12px; margin-bottom: 16px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 11px;">
                            <div>
                                <p style="margin: 0 0 4px 0;"><strong>Company Address:</strong></p>
                                <p style="margin: 0;">${db.config.address}</p>
                            </div>
                            <div>
                                <p style="margin: 0 0 4px 0;"><strong>Contact & Tax Details:</strong></p>
                                <p style="margin: 0;">Phone: ${db.config.phone}</p>
                                <p style="margin: 2px 0 0 0;">Tax ID/PAN: ${db.config.taxId}</p>
                            </div>
                        </div>
                    </div>

                    <!-- SETTLEMENT DETAILS HEADER -->
                    <div style="border: 2px solid #000; background: #e8e8e8; padding: 12px; margin-bottom: 16px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; font-size: 12px;">
                            <div>
                                <p style="margin: 0; font-weight: bold; font-size: 10px; color: #666; text-transform: uppercase;">Settlement Date</p>
                                <p style="margin: 4px 0 0 0; font-size: 14px; font-weight: bold;">${window.formatDate(settlement.date)}</p>
                            </div>
                            <div>
                                <p style="margin: 0; font-weight: bold; font-size: 10px; color: #666; text-transform: uppercase;">Settlement ID</p>
                                <p style="margin: 4px 0 0 0; font-size: 14px; font-weight: bold;">SETT-${settlement.id.toString().slice(-8).toUpperCase()}</p>
                            </div>
                            <div>
                                <p style="margin: 0; font-weight: bold; font-size: 10px; color: #666; text-transform: uppercase;">Type</p>
                                <p style="margin: 4px 0 0 0; font-size: 14px; font-weight: bold;">${settlement.type === 'customer' ? 'RECEIVABLE' : 'PAYABLE'}</p>
                            </div>
                        </div>
                    </div>

                    <!-- ENTITY INFORMATION -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <!-- Party Details -->
                        <div style="border: 2px solid #000; padding: 12px;">
                            <p style="margin: 0 0 8px 0; font-weight: bold; border-bottom: 1px solid #000; padding-bottom: 4px; text-transform: uppercase; font-size: 12px;">
                                ${settlement.type === 'customer' ? 'Customer Details' : 'Supplier Details'}
                            </p>
                            <p style="margin: 4px 0; font-size: 14px; font-weight: bold;">${settlement.entityName}</p>
                            <table style="width: 100%; font-size: 11px; border-collapse: collapse; margin-top: 8px;">
                                <tr style="border-top: 1px solid #ddd;">
                                    <td style="padding: 4px 0; font-weight: bold; width: 50%;">Outstanding Due:</td>
                                    <td style="padding: 4px 0; text-align: right; font-weight: bold; color: #c00;">${db.config.currency} ${settlement.dueAmount.toFixed(2)}</td>
                                </tr>
                                <tr style="border-top: 1px solid #ddd;">
                                    <td style="padding: 4px 0; font-weight: bold;">Amount Settled:</td>
                                    <td style="padding: 4px 0; text-align: right; font-weight: bold; color: #008000; font-size: 12px;">${db.config.currency} ${settlement.settlementAmount.toFixed(2)}</td>
                                </tr>
                                <tr style="border-top: 2px solid #000; border-bottom: 2px solid #000;">
                                    <td style="padding: 6px 0; font-weight: bold; color: #000;">Remaining Balance:</td>
                                    <td style="padding: 6px 0; text-align: right; font-weight: bold; color: #000; font-size: 12px;">${db.config.currency} ${(settlement.dueAmount - settlement.settlementAmount).toFixed(2)}</td>
                                </tr>
                            </table>
                        </div>

                        <!-- Payment Information -->
                        <div style="border: 2px solid #000; padding: 12px; background: #fff9f0;">
                            <p style="margin: 0 0 8px 0; font-weight: bold; border-bottom: 1px solid #000; padding-bottom: 4px; text-transform: uppercase; font-size: 12px;">
                                Payment Information
                            </p>
                            <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
                                ${linkedInvoiceHTML}
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <td style="padding: 4px 0; font-weight: bold; width: 50%;">Payment Method:</td>
                                    <td style="padding: 4px 0; text-align: right; font-weight: bold;">
                                        ${settlement.paymentMethod.toUpperCase()}
                                    </td>
                                </tr>
                                ${settlement.chequeNo ? `
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <td style="padding: 4px 0; font-weight: bold;">Cheque Number:</td>
                                    <td style="padding: 4px 0; text-align: right; font-family: monospace; font-weight: bold;">${settlement.chequeNo}</td>
                                </tr>
                                ` : ''}
                                ${settlement.chequeDate ? `
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <td style="padding: 4px 0; font-weight: bold;">Cheque Date:</td>
                                    <td style="padding: 4px 0; text-align: right;">${window.formatDate(settlement.chequeDate)}</td>
                                </tr>
                                ` : ''}
                                ${settlement.bankName ? `
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <td style="padding: 4px 0; font-weight: bold;">Bank Name:</td>
                                    <td style="padding: 4px 0; text-align: right; font-weight: bold;">${settlement.bankName}</td>
                                </tr>
                                ` : ''}
                                <tr>
                                    <td style="padding: 6px 0; font-weight: bold; color: #000;">Settlement Date:</td>
                                    <td style="padding: 6px 0; text-align: right; font-weight: bold;">${window.formatDate(settlement.date)}</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- NOTES SECTION -->
                    ${settlement.notes ? `
                    <div style="border: 1px solid #999; background: #fffef0; padding: 12px; margin-bottom: 16px;">
                        <p style="margin: 0 0 4px 0; font-weight: bold; font-size: 11px;">NOTES / REMARKS:</p>
                        <p style="margin: 0; font-size: 11px; line-height: 1.4;">${settlement.notes}</p>
                    </div>
                    ` : ''}

                    <!-- AMOUNT SUMMARY TABLE -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 16px; border: 2px solid #000;">
                        <tr style="background: #e8e8e8; border-bottom: 1px solid #000;">
                            <td style="padding: 12px; font-weight: bold; font-size: 12px;">SETTLEMENT SUMMARY</td>
                            <td style="padding: 12px; text-align: right; font-weight: bold; font-size: 12px;">AMOUNT</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ccc;">
                            <td style="padding: 10px;">Original Outstanding Due:</td>
                            <td style="padding: 10px; text-align: right;">${db.config.currency} ${settlement.dueAmount.toFixed(2)}</td>
                        </tr>
                        <tr style="border-bottom: 2px solid #000; background: #e8f5e9;">
                            <td style="padding: 10px; font-weight: bold; font-size: 13px;">Amount Settled Today:</td>
                            <td style="padding: 10px; text-align: right; font-weight: bold; font-size: 14px; color: #008000;">${db.config.currency} ${settlement.settlementAmount.toFixed(2)}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ccc;">
                            <td style="padding: 10px;">Remaining Balance:</td>
                            <td style="padding: 10px; text-align: right;">${db.config.currency} ${(settlement.dueAmount - settlement.settlementAmount).toFixed(2)}</td>
                        </tr>
                    </table>

                    <!-- SIGNATURE SECTION -->
                    <div style="border: 2px solid #000; padding: 16px;">
                        <p style="margin: 0 0 16px 0; font-weight: bold; text-align: center; font-size: 12px;">AUTHORIZED SIGNATURES</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; font-size: 11px;">
                            <!-- Prepared By -->
                            <div style="text-align: center;">
                                <div style="border-top: 1px solid #000; padding-top: 40px; min-height: 50px;">
                                    <p style="margin: 0; font-weight: bold;">PREPARED BY</p>
                                    <p style="margin: 4px 0 0 0; font-size: 10px; color: #666;">Name & Signature</p>
                                </div>
                            </div>

                            <!-- Verified By -->
                            <div style="text-align: center;">
                                <div style="border-top: 1px solid #000; padding-top: 40px; min-height: 50px;">
                                    <p style="margin: 0; font-weight: bold;">VERIFIED BY</p>
                                    <p style="margin: 4px 0 0 0; font-size: 10px; color: #666;">Manager/Authorized</p>
                                </div>
                            </div>

                            <!-- Recipient Acknowledgement -->
                            <div style="text-align: center;">
                                <div style="border-top: 1px solid #000; padding-top: 40px; min-height: 50px;">
                                    <p style="margin: 0; font-weight: bold;">ACKNOWLEDGED</p>
                                    <p style="margin: 4px 0 0 0; font-size: 10px; color: #666;">${settlement.type === 'customer' ? 'Customer' : 'Supplier'} Signature</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- FOOTER -->
                    <div style="text-align: center; margin-top: 16px; border-top: 1px solid #ccc; padding-top: 12px; font-size: 10px; color: #666;">
                        <p style="margin: 4px 0;">This certificate confirms the settlement of outstanding dues as per company records.</p>
                        <p style="margin: 4px 0;">Generated by KARTA Business OS</p>
                        <p style="margin: 4px 0; font-weight: bold;">Date & Time: ${window.formatDate(settlement.date)}</p>
                        <p style="margin: 4px 0; font-size: 9px; color: #999;">Reference: SETT-${settlement.id.toString().slice(-8).toUpperCase()}</p>
                    </div>
                </div>
            `;
        }

        window.printSettlementInvoice = function () {
            if (!currentSettlementData) return;
            const printContent = document.getElementById('settlementInvoiceContent').innerHTML;
            const printWindow = window.open('', '', 'height=700,width=900');

            if (!printWindow) {
                alert('Please disable popup blocker and try again, or use the PDF export button.');
                return;
            }

            printWindow.document.write('<html><head><title>Settlement Invoice</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></head><body style="font-family: Arial, sans-serif;">');
            printWindow.document.write(printContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 250);
        };

        window.downloadSettlementPDF = function () {
            if (!currentSettlementData) return;
            const s = currentSettlementData;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let yPos = 20;
            if (db.config.logo) {
                try {
                    doc.addImage(db.config.logo, 'JPEG', 14, 15, 20, 20);
                    yPos = 40;
                } catch (e) { }
            }

            doc.setFontSize(18);
            doc.text(db.config.name, 14, yPos);
            doc.setFontSize(10);
            doc.text(db.config.address, 14, yPos + 5);
            doc.text('CREDIT SETTLEMENT CERTIFICATE', 14, yPos + 15);

            doc.setDrawColor(200);
            doc.line(14, yPos + 18, 196, yPos + 18);

            doc.setFontSize(12);
            doc.text(`${s.type === 'customer' ? 'Customer' : 'Supplier'}: ${s.entityName}`, 14, yPos + 28);
            doc.setFontSize(10);
            doc.text(`Date: ${window.formatDate(s.date)}`, 14, yPos + 33);
            doc.text(`Settlement ID: ${s.id.toString().slice(-8)}`, 14, yPos + 38);

            doc.setFontSize(11);
            doc.text(`Outstanding Due: ${db.config.currency} ${s.dueAmount.toFixed(2)}`, 14, yPos + 50);
            doc.text(`Amount Settled: ${db.config.currency} ${s.settlementAmount.toFixed(2)}`, 14, yPos + 55);
            doc.text(`Payment Method: ${s.paymentMethod.toUpperCase()}`, 14, yPos + 60);

            if (s.chequeNo) {
                doc.text(`Cheque Number: ${s.chequeNo}`, 14, yPos + 65);
            }

            doc.setFontSize(8);
            doc.text('This certificate confirms the settlement of outstanding dues.', 14, yPos + 80);

            const filename = `Settlement_${s.entityName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);
        };

        window.printSettlementInvoiceQuick = function (settlementId) {
            const settlement = db.settlements.find(s => s.id === settlementId);
            if (!settlement) return;
            currentSettlementData = settlement;
            printSettlementInvoice();
        };

        // Log protection enabled to original console
        setTimeout(() => {
            originalConsole.log('%c🔐 KARTA Application Protected', 'color: #00c853; font-size: 14px; font-weight: bold;');
            originalConsole.log('%cRight-click, copying, and developer tools are disabled for security.', 'color: #888; font-size: 12px;');
        }, 1000);

        // --- INIT DUAL DATE INPUTS ---
        setTimeout(() => {
            if (window.enableDualDateInput) {
                window.enableDualDateInput('posManualDate', 'posManualDateNep');
                window.enableDualDateInput('purchInvFromDate', 'purchInvFromDateNep');
                window.enableDualDateInput('purchInvToDate', 'purchInvToDateNep');
                window.enableDualDateInput('repFrom', 'repFromNep');
                window.enableDualDateInput('repTo', 'repToNep');

                // NEW: Purchase Entry & Invoice Filter
                window.enableDualDateInput('purchaseDate', 'purchaseDateNep');
                window.enableDualDateInput('invoiceDateFilter', 'invoiceDateFilterNep');

                // Init visibility based on stored config
                if (db.config.dateMode === 'nepali') {
                    document.getElementById('posManualDateNep')?.classList.remove('hidden');
                    document.getElementById('purchInvFromDateNep')?.classList.remove('hidden');
                    document.getElementById('purchInvToDateNep')?.classList.remove('hidden');
                    document.getElementById('repFromNep')?.classList.remove('hidden');
                    document.getElementById('repToNep')?.classList.remove('hidden');
                }
            }
        }, 500);

        // ===== MOVABLE NEPALI CALENDAR LOGIC =====
        function initMovableCalendar() {
            console.log('Initializing Movable Nepali Calendar...');

            // Configuration key
            const CONFIG_KEY = 'nepaliCalendarConfig';

            // Load config or default
            function getConfig() {
                const stored = localStorage.getItem(CONFIG_KEY);
                return stored ? JSON.parse(stored) : { x: 0, y: 0, isLocked: false };
            }

            // Save config
            function saveConfig(config) {
                localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            }

            // Global State
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;
            let activeDragItem = null;

            // Watch for the calendar popup being added to DOM
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1 && (node.classList.contains('ap-card') || node.querySelector && node.querySelector('.ap-card'))) {
                            const params = node.classList.contains('ap-card') ? node : node.querySelector('.ap-card');
                            enhanceCalendar(params);
                        }
                    });
                });

                // Also check existing if missed
                const existing = document.querySelectorAll('.ap-card');
                existing.forEach(enhanceCalendar);
            });

            observer.observe(document.body, { childList: true, subtree: true });

            // Also run once immediately
            setTimeout(() => {
                document.querySelectorAll('.ap-card').forEach(enhanceCalendar);
            }, 1000);

            function enhanceCalendar(el) {
                if (el.dataset.enhanced === 'true') {
                    // Check if position enforcement is needed even if already enhanced
                    const config = getConfig();
                    if (config.isLocked) {
                        enforcePosition(el, config);
                    }
                    return;
                }

                console.log('Enhancing calendar popup:', el);
                el.dataset.enhanced = 'true';

                // Inject Header
                const header = document.createElement('div');
                header.className = 'calendar-drag-handle';
                header.innerHTML = `
                    <span><i class="fa-solid fa-calendar-days mr-2"></i>Nepali Calendar</span>
                    <button class="calendar-lock-btn" title="Lock Position">
                        <i class="fa-solid fa-lock-open"></i>
                    </button>
                `;

                el.prepend(header);

                const lockBtn = header.querySelector('.calendar-lock-btn');
                const lockIcon = lockBtn.querySelector('i');

                // Initial State Apply
                const config = getConfig();
                updateLockUI(config.isLocked);

                if (config.isLocked) {
                    enforcePosition(el, config);
                }

                // Enforce lock persistence against library updates
                const styleObserver = new MutationObserver((mutations) => {
                    const cfg = getConfig();
                    if (cfg.isLocked) {
                        // If style changed, force it back
                        // We must disconnect comfortably to avoid infinite loop
                        styleObserver.disconnect();
                        enforcePosition(el, cfg);
                        styleObserver.observe(el, { attributes: true, attributeFilter: ['style'] });
                    }
                });

                styleObserver.observe(el, { attributes: true, attributeFilter: ['style'] });

                function enforcePosition(element, cfg) {
                    element.style.position = 'fixed'; // Ensure fixed if locked
                    element.style.top = cfg.y + 'px';
                    element.style.left = cfg.x + 'px';

                    // Override any subsequent library updates
                    // We use a small timeout loop or RequestAnimationFrame to fight library positioning if needed
                    // But for now, we just set it. 
                }

                function updateLockUI(locked) {
                    if (locked) {
                        header.classList.add('locked');
                        lockIcon.className = 'fa-solid fa-lock';
                        lockBtn.title = "Unlock Position";
                        header.style.cursor = 'default';
                    } else {
                        header.classList.remove('locked');
                        lockIcon.className = 'fa-solid fa-lock-open';
                        lockBtn.title = "Lock Position";
                        header.style.cursor = 'grab';
                    }
                }

                // Lock Toggle Handler
                lockBtn.addEventListener('mousedown', (e) => {
                    e.stopPropagation(); // Prevent drag start
                });

                lockBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const currentConfig = getConfig();
                    const newLockedState = !currentConfig.isLocked;

                    // If locking, save current position
                    if (newLockedState) {
                        const rect = el.getBoundingClientRect();
                        currentConfig.x = rect.left;
                        currentConfig.y = rect.top;
                    }

                    currentConfig.isLocked = newLockedState;
                    saveConfig(currentConfig);
                    updateLockUI(newLockedState);

                    if (newLockedState) {
                        enforcePosition(el, currentConfig);
                    }
                });

                // Drag Logic - Allow dragging from ANYWHERE on the card
                // But preventing it when clicking interactive elements like buttons
                el.addEventListener('mousedown', dragStart);

                function dragStart(e) {
                    const currentConfig = getConfig();
                    if (currentConfig.isLocked) return;

                    // prevent drag if clicking on buttons (dates, arrows, year/month select)
                    if (e.target.tagName.toLowerCase() === 'button' || e.target.closest('button') || e.target.tagName.toLowerCase() === 'select') {
                        return;
                    }

                    initialX = e.clientX - el.getBoundingClientRect().left;
                    initialY = e.clientY - el.getBoundingClientRect().top;

                    activeDragItem = el;
                    isDragging = true;

                    el.style.position = 'fixed';

                    document.addEventListener('mousemove', drag);
                    document.addEventListener('mouseup', dragEnd);
                }

                function drag(e) {
                    if (isDragging && activeDragItem === el) {
                        e.preventDefault();
                        const x = e.clientX - initialX;
                        const y = e.clientY - initialY;

                        setTranslate(x, y, activeDragItem);
                    }
                }

                function dragEnd(e) {
                    if (!isDragging) return;

                    initialX = currentX;
                    initialY = currentY;
                    isDragging = false;

                    activeDragItem = null;
                    document.removeEventListener('mousemove', drag);
                    document.removeEventListener('mouseup', dragEnd);

                    // Optionally save last known position even if unlocked?
                    // User might expect it to stay there until closed. 
                    // But if unlocked, it might reset on next open.
                    // Let's NOT save to config.isLocked=false state unless needed.
                }

                function setTranslate(xPos, yPos, el) {
                    el.style.left = xPos + "px";
                    el.style.top = yPos + "px";
                }
            }
        }

        // Initialize
        initMovableCalendar();
    </script>

    <!-- PWA Service Worker Registration & Offline Sync -->
    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Service Workers generally require HTTPS or localhost. file:// protocol is often not supported.
                if (window.location.protocol === 'file:') {
                    console.warn('[PWA] Service Workers cannot run on "file://" protocol. To enable offline support and installation, please serve this project using a local server (e.g., Live Server in VS Code, Python http.server, or npx http-server).');
                    // Optional: You could show a UI notification here
                    return;
                }

                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('[PWA] Service Worker registered successfully:', registration.scope);

                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60000); // Check every minute

                        // Handle updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    if (confirm('New version of Karta available! Reload to update?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error('[PWA] Service Worker registration failed:', error);
                    });

                // Listen for messages from Service Worker
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'SYNC_DATA') {
                        console.log('[PWA] Sync data message received');
                        if (typeof syncToCloud === 'function') {
                            syncToCloud();
                        }
                    }
                });
            });
        }

        // --- Offline/Online Status Management ---
        let isOnline = navigator.onLine;
        let pendingSyncData = [];

        // Create status indicator
        function createOfflineIndicator() {
            const existing = document.getElementById('pwa-status-indicator');
            if (existing) return existing;

            const indicator = document.createElement('div');
            indicator.id = 'pwa-status-indicator';
            indicator.className = 'fixed bottom-4 right-4 z-[9998] px-4 py-2 rounded-full text-sm font-bold shadow-lg transition-all duration-300';
            indicator.style.display = 'none';
            document.body.appendChild(indicator);
            return indicator;
        }

        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const indicator = createOfflineIndicator();

            if (!isOnline) {
                // Offline
                indicator.className = 'fixed bottom-4 right-4 z-[9998] px-4 py-2 rounded-full text-sm font-bold shadow-lg transition-all duration-300 bg-orange-600 text-white';
                indicator.innerHTML = '<i class="fa-solid fa-wifi-slash mr-2"></i>Offline Mode';
                indicator.style.display = 'flex';
                indicator.style.alignItems = 'center';
                console.log('[PWA] App is now OFFLINE');
            } else {
                // Online
                indicator.className = 'fixed bottom-4 right-4 z-[9998] px-4 py-2 rounded-full text-sm font-bold shadow-lg transition-all duration-300 bg-green-600 text-white';
                indicator.innerHTML = '<i class="fa-solid fa-wifi mr-2"></i>Back Online';
                indicator.style.display = 'flex';
                indicator.style.alignItems = 'center';
                console.log('[PWA] App is now ONLINE');

                // Trigger sync when back online
                triggerDataSync();

                // Hide indicator after 3 seconds
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 3000);
            }
        }

        // Sync data when back online
        async function triggerDataSync() {
            console.log('[PWA] Triggering data sync...');

            // Check if sync function exists and call it
            if (typeof syncToCloud === 'function') {
                try {
                    await syncToCloud();
                    console.log('[PWA] Data synced successfully');
                } catch (e) {
                    console.error('[PWA] Sync failed:', e);
                }
            }

            // Request background sync if supported
            if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
                try {
                    const registration = await navigator.serviceWorker.ready;
                    await registration.sync.register('sync-data');
                    console.log('[PWA] Background sync registered');
                } catch (e) {
                    console.warn('[PWA] Background sync not supported:', e);
                }
            }
        }

        // Listen for online/offline events
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // Initial check
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (!navigator.onLine) {
                    updateOnlineStatus();
                }
            }, 1000);
        });

        // PWA Install Prompt Handler
        let deferredPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('[PWA] Install prompt captured');

            // Show custom install button in UI (optional)
            showInstallButton();
        });

        function showInstallButton() {
            // Create install button if it doesn't exist
            let installBtn = document.getElementById('pwa-install-btn');
            if (!installBtn) {
                installBtn = document.createElement('button');
                installBtn.id = 'pwa-install-btn';
                installBtn.className = 'fixed bottom-4 left-4 z-[9998] px-4 py-2 rounded-full text-sm font-bold shadow-lg bg-karta-primary text-black hover:bg-green-400 transition-all duration-300 flex items-center gap-2';
                installBtn.innerHTML = '<i class="fa-solid fa-download"></i> Install App';
                installBtn.onclick = installPWA;
                document.body.appendChild(installBtn);
            }
        }

        async function installPWA() {
            if (!deferredPrompt) {
                console.log('[PWA] No install prompt available');
                return;
            }

            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log('[PWA] User response to install prompt:', outcome);

            if (outcome === 'accepted') {
                const installBtn = document.getElementById('pwa-install-btn');
                if (installBtn) installBtn.remove();
            }

            deferredPrompt = null;
        }

        window.addEventListener('appinstalled', () => {
            console.log('[PWA] App was installed successfully');
            deferredPrompt = null;
            const installBtn = document.getElementById('pwa-install-btn');
            if (installBtn) installBtn.remove();
        });

        console.log('[PWA] Offline support initialized');
    </script>
</body>

</html>
